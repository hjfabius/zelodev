################################################################################
#                                                                              #
#    Micro Series Z80/64180 Assembler V1.95/MD2         12/Jun/07  19:49:08    #
#                                                                              #
#       Source   =   taj200.msa                                                #
#       List     =   taj200.lst                                                #
#       Object   =   taj200.a01                                                #
#       Options  =                                                             #
#                                                                              #
#                                               (c) Copyright IAR Systems 1987 #
################################################################################


    1                                         ;#################################
    2                                         ;#              TAJ 200          #
    3                                         ;#        ZELO ELETTRONICA       #
    4                                         ;#                               #
    5                                         ;#    CONTROLLO DI REGISTRO M/C  #
    6                                         ;# LONGITUDINALE                 #
    7                                         ;# TIRO                          #
    8                                         ;# TRASVERSALE (DA IMPLEMENTARE) #
    9                                         ;#################################
   10                  
   11                 
   12                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   13                 ;       PARAMETRI FONDAMENTALI PROGRAMMA
   14                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   15                 
   16  009F           VERSIONE_PROGRAMMA:     EQU     159     ;VERSIONE PROGRAMMA
   17  0014           WATCHDOG_ST7:           EQU     20      ;VALORE IN SECONDI DI ATTESA IRQ DA ST7 PRIMA DI RESETTARE (USATO IN REQISFREE)
   18                 
   19                 
   20                 
   21                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   22                 ;       PORTE PIO
   23                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   24                 
   25  0000           PA:             EQU     00H     ;DATI PORTA A
   26  0001           PB:             EQU     01H     ;DATI PORTA B
   27  0063           PC:             EQU     63H     ;DATI PORTA C
   28  0051           PD:             EQU     51H     ;DATI PORTA D
   29                 
   30  0002           PA_CMD:         EQU     02H     ;COMANDO PORTA A
   31  0003           PB_CMD:         EQU     03H     ;COMANDO PORTA B
   32                 
   33  0070           CTC0_CMD:       EQU     70H
   34  0071           CTC1_CMD:       EQU     71H
   35  0072           CTC2_CMD:       EQU     72H
   36  0073           CTC3_CMD:       EQU     73H
   37                 
   38                 
   39                 
   40                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   41                 ;       CONFIGURAZIONE PORTA PB
   42                 ;
   43                 ; PA0   IN      COM ST7 - RX DATO                       TASA
   44                 ; PA1   OUT     COM ST7 - RICHIESTA COMUNICAZIONE       OUTPA1
   45                 ; PA2   OUT     FREE                                    OUTPA2
   46                 ; PA3   OUT     FREE                                    OUTPA3
   47                 ; PA4   IN      COM ST7 - IRQ COMUNICAZIONE             TASDA
   48                 ; PA5   OUT     AUTO GAIN                       
   49                 ; PA6   OUT     AUTO GAIN                       
   50                 ; PA7   OUT     ABILITA GATE                    
   51                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   52                 
   53                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   54                 ;       CONFIGURAZIONE PORTA PB
   55                 ;
   56                 ; PB0   OUT     COM ST7 - CLOCK                         DDCLK   
   57                 ; PB1   IN      COINCIDENZA     
   58                 ; PB2   IN      S1 SQUADRATO    
   59                 ; PB3   IN      NO PRINT        
   60                 ; PB4   IN      2048 IMPULSI    
   61                 ; PB5   IN      INGRESSO SERIALE
   62                 ; PB6   OUT     RICERCA AUTOMATICA              
   63                 ; PB7   OUT     COM ST7 - TX DATO                       DDIN            
   64                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   65                 
   66                 
   67                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   68                 ;       CONFIGURAZIONE PORTA PC
   69                 ;
   70                 ; PC0   OUT     AVANTI                                  OPTO1
   71                 ; PC1   OUT     RITARDO                                 OPTO2
   72                 ; PC2   OUT     AUTOMAN LONG                            -----
   73                 ; PC3   OUT     ALLARME                                 OPTO5
   74                 ; PC4   OUT     AUTOMAN TRAV                            -----
   75                 ; PC5   OUT     FUNZIONE AGGIUNTIVA (F6)                OPTO6
   76                 ; PC6   OUT     DESTRA/TRAVERSA/+TIRO                   OPTO3
   77                 ; PC7   OUT     SINISTRA/OPERATORE/-TIRO                OPTO4
   78                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   79                 
   80                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   81                 ;       CONFIGURAZIONE PORTA PD
   82                 ;
   83                 ; PD0   OUT     DA0     SELEZIONE APPLICAZIONE / TESTINA
   84                 ; PD1   OUT     DA1     SELEZIONE ENCODER
   85                 ; PD2   OUT     DA2
   86                 ; PD3   OUT     DA3     DAC CLOCK       
   87                 ; PD4   OUT     DA4     DAC LOAD
   88                 ; PD5   OUT     DA5     DAC SRI
   89                 ; PD6   OUT     DA6
   90                 ; PD7   OUT     DA7
   91                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   92                 
   93                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
   94                 ;       CONFIGURAZIONE CTC
   95                 ;
   96                 ; CTC0  AMPIEZZA GATE
   97                 ; CTC1  RICERCA AUTOMATICA E TEMPO DI CORREZIONE
   98                 ; CTC2  TEMPO DI CORREZIONE
   99                 ; CTC3  DOPPIO SEGNO
  100                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  101                 
  102                 
  103                 
  104                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  105                 ;       AREA DI MEMORIA VOLATILE C000-CFFFH (RESETTATA ALL'AVVIO)
  106                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  107                 
  108  C000           TABCON:         EQU     0C000H   ;INIZIO AREA DI MEMORIA VOLATILE C000-CFFFH
  109                 
  110                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  111                 ;       AREA DI MEMORIA OPERAZIONI
  112                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  113  C000           DIVDEN:         EQU     0C000H   ;DIVIDENDO
  114  C002           DIVSOR:         EQU     0C002H   ;DIVISORE
  115  C004           QUOZIE:         EQU     0C004H   ;RISULTATO DIVISIONE
  116  C006           MOLTI:          EQU     0C006H   ;MOLTIPLICATORE
  117  C008           MOLPL:          EQU     0C008H   ;MOLTIPLICANDO
  118  C00A           PROD:           EQU     0C00AH   ;PRODOTTO
  119  C00C           MOLT24:         EQU     0C00CH   ;MOLTIPLICATORE                MOLTIPLICA      24 BIT
  120  C00E           MOLP24:         EQU     0C00EH   ;MOLTIPLICANDO                 MOLTIPLICA      24 BIT
  121  C010           PROD24:         EQU     0C010H   ;PRODOTTO                      MOLTIPLICA      24 BIT (ARRAY DI 3 BYTES)
  122  C014           QU4096:         EQU     0C014H   ;QUOZIENTE                     DIVISIONE PER 4096
  123  C016           QU1000:         EQU     0C016H   ;QUOZIENTE                     DIVISIONE PER 1000
  124  C018           RESTO:          EQU     0C018H   ;MEMORIA RESTO                 DIVISIONE       16 BIT  
  125  C01A           ADDEN0:         EQU     0C01AH   ;ADDENDO BASSO                 SOMMA           32 BIT
  126  C01C           ADDEN2:         EQU     0C01CH   ;ADDENDO ALTO                  SOMMA           32 BIT
  127  C01E           AUGEN0:         EQU     0C01EH   ;AUGENDO BASSO                 SOMMA           32 BIT
  128  C020           AUGEN2:         EQU     0C020H   ;AUGENDO ALTO                  SOMMA           32 BIT
  129  C022           CADDE0:         EQU     0C022H   ;ADDENDO BASSO                 SOMMA           32 BIT
  130  C024           CADDE2:         EQU     0C024H   ;ADDENDO ALTO                  SOMMA           32 BIT
  131  C026           CAUGE0:         EQU     0C026H   ;AUGENDO BASSO                 SOMMA           32 BIT
  132  C028           CAUGE2:         EQU     0C028H   ;AUGENDO ALTO                  SOMMA           32 BIT
  133  C02A           CSOMM0:         EQU     0C02AH   ;SOMMA BASSA                   SOMMA           32 BIT
  134  C02C           CSOMM2:         EQU     0C02CH   ;SOMMA ALTA                    SOMMA           32 BIT
  135  C02E           MREST0:         EQU     0C02EH   ;RESTO BASSA                   SOTTRAZIONE     32 BIT
  136  C030           MREST2:         EQU     0C030H   ;RESTO ALTA                    SOTTRAZIONE     32 BIT
  137  C032           MDO032:         EQU     0C032H   ;MOLTIPLICANDO BASSO           MOLTIPLICAZIONE 32 BIT 
  138  C034           MDO232:         EQU     0C034H   ;MOLTIPLICANDO ALTO            MOLTIPLICAZIONE 32 BIT 
  139  C036           MRE032:         EQU     0C036H   ;MOLTIPLICATORE BASSO          MOLTIPLICAZIONE 32 BIT 
  140  C038           MRE232:         EQU     0C038H   ;MOLTIPLICATORE ALTO           MOLTIPLICAZIONE 32 BIT
  141  C03A           PTO032:         EQU     0C03AH   ;PRODOTTO BASSO                MOLTIPLICAZIONE 32 BIT 
  142  C03C           PTO232:         EQU     0C03CH   ;PRODOTTO ALTO                 MOLTIPLICAZIONE 32 BIT
  143  C03E           EDEND0:         EQU     0C03EH   ;DIVIDENDO BASSO               DIVISIONE 4096  32 BIT
  144  C040           EDEND2:         EQU     0C040H   ;DIVIDENDO ALTO                DIVISIONE 4096  32 BIT
  145  C042           QUOZ32:         EQU     0C042H   ;QUOZIENTE                     DIVISIONE 4096  32 BIT
  146  C044           MINUE0:         EQU     0C044H   ;MINUENDO BASSO                SOTTRAZIONE     32 BIT
  147  C046           MINUE2:         EQU     0C046H   ;MINUENDO ALTO                 SOTTRAZIONE     32 BIT
  148  C048           SUBTR0:         EQU     0C048H   ;SOTTRAENDO BASSO              SOTTRAZIONE     32 BIT
  149  C04A           SUBTR2:         EQU     0C04AH   ;SOTTRAENDO ALTO               SOTTRAZIONE     32 BIT               
  150  C04C           RESTO0:         EQU     0C04CH   ;RESTO BASSO                   SOTTRAZIONE     32 BIT
  151  C04E           RESTO2:         EQU     0C04EH   ;RESTO ALTO                    SOTTRAZIONE     32 BIT
  152                 
  153  C050           MIXUE0:         EQU     0C050H   ;MINUENDO ALTERNATIVO BASSO    SOTTRAZIONE     32 BIT
  154  C052           MIXUE2:         EQU     0C052H   ;MINUENDO ALTERNATIVO ALTO     SOTTRAZIONE     32 BIT
  155  C054           SUXTR0:         EQU     0C054H   ;SOTTRAENDO ALTERNATIVO BASSO  SOTTRAZIONE     32 BIT
  156  C056           SUXTR2:         EQU     0C056H   ;SOTTRAENDO ALTERNATIVO ALTO   SOTTRAZIONE     32 BIT
  157                 
  158  C058           TINUE0:         EQU     0C058H   ;MINUENDO BASSO                SOTTRAZIONE     32 BIT
  159  C05A           TINUE2:         EQU     0C05AH   ;MINUENDO ALTO                 SOTTRAZIONE     32 BIT
  160  C05C           TUBTR0:         EQU     0C05CH   ;SOTTRAENDO BASSO              SOTTRAZIONE     32 BIT
  161  C05E           TUBTR2:         EQU     0C05EH   ;SOTTRAENDO ALTO               SOTTRAZIONE     32 BIT       
  162  C060           TREST0:         EQU     0C060H   ;RESTO BASSO                   SOTTRAZIONE     32 BIT
  163  C062           TREST2:         EQU     0C062H   ;RESTO ALTO                    SOTTRAZIONE     32 BIT
  164                 
  165  C064           TIXUE0:         EQU     0C064H   ;MINUENDO ALTERNATIVO BASSO    SOTTRAZIONE     32 BIT
  166  C066           TIXUE2:         EQU     0C066H   ;MINUENDO ALTERNATIVO ALTO     SOTTRAZIONE     32 BIT
  167  C068           TUXTR0:         EQU     0C068H   ;SOTTRAENDO ALTERNATIVO BASSO  SOTTRAZIONE     32 BIT
  168  C06A           TUXTR2:         EQU     0C06AH   ;SOTTRAENDO ALTERNATIVO ALTO   SOTTRAZIONE     32 BIT
  169                 
  170  C06C           CINUE0:         EQU     0C06CH   ;MINUENDO BASSO CSOTT32        SOTTRAZIONE     32 BIT
  171  C06E           CINUE2:         EQU     0C06EH   ;MINUENDO ALTO CSOTT32         SOTTRAZIONE     32 BIT
  172  C070           CUBTR0:         EQU     0C070H   ;SOTTRAENDO BASSO CSOTT32      SOTTRAZIONE     32 BIT
  173  C072           CUBTR2:         EQU     0C072H   ;SOTTRAENDO ALTO CSOTT32       SOTTRAZIONE     32 BIT            
  174  C074           CESTO0:         EQU     0C074H   ;RESTO BASSO CSOTT32           SOTTRAZIONE     32 BIT
  175  C076           CESTO2:         EQU     0C076H   ;RESTO BASSO CSOTT32           SOTTRAZIONE     32 BIT
  176                 
  177  C078           MDIVIS:         EQU     0C078H   ;TEMPORANEA                    DIVISIONE 1000
  178  C07A           COUNTER32:      EQU     0C07AH   ;CONTIENE INDIRIZZO DI MEMORIA DEL CONTATORE DA CONTROLLARE
  179  C07C           COMP16A:        EQU     0C07CH   ;WORD A DA COMPARARE/RISULTATO COMPARATORE     16 BIT
  180  C07E           COMP16B:        EQU     0C07EH   ;WORD B DA COMPARARE           COMPARATORE     16 BIT
  181  C080           DIV4096:        EQU     0C080H   ;DIVIDENDO                     DIVISIONE PER 4096       (ARRAY DI 3 BYTES)
  182  C082           DIV32_DIVID_L:  EQU     0C082H   ;DIVIDENDO ALTO                DIVISIONE       32 BIT
  183  C084           DIV32_DIVID_H:  EQU     0C084H   ;DIVIDENDO BASSO               DIVISIONE       32 BIT
  184  C086           DIV32_DIVIS_L:  EQU     0C086H   ;DIVISORE ALTO                 DIVISIONE       32 BIT
  185  C088           DIV32_DIVIS_H:  EQU     0C088H   ;DIVISORE BASSO                DIVISIONE       32 BIT
  186  C08A           DIV32_QUOZ_L:   EQU     0C08AH   ;QUOZIENTE ALTO                DIVISIONE       32 BIT
  187  C08C           DIV32_QUOZ_H:   EQU     0C08CH   ;QUOZIENTE BASSO               DIVISIONE       32 BIT
  188                 ;               EQU     0C084H
  189                 
  190                 
  191                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  192                 ;       AREA DI MEMORIA VARIABILI D'INPUT/OUTPUT
  193                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  194                 
  195  C09A           MEMA:           EQU     0C09AH   ;MEMORIA DELLA PORTA A  
  196  C09B           MEMB:           EQU     0C09BH   ;MEMORIA DELLA PORTA B  
  197  C09C           MEMC:           EQU     0C09CH   ;MEMORIA DELLA PORTA C
  198  C09D           MEMD:           EQU     0C09DH   ;MEMORIA DELLA PORTA C
  199                 
  200                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  201                 ;       AREA DI MEMORIA ARRAY TEMPORANEA
  202                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  203                 
  204  C0A0           ARR_VELO:       EQU     0C0A0H   ;ARRAY VELOCITA' MEDIA         0C0A0H-0C0BFH
  205  C100           ARR_ERRAVA:     EQU     0C100H   ;ARRAY ERRORE AVANTI           0C100H-0C15FH  
  206  C160           ARR_ERRRIT:     EQU     0C160H   ;ARRAY ERRORE RITARDO          0C160H-0C1BFH
  207  C1C0           ARR_TRASM:      EQU     0C1C0H   ;ARRAY BYTES TRASMISSIONE      C01C0H-C01CAH 
  208  C1D0           ARR_RICAUTO:    EQU     0C1D0H   ;ARRAY RICERCA AUTOMATICA      C01D0H-C01DFH 
  209                                                         ;ARR_RICAUTO+00H - FLAG SE RICERCA AUTOMATICA ATTIVA (01H)
  210                                                         ;ARR_RICAUTO+02H - NUMERO CICLI EFFETTUATI IN RICERCA AUTOMATICA
  211                                                         ;ARR_RICAUTO+04H - FLAG ATTIVA RICERCA "SEGNO DOPPIO" (DA TOGLIERE)
  212                                                         ;ARR_RICAUTO+06H - FLAG NUMERO DI SEGNI PER DARE "SEGNO DOPPIO"
  213                                                         ;ARR_RICAUTO+08H - FLAG PER NON RIPETERE MESSAGGI (DA TOGLIERE)
  214                                                         ;ARR_RICAUTO+0AH - CONTATORE DI CICLI IN CUI SI E' RILEVATO "SEGNO DOPPIO"
  215                 
  216                 
  217                 
  218  C200           ARR_TAB_IDX:    EQU     0C200H   ;ARRAY TRASCODIFICA INDIRIZZI  0C200H-0C2FFH 
  219                 
  220                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  221                 ;       AREA DI MEMORIA VARIABILI TEMPORANEE
  222                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  223                 
  224  C300           RESET:          EQU     0C300H   ;SE ATTIVO FORZA RESET DELLA MACCHINA
  225  C302           VELDIS:         EQU     0C302H   ;ULTIMA VELOCITA' SPEDITA
  226  C304           VELPRE:         EQU     0C304H   ;VELOCITA' PRECEDENTE
  227  C306           VELIMP:         EQU     0C306H   ;IMPULSI ENCODER IN 4 mS 
  228  C308           VELIST:         EQU     0C308H   ;VELOCITA' ISTANTANEA
  229  C30A           VELMED:         EQU     0C30AH   ;MEDIA DELLA VELOCITA'
  230  C30C           TMSCOR:         EQU     0C30CH   ;CORREZIONE TRASVERSALE
  231  C30E           CONSAL:         EQU     0C30EH   ;CONTEG. SALTI DI NON CORREZIONE LONG.
  232  C310           CONSAT:         EQU     0C310H   ;CONTEG. SALTI DI NON CORCORREZIONE TRAV.
  233  C312           DECORR:         EQU     0C312H   ;VALORE DI CORREZIONE A DECR.LONGITUD.
  234  C314           MDECOR:         EQU     0C314H   ;EXTRA VALORE DI CORREZIONE LONGITUD.
  235  C316           CORRE:          EQU     0C316H   ;VALORE DI CORREZIONE MOTORE
  236  C318           SUPCOR:         EQU     0C318H   ;AVVISO SPOSTAMENTO > DI 1/2 GATE  
  237  C31A           SHIFT3:         EQU     0C31AH   ;QUANTE VOLTE AMPI40 STA IN SHIFT  
  238  C31C           SHIFT4:         EQU     0C31CH   ;RESTO DELLA DIVISIONE SHIFT AMPIMP 
  239  C31E           TIRCIR_ATT:     EQU     0C31EH   ;USATA NEL TIRO
  240  C320           DACVAL:         EQU     0C320H   ;VALORE 0-4095 DA SPEDIRE AL DAC
  241  C322           ENCOD1:         EQU     0C322H   ;USATA IN TEST ENCODER
  242  C324           ENCOD2:         EQU     0C324H   ;USATA IN TEST ENCODER
  243  C326           ENCOD3:         EQU     0C326H   ;CONTEGGIO TENTATIVI TEST 
  244  C328           ENCOD4:         EQU     0C328H   ;CONTEGGIO IMPULSI FINALE  
  245  C32A           TEST_ENC:       EQU     0C32AH   ;SEGNALAZIONE RICHIESTA TEST
  246  C32C           TMEM4:          EQU     0C32CH   ;ATTIVAZIONE CORREZIONE TIRO
  247  C32E           TMEM5:          EQU     0C32EH   ;USATA IN CORREZIONE TRASVERSALE
  248  C330           TMEM6:          EQU     0C330H   ;SENSO CORREZIONE TIRO
  249  C332           CONALL:         EQU     0C332H   ;CONTEGGIO AVVISI ALLARME CIRC.
  250  C334           MEMW:           EQU     0C334H   ;USATA IN CALCOLO CORREZIONE MOTORE
  251  C336           MCALER:         EQU     0C336H   ;SEGNALA AL MAIN DI CALCOLARE
  252  C338           MSCORR:         EQU     0C338H   ;SENSO DELLA CORREZIONE
  253  C33A           MSCORR_PREC:    EQU     0C33AH   ;SENSO DELL'ERRORE PRECEDENTE
  254  C33C           ALTDIV:         EQU     0C33CH   ;ALTERNA I VALORI NELLA DIVISIONE
  255  C33E           MEMLED:         EQU     0C33EH   ;LED PRECEDENTEMENTE SPEDITI
  256  C340           PROPRI:         EQU     0C340H   ;AVVISO PROTEZIONE MANCANZA STAMPA 
  257  C342           PROVEL:         EQU     0C342H   ;AVVISO PROTEZIONE BASSA VELOCITA 
  258  C344           MATTES:         EQU     0C344H   ;USATA IN DECREM.CILCI ATTESA
  259  C346           MFASE:          EQU     0C346H   ;INIZIO GATE DELLA FASE S1
  260  C348           MFASES1:        EQU     0C348H   ;FASE DI S1
  261  C34A           MFASRIF:        EQU     0C34AH   ;FASE DI RIFERIMENTO DI S1
  262  C34C           INCREM:         EQU     0C34CH   ;MEM.A DECR.INCREMENTA VALORE   
  263  C34E           DECREM:         EQU     0C34EH   ;MEM.A DECR.DECREMENTA VALORE
  264  C350           ERATTU:         EQU     0C350H   ;ERRORE ATTUALE
  265  C352           ERPREC:         EQU     0C352H   ;ERRORE PRECEDENTE          
  266  C354           ERMEDI:         EQU     0C354H   ;MEMORIA ERRORE MEDIO LONG      
  267  C356           ERMEDI_DISP:    EQU     0C356H   ;MEMORIA ERRORE MEDIO LONGITUDINALE DA SPEDIRE
  268  C358           ERMEDI_SIGN:    EQU     0C358H   ;SEGNO ERRORE MEDIO LONG (1=POSITIVO,8=NEGATIVO)
  269  C35A           SOMLO1:         EQU     0C35AH   ;PRIMA SOMMA PER MEDIA LONG    
  270  C35C           SOMLO2:         EQU     0C35CH   ;SECONDA SOMMA PER MEDIA LONG  
  271  C35E           PRIMOB:         EQU     0C35EH   ;VALORE DA DARE AL PRIMO REG B IN MEDIALOMG   
  272  C360           SECONB:         EQU     0C360H   ;VALORE DA DARE AL SECONDO REG B IN MEDIALOMG 
  273  C362           VALORX:         EQU     0C362H   ;VALORE DA DARE AL REG IX IN MEDIALOMG
  274  C364           AUTOCENTRA:     EQU     0C364H   ;IMPOSTARE A 1 PER FORZARE LA CENTRATURA DEL GATE (FASE CON OSCILLOSCOPIO)
  275  C366           WATCHDOG_ST7_H: EQU     0C366H   ;CICLI (WORD ALTA) DI ATTESA IRQ DA ST7 PRIMA DI RESETTARE (USATO IN REQISFREE)
  276  C368           WATCHDOG_ST7_L: EQU     0C368H   ;CICLI (WORD BASSA) DI ATTESA IRQ DA ST7 PRIMA DI RESETTARE (USATO IN REQISFREE)
  277  C36A           WATCHDOG_ST7_H_TMP: EQU 0C36AH   ;CICLI ATTUALI DEL CONTATORE (WORD ALTA) 
  278  C36C           WATCHDOG_ST7_L_TMP: EQU 0C36CH   ;CICLI ATTUALI DEL CONTATORE (WORD BASSA)
  279  C36E           CODICE_BIANCO:  EQU     0C36EH   ;MINIMO SPAZIO BIANCO (IN IMPULSI DI ENCODER) PER RICERCA AUTOMATICA CODICE
  280  C370           CODICE_NERO:    EQU     0C370H   ;MINIMO SPAZIO NERO (IN IMPULSI DI ENCODER) PER RICERCA AUTOMATICA CODICE
  281  C372           CODICE_ENC_N1:  EQU     0C372H   ;VALORE ATTUALE CODICE N1 IN 4096 IMPULSI DI ENCODER
  282  C374           CODICE_ENC_B1:  EQU     0C374H   ;VALORE ATTUALE CODICE B1 IN 4096 IMPULSI DI ENCODER
  283  C376           CODICE_ENC_N2:  EQU     0C376H   ;VALORE ATTUALE CODICE N2 IN 4096 IMPULSI DI ENCODER
  284  C378           CODICE_ENC_B2:  EQU     0C378H   ;VALORE ATTUALE CODICE B2 IN 4096 IMPULSI DI ENCODER
  285  C37A           DAC_INCREM:     EQU     0C37AH   ;VALORE DI INCREMENTO SU BASE DAC
  286  C37C           DAC_DECREM:     EQU     0C37CH   ;VALORE DI DECREMENTO SU BASE DAC
  287  C37E           DAC_INCREM_BASE:EQU     0C37EH   ;VALORE DI INCREMENTO SU BASE DAC
  288  C380           DAC_DECREM_BASE:EQU     0C380H   ;VALORE DI DECREMENTO SU BASE DAC
  289  C382           STATUS:         EQU     0C382H   ;CONTIENE LO STATUS DEGLI ALLARMI (2BYTE)
  290  C384           STATU2:         EQU     0C384H   ;CONTIENE LO STATUS INVIATO DEGLI ALLARMI (2BYTE)
  291                                                  ; 0 = SVILUPPO CILINDRO
  292                                                  ; 1 = AMPIEZZA GATE
  293                                                  ; 2 = SEGNO DI RIFERIMENTO
  294                                                  ; 3 = ERRORE GENERICO
  295                                                  ; 4 = MANCANZA STAMPA
  296                                                  ; 5 = VELOCITA' SOTTO SOGLIA
  297                                                  ; 6 = SUPERAMENTO SOGLIA D'ERRORE
  298                                                  ; 7 = ------ NON USATO  -----
  299                                                  ; 8 = TEST TESTINA FALLITO
  300                                                  ; 9 = TEST ENCODER FALLITO
  301                                                  ;10 = FASATURA FALLITA
  302                                                  ;11 = ------ NON USATO  -----
  303                                                  ;12 = ------ NON USATO  -----
  304                                                  ;13 = ------ NON USATO  -----
  305                                                  ;14 = ------ NON USATO  -----
  306                                                  ;15 = ------ NON USATO  -----
  307  C386           CORRATT:        EQU     0C386H   ;CONTIENE IL VALORE CON SEGNO DELLA CORREZIONE IN BASE ALL'ERRORE (4BYTE)
  308  C38A           MSCORR_ATT:     EQU     0C38AH   ;SENSO DELL'ERRORE ATTUALE
  309                 
  310                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  311                 ;       AREA DI MEMORIA NON VOLATILE D000-DFFFH
  312                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  313                 
  314  D000           TAB_DUMMY:      EQU     0D000H   ;AREA DI MEMORIA DUMMY USATA IN FAITAB
  315                 
  316  D000           VERPRO:         EQU     0D000H   ;VERSIONE PROGRAMMA 
  317                 ;IDMACC:                EQU     0D002H   ;IDENTIFICAZIONE MACCHINA 
  318  D004           COSVEL:         EQU     0D004H   ;COSTANTE USATA IN VELOCITA'
  319  D006           CENTES:         EQU     0D006H   ;CENTESIMI IN UN IMP.DI ENCODER
  320  D008           MILLES:         EQU     0D008H   ;MILLESIMI IN UN IMP.DI ENCODER
  321  D00A           AMPI10:         EQU     0D00AH   ;AMPIMP x 40 USATA CON CKTG0 1024 
  322  D00C           FASE:           EQU     0D00CH   ;INIZIO GATE DELLA FASE S1
  323  D00E           FASES1:         EQU     0D00EH   ;FASE DI S1
  324  D010           FASRIF:         EQU     0D010H   ;FASE DI RIFERIMENTO DI S1
  325  D012           RAPPO1:         EQU     0D012H   ;RAPPORTO S1
  326  D014           RAPRIF:         EQU     0D014H   ;RAPPORTO DI RIFERIMMENTO
  327  D016           RIFTOT:         EQU     0D016H   ;(FASRIFx10)+RAPRIF=RIFTOT
  328  D018           POSTOT:         EQU     0D018H   ;(FASES1x10)+RAPRIF=RIFTOT
  329  D01A           PIENO1:         EQU     0D01AH   ;VALORE DEL PIENO S1
  330  D01C           POSIZ1:         EQU     0D01CH   ;VALORE DELLA POSIZIONE S1
  331  D01E           MEMRIF:         EQU     0D01EH   ;RIFERIMENTI
  332  D020           UNOMIL:         EQU     0D020H   ;1mm IN IMPULSI ENCODER
  333  D022           AMPIMP:         EQU     0D022H   ;AMPIEZZA GATE IN IMPULSI ENCODER
  334  D024           MEZGA:          EQU     0D024H   ;MEZGA PER 4 MEZGA=AMPIE. 50% GATE  
  335  D026           CILDIV:         EQU     0D026H   ;CILINDRO DIVISO 10
  336  D028           CILIN:          EQU     0D028H   ;CILINDRO IN MM
  337  D02A           CICL75:         EQU     0D02AH   ;75% DEL CICLO DI CORREZIONE 
  338  D02C           CIDE75:         EQU     0D02CH   ;75% DEL CICLO DI CORREZIONE 
  339  D02E           SEQSEG:         EQU     0D02EH   ;POS.SEGNO NELLA SEQUENZA 
  340  D030           SEGNO:          EQU     0D030H   ;IMP. DA 2048 IN UN SEGNO DA 2mm
  341  D032           SPAZIO:         EQU     0D032H   ;IMP. DA 2048 IN UNO SPAZIO DA 5mm
  342  D034           SPAZ40:         EQU     0D034H   ;IMP. DA 2048 IN SPAZIO DA 40mm
  343  D036           DISTAN:         EQU     0D036H   ;DISTANZA TEORICA TRA S1 E S2
  344  D038           MILL20:         EQU     0D038H   ;20mm IN IMPULSI ENCODER     
  345  D03A           MILL40:         EQU     0D03AH   ;40mm IN IMPULSI ENCODER
  346  D03C           GUADS1:         EQU     0D03CH   ;VALORE GUADAGNO SEGNALE S1
  347  D03E           DMILLE:         EQU     0D03EH   ;DECIMILLESIMI IN UN IMP.DI ENCOD
  348  D040           DISTA0:         EQU     0D040H   ;DISTANZA BASSA IN DECIMILLESIMI
  349  D042           DISTA2:         EQU     0D042H   ;DISTANZA ALTA IN DECIMILLESIMI
  350  D044           TDIST0:         EQU     0D044H   ;DISTAN. BASSA IN DECIMILL.TRAV
  351  D046           TDIST2:         EQU     0D046H   ;DIATAN. ALTA  IN DECIMILL.TRAV
  352  D048           SHIFT:          EQU     0D048H   ;SPOSTAMENTO REGISTRO
  353  D04A           AVARIT:         EQU     0D04AH   ;SENSO DELLO SPOSTAMENTO LONG
  354  D04C           TRAOPE:         EQU     0D04CH   ;SENSO DELLO SPOSTAMENTO TRAV
  355  D04E           DMEZGA:         EQU     0D04EH   ;40% GATE IN CENTESIMI
  356  D050           CENSEN:         EQU     0D050H   ;VALORE SEGNO CENTRATO NEL GATE
  357  D052           AMPMEZ:         EQU     0D052H   ;AMPIMP DIVISO 2
  358  D054           AMPI40:         EQU     0D054H   ;AMPIEZZA GATE DEL40%  IN CENTS  
  359  D056           AUMATI_OLD:     EQU     0D056H   ;VALORE DI AUMATI PRIMA DI ENTRARE IN F9
  360                 ;CICLI_F9:      EQU     0D058H   ;GIRI ATTESA PRIMA DI ANNULLARE F9
  361  D05A           CENTE4:         EQU     0D05AH   ;CENTES PER 4 
  362  D05C           TDISPR:         EQU     0D05CH   ;ERRORE DISPLAY TRAV.PRECEDENTE 
  363  D05E           TERATT:         EQU     0D05EH   ;ERRORE ATTUALE TRAVERS 
  364  D060           IMPMIL:         EQU     0D060H   ;IMPULSI DA 2048 PER mm PIU UNO  
  365  D062           BIANCO:         EQU     0D062H   ;MINIMO SPAZIO BIANCO PER RA   
  366  D064           CILMOL:         EQU     0D064H   ;SVILUPPO CILINDRO IN DECIMI DI MM
  367  D066           ALLAR:          EQU     0D066H   ;VALORE ALLARME IN CENTESIMI
  368  D068           AMPGA:          EQU     0D068H   ;AMPIEZZA GATE IN mm  
  369  D06A           GUADA:          EQU     0D06AH   ;GUAD.min 11 x CIL=2000
  370  D06C           CICLO:          EQU     0D06CH   ;INTERVALLO DI  DI CORREZIONE LONGITUDINALE
  371  D06E           DERIVA:         EQU     0D06EH   ;DERIVATIVO LONGITUDINALE
  372  D070           ZONA:           EQU     0D070H   ;ZONA MORTA LONGITUDINALE
  373  D072           INSER:          EQU     0D072H   ;VELOCITA' MINIMA 
  374  D074           SALTO:          EQU     0D074H   ;SALTO ANIMALIE
  375  D076           ZONT:           EQU     0D076H   ;ZONA MORTA TRAVERSALE
  376  D078           TRIP:           EQU     0D078H   ;SENSIBILITA' CAMBIO VELOCITA' 
  377  D07A           GUATRA:         EQU     0D07AH   ;GUADAGNO TRAVERSALE
  378  D07C           TCICLO:         EQU     0D07CH   ;INTERVALLO TRAVERSALE
  379  D07E           MESSA:          EQU     0D07EH   ;SELEZIONE TIPO DI MESSA A REGISTRO   
  380  D080           REV_CORRECTION: EQU     0D080H   ;CORREZIONE NORMALE O INVERSA
  381  D082           MM_MC:          EQU     0D082H   ;SELEZIONE MM/MC  
  382  D084           SEGRIF:         EQU     0D084H   ;SCELTA SEGNO DI RIFERIMENTO SSRR 
  383  D086           VCLONG:         EQU     0D086H   ;VELOCITA DI CORREZIONE LONGITUDINALE 
  384  D088           VCTRAV:         EQU     0D088H   ;VELOCITA DI CORREZIONE TRASVERSALE  
  385  D08A           DIAGON:         EQU     0D08AH   ;POSIZIONE IPOTENUSA 
  386  D08C           TIRGUA:         EQU     0D08CH   ;GUADAGNO DI TIRO
  387  D08E           TIRCIC:         EQU     0D08EH   ;CICLO DI TIRO
  388  D090           PRESS:          EQU     0D090H   ;TIPO DI ROTATIVA
  389  D092           DACOFFSET:      EQU     0D092H   ;VALORE OFFSET DAC
  390  D094           AUMALO:         EQU     0D094H   ;MANUALE/AUTOMATICO LONGITUDINALE 
  391  D096           AUMATR:         EQU     0D096H   ;MANUALE/AUTOMATICO TRASVERSALE
  392  D098           AUMATI:         EQU     0D098H   ;MANUALE/AUTOMATICO TIRO
  393  D09A           ENB_TRASVERSALE:EQU     0D09AH   ;ABILITA TRASVERSALE
  394  D09C           ENB_TIRO:       EQU     0D09CH   ;ABILITA TIRO
  395  D09E           ENB_COLDSEAL:   EQU     0D09EH   ;ABILITA FUNZIONE REGISTRO COLD SEAL
  396  D0A0           ENB_DAC_LON:    EQU     0D0A0H   ;ABILITA DAC ERRORE LONG 
  397  D0A2           ENB_DAC_TRA:    EQU     0D0A2H   ;ABILITA DAC ERRORE TRAV 
  398  D0A4           ENB_DAC_TIR:    EQU     0D0A4H   ;ABILITA DAC TIRO 
  399  D0A6           DACBASE1000:    EQU     0D0A6H   ;VALORE 0-1000 DA USARE COME BASE PER IL DAC
  400  D0A8           DACBASE:        EQU     0D0A8H   ;VALORE 0-4095 DA USARE COME BASE PER IL DAC
  401  D0AA           DACDELTACOR:    EQU     0D0AAH   ;VALORE DEL DELTA DA APPLICARE IN CORREZIONE
  402  D0AC           DACDELTATIR:    EQU     0D0ACH   ;VALORE DEL DELTA DA APPLICARE IN CORREZIONE TIRO
  403  D0AE           DACMANGUA:      EQU     0D0AEH   ;GUADAGNO CORREZIONE MANUALE
  404                 
  405                 
  406  D0B0           LAVORO:         EQU     0D0B0H   ;NøDEL LAVORO PRESENTE
  407  D0B2           TWIN_APP_01:    EQU     0D0B2H   ;PRIMA FUNZIONALITA' TWIN
  408  D0B4           TWIN_APP_02:    EQU     0D0B4H   ;SECONDA FUNZIONALITA' TWIN
  409  D0B6           TWIN_CURRENTAPP:EQU     0D0B6H   ;FUNZIONALITA' TWIN CORRENTE
  410  D0B8           LINGUA:         EQU     0D0B8H   ;MEMORIA DELLA LINGUA
  411  D0BA           ENCOD:          EQU     0D0BAH   ;FUNZIONAMENTO CON ENCODER NPN O PNP (SI AUTOSETTA SU TEST ENCODER)
  412  D0BC           CURRENT_ENCODER:EQU     0D0BCH   ;ENCODER CORRENTEMENTE SELEZIONATO
  413  D0BE           F4_DIMENSION:   EQU     0D0BEH   ;MINIMO SPAZIO BIANCO (IN MILLIMETRI) PER RICERCA AUTOMATICA CODICE
  414  D0C0           ENB_SH_PN:      EQU     0D0C0H   ;ABILITA MENU AMPLIFICATORE POSITIVO/NEGATIVO
  415  D0C2           SH_PN:          EQU     0D0C2H   ;AMPLIFICATORE POSITIVO/NEGATIVO
  416                 
  417                 
  418  DA20           TAP1:           EQU     0DA20H   ;IND. INTERRUPT PIO1A
  419  DA22           TAP2:           EQU     0DA22H   ;IND. INTERRUPT PIO1B
  420  DA30           TAB0:           EQU     0DA30H   ;IND. INTERRUPT CTC CANALE 0
  421  DA32           TAB1:           EQU     0DA32H   ;IND. INTERRUPT CTC CANALE 1
  422  DA34           TAB2:           EQU     0DA34H   ;IND. INTERRUPT CTC CANALE 2
  423  DA36           TAB3:           EQU     0DA36H   ;IND. INTERRUPT CTC CANALE 3
  424                 
  425  DB00           ARR_TMP:        EQU     0DB00H   ;INIZIO TABELLA MEM. LAVORI
  426  D990           TMP_CURSOR:     EQU     0D990H   ;USATA NELLA CREAZIONE TABELLE TEST
  427                 
  428                 
  429                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  430                 ;                        BIT DI PC (USCITE)
  431                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  432  0000           B_PC_AVANTI:    EQU     0
  433  0001           B_PC_RITARDO:   EQU     1
  434  0003           B_PC_ALLARME:   EQU     3
  435  0004           B_PC_PROTEZIONE:EQU     4       ;TODO:MA NON E' DA RIMUOVERE?
  436  0005           B_PC_FUNZ:      EQU     5
  437  0006           B_PC_DESTRA:    EQU     6
  438  0007           B_PC_SINISTRA:  EQU     7
  439                 
  440                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  441                 ;                       POSSIBILI STATI DI DIRECTION
  442                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  443  0001           D_AVANTI:       EQU     01H
  444  0008           D_RITARDO:      EQU     08H
  445                 
  446  0001           D_TRAVERSA:     EQU     01H
  447  0008           D_OPERATORE:    EQU     08H
  448                 
  449  0001           D_INC_TIRO:     EQU     01H
  450  0008           D_DEC_TIRO:     EQU     08H
  451                 
  452  0001           D_DESTRA:       EQU     01H
  453  0008           D_SINISTRA:     EQU     08H
  454                 
  455                 
  456  0005           C_MEMRIF:       EQU     05H
  457                 
  458                 
  459                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  460                 ;               INIZIALIZZAZIONE SISTEMA
  461                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  462  0000                           ORG     0000H
  463  0000 C30001                    JP      VIA
  464                 
  465  0008                           ORG     0008H
  466  0008 C30001                    JP      VIA
  467                 
  468  0010                           ORG     0010H
  469  0010 C30001                    JP      VIA
  470                 
  471  0018                           ORG     0018H
  472  0018 C30001                    JP      VIA
  473                 
  474  0020                           ORG     0020H
  475  0020 C30001                    JP      VIA
  476                 
  477  0028                           ORG     0028H
  478  0028 C30001                    JP      VIA
  479                 
  480  0030                           ORG     0030H
  481  0030 C30001                    JP      VIA
  482                 
  483  0038                           ORG     0038H
  484  0038 C30001                    JP      VIA
  485                 
  486                 
  487  0100                           ORG     100H
  488                 
  489  0100           VIA:
  490                 
  491                                 
  492                 
  493  0100           RESET_PIO:            
  494  0100 210E01                    LD      HL,INIT_Z80
  495  0103 22FFDF                    LD      (0DFFFH),HL
  496  0106 22FDDF                    LD      (0DFFDH),HL
  497  0109 31FDDF                    LD      SP,0DFFDH       ;DEF.AREA STACK
  498  010C ED4D                      RETI
  499                 
  500  010E           INIT_Z80:
  501  010E 210001                    LD      HL,VIA
  502  0111 22FFDF                    LD      (0DFFFH),HL
  503  0114 31FFDF                    LD      SP,0DFFFH       ;DEF.AREA STACK
  504                 
  505  0117 ED5E                      IM      2               ;IMPOSTA MODO PIO = 2
  506                 
  507  0119 3EDA                      LD      A,0DAH          ;INDIRIZZO INIZIALE VETTORE DI INTERRUPT
  508  011B ED47                      LD      I,A             ;I INTERRUPT VECTOR BASE REGISTER, 8 BITS
  509                 
  510  011D FD213C07                  LD      IY,PIOA         ;INSERISCO FUNZIONE DI GESTIONE INTERRUPT
  511  0121 FD2220DA                  LD      (TAP1),IY       ;NEL VETTORE DI INTERRUPT
  512                 
  513                         
  514  0125 3E20                      LD      A,20H           ;COMUNICO LA POSIZIONE DEL VETTORE DI INTERRUPT 
  515  0127 D302                      OUT     (PA_CMD),A      ;DA CHIAMARE PER PIO A
  516                                                         ;V7 V6 V5 V4 V3 V2 V1 0                 
  517                 
  518  0129 3ECF                      LD      A,11001111B     ;PORTA A MODO 3 (SEGUE IO E IRQ)
  519  012B D302                      OUT     (PA_CMD),A      ;M1 M0 X X 1 1 1 1
  520                 
  521                 
  522  012D 3E11                      LD      A,00010001B     ;IO PORT (0,4 IN)
  523  012F D302                      OUT     (PA_CMD),A      ;IO7 IO6 IO5 IO4 IO3 IO2 IO1 IO0 
  524                 
  525  0131 3E97                      LD      A,10010111B     ;IRQ CONTROL (ABILITA E SEGUE MASK)
  526  0133 D302                      OUT     (PA_CMD),A      ;Enable  AND/   High/   Mask      0 1 1 1
  527                                                         ;  Int   OR     Low     Follows
  528                 
  529  0135 3EEF                      LD      A,11101111B     ;IRQ MASK (BIT 4)
  530  0137 D302                      OUT     (PA_CMD),A      ;MB7 MB6 MB5 MB4 MB3 MB2 MB1 MB0
  531                 
  532                 
  533                 
  534  0139 FD217507                  LD      IY,PIOB         ;IND.ROUT.INT.
  535  013D FD2222DA                  LD      (TAP2),IY       ;CAR.TAB.INT.
  536  0141 3E22                      LD      A,22H           ;VET.INT.PIO B
  537  0143 D303                      OUT     (PB_CMD),A      ;CONTROLLO PIO B
  538  0145 3ECF                      LD      A,0CFH          ;PORTA B MODO 3
  539  0147 D303                      OUT     (PB_CMD),A
  540  0149 3E3E                      LD      A,3EH           ;067 OUT 12345 IN 1E PPUU
  541  014B D303                      OUT     (PB_CMD),A
  542  014D 3E97                      LD      A,97H           ;PAR.CONT.INTER.
  543  014F D303                      OUT     (PB_CMD),A
  544  0151 3EFD                      LD      A,0FDH          ;P.MAS.BIT 0234567  ;0DDH TO USE RS232
  545  0153 D303                      OUT     (PB_CMD),A      ;ALL'INTERUPT
  546                 
  547                 
  548  0155 FD21CA07                  LD      IY,CTC0         ;IND.ROUT.CTC0.
  549  0159 FD2230DA                  LD      (TAB0),IY       ;CAR.TAB.INT.CAN0
  550  015D 3E30                      LD      A,30H           ;VET.IND.CTC0
  551  015F D370                      OUT     (CTC0_CMD),A    ;VET.SEMPRE IN 0
  552  0161 FD214C08                  LD      IY,CTC1         ;IND.ROUT.CTC1
  553  0165 FD2232DA                  LD      (TAB1),IY       ;CAR.TAB.INT.CAN1
  554  0169 3E32                      LD      A,32H           ;VET.IND.CTC1
  555  016B D370                      OUT     (CTC0_CMD),A
  556  016D FD21A508                  LD      IY,CTC2         ;IND.ROUT.CTC2
  557  0171 FD2234DA                  LD      (TAB2),IY       ;CAR.TAB.INT.CAN2
  558  0175 3E34                      LD      A,34H           ;VET.IND.CTC2
  559  0177 D370                      OUT     (CTC0_CMD),A
  560  0179 FD21F808                  LD      IY,CTC3         ;IND.ROUT.CTC3
  561  017D FD2236DA                  LD      (TAB3),IY       ;CAR.TAB.INT.CAN3
  562  0181 3E36                      LD      A,36H           ;VET.IND.CTC3
  563  0183 D370                      OUT     (CTC0_CMD),A    ;VET.CARICATO
  564                 
  565                 
  566                                 ;DEFAULT PER PORTA A
  567  0185 3A9AC0                    LD      A,(MEMA)        
  568  0188 CB8F                      RES     1,A             ;RESET RICHIESTA DI TRASMISSIONE        
  569  018A CBFF                      SET     7,A             ;ABILITO SEMPRE LA GENERAZIONE DEL GATE
  570  018C 329AC0                    LD      (MEMA),A
  571  018F D300                      OUT     (PA),A
  572                 
  573                 
  574                                 ;RESET DELLA PORTA C
  575  0191 3A9CC0                    LD      A,(MEMC)        ;RESETTO LE USCITE
  576  0194 CB87                      RES     B_PC_AVANTI,A             
  577  0196 CB8F                      RES     B_PC_RITARDO,A             
  578  0198 CB9F                      RES     B_PC_ALLARME,A
  579  019A CBAF                      RES     B_PC_FUNZ,A             
  580  019C CBB7                      RES     B_PC_DESTRA,A             
  581  019E CBBF                      RES     B_PC_SINISTRA,A             
  582  01A0 D363                      OUT     (PC),A
  583  01A2 329CC0                    LD      (MEMC),A
  584                 
  585                                 ;RESET DELLA PORTA D
  586  01A5 3EFF                      LD      A,0FFH          ;RESETTO LE USCITE
  587  01A7 CBDF                      SET     3,A             ;SETTO IL CLOCK DEL DAC BASSO IN MODO CHE SIA PRONTO A RICEVERE IL DATO
  588  01A9 CBA7                      RES     4,A             ;SETTO IL DAC ALTO IN MODO CHE SIA PRONTO A RICEVERE IL DATO
  589  01AB D351                      OUT     (PD),A
  590  01AD 329DC0                    LD      (MEMD),A
  591                 
  592                                 ;AZZERAMENTO DA 0C000H A 0CFFFH (MEMORIA VOLATILE)
  593  01B0 3E00                      LD      A,00H
  594  01B2 3200C0                    LD      (TABCON),A      ;LOC. INIZIALE
  595  01B5 2100C0                    LD      HL,TABCON
  596  01B8 1101C0                    LD      DE,TABCON+01H
  597  01BB 01FF0F                    LD      BC,0FFFH
  598  01BE EDB0                      LDIR                    
  599                 
  600  01C0 3E04                      LD      A,04H           ;PER NON AVERE IN
  601  01C2 3244C3                    LD      (MATTES),A      ;DECREMENTO FFH
  602  01C5 320EC3                    LD      (CONSAL),A
  603                 
  604  01C8 3210C3                    LD      (CONSAT),A
  605                 
  606  01CB 3A8ED0                    LD      A,(TIRCIC)      ;CARICO LE MEM.
  607  01CE 324CC3                    LD      (INCREM),A      ;A DECREMENTO
  608  01D1 324EC3                    LD      (DECREM),A      ;DEL MOTOPOTENZ.
  609  01D4 321EC3                    LD      (TIRCIR_ATT),A
  610                 
  611                         
  612  01D7 CD6A23                    CALL    CAL_WATCHDOG_ST7        ;CALCOLA TEMPO WATCHDOG
  613  01DA CD9A23                    CALL    FAITAB  
  614  01DD CD4727                    CALL    AZZER_MSB
  615  01E0 CDD712                    CALL    DEFAUL
  616  01E3 CD1E06                    CALL    FORCE_STATUS            ;RESET STATUS ALLARMI
  617  01E6 CD581A                    CALL    VARERR
  618  01E9 CD4320                    CALL    CAL_CILINDRO
  619  01EC CD3C03                    CALL    FASE_COINCIDENZA        ;INVIO FASE AI CONTATORI HW
  620                 
  621                                 ;RESET DAC A VALORE BASE
  622  01EF CD931C                    CALL    DAC_INCR_DECR
  623                 
  624                 
  625                                 ;ABILITA INTERRUPT
  626  01F2 FB                        EI      
  627                 
  628                                 ;RICHIEDI TUTTI I PARAMETRI A ST7
  629  01F3 CD9506                    CALL    SEND_INIT_Z80
  630                 
  631                 
  632                 ;çççççççççççççççççççççççççççççççççççççççççççççççççççç
  633  01F6 FD2100DB                  LD      IY,ARR_TMP
  634  01FA FD2290D9                  LD      (TMP_CURSOR),IY
  635                                 
  636  01FE 3E00                      LD      A,00H
  637  0200 3200DB                    LD      (ARR_TMP),A      ;LOC. INIZIALE
  638  0203 2100DB                    LD      HL,ARR_TMP
  639  0206 1101DB                    LD      DE,ARR_TMP+01H
  640  0209 01FF00                    LD      BC,00FFH
  641  020C EDB0                      LDIR
  642                 
  643                 ;ççççççççççççççççççççççççççççççççççççççççççççççççççççç
  644                                 
  645                 
  646                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  647                 ;               MAIN - PROGRAMMA PRINCIPALE DI CALCOLO
  648                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  649                 
  650  020E           MAIN:
  651  020E 2A06C3                    LD      HL,(VELIMP)     ;SE LA VELOCITA' E' ALTA SPEDISCO 
  652  0211 118000                    LD      DE,0080H        ;LO STATO DEI LED SOLO UNA
  653  0214 ED52                      SBC     HL,DE           ;VOLTA AL GIRO DA QUI
  654  0216 3806                      JR      C,MAIN_LOOP
  655  0218 CD101A                    CALL    SEND_LED
  656  021B CDAD06                    CALL    SEND_SPEED
  657                                 
  658                                 
  659  021E           MAIN_LOOP:              
  660  021E 3A36C3                    LD      A,(MCALER)      ;VEDE SE DEVE 
  661  0221 FE00                      CP      00H             ;CALCOLARE O NO
  662  0223 CA7502                    JP      Z,MAIN_WAITING
  663                 
  664                 
  665  0226           MAIN_FASATURA_LONG:
  666                 
  667  0226 CD6303                    CALL    FASE_AUTO_LONG
  668                                 
  669  0229 3E00                      LD      A,00H           ;SETTO FLAG PER EVITARE
  670  022B 3236C3                    LD      (MCALER),A      ;DI FARE I CALCOLI DUE VOLTE
  671                 
  672  022E 3A40C3                    LD      A,(PROPRI)      ;SE NO PRINT
  673  0231 FE01                      CP      01H             ;SALTO I CALCOLI DELL'ERRORE
  674  0233 CA6902                    JP      Z,MAIN_SOGLIA_INSER
  675                                 
  676  0236 CD2D04                    CALL    ERR_CALC        ;CALCOLO ERRORE ATTUALE
  677                 
  678  0239 3A94D0                    LD      A,(AUMALO)      ;SE SONO IN AUTOMATICO
  679  023C FEFF                      CP      0FFH            ;VISUALIZZO ERRORE MEDIATO
  680  023E 2810                      JR      Z,MAIN_ERR1
  681                 
  682  0240 3A9CC0                    LD      A,(MEMC)        ;SE SONO IN MANUALE E' STO CORREGGENDO
  683  0243 CB47                      BIT     B_PC_AVANTI,A   ;IN AVANTI VISUALIZZO ERRORE ISTANTANEO
  684  0245 2017                      JR      NZ,MAIN_ERR2
  685                 
  686  0247 3A9CC0                    LD      A,(MEMC)        ;SE SONO IN MANUALE E' STO CORREGGENDO
  687  024A CB4F                      BIT     B_PC_RITARDO,A  ;IN RITARDO VISUALIZZO ERRORE ISTANTANEO
  688  024C 2010                      JR      NZ,MAIN_ERR2
  689                 
  690  024E 1800                      JR      MAIN_ERR1       ;ALTRIMENTI, SE SONO IN MANUALE 
  691                                                         ;E NON STO CORREGGENDO, VISUALIZZO ERRORE 
  692                                                         ;MEDIATO
  693                 
  694  0250           MAIN_ERR1:
  695  0250 CD2910                    CALL    LMEDIA          ;CALCOLO MEDIA DELL'ERRORE
  696  0253 3A58C3                    LD      A,(ERMEDI_SIGN)
  697  0256 3238C3                    LD      (MSCORR),A 
  698  0259 CD6009                    CALL    SEND_ERR
  699                 
  700  025C 1808                      JR      MAIN_OVERCORRECTION
  701                                                                 
  702  025E           MAIN_ERR2:
  703  025E CDBC0F                    CALL    RESET_MEDIA     ;EQUIVALE A PRENDERE IL VALORE ISTANTANEO
  704  0261 CD6009                    CALL    SEND_ERR
  705  0264 1800                      JR      MAIN_OVERCORRECTION
  706                 
  707  0266           MAIN_OVERCORRECTION:
  708                 
  709  0266 CDFB18                    CALL    OVERCO          ; GESTIONE DELLA CORREZIONE SUPERIORE A MEZZO GATE 
  710                 
  711  0269           MAIN_SOGLIA_INSER:
  712  0269 CDBE02                    CALL    CHKSOGLIN
  713                 
  714  026C CDE202                    CALL    CHKALARM
  715                 
  716                 
  717  026F           MAIN_CORREZIONI:
  718  026F CDFD0B                    CALL    CORREZIONI
  719                 
  720                 
  721  0272 CDE009                    CALL    CENTRO          ;SE ESEGUITA FASE CON OSCILLOSCOPIO, SI AUTOCENTRA
  722                 
  723  0275           MAIN_WAITING:
  724                 
  725  0275           MAIN_TRASMISSIONE_DATI:
  726  0275 2A06C3                    LD      HL,(VELIMP)     ;SE LA VELOCITA' E' LENTA, CONTINUO
  727  0278 118000                    LD      DE,0080H        ;A SPEDIRE LO STATO DEI LED
  728  027B ED52                      SBC     HL,DE           
  729  027D 3006                      JR      NC,MAIN_TRASMISSIONE_DATI2
  730  027F CD101A                    CALL    SEND_LED
  731  0282 CDAD06                    CALL    SEND_SPEED
  732  0285           MAIN_TRASMISSIONE_DATI2:
  733  0285 CD2606                    CALL    SEND_STATUS
  734                 
  735                 
  736  0288           MAIN_CHK_ENCODER:
  737  0288 3A2AC3                    LD      A,(TEST_ENC)    ;SE FLAG TEST ENCODER E ABILITATO
  738  028B CB47                      BIT     0,A             ;ESEGUI TEST
  739  028D 2803                      JR      Z,MAIN_CHK_ALARM
  740  028F CDD325                    CALL    ENC1
  741                 
  742  0292           MAIN_CHK_ALARM:
  743  0292 3A94D0                    LD      A,(AUMALO)      
  744  0295 FEFF                      CP      0FFH            ;SE SONO IN MANUALE 
  745  0297 2803                      JR      Z,MAIN_CHK_SPEED                
  746  0299 CD1B0B                    CALL    ALARM_OFF       ;DISATTIVO ALLARME
  747                 
  748  029C           MAIN_CHK_SPEED:
  749  029C CDFD06                    CALL    CHK_SPEED_ZERO
  750                 
  751  029F           MAIN_CHK_RESET:
  752                                 
  753  029F 3A00C3                    LD      A,(RESET)       ;SE FLAG RESET=FF ALLORA RIPARTO DA VIA
  754  02A2 FEFF                      CP      0FFH
  755  02A4 CA0001                    JP      Z,VIA
  756                 
  757  02A7 CDB602                    CALL    CHK_IRQ_ENABLED
  758  02AA CD4823                    CALL    CHK_CURRENT_ENCODER
  759  02AD CDFA22                    CALL    CHK_TWIN_APP
  760  02B0 CD2623                    CALL    CHK_SH_PN
  761                 
  762  02B3           MAIN_FINE:      
  763                 
  764                 
  765                                 ;EI     ;RESTORE INTERRUPT (IF REQUIRED)
  766  02B3 C30E02                    JP      MAIN
  767                 
  768                 
  769                 
  770                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  771                 ;               ROUTINE DI CONTROLLO SE IRQ SONO ATTIVATI
  772                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  773  02B6           CHK_IRQ_ENABLED:
  774  02B6 DB00                      IN      A,(PA)          ;SE BIT DI RICHIESTA DI ABILITAZIONE E' 1
  775  02B8 CB7F                      BIT     7,A             ;SIGNIFICA CHE PER QUALCHE MOTIVO GLI IRQ SONO DISABILITATI
  776  02BA 2801                      JR      Z,CHK_IRQ_ENABLED_FINE
  777  02BC FB                        EI                      ;ABILITO INTERRUPT
  778  02BD           CHK_IRQ_ENABLED_FINE:
  779  02BD C9                        RET
  780                                                 
  781                 
  782                 
  783                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  784                 ;               ROUTINE DI CONTROLLO SOGLIA INSERZIONE
  785                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  786                 
  787  02BE           CHKSOGLIN:
  788  02BE CD4119                    CALL    VELO
  789  02C1 2A08C3                    LD      HL,(VELIST)  
  790  02C4 ED5B72D0                  LD      DE,(INSER)      
  791  02C8 ED52                      SBC     HL,DE            
  792  02CA 3805                      JR      C,SOGLIN_ERR
  793                 
  794  02CC CD7D0B    SOGLIN_OK:      CALL    SPEEDOK
  795  02CF 1810                      JR      CHKSOGLIN_FINE
  796                 
  797  02D1           SOGLIN_ERR:         
  798  02D1 3F                        CCF        
  799  02D2 3E05                      LD      A,05H           ;BLOCCO ALLARME
  800  02D4 3232C3                    LD      (CONALL),A      ;CONTEGGIO AVVISI ALLARME CIRC
  801  02D7 3E07                      LD      A,07H           ;SE INSER E' MAGGIORE BLOCCO LA CORREZIONE 
  802  02D9 3244C3                    LD      (MATTES),A      ;E AUMENTO I CICLI DI ATTESA.
  803                                 
  804  02DC CD650B                    CALL    SPEED_LOW 
  805  02DF 1800                      JR      CHKSOGLIN_FINE
  806                 
  807  02E1           CHKSOGLIN_FINE:
  808  02E1 C9                        RET
  809                 
  810                 
  811                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  812                 ;               ROUTINE DI CONTROLLO SOGLIA ALLARME 
  813                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  814                 
  815  02E2           CHKALARM:       
  816  02E2 DB01                      IN      A,(PB)          
  817  02E4 CB5F                      BIT     3,A             ;SE MANCA IL SEGNO
  818  02E6 200F                      JR      NZ,ALLA1        ;SALTO
  819                 
  820  02E8 ED5B4ED0                  LD      DE,(DMEZGA)     ;40% GATE IN CENTESIMI
  821  02EC 2A54C3                    LD      HL,(ERMEDI)     ;QUANDO L'ERRORE
  822  02EF ED52                      SBC     HL,DE           ;E' MINORE 
  823  02F1 3004                      JR      NC,ALLA1        ;DEL 40% DEL
  824  02F3 3F                        CCF                     ;GATE E SONO
  825                 
  826  02F4 CD4A0B                    CALL    F9_OFF          ;DISATTIVO F9
  827                 
  828  02F7           ALLA1:          
  829  02F7 3A94D0                    LD      A,(AUMALO)      ;SE SONO IN MANUALE
  830  02FA FE00                      CP      00H             ;DISATTIVO ALLARME
  831  02FC 2833                      JR      Z,NOALL
  832                         
  833  02FE 3A42C3                    LD      A,(PROVEL)      ;SE BASSA VELOCITA 
  834  0301 FE01                      CP      01H             ;DISATTIVO ALLARME
  835  0303 282C                      JR      Z,NOALL
  836                 
  837  0305 3A66D0                    LD      A,(ALLAR)       ;SE SOGLIA ALLARME (P2) = 0
  838  0308 FE00                      CP      00H             ;SALTA.
  839  030A 2825                      JR      Z,NOALL  
  840                 
  841  030C 3A40C3                    LD      A,(PROPRI)      ;SE NO PRINT
  842  030F FE01                      CP      01H             ;ATTIVO ALLARME
  843  0311 2819                      JR      Z,SIALL
  844                 
  845  0313 2A66D0                    LD      HL,(ALLAR)      ;SE ERRORE > SOGLIA ALLARME (P2)
  846  0316 ED5B54C3                  LD      DE,(ERMEDI)     ;CONTO 5 AVVISI E POI ATTIVO ALLARME
  847  031A ED52                      SBC     HL,DE         
  848  031C 3013                      JR      NC,NOALL   
  849                                 
  850  031E 3F                        CCF
  851  031F 3A32C3                    LD      A,(CONALL)      ;SE HO CONTATO 5 CICLI DI AVVISO
  852  0322 FE00                      CP      00H             ;ATTIVO L'ALLARME
  853  0324 2806                      JR      Z,SIALL    
  854  0326 3D                        DEC     A
  855  0327 3232C3                    LD      (CONALL),A
  856  032A 180F                      JR      ALLA_FINE
  857                 
  858  032C           SIALL:          
  859  032C CD090B                    CALL    ALARM_ON        ;ATTIVO ALLARME
  860  032F 180A                      JR      ALLA_FINE
  861                 
  862  0331           NOALL:          
  863  0331 CD1B0B                    CALL    ALARM_OFF       ;DISATTIVO ALLARME
  864  0334 3E05                      LD      A,05H           ;E CARICO 5 CICLI PRIMA 
  865  0336 3232C3                    LD      (CONALL),A      ;DI DARE L'ALLARME
  866  0339 1800                      JR      ALLA_FINE
  867  033B           ALLA_FINE:
  868  033B C9                        RET
  869                 
  870                 
  871                 
  872                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  873                 ;               TRASMISSIONE A COINCIDENZA DEL VALORE DI FASE
  874                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  875                 
  876  033C           FASE_COINCIDENZA:         
  877                 
  878  033C 2A0CD0                    LD      HL,(FASE)
  879  033F 227CC0                    LD      (COMP16A),HL
  880  0342 210010                    LD      HL,1000H        
  881  0345 227EC0                    LD      (COMP16B),HL
  882  0348 CD3814                    CALL    COMPARE16
  883  034B 3A7CC0                    LD      A,(COMP16A)
  884  034E FE02                      CP      02H             ;FASE<4096 ?
  885  0350 CA5903                    JP      Z,FASE_COINCIDENZA_INVIO 
  886                                 
  887  0353 210000                    LD      HL,0000H        ;METTO DI DEFAULT A 0
  888  0356 220CD0                    LD      (FASE),HL
  889                 
  890                 
  891  0359           FASE_COINCIDENZA_INVIO:
  892  0359 2A0CD0                    LD      HL,(FASE)
  893  035C 7C                        LD      A,H
  894  035D D320                      OUT     (20H),A
  895  035F 7D                        LD      A,L
  896  0360 D310                      OUT     (10H),A
  897  0362           FASE_COINCIDENZA_FINE:
  898  0362 C9                        RET
  899                 
  900                 
  901                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  902                 ;               ROUTINE DI FASATURA AUTOMATICA LONGITUDINALE
  903                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  904                 
  905  0363           FASE_AUTO_LONG: 
  906  0363 3AD0C1                    LD      A,(ARR_RICAUTO+00H)     ;SE RICERCA E' GIA' IN CORSO, ESCO
  907  0366 FE01                      CP      01H
  908  0368 C27403                    JP      NZ,FASE_AUTO_LONG_FINE
  909                 
  910  036B CD7503                    CALL    FASE_AUTO_INIZIA
  911  036E CDBD11                    CALL    CODICE
  912  0371 CDC903                    CALL    FASE_TROVATA            ;SE ARRIVA QUI LA FASE E' STATA TROVATA
  913                                                                 ;ALTRIMENTI CTC1 CHIAMA FASE_FALLITA E RIPARTE DA MAIN
  914  0374           FASE_AUTO_LONG_FINE:
  915  0374 C9                        RET
  916                 
  917                 
  918                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  919                 ;               ROUTINE DI INIZIO FASATURA AUTOMATICA
  920                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  921  0375           FASE_AUTO_INIZIA:
  922                 
  923  0375 ED4B0CD0                  LD      BC,(FASE)               ;BACKUP VALORI FASE PRECEDENTE
  924  0379 ED4346C3                  LD      (MFASE),BC
  925  037D ED4B0ED0                  LD      BC,(FASES1)
  926  0381 ED4348C3                  LD      (MFASES1),BC
  927  0385 ED4B10D0                  LD      BC,(FASRIF)
  928  0389 ED434AC3                  LD      (MFASRIF),BC
  929                 
  930                 
  931  038D 3E00                      LD       A,00H                  ;IMPONGO MANUALE
  932  038F 3294D0                    LD      (AUMALO),A      
  933  0392 3298D0                    LD      (AUMATI),A      
  934  0395 3296D0                    LD      (AUMATR),A      
  935                 
  936  0398 3E00                      LD       A,00H                  ;RESET USCITE
  937  039A 329CC0                    LD      (MEMC),A                
  938  039D D363                      OUT     (PC),A
  939                 
  940  039F 3E00                      LD      A,00H
  941  03A1 3218C3                    LD      (SUPCOR),A              ;ANNULLO VALORE DI ERRORE MAGGIORE DI MEZZO GATE
  942                 
  943                 
  944  03A4 3E60                      LD      A,60H                   ;INIZIO CON GUADAGNO MINIMO
  945  03A6 323CD0                    LD      (GUADS1),A
  946                 
  947  03A9 CD2011                    CALL    CAL_CODICE              ;CALCOLO VALORI DI CODICE_BIANCO E CODICE_NERO
  948                 
  949  03AC 3A9BC0                    LD      A,(MEMB)
  950  03AF CBF7                      SET     6,A                     ;BLOCCO GATE
  951  03B1 329BC0                    LD      (MEMB),A
  952  03B4 D301                      OUT     (PB),A
  953                 
  954  03B6 3ED7                      LD      A,0D7H                  ;IMPOSTO CTC1 COME CONTATORE DI CICLI
  955  03B8 D371                      OUT     (CTC1_CMD),A            
  956  03BA 3E03                      LD      A,03H                   ;INTERRUPT OGNI 3 GIRI
  957  03BC D371                      OUT     (CTC1_CMD),A
  958                 
  959  03BE 3E01                      LD      A,01H
  960  03C0 32D6C1                    LD      (ARR_RICAUTO+06H),A
  961  03C3 3E04                      LD      A,04H                   ;SE DOPO CIRCA 12 GIRI RICERCA FALLITA ESCI 
  962  03C5 32D2C1                    LD      (ARR_RICAUTO+02H),A
  963                 
  964  03C8           FASE_AUTO_INIZIA_FINE:
  965  03C8 C9                        RET
  966                 
  967                 
  968                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  969                 ;               SUBROUTINE DI FASATURA AUTOMATICA ESEGUITA CORRETTAMENTE
  970                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  971                 
  972  03C9           FASE_TROVATA:
  973                                 ;MEMORIZZO LA NUOVA FASE
  974  03C9 ED4B74C3                  LD      BC,(CODICE_ENC_B1)      
  975  03CD ED430CD0                  LD      (FASE),BC  
  976                 
  977  03D1 CDBA09                    CALL    CENTRA  
  978                 
  979  03D4 3A9CC0                    LD      A,(MEMC)                ;TOLGO EVENTUALE ALLARME
  980  03D7 CBA7                      RES     B_PC_PROTEZIONE,A
  981  03D9 329CC0                    LD      (MEMC),A        
  982  03DC D363                      OUT     (PC),A          
  983                                 
  984  03DE CD1E06                    CALL    FORCE_STATUS
  985  03E1 CD1306                    CALL    SEND_OK
  986                 
  987  03E4 CD0E04                    CALL    FASE_AUTO_TERMINA
  988                 
  989  03E7           FASE_TROVATA_FINE:
  990  03E7 C9                        RET
  991                 
  992                 
  993                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  994                 ;               SUBROUTINE DI FASATURA AUTOMATICA FALLITA
  995                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
  996  03E8           FASE_FALLITA:
  997  03E8 CD1E06                    CALL    FORCE_STATUS
  998  03EB ED5BF026                  LD      DE,(S_FASATURA_FALLITA)
  999  03EF CD7106                    CALL    SET_STATUS              ;INVIO MESSAGGIO FASE FALLITA
 1000                 
 1001  03F2 ED4B46C3                  LD      BC,(MFASE)              ;BACKUP VALORI FASE PRECEDENTE
 1002  03F6 ED430CD0                  LD      (FASE),BC
 1003  03FA ED4B48C3                  LD      BC,(MFASES1)
 1004  03FE ED430ED0                  LD      (FASES1),BC
 1005  0402 ED4B4AC3                  LD      BC,(MFASRIF)
 1006  0406 ED4310D0                  LD      (FASRIF),BC
 1007                 
 1008  040A CD0E04                    CALL    FASE_AUTO_TERMINA
 1009  040D           FASE_FALLITA_FINE:
 1010  040D C9                        RET
 1011                 
 1012                 
 1013                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1014                 ;               ROUTINE DI TERMINE FASATURA AUTOMATICA 
 1015                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1016  040E           FASE_AUTO_TERMINA:
 1017  040E 3A9BC0                    LD      A,(MEMB)                ;SBLOCCO GATE
 1018  0411 CBB7                      RES     6,A             
 1019  0413 329BC0                    LD      (MEMB),A
 1020  0416 D301                      OUT     (PB),A
 1021                 
 1022  0418 3E43                      LD      A,43H                   ;RESETTO CTC1 COME CONTATORE CICLI DI FASE
 1023  041A D371                      OUT     (CTC1_CMD),A         
 1024                 
 1025  041C 3E00                      LD      A,00H                   ;RESET USCITE DI RICERCA
 1026  041E 32D0C1                    LD      (ARR_RICAUTO+00H),A
 1027  0421 32D2C1                    LD      (ARR_RICAUTO+02H),A
 1028  0424 32DAC1                    LD      (ARR_RICAUTO+0AH),A
 1029  0427 3E02                      LD      A,02H                   ;NUMERO SEGNI PRIMA DI DOPPIO
 1030  0429 32D6C1                    LD      (ARR_RICAUTO+06H),A
 1031  042C           FASE_AUTO_TERMINA_FINE:
 1032  042C C9                        RET
 1033                 
 1034                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1035                 ;               CONTROLLO DELL'ERRORE ATTUALE
 1036                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1037                 
 1038  042D           ERR_CALC:
 1039                                 ;CALCOLO RAPPORTO POSIZINE PIENO S1
 1040                 
 1041  042D ED5B50C3                  LD      DE,(ERATTU)     ;MEMORIZZO ERRORE
 1042  0431 ED5352C3                  LD      (ERPREC),DE     ;PRECEDENTE
 1043                 
 1044  0435 3A38C3                    LD      A,(MSCORR)      ;
 1045  0438 DD211AD0                  LD      IX,PIENO1       ;DIVIDO PIENO
 1046  043C DD5E00                    LD      E,(IX+00H)      ;PER DIECI
 1047  043F DD5601                    LD      D,(IX+01H)      ;E SOTTRAGGO
 1048  0442 ED5300C0                  LD      (DIVDEN),DE     ;IL RISULTATO
 1049  0446 010A00                    LD      BC,000AH        ;A POSIZIONE
 1050  0449 ED4302C0                  LD      (DIVSOR),BC     ;SE IL RISULTATO
 1051  044D CD6514                    CALL    DIVIS           ;E' NEGATIVO
 1052  0450 DD2104C0                  LD      IX,QUOZIE       ;VUOLE DIRE CHE
 1053  0454 DD5E00                    LD      E,(IX+00H)      ;DIVIDENDO
 1054  0457 DD5601                    LD      D,(IX+01H)      ;POSIZIONE X 10
 1055  045A FD211CD0                  LD      IY,POSIZ1       ;CON PIENO AVRO'
 1056  045E FD6E00                    LD      L,(IY+00H)      ;UN NUMERO MINORE
 1057  0461 FD6601                    LD      H,(IY+01H)      ;DI 0,1 PER CUI
 1058  0464 ED52                      SBC     HL,DE           ;CARICO IN MEM.
 1059  0466 3837                      JR      C,RAPP10        ;RAPPORTO ZERO.
 1060  0468 FD5E00                    LD      E,(IY+00H)      ;SE LA SOTTRZIONE
 1061  046B FD5601                    LD      D,(IY+01H)      ;NON DA RISULTATO
 1062  046E ED5306C0                  LD      (MOLTI),DE      ;NEGATIVO PROCEDO
 1063  0472 3E0A                      LD      A,0AH           ;NELLA DIVISIONE
 1064  0474 3208C0                    LD      (MOLPL),A       ;POSIZIONE X 10
 1065  0477 CD8D14                    CALL    MOLT            ;DIVISO PIENO
 1066  047A DD210AC0                  LD      IX,PROD         ;E OTTERRO'UN
 1067  047E DD4E00                    LD      C,(IX+00H)      ;RISULTATO 
 1068  0481 DD4601                    LD      B,(IX+01H)      ;COMPRESO 
 1069  0484 ED4300C0                  LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
 1070  0488 FD211AD0                  LD      IY,PIENO1
 1071  048C FD5E00                    LD      E,(IY+00H)
 1072  048F FD5601                    LD      D,(IY+01H)
 1073  0492 ED5302C0                  LD      (DIVSOR),DE
 1074  0496 CD6514                    CALL    DIVIS
 1075  0499 ED5B04C0                  LD      DE,(QUOZIE)
 1076  049D 1804                      JR      RAPP11
 1077  049F 3F        RAPP10:         CCF
 1078  04A0 110000                    LD      DE,0000H
 1079  04A3 ED5312D0  RAPP11:         LD      (RAPPO1),DE     
 1080                 
 1081  04A7 3A1ED0                    LD      A,(MEMRIF)      ;VERIFICO SE E' STATO TROVATO IL SEGNO DI REGISTRO DURANTE LA RICERCA AUTOMATICA 
 1082  04AA FE00                      CP      00H
 1083  04AC 2840                      JR      Z,RAPP2
 1084                 
 1085                                 ;SE SONO SUBITO DOPO FASATURA, ANNULLO LA MEDIA
 1086  04AE 110000                    LD      DE,0000H
 1087  04B1 ED5350C3                  LD      (ERATTU),DE
 1088  04B5 CDBC0F                    CALL    RESET_MEDIA
 1089                 
 1090  04B8 ED5B12D0                  LD      DE,(RAPPO1)     ;PER MEMORIZZARE I RIFERIMENTI QUESTI VENGONO MEMORIZZATI DOPO 4 GIRI
 1091  04BC ED5314D0                  LD      (RAPRIF),DE
 1092  04C0 ED5B0ED0                  LD      DE,(FASES1)
 1093  04C4 ED5310D0                  LD      (FASRIF),DE
 1094                 
 1095  04C8 211ED0                    LD      HL,MEMRIF       ;DECREMENTO MEMRIF
 1096  04CB 35                        DEC     (HL)
 1097                 
 1098  04CC 3A1ED0                    LD      A,(MEMRIF)      ;QUANDO ARRIVO A ZERO ESEGUO IL CALCOLO DEL RIFTOT
 1099  04CF FE00                      CP      00H
 1100  04D1 201B                      JR      NZ,RAPP2
 1101                 
 1102  04D3 ED5B10D0                  LD      DE,(FASRIF)
 1103  04D7 ED5306C0                  LD      (MOLTI),DE
 1104  04DB 3E0A                      LD      A,0AH
 1105  04DD 3208C0                    LD      (MOLPL),A
 1106  04E0 CD8D14                    CALL    MOLT
 1107  04E3 ED5B0AC0                  LD      DE,(PROD)
 1108  04E7 2A14D0                    LD      HL,(RAPRIF)
 1109  04EA 19                        ADD     HL,DE
 1110  04EB 2216D0                    LD      (RIFTOT),HL
 1111                 
 1112                                 ;JP     ERR_CALC_FINE
 1113                 
 1114                 
 1115                                 ;CALCOLO DELL'ERRORE IN CENTESIMI ED
 1116                                 ;EVENTUALE CORREZIONE DA ESEGUIRE
 1117                                 ;(FASRIF-FASES1)+(RAPRIF-RAPPO1)= ERRORE
 1118                                 ;(FASRIFx10)+RAPRIF=RIFTOT
 1119                                 ;(FASES1x10)+RAPPO1=POSTOT
 1120                                 ;(RIFTOT-POSTOT):10=ERRORE IN DECIMI
 1121                 
 1122  04EE ED5B0ED0  RAPP2:          LD      DE,(FASES1)     ;FASES1 x 10
 1123  04F2 ED5306C0                  LD      (MOLTI),DE
 1124  04F6 3E0A                      LD      A,0AH
 1125  04F8 3208C0                    LD      (MOLPL),A
 1126  04FB CD8D14                    CALL    MOLT
 1127  04FE ED5B0AC0                  LD      DE,(PROD)
 1128  0502 2A12D0                    LD      HL,(RAPPO1)
 1129  0505 19                        ADD     HL,DE
 1130  0506 2218D0                    LD      (POSTOT),HL
 1131  0509 EB                        EX      DE,HL
 1132  050A 2A16D0                    LD      HL,(RIFTOT)     ;FLO1 PUNTO A
 1133  050D ED52                      SBC     HL,DE
 1134  050F 381B                      JR      C,ERR1
 1135  0511 EB                        EX      DE,HL
 1136  0512 2A0AD0                    LD      HL,(AMPI10)     ;VEDO SE ERRORE 
 1137  0515 ED52                      SBC     HL,DE           ;E'> DI AMPI10
 1138  0517 EB                        EX      DE,HL
 1139  0518 3034                      JR      NC,INDRE        ;FLO1 PUNTO B
 1140  051A 3F                        CCF
 1141  051B 2A16D0                    LD      HL,(RIFTOT)     ;FLO1 PUNTO C
 1142  051E ED5B18D0                  LD      DE,(POSTOT)
 1143  0522 ED52                      SBC     HL,DE
 1144  0524 EB                        EX      DE,HL
 1145  0525 2100A0                    LD      HL,0A000H       ;40960
 1146  0528 ED52                      SBC     HL,DE
 1147  052A 1832                      JR      INNAS
 1148  052C 3F        ERR1:           CCF
 1149  052D 2A18D0                    LD      HL,(POSTOT)     ;FLO1 PUNTO D
 1150  0530 ED5B16D0                  LD      DE,(RIFTOT)
 1151  0534 ED52                      SBC     HL,DE
 1152  0536 EB                        EX      DE,HL
 1153  0537 2A0AD0                    LD      HL,(AMPI10)     ;FLO1 PUNTO E  
 1154  053A ED52                      SBC     HL,DE
 1155  053C EB                        EX      DE,HL
 1156  053D 301F                      JR      NC,INNAS
 1157  053F 3F                        CCF
 1158  0540 2100A0                    LD      HL,0A000H       ;40960
 1159  0543 ED5B18D0                  LD      DE,(POSTOT)     ;FLO1 PUNTO F
 1160  0547 ED52                      SBC     HL,DE
 1161  0549 ED4B16D0                  LD      BC,(RIFTOT)
 1162  054D 09                        ADD     HL,BC
 1163  054E           INDRE:          
 1164  054E 3A8AC3                    LD      A,(MSCORR_ATT)
 1165  0551 323AC3                    LD      (MSCORR_PREC),A
 1166  0554 3E08                      LD      A,D_RITARDO     ;SEGNALAZIONE
 1167  0556 3238C3                    LD      (MSCORR),A      ;CORREZ. RITARDO
 1168  0559 328AC3                    LD      (MSCORR_ATT),A
 1169  055C 180E                      JR      ERR2
 1170  055E           INNAS:          
 1171  055E 3A8AC3                    LD      A,(MSCORR_ATT)
 1172  0561 323AC3                    LD      (MSCORR_PREC),A
 1173  0564 3E01                      LD      A,D_AVANTI      ;SEGNALAZIONE
 1174  0566 3238C3                    LD      (MSCORR),A      ;CORREZ. AVANTI
 1175  0569 328AC3                    LD      (MSCORR_ATT),A
 1176                 
 1177                                 ;(ERR.xCENT.IN DIV.ENC.):10=ERR.IN CENTESIMI
 1178                 
 1179                 
 1180  056C 2206C0    ERR2:           LD      (MOLTI),HL      ;HL CONTIENE ERR.
 1181  056F 3A06D0                    LD      A,(CENTES)
 1182  0572 3208C0                    LD      (MOLPL),A
 1183  0575 CD8D14                    CALL    MOLT
 1184  0578 ED5B0AC0                  LD      DE,(PROD)
 1185  057C ED5300C0                  LD      (DIVDEN),DE     ;PRIMA DIVISIONE
 1186  0580 010A00                    LD      BC,000AH        ;PER DIECI
 1187  0583 ED4302C0                  LD      (DIVSOR),BC
 1188  0587 CD6514                    CALL    DIVIS
 1189  058A ED5B04C0                  LD      DE,(QUOZIE)
 1190  058E ED5350C3                  LD      (ERATTU),DE
 1191                                 
 1192  0592 3A74D0                    LD      A,(SALTO)       ;SE SALTO E'
 1193  0595 FE00                      CP      00H             ;ZERO CORREGGO
 1194  0597 2832                      JR      Z,ERR_CALC_FINE ;SEMPRE
 1195  0599 216400                    LD      HL,0064H        ;SOMMO A ERPREC   
 1196  059C ED4B52C3                  LD      BC,(ERPREC)     ;1mm IL RISULTATO
 1197  05A0 09                        ADD     HL,BC           ;LO SOTTRAGGO A
 1198  05A1 ED52                      SBC     HL,DE           ;ERATTU SE CARRY
 1199  05A3 3020                      JR      NC,ERR4         ;SE VI E' STATA  
 1200  05A5 3F                        CCF                     ;UNA LETTURA SBAL-
 1201  05A6 ED4B52C3                  LD      BC,(ERPREC)     ;LATA LA IGNORO.
 1202  05AA ED4350C3                  LD      (ERATTU),BC
 1203  05AE 3A0EC3                    LD      A,(CONSAL)      ;CONTROLLA CHE NON
 1204  05B1 3D                        DEC     A               ;CHE NON RIMANGA
 1205  05B2 320EC3                    LD      (CONSAL),A      ;IN BLOCCO PER PIU'
 1206  05B5 FE00                      CP      00H             ;DI N GIRI MEMORIZZATI 
 1207  05B7 2802                      JR      Z,ERR3          ;IN SALTO E POI
 1208  05B9 1810                      JR      ERR_CALC_FINE   
 1209                 
 1210  05BB ED5350C3  ERR3:           LD      (ERATTU),DE     ;RICARICA L'ULTIMO
 1211  05BF ED5352C3                  LD      (ERPREC),DE     ;ERRORE LETTO
 1212  05C3 1800                      JR      ERR4            
 1213  05C5 3A74D0    ERR4:           LD      A,(SALTO)       ;CARICA I GIRI DI
 1214  05C8 320EC3                    LD      (CONSAL),A      ;ATTESA.
 1215                 
 1216  05CB           ERR_CALC_FINE:           
 1217  05CB C9                        RET
 1218                 
 1219                 
 1220                 
 1221                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1222                 ;               CONTROLLO CHE NON CI SIA UN'ALTRO
 1223                 ;               AVVISO RICHIESTA DI TRASMISSIONE IN CORSO
 1224                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1225                 
 1226  05CC           REQISFREE:      
 1227  05CC ED5B68C3                  LD      DE,(WATCHDOG_ST7_L)     ;RESET WATCHDOG CON IL VALORE 
 1228  05D0 ED536CC3                  LD      (WATCHDOG_ST7_L_TMP),DE ;PRECALCOLATO
 1229  05D4 ED5B66C3                  LD      DE,(WATCHDOG_ST7_H)
 1230  05D8 ED536AC3                  LD      (WATCHDOG_ST7_H_TMP),DE
 1231                 
 1232                 
 1233  05DC           REQISFREE_LOOP:
 1234                                 
 1235                                 ;CONTROLLO SE WATCHDOG E' ARRIVATO A 0
 1236  05DC 116AC3                    LD      DE,WATCHDOG_ST7_H_TMP
 1237  05DF ED537AC0                  LD      (COUNTER32),DE
 1238  05E3 CD7C15                    CALL    CHK32
 1239                 
 1240  05E6 ED5B7AC0                  LD      DE,(COUNTER32)
 1241  05EA 7A                        LD      A,D
 1242  05EB A3                        AND     E
 1243  05EC FEFF                      CP      0FFH
 1244  05EE CA0406                    JP      Z,REQISFREE_TIMEOUT
 1245                 
 1246  05F1 116AC3                    LD      DE,WATCHDOG_ST7_H_TMP
 1247  05F4 ED537AC0                  LD      (COUNTER32),DE
 1248  05F8 CD5A15                    CALL    DEC32
 1249                 
 1250                                 
 1251                 
 1252  05FB 3A9AC0                    LD      A,(MEMA)                ;CONTROLLO SE
 1253  05FE CB4F                      BIT     1,A                     ;SETTATO ESCI DAL LOOP
 1254  0600 20DA                      JR      NZ,REQISFREE_LOOP       ;ALTRIMENTI CICLA
 1255                 
 1256  0602 1803                      JR      REQISFREE_FINE
 1257                 
 1258  0604           REQISFREE_TIMEOUT:
 1259                 
 1260  0604 C30001                    JP      VIA                     ;RESET DELLO Z80
 1261                 
 1262  0607           REQISFREE_FINE:
 1263  0607 C9                        RET
 1264                 
 1265                 
 1266                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1267                 ;               AVVISO RICHIESTA DI TRASMISSIONE 
 1268                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1269                 
 1270  0608           REQUEST:                        
 1271  0608 3A9AC0                    LD      A,(MEMA)        ;SETTO
 1272  060B CBCF                      SET     1,A             ;OUTPA1
 1273  060D 329AC0                    LD      (MEMA),A
 1274  0610 D300                      OUT     (PA),A
 1275  0612 C9                        RET
 1276                 
 1277                 
 1278                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1279                 ;               SUBROUTINE INVIO CODICE DI OK
 1280                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1281                 
 1282  0613           SEND_OK:                
 1283  0613 010000                    LD      BC,0000H
 1284  0616 ED4382C3                  LD      (STATUS),BC
 1285  061A CD1E06                    CALL    FORCE_STATUS
 1286  061D C9                        RET
 1287                 
 1288                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1289                 ;               SUBROUTINE PER FORZARE INVIO CODICE DI STATUS
 1290                 ;               ANCHE SE UGUALE AL PRECEDENTE
 1291                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1292                 
 1293  061E           FORCE_STATUS:
 1294  061E 01FFFF                    LD      BC,0FFFFH
 1295  0621 ED4384C3                  LD      (STATU2),BC
 1296  0625 C9                        RET
 1297                 
 1298                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1299                 ;               SUBROUTINE INVIO CODICE DI STATUS
 1300                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1301                 
 1302  0626           SEND_STATUS:            
 1303  0626 D9                        EXX
 1304  0627 3A82C3                    LD      A,(STATUS)              ;INVIA SONO SE DIVERSO DA PRECEDENTE
 1305  062A ED4B84C3                  LD      BC,(STATU2)
 1306  062E B9                        CP      C
 1307  062F 2008                      JR      NZ,SEND_STATUS_DIFFERNT
 1308  0631 3A83C3                    LD      A,(STATUS+01H)
 1309  0634 B8                        CP      B
 1310  0635 2002                      JR      NZ,SEND_STATUS_DIFFERNT
 1311  0637 1837                      JR      SEND_STATUS_FINE
 1312                 
 1313  0639           SEND_STATUS_DIFFERNT:
 1314  0639 CDCC05                    CALL    REQISFREE
 1315  063C 3AD326                    LD      A,(ANSWER)              ;MANDA OK A
 1316  063F 32C0C1                    LD      (ARR_TRASM+00H),A               ;CPU    
 1317  0642 3E00                      LD      A,00H
 1318  0644 32C1C1                    LD      (ARR_TRASM+01H),A
 1319  0647 3A83C3                    LD      A,(STATUS+01)
 1320  064A 32C2C1                    LD      (ARR_TRASM+02H),A
 1321  064D 3A82C3                    LD      A,(STATUS)
 1322  0650 32C3C1                    LD      (ARR_TRASM+03H),A
 1323  0653 CD0806                    CALL    REQUEST
 1324                 
 1325  0656 2AF626                    LD      HL,(S_PERMANENT_MASK)   ;AND CON LA MASCHERA DI BIT 
 1326  0659 3A82C3                    LD      A,(STATUS)              ;PERMANENTI
 1327  065C A4                        AND     H
 1328  065D 3282C3                    LD      (STATUS),A
 1329  0660 3A83C3                    LD      A,(STATUS+01H)
 1330  0663 A5                        AND     L
 1331  0664 3283C3                    LD      (STATUS+01H),A
 1332                 
 1333  0667 ED4B82C3                  LD      BC,(STATUS)             ;SALVO IL NUOVO STATO 
 1334  066B ED4384C3                  LD      (STATU2),BC             ;NELLO STATO PRECEDENTE
 1335                 
 1336  066F D9                        EXX
 1337  0670           SEND_STATUS_FINE:
 1338  0670 C9                        RET     
 1339                 
 1340                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1341                 ;               SUBROUTINE SETTA UNO STATUS
 1342                 ;               IPOTIZZA IL VALORE SIA NEL REGISTRO DE
 1343                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1344                 
 1345  0671           SET_STATUS:             
 1346  0671 3A82C3                    LD      A,(STATUS)
 1347  0674 B2                        OR      D
 1348  0675 3282C3                    LD      (STATUS),A
 1349  0678 3A83C3                    LD      A,(STATUS+01H)
 1350  067B B3                        OR      E
 1351  067C 3283C3                    LD      (STATUS+01H),A
 1352  067F C9                        RET
 1353                 
 1354                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1355                 ;               SUBROUTINE RESETTA UNO STATUS
 1356                 ;               IPOTIZZA IL VALORE SIA NEL REGISTRO DE
 1357                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1358                 
 1359  0680           RES_STATUS:             
 1360  0680 7A                        LD      A,D             ;COMPLEMENTO DE
 1361  0681 2F                        CPL     
 1362  0682 57                        LD      D,A
 1363  0683 7B                        LD      A,E
 1364  0684 2F                        CPL
 1365  0685 5F                        LD      E,A
 1366  0686 3A82C3                    LD      A,(STATUS)
 1367  0689 A2                        AND     D
 1368  068A 3282C3                    LD      (STATUS),A
 1369  068D 3A83C3                    LD      A,(STATUS+01H)
 1370  0690 A3                        AND     E
 1371  0691 3283C3                    LD      (STATUS+01H),A
 1372  0694 C9                        RET
 1373                 
 1374                 
 1375                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1376                 ;               SUB-ROUTINE RICHIESTA A ST7 DI TUTTI I PARAMETRI
 1377                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1378  0695           SEND_INIT_Z80:
 1379  0695 CDCC05                    CALL    REQISFREE
 1380                 
 1381  0698 3AC426                    LD      A,(INITZ80)             ;INVIO RICHIESTA PARAMETRI
 1382  069B 32C0C1                    LD      (ARR_TRASM+00H),A
 1383  069E 3E00                      LD      A,00H
 1384  06A0 32C1C1                    LD      (ARR_TRASM+01H),A
 1385  06A3 32C2C1                    LD      (ARR_TRASM+02H),A
 1386  06A6 32C3C1                    LD      (ARR_TRASM+03H),A
 1387  06A9 CD0806                    CALL    REQUEST
 1388                 
 1389  06AC           SEND_INIT_Z80_FINE:
 1390  06AC C9                        RET
 1391                         
 1392                 
 1393                 
 1394                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1395                 ;               SUB-ROUTINE INVIO VELOCITA' (SE RICHIESTO) A ST7
 1396                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1397                 
 1398  06AD           SEND_SPEED:
 1399  06AD 2A0AC3                    LD      HL,(VELMED)
 1400  06B0 ED5B02C3                  LD      DE,(VELDIS)     ;SE VELOCITA' E' LA STESSA
 1401  06B4 ED52                      SBC     HL,DE           ;NON AGGIORNO IL DISPLAY
 1402  06B6 2827                      JR      Z,SEND_SPEED_FINE        
 1403  06B8 3001                      JR      NC,SEND_SPEED_OK
 1404  06BA 3F                        CCF
 1405                 
 1406  06BB           SEND_SPEED_OK:
 1407  06BB CDCC05                    CALL    REQISFREE
 1408                                 
 1409  06BE ED5B0AC3                  LD      DE,(VELMED)             ;AGGIORNO LA VELOCITA'
 1410  06C2 ED5302C3                  LD      (VELDIS),DE             ;PRECEDENTE CON LA CORRENTE
 1411                 
 1412  06C6 3AC126                    LD      A,(LEGGI)               ;INVIO LA VELOCITA' CORRENTE
 1413  06C9 32C0C1                    LD      (ARR_TRASM+00H),A
 1414  06CC 3AB326                    LD      A,(PARVEL)
 1415  06CF 32C1C1                    LD      (ARR_TRASM+01H),A
 1416  06D2 ED5B0AC3                  LD      DE,(VELMED)     
 1417  06D6 21C2C1                    LD      HL,ARR_TRASM+02H
 1418  06D9 72                        LD      (HL),D
 1419  06DA 23                        INC     HL
 1420  06DB 73                        LD      (HL),E
 1421  06DC CD0806                    CALL    REQUEST
 1422                 
 1423  06DF           SEND_SPEED_FINE:
 1424  06DF C9                        RET
 1425                 
 1426                 
 1427                 
 1428                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1429                 ;               SUB-ROUTINE INVIO VALORE BASE DAC 
 1430                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1431                 
 1432  06E0           SEND_DAC_BASE:
 1433  06E0 CDCC05                    CALL    REQISFREE
 1434  06E3 3AC126                    LD      A,(LEGGI)               ;INVIO IL VALORE BASE DAC
 1435  06E6 32C0C1                    LD      (ARR_TRASM+00H),A
 1436  06E9 3AB426                    LD      A,(BASEVALDAC)
 1437  06EC 32C1C1                    LD      (ARR_TRASM+01H),A
 1438  06EF ED5BA6D0                  LD      DE,(DACBASE1000)        
 1439  06F3 21C2C1                    LD      HL,ARR_TRASM+02H
 1440  06F6 72                        LD      (HL),D
 1441  06F7 23                        INC     HL
 1442  06F8 73                        LD      (HL),E
 1443  06F9 CD0806                    CALL    REQUEST
 1444                 
 1445  06FC           SEND_DAC_BASE_FINE:
 1446  06FC C9                        RET
 1447                 
 1448                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1449                 ;               SUB-ROUTINE CONTROLLO VELOCITA'==0 
 1450                 ;               E SE RICHIESTO INVIO A ST7
 1451                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1452                 
 1453  06FD           CHK_SPEED_ZERO: ;CONTROLLO INGRESSO PIN PER UN PO' DI TEMPO
 1454                                 ;SE NON RICEVO UN IMPULSO DELL'ENCODER 2024
 1455                                 ;SIGNIFICA CHE LA MACCHINA E' FERMA
 1456                 
 1457  06FD 01FF1F                    LD      BC,01FFFH
 1458  0700 0B        CHK_SPEED_ZERO1:  DEC     BC
 1459  0701 78                        LD      A,B
 1460  0702 B1                        OR      C
 1461  0703 2813                      JR      Z,SPEED_IS_ZERO 
 1462  0705 DB01                      IN      A,(PB)                  ;QUANDO LA
 1463  0707 CB67                      BIT     4,A                     ;MACCHINA GIRA
 1464  0709 28F5                      JR      Z,CHK_SPEED_ZERO1               ;ESEGUE IL CONTROLLO
 1465  070B 0B        CHK_SPEED_ZERO2:        DEC     BC                      ;SE NO
 1466  070C 78                        LD      A,B                     ;ASPETTA E
 1467  070D B1                        OR      C                       ;METTE ZERO
 1468  070E 2808                      JR      Z,SPEED_IS_ZERO         ;LA VELOCITA'
 1469  0710 DB01                      IN      A,(PB)          
 1470  0712 CB67                      BIT     4,A             
 1471  0714 20F5                      JR      NZ,CHK_SPEED_ZERO2
 1472  0716 1823                      JR      CHK_SPEED_ZERO_FINE
 1473                 
 1474  0718           SPEED_IS_ZERO:           
 1475  0718 010000                    LD      BC,0000H                ;SE ARRIVO QUI
 1476  071B ED4306C3                  lD      (VELIMP),BC
 1477  071F ED4308C3                  LD      (VELIST),BC             ;LA VELOCITA' = 0
 1478  0723 ED430AC3                  LD      (VELMED),BC             ;SETTO LE VARIABILI ED INVIO
 1479  0727 01FFFF                    LD      BC,0FFFFH
 1480  072A ED4302C3                  LD      (VELDIS),BC
 1481  072E CD650B                    CALL    SPEED_LOW               ;MANDO MESSAGGIO ALLARME
 1482                 
 1483  0731 3A94D0                    LD      A,(AUMALO)              ;SE NON E' IN MANUALE SALTO
 1484  0734 FE00                      CP      00H                     
 1485  0736 2803                      JR      Z,CHK_SPEED_ZERO_FINE   
 1486                 
 1487  0738 CD451A                    CALL    RESEPC                  ;FACCIO IL RESET DELLE USCITE
 1488                 
 1489  073B           CHK_SPEED_ZERO_FINE:
 1490  073B C9                        RET
 1491                 
 1492                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1493                 ;               GESTIONE COMUNICAZIONE CON ST7
 1494                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1495                 
 1496                 
 1497  073C C5        PIOA:           PUSH    BC
 1498  073D D5                        PUSH    DE
 1499  073E E5                        PUSH    HL
 1500  073F F5                        PUSH    AF
 1501  0740 DDE5                      PUSH    IX
 1502  0742 FDE5                      PUSH    IY
 1503                 
 1504  0744 3A9AC0                    LD      A,(MEMA)                ;RESETTO   TODO: Da spostare
 1505  0747 CB8F                      RES     1,A                     ;OUTPA1
 1506  0749 329AC0                    LD      (MEMA),A
 1507  074C D300                      OUT     (PA),A
 1508                                
 1509  074E DD21C0C1                  LD      IX,ARR_TRASM+00H                ;LOC BYTE
 1510  0752 FD21C4C1                  LD      IY,ARR_TRASM+04H
 1511  0756 CD6B1E                    CALL    TRASM
 1512                 
 1513  0759 CD4F1B                    CALL    ANALI1
 1514                                 
 1515  075C DD21C2C1                  LD      IX,ARR_TRASM+02H                ;LOC BYTE
 1516  0760 FD21C6C1                  LD      IY,ARR_TRASM+06H
 1517  0764 CD6B1E                    CALL    TRASM
 1518                 
 1519  0767 CD851B                    CALL    ANALI2          
 1520                 
 1521  076A FDE1                      POP     IY                      ;INIZIO COSI'
 1522  076C DDE1                      POP     IX                      ;AGGIORNA IL
 1523  076E F1                        POP     AF                      ;TUTTO.
 1524  076F E1                        POP     HL      
 1525  0770 D1                        POP     DE
 1526  0771 C1                        POP     BC
 1527  0772 FB                        EI
 1528  0773 ED4D                      RETI
 1529                 
 1530                 
 1531                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1532                 ;               GESTIONE GATE
 1533                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1534                 
 1535  0775           PIOB:           ;VIENE GENERATO DALL'IMPULSO DI COINCIDENZA
 1536                                 ;CARICO IL VALORE DELL'AMPIEZZA DEL GATE                
 1537  0775 C5                        PUSH    BC              
 1538  0776 D5                        PUSH    DE
 1539  0777 E5                        PUSH    HL
 1540  0778 F5                        PUSH    AF
 1541  0779 DDE5                      PUSH    IX
 1542  077B FDE5                      PUSH    IY
 1543                 
 1544  077D DB01                      IN      A,(PB)          ;PPUU
 1545  077F CB6F                      BIT     5,A
 1546  0781 282F                      JR      Z,PIOB4         ;PPUU
 1547                 
 1548  0783 3AD6C1                    LD      A,(ARR_RICAUTO+06H)     ;VIENE DECR.IN    PPDD
 1549  0786 FE00                      CP      00H                     ;MODO CHE IL
 1550  0788 2804                      JR      Z,PIOB3                 ;TEST DEL DOPPIO
 1551  078A 3D                        DEC     A                       ;PIO VENGA LETTO
 1552  078B 32D6C1                    LD      (ARR_RICAUTO+06H),A     ;UNA VOLTA       PPDD
 1553                 
 1554                 
 1555  078E 3A24C3    PIOB3:          LD      A,(ENCOD2)     ;PPDD
 1556  0791 FE02                      CP      02H
 1557  0793 282A                      JR      Z,PIOB_FINE         
 1558                 
 1559  0795 3ED7                      LD      A,0D7H          ;SETTO IN CTC0 AMPIEZZA GATE IN IMPULSI DI ENC
 1560  0797 D370                      OUT     (CTC0_CMD),A         
 1561  0799 3A22D0                    LD      A,(AMPIMP)      
 1562  079C D370                      OUT     (CTC0_CMD),A         
 1563                 
 1564                 
 1565  079E CDFD10                    CALL    SET_GUAD_S1
 1566                 
 1567                 
 1568  07A1 3AD6C1                    LD      A,(ARR_RICAUTO+06H)     ;VEDO SE DEVO
 1569  07A4 FE00                      CP      00H                     ;CONTROLLARE IL
 1570  07A6 2817                      JR      Z,PIOB_FINE             ;DOPPIO SEGNO
 1571  07A8 3ED7                      LD      A,0D7H                  ;METTO 2 PER-
 1572  07AA D373                      OUT     (73H),A                 ;CHE NON SENTE
 1573  07AC 3E02                      LD      A,02H                   ;LA COMMUT.
 1574  07AE D373                      OUT     (73H),A                 ;DEL TRAVERS
 1575  07B0 180D                      JR      PIOB_FINE               
 1576  07B2           PIOB4:          
 1577  07B2 DB10                      IN      A,(10H)                 ;LEGGO LA POSIZIONE
 1578  07B4 5F                        LD      E,A                     ;(PULSANTE FASE MANUALE)
 1579  07B5 DB20                      IN      A,(20H)
 1580  07B7 57                        LD      D,A
 1581  07B8 ED530CD0                  LD      (FASE),DE
 1582  07BC CDBA09                    CALL    CENTRA        
 1583                 
 1584  07BF           PIOB_FINE:          
 1585                 
 1586  07BF FDE1                      POP     IY
 1587  07C1 DDE1                      POP     IX
 1588  07C3 F1                        POP     AF
 1589  07C4 E1                        POP     HL
 1590  07C5 D1                        POP     DE
 1591  07C6 C1                        POP     BC
 1592  07C7 FB                        EI
 1593  07C8 ED4D                      RETI
 1594                 
 1595                 
 1596                 
 1597                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1598                 ;               VIENE SCATENATO ALLA FINE DEL GATE              
 1599                 ;               VERIFICA POSIZIONE S1
 1600                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1601                 
 1602                 
 1603  07CA C5        CTC0:           PUSH    BC              
 1604  07CB D5                        PUSH    DE
 1605  07CC E5                        PUSH    HL
 1606  07CD F5                        PUSH    AF
 1607  07CE DDE5                      PUSH    IX
 1608  07D0 FDE5                      PUSH    IY
 1609                 
 1610  07D2 3E01                      LD      A,01H                   ;SEGNALA AL MAIN CHE HA LETTO
 1611  07D4 3236C3                    LD      (MCALER),A              ;IN MODO CHE FACCIA CALCOLI UNA SOLA VOLTA PER GIRO
 1612                 
 1613  07D7 3AD0C1                    LD      A,(ARR_RICAUTO+00H)     ;CONTROLLO SE SONO IN FASE AUTOMATICA
 1614  07DA FE01                      CP      01H
 1615  07DC CA3708                    JP      Z,CTC0_FINE             ;SE FASE SALTO TUTTI CONTROLLI SUCESSIVI
 1616                 
 1617  07DF 3A22C3                    LD      A,(ENCOD1)              ;SE NON STO FACENDO IL TEST DELL'ENCODER   
 1618  07E2 FE00                      CP      00H                     ;SALTA   
 1619  07E4 2817                      JR      Z,CTC01  
 1620                                 
 1621  07E6 FE01                      CP      01H             ;SE STO FACENDO IL TEST DELL'ENCODER
 1622  07E8 CA3708                    JP      Z,CTC0_FINE
 1623  07EB 3A24C3                    LD      A,(ENCOD2)     ;INCREMENTO
 1624  07EE 3C                        INC     A              ;A OGNI 255
 1625  07EF 3224C3                    LD      (ENCOD2),A     ;IMPULSI
 1626  07F2 3EDF                      LD      A,0DFH         ;RICARICO CTC0 
 1627  07F4 D370                      OUT     (CTC0_CMD),A
 1628  07F6 3EFF                      LD      A,0FFH
 1629  07F8 D370                      OUT     (CTC0_CMD),A
 1630  07FA C33708                    JP      CTC0_FINE          
 1631                 
 1632  07FD           CTC01:          
 1633  07FD DB30                      IN      A,(30H)         ;LEGGO IL VALORE
 1634  07FF 5F                        LD      E,A             ;DI PIENO
 1635  0800 DB40                      IN      A,(40H)
 1636  0802 57                        LD      D,A
 1637  0803 ED531AD0                  LD      (PIENO1),DE
 1638  0807 DB50                      IN      A,(50H)         ;LEGGO IL VALORE
 1639  0809 5F                        LD      E,A             ;DELLA POSIZIONE
 1640  080A DB60                      IN      A,(60H)         ;DI S1
 1641  080C 57                        LD      D,A
 1642  080D ED531CD0                  LD      (POSIZ1),DE
 1643  0811 DB61                      IN      A,(61H)         ;LEGGO IL VALORE
 1644  0813 5F                        LD      E,A             ;DI ENCODER
 1645  0814 DB62                      IN      A,(62H)         ;ALL'ARRIVO DI S1
 1646  0816 57                        LD      D,A
 1647  0817 ED530ED0                  LD      (FASES1),DE
 1648                 
 1649                 
 1650  081B CDCA0A                    CALL    CHKPRINT        ;CONTROLLA SE C'E' SEGNO E/O SETTA VARIABILE ALLARME RELATIVO
 1651                 
 1652  081E D352                      OUT     (52H),A         ;IMPULSO A ZERO SU MONOSTABILE DA 0,5 mS 
 1653                                                         ;PER RESETTARE TUTTI I FLIP-FLOP
 1654                 
 1655  0820 3E43                      LD      A,43H           ;RESETTO IL CTC 0
 1656  0822 D370                      OUT     (CTC0_CMD),A
 1657                 
 1658                 
 1659  0824 2A0CD0                    LD      HL,(FASE)       ;CARICO IL 
 1660  0827 7C                        LD      A,H             ;CONTATORE PER
 1661  0828 D320                      OUT     (20H),A         ;LEGGERE POI S1
 1662  082A 7D                        LD      A,L
 1663  082B D310                      OUT     (10H),A         
 1664  082D 3E43                      LD      A,43H
 1665  082F D370                      OUT     (CTC0_CMD),A
 1666  0831           CTC03:
 1667  0831 CDD40B                    CALL    SPEED_CALC              ;AGGIORNA VELOCITA' IMPULSIVA
 1668  0834 CDDA1A                    CALL    CHK_CILINDRO_GATE       ;CONTROLLO DEI PARAMETRI GATE E CILINDRO  ;TODO: PROBABILMENTE E' INUTILE
 1669                 
 1670  0837           CTC0_FINE:              
 1671                         
 1672  0837 3A9AC0                    LD      A,(MEMA)        
 1673  083A CBFF                      SET     7,A             ;ABILITO SEMPRE LA GENERAZIONE DEL GATE
 1674  083C 329AC0                    LD      (MEMA),A
 1675  083F D300                      OUT     (PA),A
 1676                 
 1677  0841 FDE1                      POP     IY
 1678  0843 DDE1                      POP     IX
 1679  0845 F1                        POP     AF
 1680  0846 E1                        POP     HL
 1681  0847 D1                        POP     DE
 1682  0848 C1                        POP     BC
 1683  0849 FB                        EI
 1684  084A ED4D                      RETI
 1685                 
 1686                 
 1687                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1688                 ;               INTERRUPT DI GESTIONE TIMER DI CORREZIONE
 1689                 ;               E IN FASE AUTOMATICA CONTATORE DI NUMERO DI GIRI EFFETTUATI
 1690                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1691                 
 1692                 
 1693  084C           CTC1:
 1694  084C E3                        EX      (SP),HL         ;SCRIVO IN HL IL VALORE CORRENTE DELLO STACK POINTER
 1695  084D C5                        PUSH    BC
 1696  084E D5                        PUSH    DE
 1697  084F F5                        PUSH    AF
 1698  0850 DDE5                      PUSH    IX
 1699  0852 FDE5                      PUSH    IY
 1700                 
 1701                                 
 1702                 
 1703  0854 3A22C3                    LD      A,(ENCOD1)      ;VEDO SE SONO IN TEST ENCODER
 1704  0857 FE00                      CP      00H
 1705  0859 2819                      JR      Z,CTC16
 1706  085B FE01                      CP      01H
 1707  085D 2804                      JR      Z,CTC17
 1708  085F FE02                      CP      02H
 1709  0861 280B                      JR      Z,CTC18
 1710                 
 1711                 
 1712  0863 3E02      CTC17:          LD      A,02H           ;STACK POINTER = PARTENZA TEST ENCODER
 1713  0865 3222C3                    LD      (ENCOD1),A
 1714  0868 21FA25                    LD      HL,ENC2
 1715  086B C39A08                    JP      CTC1_FINE           
 1716                 
 1717  086E 211926    CTC18:          LD      HL,ENC6         ;STACK POINTER = FINE TEST ENCODER            
 1718  0871 C39A08                    JP      CTC1_FINE
 1719                                 
 1720                 
 1721                 
 1722                 
 1723  0874 3AD0C1    CTC16:          LD      A,(ARR_RICAUTO+00H)     ;CONTROLLA SE SONO IN RICERCA AUTOMATICA
 1724  0877 FE01                      CP      01H
 1725  0879 2806                      JR      Z,CTC12
 1726                         
 1727  087B           CTC10:          
 1728                                 ;NON SONO NE IN RICERCA AUTOMATICA NE IN TEST ENCODER
 1729                                 ;SPENGO IL CTC1 COME TIMER
 1730  087B 3E43                      LD      A,43H
 1731  087D D371                      OUT     (CTC1_CMD),A    
 1732  087F 1819                      JR      CTC1_FINE               
 1733                 
 1734                 
 1735  0881           CTC12:          
 1736                                 ;SONO IN RICERCA AUTOMATICA
 1737  0881 CDB012                    CALL    GAINS1     
 1738  0884 CDFD10                    CALL    SET_GUAD_S1
 1739                 
 1740                 
 1741  0887 3AD2C1                    LD      A,(ARR_RICAUTO+02H)     ;CONTROLLO SE ESAURITI I CICLI DI FASATURA AUTOMATICA
 1742  088A 3D                        DEC     A
 1743  088B 32D2C1                    LD      (ARR_RICAUTO+02H),A
 1744  088E FE00                      CP      00H
 1745  0890 2008                      JR      NZ,CTC1_FINE            ;SE LO SONO INVIO MESSAGGIO DI FASE FALLITA
 1746                 
 1747  0892 CDE803                    CALL    FASE_FALLITA
 1748                 
 1749  0895 210E02                    LD      HL,MAIN                 ;STACK POINTER = MAIN
 1750  0898 1800                      JR      CTC1_FINE
 1751                 
 1752  089A           CTC1_FINE:          
 1753  089A FDE1                      POP     IY              
 1754  089C DDE1                      POP     IX              
 1755  089E F1                        POP     AF
 1756  089F D1                        POP     DE      
 1757  08A0 C1                        POP     BC
 1758  08A1 E3                        EX      (SP),HL
 1759  08A2 FB                        EI              
 1760  08A3 ED4D                      RETI
 1761                 
 1762                 
 1763                 
 1764                 
 1765                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1766                 ;               INTERRUPT DI GESTIONE TIMER DI CORREZIONE
 1767                 ;               IN CASCATA A CTC1
 1768                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1769                 
 1770  08A5 C5        CTC2:           PUSH    BC
 1771  08A6 D5                        PUSH    DE
 1772  08A7 E5                        PUSH    HL
 1773  08A8 F5                        PUSH    AF
 1774  08A9 DDE5                      PUSH    IX
 1775  08AB FDE5                      PUSH    IY
 1776                 
 1777  08AD 3A12C3                    LD      A,(DECORR)      ;SE EXTRA 
 1778  08B0 FE00                      CP      00H             ;CORREZIONE 
 1779  08B2 2017                      JR      NZ,CTC21        ;ATTIVA SALTO.
 1780  08B4 3A9CC0    CTC23:          LD      A,(MEMC)        ;FINE DELLA
 1781  08B7 CB87                      RES     B_PC_AVANTI,A   ;CORREZIONE          
 1782  08B9 CB8F                      RES     B_PC_RITARDO,A             
 1783  08BB 329CC0                    LD      (MEMC),A
 1784  08BE D363                      OUT     (PC),A
 1785                 
 1786                 
 1787                                 ;RESET DAC AL VALORE BASE
 1788  08C0 CD931C                    CALL    DAC_INCR_DECR
 1789                 
 1790                 
 1791  08C3 3E43                      LD      A,43H           ;RESETTO
 1792  08C5 D371                      OUT     (CTC1_CMD),A    ;CTC1
 1793  08C7 D372                      OUT     (CTC2_CMD),A    ;CTC2
 1794  08C9 1822                      JR      CTC22           
 1795  08CB 3E37      CTC21:          LD      A,37H           ;CONTROLLO CTC1
 1796  08CD D371                      OUT     (CTC1_CMD),A         
 1797  08CF 3E40                      LD      A,40H           ;COSTANTE DI
 1798  08D1 D371                      OUT     (CTC1_CMD),A    ;TEMPO
 1799  08D3 3ED7                      LD      A,0D7H          ;CONTROLLO CTC2
 1800  08D5 D372                      OUT     (CTC2_CMD),A    ;CARICO PER 
 1801  08D7 3EFF                      LD      A,0FFH          ;EXTRA CORREZ.
 1802  08D9 D372                      OUT     (CTC2_CMD),A
 1803                 
 1804  08DB 3A12C3                    LD      A,(DECORR)      ;SE E' MAGGIORE 
 1805  08DE 3D                        DEC     A               ;DI UNO LA CORREZ-
 1806  08DF 3212C3                    LD      (DECORR),A      ;ZIONE DIVENTA
 1807  08E2 FE00                      CP      00H             ;CONTINUA
 1808  08E4 2007                      JR      NZ,CTC22
 1809                 
 1810  08E6 3A2CD0                    LD      A,(CIDE75)      ;SE FATTO 75% 
 1811  08E9 FE00                      CP      00H             ;DEL CICLO
 1812  08EB 28C7                      JR      Z,CTC23         ;BLOCCO CORREZ.
 1813                 
 1814                 
 1815                 
 1816  08ED FDE1      CTC22:          POP     IY
 1817  08EF DDE1                      POP     IX
 1818  08F1 F1                        POP     AF
 1819  08F2 E1                        POP     HL
 1820  08F3 D1                        POP     DE      
 1821  08F4 C1                        POP     BC
 1822  08F5 FB                        EI
 1823  08F6 ED4D                      RETI
 1824                 
 1825                 
 1826                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1827                 ;               INTERRUPT DI GESTIONE TIMER DI CORREZIONE LATERALE
 1828                 ;               E CONTEGGI SEGNI IN FASE AUTOMATICA (DOPPIO SEGNO)
 1829                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1830                 
 1831  08F8 C5        CTC3:           PUSH    BC
 1832  08F9 D5                        PUSH    DE
 1833  08FA E5                        PUSH    HL
 1834  08FB F5                        PUSH    AF
 1835  08FC DDE5                      PUSH    IX
 1836  08FE FDE5                      PUSH    IY
 1837                 
 1838  0900 3AD6C1                    LD      A,(ARR_RICAUTO+06H)     ;SE NON SONO IN  
 1839  0903 FE00                      CP      00H                     ;F4 SALTO
 1840  0905 2824                      JR      Z,CTC32                 ;
 1841                 
 1842  0907 3ADAC1                    LD      A,(ARR_RICAUTO+0AH)     ;PRIMA DI 
 1843  090A 3C                        INC     A                       ;SCRIVERE 
 1844  090B 32DAC1                    LD      (ARR_RICAUTO+0AH),A     ;DOPPIO ASPET-
 1845  090E FE04                      CP      04H                     ;4 RIPETIZIONI
 1846  0910 2808                      JR      Z,CTC31
 1847  0912 3E02                      LD      A,02H
 1848  0914 32D6C1                    LD      (ARR_RICAUTO+06H),A
 1849  0917 C35509                    JP      CTC33           
 1850                 
 1851  091A           CTC31:
 1852  091A CDCC0B                    CALL    DOPPIO
 1853                 
 1854  091D 3E00                      LD      A,00H
 1855                                 ;LD      (ARR_RICAUTO+04H),A
 1856  091F 32D6C1                    LD      (ARR_RICAUTO+06H),A
 1857  0922 32DAC1                    LD      (ARR_RICAUTO+0AH),A
 1858                 
 1859  0925 3E43                      LD      A,43H
 1860  0927 D373                      OUT     (73H),A
 1861  0929 182A                      JR      CTC33
 1862                 
 1863                 
 1864  092B 3A2CC3    CTC32:          LD      A,(TMEM4)       ;SE ATTIVATA
 1865  092E FE01                      CP      01H             ;CORREZIONE
 1866  0930 C25509                    JP      NZ,CTC33        ;SALTA
 1867  0933 ED4B2EC3                  LD      BC,(TMEM5)      ;CONTIENE IL
 1868  0937 0B                        DEC     BC              ;VALORE 
 1869  0938 ED432EC3                  LD      (TMEM5),BC      ;DELL'ERRORE
 1870  093C 78                        LD      A,B
 1871  093D B1                        OR      C
 1872  093E 2015                      JR      NZ,CTC33        
 1873  0940 3A9CC0                    LD      A,(MEMC)        ;FINITO IL DE-  
 1874  0943 CBB7                      RES     B_PC_DESTRA,A   ;CREMENTO DELLO
 1875  0945 CBBF                      RES     B_PC_SINISTRA,A ;ERRORE TOGLI
 1876  0947 329CC0                    LD      (MEMC),A        ;LE CORREZIONI.
 1877  094A D363                      OUT     (PC),A
 1878                 
 1879  094C 3E43                      LD      A,43H
 1880  094E D373                      OUT     (73H),A
 1881  0950 3E00                      LD      A,00H
 1882  0952 322CC3                    LD      (TMEM4),A
 1883  0955 FDE1      CTC33:          POP     IY
 1884  0957 DDE1                      POP     IX
 1885  0959 F1                        POP     AF
 1886  095A E1                        POP     HL
 1887  095B D1                        POP     DE
 1888  095C C1                        POP     BC
 1889  095D FB                        EI
 1890  095E ED4D                      RETI
 1891                 
 1892                 
 1893                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1894                 ;               CONTROLLO SE L'ERRORE E' CAMBIATO
 1895                 ;               E IN TAL CASO LO SPEDISCO A ST7
 1896                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1897                 
 1898  0960           SEND_ERR:       
 1899  0960 2A54C3                    LD      HL,(ERMEDI)             ;SE NON C'E'STATA VARIAZIONE
 1900  0963 ED5B56C3                  LD      DE,(ERMEDI_DISP)        ;D'ERRORE NON AGGIORNO ST7
 1901  0967 ED52                      SBC     HL,DE
 1902  0969 284E                      JR      Z,SEND_ERR_FINE
 1903                 
 1904  096B 3001                      JR      NC,SEND_ERR1            ;RESET CARRY SE NECESSARIO
 1905  096D 3F                        CCF
 1906  096E           SEND_ERR1:           
 1907  096E 2A54C3                    LD      HL,(ERMEDI)             ;ERMEDI_DISP = ERMEDI
 1908  0971 2256C3                    LD      (ERMEDI_DISP),HL
 1909                 
 1910                 ;               ;INVIO ERRORE A DAC
 1911                 ;               LD      BC,0800H
 1912                 ;               LD      HL,(ERMEDI)
 1913                 ;               ADD     HL,BC   
 1914                 ;
 1915                 ;               LD      (DACVAL),HL
 1916                 ;               CALL    DAC_TRASM       
 1917                 
 1918                 
 1919                                 ;INVIO ERRORE 
 1920  0974 3A38C3                    LD      A,(MSCORR)              ;IN BASE ALLA DIREZIONE
 1921  0977 FE08                      CP      D_RITARDO               ;SCELGO LA DIREZIONE 
 1922  0979 2820                      JR      Z,SEND_ERR_A            ;CUI SPEDIRE
 1923  097B 1800                      JR      SEND_ERR_R
 1924                                 
 1925                                 
 1926  097D           SEND_ERR_R:     ;INVIO ERRORE RITARDO
 1927  097D CDCC05                    CALL    REQISFREE
 1928  0980 3AC126                    LD      A,(LEGGI)
 1929  0983 32C0C1                    LD      (ARR_TRASM+00H),A
 1930  0986 3AB126                    LD      A,(LONRIT)
 1931  0989 32C1C1                    LD      (ARR_TRASM+01H),A
 1932  098C ED5B54C3                  LD      DE,(ERMEDI)
 1933  0990 21C2C1                    LD      HL,ARR_TRASM+02H
 1934  0993 72                        LD      (HL),D
 1935  0994 23                        INC     HL
 1936  0995 73                        LD      (HL),E
 1937  0996 CD0806                    CALL    REQUEST
 1938  0999 181E                      JR      SEND_ERR_FINE
 1939                 
 1940  099B           SEND_ERR_A:     ;INVIO ERRORE AVANTI
 1941  099B CDCC05                    CALL    REQISFREE
 1942  099E 3AC126                    LD      A,(LEGGI)
 1943  09A1 32C0C1                    LD      (ARR_TRASM+00H),A
 1944  09A4 3AB026                    LD      A,(LONAVA)
 1945  09A7 32C1C1                    LD      (ARR_TRASM+01H),A
 1946  09AA ED5B54C3                  LD      DE,(ERMEDI)
 1947  09AE 21C2C1                    LD      HL,ARR_TRASM+02H
 1948  09B1 72                        LD      (HL),D
 1949  09B2 23                        INC     HL
 1950  09B3 73                        LD      (HL),E
 1951  09B4 CD0806                    CALL    REQUEST
 1952  09B7 1800                      JR      SEND_ERR_FINE
 1953                 
 1954  09B9           SEND_ERR_FINE:
 1955                 
 1956  09B9 C9                        RET
 1957                 
 1958                 
 1959                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1960                 ;                       CALCOLO CENTRATURA GATE
 1961                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1962                 
 1963  09BA D9        CENTRA:         EXX
 1964  09BB 2A0CD0                    LD      HL,(FASE)       ;SOTTRAGGO IL VALORE DI 1/2 GATE 
 1965  09BE ED4B24D0                  LD      BC,(MEZGA)
 1966  09C2 ED42                      SBC     HL,BC           ;SE IL RISULTATO E'POSITIVO LO MEMORIZZO IN IN FASE.
 1967  09C4 3802                      JR      C,RISNEG
 1968  09C6 180B                      JR      TRFASE
 1969  09C8 3F        RISNEG:         CCF                     
 1970  09C9 210010                    LD      HL,1000H        ;SE E'NEGATIVO SOTTRAGGO DA 4096 IL 1/2 GATE E IL RESTO LO SOMMO AL VALORE LETTO.
 1971  09CC ED42                      SBC     HL,BC
 1972  09CE ED4B0CD0                  LD      BC,(FASE)
 1973  09D2 09                        ADD     HL,BC
 1974  09D3           TRFASE:         
 1975  09D3 220CD0                    LD      (FASE),HL       
 1976                 
 1977  09D6 CD3C03                    CALL    FASE_COINCIDENZA
 1978                 
 1979                 ;               LD      A,H
 1980                 ;               OUT     (20H),A
 1981                 ;               LD      A,L
 1982                 ;               OUT     (10H),A
 1983                 
 1984  09D9 3E05                      LD      A,C_MEMRIF           ;4 GIRI ATTESA PER MEMORIZZARE IL RIFERIMENTO
 1985  09DB 321ED0                    LD      (MEMRIF),A
 1986  09DE D9                        EXX               
 1987  09DF C9                        RET
 1988                                 
 1989                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 1990                 ;               CENTRATURA DOPO FASE CON OSCILLOSCOPIO ESTERNO
 1991                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 1992                 
 1993                 
 1994  09E0           CENTRO:         
 1995  09E0 D9                        EXX                     
 1996                 
 1997  09E1 3A64C3                    LD      A,(AUTOCENTRA)
 1998  09E4 FE00                      CP      00H             ;SE AUTOCENTRA = 0 (MESSO SU CAMBIO FASE CON OSCILLOSCOPIO)
 1999  09E6 283A                      JR      Z,CENTRO_FINE   ;ESCI
 2000                 
 2001  09E8 FE01                      CP      01H             ;SE AUTOCENTRA = 1 (MESSO SU CAMBIO FASE CON OSCILLOSCOPIO)
 2002  09EA 280B                      JR      Z,CENTRO_EXECUTE;ESEGUO CENTRATURA GATE
 2003                 
 2004  09EC 1800                      JR      CENTRO_NEXT     ;ALTRIMENTI DECREMENTA AUTOCENTRA
 2005                 
 2006  09EE           CENTRO_NEXT:
 2007  09EE 3A64C3                    LD      A,(AUTOCENTRA)
 2008  09F1 3D                        DEC     A
 2009  09F2 3264C3                    LD      (AUTOCENTRA),A
 2010  09F5 182B                      JR      CENTRO_FINE
 2011                                 
 2012                 
 2013  09F7           CENTRO_EXECUTE:
 2014  09F7 3E00                      LD      A,00H           ;RESETTO AUTOCENTRA
 2015  09F9 3264C3                    LD      (AUTOCENTRA),A
 2016                 
 2017  09FC 2A0ED0                    LD      HL,(FASES1)     ;SOTTRAGGO IL VALORE DI 1/2 GATE DAL VALORE LETTO
 2018  09FF ED4B24D0                  LD      BC,(MEZGA)      
 2019  0A03 ED42                      SBC     HL,BC           ;SE IL RISULTATO E'POSITIVO LO MEMORIZZO IN FASE
 2020  0A05 3802                      JR      C,CENTRO_02
 2021  0A07 180B                      JR      CENTRO_03
 2022  0A09 3F        CENTRO_02:      CCF
 2023  0A0A 210010                    LD      HL,1000H        ;SE E'NEGATIVO
 2024  0A0D ED42                      SBC     HL,BC           ;SOTTRAGGO DA 4096
 2025  0A0F ED4B0ED0                  LD      BC,(FASES1)     ;IL 1/2 GATE E IL
 2026  0A13 09                        ADD     HL,BC           ;RESTO LO SOMMO
 2027  0A14 220CD0    CENTRO_03:      LD      (FASE),HL       ;AL VALORE LETTO.
 2028  0A17 7C                        LD      A,H
 2029  0A18 D320                      OUT     (20H),A
 2030  0A1A 7D                        LD      A,L
 2031  0A1B D310                      OUT     (10H),A
 2032  0A1D 3E05                      LD      A,C_MEMRIF      ;4 GIRI ATTESA
 2033  0A1F 321ED0                    LD      (MEMRIF),A      ;PER MEMORIZZARE
 2034                                                         ;IL RIFERIMENTO
 2035                 
 2036  0A22           CENTRO_FINE:    
 2037  0A22 D9                        EXX                     
 2038  0A23 C9                        RET
 2039                 
 2040                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2041                 ;               CALCOLO DELLO SPOSTAMENTO REGISTRO E GATE
 2042                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2043                 
 2044  0A24 D9        SPOSTA:         EXX
 2045  0A25 ED4B48D0                  LD      BC,(SHIFT)      ;SHIFT x 10 = A
 2046  0A29 ED4306C0                  LD      (MOLTI),BC
 2047  0A2D 3E0A                      LD      A,0AH
 2048  0A2F 3208C0                    LD      (MOLPL),A
 2049  0A32 CD8D14                    CALL    MOLT
 2050  0A35 ED5B0AC0                  LD      DE,(PROD)       ;FLO2 = A
 2051  0A39 ED5300C0                  LD      (DIVDEN),DE     ;A : CENTES = B
 2052  0A3D ED4B06D0                  LD      BC,(CENTES)
 2053  0A41 ED4302C0                  LD      (DIVSOR),BC
 2054  0A45 CD6514                    CALL    DIVIS
 2055  0A48 ED5B04C0                  LD      DE,(QUOZIE)     ;FLO2 = B
 2056                 
 2057                 
 2058  0A4C 3A4AD0                    LD      A,(AVARIT)      
 2059  0A4F 47                        LD      B,A             
 2060  0A50 3AD626                    LD      A,(DIRAVA)      
 2061  0A53 B8                        CP      B               
 2062  0A54 2815                      JR      Z,SPOMEN
 2063                 
 2064  0A56 2A16D0                    LD      HL,(RIFTOT)
 2065  0A59 19                        ADD     HL,DE           ;RIFTOT + B = C
 2066  0A5A EB                        EX      DE,HL           ;SE C < 40960 
 2067  0A5B 2100A0                    LD      HL,0A000H       ;ALLORA C = Z
 2068  0A5E ED52                      SBC     HL,DE           ;SE C > 40960
 2069  0A60 EB                        EX      DE,HL           ;SI FARA'
 2070  0A61 301A                      JR      NC,SPOFIN       ;C - 40960 = Z
 2071  0A63 3F                        CCF
 2072  0A64 1100A0                    LD      DE,0A000H
 2073  0A67 ED52                      SBC     HL,DE
 2074  0A69 1812                      JR      SPOFIN
 2075  0A6B 2A16D0    SPOMEN:         LD      HL,(RIFTOT)     ;RIFTOT - B = C
 2076  0A6E ED52                      SBC     HL,DE           ;SE C = POSITIVO
 2077  0A70 300B                      JR      NC,SPOFIN       ;C = Z
 2078  0A72 3F                        CCF                     ;SE C = NEGATIVO
 2079  0A73 2100A0                    LD      HL,0A000H       ;SI FARA'
 2080  0A76 ED52                      SBC     HL,DE           ;40960 - B = D
 2081  0A78 ED5B16D0                  LD      DE,(RIFTOT)     ;D + RIFTOT = Z
 2082  0A7C 19                        ADD     HL,DE
 2083  0A7D 2216D0    SPOFIN:         LD      (RIFTOT),HL     ;FLO2 = Z
 2084                 
 2085                                 ;RIFTOT/10=POSIZIONE ENCODER
 2086                                 ;POSIZIONE ENCODER - 1/2GATE = NUOVA FASE
 2087                 
 2088  0A80 2200C0                    LD      (DIVDEN),HL
 2089  0A83 010A00                    LD      BC,000AH
 2090  0A86 ED4302C0                  LD      (DIVSOR),BC
 2091  0A8A CD6514                    CALL    DIVIS
 2092  0A8D 2A04C0                    LD      HL,(QUOZIE)
 2093  0A90 ED5B04C0                  LD      DE,(QUOZIE)
 2094  0A94 ED4B24D0                  LD      BC,(MEZGA)     ;
 2095  0A98 ED42                      SBC     HL,BC
 2096  0A9A 3802                      JR      C,RISNE1
 2097  0A9C 1807                      JR      TRFAS1
 2098  0A9E 3F        RISNE1:         CCF                     ;SE 1/2GATE > DI
 2099  0A9F 210010                    LD      HL,1000H        ;QUOZIE ALLORA
 2100  0AA2 ED42                      SBC     HL,BC           ;4096-1/2GAT = A
 2101  0AA4 19                        ADD     HL,DE           ;A + QUOZIE=FASE
 2102  0AA5 220CD0    TRFAS1:         LD      (FASE),HL
 2103  0AA8 7C                        LD      A,H
 2104  0AA9 D320                      OUT     (20H),A
 2105  0AAB 7D                        LD      A,L
 2106  0AAC D310                      OUT     (10H),A
 2107                 
 2108  0AAE 3A98D0                    LD      A,(AUMATI)      ;SE IN MANUALE
 2109  0AB1 FE00                      CP      00H             ;TIRO SALTA 
 2110  0AB3 2813                      JR      Z,TRFAS2
 2111                 
 2112  0AB5 3A8ED0                    LD      A,(TIRCIC)      ;23/7/02 
 2113  0AB8 FE00                      CP      00H             ;A UNO SHIFT
 2114  0ABA 280C                      JR      Z,TRFAS2        ;VIENE TRIPLI-
 2115  0ABC 47                        LD      B,A             ;CATO IL 
 2116  0ABD 17                        RLA                     ;TEMPO DI
 2117  0ABE 80                        ADD     A,B             ;ATTESA  
 2118  0ABF 324EC3                    LD      (DECREM),A      ;DEL TIRO
 2119  0AC2 324CC3                    LD      (INCREM),A       
 2120  0AC5 321EC3                    LD      (TIRCIR_ATT),A      
 2121                 
 2122  0AC8 D9        TRFAS2:         EXX
 2123  0AC9 C9                        RET
 2124                 
 2125                 
 2126                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2127                 ;               SUB-ROUTINE GESTIONE SEGNO STAMPA
 2128                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2129                 
 2130  0ACA           CHKPRINT:       
 2131                                 ;SE SONO IN FUNZIONE COLD SEAL, NON FACCIO IL TEST
 2132                                 ;ALTIMENTI MANDO OK APPENA ENTRA IL SEGNO NEL GATE
 2133  0ACA 3A9CC0                    LD      A,(MEMC)        
 2134  0ACD CB6F                      BIT     B_PC_FUNZ,A             
 2135  0ACF 2013                      JR      NZ,CHKPRINT_END 
 2136                 
 2137                 
 2138                                 ;CONTROLLO SE UN SEGNO E' STATO RILEVATO NEL GATE
 2139  0AD1 DB01                      IN      A,(PB)          
 2140  0AD3 CB5F                      BIT     3,A
 2141  0AD5 280A                      JR      Z,CHKPRINT_OK           
 2142                 
 2143  0AD7           CHKPRINT_ERR:   ;NON C'E' SEGNO
 2144  0AD7 3E02                      LD      A,02H           ;BLOCCO LA CORREZIONE 
 2145  0AD9 3244C3                    LD      (MATTES),A      ;AUMENTANDO I CICLI DI ATTESA.
 2146  0ADC CDF20A                    CALL    NOPRINT         ;ATTIVO ALLARME E MANDO MESSAGGIO
 2147  0ADF 1803                      JR      CHKPRINT_END
 2148                                 
 2149  0AE1           CHKPRINT_OK:    ;C'E' IL SEGNO
 2150  0AE1 CDE50A                    CALL    SIPRINT
 2151                                 ;JR     CHKPRINT_END
 2152                 
 2153  0AE4           CHKPRINT_END:
 2154  0AE4 C9                        RET
 2155                 
 2156                 
 2157                 
 2158                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2159                 ;               SUB-ROUTINE GESTIONE SI PRINT
 2160                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2161                 
 2162  0AE5           SIPRINT:        ;SE NON IN ERRORE, RESETTO IL FLAG DELLO STATO D'ALLARME E 
 2163                                 ;RIMUOVO IL MESSAGGIO "NO PRINT"
 2164  0AE5 ED5BE426                  LD      DE,(S_MANCANZA_STAMPA)
 2165  0AE9 CD8006                    CALL    RES_STATUS
 2166  0AEC 3E00                      LD      A,00H
 2167  0AEE 3240C3                    LD      (PROPRI),A
 2168  0AF1 C9                        RET
 2169                 
 2170                 
 2171                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2172                 ;               SUB-ROUTINTE GESTIONE NO PRINT
 2173                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2174                                 
 2175  0AF2           NOPRINT:        ;SE IN ERRORE, SETTO FLAG DELLO STATO D'ALLARME, 
 2176                                 ;INVIO MESSAGGIO "NO PRINT",
 2177                                 ;FACCIO IL RESET DELLE PORTE DI CORREZIONE (SOLO IN AUTOMATICO)
 2178  0AF2 ED5BE426                  LD      DE,(S_MANCANZA_STAMPA)
 2179  0AF6 CD7106                    CALL    SET_STATUS
 2180  0AF9 3E01                      LD      A,01H 
 2181  0AFB 3240C3                    LD      (PROPRI),A
 2182                 
 2183  0AFE 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE NON 
 2184  0B01 FE00                      CP      00H             ;RESETTARE LE USCITE DI COMANDO
 2185  0B03 2803                      JR      Z,NOPRI_FINE
 2186                                 
 2187  0B05 CD451A                    CALL    RESEPC
 2188                                 
 2189  0B08           NOPRI_FINE:
 2190  0B08 C9                        RET
 2191                 
 2192                 
 2193                 
 2194                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2195                 ;               SUB-ROUTINE ACCENDI ALLARME
 2196                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2197                 
 2198  0B09           ALARM_ON:       
 2199  0B09 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE, 
 2200  0B0C FE00                      CP      00H             ;NON ATTIVO L'ALLARME
 2201  0B0E 280A                      JR      Z,ALARM_ON_FINE
 2202                 
 2203  0B10 3A9CC0                    LD      A,(MEMC)
 2204  0B13 CBDF                      SET     B_PC_ALLARME,A             ;ATTIVO ALLARME
 2205  0B15 329CC0                    LD      (MEMC),A
 2206  0B18 D363                      OUT     (PC),A
 2207                  
 2208  0B1A           ALARM_ON_FINE:
 2209  0B1A C9                        RET
 2210                 
 2211                 
 2212                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2213                 ;               SUB-ROUTINE SPEGNI ALLARME
 2214                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2215                 
 2216  0B1B 3A9CC0    ALARM_OFF:      LD      A,(MEMC)
 2217  0B1E CB9F                      RES     B_PC_ALLARME,A             ;DISATTIVO ALLARME
 2218  0B20 329CC0                    LD      (MEMC),A
 2219  0B23 D363                      OUT     (PC),A
 2220  0B25 C9                        RET
 2221                 
 2222                 
 2223                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2224                 ;               SUB-ROUTINE ACCENDI F9
 2225                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2226                 
 2227  0B26 3A9CC0    F9_ON:          LD      A,(MEMC)        
 2228  0B29 CB87                      RES     B_PC_AVANTI,A
 2229  0B2B CBCF                      SET     B_PC_RITARDO,A
 2230  0B2D CBDF                      SET     B_PC_ALLARME,A
 2231  0B2F CBEF                      SET     B_PC_FUNZ,A             ;ATTIVO F9
 2232  0B31 329CC0                    LD      (MEMC),A
 2233  0B34 D363                      OUT     (PC),A
 2234                 
 2235  0B36 3A98D0                    LD      A,(AUMATI)
 2236  0B39 3256D0                    LD      (AUMATI_OLD), A
 2237                 
 2238  0B3C 3EFF                      LD      A,0FFH          ;IMPONGO AUTOMATICO 
 2239  0B3E 3294D0                    LD      (AUMALO),A
 2240                 
 2241  0B41 3E00                      LD      A,000H          ;IMPONGO MANUALE
 2242  0B43 3296D0                    LD      (AUMATR),A      
 2243  0B46 3298D0                    LD      (AUMATI),A      
 2244                 
 2245  0B49 C9                        RET
 2246                 
 2247                 
 2248                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2249                 ;               SUB-ROUTINE SPEGNI F9
 2250                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2251                 
 2252  0B4A 3A9CC0    F9_OFF:         LD      A,(MEMC)
 2253  0B4D CB6F                      BIT     B_PC_FUNZ,A
 2254  0B4F 2813                      JR      Z,F9_OFF1       ;SE GIA' SPENTO, NON FACCIO NULLA
 2255                 
 2256  0B51 3A56D0                    LD      A,(AUMATI_OLD)  ;IMPOSTO IL VALORE PRECEDENTE DI AUMATI
 2257  0B54 3298D0                    LD      (AUMATI), A
 2258                 
 2259                                 
 2260  0B57 3A9CC0                    LD      A,(MEMC)
 2261  0B5A CBAF                      RES     B_PC_FUNZ,A             ;ALTRIMENTI DISATTIVO F9
 2262  0B5C 329CC0                    LD      (MEMC),A
 2263  0B5F D363                      OUT     (PC),A
 2264  0B61 CD1306                    CALL    SEND_OK         ;E INVIO OK A CPU
 2265                 
 2266                 
 2267  0B64           F9_OFF1:
 2268  0B64 C9                        RET
 2269                 
 2270                 
 2271                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2272                 ;               SUB-ROUTINE LOW-SPEED
 2273                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2274                 
 2275  0B65           SPEED_LOW:
 2276  0B65 ED5BE626                  LD      DE,(S_VELOCITA_SOTTO_SOGLIA)
 2277  0B69 CD7106                    CALL    SET_STATUS
 2278                 
 2279  0B6C 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE, NON INVIO
 2280  0B6F FE00                      CP      00H             ;ATTIVO ALLARME PER BASSA VELOCITA'
 2281  0B71 CA7C0B                    JP      Z,SPEED_LOW_FINE
 2282                 
 2283  0B74 CD451A                    CALL    RESEPC          ;RESET USCITE DI CORREZIONE
 2284                 
 2285  0B77 3E01                      LD      A,01H
 2286  0B79 3242C3                    LD      (PROVEL),A  
 2287  0B7C           SPEED_LOW_FINE:
 2288  0B7C C9                        RET
 2289                 
 2290                 
 2291                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2292                 ;               SUB-ROUTINE SPEED-OK
 2293                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2294                 
 2295  0B7D ED5BE626  SPEEDOK:        LD      DE,(S_VELOCITA_SOTTO_SOGLIA)
 2296  0B81 CD8006                    CALL    RES_STATUS
 2297  0B84 3E00                      LD      A,00H
 2298  0B86 3242C3                    LD      (PROVEL),A
 2299  0B89 C9                        RET
 2300                 
 2301                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2302                 ;               SUB-ROUTINTE GESTIONE DECELLERA
 2303                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2304                                 
 2305  0B8A           DECEL:          ;SE IN ERRORE, SETTO FLAG DELLO STATO D'ALLARME, 
 2306                                 ;INVIO MESSAGGIO "DECELLERAZIONE",
 2307                                 ;FACCIO IL RESET DELLE PORTE DI CORREZIONE (SOLO IN AUTOMATICO)
 2308  0B8A ED5BF226                  LD      DE,(S_BLOCCO_DECELERAZIONE)
 2309  0B8E CD7106                    CALL    SET_STATUS
 2310  0B91 3E01                      LD      A,01H 
 2311  0B93 3242C3                    LD      (PROVEL),A
 2312                 
 2313  0B96 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE NON 
 2314  0B99 FE00                      CP      00H             ;RESETTARE LE USCITE DI COMANDO
 2315  0B9B 2803                      JR      Z,DECEL_FINE
 2316  0B9D CD451A                    CALL    RESEPC
 2317                                 
 2318  0BA0           DECEL_FINE:
 2319  0BA0 C9                        RET
 2320                 
 2321                 
 2322                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2323                 ;               SUB-ROUTINTE GESTIONE ACCELERA
 2324                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2325                                 
 2326  0BA1           ACCEL:          ;SE IN ERRORE, SETTO FLAG DELLO STATO D'ALLARME, 
 2327                                 ;INVIO MESSAGGIO "ACCELERAZIONE",
 2328                                 ;FACCIO IL RESET DELLE PORTE DI CORREZIONE (SOLO IN AUTOMATICO)
 2329  0BA1 ED5BF426                  LD      DE,(S_BLOCCO_ACCELERAZIONE)
 2330  0BA5 CD7106                    CALL    SET_STATUS
 2331  0BA8 3E01                      LD      A,01H 
 2332  0BAA 3242C3                    LD      (PROVEL),A
 2333                 
 2334  0BAD 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE NON 
 2335  0BB0 FE00                      CP      00H             ;RESETTARE LE USCITE DI COMANDO
 2336  0BB2 2803                      JR      Z,ACCEL_FINE
 2337  0BB4 CD451A                    CALL    RESEPC
 2338  0BB7           ACCEL_FINE:
 2339  0BB7 C9                        RET
 2340                 
 2341                 
 2342                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2343                 ;               SUB-ROUTINE VELOCITA'COSTANTE
 2344                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2345                 
 2346  0BB8           VELCOST:        ;SE NON IN ERRORE, RESETTO IL FLAG DELLO STATO D'ALLARME E 
 2347                                 ;RIMUOVO IL MESSAGGIO "ACC/DEC"
 2348  0BB8 ED5BF426                  LD      DE,(S_BLOCCO_ACCELERAZIONE)
 2349  0BBC CD8006                    CALL    RES_STATUS
 2350  0BBF ED5BF226                  LD      DE,(S_BLOCCO_DECELERAZIONE)
 2351  0BC3 CD8006                    CALL    RES_STATUS
 2352  0BC6 3E00                      LD      A,00H
 2353  0BC8 3242C3                    LD      (PROVEL),A
 2354  0BCB           VELCOST_FINE:
 2355  0BCB C9                        RET
 2356                 
 2357                 
 2358                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2359                 ;               SUB-ROUTINE DOPPIO SEGNO
 2360                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2361  0BCC           DOPPIO:
 2362  0BCC ED5BEA26                  LD      DE,(S_DOPPIO_SEGNO)
 2363  0BD0 CD7106                    CALL    SET_STATUS
 2364  0BD3 C9                        RET
 2365                 
 2366                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2367                 ;               SUB-ROUTINE CALCOLA VELOCITA IMPULSIVA - VELIMP
 2368                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2369                 
 2370  0BD4           SPEED_CALC:
 2371  0BD4 017404                    LD      BC,0474H        ;16mS TEMPO   
 2372  0BD7 DD2106C3                  LD      IX,VELIMP       ;PER MISURARE
 2373  0BDB 3E00                      LD      A,00H           ;GLI IMPULSI
 2374  0BDD DD7701                    LD      (IX+01H),A
 2375  0BE0 3E57                      LD      A,057H          ;SETTO CTC0 COME TIMER
 2376  0BE2 D370                      OUT     (CTC0_CMD),A    ;SENZA INTERUPT
 2377  0BE4 3EFF                      LD      A,0FFH          ;PARTENDO DA 0FFH
 2378  0BE6 D370                      OUT     (CTC0_CMD),A         
 2379  0BE8           SPEED_C1:         
 2380  0BE8 DB70                      IN      A,(CTC0_CMD)    ;NEL CASO IL 
 2381  0BEA FE00                      CP      00H             ;DECREMENTO 
 2382  0BEC 2003                      JR      NZ,SPEED_C2     ;ARRIVI A ZERO
 2383  0BEE DD3401                    INC     (IX+01H)        ;LO MEMORIZZO
 2384  0BF1           SPEED_C2:         
 2385  0BF1 0B                        DEC     BC              
 2386  0BF2 78                        LD      A,B
 2387  0BF3 B1                        OR      C
 2388  0BF4 20F2                      JR      NZ,SPEED_C1       
 2389  0BF6 DB70                      IN      A,(CTC0_CMD)         
 2390  0BF8 2F                        CPL                     ;IMPULSI PROPOR
 2391  0BF9 3206C3                    LD      (VELIMP),A      ;ALLA VELOCITA.
 2392                 
 2393  0BFC           SPEED_CALC_FINE:
 2394  0BFC C9                        RET
 2395                 
 2396                 
 2397                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2398                 ;               CONTROLLO ZONA MORTA
 2399                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2400                 
 2401  0BFD           CORREZIONI:         
 2402  0BFD 3A94D0                    LD      A,(AUMALO)      ;SE SONO IN MANUALE, NON MI INTERESSA, 
 2403  0C00 FE00                      CP      00H             ;DISATTIVARE LE USCITE IN BASE ALLA ZONA MORTA
 2404  0C02 281B                      JR      Z,CORREZIONI_1
 2405                 
 2406  0C04 2A54C3                    LD      HL,(ERMEDI)     ;SE ZONA MORTA E'
 2407  0C07 ED5B70D0                  LD      DE,(ZONA)       ;> DELL'ERRORE
 2408  0C0B ED52                      SBC     HL,DE           ;NON CORREGGO
 2409  0C0D 3010                      JR      NC,CORREZIONI_1
 2410  0C0F 3F                        CCF
 2411  0C10 3A9CC0                    LD      A,(MEMC)        
 2412  0C13 CB87                      RES     B_PC_AVANTI,A             
 2413  0C15 CB8F                      RES     B_PC_RITARDO,A             
 2414  0C17 329CC0                    LD      (MEMC),A        
 2415  0C1A D363                      OUT     (PC),A                  
 2416  0C1C C3A00E                    JP      CORREZIONI_END
 2417                 
 2418                 
 2419                                 ;#####################################################################
 2420                                 ;# CALCOLO CORREZIONE MOTORE                                         #
 2421                                 ;# [Ea x C/10 + (Ea - Ep) x D] x G                                   #
 2422                                 ;# [Ea x (C/10 + D) x G] - [Ep x D x G]                              #
 2423                                 ;# CORRATT = 80000000h + [Ea x (C/10 + D) x G] - [Ep x D x G]        #
 2424                                 ;#####################################################################
 2425                 
 2426                 
 2427  0C1F           CORREZIONI_1:   
 2428                                 ;[Ea x (C/10 + D) x G]
 2429  0C1F ED5B26D0                  LD      DE,(CILDIV)     
 2430  0C23 2A6ED0                    LD      HL,(DERIVA)
 2431  0C26 19                        ADD     HL,DE           ;HL = C/10+D
 2432  0C27 2232C0                    LD      (MDO032),HL
 2433  0C2A 2A6AD0                    LD      HL,(GUADA)      ;HL = G
 2434  0C2D 2236C0                    LD      (MRE032),HL
 2435  0C30 210000                    LD      HL,0000H
 2436  0C33 2234C0                    LD      (MDO232),HL
 2437  0C36 2238C0                    LD      (MRE232),HL
 2438  0C39 CD9815                    CALL    MOL32           ;PT = (C/10+D)*G
 2439  0C3C 2A3AC0                    LD      HL,(PTO032)
 2440  0C3F 2232C0                    LD      (MDO032),HL
 2441  0C42 2A3CC0                    LD      HL,(PTO232)
 2442  0C45 2234C0                    LD      (MDO232),HL
 2443  0C48 2A50C3                    LD      HL,(ERATTU)     ;HL = Ea
 2444  0C4B 2236C0                    LD      (MRE032),HL     
 2445  0C4E CD9815                    CALL    MOL32           ;PT = [Ea x (C/10 + D) x G]
 2446                 
 2447  0C51 3A8AC3                    LD      A,(MSCORR_ATT)  
 2448  0C54 FE01                      CP      D_AVANTI        
 2449  0C56 2829                      JR      Z,CORREZIONI_2  
 2450                 
 2451                                 ;CORRATT = 80000000h - [Ea x (C/10 + D) x G]
 2452  0C58 2A3AC0                    LD      HL,(PTO032)
 2453  0C5B 2270C0                    LD      (CUBTR0),HL     ;SOTTRAENDO = [Ea x (C/10 + D) x G]
 2454  0C5E 2A3CC0                    LD      HL,(PTO232)
 2455  0C61 2272C0                    LD      (CUBTR2),HL
 2456  0C64 210000                    LD      HL,0000H        ;MINUENDO = 80000000h
 2457  0C67 226CC0                    LD      (CINUE0),HL
 2458  0C6A 210080                    LD      HL,8000H
 2459  0C6D 226EC0                    LD      (CINUE2),HL
 2460  0C70 CD9618                    CALL    CSOTT32         ;RESTO = MINUENDO - SOTTRAENDO
 2461  0C73 2A74C0                    LD      HL,(CESTO0)
 2462  0C76 2286C3                    LD      (CORRATT),HL    ;BASSO
 2463  0C79 2A76C0                    LD      HL,(CESTO2)
 2464  0C7C 2288C3                    LD      (CORRATT+02H),HL ;ALTO
 2465  0C7F 1829                      JR      CORREZIONI_3
 2466                 
 2467  0C81           CORREZIONI_2:
 2468                                 ;CORRATT = 80000000h + [Ea x (C/10 + D) x G]
 2469  0C81 2A3AC0                    LD      HL,(PTO032)
 2470  0C84 221AC0                    LD      (ADDEN0),HL     ;ADDENDO = [Ea x (C/10 + D) x G]
 2471  0C87 2A3CC0                    LD      HL,(PTO232)
 2472  0C8A 221CC0                    LD      (ADDEN2),HL
 2473  0C8D 210000                    LD      HL,0000H        ;AUGEND0 = 80000000h
 2474  0C90 221EC0                    LD      (AUGEN0),HL
 2475  0C93 210080                    LD      HL,8000H
 2476  0C96 2220C0                    LD      (AUGEN2),HL
 2477  0C99 CD8318                    CALL    SOMM32          ;AUGENDO = ADDENDO + AUGENDO
 2478  0C9C 2A1EC0                    LD      HL,(AUGEN0)
 2479  0C9F 2286C3                    LD      (CORRATT),HL    ;BASSO
 2480  0CA2 2A20C0                    LD      HL,(AUGEN2)
 2481  0CA5 2288C3                    LD      (CORRATT+02H),HL ;ALTO
 2482  0CA8 1800                      JR      CORREZIONI_3
 2483                                 
 2484                 
 2485  0CAA           CORREZIONI_3:
 2486                                 ;[Ep x D x G]
 2487  0CAA 2A52C3                    LD      HL,(ERPREC)     
 2488  0CAD 2206C0                    LD      (MOLTI),HL
 2489  0CB0 3A6ED0                    LD      A,(DERIVA)
 2490  0CB3 3208C0                    LD      (MOLPL),A
 2491  0CB6 CD8D14                    CALL    MOLT
 2492  0CB9 2A0AC0                    LD      HL,(PROD)      
 2493  0CBC 220CC0                    LD      (MOLT24),HL       ;RISULTATO
 2494  0CBF 3A6AD0                    LD      A,(GUADA)
 2495  0CC2 320EC0                    LD      (MOLP24),A      
 2496  0CC5 CDAD14                    CALL    MOL24
 2497                 
 2498  0CC8 3A3AC3                    LD      A,(MSCORR_PREC) 
 2499  0CCB FE01                      CP      D_AVANTI        
 2500  0CCD 2829                      JR      Z,CORREZIONI_4  
 2501                 
 2502                                 ;CORRATT = CORRATT + [Ep x D x G]
 2503  0CCF 2A86C3                    LD      HL,(CORRATT)
 2504  0CD2 221AC0                    LD      (ADDEN0),HL     ;ADDENDO = CORRATT
 2505  0CD5 2A88C3                    LD      HL,(CORRATT+02H)
 2506  0CD8 221CC0                    LD      (ADDEN2),HL
 2507  0CDB 2A10C0                    LD      HL,(PROD24)     ;AUGEND0 = [Ep x D x G]
 2508  0CDE 221EC0                    LD      (AUGEN0),HL
 2509  0CE1 2A12C0                    LD      HL,(PROD24+02H)
 2510  0CE4 2220C0                    LD      (AUGEN2),HL
 2511  0CE7 CD8318                    CALL    SOMM32          ;AUGENDO = ADDENDO + AUGENDO
 2512  0CEA 2A1EC0                    LD      HL,(AUGEN0)
 2513  0CED 2286C3                    LD      (CORRATT),HL    ;BASSO
 2514  0CF0 2A20C0                    LD      HL,(AUGEN2)
 2515  0CF3 2288C3                    LD      (CORRATT+02H),HL ;ALTO
 2516  0CF6 1829                      JR      CORREZIONI_5
 2517                 
 2518  0CF8           CORREZIONI_4:
 2519                                 ;CORRATT = CORRATT - [Ep x D x G]
 2520  0CF8 2A10C0                    LD      HL,(PROD24)
 2521  0CFB 2270C0                    LD      (CUBTR0),HL     ;SOTTRAENDO = [Ep x D x G]
 2522  0CFE 2A12C0                    LD      HL,(PROD24+02H)
 2523  0D01 2272C0                    LD      (CUBTR2),HL
 2524  0D04 2A86C3                    LD      HL,(CORRATT)    ;MINUENDO = CORRATT
 2525  0D07 226CC0                    LD      (CINUE0),HL
 2526  0D0A 2A88C3                    LD      HL,(CORRATT+02H)
 2527  0D0D 226EC0                    LD      (CINUE2),HL
 2528  0D10 CD9618                    CALL    CSOTT32         ;RESTO = MINUENDO - SOTTRAENDO
 2529  0D13 2A74C0                    LD      HL,(CESTO0)
 2530  0D16 2286C3                    LD      (CORRATT),HL    ;BASSO
 2531  0D19 2A76C0                    LD      HL,(CESTO2)
 2532  0D1C 2288C3                    LD      (CORRATT+02H),HL ;ALTO
 2533                 
 2534  0D1F 1800                      JR      CORREZIONI_5
 2535  0D21           CORREZIONI_5:
 2536  0D21 3A89C3                    LD      A,(CORRATT+03H) ;IF CORRATT > 80000000h THEN MSCORR=D_AVANTI ELSE MSCORR=D_RITARDO
 2537  0D24 CB7F                      BIT     7,A
 2538  0D26 2807                      JR      Z,CORREZIONI_6
 2539                 
 2540  0D28 3E01                      LD      A,D_AVANTI
 2541  0D2A 3238C3                    LD      (MSCORR),A
 2542  0D2D 1807                      JR      CORREZIONI_7
 2543                 
 2544  0D2F           CORREZIONI_6:
 2545  0D2F 3E08                      LD      A,D_RITARDO
 2546  0D31 3238C3                    LD      (MSCORR),A
 2547  0D34 1800                      JR      CORREZIONI_7
 2548                 
 2549  0D36           CORREZIONI_7:   
 2550  0D36 210000                    LD      HL,0000H
 2551  0D39 2270C0                    LD      (CUBTR0),HL     ;SOTTRAENDO = 80000000h
 2552  0D3C 210080                    LD      HL,8000h
 2553  0D3F 2272C0                    LD      (CUBTR2),HL
 2554  0D42 2A86C3                    LD      HL,(CORRATT)    ;MINUENDO = CORRATT
 2555  0D45 226CC0                    LD      (CINUE0),HL
 2556  0D48 2A88C3                    LD      HL,(CORRATT+02H)
 2557  0D4B 226EC0                    LD      (CINUE2),HL
 2558  0D4E CD9618                    CALL    CSOTT32         ;RESTO = MINUENDO - SOTTRAENDO
 2559  0D51 2A74C0                    LD      HL,(CESTO0)
 2560  0D54 2286C3                    LD      (CORRATT),HL    ;BASSO
 2561  0D57 2A76C0                    LD      HL,(CESTO2)
 2562  0D5A 2288C3                    LD      (CORRATT+02H),HL ;ALTO
 2563                                 
 2564  0D5D           CORREZIONI_8:           
 2565                 
 2566  0D5D 3A89C3                    LD      A,(CORRATT+03H)
 2567  0D60 E67F                      AND     7FH
 2568  0D62 FE00                      CP      00H
 2569  0D64 2807                      JR      Z,CORREZIONI_9
 2570  0D66 01FFFF                    LD      BC,0FFFFH
 2571  0D69 3EFF                      LD      A,0FFH
 2572  0D6B 1809                      JR      CORREZIONI_10
 2573  0D6D           CORREZIONI_9:
 2574  0D6D ED4B86C3                  LD      BC,(CORRATT)
 2575  0D71 3A88C3                    LD      A,(CORRATT+02H)
 2576  0D74 1800                      JR      CORREZIONI_10
 2577  0D76           CORREZIONI_10:
 2578                 
 2579  0D76 3214C3                    LD      (MDECOR),A      ;VALORE PER 
 2580  0D79 FE00                      CP      00H             ;EXTRA CORREZ.
 2581  0D7B 2006                      JR      NZ,CORREZIONI_11
 2582                 
 2583  0D7D 78                        LD      A,B
 2584                 
 2585  0D7E 3216C3                    LD      (CORRE),A
 2586  0D81 1805                      JR      CORREZIONI_12          
 2587  0D83 3EFF      CORREZIONI_11:  LD      A,0FFH
 2588  0D85 3216C3                    LD      (CORRE),A
 2589                 
 2590                 
 2591                 
 2592                                 ;ROUTINE DI CORREZIONE
 2593                 
 2594                 
 2595  0D88 3A2CD0    CORREZIONI_12:  LD      A,(CIDE75)      ;DECREMENTO 
 2596  0D8B FE00                      CP      00H             ;DEL 75% DEL
 2597  0D8D 2804                      JR      Z,CORREZIONI_13        ;CICLO
 2598  0D8F 3D                        DEC     A
 2599  0D90 322CD0                    LD      (CIDE75),A
 2600                 
 2601                 
 2602  0D93           CORREZIONI_13:       
 2603  0D93 3A40C3                    LD      A,(PROPRI)              ;SE IN PROTEZIONE 
 2604  0D96 FE01                      CP      01H                     ;(ALLARME) ATTIVO
 2605  0D98 CAA00E                    JP      Z,CORREZIONI_END        ;ESCO 
 2606  0D9B 3A42C3                    LD      A,(PROVEL)              ;SE IN PROTEZIONE 
 2607  0D9E FE01                      CP      01H                     ;(ALLARME) ATTIVO
 2608  0DA0 CAA00E                    JP      Z,CORREZIONI_END        ;ESCO 
 2609                 
 2610  0DA3 3A44C3                    LD      A,(MATTES)              ;CONTROLLO CICLO
 2611  0DA6 3D                        DEC     A                       ;DI ATTESA
 2612  0DA7 3244C3                    LD      (MATTES),A
 2613  0DAA FE00                      CP      00H
 2614  0DAC C2A00E                    JP      NZ,CORREZIONI_END
 2615                 
 2616  0DAF 3A2AD0                    LD      A,(CICL75)              ;RICARICO IL 
 2617  0DB2 322CD0                    LD      (CIDE75),A              ;75% DEL CICLO 
 2618                 
 2619  0DB5 3A6CD0                    LD      A,(CICLO)               ;RICARICO IL CI-
 2620  0DB8 3244C3                    LD      (MATTES),A              ;CLO DI ATTESA.
 2621                 
 2622  0DBB 2A54C3                    LD      HL,(ERMEDI)
 2623  0DBE ED5B70D0                  LD      DE,(ZONA)
 2624  0DC2 ED52                      SBC     HL,DE                   ;SE ZONA MORTA
 2625  0DC4 3004                      JR      NC,CORREZIONI_14                ;MAGGIORE DI
 2626  0DC6 3F                        CCF                             ;ERMEDI SALTO
 2627  0DC7 C3A00E                    JP      CORREZIONI_END
 2628  0DCA           CORREZIONI_14:         
 2629  0DCA 3A94D0                    LD      A,(AUMALO)              ;SE SONO IN 
 2630  0DCD FE00                      CP      00H                     ;MANUALE SALTO
 2631  0DCF CAA00E                    JP      Z,CORREZIONI_END
 2632                 
 2633  0DD2 3A16C3                    LD      A,(CORRE)
 2634  0DD5 FE00                      CP      00H                     ;SALTO
 2635  0DD7 CAA10E                    JP      Z,KRAPIN        
 2636                 
 2637  0DDA 3A14C3                    LD      A,(MDECOR)
 2638  0DDD 3212C3                    LD      (DECORR),A
 2639                 
 2640                 
 2641  0DE0 3E37                      LD      A,37H                   ;CONTROLLO CTC1   
 2642  0DE2 D371                      OUT     (CTC1_CMD),A         
 2643  0DE4 3E40                      LD      A,40H                   ;COSTANTE DI TEMPO
 2644  0DE6 D371                      OUT     (CTC1_CMD),A                    
 2645  0DE8 3ED7                      LD      A,0D7H                  ;CONTROLLO CTC2
 2646  0DEA D372                      OUT     (CTC2_CMD),A
 2647  0DEC 3A16C3                    LD      A,(CORRE)               ;MSB ERRORE  
 2648  0DEF D372                      OUT     (CTC2_CMD),A
 2649                 
 2650                 
 2651  0DF1 3A38C3                    LD      A,(MSCORR)              ;VEDO IN CHE
 2652  0DF4 FE01                      CP      D_AVANTI                ;SENSO CORREG.
 2653  0DF6 2054                      JR      NZ,AUTRIT
 2654                 ;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 2655  0DF8 3A8ED0                    LD      A,(TIRCIC)              ;SE INTERVALLO TIRO E' A ZERO SALTA
 2656  0DFB FE00                      CP      00H                     
 2657  0DFD 2836                      JR      Z,AUTAVA
 2658                 
 2659  0DFF 3A98D0                    LD      A,(AUMATI)              ;SE TIRO E' IN MANUALE SALTA 
 2660  0E02 FE00                      CP      00H                     
 2661  0E04 282F                      JR      Z,AUTAVA
 2662                 
 2663  0E06 ED4B1EC3                  LD      BC,(TIRCIR_ATT)
 2664  0E0A 3A4EC3                    LD      A,(DECREM)
 2665  0E0D 3C                        INC     A
 2666  0E0E B9                        CP      C
 2667  0E0F 3803                      JR      C,CORREZIONI_15 
 2668  0E11 3A1EC3                    LD      A,(TIRCIR_ATT)
 2669  0E14           CORREZIONI_15:
 2670  0E14 324EC3                    LD      (DECREM),A
 2671                 
 2672  0E17 3A4CC3                    LD      A,(INCREM)
 2673  0E1A 3D                        DEC     A
 2674  0E1B 324CC3                    LD      (INCREM),A
 2675  0E1E FE00                      CP      00H
 2676  0E20 2013                      JR      NZ,AUTAVA
 2677  0E22 3A1EC3                    LD      A,(TIRCIR_ATT)
 2678  0E25 324CC3                    LD      (INCREM),A
 2679                                 
 2680  0E28 3E01                      LD      A,01H           
 2681  0E2A 3230C3                    LD      (TMEM6),A               ;PIU' CARTA
 2682  0E2D 322CC3                    LD      (TMEM4),A               ;ATTIVO 
 2683  0E30 CDBB0E                    CALL    CORREZIONE_TIRO         ;CORREZ.TIRO
 2684  0E33 186B                      JR      CORREZIONI_END
 2685                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2686                 
 2687  0E35 3A9CC0    AUTAVA:         LD      A,(MEMC)        ;CORREZIONE IN
 2688  0E38 CB8F                      RES     B_PC_RITARDO,A  ;AVANTI
 2689  0E3A CBC7                      SET     B_PC_AVANTI,A
 2690  0E3C 329CC0                    LD      (MEMC),A
 2691  0E3F D363                      OUT     (PC),A
 2692                 
 2693                                 
 2694                                 ;INCREMENTO TEMPORANEAMENTE IL DAC
 2695  0E41 2AAAD0                    LD      HL,(DACDELTACOR)
 2696  0E44 227AC3                    LD      (DAC_INCREM),HL
 2697  0E47 CD931C                    CALL    DAC_INCR_DECR
 2698                 
 2699                                 
 2700  0E4A 1854                      JR      CORREZIONI_END
 2701                 
 2702  0E4C           AUTRIT:
 2703  0E4C 3A8ED0                    LD      A,(TIRCIC)      ;SE A ZERO  
 2704  0E4F FE00                      CP      00H             ; SALTA
 2705  0E51 2838                      JR      Z,AUTRI1
 2706                 
 2707  0E53 3A98D0                    LD      A,(AUMATI)      ;SE IN MANUALE
 2708  0E56 FE00                      CP      00H             ;TIRO SALTA 
 2709  0E58 2831                      JR      Z,AUTRI1
 2710                 
 2711  0E5A ED4B1EC3                  LD      BC,(TIRCIR_ATT)
 2712  0E5E 3A4CC3                    LD      A,(INCREM)
 2713  0E61 3C                        INC     A
 2714  0E62 B9                        CP      C
 2715  0E63 3803                      JR      C,CORREZIONI_16 
 2716  0E65 3A1EC3                    LD      A,(TIRCIR_ATT)
 2717  0E68           CORREZIONI_16:
 2718  0E68 324CC3                    LD      (INCREM),A
 2719                 
 2720  0E6B 3A4EC3                    LD      A,(DECREM)
 2721  0E6E 3D                        DEC     A
 2722  0E6F 324EC3                    LD      (DECREM),A
 2723  0E72 FE00                      CP      00H
 2724  0E74 2015                      JR      NZ,AUTRI1
 2725  0E76 3A1EC3                    LD      A,(TIRCIR_ATT)      
 2726  0E79 324EC3                    LD      (DECREM),A
 2727  0E7C 3E02                      LD      A,02H           ;MENO CARTA
 2728  0E7E 3230C3                    LD      (TMEM6),A
 2729  0E81 3E01                      LD      A,01H           ;ATTIVO
 2730  0E83 322CC3                    LD      (TMEM4),A       ;CORREZ.TIRO 
 2731  0E86 CDBB0E                    CALL    CORREZIONE_TIRO
 2732  0E89 1815                      JR      CORREZIONI_END
 2733                 
 2734                 
 2735  0E8B 3A9CC0    AUTRI1:         LD      A,(MEMC)        ;CORREZIONE IN
 2736  0E8E CB87                      RES     B_PC_AVANTI,A   ;RITARDO
 2737  0E90 CBCF                      SET     B_PC_RITARDO,A
 2738  0E92 329CC0                    LD      (MEMC),A
 2739  0E95 D363                      OUT     (PC),A
 2740                 
 2741                                 ;DECREMENTO TEMPORANEAMENTE IL DAC
 2742  0E97 2AAAD0                    LD      HL,(DACDELTACOR)
 2743  0E9A 227CC3                    LD      (DAC_DECREM),HL
 2744  0E9D CD931C                    CALL    DAC_INCR_DECR
 2745                                 
 2746  0EA0           CORREZIONI_END:         
 2747  0EA0 C9                        RET
 2748                 
 2749                 
 2750                 
 2751                 
 2752                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2753                 ;               RESET USCITE DI CORREZIONE INDESIDERATE
 2754                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2755                 
 2756  0EA1           KRAPIN:
 2757  0EA1 3A94D0                    LD      A,(AUMALO)      ;SE E' IN MANUALE NON 
 2758  0EA4 FE00                      CP      00H             ;RESETTARE LE USCITE DI COMANDO
 2759  0EA6 2803                      JR      Z,KRAPIN1
 2760                 
 2761  0EA8 CD451A                    CALL    RESEPC          ;RESET USCITE DI CORREZIONE INDESIDERATE
 2762                 
 2763  0EAB           KRAPIN1:                        
 2764  0EAB 3E43                      LD      A,43H           
 2765  0EAD D371                      OUT     (CTC1_CMD),A         
 2766  0EAF D372                      OUT     (CTC2_CMD),A
 2767                                                      
 2768  0EB1 3A1EC3                    LD      A,(TIRCIR_ATT)      
 2769  0EB4 324CC3                    LD      (INCREM),A
 2770  0EB7 324EC3                    LD      (DECREM),A
 2771  0EBA C9                        RET
 2772                 
 2773                 
 2774                 
 2775                                 ;##################################
 2776                                 ;# CALCOLO CORREZIONE MOTORE TIRO #
 2777                                 ;# Et x Gt = TEMPO DI CORREZIONE  #   
 2778                                 ;##################################
 2779  0EBB           CORREZIONE_TIRO:                
 2780  0EBB 3A8CD0                    LD      A,(TIRGUA)              ;SE ZERO 
 2781  0EBE FE00                      CP      00H                     ;SALTO
 2782  0EC0 CA940F                    JP      Z,CORREZIONE_TIRO_FINE        
 2783                 
 2784  0EC3 ED5B50C3                  LD      DE,(ERATTU)     
 2785  0EC7 3A8CD0                    LD      A,(TIRGUA)       
 2786  0ECA ED530CC0                  LD      (MOLT24),DE     
 2787  0ECE 320EC0                    LD      (MOLP24),A      
 2788  0ED1 CDAD14                    CALL    MOL24           
 2789  0ED4 ED4B10C0                  LD      BC,(PROD24)
 2790  0ED8 3A12C0                    LD      A,(PROD24+02H)
 2791  0EDB FE00                      CP      00H
 2792  0EDD 2802                      JR      Z,CORREZIONE_TIRO_1     ;BC = ERRORE    
 2793  0EDF 06FF                      LD      B,0FFH                  ;EXTRA CORR.
 2794                 
 2795  0EE1           CORREZIONE_TIRO_1:         
 2796  0EE1 21000B                    LD      HL,0B00H                ;SE SUPERA
 2797  0EE4 ED42                      SBC     HL,BC                   ;QUESTO VALORE
 2798  0EE6 3004                      JR      NC,CORREZIONE_TIRO_2    ;IMPONGO UN
 2799  0EE8 3F                        CCF                             ;VALORE FISSO
 2800  0EE9 01000B                    LD      BC,0B00H                ;PER NON FAR
 2801  0EEC           CORREZIONE_TIRO_2:         
 2802  0EEC ED432EC3                  LD      (TMEM5),BC              ;MUOVERE TANTO
 2803  0EF0 78                        LD      A,B                     ;IL MOTOPOTENZIOMETRO
 2804  0EF1 B1                        OR      C
 2805  0EF2 CAA60F                    JP      Z,CORREZIONE_TIRO_RESET        
 2806                 
 2807                 
 2808                 
 2809                                 ;ROUTINE DI CORREZIONE TIRO
 2810                 
 2811  0EF5 3A98D0                    LD      A,(AUMATI)              ;SE IN MANUALE
 2812  0EF8 FE00                      CP      00H                     ;TIRO SALTA 
 2813  0EFA CA940F                    JP      Z,CORREZIONE_TIRO_FINE
 2814                 
 2815  0EFD 3A2CC3                    LD      A,(TMEM4)      
 2816  0F00 FE00                      CP      00H
 2817  0F02 CA940F                    JP      Z,CORREZIONE_TIRO_FINE        
 2818                 
 2819  0F05 3A30C3                    LD      A,(TMEM6)       
 2820  0F08 FE00                      CP      00H
 2821  0F0A CA940F                    JP      Z,CORREZIONE_TIRO_FINE
 2822  0F0D FE01                      CP      01H
 2823  0F0F CA1A0F                    JP      Z,CORREZIONE_TIRO_DEC        
 2824  0F12 FE02                      CP      02H
 2825  0F14 CA570F                    JP      Z,CORREZIONE_TIRO_INC        
 2826  0F17 C3940F                    JP      CORREZIONE_TIRO_FINE
 2827                 
 2828  0F1A           CORREZIONE_TIRO_DEC:                  
 2829  0F1A 3A8CD0                    LD      A,(TIRGUA)              ;SE GUATRA >  DI 100 LA
 2830  0F1D FE65                      CP      65H                     ;CORREZIONE
 2831  0F1F 3816                      JR      C,CORREZIONE_TIRO_DEC_1 
 2832  0F21 DE64                      SBC     A,64H                   ;DIVENTA FISSA
 2833  0F23 010000                    LD      BC,0000H                ;UNA UNITA'
 2834  0F26 ED432EC3                  LD      (TMEM5),BC              ;DELLA SOTTRAZIONE
 2835  0F2A 322EC3                    LD      (TMEM5),A               ;E' UGUALE A 1mS
 2836  0F2D 3EB7                      LD      A,0B7H                
 2837  0F2F D373                      OUT     (73H),A         
 2838  0F31 3E10                      LD      A,10H           
 2839  0F33 D373                      OUT     (73H),A          
 2840  0F35 1809                      JR      CORREZIONE_TIRO_DEC_2
 2841  0F37           CORREZIONE_TIRO_DEC_1:         
 2842  0F37 3F                        CCF                     
 2843  0F38 3EB7                      LD      A,0B7H                  ;CON ERORE 0.1mmm      
 2844  0F3A D373                      OUT     (73H),A                 ;E TIMER = 10
 2845  0F3C 3E02                      LD      A,02H                   ;TEMPO DI  ZZZ
 2846  0F3E D373                      OUT     (73H),A                 ;CORREZ. = 30mS  
 2847  0F40           CORREZIONE_TIRO_DEC_2:         
 2848                 
 2849  0F40 3A9CC0                    LD      A,(MEMC)                ;DIMINUZIONE
 2850  0F43 CBBF                      RES     B_PC_SINISTRA,A         ;TIRO
 2851  0F45 CBF7                      SET     B_PC_DESTRA,A
 2852  0F47 329CC0                    LD      (MEMC),A
 2853  0F4A D363                      OUT     (PC),A
 2854                 
 2855                                 ;DECREMENTA BASE DAC
 2856  0F4C 2AACD0                    LD      HL,(DACDELTATIR)
 2857  0F4F 227EC3                    LD      (DAC_INCREM_BASE),HL
 2858  0F52 CDFE1C                    CALL    DAC_INCR_DECR_BASE
 2859                 
 2860  0F55 183D                      JR      CORREZIONE_TIRO_FINE  
 2861                 
 2862                 
 2863                 
 2864  0F57           CORREZIONE_TIRO_INC:                   
 2865  0F57 3A8CD0                    LD      A,(TIRGUA)              ;VEDI SOPRA 
 2866  0F5A FE65                      CP      65H
 2867  0F5C 3816                      JR      C,CORREZIONE_TIRO_INC_1
 2868  0F5E DE64                      SBC     A,64H
 2869  0F60 010000                    LD      BC,0000H
 2870  0F63 ED432EC3                  LD      (TMEM5),BC
 2871  0F67 322EC3                    LD      (TMEM5),A
 2872  0F6A 3EB7                      LD      A,0B7H                
 2873  0F6C D373                      OUT     (73H),A         
 2874  0F6E 3E10                      LD      A,10H           
 2875  0F70 D373                      OUT     (73H),A          
 2876  0F72 1809                      JR      CORREZIONE_TIRO_INC_2
 2877  0F74           CORREZIONE_TIRO_INC_1:         
 2878  0F74 3F                        CCF
 2879  0F75 3EB7                      LD      A,0B7H                  ;CON ERRORE 0.1mmm      
 2880  0F77 D373                      OUT     (73H),A                 ;E TIMER = 10
 2881  0F79 3E02                      LD      A,02H                   ;TEMPO DI  
 2882  0F7B D373                      OUT     (73H),A                 ;CORREZ. = 30mS 
 2883                 
 2884  0F7D           CORREZIONE_TIRO_INC_2:        
 2885  0F7D 3A9CC0                    LD      A,(MEMC)                ;AUMENTO
 2886  0F80 CBB7                      RES     B_PC_DESTRA,A           ;TIRO
 2887  0F82 CBFF                      SET     B_PC_SINISTRA,A
 2888  0F84 329CC0                    LD      (MEMC),A
 2889  0F87 D363                      OUT     (PC),A
 2890                 
 2891                                 ;INCREMENTA BASE DAC
 2892  0F89 2AACD0                    LD      HL,(DACDELTATIR)
 2893  0F8C 2280C3                    LD      (DAC_DECREM_BASE),HL
 2894  0F8F CDFE1C                    CALL    DAC_INCR_DECR_BASE
 2895                 
 2896                 
 2897  0F92 1800                      JR      CORREZIONE_TIRO_FINE
 2898                 
 2899  0F94           CORREZIONE_TIRO_FINE:         
 2900  0F94 3E00                      LD      A,00H           
 2901  0F96 3230C3                    LD      (TMEM6),A
 2902                                 
 2903  0F99 3A8ED0                    LD      A,(TIRCIC)      ;RIPRISTINO
 2904  0F9C 321EC3                    LD      (TIRCIR_ATT),A      ;I VALORI 
 2905  0F9F 324CC3                    LD      (INCREM),A      ;NORMALI
 2906  0FA2 324EC3                    LD      (DECREM),A
 2907  0FA5 C9                        RET
 2908                                       
 2909  0FA6           CORREZIONE_TIRO_RESET:         
 2910  0FA6 3A9CC0                    LD      A,(MEMC)        ;QUANDO L'ERRORE 
 2911  0FA9 CBB7                      RES     B_PC_DESTRA,A   ;E' A ZERO
 2912  0FAB CBBF                      RES     B_PC_SINISTRA,A ;SI ANNULLA 
 2913  0FAD 329CC0                    LD      (MEMC),A        ;TUTTO PER
 2914  0FB0 D363                      OUT     (PC),A          ;EVITARE CHE
 2915  0FB2 3E43                      LD      A,43H           ;CHE AVVENGANO
 2916  0FB4 D373                      OUT     (73H),A         ;CORREZIONI
 2917  0FB6 3E00                      LD      A,00H           ;INDESIDERATE
 2918  0FB8 322CC3                    LD      (TMEM4),A       ;COME A KRAPINA
 2919  0FBB C9                        RET
 2920                 
 2921                 
 2922                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2923                 ;               RIEMPIO TABELLA ERRORE MEDIO PER CORREZIONE LONG CON 
 2924                 ;               IL VALORE DI ERATTU E MSCORR
 2925                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2926  0FBC           RESET_MEDIA:
 2927  0FBC ED5B50C3                  LD      DE,(ERATTU)      
 2928  0FC0 ED4BD426                  LD      BC,(MLUNGHEZZA)
 2929  0FC4 DD2100C1                  LD      IX,ARR_ERRAVA
 2930  0FC8 DD09                      ADD     IX,BC
 2931  0FCA DD09                      ADD     IX,BC
 2932  0FCC DD2B                      DEC     IX
 2933  0FCE DD2B                      DEC     IX
 2934                 
 2935  0FD0 FD2160C1                  LD      IY,ARR_ERRRIT
 2936  0FD4 FD09                      ADD     IY,BC
 2937  0FD6 FD09                      ADD     IY,BC
 2938  0FD8 FD2B                      DEC     IY
 2939  0FDA FD2B                      DEC     IY
 2940                 
 2941  0FDC 41                        LD      B,C
 2942                 
 2943  0FDD 3A38C3                    LD      A,(MSCORR)       
 2944  0FE0 FE01                      CP      D_AVANTI              
 2945  0FE2 281A                      JR      Z,RESET_MEDIA_02
 2946                 
 2947  0FE4           RESET_MEDIA_01:
 2948                 
 2949  0FE4 DD7300                    LD      (IX+00H),E
 2950  0FE7 DD7201                    LD      (IX+01H),D
 2951  0FEA DD2B                      DEC     IX
 2952  0FEC DD2B                      DEC     IX
 2953  0FEE FD360000                  LD      (IY+00H),00H
 2954  0FF2 FD360100                  LD      (IY+01H),00H
 2955  0FF6 FD2B                      DEC     IY
 2956  0FF8 FD2B                      DEC     IY
 2957  0FFA 10E8                      DJNZ    RESET_MEDIA_01
 2958                 
 2959  0FFC 1818                      JR      RESET_MEDIA_FINE
 2960                 
 2961  0FFE           RESET_MEDIA_02:         
 2962  0FFE DD360000                  LD      (IX+00H),00H
 2963  1002 DD360100                  LD      (IX+01H),00H
 2964  1006 DD2B                      DEC     IX
 2965  1008 DD2B                      DEC     IX
 2966  100A FD7300                    LD      (IY+00H),E
 2967  100D FD7201                    LD      (IY+01H),D
 2968  1010 FD2B                      DEC     IY
 2969  1012 FD2B                      DEC     IY
 2970  1014 10E8                      DJNZ    RESET_MEDIA_02
 2971                 
 2972  1016           RESET_MEDIA_FINE:
 2973  1016 3A38C3                    LD      A,(MSCORR)      ;FORZO SEGNO CORRENTE COME 
 2974  1019 3258C3                    LD      (ERMEDI_SIGN),A ;SEGNO DELLA MEDIA      
 2975  101C ED4B50C3                  LD      BC,(ERATTU)     ;FORZO ERRORE CORRENTE
 2976  1020 ED4352C3                  LD      (ERPREC),BC     ;COME ERRORE MEDIATO
 2977  1024 ED4354C3                  LD      (ERMEDI),BC     ;ED ERRORE PRECEDENTE
 2978  1028 C9                        RET
 2979                 
 2980                 
 2981                 
 2982                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2983                 ;               CALCOLO ERRORE MEDIO PER CORREZIONE LONG
 2984                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 2985                 
 2986  1029           LMEDIA:
 2987                 
 2988                 ;               LD      BC,(ERATTU)
 2989                 ;               LD      (ERMEDI),BC
 2990                 ;               LD      BC,(MSCORR)
 2991                 ;               LD      (ERMEDI_SIGN),BC
 2992                 ;               RET
 2993                 
 2994                 
 2995                 
 2996  1029 3A5EC3                    LD      A,(PRIMOB)      
 2997  102C 47                        LD      B,A
 2998                                 
 2999  102D DD2100C1                  LD      IX,ARR_ERRAVA       ;SU SEDICI
 3000  1031 ED5B62C3                  LD      DE,(VALORX)
 3001  1035 DD19                      ADD     IX,DE
 3002  1037           LMED01:
 3003  1037 DD5E00                    LD      E,(IX)          ;DATI LETTI
 3004  103A DD5601                    LD      D,(IX+01H)      ;INSERENDO
 3005  103D DD7302                    LD      (IX+02H),E      ;IL NUOVO
 3006  1040 DD7203                    LD      (IX+03H),D      ;ERRORE AL
 3007  1043 DD2B                      DEC     IX              ;PRIMO POSTO
 3008  1045 DD2B                      DEC     IX              ;ED ELIMINANDO
 3009  1047 10EE                      DJNZ    LMED01          ;L'ULTIMO
 3010  1049 DD23                      INC     IX
 3011  104B DD23                      INC     IX
 3012                 
 3013                 
 3014  104D 3A5EC3                    LD      A,(PRIMOB)      ; LD      B,2FH           ;
 3015  1050 47                        LD      B,A             ;
 3016  1051 FD2160C1                  LD      IY,ARR_ERRRIT       ;+5CH   ;DMED1C       
 3017  1055 ED5B62C3                  LD      DE,(VALORX)     ;
 3018  1059 FD19                      ADD     IY,DE           ;
 3019  105B           LMED02:
 3020  105B FD5E00                    LD      E,(IY)          ;RIPETE QUELLO
 3021  105E FD5601                    LD      D,(IY+01H)      ;VISTO SOPRA
 3022  1061 FD7302                    LD      (IY+02H),E      ;CON ALTRE  
 3023  1064 FD7203                    LD      (IY+03H),D      ;16 CELLE
 3024  1067 FD2B                      DEC     IY
 3025  1069 FD2B                      DEC     IY
 3026  106B 10EE                      DJNZ    LMED02
 3027  106D FD23                      INC     IY
 3028  106F FD23                      INC     IY
 3029                 
 3030                 
 3031  1071 ED5B50C3                  LD      DE,(ERATTU)      ;INSERIMENTO
 3032  1075 010000                    LD      BC,0000H         ;NUOVO ERRORE
 3033  1078 3A38C3                    LD      A,(MSCORR)       ;NELLA PRIMA
 3034  107B FE01                      CP      D_AVANTI         ;DELLE 16 CELLE
 3035  107D 280A                      JR      Z,LMED04
 3036  107F           LMED03:
 3037  107F ED5300C1                  LD      (ARR_ERRAVA),DE
 3038  1083 ED4360C1                  LD      (ARR_ERRRIT),BC
 3039  1087 1808                      JR      LMED05
 3040  1089           LMED04:         
 3041  1089 ED4300C1                  LD      (ARR_ERRAVA),BC
 3042  108D ED5360C1                  LD      (ARR_ERRRIT),DE
 3043  1091           LMED05:
 3044  1091 3A60C3                    LD      A,(SECONB)
 3045  1094 47                        LD      B,A             ;SOMMA DELLE  16 celle reali
 3046  1095 3001                      JR      NC,LMED06       ;48 CELLE 16 CELLE
 3047  1097 3F                        CCF                      ; 
 3048  1098 210000    LMED06:         LD      HL,0000H
 3049  109B           LMED07:
 3050  109B DD5E00                    LD      E,(IX+00H)
 3051  109E DD5601                    LD      D,(IX+01H)
 3052  10A1 ED5A                      ADC     HL,DE
 3053  10A3 DD23                      INC     IX
 3054  10A5 DD23                      INC     IX
 3055  10A7 10F2                      DJNZ    LMED07
 3056  10A9 225AC3                    LD      (SOMLO1),HL
 3057                 
 3058  10AC 3A60C3                    LD      A,(SECONB)      ;
 3059  10AF 47                        LD      B,A             ;SOMMA DELLE  16 celle reali 
 3060  10B0 3001                      JR      NC,LMED08        ;48 CELLE 16 CELLE   
 3061  10B2 3F                        CCF
 3062  10B3 210000    LMED08:         LD      HL,0000H
 3063  10B6           LMED09:
 3064  10B6 FD5E00                    LD      E,(IY+00H)
 3065  10B9 FD5601                    LD      D,(IY+01H)
 3066  10BC ED5A                      ADC     HL,DE
 3067  10BE FD23                      INC     IY
 3068  10C0 FD23                      INC     IY
 3069  10C2 10F2                      DJNZ    LMED09
 3070  10C4 225CC3                    LD      (SOMLO2),HL
 3071                 
 3072  10C7 2A5CC3                    LD      HL,(SOMLO2)
 3073  10CA ED5B5AC3                  LD      DE,(SOMLO1)
 3074  10CE ED52                      SBC     HL,DE
 3075  10D0 3807                      JR      C,LMED10        ;SEGNO ERRORE
 3076  10D2 3E01                      LD      A,D_AVANTI      ;POSITIVO
 3077  10D4 3258C3                    LD      (ERMEDI_SIGN),A
 3078  10D7 180D                      JR      LMED11 
 3079                 
 3080  10D9 3F        LMED10:         CCF
 3081  10DA 3E08                      LD      A,D_RITARDO     ;NEGATIVO
 3082  10DC 3258C3                    LD      (ERMEDI_SIGN),A
 3083                                 
 3084  10DF EB                        EX      DE,HL
 3085  10E0 ED5B5CC3                  LD      DE,(SOMLO2)
 3086  10E4 ED52                      SBC     HL,DE
 3087                 
 3088  10E6 2200C0    LMED11:         LD      (DIVDEN),HL
 3089  10E9 ED4B60C3                  LD      BC,(SECONB)     ;DIVISIONE    
 3090  10ED 0600                      LD      B,00H           ;
 3091  10EF ED4302C0                  LD      (DIVSOR),BC     ;PER XX 
 3092  10F3 CD6514                    CALL    DIVIS
 3093  10F6 2A04C0                    LD      HL,(QUOZIE)
 3094  10F9 2254C3                    LD      (ERMEDI),HL
 3095                 
 3096  10FC C9                        RET
 3097                 
 3098                             
 3099                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3100                 ;               SET GUADS1 SU AMPLIFICATORE OPERAZIONALE
 3101                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3102                 
 3103  10FD           SET_GUAD_S1:
 3104  10FD D9                        EXX
 3105  10FE 3A3CD0                    LD      A,(GUADS1)      ;SETTO GUADAGNO DI S1
 3106  1101 47                        LD      B,A             
 3107  1102 3A9AC0                    LD      A,(MEMA)        
 3108  1105 CBAF                      RES     5,A
 3109  1107 CBB7                      RES     6,A
 3110  1109 80                        ADD     A,B
 3111  110A 329AC0                    LD      (MEMA),A
 3112  110D D300                      OUT     (PA),A     
 3113                 
 3114  110F           SET_GUAD_S1_FINE:
 3115  110F D9                        EXX
 3116  1110 C9                        RET;
 3117                 
 3118                 
 3119                 
 3120                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3121                 ;               ASPETTA UN IMPULSO DI ENCODER E METTE IN A PB
 3122                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3123                 
 3124  1111           WAIT_ENCODER:      
 3125  1111 DB01                      IN      A,(PB)                
 3126  1113 CB67                      BIT     4,A             ;SE ENCODER = 0 ASPETTA
 3127  1115 28FA                      JR      Z,WAIT_ENCODER
 3128  1117           WAIT_ENCODER_01:      
 3129  1117 DB01                      IN      A,(PB)          ;SE ENCODER = 1 ASPETTA
 3130  1119 CB67                      BIT     4,A
 3131  111B 20FA                      JR      NZ,WAIT_ENCODER_01
 3132                                 ;LD     (MEMB),A
 3133  111D           WAIT_ENCODER_FINE:
 3134  111D CB57                      BIT     2,A             ; Z SE BIANCA
 3135                                                         ;NZ SE NERA
 3136  111F C9                        RET     
 3137                 
 3138                 
 3139                 
 3140                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3141                 ;               CALCOLO CODICE BIANCO E CODICE NERO
 3142                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3143  1120           CAL_CODICE:
 3144                                 ;RESET VALORI DIVISIONE E MOLTIPLICAZIONE 32BIT
 3145  1120 010000                    LD      BC,0000H
 3146  1123 ED4384C0                  LD      (DIV32_DIVID_H),BC
 3147  1127 ED4382C0                  LD      (DIV32_DIVID_L),BC
 3148  112B ED4388C0                  LD      (DIV32_DIVIS_H),BC
 3149  112F ED4386C0                  LD      (DIV32_DIVIS_L),BC
 3150  1133 ED438CC0                  LD      (DIV32_QUOZ_H),BC
 3151  1137 ED438AC0                  LD      (DIV32_QUOZ_L),BC
 3152                 
 3153  113B ED4332C0                  LD      (MDO032),BC     
 3154  113F ED4334C0                  LD      (MDO232),BC     
 3155  1143 ED4336C0                  LD      (MRE032),BC     
 3156  1147 ED4338C0                  LD      (MRE232),BC     
 3157  114B ED433AC0                  LD      (PTO032),BC
 3158  114F ED433CC0                  LD      (PTO232),BC
 3159                                 
 3160                                 
 3161  1153           CAL_CODICE_NERO:
 3162                                 ;CODICE_NERO = (4096/CILIN) * 0.5 = 2048/CILIN
 3163  1153 010008                    LD      BC,0800H        
 3164  1156 ED4382C0                  LD      (DIV32_DIVID_L),BC
 3165  115A ED4B28D0                  LD      BC,(CILIN)      
 3166  115E ED4386C0                  LD      (DIV32_DIVIS_L),BC
 3167  1162 CD2217                    CALL    DIV32
 3168  1165 ED4B8AC0                  LD      BC,(DIV32_QUOZ_L)
 3169  1169 ED4370C3                  LD      (CODICE_NERO),BC
 3170                 
 3171                 
 3172                 
 3173  116D           CAL_CODICE_BIANCO:
 3174  116D 3ABED0                    LD      A,(F4_DIMENSION)
 3175  1170 FE00                      CP      00H
 3176  1172 2811                      JR      Z,CAL_CODICE_BIANCO_GATE
 3177                                 
 3178  1174           CAL_CODICE_BIANCO_DIMENSION:
 3179                                 ;CODICE_BIANCO = (4096/CILIN) * F4_DIMENSION    = (4096 * F4_DIMENSION) / CILIN
 3180  1174 010010                    LD      BC,1000H
 3181  1177 ED4332C0                  LD      (MDO032),BC
 3182                 
 3183  117B ED4BBED0                  LD      BC,(F4_DIMENSION)
 3184  117F ED4336C0                  LD      (MRE032),BC
 3185                 
 3186  1183 1811                      JR      CAL_CODICE_BIANCO_BOTH
 3187                 
 3188  1185           CAL_CODICE_BIANCO_GATE:
 3189                                 ;CODICE_BIANCO = (4096/CILIN) * (GATE/2)        = (2048 * GATE) / CILIN
 3190  1185 010008                    LD      BC,0800H
 3191  1188 ED4332C0                  LD      (MDO032),BC
 3192                 
 3193  118C ED4B68D0                  LD      BC,(AMPGA)
 3194  1190 ED4336C0                  LD      (MRE032),BC
 3195                 
 3196  1194 1800                      JR      CAL_CODICE_BIANCO_BOTH
 3197                                 
 3198  1196           CAL_CODICE_BIANCO_BOTH:
 3199  1196 CD9815                    CALL    MOL32
 3200  1199 ED4B3AC0                  LD      BC,(PTO032)
 3201  119D ED4382C0                  LD      (DIV32_DIVID_L),BC
 3202                 
 3203  11A1 ED4B3CC0                  LD      BC,(PTO232)
 3204  11A5 ED4384C0                  LD      (DIV32_DIVID_H),BC
 3205                 
 3206  11A9 ED4B28D0                  LD      BC,(CILIN)      
 3207  11AD ED4386C0                  LD      (DIV32_DIVIS_L),BC
 3208                 
 3209  11B1 CD2217                    CALL    DIV32
 3210                 
 3211  11B4 ED4B8AC0                  LD      BC,(DIV32_QUOZ_L)
 3212  11B8 ED436EC3                  LD      (CODICE_BIANCO),BC
 3213                 
 3214  11BC           CAL_CODICE_FINE:
 3215  11BC C9                        RET
 3216                 
 3217                 
 3218                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3219                 ;               RICONOSCIMENTO CODICE
 3220                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3221                 
 3222  11BD           CODICE:
 3223  11BD CDFD10                    CALL    SET_GUAD_S1
 3224                 
 3225  11C0 3ABED0                    LD      A,(F4_DIMENSION)        ;SE F4_DIMENSION = 600 (MASSIMO VALORE CONSENTITO)
 3226  11C3 FE58                      CP      58H                     ;USO LA RICERCA EASY (PRIMO SEGNO NERO VISIBILE)
 3227  11C5 200D                      JR      NZ, CODICE_WAIT_B
 3228                 
 3229  11C7 3ABFD0                    LD      A,(F4_DIMENSION+01H)
 3230  11CA FE02                      CP      02H     
 3231  11CC 2006                      JR      NZ, CODICE_WAIT_B
 3232                                 
 3233  11CE CD6812                    CALL    CODICE_EASY
 3234                 
 3235  11D1 C36712                    JP      CODICE_FINE
 3236                 
 3237                 
 3238                 
 3239  11D4           CODICE_WAIT_B:                                  ;ATTENDO IL PRIMO SEGNO BIANCO
 3240  11D4 DB01                      IN      A,(PB)          
 3241  11D6 CB57                      BIT     2,A             
 3242  11D8 28FA                      JR      Z,CODICE_WAIT_B         
 3243                 
 3244                 
 3245  11DA           CODICE_N1:                                      ;ATTENDO IL PRIMO SEGNO NERO
 3246  11DA DB01                      IN      A,(PB)          
 3247  11DC CB57                      BIT     2,A             
 3248  11DE 20FA                      JR      NZ,CODICE_N1
 3249                 
 3250  11E0 DB10                      IN      A,(10H)                 ;VALORE ENCODER ATTUALE
 3251  11E2 4F                        LD      C,A
 3252  11E3 DB20                      IN      A,(20H)
 3253  11E5 47                        LD      B,A     
 3254  11E6 ED4372C3                  LD      (CODICE_ENC_N1),BC
 3255                 
 3256  11EA           CODICE_B1:                                      ;ASPETTA MENTRE LEGGE BIANCO
 3257  11EA DB01                      IN      A,(PB)          
 3258  11EC CB57                      BIT     2,A             
 3259  11EE 28FA                      JR      Z,CODICE_B1
 3260                 
 3261  11F0 DB10                      IN      A,(10H)                 ;VALORE ENCODER ATTUALE
 3262  11F2 6F                        LD      L,A
 3263  11F3 DB20                      IN      A,(20H)
 3264  11F5 67                        LD      H,A     
 3265  11F6 2274C3                    LD      (CODICE_ENC_B1),HL
 3266                 
 3267  11F9 110010                    LD      DE,1000H                ;HL = MOD(4096+HL-BC, 4096) 
 3268  11FC 19                        ADD     HL,DE
 3269  11FD A7                        AND     A
 3270  11FE ED42                      SBC     HL,BC
 3271                 
 3272  1200 7C                        LD      A,H             
 3273  1201 E60F                      AND     0FH
 3274  1203 67                        LD      H,A
 3275                                                                 
 3276  1204 A7                        AND     A                       ;RESET CARRY
 3277  1205 ED4B6EC3                  LD      BC,(CODICE_BIANCO)
 3278  1209 ED42                      SBC     HL,BC                   
 3279  120B ED4B74C3                  LD      BC,(CODICE_ENC_B1)      ;AGGIORNO IL VALORE PRECEDENTE
 3280  120F 38C9                      JR      C,CODICE_N1             ;HL<CODICE_BIANCO
 3281                 
 3282                 
 3283                 
 3284  1211           CODICE_N2:                                      ;ASPETTA MENTRE LEGGE NERO
 3285  1211 DB01                      IN      A,(PB)          
 3286  1213 CB57                      BIT     2,A             
 3287  1215 20FA                      JR      NZ,CODICE_N2
 3288                 
 3289  1217 DB10                      IN      A,(10H)                 ;VALORE ENCODER ATTUALE
 3290  1219 6F                        LD      L,A
 3291  121A DB20                      IN      A,(20H)
 3292  121C 67                        LD      H,A     
 3293  121D 2276C3                    LD      (CODICE_ENC_N2),HL
 3294                 
 3295  1220 110010                    LD      DE,1000H                ;HL = MOD(4096+HL-BC, 4096) 
 3296  1223 19                        ADD     HL,DE
 3297  1224 A7                        AND     A
 3298  1225 ED42                      SBC     HL,BC
 3299                 
 3300  1227 7C                        LD      A,H             
 3301  1228 E60F                      AND     0FH
 3302  122A 67                        LD      H,A
 3303                 
 3304  122B A7                        AND     A                       ;RESET CARRY
 3305  122C ED4B70C3                  LD      BC,(CODICE_NERO)
 3306  1230 ED42                      SBC     HL,BC                   
 3307  1232 ED4B76C3                  LD      BC,(CODICE_ENC_N2)      ;AGGIORNO IL VALORE PRECEDENTE
 3308  1236 3006                      JR      NC,CODICE_B2            ;HL>=CODICE_NERO
 3309                 
 3310  1238 ED4372C3                  LD      (CODICE_ENC_N1),BC
 3311  123C 18AC                      JR      CODICE_B1
 3312                 
 3313                 
 3314  123E           CODICE_B2:                                      ;ASPETTA MENTRE LEGGE BIANCO
 3315  123E DB01                      IN      A,(PB)          
 3316  1240 CB57                      BIT     2,A             
 3317  1242 28FA                      JR      Z,CODICE_B2
 3318                 
 3319  1244 DB10                      IN      A,(10H)                 ;VALORE ENCODER ATTUALE
 3320  1246 6F                        LD      L,A
 3321  1247 DB20                      IN      A,(20H)
 3322  1249 67                        LD      H,A     
 3323  124A 2278C3                    LD      (CODICE_ENC_B2),HL
 3324                 
 3325  124D 110010                    LD      DE,1000H                ;HL = MOD(4096+HL-BC, 4096) 
 3326  1250 19                        ADD     HL,DE
 3327  1251 A7                        AND     A
 3328  1252 ED42                      SBC     HL,BC
 3329                 
 3330  1254 7C                        LD      A,H             
 3331  1255 E60F                      AND     0FH
 3332  1257 67                        LD      H,A
 3333                                                                 
 3334  1258 A7                        AND     A                       ;RESET CARRY
 3335  1259 ED4B6EC3                  LD      BC,(CODICE_BIANCO)
 3336  125D ED42                      SBC     HL,BC                   
 3337  125F ED4B78C3                  LD      BC,(CODICE_ENC_B2)      ;AGGIORNO IL VALORE PRECEDENTE
 3338  1263 DADA11                    JP      C,CODICE_N1             ;HL<CODICE_BIANCO
 3339                 
 3340                 
 3341                                 ;TROVATO SEGNO
 3342  1266 A7                        AND     A               ;RESET CARRY
 3343                 
 3344  1267           CODICE_FINE:
 3345  1267 C9                        RET
 3346                 
 3347                 
 3348                 
 3349                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3350                 ;               RICONOSCIMENTO CODICE_EASY
 3351                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3352                 
 3353  1268           CODICE_EASY:
 3354                 
 3355                 
 3356  1268           CODICE_EASY_WAIT_B:                             ;ATTENDO IL PRIMO SEGNO BIANCO
 3357  1268 DB01                      IN      A,(PB)          
 3358  126A CB57                      BIT     2,A             
 3359  126C 28FA                      JR      Z,CODICE_EASY_WAIT_B            
 3360                 
 3361                 
 3362  126E           CODICE_EASY_N1:                                 ;ATTENDO IL PRIMO SEGNO NERO
 3363  126E DB01                      IN      A,(PB)          
 3364  1270 CB57                      BIT     2,A             
 3365  1272 20FA                      JR      NZ,CODICE_EASY_N1
 3366                 
 3367  1274           CODICE_EASY_B1:                                 ;ASPETTA MENTRE LEGGE BIANCO
 3368  1274 DB01                      IN      A,(PB)          
 3369  1276 CB57                      BIT     2,A             
 3370  1278 28FA                      JR      Z,CODICE_EASY_B1
 3371                 
 3372  127A DB10                      IN      A,(10H)                 ;VALORE ENCODER ATTUALE
 3373  127C 6F                        LD      L,A
 3374  127D DB20                      IN      A,(20H)
 3375  127F 67                        LD      H,A     
 3376  1280 2274C3                    LD      (CODICE_ENC_B1),HL
 3377                 
 3378  1283           CODICE_EASY_FINE:
 3379  1283 C9                        RET
 3380                 
 3381                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3382                 ;               SUBROUTINE DI RITARDO
 3383                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3384                 
 3385  1284 DB01      RIT:            IN      A,(PB)
 3386  1286 CB67                      BIT     4,A
 3387  1288 28FA                      JR      Z,RIT
 3388  128A DB01      RIT1:           IN      A,(PB)
 3389  128C CB67                      BIT     4,A
 3390  128E 20FA                      JR      NZ,RIT1
 3391  1290 1D                        DEC     E
 3392  1291 20F1                      JR      NZ,RIT
 3393  1293 C9                        RET
 3394                 
 3395                 
 3396                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3397                 ;               SUBROUTINE DI CONTROLLO CODICE
 3398                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3399                 
 3400  1294 3A30D0    MARC:           LD      A,(SEGNO)       ;MISURA 2mm IN      
 3401  1297 47                        LD      B,A             ;MODO CHE IN
 3402  1298 DB01      MAR1:           IN      A,(PB)          ;QUESTO SPAZIO
 3403  129A CB57                      BIT     2,A             ;PASSI IL SEGNO
 3404  129C 2011                      JR      NZ,RIT0         ;DI CODICE
 3405  129E CB67                      BIT     4,A
 3406  12A0 28F6                      JR      Z,MAR1
 3407  12A2 DB01      MAR2:           IN      A,(PB)
 3408  12A4 CB57                      BIT     2,A
 3409  12A6 2007                      JR      NZ,RIT0
 3410  12A8 CB67                      BIT     4,A
 3411  12AA 20F6                      JR      NZ,MAR2
 3412  12AC 05                        DEC     B
 3413  12AD 20E9                      JR      NZ,MAR1
 3414  12AF C9        RIT0:           RET
 3415                 
 3416                 
 3417                 
 3418                 
 3419                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3420                 ;               ADEGUAMENTO GUADAGNO AMPLIFICAT. ESTERNO
 3421                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3422                  
 3423  12B0 D9        GAINS1:         EXX
 3424  12B1 3A3CD0                    LD      A,(GUADS1)
 3425  12B4 FE60                      CP      60H
 3426  12B6 280C                      JR      Z,GS11
 3427  12B8 FE40                      CP      40H
 3428  12BA 280C                      JR      Z,GS12
 3429  12BC FE20                      CP      20H
 3430  12BE 280C                      JR      Z,GS13
 3431  12C0 FE00                      CP      00H
 3432  12C2 280C                      JR      Z,GS14
 3433  12C4 3E40      GS11:           LD      A,40H
 3434  12C6 180A                      JR      GS15
 3435  12C8 3E20      GS12:           LD      A,20H
 3436  12CA 1806                      JR      GS15
 3437  12CC 3E00      GS13:           LD      A,00H
 3438  12CE 1802                      JR      GS15
 3439  12D0 3E60      GS14:           LD      A,60H
 3440  12D2 323CD0    GS15:           LD      (GUADS1),A
 3441  12D5 D9                        EXX
 3442  12D6 C9                        RET
 3443                 
 3444                 
 3445                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3446                 ;               CONTROLLO PARAMETRI E EVENTUALE
 3447                 ;               INSERIMENTO VALORI DI DEFAULT
 3448                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3449                                 
 3450  12D7 DD2178D0  DEFAUL:         LD      IX,TRIP         
 3451  12DB DD360100                  LD      (IX+01H),00H
 3452  12DF DD7E00                    LD      A,(IX)
 3453  12E2 FE0F                      CP      0FH
 3454  12E4 3002                      JR      NC,DEF1
 3455  12E6 1805                      JR      DEF2
 3456  12E8 3E06      DEF1:           LD      A,06H
 3457  12EA DD7700                    LD      (IX),A
 3458                 
 3459                 
 3460  12ED DD216AD0  DEF2:           LD      IX,GUADA
 3461  12F1 DD360100                  LD      (IX+01H),00H
 3462  12F5 DD7E00                    LD      A,(IX)
 3463  12F8 FE00                      CP      00H
 3464  12FA 2806                      JR      Z,DEF3
 3465  12FC FE64                      CP      64H
 3466  12FE 3002                      JR      NC,DEF3
 3467  1300 1805                      JR      DEF4
 3468  1302 3E0A      DEF3:           LD      A,0AH
 3469  1304 DD7700                    LD      (IX),A
 3470                                 
 3471  1307 DD216CD0  DEF4:           LD      IX,CICLO
 3472  130B DD360100                  LD      (IX+01H),00H
 3473  130F DD7E00                    LD      A,(IX)
 3474  1312 FE00                      CP      00H
 3475  1314 2806                      JR      Z,DEF5
 3476  1316 FE64                      CP      64H
 3477  1318 3002                      JR      NC,DEF5
 3478  131A 1805                      JR      DEF6
 3479  131C 3E03      DEF5:           LD      A,03H
 3480  131E DD7700                    LD      (IX),A
 3481                                 
 3482  1321 DD216ED0  DEF6:           LD      IX,DERIVA
 3483  1325 DD360100                  LD      (IX+01H),00H
 3484  1329 DD7E00                    LD      A,(IX)
 3485  132C FE00                      CP      00H
 3486  132E 2806                      JR      Z,DEF7
 3487  1330 FEFF                      CP      0FFH
 3488  1332 3002                      JR      NC,DEF7
 3489  1334 1805                      JR      DEF8
 3490  1336 3E02      DEF7:           LD      A,02H
 3491  1338 DD7700                    LD      (IX),A
 3492                                 
 3493  133B DD2170D0  DEF8:           LD      IX,ZONA
 3494  133F DD360100                  LD      (IX+01H),00H
 3495  1343 DD7E00                    LD      A,(IX)
 3496  1346 FE00                      CP      00H
 3497  1348 2806                      JR      Z,DEF9
 3498  134A FE65                      CP      65H
 3499  134C 3002                      JR      NC,DEF9
 3500  134E 1805                      JR      DEF10
 3501  1350 3E00      DEF9:           LD      A,00H
 3502  1352 DD7700                    LD      (IX),A
 3503                                 
 3504  1355 DD2172D0  DEF10:          LD      IX,INSER
 3505  1359 DD360100                  LD      (IX+01H),00H
 3506  135D DD7E00                    LD      A,(IX)
 3507  1360 FE00                      CP      00H
 3508  1362 2806                      JR      Z,DEF11
 3509  1364 FEFF                      CP      0FFH            ;PPNN
 3510  1366 3002                      JR      NC,DEF11
 3511  1368 1805                      JR      DEF12
 3512  136A 3E0A      DEF11:          LD      A,0AH
 3513  136C DD7700                    LD      (IX),A
 3514                 
 3515  136F DD2174D0  DEF12:          LD      IX,SALTO
 3516  1373 DD360100                  LD      (IX+01H),00H
 3517  1377 DD7E00                    LD      A,(IX)
 3518  137A FE0A                      CP      0AH
 3519  137C 3002                      JR      NC,DEF13
 3520  137E 1805                      JR      DEF14           
 3521  1380 3E09      DEF13:          LD      A,09H
 3522  1382 DD7700                    LD      (IX),A
 3523                 
 3524                 
 3525                 
 3526  1385 DD2176D0  DEF14:          LD      IX,ZONT
 3527  1389 DD360100                  LD      (IX+01H),00H
 3528  138D DD7E00                    LD      A,(IX)
 3529  1390 FE00                      CP      00H
 3530  1392 2806                      JR      Z,DEF15
 3531  1394 FE65                      CP      65H
 3532  1396 3002                      JR      NC,DEF15
 3533  1398 1805                      JR      DEF16
 3534  139A 3E00      DEF15:          LD      A,00H
 3535  139C DD7700                    LD      (IX),A
 3536                 
 3537  139F DD21B8D0  DEF16:          LD      IX,LINGUA
 3538  13A3 DD360100                  LD      (IX+01H),00H
 3539  13A7 DD7E00                    LD      A,(IX)
 3540  13AA FEFF                      CP      0FFH            
 3541  13AC 2806                      JR      Z,DEF17
 3542  13AE FE06                      CP      06H
 3543  13B0 3002                      JR      NC,DEF17
 3544  13B2 1805                      JR      DEF18
 3545  13B4 3E01      DEF17:          LD      A,01H
 3546  13B6 DD7700                    LD      (IX),A
 3547                 
 3548                                 ;AAOO ELIMINATO OSGAIN
 3549                 
 3550  13B9 3A3CD0    DEF18:          LD      A,(GUADS1)      ;SE IN PARTENZA
 3551  13BC FE00                      CP      00H             ;NON C'E UN
 3552  13BE 2810                      JR      Z,DEF19         ;VALORE NORMALE
 3553  13C0 FE20                      CP      20H             ;CREA CASINO 
 3554  13C2 280C                      JR      Z,DEF19         ;IN SERITA.
 3555  13C4 FE40                      CP      40H
 3556  13C6 2808                      JR      Z,DEF19
 3557  13C8 3E60                      LD      A,60H
 3558  13CA 323CD0                    LD      (GUADS1),A
 3559  13CD CDFD10                    CALL    SET_GUAD_S1
 3560                 
 3561                 
 3562  13D0 019F00    DEF19:          LD      BC,VERSIONE_PROGRAMMA   ;CARICO LA VERSIONE DEL PROGRAMMA
 3563  13D3 ED4300D0                  LD      (VERPRO),BC
 3564                 
 3565  13D7           DEF20:          
 3566  13D7 3A95D0                    LD      A,(AUMALO+01H)
 3567  13DA FEFF                      CP      0FFH
 3568  13DC 2008                      JR      NZ,DEF21
 3569  13DE 3E00                      LD      A,00H
 3570  13E0 3294D0                    LD      (AUMALO),A
 3571  13E3 3295D0                    LD      (AUMALO+01H),A
 3572  13E6           DEF21:          
 3573  13E6 3A97D0                    LD      A,(AUMATR+01H)
 3574  13E9 FEFF                      CP      0FFH
 3575  13EB 2008                      JR      NZ,DEF22
 3576  13ED 3E00                      LD      A,00H
 3577  13EF 3296D0                    LD      (AUMATR),A
 3578  13F2 3297D0                    LD      (AUMATR+01H),A
 3579  13F5           DEF22:          
 3580  13F5 3A99D0                    LD      A,(AUMATI+01H)
 3581  13F8 FEFF                      CP      0FFH
 3582  13FA 2008                      JR      NZ,DEF23
 3583  13FC 3E00                      LD      A,00H
 3584  13FE 3298D0                    LD      (AUMATI),A
 3585  1401 3299D0                    LD      (AUMATI+01H),A
 3586                 
 3587  1404           DEF23:          
 3588  1404 2A0CD0                    LD      HL,(FASE)       ;SE POSIZIONE FASE > 4096 (IMPULSI ENCODER)
 3589  1407 110010                    LD      DE,1000H        ;RESET DEL VALORE
 3590  140A ED52                      SBC     HL,DE         
 3591  140C 3807                      JR      C,DEF24 
 3592  140E 010001                    LD      BC,100H
 3593  1411 ED430CD0                  LD      (FASE),BC
 3594  1415           DEF24:          
 3595  1415 2A0ED0                    LD      HL,(FASES1)     ;SE POSIZIONE S1 > 4096 (IMPULSI ENCODER)
 3596  1418 110010                    LD      DE,1000H        ;RESET DEL VALORE
 3597  141B ED52                      SBC     HL,DE         
 3598  141D 3807                      JR      C,DEF25 
 3599  141F 010001                    LD      BC,100H
 3600  1422 ED430ED0                  LD      (FASES1),BC
 3601  1426           DEF25:          
 3602  1426 2A10D0                    LD      HL,(FASRIF)     ;SE POSIZIONE RIFERIMENTO S1 > 4096 (IMPULSI ENCODER)
 3603  1429 110010                    LD      DE,1000H        ;RESET DEL VALORE
 3604  142C ED52                      SBC     HL,DE         
 3605  142E 3807                      JR      C,DEF26 
 3606  1430 010001                    LD      BC,100H
 3607  1433 ED4310D0                  LD      (FASRIF),BC
 3608                 
 3609  1437 C9        DEF26:          RET
 3610                 
 3611                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3612                 ;               ROUTINE DI COMPARAZIONE A 16 BIT
 3613                 ;               COMP16A <=> COMP16B
 3614                 ;               RITORNA IN COMP16A
 3615                 ;                 0 A=B
 3616                 ;                 1 A>B
 3617                 ;                 2 A<B
 3618                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3619                 
 3620  1438           COMPARE16:
 3621  1438 A7                        AND     A               ;RESET CARRY
 3622                 
 3623  1439 2A7CC0                    LD      HL,(COMP16A)
 3624  143C ED4B7EC0                  LD      BC,(COMP16B)
 3625  1440 ED42                      SBC     HL,BC
 3626                 
 3627  1442 2804                      JR      Z,COMPARE_A_E_B
 3628  1444 3814                      JR      C,COMPARE_A_L_B
 3629  1446 1809                      JR      COMPARE_A_G_B
 3630                 
 3631  1448           COMPARE_A_E_B:  
 3632  1448 010000                    LD      BC,0000H
 3633  144B ED437CC0                  LD      (COMP16A),BC
 3634  144F 1812                      JR      COMPARE16_FINE
 3635  1451           COMPARE_A_G_B:
 3636  1451 010100                    LD      BC,0001H
 3637  1454 ED437CC0                  LD      (COMP16A),BC
 3638  1458 1809                      JR      COMPARE16_FINE
 3639  145A           COMPARE_A_L_B:
 3640  145A 010200                    LD      BC,0002H
 3641  145D ED437CC0                  LD      (COMP16A),BC
 3642  1461 1800                      JR      COMPARE16_FINE
 3643                 
 3644  1463           COMPARE16_FINE:
 3645  1463 A7                        AND     A               ;RESET CARRY
 3646  1464 C9                        RET
 3647                 
 3648                 
 3649                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3650                 ;               ROUTINE DI DIVISIONE A 16 BIT
 3651                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3652                 
 3653  1465 D9        DIVIS:          EXX
 3654  1466 ED5B00C0                  LD      DE,(DIVDEN)
 3655  146A ED4B02C0                  LD      BC,(DIVSOR)
 3656  146E AF        DIV16:          XOR     A
 3657  146F 67                        LD      H,A
 3658  1470 6F                        LD      L,A
 3659  1471 3E10                      LD      A,10H
 3660  1473 CB13      DV0:            RL      E
 3661  1475 CB12                      RL      D
 3662  1477 ED6A                      ADC     HL,HL
 3663  1479 ED42                      SBC     HL,BC
 3664  147B 3001                      JR      NC,DIV1
 3665  147D 09                        ADD     HL,BC
 3666  147E 3F        DIV1:           CCF
 3667  147F 3D                        DEC     A
 3668  1480 20F1                      JR      NZ,DV0
 3669  1482 2218C0                    LD      (RESTO),HL      ;SSCC
 3670  1485 EB                        EX      DE,HL
 3671  1486 ED6A                      ADC     HL,HL
 3672  1488 2204C0                    LD      (QUOZIE),HL
 3673  148B D9                        EXX
 3674  148C C9                        RET
 3675                 
 3676                 
 3677                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3678                 ;               ROUTINE DI MOLTIPLICAZIONE
 3679                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3680                 
 3681  148D D9        MOLT:           EXX
 3682  148E ED5B06C0                  LD      DE,(MOLTI)      ;MOLTIPLICANDO
 3683  1492 3A08C0                    LD      A,(MOLPL)       ;MOLTIPLICATORE
 3684  1495 210000                    LD      HL,00H
 3685  1498 0608                      LD      B,08H
 3686  149A 29        MULT:           ADD     HL,HL
 3687  149B 17                        RLA
 3688  149C 3001                      JR      NC,CHCNT
 3689  149E 19                        ADD     HL,DE
 3690  149F 10F9      CHCNT:          DJNZ    MULT            ;SE IL RISULTATO
 3691  14A1 FE00                      CP      00H             ;E'> DI FFFFH IL
 3692  14A3 2803                      JR      Z,CHC1          ;REGISTRO A SARA'
 3693  14A5 21FFFF                    LD      HL,0FFFFH       ;DIVERSO DA 0 PER
 3694  14A8 220AC0    CHC1:           LD      (PROD),HL       ;CUI CARICA IL MAX
 3695  14AB D9                        EXX                     ;(SOLO IN CASO DI
 3696  14AC C9                        RET                     ;CORREZ.MOTORE)
 3697                 
 3698                                 
 3699                  
 3700                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3701                 ;               ROUTINE DI MOLTIPLICAZIONE A 24 BIT  
 3702                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3703                                 
 3704  14AD D9        MOL24:          EXX                                                                                        
 3705  14AE ED5B0CC0                  LD      DE,(MOLT24)
 3706  14B2 3A0EC0                    LD      A,(MOLP24)
 3707  14B5 010008                    LD      BC,800H                
 3708  14B8 61                        LD      H,C
 3709  14B9 69                        LD      L,C
 3710  14BA 29        MPX1:           ADD     HL,HL
 3711  14BB 17                        RLA
 3712  14BC 3002                      JR      NC,MPX2
 3713  14BE 19                        ADD     HL,DE
 3714  14BF 89                        ADC     A,C             ;IL RISULTATO
 3715  14C0 10F8      MPX2:           DJNZ    MPX1            ;SI TROVA IN AHL
 3716  14C2 2210C0                    LD      (PROD24),HL
 3717  14C5 3212C0                    LD      (PROD24+02H),A
 3718  14C8 D9                        EXX
 3719  14C9 C9                        RET
 3720                 
 3721                  
 3722                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3723                 ;               DIVISIONE PER 4096 
 3724                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3725                                          
 3726                 
 3727  14CA D9        DI4096:         EXX
 3728  14CB 2A80C0                    LD      HL,(DIV4096)
 3729  14CE 3A80C0                    LD      A,(DIV4096)
 3730  14D1 060D                      LD      B,0DH           ;PER DIVIDERE
 3731  14D3 1002      MPX3:           DJNZ    MPX4            ;IN 4096 SHIFTO
 3732  14D5 1816                      JR      MPX8            ;A DESTRA 12 VOLTE
 3733  14D7 CB3D      MPX4:           SRL     L
 3734  14D9 CB3C                      SRL     H
 3735  14DB 3806                      JR      C,MPX6
 3736  14DD CB3F      MPX5:           SRL     A
 3737  14DF 3807                      JR      C,MPX7
 3738  14E1 18F0                      JR      MPX3
 3739  14E3 3F        MPX6:           CCF
 3740  14E4 CBFD                      SET     7,L
 3741  14E6 18F5                      JR      MPX5
 3742  14E8 3F        MPX7:           CCF
 3743  14E9 CBFC                      SET     7,H
 3744  14EB 18E6                      JR      MPX3
 3745  14ED 2214C0    MPX8:           LD      (QU4096),HL
 3746  14F0 D9                        EXX
 3747  14F1 C9                        RET
 3748                 
 3749                 
 3750                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3751                 ;               DIVISIONE 24 PER 8 BIT (DIVISIONE PER 1000)
 3752                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3753                 
 3754  14F2 D9        DI1000:         EXX
 3755  14F3 3A3CC3                    LD      A,(ALTDIV)      
 3756  14F6 FE00                      CP      00H
 3757  14F8 280A                      JR      Z,DI1004
 3758  14FA FE01                      CP      01H             
 3759  14FC 280C                      JR      Z,DI1005
 3760  14FE DD213AC0                  LD      IX,PTO032
 3761  1502 180A                      JR      DI1006
 3762  1504 DD214CC0  DI1004:         LD      IX,RESTO0
 3763  1508 1804                      JR      DI1006
 3764  150A DD2160C0  DI1005:         LD      IX,TREST0       
 3765  150E 11E803    DI1006:         LD      DE,3E8H         ;1000
 3766  1511 010000                    LD      BC,0000H
 3767  1514 3E10                      LD      A,16
 3768  1516 3278C0                    LD      (MDIVIS),A
 3769  1519 DD6603    DI1001:         LD      H,(IX+03H)
 3770  151C DD6E02                    LD      L,(IX+02H)
 3771  151F ED52                      SBC     HL,DE
 3772  1521 FA2B15                    JP      M,DI1002
 3773  1524 DD7403                    LD      (IX+03H),H      ;RESTO
 3774  1527 DD7502                    LD      (IX+02H),L
 3775  152A 03                        INC     BC
 3776  152B DDCB0026  DI1002:         SLA     (IX+00H)        ;ROTAZ.DIV.DO
 3777  152F DDCB0116                  RL      (IX+01H)
 3778  1533 DDCB0216                  RL      (IX+02H)
 3779  1537 DDCB0316                  RL      (IX+03H)
 3780  153B CB21                      SLA     C               ;ROTAZ.QUO.TE
 3781  153D CB10                      RL      B
 3782  153F 3A78C0                    LD      A,(MDIVIS)
 3783  1542 3D                        DEC     A
 3784  1543 3278C0                    LD      (MDIVIS),A
 3785  1546 20D1                      JR      NZ,DI1001
 3786  1548 DD6603                    LD      H,(IX+03H)
 3787  154B DD6E02                    LD      L,(IX+02H)
 3788  154E ED52                      SBC     HL,DE
 3789  1550 FA5415                    JP      M,DI1003
 3790  1553 03                        INC     BC
 3791  1554 ED4316C0  DI1003:         LD      (QU1000),BC
 3792  1558 D9                        EXX
 3793  1559 C9                        RET
 3794                                 
 3795                 
 3796                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3797                 ;               DECREMENTA CONTATORE A 32 BIT
 3798                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3799  155A           DEC32:
 3800  155A D9                        EXX
 3801                                 
 3802  155B 2A7AC0                    LD      HL,(COUNTER32)          ;INDIRIZZAMENTO INDIRETTO
 3803  155E 23                        INC     HL                      ;VERSO LA WORD BASSA
 3804  155F 23                        INC     HL
 3805                 
 3806                                 
 3807  1560 5E                        LD      E,(HL)                  ;CARICO LA WORD BASSA IN DE
 3808  1561 23                        INC     HL
 3809  1562 56                        LD      D,(HL)
 3810                 
 3811  1563 010100                    LD      BC,01H
 3812                                 
 3813  1566 A7                        AND     A                       ;RESET CARRY
 3814                 
 3815  1567 EB                        EX      DE,HL                   ;DE = DE-BC
 3816  1568 ED42                      SBC     HL,BC   
 3817  156A EB                        EX      DE,HL
 3818                 
 3819  156B 72                        LD      (HL),D                  ;SCRIVO LA WORD BASSA
 3820  156C 2B                        DEC     HL
 3821  156D 73                        LD      (HL),E
 3822                 
 3823  156E 300A                      JR      NC,DEC32_FINE           ;SE NON C'E' CARRY HO TERMINATO, ALTRIMENTI DECREMENTO PAROLA ALTA
 3824                 
 3825                 
 3826                 
 3827  1570 2A7AC0                    LD      HL,(COUNTER32)          ;INDIRIZZAMENTO INDIRETTO
 3828  1573 5E                        LD      E,(HL)                  ;CARICO LA WORD ALTA IN DE
 3829  1574 23                        INC     HL
 3830  1575 56                        LD      D,(HL)          
 3831                 
 3832  1576 1B                        DEC     DE                      ;DECREMENTO WORD ALTA
 3833                 
 3834  1577 72                        LD      (HL),D                  ;SCRIVO LA WORD ALTA
 3835  1578 2B                        DEC     HL
 3836  1579 73                        LD      (HL),E          
 3837                 
 3838                 
 3839                 
 3840  157A           DEC32_FINE:
 3841  157A D9                        EXX
 3842  157B C9                        RET
 3843                 
 3844                 
 3845                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3846                 ;               CHECK CONTATORE A 32 BIT = 00000000H
 3847                 ;               (CONTROLLO 32 BIT A PARTIRE DA AREA DI MEMORIA
 3848                 ;               INDICATA IN COUNTER32
 3849                 ;
 3850                 ;               SE CONTATORE E' = 0, COUNTER32 = FFFFH
 3851                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3852  157C           CHK32:
 3853  157C D9                        EXX
 3854  157D 2A7AC0                    LD      HL,(COUNTER32)
 3855  1580 5E                        LD      E,(HL)
 3856  1581 23                        INC     HL
 3857  1582 7E                        LD      A,(HL)
 3858  1583 B3                        OR      E
 3859  1584 2010                      JR      NZ,CHK32_FINE           
 3860                                 
 3861  1586 23                        INC     HL
 3862  1587 5E                        LD      E,(HL)
 3863  1588 23                        INC     HL
 3864  1589 7E                        LD      A,(HL)
 3865  158A B3                        OR      E
 3866  158B 2009                      JR      NZ,CHK32_FINE           
 3867                 
 3868  158D 1800                      JR      CHK32_ZERO
 3869                 
 3870  158F           CHK32_ZERO:     
 3871  158F 11FFFF                    LD      DE,0FFFFH
 3872  1592 ED537AC0                  LD      (COUNTER32),DE
 3873  1596           CHK32_FINE:
 3874  1596 D9                        EXX
 3875  1597 C9                        RET
 3876                 
 3877                 
 3878                 
 3879                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3880                 ;               MOLTIPLICAZIONE A 32 BIT
 3881                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3882                 
 3883  1598 D9        MOL32:          EXX
 3884                                 
 3885  1599 0604                      LD      B,04H
 3886  159B 213AC0                    LD      HL,PTO032
 3887  159E 3600      INIT:           LD      (HL),00H
 3888  15A0 23                        INC     HL
 3889  15A1 10FB                      DJNZ    INIT
 3890  15A3 0604      SHIFTX:         LD      B,04H
 3891  15A5 DD2135C0                  LD      IX,MDO032+03H
 3892  15A9 AF                        XOR     A
 3893  15AA DDCB001E  RTX:            RR      (IX)
 3894  15AE DD2B                      DEC     IX
 3895  15B0 10F8                      DJNZ    RTX
 3896  15B2 3014                      JR      NC,ZERO
 3897  15B4 0604                      LD      B,04H
 3898  15B6 213AC0                    LD      HL,PTO032
 3899  15B9 FD2136C0                  LD      IY,MRE032
 3900  15BD 3F                        CCF
 3901  15BE FD7E00    NXTBYT:         LD      A,(IY)
 3902  15C1 8E                        ADC     A,(HL)
 3903  15C2 77                        LD      (HL),A
 3904  15C3 FD23                      INC     IY
 3905  15C5 23                        INC     HL
 3906  15C6 10F6                      DJNZ    NXTBYT
 3907  15C8 0604      ZERO:           LD      B,04H
 3908  15CA DD2132C0                  LD      IX,MDO032
 3909  15CE AF                        XOR     A
 3910  15CF DDB600    ZCHK:           OR      (IX)
 3911  15D2 2006                      JR      NZ,SHIFTY
 3912  15D4 DD23                      INC     IX
 3913  15D6 10F7                      DJNZ    ZCHK
 3914  15D8 1811                      JR      END32
 3915  15DA 0604      SHIFTY:         LD      B,04H
 3916  15DC FD2136C0                  LD      IY,MRE032
 3917  15E0 AF                        XOR     A
 3918  15E1 FDCB0016  LEFTY:          RL      (IY)
 3919  15E5 FD23                      INC     IY
 3920  15E7 10F8                      DJNZ    LEFTY
 3921  15E9 18B8                      JR      SHIFTX
 3922  15EB D9        END32:          EXX
 3923  15EC C9                        RET
 3924                 
 3925                 
 3926                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3927                 ;               DIVISIONE, 32BIT DIVISO 4096
 3928                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3929                  
 3930                 
 3931  15ED           DIV32_4096:      
 3932  15ED D9                        EXX
 3933  15EE 2A3EC0                    LD      HL,(EDEND0)
 3934  15F1 ED5B40C0                  LD      DE,(EDEND2)
 3935  15F5 060D                      LD      B,0DH           ;PER DIVIDERE
 3936  15F7 1002      MPW1:           DJNZ    MPW2            ;IN 4096 SHIFTO
 3937  15F9 181F                      JR      MPW8            ;A DESTRA 12 VOLTE
 3938  15FB CB3D      MPW2:           SRL     L
 3939  15FD CB3C                      SRL     H
 3940  15FF 3814                      JR      C,MPW7
 3941  1601 CB3B      MPW3:           SRL     E
 3942  1603 380B                      JR      C,MPW6
 3943  1605 CB3A      MPW4:           SRL     D
 3944  1607 3802                      JR      C,MPW5
 3945  1609 18EC                      JR      MPW1
 3946  160B 3F        MPW5:           CCF
 3947  160C CBFB                      SET     7,E
 3948  160E 18E7                      JR      MPW1
 3949  1610 3F        MPW6:           CCF
 3950  1611 CBFC                      SET     7,H
 3951  1613 18F0                      JR      MPW4
 3952  1615 3F        MPW7:           CCF
 3953  1616 CBFD                      SET     7,L
 3954  1618 18E7                      JR      MPW3
 3955  161A 2242C0    MPW8:           LD      (QUOZ32),HL
 3956                 
 3957  161D           DIV32_4096_FINE:
 3958  161D D9                        EXX
 3959  161E C9                        RET
 3960                 
 3961                 
 3962                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3963                 ;               SHIFT 32 BIT (USATO IN DIVISIONE)
 3964                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3965  161F           RLULONG:                
 3966  161F 210600            LD      HL,06H;#2+4
 3967  1622 39                ADD     HL,SP
 3968  1623 4E                LD      C,(HL)
 3969  1624 2B                DEC     HL
 3970  1625 56                LD      D,(HL)
 3971  1626 2B                DEC     HL
 3972  1627 5E                LD      E,(HL)
 3973  1628 2B                DEC     HL
 3974  1629 7E                LD      A,(HL)
 3975  162A 2B                DEC     HL
 3976  162B 6E                LD      L,(HL)
 3977  162C 67                LD      H,A
 3978                 
 3979  162D 79                LD      A,C
 3980  162E           RLULONG_01:
 3981  162E B7                OR      A
 3982  162F C8                RET     Z
 3983                 
 3984  1630 CB15              RL      L
 3985  1632 CB14              RL      H
 3986  1634 CB13              RL      E
 3987  1636 CB12              RL      D
 3988                 
 3989  1638 3D                DEC     A        
 3990  1639 C32E16            JP      RLULONG_01
 3991  163C           RLULONG_FINE:
 3992                 
 3993                 
 3994                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 3995                 ;               DIVISIONE 32 BIT
 3996                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 3997                 ;#DEFINE MSB_SET(X) ((X >> (8*SIZEOF(X)-1)) & 1)
 3998                 ;UNSIGNED LONG _DIV32 (UNSIGNED LONG X, UNSIGNED LONG Y)
 3999                 ;{
 4000                 ;  UNSIGNED LONG RESTE = 0L;
 4001                 ;  UNSIGNED CHAR COUNT = 32;
 4002                 ;  BOOL C;
 4003                 ;
 4004                 ;  DO
 4005                 ;  {
 4006                 ;    // RESTE: X <- 0;
 4007                 ;    C = MSB_SET(X);
 4008                 ;    X <<= 1;
 4009                 ;    RESTE <<= 1;
 4010                 ;    IF (C)
 4011                 ;      RESTE |= 1L;
 4012                 ;
 4013                 ;    IF (RESTE >= Y)
 4014                 ;    {
 4015                 ;      RESTE -= Y;
 4016                 ;      // X <- (RESULT = 1)
 4017                 ;      X |= 1L;
 4018                 ;    }
 4019                 ;  }
 4020                 ;  WHILE (--COUNT);
 4021                 ;  RETURN X;
 4022                 ;}
 4023                 ;
 4024                 ;
 4025                 ;DIV32 (UNSIGNED LONG X, UNSIGNED LONG Y)
 4026  163C           DIV32_INNER:
 4027  163C DDE5              PUSH    IX
 4028  163E DD210000          LD      IX,00H
 4029  1642 DD39              ADD     IX,SP
 4030  1644 21FAFF            LD      HL,0FFFAH
 4031  1647 39                ADD     HL,SP
 4032  1648 F9                LD      SP,HL
 4033                 ;unsigned long reste = 0L;
 4034  1649 AF                XOR     A
 4035  164A DD77FC            LD      (IX-4),A
 4036  164D DD77FD            LD      (IX-3),A
 4037  1650 DD77FE            LD      (IX-2),A
 4038  1653 DD77FF            LD      (IX-1),A
 4039                 ;do
 4040  1656 DD36FB20          LD      (IX-5),20H
 4041  165A           DIV32_INNER_01:
 4042                 ;c = MSB_SET(x);
 4043  165A DD7E07            LD      A,(IX+7)
 4044  165D CB07              RLC     A
 4045  165F E601              AND     01H
 4046  1661 4F                LD      C,A
 4047  1662 DD71FA            LD      (IX-6),C
 4048                 ;x <<= 1;
 4049  1665 3E01              LD      A,01H
 4050  1667 F5                PUSH    AF
 4051  1668 33                INC     SP
 4052  1669 DD6E06            LD      L,(IX+6)
 4053  166C DD6607            LD      H,(IX+7)
 4054  166F E5                PUSH    HL
 4055  1670 DD6E04            LD      L,(IX+4)
 4056  1673 DD6605            LD      H,(IX+5)
 4057  1676 E5                PUSH    HL
 4058  1677 CD1F16            CALL    RLULONG
 4059  167A 44                LD      B,H
 4060  167B 4D                LD      C,L
 4061  167C F1                POP     AF
 4062  167D F1                POP     AF
 4063  167E 33                INC     SP
 4064  167F DD7104            LD      (IX+4),C
 4065  1682 DD7005            LD      (IX+5),B
 4066  1685 DD7306            LD      (IX+6),E
 4067  1688 DD7207            LD      (IX+7),D
 4068                 ;reste <<= 1;
 4069  168B 3E01              LD      A,01H
 4070  168D F5                PUSH    AF
 4071  168E 33                INC     SP
 4072  168F DD6EFE            LD      L,(IX-2)
 4073  1692 DD66FF            LD      H,(IX-1)
 4074  1695 E5                PUSH    HL
 4075  1696 DD6EFC            LD      L,(IX-4)
 4076  1699 DD66FD            LD      H,(IX-3)
 4077  169C E5                PUSH    HL
 4078  169D CD1F16            CALL    RLULONG
 4079  16A0 44                LD      B,H
 4080  16A1 4D                LD      C,L
 4081  16A2 F1                POP     AF
 4082  16A3 F1                POP     AF
 4083  16A4 33                INC     SP
 4084  16A5 DD71FC            LD      (IX-4),C
 4085  16A8 DD70FD            LD      (IX-3),B
 4086  16AB DD73FE            LD      (IX-2),E
 4087  16AE DD72FF            LD      (IX-1),D
 4088                 ;if (c)
 4089  16B1 AF                XOR     A
 4090  16B2 DDB6FA            OR      (IX-6)
 4091  16B5 CAC016            JP      Z,DIV32_INNER_02
 4092                 ;reste |= 1L;
 4093  16B8 DD7EFC            LD      A,(IX-4)
 4094  16BB F601              OR      01H
 4095  16BD DD77FC            LD      (IX-4),A
 4096  16C0           DIV32_INNER_02:
 4097                 ;if (reste >= y)
 4098  16C0 DD7EFC            LD      A,(IX-4)
 4099  16C3 DD9608            SUB     (IX+8)
 4100  16C6 DD7EFD            LD      A,(IX-3)
 4101  16C9 DD9E09            SBC     A,(IX+9)
 4102  16CC DD7EFE            LD      A,(IX-2)
 4103  16CF DD9E0A            SBC     A,(IX+10)
 4104  16D2 DD7EFF            LD      A,(IX-1)
 4105  16D5 DD9E0B            SBC     A,(IX+11)
 4106  16D8 DA0717            JP      C,DIV32_INNER_03
 4107                 ;reste -= y;
 4108  16DB DD7EFC            LD      A,(IX-4)
 4109  16DE DD9608            SUB     (IX+8)
 4110  16E1 DD77FC            LD      (IX-4),A
 4111  16E4 DD7EFD            LD      A,(IX-3)
 4112  16E7 DD9E09            SBC     A,(IX+9)
 4113  16EA DD77FD            LD      (IX-3),A
 4114  16ED DD7EFE            LD      A,(IX-2)
 4115  16F0 DD9E0A            SBC     A,(IX+10)
 4116  16F3 DD77FE            LD      (IX-2),A
 4117  16F6 DD7EFF            LD      A,(IX-1)
 4118  16F9 DD9E0B            SBC     A,(IX+11)
 4119  16FC DD77FF            LD      (IX-1),A
 4120                 ;x |= 1L;
 4121  16FF DD7E04            LD      A,(IX+4)
 4122  1702 F601              OR      01H
 4123  1704 DD7704            LD      (IX+4),A
 4124  1707           DIV32_INNER_03:
 4125                 ;while (--count);
 4126  1707 DD35FB            DEC     (IX-5)
 4127  170A AF                XOR     A
 4128  170B DDB6FB            OR      (IX-5)
 4129  170E C25A16            JP      NZ,DIV32_INNER_01
 4130                 ;return x;
 4131  1711 DD6E04            LD      L,(IX+4)
 4132  1714 DD6605            LD      H,(IX+5)
 4133  1717 DD5E06            LD      E,(IX+6)
 4134  171A DD5607            LD      D,(IX+7)
 4135                 
 4136  171D DDF9              LD      SP,IX
 4137  171F DDE1              POP     IX
 4138  1721 C9                RET
 4139  1722           DIV32_INNER_END:
 4140                              
 4141                 
 4142  1722           DIV32:
 4143  1722 DDE5              PUSH    IX
 4144  1724 DD210000          LD      IX,00H
 4145  1728 DD39              ADD     IX,SP
 4146  172A 21FAFF            LD      HL,0FFFAH
 4147  172D 39                ADD     HL,SP
 4148  172E F9                LD      SP,HL
 4149                         ;(*QUOZIENTE) =   DIV32_INNER ((*DIVISORE), (*DIVIDENDO));
 4150  172F 218AC0            LD      HL,DIV32_QUOZ_L
 4151  1732 DD75FE            LD      (IX-2),l        ;#0X8A
 4152  1735 DD74FF            LD      (IX-1),H        ;#0XC0
 4153  1738 2186C0            LD      HL,DIV32_DIVIS_L
 4154  173B 7E                LD      A,(HL)
 4155  173C DD77FA            LD      (IX-6),A
 4156  173F 23                INC     HL
 4157  1740 7E                LD      A,(HL)
 4158  1741 DD77FB            LD      (IX-5),A
 4159  1744 23                INC     HL
 4160  1745 7E                LD      A,(HL)
 4161  1746 DD77FC            LD      (IX-4),A
 4162  1749 23                INC     HL
 4163  174A 7E                LD      A,(HL)
 4164  174B DD77FD            LD      (IX-3),A
 4165  174E 2182C0            LD      HL,DIV32_DIVID_L
 4166  1751 4E                LD      C,(HL)
 4167  1752 23                INC     HL
 4168  1753 46                LD      B,(HL)
 4169  1754 23                INC     HL
 4170  1755 5E                LD      E,(HL)
 4171  1756 23                INC     HL
 4172  1757 56                LD      D,(HL)
 4173  1758 DD6EFC            LD      L,(IX-4)
 4174  175B DD66FD            LD      H,(IX-3)
 4175  175E E5                PUSH    HL
 4176  175F DD6EFA            LD      L,(IX-6)
 4177  1762 DD66FB            LD      H,(IX-5)
 4178  1765 E5                PUSH    HL
 4179  1766 D5                PUSH    DE
 4180  1767 C5                PUSH    BC
 4181  1768 CD3C16            CALL    DIV32_INNER
 4182  176B 44                LD      B,H
 4183  176C 4D                LD      C,L
 4184  176D F1                POP     AF
 4185  176E F1                POP     AF
 4186  176F F1                POP     AF
 4187  1770 F1                POP     AF
 4188  1771 DD6EFE            LD      L,(IX-2)
 4189  1774 DD66FF            LD      H,(IX-1)
 4190  1777 71                LD      (HL),C
 4191  1778 23                INC     HL
 4192  1779 70                LD      (HL),B
 4193  177A 23                INC     HL
 4194  177B 73                LD      (HL),E
 4195  177C 23                INC     HL
 4196  177D 72                LD      (HL),D
 4197  177E DDF9              LD      SP,IX
 4198  1780 DDE1              POP     IX
 4199  1782 C9                RET
 4200  1783           DIV32_FINE:
 4201                 
 4202                 
 4203                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4204                 ;               SOTTRAZIONE 32 BIT
 4205                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4206                 
 4207  1783 D9        SOTT32:         EXX
 4208  1784 A7                        AND     A
 4209  1785 2A44C0                    LD      HL,(MINUE0)     ;SALVO MINU-
 4210  1788 2250C0                    LD      (MIXUE0),HL     ;ENDO E SOT-
 4211  178B 2A46C0                    LD      HL,(MINUE2)     ;TRAENDO
 4212  178E 2252C0                    LD      (MIXUE2),HL     ;ORIGINALI
 4213  1791 2A48C0                    LD      HL,(SUBTR0)
 4214  1794 2254C0                    LD      (SUXTR0),HL
 4215  1797 2A4AC0                    LD      HL,(SUBTR2)
 4216  179A 2256C0                    LD      (SUXTR2),HL
 4217  179D 2A52C0                    LD      HL,(MIXUE2)     ;VERIFICO CHI E'
 4218  17A0 ED5B56C0                  LD      DE,(SUXTR2)     ;IL NUMERO PIU'
 4219  17A4 ED52                      SBC     HL,DE           ;GRANDE PER PER
 4220  17A6 2804                      JR      Z,SOT01         ;NON AVERE IL
 4221  17A8 3030                      JR      NC,SOT03        ;RISULTATO NEGA-
 4222  17AA 180B                      JR      SOT02           ;TIVO E PER
 4223  17AC 2A50C0    SOT01:          LD      HL,(MIXUE0)     ;DETERMINARE IL
 4224  17AF ED5B54C0                  LD      DE,(SUXTR0)     ;SENSO DI CORREZ-
 4225  17B3 ED52                      SBC     HL,DE           ;ZIONE
 4226  17B5 3023                      JR      NC,SOT03
 4227  17B7 2A50C0    SOT02:          LD      HL,(MIXUE0)
 4228  17BA ED5B54C0                  LD      DE,(SUXTR0)
 4229  17BE ED5350C0                  LD      (MIXUE0),DE
 4230  17C2 2254C0                    LD      (SUXTR0),HL
 4231  17C5 2A52C0                    LD      HL,(MIXUE2)
 4232  17C8 ED5B56C0                  LD      DE,(SUXTR2)
 4233  17CC ED5352C0                  LD      (MIXUE2),DE
 4234  17D0 2256C0                    LD      (SUXTR2),HL     
 4235  17D3 3E08                      LD      A,D_RITARDO
 4236  17D5 3238C3                    LD      (MSCORR),A
 4237  17D8 1805                      JR      SOT04
 4238  17DA 3E01      SOT03:          LD      A,D_AVANTI
 4239  17DC 3238C3                    LD      (MSCORR),A
 4240  17DF 2A50C0    SOT04:          LD      HL,(MIXUE0)
 4241  17E2 ED5B52C0                  LD      DE,(MIXUE2)
 4242  17E6 ED4B54C0                  LD      BC,(SUXTR0)
 4243  17EA A7                        AND     A
 4244  17EB ED42                      SBC     HL,BC
 4245  17ED 224CC0                    LD      (RESTO0),HL
 4246  17F0 222EC0                    LD      (MREST0),HL     ;MEMORIZZO
 4247  17F3 3001                      JR      NC,SOT05        ;IL RESTO
 4248  17F5 1B                        DEC     DE              ;PERCHE' LA
 4249  17F6 EB        SOT05:          EX      DE,HL           ;LOCAZIONE
 4250  17F7 ED5B56C0                  LD      DE,(SUXTR2)     ;REST0 VIENE
 4251  17FB A7                        AND     A               ;IN SEGUITO
 4252  17FC ED52                      SBC     HL,DE           ;MODIFICATA
 4253  17FE 224EC0                    LD      (RESTO2),HL
 4254  1801 2230C0                    LD      (MREST2),HL     
 4255  1804 D9                        EXX
 4256  1805 C9                        RET
 4257                 
 4258                                 
 4259                 
 4260  1806 D9        TSOTT32:        EXX
 4261  1807 A7                        AND     A
 4262  1808 2A58C0                    LD      HL,(TINUE0)     ;SALVO MINU-
 4263  180B 2264C0                    LD      (TIXUE0),HL     ;ENDO E SOT-
 4264  180E 2A5AC0                    LD      HL,(TINUE2)     ;TRAENDO
 4265  1811 2266C0                    LD      (TIXUE2),HL     ;ORIGINALI
 4266  1814 2A5CC0                    LD      HL,(TUBTR0)
 4267  1817 2268C0                    LD      (TUXTR0),HL
 4268  181A 2A5EC0                    LD      HL,(TUBTR2)
 4269  181D 226AC0                    LD      (TUXTR2),HL
 4270  1820 2A66C0                    LD      HL,(TIXUE2)     ;VERIFICO CHI E'
 4271  1823 ED5B6AC0                  LD      DE,(TUXTR2)     ;IL NUMERO PIU'
 4272  1827 ED52                      SBC     HL,DE           ;GRANDE PER PER
 4273  1829 2804                      JR      Z,TSOT01        ;NON AVERE IL
 4274  182B 3030                      JR      NC,TSOT03       ;RISULTATO NEGA-
 4275  182D 180B                      JR      TSOT02          ;TIVO E PER
 4276  182F 2A64C0    TSOT01:         LD      HL,(TIXUE0)     ;DETERMINARE IL
 4277  1832 ED5B68C0                  LD      DE,(TUXTR0)     ;SENSO DI CORREZ-
 4278  1836 ED52                      SBC     HL,DE           ;ZIONE
 4279  1838 3023                      JR      NC,TSOT03
 4280  183A 2A64C0    TSOT02:         LD      HL,(TIXUE0)
 4281  183D ED5B68C0                  LD      DE,(TUXTR0)
 4282  1841 ED5364C0                  LD      (TIXUE0),DE
 4283  1845 2268C0                    LD      (TUXTR0),HL
 4284  1848 2A66C0                    LD      HL,(TIXUE2)
 4285  184B ED5B6AC0                  LD      DE,(TUXTR2)
 4286  184F ED5366C0                  LD      (TIXUE2),DE
 4287  1853 226AC0                    LD      (TUXTR2),HL     
 4288  1856 3E01                      LD      A,D_DESTRA
 4289  1858 320CC3                    LD      (TMSCOR),A
 4290  185B 1805                      JR      TSOT04
 4291  185D 3E08      TSOT03:         LD      A,D_SINISTRA
 4292  185F 320CC3                    LD      (TMSCOR),A
 4293  1862 2A64C0    TSOT04:         LD      HL,(TIXUE0)
 4294  1865 ED5B66C0                  LD      DE,(TIXUE2)
 4295  1869 ED4B68C0                  LD      BC,(TUXTR0)
 4296  186D A7                        AND     A
 4297  186E ED42                      SBC     HL,BC
 4298  1870 2260C0                    LD      (TREST0),HL
 4299  1873 3001                      JR      NC,TSOT05
 4300  1875 1B                        DEC     DE
 4301  1876 EB        TSOT05:         EX      DE,HL
 4302  1877 ED5B6AC0                  LD      DE,(TUXTR2)
 4303  187B A7                        AND     A
 4304  187C ED52                      SBC     HL,DE
 4305  187E 2262C0                    LD      (TREST2),HL
 4306  1881 D9                        EXX
 4307  1882 C9                        RET
 4308                 
 4309                 
 4310                                 
 4311                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4312                 ;               SOMMA A 32 BIT
 4313                 ;
 4314                 ;       AUGENDO = ADDENDO + AUGENDO
 4315                 ;       si definisce il primo operando addendo e il secondo augendo. 
 4316                 ;       Il risultato somma va poi a sostituire il valore dell'augendo 
 4317                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4318                                 
 4319                 
 4320  1883 D9        SOMM32:         EXX
 4321  1884 111AC0                    LD      DE,ADDEN0
 4322  1887 211EC0                    LD      HL,AUGEN0
 4323  188A 0604                      LD      B,04H
 4324  188C A7                        AND     A
 4325  188D 1A        ADDW:           LD      A,(DE)
 4326  188E 8E                        ADC     A,(HL)
 4327  188F 77                        LD      (HL),A
 4328  1890 13                        INC     DE              ;IL RISULTATO
 4329  1891 23                        INC     HL              ;SI TROVA NELLA
 4330  1892 10F9                      DJNZ    ADDW            ;LOCAZIONE 
 4331  1894 D9                        EXX                     ;ADDEN0 E ADDEN2
 4332  1895 C9                        RET
 4333                                 
 4334                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4335                 ;               SOTTRAZIONE A 32 BIT
 4336                 ;
 4337                 ;       RESTO = MINUENDO - SOTTRAENDO
 4338                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4339                 
 4340  1896 D9        CSOTT32:        EXX
 4341  1897 A7                        AND     A
 4342  1898 2A6EC0                    LD      HL,(CINUE2)
 4343  189B ED5B72C0                  LD      DE,(CUBTR2)
 4344  189F ED52                      SBC     HL,DE
 4345  18A1 3018                      JR      NC,COT00
 4346  18A3 2A6EC0                    LD      HL,(CINUE2)
 4347  18A6 ED536EC0                  LD      (CINUE2),DE
 4348  18AA 2272C0                    LD      (CUBTR2),HL
 4349  18AD 2A6CC0                    LD      HL,(CINUE0)
 4350  18B0 ED5B70C0                  LD      DE,(CUBTR0)
 4351  18B4 ED536CC0                  LD      (CINUE0),DE
 4352  18B8 2270C0                    LD      (CUBTR0),HL
 4353  18BB 2A6CC0    COT00:          LD      HL,(CINUE0)
 4354  18BE ED5B6EC0                  LD      DE,(CINUE2)
 4355  18C2 ED4B70C0                  LD      BC,(CUBTR0)
 4356  18C6 A7                        AND     A
 4357  18C7 ED42                      SBC     HL,BC
 4358  18C9 2274C0                    LD      (CESTO0),HL
 4359  18CC 3001                      JR      NC,COT01
 4360  18CE 1B                        DEC     DE
 4361  18CF EB        COT01:          EX      DE,HL
 4362  18D0 ED5B72C0                  LD      DE,(CUBTR2)
 4363  18D4 A7                        AND     A
 4364  18D5 ED52                      SBC     HL,DE
 4365  18D7 2276C0                    LD      (CESTO2),HL
 4366  18DA D9                        EXX
 4367  18DB C9                        RET
 4368                 
 4369                                
 4370  18DC D9        CSOM32:         EXX
 4371  18DD 37                        SCF
 4372  18DE 3F                        CCF
 4373  18DF 2A22C0                    LD      HL,(CADDE0)
 4374  18E2 ED5B26C0                  LD      DE,(CAUGE0)
 4375  18E6 ED5A                      ADC     HL,DE
 4376  18E8 222AC0                    LD      (CSOMM0),HL
 4377  18EB 2A24C0                    LD      HL,(CADDE2)
 4378  18EE ED5B28C0                  LD      DE,(CAUGE2)
 4379  18F2 ED5A                      ADC     HL,DE
 4380  18F4 222CC0                    LD      (CSOMM2),HL
 4381  18F7 37                        SCF
 4382  18F8 3F                        CCF
 4383  18F9 D9                        EXX
 4384  18FA C9                        RET
 4385                 
 4386                 
 4387                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4388                 ;               GESTIONE DELLA CORREZIONE SUPERIORE A MEZZO GATE  
 4389                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4390                 
 4391                 
 4392  18FB           OVERCO:
 4393  18FB 3A18C3                    LD      A,(SUPCOR)      ;SE C'E' STATO UN ERRORE MAGGIORE 
 4394  18FE FE01                      CP      01H             ;DI MEZZO GATE
 4395  1900 203E                      JR      NZ,OVERCO_FINE
 4396                 
 4397  1902 2A50C3                    LD      HL,(ERATTU)     ;SE ERRORE > 1mm  
 4398  1905 116400                    LD      DE,0064H        ;SALTO SE NO  
 4399  1908 ED52                      SBC     HL,DE           ;RICARICO LA
 4400  190A 3026                      JR      NC,OVERC3       ;SOVRA CORREZ-
 4401  190C 3F                        CCF                     ;ZIONE.
 4402                 
 4403  190D 3A1AC3                    LD      A,(SHIFT3)      ;METTO IN SHIFT
 4404  1910 3D                        DEC     A               ;AMPI40 FINO
 4405  1911 321AC3                    LD      (SHIFT3),A      ;A CHE SHIFT1
 4406  1914 FE00                      CP      00H             ;ARRIVI A ZERO
 4407  1916 280A                      JR      Z,OVERC1
 4408  1918 ED5B54D0                  LD      DE,(AMPI40)     
 4409  191C ED5348D0                  LD      (SHIFT),DE      
 4410  1920 180D                      JR      OVERC2
 4411                 
 4412  1922 ED5B1CC3  OVERC1:         LD      DE,(SHIFT4)     ;ALLA FINE 
 4413  1926 ED5348D0                  LD      (SHIFT),DE      ;CARICO IL
 4414  192A 3E00                      LD      A,00H           ;RESTO IN
 4415  192C 3218C3                    LD      (SUPCOR),A      ;SHIFT
 4416                 
 4417  192F CD240A    OVERC2:         CALL    SPOSTA
 4418                 
 4419  1932 3A8ED0    OVERC3:         LD      A,(TIRCIC)      ;QUADRU-
 4420  1935 17                        RLA                     ;PLICO
 4421  1936 17                        RLA                     ;IL TEMPO DI 
 4422  1937 324CC3                    LD      (INCREM),A      ;ATTESA DEL
 4423  193A 324EC3                    LD      (DECREM),A      ;TIRO 
 4424  193D 321EC3                    LD      (TIRCIR_ATT),A      
 4425  1940           OVERCO_FINE:
 4426  1940 C9                        RET
 4427                 
 4428                 
 4429                 
 4430                 
 4431                 
 4432                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4433                 ;               CALCOLO DELLA  VELOCITA' 
 4434                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4435                 
 4436                                 ;4mS x 4096 = 16384000
 4437                                 ;60\1638400 = 0,000003662
 4438                                 ;0,000003662 x CILINDRO = X
 4439                                 ;X\1000 = COSVEL (COSVEL E' CALCOLATA AL CAMBIO CILINDRO)
 4440                                 ;COSVEL x VELIMP = Y
 4441                                 ;Y/1000 = VELOCITA m/m
 4442                 
 4443  1941           VELO:           
 4444  1941 ED5B04D0                  LD      DE,(COSVEL)
 4445  1945 ED5332C0                  LD      (MDO032),DE
 4446  1949 110000                    LD      DE,0000H
 4447  194C ED5334C0                  LD      (MDO232),DE
 4448  1950 ED5338C0                  LD      (MRE232),DE
 4449  1954 ED5B06C3                  LD      DE,(VELIMP)
 4450  1958 ED5336C0                  LD      (MRE032),DE
 4451  195C 3E02                      LD      A,02H           
 4452  195E 323CC3                    LD      (ALTDIV),A      
 4453  1961 CD9815                    CALL    MOL32
 4454  1964 CDF214                    CALL    DI1000
 4455  1967 ED4B16C0                  LD      BC,(QU1000)     ;VELOCITA         
 4456  196B ED4308C3                  LD      (VELIST),BC     ;ISTANTANEA    
 4457                                 
 4458                                 ;MEDIA VELOCITA SU QUATTRO LETTURE  WWNN
 4459                 
 4460  196F 0603                      LD      B,03H        
 4461  1971 DD21A0C0                  LD      IX,ARR_VELO      
 4462  1975 110400                    LD      DE,0004H        
 4463  1978 DD19                      ADD     IX,DE
 4464  197A           MEDV01:
 4465  197A DD5E00                    LD      E,(IX)          ;DATI LETTI
 4466  197D DD5601                    LD      D,(IX+01H)      ;INSERENDO
 4467  1980 DD7302                    LD      (IX+02H),E      ;IL NUOVO
 4468  1983 DD7203                    LD      (IX+03H),D      ;DATO AL
 4469  1986 DD2B                      DEC     IX              ;PRIMO POSTO
 4470  1988 DD2B                      DEC     IX              ;ED ELIMINANDO
 4471  198A 10EE                      DJNZ    MEDV01          ;L'ULTIMO
 4472  198C DD23                      INC     IX
 4473  198E DD23                      INC     IX
 4474                 
 4475                 
 4476  1990 ED5B08C3                  LD      DE,(VELIST)
 4477  1994 ED53A0C0                  LD      (ARR_VELO),DE
 4478                 
 4479  1998 0604                      LD      B,04H            ;SOMMA DELLE
 4480  199A 3001                      JR      NC,MEDV02        ;4 CELLE
 4481  199C 3F                        CCF                      ; 
 4482  199D 210000    MEDV02:         LD      HL,0000H
 4483  19A0           MEDV03:
 4484  19A0 DD5E00                    LD      E,(IX+00H)
 4485  19A3 DD5601                    LD      D,(IX+01H)
 4486  19A6 ED5A                      ADC     HL,DE
 4487  19A8 DD23                      INC     IX
 4488  19AA DD23                      INC     IX
 4489  19AC 10F2                      DJNZ    MEDV03
 4490                                 
 4491  19AE 2200C0                    LD      (DIVDEN),HL
 4492  19B1 010400                    LD      BC,0004H  
 4493  19B4 ED4302C0                  LD      (DIVSOR),BC    
 4494  19B8 CD6514                    CALL    DIVIS
 4495  19BB 2A04C0                    LD      HL,(QUOZIE)
 4496  19BE 220AC3                    LD      (VELMED),HL
 4497                 
 4498  19C1 CDCD19                    CALL    CHKTRIP         ;CONTROLLO SE LA DIFFERENZA DI VELOCITA' 
 4499                                                         ;IN VALORE ASSOLUTO
 4500                                                         ;E' SUPERIORE A TRIP
 4501                 
 4502  19C4 ED4B0AC3                  LD      BC,(VELMED)     ;SALVO LA VELOCITA PER FARE IL CALCOLO DEL TRIP
 4503  19C8 ED4304C3                  LD      (VELPRE),BC     ;AL PROSSIMO GIRO
 4504  19CC           MEDV05:        
 4505  19CC C9                        RET
 4506                 
 4507                 
 4508                 
 4509                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4510                 ;               SUBROUTINE CONTROLLO SE LA DIFFERENZA DI VELOCITA' 
 4511                 ;               IN VALORE ASSOLUTO E' SUPERIORE A TRIP
 4512                 ;               SE VERO... MESSAGGIO ACCELERA O DECELERA SU DISPLAY
 4513                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4514                 
 4515  19CD           CHKTRIP:
 4516                                         
 4517  19CD 3A94D0                    LD      A,(AUMALO)      ;SE E'IN MANUALE
 4518  19D0 FE00                      CP      00H             ;ESCO
 4519  19D2 283B                      JR      Z,ENDCHKTRIP
 4520                 
 4521  19D4 DD2178D0                  LD      IX,TRIP         ;SE TRIP=0 
 4522                 
 4523  19D8 DD7E00                    LD      A,(IX)          ;SE TRIP=0 
 4524  19DB FE00                      CP      00H             ;ESCO
 4525  19DD 2830                      JR      Z,ENDCHKTRIP    ;
 4526                                 
 4527                 ;                LD      A,(PROVEL)      ;SE IN PROTEZIONE 
 4528                 ;                CP      01H             ;(ALLARME) ATTIVO
 4529                 ;                JR      Z,ENDCHKTRIP    ;ESCO
 4530                                 
 4531  19DF 2A0AC3                    LD      HL,(VELMED)     ;CONTROLLO SE
 4532  19E2 ED5B04C3                  LD      DE,(VELPRE)     ;TRA LA NUOVA 
 4533  19E6 ED52                      SBC     HL,DE           ;E LA VECCHIA 
 4534  19E8 380C                      JR      C,CHKTRIPD      ;VELOCITA'C'E' 
 4535  19EA 7D                        LD      A,L             ;UN DIFFERENZA
 4536  19EB DDBE00                    CP      (IX)            ;TRIP IN METRI 
 4537  19EE FA0C1A                    JP      M,NO_TRIP       ;IN PIU' CHE
 4538  19F1 CDA10B                    CALL    ACCEL           ;MENO SE C'E'
 4539  19F4 1819                      JR      ENDCHKTRIP      ;BLOCCO CON
 4540                 
 4541  19F6 3F        CHKTRIPD:       CCF                     ;LA SCRITTA  
 4542  19F7 2A04C3                    LD      HL,(VELPRE)     ;APPROPIATA
 4543  19FA ED5B0AC3                  LD      DE,(VELMED)
 4544  19FE ED52                      SBC     HL,DE
 4545  1A00 7D                        LD      A,L
 4546  1A01 DDBE00                    CP      (IX)                         
 4547  1A04 FA0C1A                    JP      M,NO_TRIP
 4548  1A07 CD8A0B                    CALL    DECEL
 4549  1A0A 1803                      JR      ENDCHKTRIP      ;BLOCCO CON
 4550  1A0C           NO_TRIP:
 4551  1A0C CDB80B                    CALL    VELCOST
 4552  1A0F           ENDCHKTRIP:
 4553  1A0F C9                        RET
 4554                 
 4555                 
 4556                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4557                 ;               TRASMISSIONE LED CORREZIONI
 4558                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4559                 
 4560  1A10           SEND_LED:
 4561  1A10 D9                        EXX
 4562  1A11 3A3EC3                    LD      A,(MEMLED)      ;SE E' UGUALE
 4563  1A14 47                        LD      B,A             ;ALLA PRECEDENTE
 4564  1A15 3A9CC0                    LD      A,(MEMC)        ;SALTO 
 4565  1A18 E6EB                      AND     0EBH            ;0C3H
 4566  1A1A B8                        CP      B
 4567  1A1B 2827                      JR      Z,SEND_LED_FINE
 4568  1A1D 5F                        LD      E,A
 4569                 
 4570  1A1E CDCC05                    CALL    REQISFREE
 4571  1A21 3AC126                    LD      A,(LEGGI)       ;CORREZIONE 
 4572  1A24 32C0C1                    LD      (ARR_TRASM+00H),A  ;AVANTI
 4573  1A27 3AB226                    LD      A,(STATLED)
 4574  1A2A 32C1C1                    LD      (ARR_TRASM+01H),A
 4575  1A2D 1600                      LD      D,00H
 4576  1A2F 21C2C1                    LD      HL,ARR_TRASM+02H
 4577  1A32 72                        LD      (HL),D
 4578  1A33 23                        INC     HL
 4579  1A34 3A9CC0                    LD      A,(MEMC)        ;STATO CORREZIONE
 4580  1A37 E6EB                      AND     0EBH            ;0C3H
 4581  1A39 77                        LD      (HL),A
 4582  1A3A CD0806                    CALL    REQUEST
 4583                 
 4584  1A3D 3A9CC0                    LD      A,(MEMC)        ;STATO CORREZIONE
 4585  1A40 323EC3                    LD      (MEMLED),A
 4586                 
 4587  1A43 D9                        EXX
 4588  1A44           SEND_LED_FINE:
 4589  1A44 C9                        RET
 4590                 
 4591                 
 4592                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4593                 ;               RESET USCITE CORREZIONE
 4594                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4595                 
 4596  1A45           RESEPC:
 4597  1A45 3A9CC0                    LD      A,(MEMC)        
 4598  1A48 CB87                      RES     B_PC_AVANTI,A
 4599  1A4A CB8F                      RES     B_PC_RITARDO,A
 4600  1A4C CBAF                      RES     B_PC_FUNZ,A
 4601  1A4E CBB7                      RES     B_PC_DESTRA,A
 4602  1A50 CBBF                      RES     B_PC_SINISTRA,A
 4603  1A52 329CC0                    LD      (MEMC),A
 4604  1A55 D363                      OUT     (PC),A
 4605                 
 4606  1A57 C9        RESPE1:         RET
 4607                 
 4608                 
 4609                 
 4610                 
 4611                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4612                 ;               CALCOLO VARIABILI PER MEDIA ERRORE LONG.
 4613                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4614                 
 4615                 
 4616  1A58           VARERR:                                  ;
 4617  1A58 3A6CD0                    LD      A,(CICLO)
 4618  1A5B FE09                      CP      09H
 4619  1A5D 3010                      JR      NC,MECI01
 4620  1A5F 3E07                      LD      A,07H
 4621  1A61 325EC3                    LD      (PRIMOB),A
 4622  1A64 3C                        INC     A
 4623  1A65 3260C3                    LD      (SECONB),A
 4624  1A68 3E0C                      LD      A,0CH
 4625  1A6A 3262C3                    LD      (VALORX),A
 4626  1A6D 183C                      JR      MECI04
 4627  1A6F           MECI01:
 4628  1A6F 3A6CD0                    LD      A,(CICLO)
 4629  1A72 FE11                      CP      11H             ;= 17
 4630  1A74 3010                      JR      NC,MECI02
 4631  1A76 3E0F                      LD      A,0FH
 4632  1A78 325EC3                    LD      (PRIMOB),A
 4633  1A7B 3C                        INC     A
 4634  1A7C 3260C3                    LD      (SECONB),A
 4635  1A7F 3E1C                      LD      A,1CH           ;= 28
 4636  1A81 3262C3                    LD      (VALORX),A
 4637  1A84 1825                      JR      MECI04
 4638  1A86           MECI02:
 4639  1A86 3A6CD0                    LD      A,(CICLO)
 4640  1A89 FE21                      CP      21H             ;= 33
 4641  1A8B 3010                      JR      NC,MECI03
 4642  1A8D 3E1F                      LD      A,1FH           ;= 31
 4643  1A8F 325EC3                    LD      (PRIMOB),A
 4644  1A92 3C                        INC     A
 4645  1A93 3260C3                    LD      (SECONB),A
 4646  1A96 3E3C                      LD      A,3CH           ;= 60
 4647  1A98 3262C3                    LD      (VALORX),A
 4648  1A9B 180E                      JR      MECI04
 4649  1A9D           MECI03:
 4650  1A9D 3E2F                      LD      A,2FH           ;= 47
 4651  1A9F 325EC3                    LD      (PRIMOB),A
 4652  1AA2 3C                        INC     A
 4653  1AA3 3260C3                    LD      (SECONB),A
 4654  1AA6 3E5C                      LD      A,5CH           ;= 92
 4655  1AA8 3262C3                    LD      (VALORX),A
 4656  1AAB           MECI04:
 4657                                 
 4658                                 
 4659  1AAB ED5B6CD0                  LD      DE,(CICLO)      ;CALCOLO DEL 
 4660  1AAF ED5306C0                  LD      (MOLTI),DE      ;75% DEL CICLO
 4661  1AB3 3E19                      LD      A,19H           ;CHE VIENE USATO
 4662  1AB5 3208C0                    LD      (MOLPL),A       ;ALL'INIZIO DELLE
 4663  1AB8 CD8D14                    CALL    MOLT            ;EXTRA CORREZ.
 4664  1ABB ED5B0AC0                  LD      DE,(PROD)       ;PER FAR SI CHE
 4665  1ABF ED5300C0                  LD      (DIVDEN),DE     ;VI SIA UNA 
 4666  1AC3 016400                    LD      BC,64H          ;BREVE INTERRU-
 4667  1AC6 ED4302C0                  LD      (DIVSOR),BC     ;ZIONE PER 
 4668  1ACA CD6514                    CALL    DIVIS           ;EVITARE LA
 4669  1ACD ED5B04C0                  LD      DE,(QUOZIE)     ;CORREZIONE
 4670  1AD1 2A6CD0                    LD      HL,(CICLO)      ;CONTINUA
 4671  1AD4 ED52                      SBC     HL,DE
 4672  1AD6 222AD0                    LD      (CICL75),HL
 4673                 
 4674  1AD9 C9                        RET
 4675                 
 4676                 
 4677                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4678                 ;               VERIFICA VALORI DI SVILUPPO CILINDRO E AMPIEZZA GATE
 4679                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4680                 
 4681  1ADA           CHK_CILINDRO_GATE:
 4682  1ADA 2A64D0                    LD      HL,(CILMOL)
 4683  1ADD 227EC0                    LD      (COMP16B),HL
 4684                 
 4685  1AE0 21DC05                    LD      HL,05DCH                ;CILINDRO MINIMO 150MM
 4686  1AE3 227CC0                    LD      (COMP16A),HL
 4687  1AE6 CD3814                    CALL    COMPARE16               ; 1500 <=> CILMOL
 4688  1AE9 3A7CC0                    LD      A,(COMP16A)
 4689  1AEC FE01                      CP      01                      ; 1500 >   CILMOL       
 4690  1AEE 2812                      JR      Z,CHK_CILINDRO_NO
 4691                 
 4692                 
 4693  1AF0 21A861                    LD      HL,061A8H               ;CILINDRO MASSIMO 2500MM
 4694  1AF3 227CC0                    LD      (COMP16A),HL
 4695  1AF6 CD3814                    CALL    COMPARE16               ;25000 <=> CILMOL
 4696  1AF9 3A7CC0                    LD      A,(COMP16A)
 4697  1AFC FE02                      CP      02                      ;25000 <  CILMOL        
 4698  1AFE 2802                      JR      Z,CHK_CILINDRO_NO
 4699                                 
 4700  1B00 1809                      JR      CHK_CILINDRO_OK         ;150<CILIN<2500
 4701                 
 4702  1B02           CHK_CILINDRO_NO:
 4703  1B02 ED5BDC26                  LD      DE,(S_SVILUPPO_CILINDRO)
 4704  1B06 CD7106                    CALL    SET_STATUS
 4705  1B09 1809                      JR      CHK_GATE
 4706                 
 4707  1B0B           CHK_CILINDRO_OK:
 4708  1B0B ED5BDC26                  LD      DE,(S_SVILUPPO_CILINDRO)
 4709  1B0F CD8006                    CALL    RES_STATUS
 4710  1B12 1800                      JR      CHK_GATE
 4711                 
 4712                 
 4713  1B14           CHK_GATE:
 4714  1B14 2A68D0                    LD      HL,(AMPGA)
 4715  1B17 227EC0                    LD      (COMP16B),HL
 4716                 
 4717  1B1A 210500                    LD      HL,0005H                ;GATE MINIMO 5MM
 4718  1B1D 227CC0                    LD      (COMP16A),HL
 4719  1B20 CD3814                    CALL    COMPARE16               ; 5   <=> GATE
 4720  1B23 3A7CC0                    LD      A,(COMP16A)
 4721  1B26 FE01                      CP      01                      ; 5   >   GATE  
 4722  1B28 2812                      JR      Z,CHK_GATE_NO
 4723                 
 4724                 
 4725  1B2A 215802                    LD      HL,0258H                ;GATE MASSIMO 600MM
 4726  1B2D 227CC0                    LD      (COMP16A),HL
 4727  1B30 CD3814                    CALL    COMPARE16               ;600 <=> GATE
 4728  1B33 3A7CC0                    LD      A,(COMP16A)
 4729  1B36 FE02                      CP      02                      ;600 <  GATE    
 4730  1B38 2802                      JR      Z,CHK_GATE_NO
 4731                                 
 4732  1B3A 1809                      JR      CHK_GATE_OK             ;5<GATE<600
 4733                 
 4734  1B3C           CHK_GATE_NO:
 4735  1B3C ED5BDE26                  LD      DE,(S_AMPIEZZA_GATE)
 4736  1B40 CD7106                    CALL    SET_STATUS
 4737  1B43 1809                      JR      CHK_CILINDRO_GATE_FINE
 4738                 
 4739  1B45           CHK_GATE_OK:
 4740  1B45 ED5BDE26                  LD      DE,(S_AMPIEZZA_GATE)
 4741  1B49 CD8006                    CALL    RES_STATUS
 4742  1B4C 1800                      JR      CHK_CILINDRO_GATE_FINE
 4743                 
 4744  1B4E           CHK_CILINDRO_GATE_FINE:
 4745  1B4E C9                        RET                     
 4746                 
 4747                 
 4748                 
 4749                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4750                 ;               TRASMISSIONE CON ST7
 4751                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4752                 
 4753                 
 4754                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4755                 ;               ST7:    IDENTIFICAZIONE PARAMETRO/FUNZIONE
 4756                 ;                       GESTIONE PRIMI DUE BYTES        
 4757                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4758                 
 4759  1B4F           ANALI1:
 4760  1B4F 3AC4C1                    LD      A,(ARR_TRASM+04H)
 4761  1B52 21C126                    LD      HL,LEGGI
 4762  1B55 BE                        CP      (HL)
 4763  1B56 2807                      JR      Z,ANA10
 4764  1B58 21C226                    LD      HL,SCRIVI
 4765  1B5B BE                        CP      (HL)
 4766  1B5C 2801                      JR      Z,ANA10
 4767  1B5E C9                        RET
 4768                 
 4769  1B5F           ANA10:
 4770  1B5F 3AC4C1                    LD      A,(ARR_TRASM+04H)               ;COPIA B4 IN B0
 4771  1B62 32C0C1                    LD      (ARR_TRASM+00H),A
 4772  1B65 3AC5C1                    LD      A,(ARR_TRASM+05H)               ;COPIA B5 IN B1
 4773  1B68 32C1C1                    LD      (ARR_TRASM+01H),A
 4774                 
 4775  1B6B 3AC5C1                    LD      A,(ARR_TRASM+05H)               ;MOLTIPLICA PER 2
 4776  1B6E 3001                      JR      NC,ANA11                ;E LO SALVA IN A
 4777  1B70 3F                        CCF     
 4778  1B71 17        ANA11:          RLA
 4779                                 
 4780  1B72 6F                        LD      L,A                     ;SOMMA IL VALORE RICEVUTO
 4781  1B73 2600                      LD      H,00H                   ;ALLA TRABELLA DI TRANSCODIFICA
 4782  1B75 1100C2                    LD      DE,ARR_TAB_IDX
 4783  1B78 19                        ADD     HL,DE
 4784  1B79 5E                        LD      E,(HL)                  ;HO L'AREA DI MEMORIA INDIRIZZATA IN DE
 4785  1B7A 23                        INC     HL
 4786  1B7B 56                        LD      D,(HL)
 4787  1B7C EB                        EX      DE,HL
 4788  1B7D 56                        LD      D,(HL)                  ;SCRIVO IN HL IL VALORE INDIRIZZATO DA DE
 4789  1B7E 23                        INC     HL
 4790  1B7F 5E                        LD      E,(HL)
 4791  1B80 ED53C2C1                  LD      (ARR_TRASM+02H),DE
 4792  1B84 C9                        RET     
 4793                 
 4794                 
 4795                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 4796                 ;               ST7:    SECONDA IDENTIFICAZIONE PARAMETRI
 4797                 ;                       GESTIONE ULTIMI DUE BYTES       
 4798                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 4799                 
 4800  1B85           ANALI2:
 4801  1B85 3AC4C1                    LD      A,(ARR_TRASM+04H)
 4802  1B88 21C226                    LD      HL,SCRIVI
 4803  1B8B BE                        CP      (HL)
 4804  1B8C 2805                      JR      Z,ANA20
 4805  1B8E BE                        CP      (HL)
 4806  1B8F D2081C                    JP      NC,ANA30
 4807  1B92 C9                        RET
 4808  1B93           ANA20:
 4809  1B93 3AC5C1                    LD      A,(ARR_TRASM+05H)       ;MOLTIPLICA PER 2
 4810  1B96 3001                      JR      NC,ANA21                ;E LO SALVA IN A
 4811  1B98 3F                        CCF     
 4812  1B99           ANA21:          
 4813  1B99 17                        RLA
 4814  1B9A 6F                        LD      L,A                     ;SOMMA IL VALORE RICEVUTO
 4815  1B9B 2600                      LD      H,00H                   ;ALLA TRABELLA DI TRANSCODIFICA
 4816  1B9D 1100C2                    LD      DE,ARR_TAB_IDX
 4817  1BA0 19                        ADD     HL,DE
 4818  1BA1 5E                        LD      E,(HL)                  ;HO L'AREA DI MEMORIA INDIRIZZATA IN DE
 4819  1BA2 23                        INC     HL
 4820  1BA3 56                        LD      D,(HL)
 4821  1BA4 EB                        EX      DE,HL
 4822  1BA5 ED5BC6C1                  LD      DE,(ARR_TRASM+06H)
 4823  1BA9 72                        LD      (HL),D
 4824  1BAA 23                        INC     HL
 4825  1BAB 73                        LD      (HL),E
 4826                 
 4827  1BAC 3AC5C1                    LD      A,(ARR_TRASM+05H)       
 4828  1BAF 21AB26                    LD      HL,CILINT               ;SE CILINDRO, ESEGUO CALCOLI RELATIVI
 4829  1BB2 BE                        CP      (HL)                    
 4830  1BB3 281A                      JR      Z,ANA22                 
 4831                 
 4832  1BB5 21AC26                    LD      HL,AMPGAT               ;SE AMPIEZZA GATE, ESEGUO CALCOLI RELATIVI
 4833  1BB8 BE                        CP      (HL)
 4834  1BB9 2814                      JR      Z,ANA22 
 4835                 
 4836  1BBB 21BE26                    LD      HL,ENCSEGN              ;SE NUOVA POSIZIONE FASE ESEGUO LE MODIFICHE RELATIVE
 4837  1BBE BE                        CP      (HL)
 4838  1BBF 2813                      JR      Z,ANA23
 4839                 
 4840  1BC1 21B426                    LD      HL,BASEVALDAC           ;SE NUOVA BASE PER DAC ESEGUO IL CALCOLO DI DACBASE
 4841  1BC4 BE                        CP      (HL)
 4842  1BC5 2830                      JR      Z,ANA24
 4843                 
 4844  1BC7 21C026                    LD      HL,OFFSETVALDAC         ;SE NUOVO OFFSET PER DAC ESEGUO IL CALCOLO DI DACBASE
 4845  1BCA BE                        CP      (HL)
 4846  1BCB 282A                      JR      Z,ANA24
 4847                 
 4848  1BCD 1838                      JR      ANALI2_FINE
 4849                 
 4850  1BCF           ANA22:          
 4851  1BCF CD4320                    CALL    CAL_CILINDRO            
 4852  1BD2 1833                      JR      ANALI2_FINE
 4853                 
 4854  1BD4           ANA23:
 4855                                 ;RESET IL CTC CON IN NUOVO VALORE       
 4856                 
 4857  1BD4 3E00                      LD      A,00H                   ;IMPONGO MANUALE
 4858  1BD6 3294D0                    LD      (AUMALO),A
 4859  1BD9 3298D0                    LD      (AUMATI),A      
 4860  1BDC 3296D0                    LD      (AUMATR),A      
 4861                 
 4862  1BDF CD451A                    CALL    RESEPC                  ;ANNULLO COMANDI
 4863                 
 4864                 
 4865  1BE2 2A0CD0                    LD      HL,(FASE)               ;SPOSTO IL PUNTO DI FASE
 4866  1BE5 7C                        LD      A,H
 4867  1BE6 D320                      OUT     (20H),A         
 4868  1BE8 7D                        LD      A,L
 4869  1BE9 D310                      OUT     (10H),A
 4870                 
 4871  1BEB 3E05                      LD      A,05H                   ;SETTO AUTOCENTRA PER FAR SI CHE APPENA IL SEGNO VIENE TROVATO
 4872  1BED 3264C3                    LD      (AUTOCENTRA),A          ;IL GATE SI AUTOCENTRI
 4873                 
 4874  1BF0 3E05                      LD      A,C_MEMRIF              ;4 GIRI ATTESA
 4875  1BF2 321ED0                    LD      (MEMRIF),A              ;PER MEMORIZZARE
 4876  1BF5 1810                      JR      ANALI2_FINE
 4877                 
 4878  1BF7           ANA24:                                          ;SE NUOVO VALORE BASE DI DAC (0-1000)
 4879  1BF7 CD861D                    CALL    CONVERT_DAC_BASE        ;AGGIORNO IL VALORE CORRENTE  (0-4096)
 4880  1BFA ED5BA8D0                  LD      DE,(DACBASE)            ;E AGGIORNO DAC
 4881  1BFE ED5320C3                  LD      (DACVAL),DE
 4882  1C02 CDD31D                    CALL    DAC_TRASM
 4883                 
 4884  1C05 1800                      JR      ANALI2_FINE
 4885  1C07           ANALI2_FINE:            
 4886  1C07 C9                        RET
 4887                 
 4888                 
 4889                 
 4890  1C08           ANA30:
 4891  1C08 3AC4C1                    LD      A,(ARR_TRASM+04H)
 4892  1C0B 21C326                    LD      HL,AUTFAS
 4893  1C0E BE                        CP      (HL)
 4894  1C0F 2006                      JR      NZ,ANA30_1
 4895  1C11 CD5F25                    CALL    FUNZ_AUTO_PHASE         ;FASATURA AUTOMATICA
 4896  1C14 C3921C                    JP      ANA30_FINE
 4897                 
 4898  1C17           ANA30_1:
 4899  1C17 21C526                    LD      HL,TESTES
 4900  1C1A BE                        CP      (HL)
 4901  1C1B 2006                      JR      NZ,ANA30_2
 4902  1C1D CD9225                    CALL    TEST_SH                 ;TEST DELLA TESTA
 4903  1C20 C3921C                    JP      ANA30_FINE
 4904                 
 4905  1C23           ANA30_2:
 4906  1C23 21C626                    LD      HL,TESENC
 4907  1C26 BE                        CP      (HL)
 4908  1C27 2006                      JR      NZ,ANA30_3
 4909  1C29 CDE11E                    CALL    TEST_ENCODER            ;TEST DELL'ENCODER
 4910  1C2C C3921C                    JP      ANA30_FINE
 4911                 
 4912  1C2F           ANA30_3:
 4913  1C2F 21C826                    LD      HL,SHDATO               
 4914  1C32 BE                        CP      (HL)
 4915  1C33 2005                      JR      NZ,ANA30_4
 4916  1C35 CD1B1F                    CALL    LTSHIFT         ;VALORE DELLO SHIFT (IN AUTOMATICO)
 4917  1C38 1858                      JR      ANA30_FINE
 4918                 
 4919  1C3A           ANA30_4:
 4920  1C3A 21C926                    LD      HL,SHMANU
 4921  1C3D BE                        CP      (HL)
 4922  1C3E 2005                      JR      NZ,ANA30_5
 4923  1C40 CD8D1F                    CALL    CORREZIONE_MANUALE      ;SPOSTAMENTO MANUALE
 4924  1C43 184D                      JR      ANA30_FINE
 4925                 
 4926  1C45           ANA30_5:
 4927  1C45 21CA26                    LD      HL,SHSTOP
 4928  1C48 BE                        CP      (HL)
 4929  1C49 2005                      JR      NZ,ANA30_6
 4930  1C4B CD2F20                    CALL    STOP_CORREZIONE_MANUALE
 4931  1C4E 1842                      JR      ANA30_FINE
 4932                 
 4933  1C50           ANA30_6:
 4934  1C50 21CB26                    LD      HL,NORDF9               
 4935  1C53 BE                        CP      (HL)
 4936  1C54 2005                      JR      NZ,ANA30_7
 4937  1C56 CD260B                    CALL    F9_ON                   ;FUNZIONE COLD SEAL
 4938  1C59 1837                      JR      ANA30_FINE
 4939                 
 4940  1C5B           ANA30_7:
 4941  1C5B 21CC26                    LD      HL,INIPAR               
 4942  1C5E BE                        CP      (HL)
 4943  1C5F 2005                      JR      NZ,ANA30_8
 4944  1C61 CDF21E                    CALL    FUNZ_INIT               ;FUNZIONE INIZIALIZZAZIONE
 4945  1C64 182C                      JR      ANA30_FINE
 4946                 
 4947  1C66           ANA30_8:
 4948  1C66 21CD26                    LD      HL,AZZERA               ;FUNZIONE ZERO
 4949  1C69 BE                        CP      (HL)
 4950  1C6A 2005                      JR      NZ,ANA30_9
 4951  1C6C CD2125                    CALL    FUNZ_RESET_ERROR        ;FUNZIONE ANNULLA ERRORE
 4952  1C6F 1821                      JR      ANA30_FINE
 4953                 
 4954                 
 4955  1C71           ANA30_9:
 4956  1C71 21CE26                    LD      HL,PULSAN               
 4957  1C74 BE                        CP      (HL)
 4958  1C75 2005                      JR      NZ,ANA30_10
 4959  1C77 CD6525                    CALL    FUNZ_MANUAL_PHASE       ;FASATURA A PULSANTE ESTERNO
 4960  1C7A 1816                      JR      ANA30_FINE
 4961                 
 4962  1C7C           ANA30_10:
 4963  1C7C 21CF26                    LD      HL,TESTOUT              
 4964  1C7F BE                        CP      (HL)
 4965  1C80 2005                      JR      NZ,ANA30_11
 4966  1C82 CD5526                    CALL    USCITE                  ;TEST USCITE
 4967  1C85 180B                      JR      ANA30_FINE
 4968                 
 4969  1C87           ANA30_11:
 4970  1C87 21D026                    LD      HL,FORCERESET           
 4971  1C8A BE                        CP      (HL)
 4972  1C8B 2005                      JR      NZ,ANA30_FINE
 4973  1C8D CD081F                    CALL    FUNZ_RESET              ;FORZA IL RESET DELLA SCHEDA Z80
 4974  1C90 1800                      JR      ANA30_FINE
 4975                 ;
 4976                 ;ANA30_12:
 4977                 ;               LD      HL,FUNZ_TWIN_APP_01             
 4978                 ;               CP      (HL)
 4979                 ;               JR      NZ,ANA30_13
 4980                 ;               LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 1 (NEGATO)        
 4981                 ;                RES     0,A                    ;CAMBIANDO PIN 0 DELLA PORTA D
 4982                 ;                LD      (MEMD),A
 4983                 ;                OUT     (PD),A
 4984                 ;               JR      ANA30_FINE
 4985                 ;
 4986                 ;ANA30_13:
 4987                 ;               LD      HL,FUNZ_TWIN_APP_02             
 4988                 ;               CP      (HL)
 4989                 ;               JR      NZ,ANA30_FINE
 4990                 ;               LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 1 (NEGATO)        
 4991                 ;                SET     0,A                    ;CAMBIANDO PIN 0 DELLA PORTA D
 4992                 ;                LD      (MEMD),A
 4993                 ;                OUT     (PD),A
 4994                 ;               JR      ANA30_FINE
 4995  1C92           ANA30_FINE:
 4996  1C92 C9                        RET
 4997                 
 4998                 
 4999                 
 5000                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5001                 ;               DAC:            INCREMENTO E DECREMENTO VALORE ATTUALE DAC
 5002                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5003  1C93           DAC_INCR_DECR:
 5004                 
 5005                 
 5006                                 ;SE LONGITUDINALE O LATERALE TIRO DISABILITATO, SALTO
 5007  1C93 3AA0D0                    LD      A,(ENB_DAC_LON)
 5008  1C96 FE00                      CP      00H
 5009  1C98 2809                      JR      Z,DAC_INCR_DECR_01
 5010                 
 5011  1C9A 3AA2D0                    LD      A,(ENB_DAC_TRA)
 5012  1C9D FE00                      CP      00H
 5013  1C9F 2802                      JR      Z,DAC_INCR_DECR_01
 5014                 
 5015  1CA1 185A                      JR      DAC_INCR_DECR_FINE
 5016                 
 5017  1CA3           DAC_INCR_DECR_01:
 5018                                 
 5019                 
 5020                                 ;SE REV_CORRECTION INVERTO I VALORI
 5021  1CA3 3A80D0                    LD      A,(REV_CORRECTION)
 5022  1CA6 FE00                      CP      00H
 5023  1CA8 C2B91C                    JP      NZ,DAC_INCR_DECR_02
 5024                 
 5025                                 ;INVERTO I VALORI DI CORREZIONE
 5026  1CAB 2A7AC3                    LD      HL,(DAC_INCREM)
 5027  1CAE ED5B7CC3                  LD      DE,(DAC_DECREM)
 5028  1CB2 ED537AC3                  LD      (DAC_INCREM),DE
 5029  1CB6 227CC3                    LD      (DAC_DECREM),HL
 5030                                 
 5031  1CB9           DAC_INCR_DECR_02:
 5032                                 ;INCREMENTO TEMPORANEAMENTE IL VALORE DEL DAC
 5033  1CB9 2AA8D0                    LD      HL,(DACBASE)
 5034                 
 5035  1CBC ED5B7AC3                  LD      DE,(DAC_INCREM)
 5036  1CC0 19                        ADD     HL,DE
 5037  1CC1 2220C3                    LD      (DACVAL),HL
 5038                 
 5039                 
 5040                 
 5041                                 ;DECREMENTO TEMPORANEAMENTE IL VALORE DEL DAC
 5042                 
 5043                                 ;CONTROLLO SE DACVAL-DAC_DECREM < 0    -->   DACVAL = 0
 5044  1CC4 2A20C3                    LD      HL,(DACVAL)
 5045  1CC7 227CC0                    LD      (COMP16A),HL
 5046  1CCA 2A7CC3                    LD      HL,(DAC_DECREM)
 5047  1CCD 227EC0                    LD      (COMP16B),HL
 5048  1CD0 CD3814                    CALL    COMPARE16
 5049  1CD3 3A7CC0                    LD      A,(COMP16A)
 5050  1CD6 FE02                      CP      02H                     ;DACVAL < DAC_DECREM
 5051  1CD8 2802                      JR      Z,DAC_INCR_DECR_03
 5052  1CDA 1805                      JR      DAC_INCR_DECR_04
 5053                 
 5054  1CDC           DAC_INCR_DECR_03:       ;DACVAL-DAC_DECREM < 0    -->   DACVAL = 0
 5055  1CDC 210000                    LD      HL,0000H
 5056  1CDF 180D                      JR      DAC_INCR_DECR_05
 5057                 
 5058  1CE1           DAC_INCR_DECR_04:       ;DACVAL-DAC_DECREM >= 0    -->   DACVAL = DACVAL-DAC_DECREM
 5059  1CE1 2A20C3                    LD      HL,(DACVAL)
 5060  1CE4 ED5B7CC3                  LD      DE,(DAC_DECREM)
 5061  1CE8 A7                        AND     A               ;RESET CARRY
 5062  1CE9 ED52                      SBC     HL,DE
 5063  1CEB A7                        AND     A               ;RESET CARRY
 5064  1CEC 1800                      JR      DAC_INCR_DECR_05
 5065                 
 5066  1CEE           DAC_INCR_DECR_05:
 5067  1CEE 2220C3                    LD      (DACVAL),HL
 5068  1CF1 CDD31D                    CALL    DAC_TRASM
 5069                 
 5070                                 ;RESET VALORI TEMPORANEI
 5071  1CF4 210000                    LD      HL,0000H
 5072  1CF7 227AC3                    LD      (DAC_INCREM),HL
 5073  1CFA 227CC3                    LD      (DAC_DECREM),HL
 5074                 
 5075  1CFD           DAC_INCR_DECR_FINE:             
 5076  1CFD C9                        RET
 5077                 
 5078                 
 5079                 
 5080                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5081                 ;               DAC:            INCREMENTO E DECREMENTO VALORE BASE DAC
 5082                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5083  1CFE           DAC_INCR_DECR_BASE:
 5084                                 ;SE TIRO DAC DISABILITATO, SALTO
 5085  1CFE 3AA4D0                    LD      A,(ENB_DAC_TIR)
 5086  1D01 FE00                      CP      00H
 5087  1D03 C2851D                    JP      NZ,DAC_INCR_DECR_BASE_FINE
 5088                 
 5089                 
 5090                                 ;SE REV_CORRECTION INVERTO I VALORI
 5091  1D06 3A80D0                    LD      A,(REV_CORRECTION)
 5092  1D09 FE00                      CP      00H
 5093  1D0B C21C1D                    JP      NZ,DAC_INCR_DECR_BASE_01
 5094                 
 5095                                 ;INVERTO I VALORI DI CORREZIONE
 5096  1D0E 2A7EC3                    LD      HL,(DAC_INCREM_BASE)
 5097  1D11 ED5B80C3                  LD      DE,(DAC_DECREM_BASE)
 5098  1D15 ED537EC3                  LD      (DAC_INCREM_BASE),DE
 5099  1D19 2280C3                    LD      (DAC_DECREM_BASE),HL
 5100                 
 5101  1D1C           DAC_INCR_DECR_BASE_01:
 5102                 
 5103                                 ;INCREMENTO TEMPORANEAMENTE IL VALORE DEL DAC
 5104  1D1C 2AA8D0                    LD      HL,(DACBASE)
 5105                 
 5106  1D1F ED5B7EC3                  LD      DE,(DAC_INCREM_BASE)
 5107  1D23 19                        ADD     HL,DE
 5108  1D24 22A8D0                    LD      (DACBASE),HL
 5109                 
 5110                 
 5111  1D27 2AA8D0                    LD      HL,(DACBASE)
 5112  1D2A 227CC0                    LD      (COMP16A),HL
 5113  1D2D 210010                    LD      HL,1000H
 5114  1D30 227EC0                    LD      (COMP16B),HL
 5115  1D33 CD3814                    CALL    COMPARE16
 5116  1D36 3A7CC0                    LD      A,(COMP16A)
 5117                 
 5118  1D39 FE02                      CP      02H                     ;DACBASE < 1000
 5119  1D3B 2806                      JR      Z,DAC_INCR_DECR_BASE_02
 5120                 
 5121  1D3D 210010                    LD      HL,1000H
 5122  1D40 22A8D0                    LD      (DACBASE),HL
 5123                                 
 5124  1D43           DAC_INCR_DECR_BASE_02:
 5125                 
 5126                                 ;DECREMENTO TEMPORANEAMENTE IL VALORE DEL DAC
 5127                 
 5128                                 ;CONTROLLO SE DACBASE-DAC_DECREM < 0    -->   DACBASE = 0
 5129  1D43 2AA8D0                    LD      HL,(DACBASE)
 5130  1D46 227CC0                    LD      (COMP16A),HL
 5131  1D49 2A80C3                    LD      HL,(DAC_DECREM_BASE)
 5132  1D4C 227EC0                    LD      (COMP16B),HL
 5133  1D4F CD3814                    CALL    COMPARE16
 5134  1D52 3A7CC0                    LD      A,(COMP16A)
 5135  1D55 FE02                      CP      02H                     ;DACBASE < DAC_DECREM
 5136  1D57 2802                      JR      Z,DAC_INCR_DECR_BASE_03
 5137  1D59 1805                      JR      DAC_INCR_DECR_BASE_04
 5138                 
 5139  1D5B           DAC_INCR_DECR_BASE_03:  ;DACBASE-DAC_DECREM < 0    -->   DACBASE = 0
 5140  1D5B 210000                    LD      HL,0000H
 5141  1D5E 180D                      JR      DAC_INCR_DECR_BASE_05
 5142                 
 5143  1D60           DAC_INCR_DECR_BASE_04:  ;DACBASE-DAC_DECREM >= 0    -->   DACBASE = DACBASE-DAC_DECREM
 5144  1D60 2AA8D0                    LD      HL,(DACBASE)
 5145  1D63 ED5B80C3                  LD      DE,(DAC_DECREM_BASE)
 5146  1D67 A7                        AND     A               ;RESET CARRY
 5147  1D68 ED52                      SBC     HL,DE
 5148  1D6A A7                        AND     A               ;RESET CARRY
 5149  1D6B 1800                      JR      DAC_INCR_DECR_BASE_05
 5150                 
 5151  1D6D           DAC_INCR_DECR_BASE_05:
 5152  1D6D 22A8D0                    LD      (DACBASE),HL
 5153  1D70 2220C3                    LD      (DACVAL),HL
 5154  1D73 CDD31D                    CALL    DAC_TRASM
 5155                 
 5156  1D76 CDA41D                    CALL    CONVERT_DAC_BASE_1000
 5157  1D79 CDE006                    CALL    SEND_DAC_BASE
 5158                 
 5159                                 ;RESET VALORI TEMPORANEI
 5160  1D7C 210000                    LD      HL,0000H
 5161  1D7F 227EC3                    LD      (DAC_INCREM_BASE),HL
 5162  1D82 2280C3                    LD      (DAC_DECREM_BASE),HL
 5163                 
 5164  1D85           DAC_INCR_DECR_BASE_FINE:                
 5165  1D85 C9                        RET
 5166                 
 5167                 
 5168                 
 5169                 
 5170                 
 5171                 
 5172                 
 5173                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5174                 ;               DAC:            CONVERTO DACBASE1000 (0-1000) IN DACBASE (0-4096)
 5175                 ;                               ;DACBASE = DACOFFSET+(DACBASE1000*4)
 5176                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5177  1D86           CONVERT_DAC_BASE:
 5178  1D86 ED5BA6D0                  LD      DE,(DACBASE1000)        ;AGGIORNO IL VALORE CORRENTE E AGGIORNO DAC
 5179  1D8A ED5306C0                  LD      (MOLTI),DE              
 5180  1D8E 110400                    LD      DE,04H
 5181  1D91 ED5308C0                  LD      (MOLPL),DE
 5182  1D95 CD8D14                    CALL    MOLT
 5183  1D98 ED5B0AC0                  LD      DE,(PROD)
 5184  1D9C 2A92D0                    LD      HL,(DACOFFSET)
 5185  1D9F 19                        ADD     HL,DE
 5186  1DA0 22A8D0                    LD      (DACBASE),HL
 5187  1DA3           CONVERT_DAC_BASE_FINE:          
 5188  1DA3 C9                        RET
 5189                 
 5190                 
 5191                 
 5192                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5193                 ;               DAC:            CONVERTO  DACBASE (0-4096) IN DACBASE1000 (0-1000) 
 5194                 ;                               ;DACBASE1000 = (DACBASE - DACOFFSET)/4 
 5195                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5196  1DA4           CONVERT_DAC_BASE_1000:
 5197  1DA4 A7                        AND     A               ;RESET CARRY
 5198                 
 5199                                 ;DACBASE1000 = (DACBASE - DACOFFSET)/4
 5200  1DA5 2AA8D0                    LD      HL,(DACBASE)
 5201  1DA8 ED5B92D0                  LD      DE,(DACOFFSET)
 5202  1DAC ED52                      SBC     HL,DE
 5203  1DAE 3009                      JR      NC,CONVERT_DAC_BASE_1000_01
 5204                                 
 5205  1DB0 3F                        CCF
 5206  1DB1 210000                    LD      HL,0000H
 5207  1DB4 22A6D0                    LD      (DACBASE1000),HL
 5208  1DB7 1819                      JR      CONVERT_DAC_BASE_1000_FINE
 5209                 
 5210  1DB9           CONVERT_DAC_BASE_1000_01:
 5211  1DB9 22A6D0                    LD      (DACBASE1000),HL
 5212                                 
 5213                                 ;DIVIDO PER 4
 5214  1DBC A7                        AND     A               ;RESET CARRY
 5215  1DBD CB3D                      SRL     L
 5216  1DBF CB3C                      SRL     H
 5217  1DC1 3003                      JR      NC,CONVERT_DAC_BASE_1000_02
 5218                 
 5219  1DC3 3F                        CCF
 5220  1DC4 CBFD                      SET     7,L
 5221                 
 5222  1DC6           CONVERT_DAC_BASE_1000_02:
 5223  1DC6 CB3D                      SRL     L
 5224  1DC8 CB3C                      SRL     H
 5225  1DCA 3003                      JR      NC,CONVERT_DAC_BASE_1000_03
 5226                 
 5227  1DCC 3F                        CCF
 5228  1DCD CBFD                      SET     7,L
 5229  1DCF           CONVERT_DAC_BASE_1000_03:
 5230                 
 5231  1DCF 22A6D0                    LD      (DACBASE1000),HL
 5232  1DD2           CONVERT_DAC_BASE_1000_FINE:             
 5233  1DD2 C9                        RET
 5234                 
 5235                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5236                 ;               DAC:    TRASMISSIONE NUOVO VALORE 
 5237                 ;                       VERSO CONVERTITORE 12 BIT
 5238                 ;                       
 5239                 ;               DAC_CLK         DA3     /PD3
 5240                 ;               DAC_LOAD        DA4     /PD4
 5241                 ;               DAC_SRI         DA5     /PD5
 5242                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5243                 
 5244  1DD3           DAC_TRASM:
 5245  1DD3 C5                        PUSH    BC
 5246  1DD4 D5                        PUSH    DE
 5247  1DD5 E5                        PUSH    HL
 5248                 
 5249  1DD6 3E00                      LD      A,00H           ;AZZERO IL CARRY
 5250  1DD8 17                        RLA
 5251                 
 5252  1DD9 ED5B20C3                  LD      DE,(DACVAL)     ;CARICO IL VALORE IN DE
 5253  1DDD 2ADA26                    LD      HL,(MAXDAC)     ;CONTROLLO CHE SIA INFERIORE
 5254  1DE0 ED52                      SBC     HL,DE           ;AL MASSIMO AMMISSIBILE (4096)
 5255  1DE2 300A                      JR      NC,DAC_TRASM1   
 5256                 
 5257  1DE4 2ADA26                    LD      HL,(MAXDAC)     ;SE SUPERIORE IMPONGO IL MASSIMO
 5258  1DE7 2220C3                    LD      (DACVAL),HL
 5259  1DEA ED5BDA26                  LD      DE,(MAXDAC)
 5260                         
 5261                                 ;TRASMETTO I PRIMI 4 BIT DEL BYTE PIU' SIGNIFICATIVO
 5262  1DEE           DAC_TRASM1:
 5263  1DEE 3E00                      LD      A,00H           ;AZZERO IL CARRY
 5264  1DF0 17                        RLA     
 5265                 
 5266  1DF1 4A                        LD      C,D             ;D CONTIENE MSB DA TRASMETTERE
 5267  1DF2 CB11                      RL      C               ;SHIFTO DI 4 BIT (DAC A 12 BIT)
 5268  1DF4 CB11                      RL      C
 5269  1DF6 CB11                      RL      C
 5270  1DF8 CB11                      RL      C
 5271                 
 5272  1DFA 0604                      LD      B,04H           ;CONTATORE DI CICLO
 5273  1DFC           DAC_TRASM2:     
 5274  1DFC 3A9DC0                    LD      A,(MEMD)        
 5275  1DFF CBDF                      SET     3,A             ;CLOCK BASSO
 5276  1E01 329DC0                    LD      (MEMD),A
 5277  1E04 D351                      OUT     (PD),A
 5278                 
 5279  1E06 CB11                      RL      C               ;SHIFTO DI UN BIT
 5280                 
 5281  1E08 CD571E                    CALL    DAC_TRASM_BIT
 5282                 
 5283  1E0B 3A9DC0                    LD      A,(MEMD)
 5284  1E0E CB9F                      RES     3,A             ;CLOCK ALTO
 5285  1E10 329DC0                    LD      (MEMD),A
 5286  1E13 D351                      OUT     (PD),A
 5287                 
 5288  1E15 3A9DC0                    LD      A,(MEMD)        
 5289  1E18 CBDF                      SET     3,A             ;CLOCK BASSO
 5290  1E1A 329DC0                    LD      (MEMD),A
 5291  1E1D D351                      OUT     (PD),A
 5292                 
 5293  1E1F 10DB                      DJNZ    DAC_TRASM2
 5294                 
 5295                 
 5296                                 ;TRASMETTO IL BYTE MENO SIGNIFICATIVO
 5297  1E21 2608                      LD      H,08H
 5298  1E23 0608                      LD      B,08H           ;E CONTIENE LSB DA TRASMETTERE
 5299  1E25 4B                        LD      C,E
 5300  1E26 3A9DC0    DAC_TRASM3:     LD      A,(MEMD)
 5301                         
 5302  1E29 CB11                      RL      C               ;SHIFTO DI UN BIT
 5303  1E2B CD571E                    CALL    DAC_TRASM_BIT
 5304                                 
 5305  1E2E 25                        DEC     H
 5306  1E2F 2005                      JR      NZ,DAC_TRASM4
 5307                 
 5308  1E31 3A9DC0                    LD      A,(MEMD) 
 5309  1E34 CBE7                      SET     4,A             ;LOAD BASSO
 5310  1E36 CB9F      DAC_TRASM4:     RES     3,A             ;CLOCK ALTO
 5311  1E38 329DC0                    LD      (MEMD),A
 5312  1E3B D351                      OUT     (PD),A
 5313                 
 5314  1E3D 3A9DC0                    LD      A,(MEMD) 
 5315  1E40 CBDF                      SET     3,A             ;CLOCK BASSO
 5316  1E42 329DC0                    LD      (MEMD),A
 5317  1E45 D351                      OUT     (PD),A
 5318                 
 5319  1E47 10DD                      DJNZ    DAC_TRASM3
 5320                 
 5321  1E49 3A9DC0                    LD      A,(MEMD)        
 5322  1E4C CBA7                      RES     4,A             ;LOAD ALTO
 5323  1E4E 329DC0                    LD      (MEMD),A
 5324  1E51 D351                      OUT     (PD),A
 5325                 
 5326  1E53 E1                        POP     HL
 5327  1E54 D1                        POP     DE
 5328  1E55 C1                        POP     BC
 5329                 
 5330  1E56 C9                        RET
 5331                 
 5332                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5333                 ;               DAC:            TRASMETTO BIT DATO IN BASE 
 5334                 ;                               AL VALORE DI CARRY
 5335                 ;
 5336                 ;               DAC_CLK         DA3     
 5337                 ;               DAC_LOAD        DA4     
 5338                 ;               DAC_SRI         DA5     
 5339                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5340  1E57           DAC_TRASM_BIT:
 5341  1E57 3007                      JR      NC,DAC_TRASM_BIT_1 
 5342  1E59 3A9DC0                    LD      A,(MEMD)
 5343  1E5C CBEF                      SET     5,A
 5344  1E5E 1805                      JR      DAC_TRASM_BIT_FINE
 5345  1E60           DAC_TRASM_BIT_1:        
 5346  1E60 3A9DC0                    LD      A,(MEMD)
 5347  1E63 CBAF                      RES     5,A             
 5348  1E65           DAC_TRASM_BIT_FINE:  
 5349  1E65 329DC0                    LD      (MEMD),A
 5350  1E68 D351                      OUT     (PD),A
 5351                                 
 5352  1E6A C9                        RET
 5353                 
 5354                 
 5355                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5356                 ;               ST7:    TRASMISSIONE RICEZIONE 2 BYTE 
 5357                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5358  1E6B           TRASM:
 5359  1E6B 0602                      LD      B,02H           
 5360  1E6D DD7E00    TRAS1:          LD      A,(IX)          
 5361  1E70 CD7E1E                    CALL    TX_RX
 5362  1E73 7A                        LD      A,D
 5363  1E74 FD7700                    LD      (IY),A
 5364  1E77 DD23                      INC     IX
 5365  1E79 FD23                      INC     IY 
 5366  1E7B 10F0                      DJNZ    TRAS1
 5367  1E7D C9                        RET
 5368                 
 5369                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5370                 ;               ST7:    TRASSMISSIONE RICEZIONE 1 BYTE
 5371                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5372                 
 5373  1E7E           TX_RX:     
 5374  1E7E C5                        PUSH    BC              ;TRASMISSIONE
 5375  1E7F 0608                      LD      B,08H           ;RICEZIONE SE-
 5376  1E81 4F                        LD      C,A             ;RIALE PARALLELO
 5377  1E82           TX_RX1:         
 5378  1E82 3A9BC0                    LD      A,(MEMB)        ;IMPOSTO IL BIT DA MANDARE
 5379  1E85 CB11                      RL      C
 5380  1E87 3004                      JR      NC,TX_RX2
 5381  1E89 CBFF                      SET     7,A
 5382  1E8B 1802                      JR      TX_RX3
 5383  1E8D CBBF      TX_RX2:         RES     7,A
 5384  1E8F           TX_RX3:            
 5385  1E8F 329BC0                    LD      (MEMB),A        ;MANDO IL BIT IN TX
 5386  1E92 D301                      OUT     (PB),A
 5387  1E94 3A9BC0                    LD      A,(MEMB)        ;IMPOSTO CLOCK = 1
 5388  1E97 CBC7                      SET     0,A
 5389  1E99 329BC0                    LD      (MEMB),A        
 5390  1E9C D301                      OUT     (PB),A
 5391  1E9E CDD11E                    CALL    SLEEP           ;RITARDO
 5392  1EA1 DB00                      IN      A,(PA)          ;LEGGO IL BIT IN RX     
 5393  1EA3 CB1F                      RR      A               ;SHIFTO PER AVER IL BYTE IN D
 5394  1EA5 CB12                      RL      D
 5395  1EA7 3A9BC0                    LD      A,(MEMB)        ;IMPOSTO CLOCK = 0
 5396  1EAA CB87                      RES     0,A
 5397  1EAC D301                      OUT     (PB),A
 5398  1EAE 329BC0                    LD      (MEMB),A
 5399  1EB1 CDD11E                    CALL    SLEEP           ;RITARDO
 5400  1EB4 10CC                      DJNZ    TX_RX1
 5401  1EB6 C1                        POP     BC
 5402                 
 5403  1EB7 C9                        RET
 5404                 
 5405                 
 5406                 
 5407                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5408                 ;               SLEEP FOR 1 SECOND
 5409                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5410  1EB8           SLEEP_1_SEC:
 5411  1EB8 F5                        PUSH    AF
 5412  1EB9 C5                        PUSH    BC
 5413  1EBA D5                        PUSH    DE
 5414                 
 5415                                 ;LD     E,1AH
 5416  1EBB 1E10                      LD      E,10H
 5417  1EBD 06FF      SLEEP_1_SEC_1:  LD      B,0FFH
 5418  1EBF 16FF      SLEEP_1_SEC_2:  LD      D,0FFH
 5419  1EC1 15        SLEEP_1_SEC_3:  DEC     D
 5420  1EC2 C2C11E                    JP      NZ,SLEEP_1_SEC_3
 5421  1EC5 05                        DEC     B
 5422  1EC6 C2BF1E                    JP      NZ,SLEEP_1_SEC_2
 5423  1EC9 1D                        DEC     E
 5424  1ECA C2BD1E                    JP      NZ,SLEEP_1_SEC_1
 5425                         
 5426  1ECD D1                        POP     DE
 5427  1ECE C1                        POP     BC
 5428  1ECF F1                        POP     AF
 5429                 
 5430  1ED0 C9                        RET
 5431                 
 5432                 
 5433                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5434                 ;               SLEEP
 5435                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5436  1ED1           SLEEP:
 5437  1ED1 E5                        PUSH    HL
 5438  1ED2 2E4A                      LD      L,4AH
 5439  1ED4 2D        SLEEP1:         DEC     L
 5440  1ED5 20FD                      JR      NZ,SLEEP1
 5441  1ED7 E1                        POP     HL
 5442  1ED8 C9                        RET
 5443                 
 5444                 
 5445                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5446                 ;               SLEEP_FAST
 5447                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5448  1ED9           SLEEP_FAST:
 5449  1ED9 E5                        PUSH    HL
 5450  1EDA 2E04                      LD      L,04H
 5451  1EDC 2D        SLEEP_FAST1:    DEC     L
 5452  1EDD 20FD                      JR      NZ,SLEEP_FAST1
 5453  1EDF E1                        POP     HL
 5454  1EE0 C9                        RET
 5455                 
 5456                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5457                 ;               ATTIVA TEST DELL'ENCODER
 5458                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 5459                 
 5460  1EE1           TEST_ENCODER:   
 5461  1EE1 3E00                      LD      A,00H
 5462  1EE3 3294D0                    LD      (AUMALO),A
 5463  1EE6 3296D0                    LD      (AUMATR),A
 5464  1EE9 3298D0                    LD      (AUMATI),A
 5465  1EEC 3E01                      LD      A,01H                   ;SEGNALA LA  
 5466  1EEE 322AC3                    LD      (TEST_ENC),A            ;RICHIESTA DI 
 5467  1EF1 C9                        RET                             ;TEST 
 5468                 
 5469                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5470                 ;               FORZA L'INVIO DI ERRORE, VELOCITA' E STATO DEGLI ALLARMI
 5471                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 5472  1EF2 01FFFF    FUNZ_INIT:      LD      BC,0FFFFH       
 5473  1EF5 ED4356C3                  LD      (ERMEDI_DISP),BC        ;FORZA A MANDARE ERRORE CORRENTE
 5474  1EF9 01FFFF                    LD      BC,0FFFFH       
 5475  1EFC ED4302C3                  LD      (VELDIS),BC             ;FORZA A MANDARE VELOCITA' CORRENTE     
 5476  1F00 01FFFF                    LD      BC,0FFFFH       
 5477  1F03 ED4384C3                  LD      (STATU2),BC             ;FORZA A MANDARE STATO CORRENTE
 5478  1F07 C9                        RET
 5479                 
 5480                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5481                 ;               FORZA IL PROGRAMMA A RIPARTIRE DA VIA (RESET Z80)
 5482                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&               
 5483  1F08 01FFFF    FUNZ_RESET:     LD      BC,0FFFFH
 5484  1F0B ED4300C3                  LD      (RESET),BC
 5485  1F0F 3E00                      LD      A,00H
 5486  1F11 3294D0                    LD      (AUMALO),A
 5487  1F14 3296D0                    LD      (AUMATR),A
 5488  1F17 3298D0                    LD      (AUMATI),A
 5489  1F1A C9                        RET
 5490                 
 5491                 
 5492                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5493                 ;               ST7:    SCELTA SULLE QUATTRO DIREZIONI DI CORREZIONE IN AUTOMATICO
 5494                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5495                                 
 5496  1F1B           LTSHIFT:
 5497  1F1B 3AC5C1                    LD      A,(ARR_TRASM+05H)
 5498  1F1E 21D626                    LD      HL,DIRAVA
 5499  1F21 BE                        CP      (HL)
 5500  1F22 2807                      JR      Z,LTAVA
 5501  1F24 21D726                    LD      HL,DIRRIT
 5502  1F27 BE                        CP      (HL)
 5503  1F28 2807                      JR      Z,LTRIT
 5504                                 ;LD     HL,DIRTRA
 5505                                 ;CP     (HL)
 5506                                 ;JR     Z,LTTRA
 5507                                 ;LD     HL,DIROPE
 5508                                 ;CP     (HL)
 5509                                 ;JR     Z,LTOPE
 5510  1F2A C9                        RET
 5511                 
 5512  1F2B           LTAVA:
 5513  1F2B 7E                        LD      A,(HL)
 5514  1F2C 324AD0                    LD      (AVARIT),A
 5515  1F2F 1804                      JR      LONVAL
 5516  1F31 7E        LTRIT:          LD      A,(HL)
 5517  1F32 324AD0                    LD      (AVARIT),A
 5518  1F35 3AC6C1    LONVAL:         LD      A,(ARR_TRASM+06H)
 5519  1F38 57                        LD      D,A
 5520  1F39 3AC7C1                    LD      A,(ARR_TRASM+07H)
 5521  1F3C 5F                        LD      E,A
 5522  1F3D ED5348D0                  LD      (SHIFT),DE
 5523                 
 5524  1F41 ED5B48D0  LETT2:          LD      DE,(SHIFT)      ;SE E'IN AUTO 
 5525  1F45 2A54D0                    LD      HL,(AMPI40)     ;MENTI MASSIMI 
 5526  1F48 ED52                      SBC     HL,DE           ;GATE
 5527  1F4A 303D                      JR      NC,LETT1
 5528  1F4C 3F                        CCF
 5529  1F4D 3E01                      LD      A,01H
 5530  1F4F 3218C3                    LD      (SUPCOR),A      
 5531                 
 5532  1F52 2A48D0                    LD      HL,(SHIFT)      ;VEDO QUANTE 
 5533  1F55 2200C0                    LD      (DIVDEN),HL     ;VOLTE AMPI40
 5534  1F58 ED4B54D0                  LD      BC,(AMPI40)     ;STA IN SHIFT
 5535  1F5C ED4302C0                  LD      (DIVSOR),BC     ;E LO MEM. IN
 5536  1F60 CD6514                    CALL    DIVIS           ;SHIFT3
 5537  1F63 ED4B04C0                  LD      BC,(QUOZIE)
 5538  1F67 ED431AC3                  LD      (SHIFT3),BC     ;IL RESTO LO
 5539  1F6B ED4B18C0                  LD      BC,(RESTO)      ;MEM IN SHIFT4
 5540  1F6F ED431CC3                  LD      (SHIFT4),BC     ;
 5541  1F73 2A48D0                    LD      HL,(SHIFT)      ;SLAVO LA SUPER 
 5542  1F76 ED5B54D0                  LD      DE,(AMPI40)
 5543  1F7A ED52                      SBC     HL,DE
 5544  1F7C 3003                      JR      NC,LETT3
 5545  1F7E 3F                        CCF
 5546                 
 5547  1F7F 1808                      JR      LETT1
 5548                 
 5549  1F81 ED5B54D0  LETT3:          LD      DE,(AMPI40)     ;CARICO IL MAX 
 5550  1F85 ED5348D0                  LD      (SHIFT),DE      ;ACCETTABILE 
 5551                 
 5552  1F89           LETT1:
 5553  1F89 CD240A                    CALL    SPOSTA
 5554  1F8C C9                        RET
 5555                                 
 5556                 
 5557                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5558                 ;               CORREZIONI IN MANUALE
 5559                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5560                 
 5561                 
 5562  1F8D           CORREZIONE_MANUALE:
 5563  1F8D 3AC5C1                    LD      A,(ARR_TRASM+05H)
 5564  1F90 21D626                    LD      HL,DIRAVA
 5565  1F93 BE                        CP      (HL)
 5566  1F94 2813                      JR      Z,MLTAVA
 5567                 
 5568  1F96 21D726                    LD      HL,DIRRIT
 5569  1F99 BE                        CP      (HL)
 5570  1F9A 2813                      JR      Z,MLTRIT
 5571                 
 5572  1F9C 21D826                    LD      HL,DIRTRA
 5573  1F9F BE                        CP      (HL)
 5574  1FA0 2850                      JR      Z,CORREZIONE_MANUALE_DESTRA
 5575                 
 5576  1FA2 21D926                    LD      HL,DIROPE
 5577  1FA5 BE                        CP      (HL)
 5578  1FA6 2868                      JR      Z,CORREZIONE_MANUALE_SINISTRA
 5579                 
 5580  1FA8 C9                        RET
 5581                 
 5582  1FA9           MLTAVA:
 5583  1FA9 7E                        LD      A,(HL)
 5584  1FAA 324AD0                    LD      (AVARIT),A
 5585  1FAD 1807                      JR      CORREZIONE_MANUALE_AVANTI
 5586  1FAF 7E        MLTRIT:         LD      A,(HL)
 5587  1FB0 324AD0                    LD      (AVARIT),A
 5588  1FB3 181F                      JR      CORREZIONE_MANUALE_RITARDO
 5589  1FB5 C9                        RET
 5590                 
 5591  1FB6           CORREZIONE_MANUALE_AVANTI:         
 5592  1FB6 3A94D0                    LD      A,(AUMALO)      ;SE E' IN AUTOMATICO SALTO
 5593  1FB9 FEFF                      CP      0FFH            
 5594  1FBB 2871                      JR      Z,CORREZIONE_MANUALE_FINE
 5595                 
 5596  1FBD 3A9CC0                    LD      A,(MEMC)
 5597  1FC0 CB8F                      RES     B_PC_RITARDO,A
 5598  1FC2 CBC7                      SET     B_PC_AVANTI,A
 5599  1FC4 329CC0                    LD      (MEMC),A
 5600  1FC7 D363                      OUT     (PC),A          ;MOTORE AVANTI
 5601                 
 5602                 
 5603                                 ;INCREMENTO TEMPORANEAMENTE IL DAC
 5604  1FC9 2AAED0                    LD      HL,(DACMANGUA)
 5605  1FCC 227AC3                    LD      (DAC_INCREM),HL
 5606  1FCF CD931C                    CALL    DAC_INCR_DECR
 5607                 
 5608                 
 5609  1FD2 185A                      JR      CORREZIONE_MANUALE_FINE
 5610                 
 5611  1FD4           CORREZIONE_MANUALE_RITARDO:         
 5612  1FD4 3A94D0                    LD      A,(AUMALO)      ;SE E' IN AUTOMATICO SALTO
 5613  1FD7 FEFF                      CP      0FFH            
 5614  1FD9 2853                      JR      Z,CORREZIONE_MANUALE_FINE
 5615                 
 5616  1FDB 3A9CC0                    LD      A,(MEMC)
 5617  1FDE CB87                      RES     B_PC_AVANTI,A
 5618  1FE0 CBCF                      SET     B_PC_RITARDO,A  ;MOTORE RITARDO
 5619  1FE2 329CC0                    LD      (MEMC),A
 5620  1FE5 D363                      OUT     (PC),A          
 5621                 
 5622                                 ;DECREMENTO TEMPORANEAMENTE IL DAC
 5623  1FE7 2AAED0                    LD      HL,(DACMANGUA)
 5624  1FEA 227CC3                    LD      (DAC_DECREM),HL
 5625  1FED CD931C                    CALL    DAC_INCR_DECR
 5626                 
 5627  1FF0 183C                      JR      CORREZIONE_MANUALE_FINE
 5628                 
 5629                 
 5630  1FF2           CORREZIONE_MANUALE_DESTRA:    ;INCREMENTA TIRO     
 5631  1FF2 3A98D0                    LD      A,(AUMATI)      ;SE E' IN AUTOMATICO SALTO
 5632  1FF5 FEFF                      CP      0FFH
 5633  1FF7 2835                      JR      Z,CORREZIONE_MANUALE_FINE
 5634  1FF9 3A9CC0                    LD      A,(MEMC)
 5635  1FFC CBBF                      RES     B_PC_SINISTRA,A
 5636  1FFE CBF7                      SET     B_PC_DESTRA,A   ;MOTORE TRASMISSIONE
 5637  2000 329CC0                    LD      (MEMC),A
 5638  2003 D363                      OUT     (PC),A          
 5639                 
 5640                                 ;INCREMENTA BASE DAC
 5641  2005 2AACD0                    LD      HL,(DACDELTATIR)
 5642  2008 227EC3                    LD      (DAC_INCREM_BASE),HL
 5643  200B CDFE1C                    CALL    DAC_INCR_DECR_BASE
 5644                 
 5645  200E 181E                      JR      CORREZIONE_MANUALE_FINE
 5646                 
 5647  2010           CORREZIONE_MANUALE_SINISTRA: ;DECREMENTA TIRO         
 5648  2010 3A98D0                    LD      A,(AUMATI)      ;SE E' IN AUTOMATICO SALTO
 5649  2013 FEFF                      CP      0FFH            
 5650  2015 2817                      JR      Z,CORREZIONE_MANUALE_FINE
 5651  2017 3A9CC0                    LD      A,(MEMC)
 5652  201A CBB7                      RES     B_PC_DESTRA,A
 5653  201C CBFF                      SET     B_PC_SINISTRA,A ;MOTORE OPERATORE
 5654  201E 329CC0                    LD      (MEMC),A
 5655  2021 D363                      OUT     (PC),A  
 5656                                 
 5657                                 ;DECREMENTA BASE DAC
 5658  2023 2AACD0                    LD      HL,(DACDELTATIR)
 5659  2026 2280C3                    LD      (DAC_DECREM_BASE),HL
 5660  2029 CDFE1C                    CALL    DAC_INCR_DECR_BASE
 5661                 
 5662  202C 1800                      JR      CORREZIONE_MANUALE_FINE
 5663  202E           CORREZIONE_MANUALE_FINE:
 5664  202E C9                        RET
 5665                 
 5666                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5667                 ;               STOP CORREZIONI IN MANUALE
 5668                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5669                 
 5670  202F           STOP_CORREZIONE_MANUALE:
 5671  202F 3A9CC0                    LD      A,(MEMC)
 5672  2032 CB87                      RES     B_PC_AVANTI,A
 5673  2034 CB8F                      RES     B_PC_RITARDO,A
 5674  2036 CBB7                      RES     B_PC_DESTRA,A
 5675  2038 CBBF                      RES     B_PC_SINISTRA,A
 5676  203A 329CC0                    LD      (MEMC),A
 5677  203D D363                      OUT     (PC),A          ;MOTORE STOP
 5678                 
 5679                                 ;RIPRISTINO IL VALORE DI RIFERIMENTO DEL DAC
 5680  203F CD931C                    CALL    DAC_INCR_DECR
 5681                 
 5682  2042           STOP_CORREZIONE_MANUALE_FINE:
 5683  2042 C9                        RET
 5684                 
 5685                 
 5686                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5687                 ;               CALCOLI RELATIVI ALLO SVILUPPO CILINDRO E GATE
 5688                 ;               VENGONO SEMPRE ESEGUITI ENTRAMBI
 5689                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5690                 
 5691  2043           CAL_CILINDRO:           
 5692  2043 CDDA1A                    CALL    CHK_CILINDRO_GATE
 5693                                                 
 5694                                         
 5695  2046 ED5BDE26                  LD      DE,(S_AMPIEZZA_GATE)    ;CONTROLLO SE ERRORE CILINDRO O GATE
 5696  204A ED4BDC26                  LD      BC,(S_SVILUPPO_CILINDRO)
 5697  204E 2182C3                    LD      HL,STATUS
 5698  2051 3E00                      LD      A,00H
 5699  2053 B2                        OR      D
 5700  2054 B0                        OR      B
 5701  2055 A6                        AND     (HL)
 5702  2056 FE00                      CP      00H
 5703  2058 C2F922                    JP      NZ,CAL_CILINDRO_FINE    ;SE C'E' ERRORE, NON FARE I CALCOLI                     
 5704                 
 5705  205B 23                        INC     HL
 5706  205C 3E00                      LD      A,00H
 5707  205E B3                        OR      E
 5708  205F B1                        OR      C
 5709  2060 A6                        AND     (HL)
 5710  2061 FE00                      CP      00H
 5711  2063 C2F922                    JP      NZ,CAL_CILINDRO_FINE    ;SE C'E' ERRORE, NON FARE I CALCOLI                     
 5712                 
 5713                 
 5714  2066           CAL_CILINDRO_OK:
 5715                 
 5716  2066 ED5B64D0                  LD      DE,(CILMOL)
 5717  206A ED5300C0                  LD      (DIVDEN),DE
 5718  206E 3E0A                      LD      A,000AH
 5719  2070 3202C0                    LD      (DIVSOR),A
 5720  2073 CD6514                    CALL    DIVIS
 5721  2076 ED5B04C0                  LD      DE,(QUOZIE)
 5722  207A ED5328D0                  LD      (CILIN),DE      ;CILIN  = CILMOL/10
 5723                 
 5724  207E ED4B64D0                  LD      BC,(CILMOL)
 5725  2082 ED4332C0                  LD      (MDO032),BC
 5726  2086 110000                    LD      DE,0000H        
 5727  2089 ED5334C0                  LD      (MDO232),DE     
 5728  208D 01E803                    LD      BC,03E8H        
 5729  2090 ED4336C0                  LD      (MRE032),BC      
 5730  2094 ED5338C0                  LD      (MRE232),DE     
 5731  2098 CD9815                    CALL    MOL32
 5732  209B ED4B3AC0                  LD      BC,(PTO032)     
 5733  209F ED5B3CC0                  LD      DE,(PTO232)     ;CILIN x 10000
 5734                 
 5735  20A3 ED433EC0                  LD      (EDEND0),BC
 5736  20A7 ED5340C0                  LD      (EDEND2),DE
 5737  20AB CDED15                    CALL    DIV32_4096
 5738  20AE ED5B42C0                  LD      DE,(QUOZ32)
 5739  20B2 ED533ED0                  LD      (DMILLE),DE     ;(CILIN x 10000) / 4096
 5740                 
 5741  20B6 ED5300C0                  LD      (DIVDEN),DE
 5742  20BA 010A00                    LD      BC,000AH
 5743  20BD ED4302C0                  LD      (DIVSOR),BC
 5744  20C1 CD6514                    CALL    DIVIS
 5745  20C4 ED5B04C0                  LD      DE,(QUOZIE)
 5746  20C8 ED5308D0                  LD      (MILLES),DE     ;(CILIN x 1000) / 4096
 5747                 
 5748  20CC ED5300C0                  LD      (DIVDEN),DE     
 5749  20D0 010A00                    LD      BC,000AH        
 5750  20D3 ED4302C0                  LD      (DIVSOR),BC     
 5751  20D7 CD6514                    CALL    DIVIS           
 5752  20DA ED5B04C0                  LD      DE,(QUOZIE)
 5753  20DE ED5306D0                  LD      (CENTES),DE     ;(CILIN x 100) / 4096
 5754                 
 5755  20E2 ED5B28D0                  LD      DE,(CILIN)      
 5756  20E6 ED5300C0                  LD      (DIVDEN),DE     
 5757  20EA 010A00                    LD      BC,000AH
 5758  20ED ED4302C0                  LD      (DIVSOR),BC
 5759  20F1 CD6514                    CALL    DIVIS
 5760  20F4 ED5B04C0                  LD      DE,(QUOZIE)
 5761  20F8 ED5326D0                  LD      (CILDIV),DE     ;(CILIN / 10)
 5762                 
 5763                 
 5764  20FC 111027                    LD      DE,2710H        
 5765  20FF ED5300C0                  LD      (DIVDEN),DE     
 5766  2103 ED5B3ED0                  LD      DE,(DMILLE) 
 5767  2107 ED5302C0                  LD      (DIVSOR),DE     
 5768  210B CD6514                    CALL    DIVIS           
 5769  210E ED5B04C0                  LD      DE,(QUOZIE)                             
 5770  2112 ED5320D0                  LD      (UNOMIL),DE     ;10000/DMILLE = (4096/CILIN)
 5771                 
 5772  2116 11204E                    LD      DE,4E20H        ;=20000
 5773  2119 ED5300C0                  LD      (DIVDEN),DE
 5774  211D ED4B08D0                  LD      BC,(MILLES)     ;(CILIN x 1000) / 4096
 5775  2121 ED4302C0                  LD      (DIVSOR),BC
 5776  2125 CD6514                    CALL    DIVIS
 5777  2128 2A04C0                    LD      HL,(QUOZIE)
 5778  212B 2238D0                    LD      (MILL20),HL     ;20mm = (20 x 4096) / CILIN
 5779  212E 29                        ADD     HL,HL
 5780  212F 223AD0                    LD      (MILL40),HL     ;40mm = 20+20
 5781                 
 5782                  
 5783                 
 5784  2132 114E0E                    LD      DE,0E4EH        ;4000x4096= 1638400
 5785  2135 ED5332C0                  LD      (MDO032),DE     
 5786  2139 110000                    LD      DE,0000H        ;60\1638400= 0,000003662
 5787  213C ED5334C0                  LD      (MDO232),DE
 5788  2140 ED5338C0                  LD      (MRE232),DE     ;3662=0E4EH
 5789  2144 ED5B28D0                  LD      DE,(CILIN)
 5790  2148 ED5336C0                  LD      (MRE032),DE
 5791  214C 3E02                      LD      A,02H           
 5792  214E 323CC3                    LD      (ALTDIV),A      
 5793  2151 CD9815                    CALL    MOL32
 5794  2154 CDF214                    CALL    DI1000
 5795  2157 ED4B16C0                  LD      BC,(QU1000)
 5796  215B ED4304D0                  LD      (COSVEL),BC     ;COSTANTE VEL. 
 5797                 
 5798                                 
 5799                 
 5800                                 ;CALCOLO VALORI PER RICERCA CODICE
 5801                                 ;AL CAMBIO DI FORMATO
 5802                 
 5803                                 ;########################################
 5804                                 ;# UNOMIL : 2 = IMPULSI DA 2048 IN 1mm  #
 5805                                 ;# NøIMPULSI DA 2048 IN 1 mm X 3 =      #   
 5806                                 ;# SPESSORE SEGNO. LO SPAZIO TRA DUE    #
 5807                                 ;# SEGNI E' DI 7 mm PER CUI LO SPAZIO   #
 5808                                 ;# RIMANENTE E' Nø IMPULSI DA 2048      #
 5809                                 ;# IN 1mm X 4 CIOE'3+1=4                #
 5810                                 ;########################################
 5811                                 
 5812  215F ED5B20D0                  LD      DE,(UNOMIL)
 5813                                 
 5814  2163 CB3B                      SRL     E               ;DIVISO DUE
 5815                 
 5816  2165 7B                        LD      A,E             ;IMPULSI DA 
 5817  2166 3C                        INC     A               ;2048 PER mm+1
 5818  2167 3260D0                    LD      (IMPMIL),A      ;
 5819                 
 5820  216A 43                        LD      B,E             ;PERCHE' 2048
 5821  216B 1600                      LD      D,00H
 5822  216D ED5306C0                  LD      (MOLTI),DE      ;NøIMPULSI X 3
 5823  2171 3E03                      LD      A,03H
 5824  2173 3208C0                    LD      (MOLPL),A
 5825  2176 CD8D14                    CALL    MOLT
 5826  2179 ED5B0AC0                  LD      DE,(PROD)
 5827  217D ED5330D0                  LD      (SEGNO),DE
 5828  2181 78                        LD      A,B             ;NøIMPULSI X 3
 5829  2182 83                        ADD     A,E             ;+1= SPAZIO
 5830  2183 3232D0                    LD      (SPAZIO),A
 5831  2186 ED5B3AD0                  LD      DE,(MILL40)     ;MILL40:2=A
 5832  218A CB3B                      SRL     E               ;40mm IN
 5833  218C 7B                        LD      A,E             ;IMPULSI DA 2048
 5834  218D 3234D0                    LD      (SPAZ40),A      
 5835                                 
 5836  2190           ENTE4:
 5837                               
 5838  2190 ED5B06D0                  LD      DE,(CENTES)     ;
 5839  2194 ED5306C0                  LD      (MOLTI),DE      ;
 5840  2198 3E04                      LD      A,04H
 5841  219A 3208C0                    LD      (MOLPL),A
 5842  219D CD8D14                    CALL    MOLT
 5843  21A0 ED5B0AC0                  LD      DE,(PROD)
 5844  21A4 ED535AD0                  LD      (CENTE4),DE     ;
 5845                 
 5846                 
 5847  21A8 ED5B68D0                  LD      DE,(AMPGA)      ;NORD
 5848  21AC ED5306C0                  LD      (MOLTI),DE      ;MOLTIPLICO
 5849  21B0 3E50                      LD      A,50H           ;AMPIEZZA GATE
 5850  21B2 3208C0                    LD      (MOLPL),A       ;PER 80
 5851  21B5 CD8D14                    CALL    MOLT
 5852  21B8 ED5B0AC0                  LD      DE,(PROD)       
 5853  21BC ED5300C0                  LD      (DIVDEN),DE     ;DIVIDO PER 2
 5854  21C0 010200                    LD      BC,0002H
 5855  21C3 ED4302C0                  LD      (DIVSOR),BC
 5856  21C7 CD6514                    CALL    DIVIS           ;AMPIEZZA 40%  
 5857  21CA ED5B04C0                  LD      DE,(QUOZIE)     ;IN CENTESIMI
 5858  21CE ED534ED0                  LD      (DMEZGA),DE
 5859                 
 5860  21D2 ED5B68D0                  LD      DE,(AMPGA)
 5861  21D6 ED5306C0                  LD      (MOLTI),DE      ;AMPIEZZA GATE
 5862  21DA 3E64                      LD      A,64H           ;PER 100
 5863  21DC 3208C0                    LD      (MOLPL),A
 5864  21DF CD8D14                    CALL    MOLT
 5865  21E2 ED5B0AC0                  LD      DE,(PROD)       ;AMPIEZA IN CENT.
 5866  21E6 ED5300C0                  LD      (DIVDEN),DE
 5867  21EA ED4B5AD0                  LD      BC,(CENTE4)     ;
 5868  21EE ED4302C0                  LD      (DIVSOR),BC
 5869  21F2 CD6514                    CALL    DIVIS           ;AMPIEZZA GATE IN
 5870  21F5 ED5B04C0                  LD      DE,(QUOZIE)     ;IMPULSI ENCODER.
 5871                                 
 5872  21F9 7A                        LD      A,D             ;CONTROLLO SE IL 
 5873  21FA FE00                      CP      00H             ;RISULTATO E'MAG-
 5874  21FC 282E                      JR      Z,ENTE41        ;GIORE DI 255.
 5875  21FE 1600                      LD      D,00H           ;SE LO E'IMPONGO
 5876  2200 1EFF                      LD      E,0FFH          ;COME VALORE MAX
 5877  2202 ED5306C0                  LD      (MOLTI),DE      ;255 E RIPETO LE
 5878  2206 3A5AD0                    LD      A,(CENTE4)      ;OPERAZIONI 
 5879  2209 3208C0                    LD      (MOLPL),A       ;ALL'INVERSO PER
 5880  220C CD8D14                    CALL    MOLT            ;PER CALCOLARE IL
 5881  220F ED5B0AC0                  LD      DE,(PROD)       ;NUOVO AMPAG RI-
 5882  2213 ED5300C0                  LD      (DIVDEN),DE     ;FERITO A 255.
 5883  2217 016400                    LD      BC,0064H
 5884  221A ED4302C0                  LD      (DIVSOR),BC
 5885  221E CD6514                    CALL    DIVIS
 5886  2221 ED5B04C0                  LD      DE,(QUOZIE)
 5887  2225 ED5368D0                  LD      (AMPGA),DE
 5888                 
 5889  2229 C39021                    JP      ENTE4
 5890  222C           ENTE41:      
 5891                                 
 5892  222C ED5322D0                  LD      (AMPIMP),DE     
 5893  2230 ED5306C0                  LD      (MOLTI),DE
 5894  2234 3EB4                      LD      A,0B4H          ;CALCOLO IL 180%  
 5895  2236 3208C0                    LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
 5896  2239 CD8D14                    CALL    MOLT            ;GATE CIOE 45x4
 5897  223C ED5B0AC0                  LD      DE,(PROD)       
 5898  2240 ED5300C0                  LD      (DIVDEN),DE
 5899  2244 016400                    LD      BC,0064H
 5900  2247 ED4302C0                  LD      (DIVSOR),BC
 5901  224B CD6514                    CALL    DIVIS
 5902  224E ED5B04C0                  LD      DE,(QUOZIE)
 5903  2252 ED5324D0                  LD      (MEZGA),DE     ;
 5904                 
 5905  2256 ED5B22D0                  LD      DE,(AMPIMP)     ;CALCOLO DEL         
 5906  225A ED5306C0                  LD      (MOLTI),DE      ;BIANCO 
 5907  225E 3E96                      LD      A,96H           ;CHE E'IL 150%  
 5908  2260 3208C0                    LD      (MOLPL) ,A      ;DI AMPIMP 
 5909  2263 CD8D14                    CALL    MOLT            ;
 5910  2266 ED5B0AC0                  LD      DE,(PROD)       
 5911  226A ED5300C0                  LD      (DIVDEN),DE
 5912  226E 016400                    LD      BC,0064H
 5913  2271 ED4302C0                  LD      (DIVSOR),BC
 5914  2275 CD6514                    CALL    DIVIS
 5915  2278 ED5B04C0                  LD      DE,(QUOZIE)
 5916  227C ED5362D0                  LD      (BIANCO),DE      ;
 5917                         
 5918  2280 ED5B68D0                  LD      DE,(AMPGA)      ; 
 5919  2284 ED5306C0                  LD      (MOLTI),DE
 5920  2288 3E28                      LD      A,28H           ;CALCOLO IL 40% 
 5921  228A 3208C0                    LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
 5922  228D CD8D14                    CALL    MOLT            ;GATE
 5923  2290 ED5B0AC0                  LD      DE,(PROD)       
 5924  2294 ED5354D0                  LD      (AMPI40),DE     ;GATE IN CENTS     
 5925                 
 5926  2298 3A22D0                    LD      A,(AMPIMP)      ;
 5927  229B CB3F                      SRL     A
 5928  229D 3252D0                    LD      (AMPMEZ),A      ;
 5929                 
 5930  22A0 ED5B22D0                  LD      DE,(AMPIMP)     ;CON CKTG0 A  
 5931  22A4 ED5306C0                  LD      (MOLTI),DE      ;1024 MOLTIPL. 
 5932  22A8 3E28                      LD      A,28H           ;PER 40 ANZICHE 
 5933  22AA 3208C0                    LD      (MOLPL),A       ;PER 10 CON CKTG0 
 5934  22AD CD8D14                    CALL    MOLT            ;A 4096
 5935  22B0 ED5B0AC0                  LD      DE,(PROD)
 5936  22B4 ED530AD0                  LD      (AMPI10),DE     
 5937                                 
 5938  22B8 11D007                    LD      DE,7D0H         ;2000 = 20mmX100
 5939  22BB ED5306C0                  LD      (MOLTI),DE
 5940  22BF 3A2ED0                    LD      A,(SEQSEG)
 5941  22C2 3208C0                    LD      (MOLPL),A
 5942  22C5 CD8D14                    CALL    MOLT
 5943  22C8 2A0AC0                    LD      HL,(PROD)
 5944  22CB ED52                      SBC     HL,DE
 5945  22CD 2236D0                    LD      (DISTAN),HL
 5946  22D0 2232C0                    LD      (MDO032),HL     ;CALCOLO
 5947  22D3 010000                    LD      BC,0000H        ;DISTANZA IN
 5948  22D6 ED4334C0                  LD      (MDO232),BC     ;CENTIMILLESIMI
 5949  22DA 21E803                    LD      HL,03E8H
 5950  22DD 2236C0                    LD      (MRE032),HL
 5951  22E0 ED4338C0                  LD      (MRE232),BC
 5952  22E4 CD9815                    CALL    MOL32
 5953  22E7 2A3AC0                    LD      HL,(PTO032)
 5954  22EA 2240D0                    LD      (DISTA0),HL     ;DISTANZA IN
 5955  22ED 2244D0                    LD      (TDIST0),HL     ;CENTIMILLESIMI
 5956  22F0 2A3CC0                    LD      HL,(PTO232)     ;SIA PER LONG.
 5957  22F3 2242D0                    LD      (DISTA2),HL     ;CHE PER TRAVERS
 5958  22F6 2246D0                    LD      (TDIST2),HL
 5959                 
 5960  22F9           CAL_CILINDRO_FINE:
 5961  22F9 C9                        RET                     
 5962                                 
 5963                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5964                 ;               IN BASE AL VALORE DI TWIN_CURRENTAPP
 5965                 ;               SELEZIONO IL VALORE DI USCITA DI PD0
 5966                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5967  22FA           CHK_TWIN_APP:
 5968  22FA 3AB6D0                    LD      A,(TWIN_CURRENTAPP)
 5969  22FD ED5BB2D0                  LD      DE,(TWIN_APP_01)        ;SE APPLICAZIONE CORRENTE = TWIN_01
 5970  2301 BB                        CP      E
 5971  2302 2809                      JR      Z,CHK_TWIN_APP_01
 5972                 
 5973  2304 ED5BB4D0                  LD      DE,(TWIN_APP_02)        ;SE APPLICAZIONE CORRENTE = TWIN_01
 5974  2308 BB                        CP      E
 5975  2309 280E                      JR      Z,CHK_TWIN_APP_02
 5976                 
 5977  230B 1800                      JR      CHK_TWIN_APP_01         ;ALTRIMENTI DEFAULT
 5978                 
 5979  230D           CHK_TWIN_APP_01:
 5980  230D 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 1 (NEGATO)        
 5981  2310 CB87                      RES     0,A                     ;CAMBIANDO PIN 0 DELLA PORTA D
 5982  2312 329DC0                    LD      (MEMD),A
 5983  2315 D351                      OUT     (PD),A
 5984  2317 180C                      JR      CHK_TWIN_APP_FINE
 5985                 
 5986  2319           CHK_TWIN_APP_02:
 5987  2319 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 0 (NEGATO)        
 5988  231C CBC7                      SET     0,A                     ;CAMBIANDO PIN 0 DELLA PORTA D
 5989  231E 329DC0                    LD      (MEMD),A
 5990  2321 D351                      OUT     (PD),A
 5991  2323 1800                      JR      CHK_TWIN_APP_FINE
 5992                 
 5993  2325           CHK_TWIN_APP_FINE:
 5994  2325 C9                        RET
 5995                 
 5996                 
 5997                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 5998                 ;               IN BASE AL VALORE DI SH_P
 5999                 ;               SELEZIONO IL VALORE DI USCITA DI PD2
 6000                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6001  2326           CHK_SH_PN:
 6002  2326 3AC2D0                    LD      A,(SH_PN)
 6003  2329 FE01                      CP      01H
 6004  232B 280E                      JR      Z,CHK_SH_PN_02          ;SE TESTINA NEGATIVA
 6005  232D 1800                      JR      CHK_SH_PN_01            ;ALTRIMENTI DEFAULT
 6006                 
 6007  232F           CHK_SH_PN_01:
 6008  232F 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 1 (NEGATO)        
 6009  2332 CBD7                      SET     2,A                     ;CAMBIANDO PIN 2 DELLA PORTA D
 6010  2334 329DC0                    LD      (MEMD),A
 6011  2337 D351                      OUT     (PD),A
 6012  2339 180C                      JR      CHK_SH_PN_FINE
 6013                 
 6014  233B           CHK_SH_PN_02:
 6015  233B 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 0 (NEGATO)        
 6016  233E CB97                      RES     2,A                     ;CAMBIANDO PIN 2 DELLA PORTA D
 6017  2340 329DC0                    LD      (MEMD),A
 6018  2343 D351                      OUT     (PD),A
 6019  2345 1800                      JR      CHK_SH_PN_FINE
 6020                 
 6021  2347           CHK_SH_PN_FINE:
 6022  2347 C9                        RET
 6023                 
 6024                 
 6025                 
 6026                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6027                 ;               IN BASE AL VALORE DI CURRENT_ENCODER
 6028                 ;               SELEZIONO IL VALORE DI USCITA DI PD1
 6029                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6030  2348           CHK_CURRENT_ENCODER:
 6031  2348 3ABCD0                    LD      A,(CURRENT_ENCODER)
 6032  234B FE01                      CP      01H
 6033  234D 280E                      JR      Z,CHK_CURRENT_ENCODER_01
 6034  234F 1800                      JR      CHK_CURRENT_ENCODER_00          ;ALTRIMENTI DEFAULT
 6035                 
 6036  2351           CHK_CURRENT_ENCODER_00:
 6037  2351 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 1 (NEGATO)        
 6038  2354 CB8F                      RES     1,A                     ;CAMBIANDO PIN 1 DELLA PORTA D
 6039  2356 329DC0                    LD      (MEMD),A
 6040  2359 D351                      OUT     (PD),A
 6041  235B 180C                      JR      CHK_CURRENT_ENCODER_FINE
 6042                 
 6043  235D           CHK_CURRENT_ENCODER_01:
 6044  235D 3A9DC0                    LD      A,(MEMD)                ;IMPONE USCITA SELETTORE A 0 (NEGATO)        
 6045  2360 CBCF                      SET     1,A                     ;CAMBIANDO PIN 1 DELLA PORTA D
 6046  2362 329DC0                    LD      (MEMD),A
 6047  2365 D351                      OUT     (PD),A
 6048  2367 1800                      JR      CHK_CURRENT_ENCODER_FINE
 6049                 
 6050  2369           CHK_CURRENT_ENCODER_FINE:
 6051  2369 C9                        RET
 6052                 
 6053                 
 6054                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6055                 ;               PREPARA VALORE CONTATORE WATCHDOG PER 
 6056                 ;               ATTESA IRQ DI COMUNICAZIONE ST7 (IN REQISFREE)
 6057                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6058                 
 6059  236A           CAL_WATCHDOG_ST7:
 6060                                 
 6061  236A 111400                    LD      DE,WATCHDOG_ST7
 6062  236D ED5332C0                  LD      (MDO032),DE     ;MOLTIPLICANDO BASSO            MOLTIPLICAZIONE 32 BIT 
 6063  2371 110000                    LD      DE,0000H        
 6064  2374 ED5334C0                  LD      (MDO232),DE     ;MOLTIPLICANDO ALTO             MOLTIPLICAZIONE 32 BIT 
 6065                 
 6066  2378 110025                    LD      DE,2500H
 6067  237B ED5336C0                  LD      (MRE032),DE     ;MOLTIPLICATORE BASSO           MOLTIPLICAZIONE 32 BIT 
 6068  237F 110000                    LD      DE,0000H
 6069  2382 ED5338C0                  LD      (MRE232),DE     ;MOLTIPLICATORE ALTO            MOLTIPLICAZIONE 32 BIT
 6070                 
 6071  2386 CD9815                    CALL    MOL32
 6072                 
 6073  2389 ED5B3AC0                  LD      DE,(PTO032)     ;PRODOTTO BASSO                 MOLTIPLICAZIONE 32 BIT 
 6074  238D ED5368C3                  LD      (WATCHDOG_ST7_L),DE
 6075                 
 6076  2391 ED5B3CC0                  LD      DE,(PTO232)     ;PRODOTTO ALTO                  MOLTIPLICAZIONE 32 BIT 
 6077  2395 ED5366C3                  LD      (WATCHDOG_ST7_H),DE
 6078                 
 6079  2399           CAL_WATCHDOG_ST7_FINE:
 6080  2399 C9                        RET
 6081                 
 6082                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6083                 ;               CARICO INDIRIZZI DI MEMORIA DEI PARAMETRI
 6084                 ;               NELLA TABELLA DI TRANSCODIFICA
 6085                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6086                 
 6087  239A           FAITAB:
 6088  239A 2164D0                    LD      HL,CILMOL
 6089  239D 2200C2                    LD      (ARR_TAB_IDX+00H),HL
 6090  23A0 2166D0                    LD      HL,ALLAR                ;*
 6091  23A3 2202C2                    LD      (ARR_TAB_IDX+02H),HL
 6092  23A6 2168D0                    LD      HL,AMPGA                ;*
 6093  23A9 2204C2                    LD      (ARR_TAB_IDX+04H),HL
 6094  23AC 212ED0                    LD      HL,SEQSEG
 6095  23AF 2206C2                    LD      (ARR_TAB_IDX+06H),HL
 6096  23B2 2178D0                    LD      HL,TRIP                 ;*
 6097  23B5 2208C2                    LD      (ARR_TAB_IDX+08H),HL
 6098  23B8 216AD0                    LD      HL,GUADA                ;*
 6099  23BB 220AC2                    LD      (ARR_TAB_IDX+0AH),HL
 6100  23BE 217AD0                    LD      HL,GUATRA
 6101  23C1 220CC2                    LD      (ARR_TAB_IDX+0CH),HL
 6102  23C4 216CD0                    LD      HL,CICLO                ;*
 6103  23C7 220EC2                    LD      (ARR_TAB_IDX+0EH),HL
 6104  23CA 217CD0                    LD      HL,TCICLO
 6105  23CD 2210C2                    LD      (ARR_TAB_IDX+10H),HL
 6106  23D0 2170D0                    LD      HL,ZONA                 ;*
 6107  23D3 2212C2                    LD      (ARR_TAB_IDX+12H),HL
 6108  23D6 2176D0                    LD      HL,ZONT
 6109  23D9 2214C2                    LD      (ARR_TAB_IDX+14H),HL
 6110  23DC 2186D0                    LD      HL,VCLONG
 6111  23DF 2216C2                    LD      (ARR_TAB_IDX+16H),HL
 6112  23E2 2188D0                    LD      HL,VCTRAV
 6113  23E5 2218C2                    LD      (ARR_TAB_IDX+18H),HL
 6114  23E8 2194D0                    LD      HL,AUMALO               ;*
 6115  23EB 221AC2                    LD      (ARR_TAB_IDX+1AH),HL
 6116  23EE 2196D0                    LD      HL,AUMATR
 6117  23F1 221CC2                    LD      (ARR_TAB_IDX+1CH),HL
 6118  23F4 2174D0                    LD      HL,SALTO                ;*
 6119  23F7 221EC2                    LD      (ARR_TAB_IDX+1EH),HL
 6120  23FA 216ED0                    LD      HL,DERIVA               ;*
 6121  23FD 2220C2                    LD      (ARR_TAB_IDX+20H),HL
 6122  2400 2172D0                    LD      HL,INSER                ;*
 6123  2403 2222C2                    LD      (ARR_TAB_IDX+22H),HL
 6124  2406 21B8D0                    LD      HL,LINGUA
 6125  2409 2224C2                    LD      (ARR_TAB_IDX+24H),HL
 6126  240C 2184D0                    LD      HL,SEGRIF
 6127  240F 2226C2                    LD      (ARR_TAB_IDX+26H),HL
 6128  2412 218AD0                    LD      HL,DIAGON
 6129  2415 2228C2                    LD      (ARR_TAB_IDX+28H),HL
 6130  2418 217ED0                    LD      HL,MESSA                ;*
 6131  241B 222AC2                    LD      (ARR_TAB_IDX+2AH),HL
 6132  241E 2180D0                    LD      HL,REV_CORRECTION
 6133  2421 222CC2                    LD      (ARR_TAB_IDX+2CH),HL
 6134  2424 2182D0                    LD      HL,MM_MC
 6135  2427 222EC2                    LD      (ARR_TAB_IDX+2EH),HL
 6136  242A 2100D0                    LD      HL,VERPRO
 6137  242D 2230C2                    LD      (ARR_TAB_IDX+30H),HL
 6138  2430 213CD0                    LD      HL,GUADS1               ;GUADAGNO S1
 6139  2433 2232C2                    LD      (ARR_TAB_IDX+32H),HL
 6140  2436 2100D0                    LD      HL,TAB_DUMMY            ;ERATTU         ;VALORE ASSOLUTO
 6141  2439 2234C2                    LD      (ARR_TAB_IDX+34H),HL
 6142  243C 2100D0                    LD      HL,TAB_DUMMY            ;ERATTU         ;VALORE ASSOLUTO
 6143  243F 2236C2                    LD      (ARR_TAB_IDX+36H),HL
 6144  2442 219CC0                    LD      HL,MEMC                 ;STATO LED CORREZIONE
 6145  2445 2238C2                    LD      (ARR_TAB_IDX+38H),HL
 6146  2448 21A0D0                    LD      HL,ENB_DAC_LON          ;ENABLE DAC LONGITUDINALE
 6147  244B 223AC2                    LD      (ARR_TAB_IDX+3AH),HL
 6148  244E 21A2D0                    LD      HL,ENB_DAC_TRA          ;ENABLE DAC TRASVERSALE
 6149  2451 223CC2                    LD      (ARR_TAB_IDX+3CH),HL    
 6150  2454 21A4D0                    LD      HL,ENB_DAC_TIR          ;ENABLE DAC TIRO
 6151  2457 223EC2                    LD      (ARR_TAB_IDX+3EH),HL
 6152  245A 210AC3                    LD      HL,VELMED               ;VELOCITA
 6153  245D 2240C2                    LD      (ARR_TAB_IDX+40H),HL
 6154  2460 21A6D0                    LD      HL,DACBASE1000          ;VALORE BASE DAC 0-1000
 6155  2463 2242C2                    LD      (ARR_TAB_IDX+42H),HL
 6156  2466 21AAD0                    LD      HL,DACDELTACOR          ;DELTA CORREZIONE DAC
 6157  2469 2244C2                    LD      (ARR_TAB_IDX+44H),HL
 6158  246C 2198D0                    LD      HL,AUMATI               ;MODO AUTOMATICO-MANUALE DI TIRO
 6159  246F 2246C2                    LD      (ARR_TAB_IDX+46H),HL
 6160  2472 21ACD0                    LD      HL,DACDELTATIR          ;DELTA CORREZIONE TIRO DAC
 6161  2475 2248C2                    LD      (ARR_TAB_IDX+48H),HL
 6162  2478 21AED0                    LD      HL,DACMANGUA            ;GUADAGNO MANUALE TIRO
 6163  247B 224AC2                    LD      (ARR_TAB_IDX+4AH),HL
 6164  247E 2182C3                    LD      HL,STATUS
 6165  2481 224CC2                    LD      (ARR_TAB_IDX+4CH),HL
 6166  2484 2190D0                    LD      HL,PRESS
 6167  2487 224EC2                    LD      (ARR_TAB_IDX+4EH),HL
 6168  248A 210CD0                    LD      HL,FASE                 ;POSIZIONE SEGNO
 6169  248D 2250C2                    LD      (ARR_TAB_IDX+50H),HL    ;RISPETTO ENCODER
 6170  2490 21BAD0                    LD      HL,ENCOD                ;SEGNO DI ZERO DELL'ENCODER
 6171  2493 2252C2                    LD      (ARR_TAB_IDX+52H),HL    ;NPN O PNP
 6172  2496 218CD0                    LD      HL,TIRGUA               ;GUADAGNO DI TIRO
 6173  2499 2254C2                    LD      (ARR_TAB_IDX+54H),HL    
 6174  249C 218ED0                    LD      HL,TIRCIC               ;CICLICO DI TIRO
 6175  249F 2256C2                    LD      (ARR_TAB_IDX+56H),HL    
 6176  24A2 219CD0                    LD      HL,ENB_TIRO             ;ENABLE TIRO
 6177  24A5 2258C2                    LD      (ARR_TAB_IDX+58H),HL    
 6178  24A8 219AD0                    LD      HL,ENB_TRASVERSALE      ;ENABLE OP-TRASMISSIONE
 6179  24AB 225AC2                    LD      (ARR_TAB_IDX+5AH),HL    
 6180  24AE 21B0D0                    LD      HL,LAVORO               ;LAVORO CORRENTE
 6181  24B1 225CC2                    LD      (ARR_TAB_IDX+5CH),HL    
 6182  24B4 2110D0                    LD      HL,FASRIF               ;FASE DI RIFERIMENTO
 6183  24B7 225EC2                    LD      (ARR_TAB_IDX+5EH),HL    
 6184  24BA 219ED0                    LD      HL,ENB_COLDSEAL         ;ENABLE COLD SEAL (F9)
 6185  24BD 2260C2                    LD      (ARR_TAB_IDX+60H),HL
 6186  24C0 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6187  24C3 2262C2                    LD      (ARR_TAB_IDX+62H),HL
 6188  24C6 21B2D0                    LD      HL,TWIN_APP_01          ;PRIMA FUNZIONALITA' TWIN
 6189  24C9 2264C2                    LD      (ARR_TAB_IDX+64H),HL
 6190  24CC 21B4D0                    LD      HL,TWIN_APP_02          ;SECONDA FUNZIONALITA' TWIN
 6191  24CF 2266C2                    LD      (ARR_TAB_IDX+66H),HL
 6192  24D2 21B6D0                    LD      HL,TWIN_CURRENTAPP      ;FUNZIONALITA' TWIN CORRENTE
 6193  24D5 2268C2                    LD      (ARR_TAB_IDX+68H),HL
 6194  24D8 21BCD0                    LD      HL,CURRENT_ENCODER      ;ENCODER CORRENTE
 6195  24DB 226AC2                    LD      (ARR_TAB_IDX+6AH),HL
 6196  24DE 21BED0                    LD      HL,F4_DIMENSION         ;DIMENSIONE BIANCO (MM) IN F4
 6197  24E1 226CC2                    LD      (ARR_TAB_IDX+6CH),HL
 6198  24E4 21C0D0                    LD      HL,ENB_SH_PN            ;ABILITA MENU AMPLIFICATORE POSITIVO/NEGATIVO
 6199  24E7 226EC2                    LD      (ARR_TAB_IDX+6EH),HL
 6200  24EA 21C2D0                    LD      HL,SH_PN                ;AMPLIFICATORE POSITIVO/NEGATIVO
 6201  24ED 2270C2                    LD      (ARR_TAB_IDX+70H),HL
 6202  24F0 2192D0                    LD      HL,DACOFFSET            ;VALORE OFFSET DAC
 6203  24F3 2272C2                    LD      (ARR_TAB_IDX+72H),HL
 6204  24F6 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6205  24F9 2274C2                    LD      (ARR_TAB_IDX+74H),HL
 6206  24FC 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6207  24FF 2276C2                    LD      (ARR_TAB_IDX+76H),HL
 6208  2502 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6209  2505 2278C2                    LD      (ARR_TAB_IDX+78H),HL
 6210  2508 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6211  250B 227AC2                    LD      (ARR_TAB_IDX+7AH),HL
 6212  250E 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6213  2511 227CC2                    LD      (ARR_TAB_IDX+7CH),HL
 6214  2514 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6215  2517 227EC2                    LD      (ARR_TAB_IDX+7EH),HL
 6216  251A 2100D0                    LD      HL,TAB_DUMMY            ;CARICA I DUMMY
 6217  251D 2280C2                    LD      (ARR_TAB_IDX+80H),HL
 6218  2520 C9                        RET
 6219                 
 6220                 
 6221                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6222                 ;               AZZERAMENTO DOPO REGISTRO MANUALE
 6223                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6224                 
 6225  2521           FUNZ_RESET_ERROR:          
 6226  2521 3E00                      LD      A,00H                   ;IMPONGO MANUALE
 6227  2523 3294D0                    LD      (AUMALO),A
 6228  2526 3298D0                    LD      (AUMATI),A      
 6229  2529 3296D0                    LD      (AUMATR),A      
 6230  252C 329CC0                    LD      (MEMC),A        
 6231  252F D363                      OUT     (PC),A
 6232                 
 6233  2531 ED4B50C3                  LD      BC,(ERATTU)             ;CARICO L'ERRORE LETTO IN SHIFT 
 6234  2535 ED4348D0                  LD      (SHIFT),BC                                                       
 6235  2539 3A38C3                    LD      A,(MSCORR)              ;VEDO SE IN AVANTI O IN RITARDO
 6236  253C FE01                      CP      D_AVANTI                
 6237  253E 2808                      JR      Z,FUNZ_RESET_ERROR_A   
 6238  2540 3AD626                    LD      A,(DIRAVA)
 6239  2543 324AD0                    LD      (AVARIT),A
 6240  2546 1806                      JR      FUNZ_RESET_ERROR_R
 6241  2548           FUNZ_RESET_ERROR_A:           
 6242  2548 3AD726                    LD      A,(DIRRIT)
 6243  254B 324AD0                    LD      (AVARIT),A
 6244  254E           FUNZ_RESET_ERROR_R:           
 6245  254E CD240A                    CALL    SPOSTA                  ;CHIAMO LA ROUTINE SPOSTA PER CENTRARLO NEL GATE.
 6246                 
 6247  2551 010000                    LD      BC,0000H                ;SVUOTA LA MEDIA
 6248  2554 ED4350C3                  LD      (ERATTU),BC
 6249  2558 CDBC0F                    CALL    RESET_MEDIA
 6250                 
 6251  255B CD1306                    CALL    SEND_OK
 6252                 
 6253  255E           FUNZ_RESET_ERROR_FINE:
 6254  255E C9                        RET
 6255                 
 6256                         
 6257                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6258                 ;               SEGNALAZIONE FASATURA AUTOMATICA
 6259                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6260                 
 6261                 
 6262  255F           FUNZ_AUTO_PHASE:          
 6263  255F 3E01                      LD      A,01H                   ;SET FLAG RICERCA AUTOMATICA
 6264  2561 32D0C1                    LD      (ARR_RICAUTO+00H),A
 6265  2564 C9                        RET                     
 6266                 
 6267                                 
 6268                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6269                 ;               SEGNALAZIONE FASATURA MANUALE
 6270                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6271                 
 6272                 
 6273  2565           FUNZ_MANUAL_PHASE:       
 6274  2565 3E00                      LD      A,00H           ;IMPONGO MANUALE
 6275  2567 329CC0                    LD      (MEMC),A
 6276  256A D363                      OUT     (PC),A
 6277                                 ;CALL   RESEPC          ;NON ESEGUE IL RESET DEGLI ALLARMI
 6278  256C 321AC3                    LD      (SHIFT3),A
 6279  256F 321CC3                    LD      (SHIFT4),A
 6280                 
 6281  2572 DB10                      IN      A,(10H)         ;LEGGO LA POSIZIONE
 6282  2574 6F                        LD      L,A             ;(PULSANTE FASE MANUALE)
 6283  2575 DB20                      IN      A,(20H)
 6284  2577 67                        LD      H,A
 6285  2578 220CD0                    LD      (FASE),HL
 6286  257B 2206C0                    LD      (MOLTI),HL      ;MOLTIPLICO PER 
 6287  257E 3E0A                      LD      A,0AH           ;10 PER AVERE IL
 6288  2580 3208C0                    LD      (MOLPL),A       ;RIFERIMENTO TO-
 6289  2583 CD8D14                    CALL    MOLT            ;TALE TRASCURAN-
 6290  2586 ED5B0AC0                  LD      DE,(PROD)       ;DO IL RAPPORTO
 6291  258A ED5316D0                  LD      (RIFTOT),DE
 6292                 
 6293  258E CDBA09                    CALL    CENTRA        
 6294                 
 6295  2591 C9                        RET
 6296                 
 6297                 
 6298                 
 6299                 
 6300                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6301                 ;               VERIFICA FUNZIONAMENTO TESTA
 6302                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6303                 
 6304  2592           TEST_SH:                
 6305  2592 3A9BC0                    LD      A,(MEMB)
 6306  2595 CBF7                      SET     6,A             ;BLOCCO GATE
 6307  2597 329BC0                    LD      (MEMB),A
 6308  259A D301                      OUT     (PB),A
 6309  259C 16FF                      LD      D,0FFH          ;5 SECONDI
 6310  259E 01000A    TES1:           LD      BC,0A00H        
 6311  25A1 DB01      TES2:           IN      A,(PB)          
 6312  25A3 CB57                      BIT     2,A
 6313  25A5 2017                      JR      NZ,TESSI
 6314  25A7 0B                        DEC     BC              ;DI TEST 
 6315  25A8 78                        LD      A,B
 6316                                 
 6317  25A9 B1                        OR      C                
 6318  25AA 20F5                      JR      NZ,TES2         
 6319  25AC 15                        DEC     D
 6320  25AD 3E00                      LD      A,00H
 6321  25AF BA                        CP      D
 6322  25B0 20EC                      JR      NZ,TES1
 6323  25B2 CD1E06                    CALL    FORCE_STATUS
 6324  25B5 ED5BEC26                  LD      DE,(S_TEST_TESTINA)
 6325  25B9 CD7106                    CALL    SET_STATUS              ;TEST FALLITO
 6326  25BC 180A                      JR      ENDTEST
 6327  25BE           TESSI:
 6328  25BE CD1E06                    CALL    FORCE_STATUS
 6329  25C1 ED5BEC26                  LD      DE,(S_TEST_TESTINA)
 6330  25C5 CD8006                    CALL    RES_STATUS              ;TEST OK
 6331                                 
 6332  25C8           ENDTEST:
 6333  25C8 3A9BC0                    LD      A,(MEMB)
 6334  25CB CBB7                      RES     6,A             ;SBLOCCO GATE
 6335  25CD 329BC0                    LD      (MEMB),A
 6336  25D0 D301                      OUT     (PB),A
 6337  25D2 C9                        RET;
 6338                 
 6339                 
 6340                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6341                 ;               VERIFICA FUNZIONAMENTO ENCODER
 6342                 ;               ROTATIVA DEVE GIRARE AL DI SOTTO DI 50 GIRI/MIN
 6343                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6344                 
 6345  25D3           ENC1:                
 6346  25D3 3E01                      LD      A,01H          ;CARICO UN
 6347  25D5 3222C3                    LD      (ENCOD1),A     ;GIRO IN CTC1
 6348  25D8 3ED7                      LD      A,0D7H         ;AL GIRO
 6349  25DA D371                      OUT     (CTC1_CMD),A        
 6350  25DC 3E01                      LD      A,01H          
 6351  25DE D371                      OUT     (CTC1_CMD),A        
 6352  25E0 3E00                      LD      A,00H          ;AZZERO IL 
 6353  25E2 3224C3                    LD      (ENCOD2),A     ;CONTATORE
 6354  25E5 322AC3                    LD      (TEST_ENC),A
 6355  25E8 010000                    LD      BC,0000H       ;2
 6356  25EB ED4328C3                  LD      (ENCOD4),BC
 6357  25EF FB                        EI                     ;PER 16
 6358  25F0 01FFFF                    LD      BC,0FFFFH      ;RITARDO ANTI
 6359  25F3           ENC8:           
 6360  25F3 0B                        DEC     BC              ;RIMBALZO
 6361  25F4 78                        LD      A,B
 6362  25F5 B1                        OR      C
 6363  25F6 20FB                      JR      NZ,ENC8
 6364  25F8 18D9                      JR      ENC1            ;AL POSTO DIJP TES1
 6365  25FA           ENC2:          
 6366  25FA 3E37                      LD      A,37H           ;DISABILITO
 6367  25FC D303                      OUT     (03H),A         ;INTERUPT DI
 6368  25FE 3EFF                      LD      A,0FFH          ;PIOB
 6369  2600 D303                      OUT     (03H),A         ;
 6370  2602           ENC3:
 6371  2602 DB01                      IN      A,(PB)          ;
 6372  2604 CB67                      BIT     4,A
 6373  2606 28FA                      JR      Z,ENC3
 6374  2608           ENC7:           
 6375  2608 DB01                      IN      A,(PB)
 6376  260A CB67                      BIT     4,A
 6377  260C 20FA                      JR      NZ,ENC7
 6378  260E ED4B28C3                  LD      BC,(ENCOD4)
 6379  2612 03                        INC     BC
 6380  2613 ED4328C3                  LD      (ENCOD4),BC
 6381  2617 18E9                      JR      ENC3            ;
 6382                 
 6383  2619 3E00      ENC6:           LD      A,00H
 6384  261B 3222C3                    LD      (ENCOD1),A      ;
 6385  261E 3A24C3                    LD      A,(ENCOD2)
 6386  2621 3E43                      LD      A,43H
 6387  2623 D371                      OUT     (CTC1_CMD),A
 6388  2625 3A26C3                    LD      A,(ENCOD3)      ;TENTA PER
 6389  2628 3C                        INC     A               ;10 VOLTE 
 6390  2629 3226C3                    LD      (ENCOD3),A      ;IL TEST
 6391  262C FE03                      CP      03H             ;
 6392  262E C2D325                    JP      NZ,ENC1
 6393                 
 6394  2631 2A28C3                    LD      HL,(ENCOD4)     ;2
 6395  2634 11FD07                    LD      DE,07FDH        ;2045
 6396  2637 ED52                      SBC     HL,DE
 6397  2639 380C                      JR      C,ENC4
 6398  263B           ENC5:        
 6399  263B CD1E06                    CALL    FORCE_STATUS            ;TEST OK
 6400  263E ED5BEE26                  LD      DE,(S_TEST_ENCODER)
 6401  2642 CD8006                    CALL    RES_STATUS
 6402  2645 180B                      JR      ENDENC
 6403                 
 6404  2647           ENC4:
 6405  2647 3F                        CCF                    ;TEST FALLITO
 6406  2648 CD1E06                    CALL    FORCE_STATUS
 6407  264B ED5BEE26                  LD      DE,(S_TEST_ENCODER)
 6408  264F CD7106                    CALL    SET_STATUS
 6409  2652           ENDENC:
 6410  2652 C30001                    JP      VIA
 6411                 
 6412                 
 6413                 
 6414                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6415                 ;               TEST DELLE USCITE
 6416                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6417                 
 6418  2655           USCITE:
 6419                 
 6420  2655 3E00                      LD      A,00H
 6421  2657 3294D0                    LD      (AUMALO),A
 6422  265A 3296D0                    LD      (AUMATR),A
 6423  265D 3298D0                    LD      (AUMATI),A
 6424                 
 6425                 
 6426  2660 3E00                      LD      A,00H
 6427  2662 329CC0                    LD      (MEMC),A
 6428  2665 D363                      OUT     (PC),A
 6429  2667 CBC7                      SET     B_PC_AVANTI,A
 6430  2669 CD9A26                    CALL    RITOUT
 6431  266C CB87                      RES     B_PC_AVANTI,A
 6432  266E CBCF                      SET     B_PC_RITARDO,A
 6433  2670 CD9A26                    CALL    RITOUT
 6434  2673 CB8F                      RES     B_PC_RITARDO,A
 6435  2675 CBF7                      SET     B_PC_DESTRA,A
 6436  2677 CD9A26                    CALL    RITOUT
 6437  267A CBB7                      RES     B_PC_DESTRA,A
 6438  267C CBFF                      SET     B_PC_SINISTRA,A
 6439  267E CD9A26                    CALL    RITOUT
 6440  2681 CBBF                      RES     B_PC_SINISTRA,A
 6441  2683 CBDF                      SET     B_PC_ALLARME,A
 6442  2685 CD9A26                    CALL    RITOUT
 6443  2688 CB9F                      RES     B_PC_ALLARME,A
 6444  268A CBEF                      SET     B_PC_FUNZ,A
 6445  268C CD9A26                    CALL    RITOUT
 6446  268F CBAF                      RES     B_PC_FUNZ,A
 6447  2691 329CC0                    LD      (MEMC),A
 6448  2694 D363                      OUT     (PC),A
 6449                                 
 6450  2696 CD1306                    CALL    SEND_OK
 6451                 
 6452  2699 C9                        RET
 6453                 
 6454                 
 6455                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6456                 ;               RITARDO PER TEST DELLE USCITE
 6457                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6458                 
 6459  269A           RITOUT:
 6460  269A D363                      OUT     (PC),A
 6461  269C 1606      RITDIS:         LD      D,06H
 6462  269E 01FFFF    RITDI1:         LD      BC,0FFFFH
 6463  26A1 0B        RITDI2:         DEC     BC
 6464  26A2 78                        LD      A,B
 6465  26A3 B1                        OR      C
 6466  26A4 20FB                      JR      NZ,RITDI2
 6467  26A6 15                        DEC     D
 6468  26A7 20F5                      JR      NZ,RITDI1
 6469  26A9 C9                        RET
 6470                 
 6471                 
 6472                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6473                 ;               DEFINIZIONE COSTANTI
 6474                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6475                 
 6476  26AA 00        ANSWOK:         DEFB    00H
 6477  26AB 00        CILINT:         DEFB    00H
 6478  26AC 02        AMPGAT:         DEFB    02H
 6479  26AD 03        SEQSEGT:        DEFB    03H
 6480  26AE 0D        AUMALOT:        DEFB    0DH
 6481  26AF 0E        AUMATRT:        DEFB    0EH
 6482  26B0 1A        LONAVA:         DEFB    1AH
 6483  26B1 1B        LONRIT:         DEFB    1BH
 6484  26B2 1C        STATLED:        DEFB    1CH
 6485  26B3 20        PARVEL:         DEFB    20H
 6486  26B4 21        BASEVALDAC:     DEFB    21H
 6487                 
 6488                 
 6489  26B5 20        ALLCIL:         DEFB    20H
 6490  26B6 21        ALLAMPG:        DEFB    21H
 6491  26B7 22        ALLRIF:         DEFB    22H
 6492  26B8 23        ALLERR:         DEFB    23H
 6493  26B9 24        ALLNOPR:        DEFB    24H
 6494  26BA 25        ALLVELO:        DEFB    25H
 6495  26BB 26        ALLFAS:         DEFB    26H
 6496  26BC 27        ALLTES:         DEFB    27H
 6497  26BD 28        ALLENC:         DEFB    28H
 6498  26BE 28        ENCSEGN:        DEFB    28H
 6499  26BF 29        SUPSOGL:        DEFB    29H
 6500                 
 6501  26C0 39        OFFSETVALDAC:   DEFB    39H
 6502                 
 6503  26C1 80        LEGGI:          DEFB    80H
 6504  26C2 81        SCRIVI:         DEFB    81H
 6505  26C3 82        AUTFAS:         DEFB    82H             
 6506  26C4 83        INITZ80:        DEFB    83H   
 6507  26C5 84        TESTES:         DEFB    84H
 6508  26C6 85        TESENC:         DEFB    85H
 6509  26C7 86        CICLOF:         DEFB    86H
 6510                 ;AVAGAT:                DEFB    87H
 6511                 ;RITGAT:                DEFB    88H
 6512                 ;STOPGA:                DEFB    89H     
 6513  26C8 8A        SHDATO:         DEFB    8AH
 6514  26C9 8B        SHMANU:         DEFB    8BH
 6515  26CA 8C        SHSTOP:         DEFB    8CH
 6516  26CB 8D        NORDF9:         DEFB    8DH
 6517  26CC 8E        INIPAR:         DEFB    8EH
 6518  26CD 90        AZZERA:         DEFB    90H
 6519  26CE 91        PULSAN:         DEFB    91H
 6520  26CF 92        TESTOUT:        DEFB    92H
 6521  26D0 93        FORCERESET:     DEFB    93H
 6522  26D1 94        FUNZ_TWIN_APP_01: DEFB  94H
 6523  26D2 95        FUNZ_TWIN_APP_02: DEFB  95H
 6524                 
 6525  26D3 C4        ANSWER:         DEFB    0C4H
 6526  26D4 3000      MLUNGHEZZA:     DEFW    0030H    ;LUNGHEZZA DI ARR_ERRAVA e ARR_ERRRIT
 6527                 
 6528                 
 6529  26D6 03        DIRAVA:         DEFB    03H
 6530  26D7 0C        DIRRIT:         DEFB    0CH
 6531  26D8 30        DIRTRA:         DEFB    30H
 6532  26D9 C0        DIROPE:         DEFB    0C0H
 6533                 
 6534  26DA FF0F      MAXDAC:         DEFW    0FFFH   ;VALORE SERIALE DEL DAC (DACVAL) DEVE ESSERE COMPRESO TRA 0 E QUESTO VALORE
 6535                 
 6536                 
 6537                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6538                 ;                       POSSIBILI STATI DI STATUS
 6539                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6540                 
 6541  26DC 0100      S_SVILUPPO_CILINDRO:            DEFW    0001H   ;1 
 6542  26DE 0200      S_AMPIEZZA_GATE:                DEFW    0002H   ;2
 6543  26E0 0400      S_SEGNO_DI_RIFERIMENTO:         DEFW    0004H   ;4
 6544  26E2 0800      S_ERRORE_GENERICO:              DEFW    0008H   ;8
 6545                 
 6546  26E4 1000      S_MANCANZA_STAMPA:              DEFW    0010H   ;16 
 6547  26E6 2000      S_VELOCITA_SOTTO_SOGLIA:        DEFW    0020H   ;32 
 6548  26E8 4000      S_SUPERAMENTO_SOGLIA_ERRORE:    DEFW    0040H   ;64
 6549  26EA 8000      S_DOPPIO_SEGNO:                 DEFW    0080H   ;128
 6550                 
 6551  26EC 0001      S_TEST_TESTINA:                 DEFW    0100H   ;256
 6552  26EE 0002      S_TEST_ENCODER:                 DEFW    0200H   ;512
 6553  26F0 0004      S_FASATURA_FALLITA:             DEFW    0400H   ;1024
 6554  26F2 0008      S_BLOCCO_DECELERAZIONE:         DEFW    0800H   ;2048
 6555                 
 6556  26F4 0010      S_BLOCCO_ACCELERAZIONE:         DEFW    1000H   ;4096
 6557                 ;-----NON USATO----------::     DEFW    2000H
 6558                 ;-----NON USATO----------::     DEFW    4000H
 6559                 ;-----NON USATO----------::     DEFW    8000H
 6560                                                 
 6561                                                         
 6562  26F6 7FF8      S_PERMANENT_MASK:               DEFW   0F87FH   ;1111 1000 0111 1111
 6563                 
 6564                 
 6565                 
 6566                 
 6567                 
 6568                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6569                 ;                       PICCO DI TEST SUL BIT PC 5
 6570                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6571                   
 6572  26F8           OUTEST:
 6573  26F8 3A9CC0                    LD      A,(MEMC)
 6574  26FB CBEF                      SET     5,A
 6575  26FD D363                      OUT     (PC),A
 6576  26FF 16FF                      LD      D,0FFH
 6577  2701 15        CAZ:            DEC     D
 6578  2702 20FD                      JR      NZ,CAZ
 6579  2704 CBAF                      RES     5,A
 6580  2706 329CC0                    LD      (MEMC),A
 6581  2709 D363                      OUT     (PC),A
 6582  270B C9                        RET
 6583                 
 6584                 
 6585                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6586                 ;       TABELLA PER IL SALVATAGGIO TEMPORANEO DI UN VALORE
 6587                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6588                 
 6589  270C           HISTORY:
 6590  270C C5                        PUSH    BC
 6591  270D D5                        PUSH    DE
 6592  270E E5                        PUSH    HL
 6593  270F F5                        PUSH    AF
 6594  2710 DDE5                      PUSH    IX
 6595  2712 FDE5                      PUSH    IY
 6596                 
 6597                 
 6598  2714 FD2A90D9                  LD      IY,(TMP_CURSOR)
 6599  2718 ED4B0AC3                  LD      BC,(VELMED)  ;<<- SOSTITUIRE CON LA VARIABILE DA MONITORARE
 6600  271C FD7000                    LD      (IY+00H),B
 6601  271F FD23                      INC     IY
 6602  2721 FD7100                    LD      (IY+00H),C
 6603  2724 FD23                      INC     IY
 6604                 
 6605  2726 FD2290D9                  LD      (TMP_CURSOR),IY
 6606  272A 21FFDB                    LD      HL,0DBFFH
 6607  272D ED5B90D9                  LD      DE,(TMP_CURSOR)
 6608  2731 ED52                      SBC     HL,DE
 6609  2733 3009                      JR      NC,HISTORYEXIT
 6610  2735 3F                        CCF
 6611  2736 FD2100DB                  LD      IY,ARR_TMP
 6612  273A FD2290D9                  LD      (TMP_CURSOR),IY
 6613  273E           HISTORYEXIT:
 6614  273E FDE1                      POP     IY
 6615  2740 DDE1                      POP     IX
 6616  2742 F1                        POP     AF
 6617  2743 E1                        POP     HL
 6618  2744 D1                        POP     DE
 6619  2745 C1                        POP     BC
 6620  2746 C9                        RET
 6621                 
 6622                 
 6623                 
 6624                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6625                 ;       AZZERRAMENTO DEL MSB DEI PARAMETRI A UN SOLO BYTE
 6626                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6627                 
 6628  2747           AZZER_MSB:
 6629                 
 6630  2747 3E00                      LD      A,00H
 6631  2749 3267D0                    LD      (ALLAR+01H),A           
 6632  274C 3269D0                    LD      (AMPGA+01H),A           
 6633  274F 322FD0                    LD      (SEQSEG+01H),A
 6634  2752 3279D0                    LD      (TRIP+01H),A            
 6635  2755 326BD0                    LD      (GUADA+01H),A           
 6636  2758 327BD0                    LD      (GUATRA+01H),A
 6637  275B 326DD0                    LD      (CICLO+01H),A           
 6638  275E 327DD0                    LD      (TCICLO+01H),A
 6639  2761 3271D0                    LD      (ZONA+01H),A            
 6640  2764 3277D0                    LD      (ZONT+01H),A
 6641  2767 3287D0                    LD      (VCLONG+01H),A
 6642  276A 3289D0                    LD      (VCTRAV+01H),A
 6643  276D 3295D0                    LD      (AUMALO+01H),A          ;MODO AUTOMATICO-MANUALE LONGITUDINALE
 6644  2770 3297D0                    LD      (AUMATR+01H),A          ;MODO AUTOMATICO-MANUALE TRASVERSALE
 6645  2773 3299D0                    LD      (AUMATI+01H),A          ;MODO AUTOMATICO-MANUALE TIRO
 6646  2776 3275D0                    LD      (SALTO+01H),A           
 6647  2779 326FD0                    LD      (DERIVA+01H),A          
 6648  277C 3273D0                    LD      (INSER+01H),A           
 6649  277F 32B9D0                    LD      (LINGUA+01H),A
 6650  2782 3285D0                    LD      (SEGRIF+01H),A
 6651  2785 328BD0                    LD      (DIAGON+01H),A
 6652  2788 327FD0                    LD      (MESSA+01H),A   
 6653  278B 3281D0                    LD      (REV_CORRECTION+01H),A
 6654  278E 3283D0                    LD      (MM_MC+01H),A
 6655  2791 329BD0                    LD      (ENB_TRASVERSALE+01H),A ;ENABLE OP-TRASMISSIONE
 6656  2794 329DD0                    LD      (ENB_TIRO+01H),A        ;ENABLE TIRO
 6657  2797 329FD0                    LD      (ENB_COLDSEAL+01H),A    ;ENABLE COLD SEAL
 6658  279A 32A1D0                    LD      (ENB_DAC_LON+01H),A     ;ENABLE DAC_LONGITUDINALE
 6659  279D 32A3D0                    LD      (ENB_DAC_TRA+01H),A     ;ENABLE DAC_TRASVERSALE
 6660  27A0 32A5D0                    LD      (ENB_DAC_TIR+01H),A     ;ENABLE DAC_TIRO
 6661  27A3 3291D0                    LD      (PRESS+01H),A
 6662  27A6 32BBD0                    LD      (ENCOD+01H),A           ;SEGNO DI ZERO DELL'ENCODER
 6663  27A9 328DD0                    LD      (TIRGUA+01H),A          ;GUADAGNO DI TIRO
 6664  27AC 328FD0                    LD      (TIRCIC+01H),A          ;CICLICO DI TIRO
 6665  27AF 32B3D0                    LD      (TWIN_APP_01+01H),A     ;PRIMA FUNZIONALITA' TWIN                                          
 6666  27B2 32B5D0                    LD      (TWIN_APP_02+01H),A     ;SECONDA FUNZIONALITA' TWIN                                        
 6667  27B5 32B7D0                    LD      (TWIN_CURRENTAPP+01H),A ;FUNZIONALITA' TWIN CORRENTE                                       
 6668  27B8 32B9D0                    LD      (LINGUA+01H),A          ;MEMORIA DELLA LINGUA                                              
 6669  27BB 32BBD0                    LD      (ENCOD+01H),A           ;FUNZIONAMENTO CON ENCODER NPN O PNP (SI AUTOSETTA SU TEST ENCODER)
 6670  27BE 32C3D0                    LD      (SH_PN+01H),A
 6671  27C1 32C1D0                    LD      (ENB_SH_PN+01H),A
 6672                 
 6673                 
 6674  27C4 C9                        RET
 6675                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6676                 ;               FINE
 6677                 ;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
 6678  27C5                           END

    Errors:  None          ##########
    Bytes:   9949          # taj200 #
    CRC:     A3BF          ##########

