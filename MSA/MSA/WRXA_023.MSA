

                         ;#################################
                         ;# CONTROLLO DI REGISTRO COLORE  #
                         ;# LONGITUDINALE/TRASVERSALE PER #
                         ;# ROTO/FLEXO CON DOPPIO CODICE  #
                         ;#################################



;22/07/05 ELIMINAZIONE ERRORE FILTRATO PER DISPLAY FFFE
;12/08/05 ELIMINAZIONE ERRORE FILTRATO PER DISPLAY FFFE
;13/08/05 INIZIO MODIFICHE INSERIMENTO SISTEMA MM_MC  MMCC
;10/09/05 INIZIO MODIFICHE CAMBIO SEGNO DI RIFERIMENTO SSRR
;16/09/05 INSERITO ALLARME QUANDO NOPRINT BBLL
;14/11/05 SPOSTAMENTO IN RIGA BASSA DI BASSA VELOCITA E MANCA SEGNO TTVV/TVVV
          ;E CONSEGUENTE VISUALIZZAZIONE VELOCITA,ELIMINAZIONE,SCRITTURA
          ;ACCELLERA, DECELLERA QUANDO A BASSA VELOCITA  DIVENTA_024
;31/03/06 MODIFICHE SU VELOCITA VVVV
;29/04/06 MIGLIORIE SU SI STEMA MC MMMC 
;24/05/06 TOLTO PROBLEMI SU MODIFICHE VVVV
;24/05/06 SISTEMAZIONE OSCILLOSCOPIO ESTERNO FF55 FF56 SSRR
;26/05/06 SCRITTURA ERRORE DATO ERRATO F1 E F3 EEOO EEUU
	  ;MODIFICHE PER CORREZIONE SOLO PROPORZIONALE PPPP
;31/07/06 INIZIO MODIFICHE PER AVERE UN UNICO PROGRAMMA CHE FACCIA
	  ;SIA REGISTRO COLORE PER ROTOCALCO E PER OFFSET E MC
	  ;CON CODICE E SENZA CODICE CON AMPIEZZA GATE IN MC REGOLABILE
	  ;1) MARCA CILINDRO COL CODICE CON SCELTA MARCA MMXX
	  ;2) CENTRATURA CON OSCILLOSCOPIO IM MC FF58
	  ;3)INSERIMENTO SUPER CORREZIONE IN MC SSCC
	  ;4)INSERIMENTO SOLO LONGITUDINALE SSLL	
	  ;5)SOSTITUZIONE JP CLEA1 CON  JP ESCI PER PROBLEMI SHIFT > 500 
	     ;ELIMINATA SCRITTA ERROR ESOSTITUITA CON ERLATO JJPP
;25/09/06 INSERITO COME DEFAULT ANCHE OSGAIN
;28/09/06 SISTEMATO ALTERR ED ALTRO PER METTERE ZERO AL DISPLAY DOPO NOPRI PUUU 
;02/01/07 MODIFICATO INIZIALIZZAZIONE
;07/01/07 INSERIMENTO NUOVO SISTEMA CONTROLLO SEGNO DOPPIO PER MC ,SPECIE DI WATCH DOG
	 ;NELLA RICERCA UATOMATICA,CILINDRO MAX=2047 DIVENTA  WRXA_031 SSDD
;11/01/07;MIGLIORATO DOPPIO SEGNO ELIMINATO MRIC+0AH MESSO SCRITTA INIZIALE COME
	;SUBROUTINE IN MODO DI CHIAMARLA DOPO MODPA GIRATO OPE/TRAS OOTT
;13/01/07 INSERITO IN ALCUNI PUNTI TRASMISSIONE DELLA FASE FFAA
;28/01/07 MIGLIORATO GESTIONE ALTERN AALL
;29/01/07 AZZERATO MRIC+00H ALLA FINE DELLA ROUTINE CODICE SSII
;19/02/07 TOLTO ERRORE IN MIS9:IL VALORE DI FASE VENIVA CARICATO IN DE CREANDO PER QUI 
	;AL SALTO IN XW20 SI PERDEVA IL VALORE
;01/06/07 CAMBIATO TEMPI SCANSIONE OSCILLOSCOPIO ESTERNO
;02/06/07 INIZIO MODIFICHE PER MM SOLO LONGITUDINALE MMLL
;09/06/07 TERMINATE MODIFICHE SOLO LONGITUDINALE DIVENTA 032
;07/07/07 MODIFICHE NUOVO DERIVATIVO DIVENTA LRXA_033 NNDD

	;WRXA_033 + YRXA_023 = LRXA_033

                NAME    WRXA_033

                ASEG
                PUBLIC  MEMC,PC,MOSCIL,FASE,TRIGFA,PB,MEMB,MPUNTO
                PUBLIC  IMPMIL,FORMAR,SCRIOS,GATOSC,SPOINC,MEM5
                PUBLIC  MKBUSY,PA,SERITA,TX,INISI,BASSA,AMPIM1
                PUBLIC  RSZERO,ADDRCG,SERPAR,RSUNO,MERITA
                PUBLIC  MEZGA,FASES1,MOLTI,MOLPL,RIFTOT,PROD
                PUBLIC  GUADS1,MEMA,OSGAIN,GUAOSC,POSGA1,POSGA2

                PUBLIC  TRIP,GUADA,CICLO,DERIVA,ZONA,INSER
                PUBLIC  SALTO,GUATRA,TCICLO,ZONT,LINGUA,GATEPU
                PUBLIC  VCLONG,VCTRAV,DIAGON,MDIAGO,MESSA,CENTRA 
                PUBLIC  MM_MC,XUNZ,XTASTO,MEM1,MEM2,MEM3
                PUBLIC  BINSET,QUOZIE,CICL75,DIVSOR,OF_ROT,PROGR1
                PUBLIC  DIVDEN,SPACOD,NORINV,SEGRIF,INCEXT,PROGR2
                PUBLIC  INFLAS,ENCOD1,ENCOD2,ENCOD3,ENCOD4   
                PUBLIC  TCICAT,CICATT,PROTEZ,VELIST,SECERR,SPELE1  
		PUBLIC	VELMED,VELPRE,ISTVEL,VELMEM,IMPVEL,SPELE2
                PUBLIC  MAGGIU,MAGGI1,PROD24,ALTDIV,PTO032,RESTO0
                PUBLIC  TREST0,MDIVIS,QU1000,MOLT24,MOLP24,CILI12
                PUBLIC  MDO032,MRE032,MSCORR,MIXUE0,MIXUE2,SUXTR0
                PUBLIC  SUXTR2,MREST0,MREST2,EDEND0,EDEND2,QUOZ32
                PUBLIC  MINUE0,MINUE2,SUBTR0,SUBTR2,RESTO2,TMSCOR
                PUBLIC  TIXUE0,TIXUE2,TUXTR0,TUXTR2,TREST2,TINUE0
                PUBLIC  TINUE2,TUBTR0,TUBTR2,CUBTR0,CUBTR2,CESTO0
                PUBLIC  CESTO2,CADDE0,CADDE2,CSOMM0,CSOMM2,CAUGE0
                PUBLIC  CAUGE2,CINUE0,CINUE2,ADDEN0,AUGEN0,NUMCOL
                PUBLIC  AMPIM2,PIOB1,CTC017,SHIFT,MVEL00,CILIN
                PUBLIC  DECEL ,POSIZ1,MCALER,ERATTU,MAVA00,SECONB
                PUBLIC  MPOSI1,MASES1,SPOFAS,MPIEN1,MRIC,SEQSEG
                PUBLIC  MATTES,ALTGUA,GAINS1,RESEPC,PIENO1,TALTER
                PUBLIC  SPOSTA,CENTES,PIUMEN,COSVEL,MDO232,MRE232
                PUBLIC  MEMRIF,SOGLIN,DISPRE,PERCE,RISPER,AMPGA
                PUBLIC  NODISP,LMEDIA,GIR1,MDATER,CALIBR,SIMCOT
                PUBLIC  CONSAL,MTASTI,ERPREC,MDBUSY,ALLAR,ALTERN
                PUBLIC  POSTOT,AMPI10,FASRIF,RAPRIF,RAPPO1,TXUNO
		PUBLIC	SUPCOR,SHIFT3,SHIFT4,AMPI40,MTSHIF,TIUMEN
		PUBLIC	TABCON,TSHIFT,MSHIFT,LAVORO,RESTO,VALORX
		PUBLIC	BINSE1,BINSE2,SECFUN,SIMCOL,VELBCD,ALTERR
		PUBLIC  TVALOX,TPRIMB,TSECOB,PRIMOB
		

                EXTERN  YRXA_023,GENCAR,FINOSC,CAG,FUNDIS,NOPRI,VELO
		EXTERN  FORCIL,SOALLR,AZZER1,AZZER2,POSSEG,COLORE
                EXTERN  IIRIGA,AVANTI,RITARD,OPERAT,TRASMI,FASEAU
                EXTERN  ESEGUI,ERRORE,NOSTAM,VADASI,ACELER,DECELE
                EXTERN  PARAME,TRIDIS,GUADAG,CICLIC,DISDER,INSERZ
                EXTERN  DSALTO,ZONAMO,TRAGUA,TRACIC,TRAZON,DISLIN
                EXTERN  DIADIS,DIADI1,DIADI2,VELONG,VETRAV,DITEST
                EXTERN  TTESTA,TENCOD,LAVANO,LAVA,SECUND,NETA
                EXTERN  SETTA,TABLE,SSEG,SOLDIS,SOLBAS,GATEW
                EXTERN  NORDIS,INTIR,GUATIR,DOPPIO,MODPA,TESREL
                EXTERN  ATIDIS,FLXDIS,MESS0,MACI,MCSSEG,MACODE
                EXTERN  FLASH,TEST,ENC2,ENC6,RITDIS,FUNDI5,PERC40
                EXTERN  DIVIS,MOLT,AGGIUS,AGGIU1,MOL24,DI1000
                EXTERN  DI2000,MOL32,DIV32,SOTT32,TSOTT32,ERALTO
                EXTERN  SOMM32,CSOTT32,CSOM32,ERR_01,ERR_F1,ERR_F3	;EEUU
		EXTERN	INTCOR,TINTCO,BIOTTD,LOWSPE,DISPLD,DISPLT
		EXTERN 	BCDBIN,BIN7,DISPLL,AZZTOT,VARERR,FADA
		EXTERN  VERIFI,CONTR,OCIO,DEFAUL,FABIOSOMM32


PA:     EQU     00H      ;DATI PORTA A
PB:     EQU     01H      ;DATI PORTA B
PC:     EQU     63H      ;DATI PORTA C
TABCON: EQU     0C000H   ;USATA IN CONVERSIONE BCD BINARIO
DIVDEN: EQU     0C014H   ;MEM. DEL DIVIDENDO
DIVSOR: EQU     0C016H   ;MEM. DEL DIVISORE
QUOZIE: EQU     0C018H   ;MEM. RISULTATO DIVISIONE
MOLTI:  EQU     0C01AH   ;MEMORIA DEL MOLTIPLICATORE
MOLPL:  EQU     0C01CH   ;MEMORIA DEL MOLTIPLICANDO
PROD:   EQU     0C01EH   ;MEMORIA DEL PRODOTTO
MOLT24: EQU     0C020H   ;MOLTIPLICATORE  MOLTIPLICA 24 BIT
MOLP24: EQU     0C022H   ;MOLTIPLICANDO MOLTIPLICA 24 BIT
PROD24: EQU     0C024H   ;C026H PRODOTTO MOLTIPLICA 24 BIT 
QU4096: EQU     0C028H   ;QUOZIENTE DIVISIONE PER 4096
QU1000: EQU     0C02AH   ;QUOZIENTE DIVISIONE PER 1000
MDIVIS: EQU     0C02CH   ;MEM. USATA IN DIVISIONE 1000

ADDEN0: EQU     0C030H   ;ADDENDO BASSO SOMMA A 32 BIT
ADDEN2: EQU     0C032H   ;ADDENDO ALTO SOMMA A 32 BIT
AUGEN0: EQU     0C034H   ;AUGENDO BASSO SOMMA A 32 BIT
AUGEN2: EQU     0C036H   ;AUGENDO ALTO SOMMA A 32 BIT

NODISP: EQU     0C038H   ;CONTA NON BLOCCO DISLAY MMCC

CONSAL: EQU     0C03AH   ;CONTEG. SALTI DI NON COR.LONG. EEAA
CONSAT: EQU     0C03CH   ;CONTEG. SALTI DI NON COR.TRAV. EEAA
RESTO:	EQU	0C03EH	 ;RESTO DELL DIVISIONE A SEDICI BIT

VELBCD: EQU     0C040H   ;0C042H MEM. VELOCITA BCD
VELMEM: EQU     0C044H   ;USATA NELLA CONVERSIONE VELOCITA
VMEDIA: EQU     0C046H   ;USATA IN CALCOLO VELOCITA'MEDIA 
VELPRE: EQU     0C048H   ;MEM. DELLA VELOCITA' PRECEDENTE
IMPVEL: EQU     0C04AH   ;IMPULSI ENCODER IN 4 mS 
ISTVEL: EQU     0C04CH   ;VELOCITA' ISTANTANEA 

VELMED: EQU     0C04EH   ;MEM.MEDIA DELLA VELOCITA' AAVV
MVEL00: EQU     0C050H   ;DA 0C050H A 0C06FH USATA IN WWAA
                         ;CALCOLO VELOCITA' MEDIA
DECORR: EQU     0C080H   ;EXTRA VALORE DI CORREZ. LONGITUD.ZZZ  WWAA
MDECOR: EQU     0C082H   ;MEM.EXTRA VALORE DI CORREZ. LONG. ZZZ

DECORT: EQU     0C084H   ;EXTRA VALORE DI CORREZ. TRAVERS.
MDECOT: EQU     0C086H   ;MEM.EXTRA VALORE DI CORREZ. TRAV. ZZZ

CORRE:  EQU     0C088H   ;MEM.VALORE DI CORREZ.MOTORE
ADDRCG: EQU     0C08AH   ;MEM.ADDRES GENERAZIONE CARATTERI OOOO

BINSET: EQU     0C200H   ;MEM.TRASM.DISPLAY 4200H-4210H
BINSE1: EQU     0C220H   ;MEM.TRASM.DISPLAY 4220H-422FH
BINSE2: EQU     0C230H   ;MEM.TRASM.DISPLAY 4230H-423FH

SUPCOR: EQU     0C250H   ;AVVISO SPOSTAMENTO > DI 1/2 GATE  SSCC
SHIFT3: EQU     0C252H   ;QUANTE VOLTE AMPI40 STA IN SHIFT  SSCC
SHIFT4: EQU     0C254H   ;RESTO DELLA DIVISIONE SHIFT AMPIMP SSCC 

MFLEXL: EQU     0C256H   ;ABILITA CORREZ. LONG. ALLA FASE   FFZZ
MFLEXT: EQU     0C258H   ;ABILITA CORREZ. TRAV. ALLA FASE   FFZZ
FLERRO: EQU     0C25AH   ;ERRORE DA CORREGGERE IN FLEXO  FFZZ     

MDATE1:	EQU	0C270H	;MEM. F1 ERRATO EEOO 
MDATE2:	EQU	0C272H	;MEM. F3 ERRATO EEOO 

MAGGIU: EQU     0C2E0H   ;MEM.USATA IN AGGIUST.DECIM. OOOO AAAA
MAGGI1: EQU     0C2E2H   ;USATA IN AGGIUSTAMENTO AMPGATE OSCIL OOOO
SPOINC: EQU     0C2E6H   ;MEM.INCREMENTO DELLO SPOSTAMENTO OSCIL. OOOO

SIMCOL: EQU     0C300H   ;SIMBOLO PER DISPLAY
SIMCOT: EQU     0C304H   ;SIMBOLO PER DISPLAY
ALTERN: EQU     0C308H   ;CONTEGGIO ALTERNANZA
MAZTRA: EQU     0C30AH   ;AVVISO AZZERAMENTO TRAVERS
ENCOD1: EQU     0C310H   ;USATA IN TEST ENCODER
ENCOD2: EQU     0C312H   ;USATA IN TEST ENCODER
ENCOD3: EQU     0C314H   ;CONTEGGIO TENTATIVI TEST XXTT
ENCOD4: EQU     0C316H   ;CONTEGGIO IMPULSI FINALE  XXTT

TMEM4:  EQU     0C332H   ;ATTIVAZIONE CORREZ.TRAVERS
TMEM5:  EQU     0C334H   ;USATA IN CORREZ.TRAVER
TMEM6:  EQU     0C336H   ;USATA IN CORREZ.TRAVER ZZZ

CONALL: EQU     0C338H   ;CONTEGGIO AVVISI ALLARME CIRC.
CONALT: EQU     0C33AH   ;CONTEGGIO AVVISI ALLARME TRAV.
MEM0:   EQU     0C400H   ;MEMORIA DELLA FUNZIONE 0
MEM1:   EQU     0C402H   ;MEMORIA DELLA FUNZIONE 1
MEM2:   EQU     0C404H   ;MEMORIA DELLA FUNZIONE 2
MEM3:   EQU     0C406H   ;MEMORIA DELLA FUNZIONE 3

MEM5:   EQU     0C408H   ;MEMORIA DELLA FUNZIONE 5 OOOO FF55
MEM8:   EQU     0C410H   ;MEMORIA DELLA FUNZIONE 8  CCMM
MEM8A:  EQU     0C412H   ;MEM. USATA NELLA FUNZIONE8 CCMM
MEMW:   EQU     0C414H   ;USATA IN CALCOLO CORREZ.MOTORE  CCMM
MEMID:  EQU     0C416H   ;MEM.INIZIALIZZIONE DISPLAY
MEMTF:  EQU     0C418H   ;MEM. TASTO F GIA' PIGIATO
PROTEZ: EQU     0C41AH   ;AVVISO PROTEZIONE
MDATER: EQU     0C41CH   ;MEM.INSERIMENTO DATO ERRATO
MCALER: EQU     0C41EH   ;SEGNALA AL MAIN DI CALCOLARE
MSCORR: EQU     0C420H   ;MEM.INDICA IL SENSO DELLA CORR.
TMSCOR: EQU     0C422H   ;INDICA SENSO DI CORREZ. DISPLAY ;LLTT
ALTDIV: EQU     0C424H   ;ALTERNA I VALORI NELLA DIVISIONE
CADDE0: EQU     0C426H   ;ADDENDO BASSO SOMMA A 32 BIT
CADDE2: EQU     0C428H   ;ADDENDO ALTO SOMMA A 32BIT
CAUGE0: EQU     0C42AH   ;AUGENDO BASSO SOMMA A 32 BIT
CAUGE2: EQU     0C42CH   ;AUGENDO ALTO SOMMA A 32 BIT
CSOMM0: EQU     0C42EH   ;SOMMA BASSA A 32 BIT
CSOMM2: EQU     0C430H   ;SOMMA ALTA A 32 BIT
MREST0: EQU     0C432H   ;MEM RESTO BASSA SOTT32
MREST2: EQU     0C434H   ;MEM RESTO ALTA SOTT32   CCMM
CALIBR: EQU     0C436H   ;VALORE CALIBRAZIONE MOTORE
INCEXT: EQU     0C438H   ;AUMENTA VELOCITA SCANSIONE IN FUNZ5 FF55
MOSCI1: EQU	0C43AH	 ;USATA PER FASE CON OSCILLOSCOPIO ESTERNO FF56
MDBUSY: EQU     0C456H   ;DISPLAY CON ERRORE DI REGISTRO  DDEE
MKBUSY: EQU     0C458H   ;SEGNALA L'USO DELLA TASTIERA    DDEE

MTASTI: EQU     0C45CH   ;SEGNALA PASSAGGIO DALLA TASTIERA

ALTERR: EQU     0C460H   ;ALT CALCOLO ERR.DOPO USO TASTIER PUUU
TALTER: EQU     0C462H   ;COME SOPRA MA PER TRASVERS PUUU


ZEROSE: EQU     0C464H   ;SEGNO IN ZERO ENCODER 
ALTGUA: EQU     0C466H   ;DOPO N GIRI FISSA IL GUADAGNO

MATTES: EQU     0C46AH   ;USATA IN DECREM.CILCI ATTESA DDEE
MRIC:   EQU     0C470H   ;0C47EH GRUPPO MEME IN RICERCA AUTOMATICA
;+00H SEGNALA RICERCA IN CORSO MMSS
;+02H CONTA I GIRI DELLA RICERA
;+04H SEGNO DOPPIO 0=CONTROLLO ATTIVO 1=SCRITTA ABILITATA 2=DISABILITATO SSDD
;+06H CONTEGGIO GIRI PER CANCELLARE LA SCRITTA DOPPIO MMSS
;+08H COTEGGIO GIRI PER MISURARE LO SPESSORE
MDO032: EQU     0C480H   ;MOLTIPLICANDO BASSO A 32 BIT 
MDO232: EQU     0C482H   ;MOLTIPLICANDO ALTO A 32 BIT 
MRE032: EQU     0C484H   ;MOLTIPLICATORE BASSO 32 BIT 
MRE232: EQU     0C486H   ;MOLTIPLICATORE ALTO A 32 BIT
PTO032: EQU     0C488H   ;PRODOTTO BASSO A 32 BIT 
PTO232: EQU     0C48AH   ;PRODOTTO ALTO  A 32 BIT
EDEND0: EQU     0C48CH   ;DIVIDENDO BASSO DIVISIONE 32BIT
EDEND2: EQU     0C48EH   ;DIVIDENDO ALTO DIVISIONEO 32BIT
QUOZ32: EQU     0C490H   ;QUOZ DIVISIONE 32BIT DIVISO 4096
MINUE0: EQU     0C492H   ;MINUENDO BASSO SOTT. A 32 BIT
MINUE2: EQU     0C494H   ;MINUENDO ALTO SOTT. A 32 BIT
SUBTR0: EQU     0C496H   ;SOTTRAENDO BASSO SOTT. A 32 BIT
SUBTR2: EQU     0C498H   ;SOTTRAENDO ALTO SOTT. A 32 BIT                     
RESTO0: EQU     0C49AH   ;RESTO BASSO SOTT. A 32 BIT
RESTO2: EQU     0C49CH   ;RESTO ALTO SOTT. A 32 BIT
MIXUE0: EQU     0C49EH   ;MINUENDO ALTERNATIVO BASSO
MIXUE2: EQU     0C4A0H   ;MINUENDO ALTERNATIVO ALTO
SUXTR0: EQU     0C4A2H   ;SOTTRAENDO ALTERNATIVO BASSO
SUXTR2: EQU     0C4A4H   ;SOTTRAENDO ALTERNATIVO ALTO

MSHIFT: EQU     0C4B0H   ;CICLO+5 DA DECREMENT.USANDO SHIFT LONG.WWAA
MTSHIF: EQU     0C4B2H   ;TCICLO+1 DA DECREMENT.USANDO SHIFT TRAV.WWAA
NANOCI: EQU     0C4B4H   ;SEGNALA CILINDRO INFERIORE A 9" NNCC SSRR

TINUE0: EQU     0C500H   ;MINUENDO BASSO SOTT. A 32 BIT
TINUE2: EQU     0C502H   ;MINUENDO ALTO SOTT. A 32 BIT
TUBTR0: EQU     0C504H   ;SOTTRAENDO BASSO SOTT. A 32 BIT
TUBTR2: EQU     0C506H   ;SOTTRAENDO ALTO SOTT. A 32 BIT                     
TREST0: EQU     0C508H   ;RESTO BASSO SOTT. A 32 BIT
TREST2: EQU     0C50AH   ;RESTO ALTO SOTT. A 32 BIT
TIXUE0: EQU     0C50CH   ;MINUENDO ALTERNATIVO BASSO
TIXUE2: EQU     0C50EH   ;MINUENDO ALTERNATIVO ALTO
TUXTR0: EQU     0C510H   ;SOTTRAENDO ALTERNATIVO BASSO
TUXTR2: EQU     0C512H   ;SOTTRAENDO ALTERNATIVO ALTO
CINUE0: EQU     0C514H   ;MINUENDO BASSO CSOTT32
CINUE2: EQU     0C516H   ;MINUENDO ALTO CSOTT32
CUBTR0: EQU     0C518H   ;SOTTRAENDO BASSO CSOTT32
CUBTR2: EQU     0C51AH   ;SOTTRAENDO ALTO CSOTT32                     
CESTO0: EQU     0C51CH   ;RESTO BASSO CSOTT32
CESTO2: EQU     0C51EH   ;RESTO BASSO CSOTT32
SECFUN: EQU     0C600H   ;SECONDA RIGA FUNZ LCD
SECERR: EQU     0C620H   ;SECONDA RIGA ERRORE
NUMCOL: EQU     0C640H   ;RIGA NUMERO COLORE
SCRIOS: EQU     0C660H   ;0C688H SCRITTURA OSCILLOSCOPIO OOOO
TRIGFA: EQU     0C700H   ;MEM.FASE DI TRIGGER OSCILLO. OOOO
MEMA:   EQU     0C800H   ;MEMORIA DELLA PORTA A OOOO
MEMB:   EQU     0C802H   ;MEMORIA DELLA PORTA B OOOO
MERITA: EQU     0C80AH   ;USATA PER FINOSC IN RITDIS FFXX
MAVA00: EQU     0C900H   ;DA 0C900H A 0C95FH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE AVANTI
MRIT00: EQU     0C960H   ;DA 0C960H A 0C9BFH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE RITARDO
DAVA00: EQU     0C9C0H   ;DA 0C9C0H A 0C9DFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE AVANTI DISPLAY
DRIT00: EQU     0C9E0H   ;DA 0C9E0H A 0C9FFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE RITARDO DISPLAY

ERATTU: EQU     0CA00H   ;ERRORE ATTUALE   ;LLTT FFXX   MMDD  WWAA
ERPREC: EQU     0CA02H   ;ERRORE PRECEDENTE   LLTT FFXX      WWAA
ERMEDI: EQU     0CA04H   ;MEMORIA ERRORE MEDIO LONG LLTT FFXX    WWAA
SOMLO1: EQU     0CA18H   ;PRIMA SOMMA PER MEDIA LONG GGAA   WWAA
SOMLO2: EQU     0CA1AH   ;SECONDA SOMMA PER MEDIA LONG GGAA WWAA
SOMDL1: EQU     0CA1CH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.
SOMDL2: EQU     0CA1EH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.

MOPE00: EQU     0CB00H   ;DA 0CB00H A 0CB5FH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE OPERATORE
MTRA00: EQU     0CB60H   ;DA 0CB60H A 0CBBFH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE TRASMISSIONE
DOPE00: EQU     0CBC0H   ;DA 0CBC0H A 0CBDFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE OPERA DISPLAY
DTRA00: EQU     0CBE0H   ;DA 0CBE0H A 0CBFFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE RITARDO DISPLAY
TERATT: EQU     0CC00H   ;ERRORE ATTUALE TRAVERS   LLTT  FFXX     MMDD
TERPRE: EQU     0CC02H   ;ERRORE PRECEDENTE TRAVERS   ;LLTT FFXX 
TERMED: EQU     0CC04H   ;MEMORIA ERRORE MEDIO TRAVERS ;LLTT FFXX

SOMTR1: EQU     0CC18H   ;PRIMA SOMMA PER MEDIA TRAVERS GGAA
SOMTR2: EQU     0CC1AH   ;SECONDA SOMMA PER MEDIA  TRAVERS GGAA
SOMDT1: EQU     0CC1CH   ;USATA IN CALCOLO MEDIA DIPLAY TRAV.
SOMDT2: EQU     0CC1EH   ;USATA IN CALCOLO MEDIA DIPLAY TRAV.

PRIMOB: EQU     0CD00H   ;VALORE DA DARE AL PRIMO REG B IN MEDIALOMG   VVVV
SECONB: EQU     0CD02H   ;VALORE DA DARE AL SECONDO REG B IN MEDIALOMG VVVV
VALORX: EQU     0CD04H   ;VALORE DA DARE AL REG IX IN MEDIALOMG        VVVV
TPRIMB: EQU     0CD06H   ;VALORE DA DARE AL PRIMO REG B IN MEDIATRAV   VVVV
TSECOB: EQU     0CD08H   ;VALORE DA DARE AL SECONDO REG B IN MEDIATRAV VVVV
TVALOX: EQU     0CD0AH   ;VALORE DA DARE AL REG IX IN MEDIATRAV        VVVV

CORRATT:EQU	0CD10H   ;CONTIENE IL VALORE CON SEGNO DELLA CORREZIONE IN BASE ALL'ERRORE (4BYTE)NNDD

MSCORR_ATT:EQU 	0CD34H   ;SENSO DELL'ERRORE ATTUALE NNDD
MSCORR_PREC:EQU 0CD36H   ;SENSO DELL'ERRORE PRECEDENTE NNDD



MEMC:   EQU     0D000H   ;MEMORIA DELLA PORTA C
MEMC1:  EQU     0D002H   ;MEM PORTA C IN FLASH
CILIN:  EQU     0D004H   ;MEM. SVILUPPO CILINDRO
ALLAR:  EQU     0D006H   ;MEM. VALORE ALLARME IN CENTESIMI
COSVEL: EQU     0D008H   ;COSTANTE USATA IN VELOCITA'
TATTES: EQU     0D00AH   ;ATTESA CORREZ.TRAVERS

RAPRIF: EQU     0D00CH   ;RAPPORTO DI RIFERIMMENTO MMCC
AMPI10: EQU     0D00EH   ;AMPIMP x 10              MMCC 

CENTES: EQU     0D010H   ;CENTESIMI IN UN IMP.DI ENCODER
MILLES: EQU     0D012H   ;MILLESIMI IN UN IMP.DI ENCODER
FASE:   EQU     0D014H   ;MEM. INIZIO GATE DELLA FASE S1
FASE2:  EQU     0D016H   ;MEM. INIZIO GATE DELLA FASE S2
FASE3:  EQU     0D018H   ;PUNTO DI ABILITAZIONE  PER PA7
FASES1: EQU     0D01AH   ;MEMORIA DELLA FASE DI S1
FASES2: EQU     0D01CH   ;MEMORIA DELLA FASE DI S2
FASRIF: EQU     0D01EH   ;MEM.FASE DI RIFERIMENTO DI S1
UNOMIL: EQU     0D020H   ;1mm IN IMPULSI ENCODER 
RIFTOT: EQU     0D022H   ;(FASRIFx10)+RAPRIF=RIFTOT 
POSTO1: EQU     0D024H   ;POSIZIONE TOTALE S1
POSTO2: EQU     0D026H   ;POSIZIONE TOTALE S2

POSTOT: EQU     0D028H   ;(FASES1x10)+RAPRIF=RIFTOT MMCC

MEZGA:  EQU     0D02AH   ;MEM.MEZZA AMPIEZZA DI GATE  WWWW

CILDIV: EQU     0D02CH   ;CILINDRO DIVISO 10
CILMOL: EQU     0D02EH   ;CILINDRO MOLTIPLICATO x 10
MEMAB:  EQU     0D030H   ;E D032H USATE IN ABILITAZ.GATE
MEMFAS: EQU     0D034H   ;SEGNALA FASE O FASE2 
SEQSEG: EQU     0D036H   ;E D038H POS.SEGNO NELLA SEQUENZA 
SEGNO:  EQU     0D03AH   ;IMP. DA 2048 IN UN SEGNO DA 2mm
SPAZIO: EQU     0D03CH   ;IMP.DA 2048 IN UNO SPAZIO DA 5mm
SPAZ40: EQU     0D03EH   ;IMP.DA 2048 IN SPAZIO DA 40mm
DISTAN: EQU     0D040H   ;DISTANZA TEORICA TRA S1 E S2
SPERIF: EQU     0D042H   ;SPESSORE DI RIFERIMENTO MMXX
SPELET: EQU     0D044H   ;SPESSORE LETTO MMXX
GUADS1: EQU     0D046H   ;VALORE GUADAGNO SEGNALE S1
GUADS2: EQU     0D048H   ;VALORE GUADAGNO SEGNALE S2
DMILLE: EQU     0D04AH   ;DECIMILLESIMI IN UN IMP.DI ENCOD
DISTA0: EQU     0D04CH   ;DISTANZA BASSA IN DECIMILLESIMI
DISTA2: EQU     0D04EH   ;DISTANZA ALTA IN DECIMILLESIMI
INFLAS: EQU     0D050H   ;INTERVALLO FLASH PROTEZIONI
LAVORO: EQU     0D052H   ;NøDEL LAVORO PRESENTE
SHIFT:  EQU     0D054H   ;MEM.DELLO SPOSTAMENTO REGISTRO
TSHIFT: EQU     0D056H   ;MEM. SPOSTAMENTO REG.TRAVERS
PIUMEN: EQU     0D058H   ;MEM.SENSO DELLO SPOSTAMENTO
SHIFT0: EQU     0D05AH   ;MEM.BASSA SPOSTAMENTO REGISTRO
SHIFT2: EQU     0D05CH   ;MEM. ALTA SPOSTAMENTO REGISTRO
PIENO1: EQU     0D05EH   ;MEM. VALORE DEL PIENO S1
PIENO2: EQU     0D060H   ;MEM. VALORE DEL PIENO S2
POSIZ1: EQU     0D062H   ;MEM. VALORE DELLA POSIZIONE S1
POSIZ2: EQU     0D064H   ;MEM. VALORE DELLA POSIZIONE S2
RAPPO1: EQU     0D066H   ;MEM. RAPPORTO S1
RAPPO2: EQU     0D068H   ;MEM. RAPPORTO S2
IMPENC: EQU     0D06AH   ;VALORE SPOSTAM.IN IMPULS.ENCODER
XUNZ:   EQU     0D06CH   ;MEMORIA FUNZIONE MOD. PARAMETRI
XTASTO: EQU     0D06EH   ;MEMORIA ULTIMO TASTO PREMUTO
TIUMEN: EQU     0D070H   ;MEM.SENSO DELLO SPOSTAM.TRAV
TPOST1: EQU     0D076H   ;POSIZIONE TOTALE S1 TRAVERS
TPOST2: EQU     0D078H   ;POSIZIONE TOTALE S1 TRAVERS
TRAPP1: EQU     0D07AH   ;MEM.RAPPORTO S1 TRAVERS
TRAPP2: EQU     0D07CH   ;MEM.RAPPORTO S2 TRAVERS
MDIAGO: EQU     0D07EH   ;USATA IN SCELTA DIAGONALE
GUADA:  EQU     0D080H   ;MEM.DEL GUAD.min 11 x CIL=2000
CICLO:  EQU     0D08AH   ;MEMORIA CICLO DI CORREZIONE
DERIVA: EQU     0D094H   ;MEMORIA DEL VALORE DERIVATIVO
ZONA:   EQU     0D09EH   ;MEMORIA VALORE ZONA MORTA
INSER:  EQU     0D0A8H   ;MEMORIA VALORE INSERZIONE AUTO
SALTO:  EQU     0D0B2H   ;MEM. VALORE SALTO DI CORREZIONE
GUATRA: EQU     0D0BCH   ;MEM. GUADAGNO TRAVERS
TCICLO: EQU     0D0C6H   ;MEM. CILCO TRAVERS
ZONT:   EQU     0D0D0H   ;MEM. ZONA MORTA TRAVERS
LINGUA: EQU     0D0DAH   ;MEMORIA DELLA LINGUA
DIAGON: EQU     0D0E4H   ;MEM. POSIZIONE IPOTENUSA
TRIP:   EQU     0D0EEH   ;SOGLIA BLOCCO PER VELOCITA' 

VCLONG: EQU     0D0F8H   ;VELOCITA DI CORREZIONE LONGITUDINALE FFZZ AAOO
VCTRAV: EQU     0D102H   ;VELOCITA DI CORREZIONE TRASVERSALE  FFZZ  AAOO
MESSA:  EQU     0D10CH   ;SELEZIONE TIPO DI MESSA A REGISTRO  CCMM
NORINV: EQU     0D116H   ;MEM. CORREZZIONE NORMALE O REVERS NNII 
MM_MC:  EQU     0D120H   ;SELEZIONE MM/MC  
SEGRIF: EQU     0D12AH   ;SCELTA SEGNO DI RIFERIMENTO SSRR
OF_ROT: EQU	0D134H	 ;SCELTA TRA OFFSET E ROTOCALCO FLEXO
CENSEN: EQU     0D140H   ;VALORE SEGNO CENTRATO NEL GATE CCDD
DISPRE: EQU     0D142H   ;ERRORE DISPLAY LONG.PRECEDENTE CCDD
TDISPR: EQU     0D144H   ;ERRORE DISPLAY TRAV.PRECEDENTE CCDD
CICATT: EQU     0D146H   ;CICLI IN FUNZ. POSIZ. CILIN. LONG. FOFF CCDD
TCICAT: EQU     0D148H   ;CICLI IN FUNZ. POSIZ. CILIN. TRAV. FOFF CCDD

CICL75: EQU     0D14AH   ;75% DEL CICLO DI CORREZZIONE ZZZ  CCDD
CIDE75: EQU     0D14CH   ;MEM. DEL 75% DEL CICLO DI CORREZZIONE ZZZ CCDD

POSGA1: EQU     0D14EH   ;POSIZIONE CARATTERE INIZIO PRIMO GATE   OOOO  CCDD  OO22
POSGA2: EQU     0D150H   ;POSIZIONE CARATTERE INIZIO SECONDO GATE   OOOO CCDD  OO22
IMPMIL: EQU     0D152H   ;IMPULSI DA 2048 PER MILLIMETRO CCDD

AMPGA:  EQU     0D154H   ;AMPIEZZA GATE IN mm  OOOO (OOOO)
OSGAIN: EQU     0D156H   ;GUADAGNO SEGNALE OSCILLOSCOPIO  OOGG AAOO
CILI12: EQU     0D158H   ;12,5% DELLO SVILUPPO DEL CILINDRO  CCPP

MILL20: EQU     0D15AH   ;20mm IN IMPULSI ENCODER  CCDD EEUU  
MILL28: EQU     0D15CH   ;2,8mm IN IMPULSI ENCODER TRIANGOLO EEUU BBAA
MILL35: EQU     0D15EH   ;35mm IN IMPULSI ENCODER DEVRIM EEUU
MILL45: EQU     0D160H   ;4,5mm IN IMPULSI ENCODER CODICE ZELO EEUU
MILL60: EQU     0D162H   ;6,0mm IN IMPULSI ENCODER TRIANGOLO EEUU
MILL70: EQU     0D164H   ;7,06 mm IN IMPULSI ENCODER  CCDD EEUU

AMPIM1: EQU     0D166H   ;AMPIEZZA GATE 1 IN IMPULSI ENCODER  WWWW CCDD
AMPIM2: EQU     0D168H   ;AMPIEZZA GATE 2 IN IMPULSI ENCODER  WWWW CCDD
MEZGA1:	EQU	0D16AH	 ;40% DEL VALORE DI AMPIM1 MMXX
MEZGA2:	EQU	0D16CH	 ;40% DEL VALORE DI AMPIM2 MMXX
SPACOD: EQU     0D16EH   ;28mm DISTANZA TRA Iø DI CODICE E Iø MARCA TTGG

SPELE1: EQU     0D170H   ;SPESSORE SEGNO DI RIFERIMENTO  SSSS     
SPELE2: EQU     0D172H   ;SPESSORE SECONDO SEGNO   SSSS     
OFFSET: EQU     0D174H   ;VALORE DA SOMM/SOTTR A SPELE2   SSSS
SPEOFF: EQU     0D176H   ;SPESSORE PRIMO SEGNO +/- OFFSET   SSSS
SEGOFF: EQU     0D178H   ;POLARITA DELL'OFFSET
PERCE:	EQU	0D17AH	 ;USATA IN CALCOLO 40%
RISPER: EQU	0D17CH	 ;RISULTATO DEL CALCOLO DEL 40%
BIANCO: EQU	0D17EH   ;MINIMO SPAZIO BIANCO PER RA 
MPIEN1: EQU     0D180H   ;MEM TEMPORANEA PIENO 1 LONG  CCMM11
MPIEN2: EQU     0D182H   ;MEM TEMPORANEA PIENO 2 LONG
MPOSI1: EQU     0D184H   ;MEM TEMPORANEA POSIZ.1 LONG
MPOSI2: EQU     0D186H   ;MEM TEMPORANEA POSIZ.2 LONG
MASES1: EQU     0D188H   ;MEM TEMPORANEA FASE 1 LONG
MASES2: EQU     0D18AH   ;MEM TEMPORANEA FASE 2 LONG
TPIEN1: EQU     0D18CH   ;MEM TEMPORANEA PIENO 1 TRAV
TPIEN2: EQU     0D18EH   ;MEM TEMPORANEA PIENO 2 TRAV
TPOSI1: EQU     0D190H   ;MEM TEMPORANEA POSIZ.1 TRAV
TPOSI2: EQU     0D192H   ;MEM TEMPORANEA POSIZ.2 LONG
TASES1: EQU     0D194H   ;MEM TEMPORANEA FASE 1 TRAV
TASES2: EQU     0D196H   ;MEM TEMPORANEA FASE 2 TRAV

CPOST1:	EQU	0D198H	;POSIZIONE TOALE DI CENTRO S1 MMLL
CPOST2:	EQU	0D19AH	;POSIZIONE TOALE DI CENTRO S2

MEMRIF: EQU     0D19CH   ;USATA PER MEMORIZ. I RIFERIMENTI  MMCC
MOSCIL: EQU     0D200H   ;MEM. OSCILLOSCOPIO DA D500H A D900H OOOO
MPUNTO: EQU     0D600H   ;MEM. DEL PUNTO ON O OFF   OOOO
FORMAR: EQU     0D700H   ;USATA NELLA FORMAZIONE DELLA MARCA OOOO

GATOSC: EQU     0D982H   ;NUMERO CARATTERI OCCUPATI PER GATE OOOO 
GUAOSC: EQU     0D98AH   ;MEM.TEMPORANEA IN FUNZ OSCILLOSCOPIO

AMPI40: EQU     0D992H   ;AMPIEZZA GATE DEL40%  IN CENTS

DOG:	EQU	0D994H	 ;IN CASO DI WATCH DOG NON FA VEDERE LA SCRITTA INIZIALE SSDD

                         ;
PROVLT: EQU     0D98CH   ;DA ELIMINARE IN PROGRAMMA REGOLARE  PRRR
SALVA:  EQU     0D990H   ;USATA NELLA CREAZIONE TABELLE TEST
                         ;


TAP1:   EQU     0DA20H   ;TABELLA IND. INTER. PIO1A
TAP2:   EQU     0DA22H   ;TABELLA IND. INTER. PIO1B
TAB0:   EQU     0DA30H   ;TABELLA IND. INTER. CTC CANALE 0
TAB1:   EQU     0DA32H   ;TABELLA IND. INTER. CTC CANALE 1
TAB2:   EQU     0DA34H   ;TABELLA IND. INTER. CTC CANALE 2
TAB3:   EQU     0DA36H   ;TABELLA IND. INTER. CTC CANALE 3
TABLAV: EQU     0DB00H   ;INIZIO TABELLA MEM. LAVORI




		;INIZIALIZZAZIONE SISTEMA
		
WRXA_033:
	      	ORG     0000H
		JP      VIA

		ORG     0008H
		JP      VIA

		ORG     0010H
		JP      VIA

		ORG     0018H
		JP      VIA

		ORG     0020H
		JP      VIA

		ORG     0028H
		JP      VIA

		ORG     0030H
		JP      VIA

		ORG     0038H
		JP      VIA


		ORG     100H

VIA:

		

RESET_PIO:            
		LD	HL,INIT_Z80
		LD	(0DFFFH),HL
		LD	(0DFFDH),HL
		LD      SP,0DFFDH       ;DEF.AREA STACK
		RETI

INIT_Z80:
		LD	HL,VIA
		LD	(0DFFFH),HL
		LD      SP,0DFFFH       ;DEF.AREA STACK
		IM      2               ;IMPOSTA MODO PIO = 2
                LD      A,0DAH          ;IND.ALTO TAB.
		LD      I,A
                LD      IY,PIOA         ;IND.ROUT.INT.
		LD      (TAP1),IY       ;CAR.TAB.INT.
		LD      A,20H           ;VET.INTER.PIO A
		OUT     (02H),A         ;CONTROLLO PIO A
		LD      A,0CFH          ;PORTA A MODO 3
		OUT     (02H),A
                LD      A,11H           ;0-4 IN 123567 OUT
		OUT     (02H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (02H),A 
		LD      A,0EFH          ;P.M.BIT 0123567
		OUT     (02H),A
                LD      IY,PIOB         ;IND.ROUT.INT.
		LD      (TAP2),IY       ;CAR.TAB.INT.
		LD      A,22H           ;VET.INT.PIO B
		OUT     (03H),A         ;CONTROLLO PIO B
		LD      A,0CFH          ;PORTA B MODO 3
                OUT     (03H),A         ;SENZA PULSANTE
                LD      A,3EH           ;0567 OUT 12345 IN PPUU
		OUT     (03H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (03H),A
                LD      A,0DDH          ;P.MAS.BIT 023467 PPUU
		OUT     (03H),A         ;ALL'INTERUPT
                LD      IY,CTC0         ;IND.ROUT.CTC0.
		LD      (TAB0),IY       ;CAR.TAB.INT.CAN0
		LD      A,30H           ;VET.IND.CTC0
		OUT     (70H),A         ;VET.SEMPRE IN 0
                LD      IY,CTC1         ;IND.ROUT.CTC1
		LD      (TAB1),IY       ;CAR.TAB.INT.CAN1
		LD      A,32H           ;VET.IND.CTC1
		OUT     (70H),A
                LD      IY,CTC2         ;IND.ROUT.CTC2
		LD      (TAB2),IY       ;CAR.TAB.INT.CAN2
		LD      A,34H           ;VET.IND.CTC2
		OUT     (70H),A
                LD      IY,CTC3         ;IND.ROUT.CTC3
		LD      (TAB3),IY       ;CAR.TAB.INT.CAN3
		LD      A,36H           ;VET.IND.CTC3
		OUT     (70H),A         ;VET.CARICATO
		EI                      ;SEMPRE IN 0
			
		;RESET DELLA PORTA C

		LD      A,(MEMC)        ;RESETTO LE USCITE
		RES     0,A             ;CHE NON VENGONO
		RES     1,A             ;UTILIZZATE
		RES     5,A             ;RIMANE MEMORIZ-
		RES     6,A             ;ZATA LA CONDI-
		RES     7,A             ;ZIONE AUTO/MAN
		OUT     (PC),A
		LD      (MEMC),A

                ;AZZERAMENTO DA 0C000H A 0CFFFH
		
		LD      A,00H
                LD      (TABCON),A      ;LOC. INIZIALE
                LD      HL,TABCON
                LD      DE,TABCON+01H
                LD      BC,0FFFH
		LDIR                    
		LD      A,04H           ;PER NON AVERE IN
		LD      (MATTES),A      ;DECREMENTO FFH
		LD      (CONSAL),A
                LD      (CONSAT),A      ;EEAA
              	LD	(OSGAIN),A	;PUUU
		LD	A,02H		;AALL
		LD      (ALTERN),A	
		CALL    DEFAUL
                CALL    VARERR          ;WWAA
		CALL    GENCAR          ;OOOO
		CALL    VERIFI          ;UUEE

		LD	A,(OF_ROT)	;IN OFFSET
		CP	00H		;VIENE FORZATO
		JR	NZ,NO_OFFSET	;A CORREZIONE
		LD	A,00H
		LD	(NORINV),A
NO_OFFSET:
		CALL	INIZIO


                ;TRASMISSIONE DELLA FASE

FASTRA:        
		LD	A,00H		;RESETTO WATCH DOG SSDD
		LD	(DOG),A		;SSDD

		LD      HL,(FASE)	;FFAA
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
       


                ;TRASMISSIONE DELLA FASE

FASAUT:         LD      A,(MRIC+00H) 
		CP      01H
                JP      NZ,MAIN        ;FFRR
                LD      A,(MEMC)        
                RES     5,A
                LD      (MEMC),A
                OUT     (PC),A          
                CALL    CODICE
                LD      A,(MEMB)
                RES     6,A
                LD      (MEMB),A
                OUT     (PB),A
                CALL    FADA            ;CCMM11
		LD      A,00H
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
               	LD      A,60H           ;ALLA PARTE-
		LD      (GUADS1),A      ;ZA METTO GUA-
		LD      (GUADS2),A      ;DAGNO MINIMO
		LD	A,01H           ;
                LD      (MRIC+06H),A    ;
		

		;MAIN PROGRAMMA PRINCIPALE DI CALCOLO

MAIN:          
		LD      A,(MM_MC)       ;PUUU
                CP      00H		
                JR      NZ,MAIN1

		LD	A,(MEMFAS)	;DEVE PASSARE PUUU
		CP	02H		;DUE VOLTE
		JP	NZ,GIR1		;DA PIOB

		LD	DE,(FASES1)	;PROTEZIONE PUUU
		LD	HL,(FASES2)	;IN CASO DI
		SBC	HL,DE		;LETTURA SBAGLITA
		JP	Z,GIR1		;PUUU
		JR	NC,MAIN1
		CCF
		
MAIN1:
		LD      A,(MCALER)      ;VEDE SE DEVE ABBB PP22
		CP      00H             ;CALCOLARE O NO
		JP      Z,GIR1
		LD      A,00H
		LD      (MCALER),A
		LD      A,(ALTERR)      ;VEDE SE DEVE PUUU
		CP      00H             ;ASPETTARE
		JP	Z,MAIN2		;PUUU
		LD      A,(MKBUSY)      ;VEDO SE TASTIERA EEUU
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
		
		CALL    DISPLL          
                CALL    DISPLD
		JP	GIR1
MAIN2:	
		CALL	CONTR		 ;EEOO

		;CALCOLO RAPPORTO POSIZINE PIENO S1


                LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JP      NZ,XMAIN2
                LD      DE,(ERATTU)     ;MEMORIZZO ERRORE
		LD      (ERPREC),DE     ;PRECEDENTE
                LD      A,(MSCORR)      ;WWAASALVO SEGNO
		LD      IX,PIENO1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,RAPP10        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
		JR      RAPP11
RAPP10:         CCF
		LD      A,00H
RAPP11:         LD      (RAPPO1),A      ;VERIFICO SE E'


		;CALCOLO RAPPORTO POSIZINE PIENO S2

		LD      IX,PIENO2       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ2       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,RAPP20        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO2
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
		JR      RAPP21
RAPP20:         CCF
		LD      A,00H
RAPP21:         LD      (RAPPO2),A      ;VERIFICO SE E'

		;CALCOLO POSIZIONE TOTTALE S1

		LD      DE,(FASES1)     ;FASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPPO1)
		LD      H,00H
		ADD     HL,DE
		LD      (POSTO1),HL


		;CALCOLO POSIZIONE TOTTALE S2
		
PROVAL:
                LD      DE,(FASES2)     ;FASES2 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPPO2)
		LD      H,00H
		ADD     HL,DE
		LD      (POSTO2),HL
		
		LD	A,(DIAGON)	;MMLL
		CP	03H		;MMLL
		JP	Z,PUNMED	;MMLL

		LD      DE,(POSTO1)
		SBC     HL,DE
		JR      NC,Z1           ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(POSTO2)     ;POSTO2<POSTO1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO1)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC.

		;(ERRORE x DECIMILLES.IN DIV.ENC.)-
		;DISTANZA IN CENTIMILLESIMI : 1000 =ERRORE
		;IN CENTESIMI

Z1:             LD      (MDO032),HL     ;HL=DISTANZA S1/S2
		LD      HL,0000H
		LD      (MDO232),HL
		LD      BC,(DMILLE)
		LD      (MRE032),BC
		LD      (MRE232),HL
		CALL    MOL32
		LD      BC,(PTO032)
		LD      DE,(PTO232)
		LD      (MINUE0),BC
		LD      (MINUE2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (SUBTR0),BC
		LD      (SUBTR2),DE
                LD      A,00H           ;AVVISO CARICO
                LD      (ALTDIV),A      ;VALORE PER
                CALL    SOTT32          ;LONGITUD.

                LD      A,(NORINV)      ;NNII
                CP      00H
                JR      Z,NOIN3
                LD      A,(MSCORR)
                CP      08H
                JR      Z,NOIN1
                CP      01H
                JR      Z,NOIN2
                JR      NOIN3
NOIN1:          LD      A,01H
                LD      (MSCORR),A
                JR      NOIN3
NOIN2:          LD      A,08H
                LD      (MSCORR),A
NOIN3:                                  ;NNII
		CALL    DI1000
                LD      DE,(QU1000)     ;ERRORE  
                LD      (ERATTU),DE     

		LD      A,(MTASTI)      ;CONTROLLO SE
		CP      00H             ;SONO PASSATO
		JR      NZ,ERR1         ;DALLA TASIERA.
		LD      HL,0064H        ;SOMMO A ERPREC
		LD      BC,(ERPREC)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;ERATTU SE CARRY
		JR      NC,ERR2         ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
		LD      BC,(ERPREC)     ;LATA LA IGNORO.
		LD      (ERATTU),BC     
		LD	A,(SALTO)	;SE SALTO E'	EEUU
		CP	00H		;ZERO CORREGGO EEUU
		JR	Z,ERR7		;SEMPRE EEUU

		LD      A,(CONSAL)      ;CONTROLLA CHE NON
		DEC     A               ;CHE NON RIMANGA
		LD      (CONSAL),A      ;IN BLOCCO PER PIU'
		CP      00H             ;DI N GIRI MEMO- 
		JR      Z,ERR3          ;RIZZATI IN SALTO  
		JP      GIR1            ;E POI
ERR3:          
		LD      (ERATTU),DE     ;RICARICA L'ULTIMO 
		LD      (ERPREC),DE     ;ERRORE LETTO
		JR      ERR2            
ERR1:          
		DEC     A               ;ATTESA 4 GIRI SE
		LD      (MTASTI),A      ;PASSATO DA TATSI.
ERR2:           LD      A,(SALTO)       ;CARICA I GIRI DI
		LD      (CONSAL),A      ;ATTESA.
ERR7:		LD      A,(MKBUSY)      ;VEDO SE TASTIERA EEUU
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
ERR5:					;
                CALL    LMEDIA          ;WWAA
	        CALL    DISPLL          
                CALL    DISPLD         
ERR4:
		LD      HL,(BINSET)
                LD      (DISPRE),HL     
                LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR
                CALL    TRAVER
                LD      A,01H
                LD      (TMEM4),A
                CALL    CORTRA

		;CONTROLLO SOGLIA INSERZIONE

SOGLIN:         CALL    VELO
                LD      HL,(ISTVEL)     ;VVVVLD      HL,(VELMED)     
		LD      DE,(INSER)      
		SBC     HL,DE            
		JR      C,SOGLI2
SOGLI1:       
		LD      A,00H           ;FFLL
                LD      (PROTEZ),A      ;FFLL
                JR      ALLA1 
SOGLI2:         CCF
             	LD      A,05H           ;BLOCCO ALL.
		LD      (CONALL),A
		LD      A,07H           ;SE INSER E'
		LD      (MATTES),A      ;MAGGIORE
		LD      A,(MEMC)        ;BLOCC0 LA COR-
		RES     3,A             ;REZIONE E AL
		LD      (MEMC),A        ;TANDO I CICLI
		OUT     (PC),A          ;DI ATTESA.
		BIT     2,A             ;SE NON E' IN
                JP      Z,GIRO          ;AUTO SALTO
		CALL    LOWSPE          
                JP      GIRO

                ;CONTROLLO SOGLIA ALLARME CIRCONFERENZIALE 

ALLA1:          LD      A,(ALLAR)       ;SE ALLARME E'
		CP      00H             ;MESSO A ZERO
		JR      Z,NOALL         ;SALTA.
		LD      HL,(ALLAR)      ;CONTROLLO SE 
		LD      DE,(ERMEDI)     ;L'ERRORE HA SU-
		SBC     HL,DE           ;PERATO LA SOGLIA
		JR      NC,NOALL        ;DI ALLARME
		CCF
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
		JR      Z,NOALL
		LD      A,(CONALL)      ;CONTO 5 AVVISI
		CP      00H             ;PRIMA DI ATTIVA- 
		JR      Z,ALLA2         ;RE L'ALLARME
		DEC     A
		LD      (CONALL),A
		JR      GIRO
ALLA2:          LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
		JR      GIRO
NOALL:          LD      A,(MEMC)
		RES     3,A             ;DISATTIVO ALLARM
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,05H           ;CARICO 5 AVVISI
		LD      (CONALL),A      ;DI ALLARME


                ;CONTROLLO SOGLIA ALLARME TRASVERSALE 

	
                LD      A,(ALLAR)       ;SE ALLARME E'
		CP      00H             ;MESSO A ZERO
                JR      Z,NOALT         ;SALTA.
		LD      HL,(ALLAR)      ;CONTROLLO SE 
                LD      DE,(TERMED)     ;L'ERRORE HA SU-
		SBC     HL,DE           ;PERATO LA SOGLIA
                JR      NC,NOALT        ;DI ALLARME
		CCF
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
                JR      Z,NOALT
                LD      A,(CONALT)      ;CONTO 5 AVVISI
		CP      00H             ;PRIMA DI ATTIVA- 
                JR      Z,ALLAT         ;RE L'ALLARME
		DEC     A
                LD      (CONALT),A
		JR      GIRO
ALLAT:          LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
		JR      GIRO
NOALT:          LD      A,(MEMC)
		RES     3,A             ;DISATTIVO ALLARM
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,05H           ;CARICO 5 AVVISI
                LD      (CONALT),A      ;DI ALLARME

GIRO:           CALL    CORREZ


		;ROUTINE DI ATTESA

                
                
GIR1:           EI                      ;õõõõõõõõõõõõõõ

                LD      A,(MEMC)        ;SE SONO IN BBLL
                BIT     2,A             ;MANUALE
                JR      NZ,G14          ;DISATTIVO EEOO
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL

G14:            LD      A,(MEM8A)       ;CCMM
                CP      00H
                JR      Z,G11
                LD      A,(MESSA)       ;CCMM
                CP      01H             ;CCMM
                JR      Z,G12
                CP      02H
                JR      Z,G12
                JR      Z,G11
G12:            CALL    CORCAL          ;CCMM
                CALL    FADA            ;CCMM11
                CALL    RITDIS
G11:           
		LD      A,(MFLEXL)      ;FFZZ
                CP      01H
                JR      NZ,G10
                LD      A,(MEMC)        ;FFZZ
                BIT     2,A
                JR      Z,G10
                CALL    FLEXOL
G10:           
		LD      A,(MFLEXT)      ;FFZZ
                CP      01H
                JR      NZ,G9
                LD      A,(MEMC)        ;FFZZ
                BIT     4,A
                JR      Z,G9
                CALL    FLEXOT          ;FFZZ
G9:            
		LD      A,(MKBUSY)      ;SE STO USANDO
		CP      01H             ;LA TASTIERA
		JR      NZ,G6           ;BLOCCO LE 
                CALL    RESEPC          ;FFLL
G6:             LD      A,(PROTEZ)
                CP      00H
                JR      Z,G7
                LD      A,(INFLAS)      ;   FFLL
                DEC     A               ; FFLL
                LD      (INFLAS),A      ; FFLL
                CP      00H             ; FFLL
                JR      NZ,G7
                CALL    FLASH           ; FFLL
G7:            
		LD      BC,01FFH		;01FFH       ;OOOO QUESTO
G1:             DEC     BC             ;VALORE VA BENE
                LD      A,B            ;DOPO AVER  RIMESSO
                OR      C              ;A MAIN1 JP Z,GIR1
                JR      NZ,G1          ;E NON Z,SOGLIN

                LD      BC,01FFH	;	01FFH       ;OOOO
G2:            
		DEC     BC
		LD      A,B
		OR      C
		JR      NZ,G2

		LD      A,(MKBUSY)      ;SE TASTIERA 
		BIT     0,A             ;IN USO SALTA
		JR      NZ,G3
                LD      BC,01FFFH
G4:            
		DEC     BC
                LD      A,B
                OR      C
                JR      Z,G8
                IN      A,(PB)          ;SOLO QUANDO LA
		BIT     4,A             ;MACCHINA GIRA
		JR      Z,G4            ;ESEGUE IL CON-
G5:             DEC     BC              ;TROLLO SE NO
                LD      A,B             ;ASPETTA E
                OR      C               ;METTE ZERO
                JR      Z,G8            ;ALLA VELOCITA'
                IN      A,(PB)          
                BIT     4,A             
		JR      NZ,G5
                JR      G3
G8:
                LD      A,(MKBUSY)      ;SE TASTIERA  CCMM
		BIT     0,A             ;IN USO SALTA
		JR      NZ,G3
                LD      A,48
                LD      (NUMCOL+11H),A
                LD      (NUMCOL+12H),A
                LD      (NUMCOL+13H),A
                LD      A,(SEQSEG)      ;NNCC
                ADD     A,48            ;NNCC
                LD      (NUMCOL+09H),A  ;NNCC
                CALL    INISI
                LD      HL,NUMCOL
                CALL    TX
                CALL    FLASH           ;FFLL22

                LD      DE,0000H        ;AAVV
                LD      (VELBCD),DE     ;AZZERO LE MEM.
                LD      HL,VELBCD       ;DELLA MEDIA
                LD      DE,VELBCD+01H   ;E DELLA 
                LD      BC,002FH        ;VVVVLD      BC,001FH        ;VELOCITA V 
                LDIR
                CALL    RESEPC          ;FFLL22
                LD      A,00H
                LD      (PROTEZ),A      ;FFLL22
                LD      A,(MEMC)        ;DISTTIVO BBLL
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL
G3:
                JP      FASAUT


		;CALCOLO PUNTO MEDIO PER REGISTRO COLORE MMLL
		;SOLO LONGITUDINALE

PUNMED:

		CALL	TRAVER		;MMLL


		;CALCOLO VALORE TOTALE DEL PUNTO MEDIANO DEL SEGNO

		LD	HL,(TPOST1)	;SOTTRAGGO IL VALORE DI MMLL
		LD	DE,(POSTO1)	;FINE SEGNO CON QUELLO INIZIALE
		SBC	HL,DE
		JR      NC,ZX1          ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST1)     ;TPOST1<POSTO1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO1)     ;A POSTO1 40960
		SBC     HL,DE           ;E RIPETO SBC.
ZX1:
		LD      (DIVDEN),HL     ;IL VALORE CHE RAPPRESENTA 
		LD      BC,0002H        ;LO SPESSORE  LO DIVIDO
		LD      (DIVSOR),BC     ;PER DUE IL RISULTATO 
		CALL    DIVIS           ;LO SOMMO A POSTO1
		LD      HL,(QUOZIE)	;E OTTENGO COSI UN 
		LD	DE,(POSTO1)	;VALORE CHE CORRISPONDE
		ADD	HL,DE		;ALCENTRO DEL SEGNO
		LD	(CPOST1),HL	;SSSS

		LD	HL,(TPOST2)	;SOTTRAGGO IL VALORE DI MMLL
		LD	DE,(POSTO2)	;FINE SEGNO CON QUELLO INIZIALE
		SBC	HL,DE
		JR      NC,ZX2          ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST2)     ;TPSTO2<POSTO2
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO2)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC.
ZX2:
		LD      (DIVDEN),HL     ;IL VALORE CHE RAPPRESENTA
		LD      BC,0002H        ;LO SPESSORE  LO DIVIDO
		LD      (DIVSOR),BC     ;PER DUE IL RISULTATO 
		CALL    DIVIS           ;LO SOMMO A POSTO2
		LD      HL,(QUOZIE)	;E OTTENGO COSI UN
		LD	DE,(POSTO2)	;VALORE CHE CORRISPONDE
		ADD	HL,DE		;ALCENTRO DEL SEGNO
		LD	(CPOST2),HL	;SSSS
		LD	DE,(CPOST1)
		SBC	HL,DE		;
		JP      NC,Z1           ;SE LA MISURA E' MMLL
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(CPOST2)     ;CPOST2<CPOST1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(CPOST1)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC. MMLL
		JP	Z1		;MMLL



                ;GESTIONE TASTIERA


PIOA:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

		LD      A,04H           ;SERVE IN ERR1
		LD      (MTASTI),A      ;PER E ELIMINARE
		LD      A,(MEMA)        ;IL SALTO QUANDO 
		RES     7,A             ;DA TASTIERA IN
		OUT     (PA),A          ;AUTO O IN MANUA-
		LD      (MEMA),A        ;LE SI FA UN GROS-
                LD      DE,1FFFH        ;SO SPOSTAMENTO. TTPP
KRIT1:          DEC     DE                
		LD      A,D
		OR      E
		JR      NZ,KRIT1
		IN      A,(PA)          
		BIT     4,A
		JP      NZ,ESCI
                CALL    SERITA
                LD      C,(HL)          ;DA LETTURA SE 
                LD      DE,1FFFH        ;SONO EGUALI      TTPP
KRIT2:          DEC     DE              ;PROCEDO SE NO 
		LD      A,D             ;ESCO
		OR      E
		JR      NZ,KRIT2
		IN      A,(PA)
		BIT     4,A
		JP      NZ,ESCI
                CALL    SERITA
		LD      A,(HL)          ;SECONDA LETTURA
                CP      C               ;C= PRIMA LETTU-
                JP      NZ,ESCI         ;RA
		LD      A,(MDBUSY)      ;SE IL DISPLAY
		CP      00H             ;E' OCCUPATO 
		JR      Z,PIOA1         ;DALL'ERRORE DI
		LD      A,00H           ;REGISTRO LO
		LD      (MDBUSY),A      ;CANCELLO
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A
                LD      (PROTEZ),A      ;CCMM

PIOA1:          LD      A,01H           ;SEGNALA L'USO
		LD      (MKBUSY),A      ;DELLA TATSIERA
		LD      A,(HL)          
		CP      0AH
                JP      Z,CLEA1
		CP      0BH
		JP      Z,ENTE1
		LD      A,(MEM0)        ;CONTROLLO SE 
		BIT     0,A             ;INSERITE FUN-
		JP      NZ,KBRD1        ;ZIONI
		LD      A,(MEM1)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM2)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM3)
		BIT     0,A
		JP      NZ,KBRD1
                LD      A,(MEM5)        ;FF55
		BIT     0,A
		JP      NZ,KBRD1
                LD      A,(MEM8)         ;CCMM
		BIT     0,A
		JP      NZ,KBRD1

		LD      A,(HL)          ;CONTINUO LA
		CP      0DH             ;LA CODIFICA
                JP      Z,MENO1         ;DELLA TASTIERA
		CP      0CH
                JP      Z,PIU1
                CP      0EH             ;T24
                JP      Z,MANC
                CP      10H             ;T24
                JP      Z,AUTOC
                CP      11H
                JP      Z,MANT
                CP      12H
                JP      Z,AUTOT
                CP      13H
                JP      Z,OPERA
                CP      14H
                JP      Z,TRAS
                CP      15H
                JP      Z,PUNTO
                CP      16H
                JR      NZ,PIOA2        
                CALL    MODPA
		CALL	INIZIO
PIOA2:          CP      17H
                JR      NZ,PIOA3        ;T24  
                CALL    TEST
PIOA3:          LD      A,(MEMTF)       ;CONTROLLO SE
		CP      00H             ;PIGIATO PRECE-
                JP      NZ,FUNZI        ;DENTEMENTE F
		LD      A,(HL)
		CP      0FH
		JP      Z,FUNZI
		CP      0AH             ;SE NON E' UN
		JR      NC,NONUM        ;NUMERO SALTA
		CALL    MUOVO
                EXX                     ;D111
                CALL    BIOTTD
                XOR     A               ;CALL    BIOTT
NONUM:          LD      (MEMTF),A       ;MEMORIZZA
		JP      ESCI            ;LA FUNZIONE

CLEA1:          LD      A,00H           ;CANCELLA
		LD      IX,BINSET+06H   ;LE MEMORIE
		LD      (IX+00H),A      ;TEMPORANEE
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A  ;E LA LETTERA
		LD      (MEM0),A        ;AZZERO MEMORIE
		LD      (MEM1),A
		LD      (MEM2),A        
		LD      (MEM3),A

                LD      (MEM5),A        ;OOOO FF55
                LD      (MEM8),A        ;CCMM

		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MRIC+04H),A
                LD      (MRIC+06H),A    ;PPDD
		LD      (MEMTF),A       ;AZZERO MEM.
		LD      (MEMID),A       ;TASTO F E INIZIA-
		LD      (MDATER),A      ;LIZAZZIONE DISP.
                LD      (MKBUSY),A      ;DATA ERROR E
                LD      A,(SEQSEG)
                ADD     A,48
                LD      (NUMCOL+09H),A  
                CALL    INISI           
                LD      HL,NUMCOL
                CALL    TX
                JP      ESCI
MENO1:
                LD      A,(MEM8)        ;CCMM
                BIT     0,A
                JR      Z,MENO2
                LD      A,01H
                LD      (MEM8A),A       ;CCMM
                CALL    BCDBIN          ;CCMM
                JP      CLEA1           ;CCMM
MENO2:
                LD      A,(MEMC)        ;SE MANUALE
                BIT     2,A             ;MOTORE RITARDO
                JP      Z,MANRIT
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,RITM
                CP      01H
                JR      Z,RITI
                CP      02H
                JR      Z,RITF
                CP      03H
                JR      Z,RITGB
                CP      04H
                JR      Z,RITE
                CP      05H
                JR      Z,RITD          ;DDDD

RITM:           CALL    INISI
                LD      HL,RITARD
                JR      RITTX
RITI:           CALL    INISI
                LD      HL,RITARD+14H
                JR      RITTX
RITF:           CALL    INISI
                LD      HL,RITARD+28H
                JR      RITTX
RITGB:          CALL    INISI
                LD      HL,RITARD+3CH
                JR      RITTX
RITE:           CALL    INISI
                LD      HL,RITARD+50H
                JR      RITTX
RITD:           CALL    INISI
                LD      HL,RITARD+64H
RITTX:          
		CALL    TX
                LD      A,40H           ; -
		LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI
PIU1:
                LD      A,(MEM8)        ;CCMM
                BIT     0,A
                JR      Z,PIU2
                LD      A,02H
                LD      (MEM8A),A       ;CCMM
                CALL    BCDBIN          ;CCMM
                JP      CLEA1           ;CCMM
PIU2:
                LD      A,(MEMC)        ;SE MANUALE
                BIT     2,A             ;MOTORE AVANTI
                JP      Z,MANAVA
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,AVAM
                CP      01H
                JR      Z,AVAI
                CP      02H
                JR      Z,AVAF
                CP      03H
                JR      Z,AVAGB
                CP      04H
                JR      Z,AVAE
                CP      05H
                JR      Z,AVAD          ;DDDD

AVAM:           CALL    INISI
                LD      HL,AVANTI
                JR      AVATX
AVAI:           CALL    INISI
                LD      HL,AVANTI+14H
                JR      AVATX
AVAF:           CALL    INISI
                LD      HL,AVANTI+28H
                JR      AVATX
AVAGB:          CALL    INISI
                LD      HL,AVANTI+3CH
                JR      AVATX
AVAE:           CALL    INISI
                LD      HL,AVANTI+50H
AVAD:           CALL    INISI
                LD      HL,AVANTI+64H
AVATX:          
		CALL    TX
                LD      A,70H           ; +
		LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI
                
OPERA:
		LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
                CP      02H             ;LONGITUDINALE
                JP      Z,ESCI	
		LD      A,(MEM8)        ;CCMM
                BIT     0,A
                JR      Z,OPERA1
                LD      A,03H
                LD      (MEM8A),A       ;CCMM
                CALL    BCDBIN          ;CCMM
                JP      CLEA1           ;CCMM
OPERA1:
                LD      A,(MEMC)        ;SE MANUALE
                BIT     4,A             ;TRAVERS MOTORE
                JP      Z,MANOPE        ;LATO OPERATORE
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,OPEM
                CP      01H
                JR      Z,OPEI
                CP      02H
                JR      Z,OPEF
                CP      03H
                JR      Z,OPEGB
                CP      04H
                JR      Z,OPEE
                CP      05H             ;DDDD
                JR      Z,OPED

OPEM:           CALL    INISI
                LD      HL,OPERAT
                JR      OPETX
OPEI:           CALL    INISI
                LD      HL,OPERAT+14H
                JR      OPETX
OPEF:           CALL    INISI
                LD      HL,OPERAT+28H
                JR      OPETX
OPEGB:          CALL    INISI
                LD      HL,OPERAT+3CH
                JR      OPETX
OPEE:           CALL    INISI
                LD      HL,OPERAT+50H
                JR      OPETX
OPED:           CALL    INISI
                LD      HL,OPERAT+64H
OPETX:         
		CALL    TX              
                LD      A,(DIAGON)     ;ADEGUAMENTO BBUU
                CP      01H            ;ALLA POSIZIO-
                JR      Z,BAUM         ;NE DELLA 
                LD      A,78H          ;IPOTENUSA
                JR      BAUM1
BAUM:         
		LD      A,3FH           ; O
BAUM1:          LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI



TRAS:
           	LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
                CP      02H             ;LONGITUDINALE
                JP      Z,ESCI	
		LD      A,(MEM8)        ;CCMM
                BIT     0,A
                JR      Z,TRAS1
                LD      A,04H
                LD      (MEM8A),A       ;CCMM
                CALL    BCDBIN          ;CCMM
                JP      CLEA1           ;CCMM
TRAS1:
                LD      A,(MEMC)        ;MANUALE TRAV
                BIT     4,A             ;MOTORE LATO
                JP      Z,MANTRA        ;TRASMISSIONE
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,TRAM
                CP      01H
                JR      Z,TRAI
                CP      02H
                JR      Z,TRAF
                CP      03H
                JR      Z,TRAGB
                CP      04H
                JR      Z,TRAE
                CP      05H
                JR      Z,TRAD          ;DDDD
TRAM:           
		CALL    INISI
                LD      HL,TRASMI
                JR      TRATX
TRAI:           CALL    INISI
                LD      HL,TRASMI+14H
                JR      TRATX
TRAF:           CALL    INISI
                LD      HL,TRASMI+28H
                JR      TRATX
TRAGB:          CALL    INISI
                LD      HL,TRASMI+3CH
                JR      TRATX
TRAE:           CALL    INISI
                LD      HL,TRASMI+50H
                JR      TRATX
TRAD:           CALL    INISI
                LD      HL,TRASMI+64H
TRATX:         
		CALL    TX              
                LD      A,(DIAGON)     ;ADEGUAMENTO  BBUU
                CP      01H            ;ALLA POSIZIO-
                JR      Z,BAUM2        ;NE DELLA 
                LD      A,3FH          ;IPOTENUSA
                JR      BAUM3
BAUM2:          
		LD      A,78H           ; t    
BAUM3:          LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI
ENTE1:        
	        LD      A,(MEM5)        ;FF5555
                BIT     0,A             ;FF5555
                JP      NZ,ENTE34       ;FF5555

		LD      A,(MEM0)
		BIT     0,A
		JP      NZ,FUN3
		LD      A,00H           ;AZZERO MEM.
		LD      (MEM0),A
		LD      (MEM1),A
		LD      (MEM2),A
		LD      (MEM3),A
                LD      (MEM5),A        ;OOOO
                LD      (MEM8),A        ;CCMM
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MRIC+06H),A
		LD      (MRIC+08H),A
 		LD      (MEMTF),A       ;TASTO F E INI-
		LD      (MEMID),A       ;ZIALIZZAZIONE
		CALL    BCDBIN          ;DISPLAY
		LD      A,(BINSET+10H)  ;SE SELEZIONATO
		CP      40H             ;MENO SALTO
		JP      Z,ENTE3         ;SE SELEZIONATO
		CP      70H             ;PIU' SALTO
		JP      Z,ENTE3
                CP      3FH             ;SE SELEZIONATO
                JP      Z,ENTE3         ;OPERATORE SALTO
                CP      78H             ;SE SELEZIONATO
                JP      Z,ENTE3         ;TRASMISS. SALTO
		CP      73H             ;SE SELEZIONATO
		JP      Z,ENTE4         ;P SALTO
                CP      39H             
                JP      NZ,ENTE2   
		CALL    INTCOR          ;AGGIORNA CICLI
                CALL    TINTCO          ;FOFF
		LD      DE,(CILIN)      ;MOLTIPLICO PER
		LD      (MOLTI),DE      ;10 IL CILINDRO
		LD      A,0AH           ;PER POTER USARE
		LD      (MOLPL),A       ;AGGIUSTAMENTO
		CALL    MOLT            ;DECIMALE
		LD      BC,(PROD)
		LD      (CILMOL),BC     ;CILINDRO x 10
		LD      (MDO032),BC
		LD      DE,0000H        
		LD      (MDO232),DE     
		LD      BC,03E8H         
		LD      (MRE032),BC      
		LD      (MRE232),DE     
		CALL    MOL32
		LD      BC,(PTO032)     ;CILNDRO X 10000
		LD      DE,(PTO232)
		LD      (EDEND0),BC
		LD      (EDEND2),DE
		CALL    DIV32
		LD      DE,(QUOZ32)
		LD      (DMILLE),DE     ;DECIMILLESIMI
		LD      (DIVDEN),DE     ;CALCOLO QUANTI
		LD      BC,000AH        ;MILLESIMI CI 
		LD      (DIVSOR),BC     ;SONO IN UN
		CALL    DIVIS           ;CILINDRO
		LD      DE,(QUOZIE)
		LD      (MILLES),DE     ;MILLESIMI
		LD      (DIVDEN),DE     ;DIVIDO PER 10
		LD      BC,000AH        ;PER AVERE 
		LD      (DIVSOR),BC     ;I CENTESIMI
		CALL    DIVIS           
		LD      DE,(QUOZIE)
		LD      (CENTES),DE
		LD      DE,(CILIN)      ;DIVISIONE DEL
		LD      (DIVDEN),DE     ;CILNDRO PER 10
		LD      BC,000AH
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      (CILDIV),DE
		LD      DE,2710H        ;10000/DMILLE=                                     
		LD      (DIVDEN),DE     ;IMPULSI ENCO-
		LD      DE,(DMILLE)     ;DER PER 1mm
		LD      (DIVSOR),DE     
		CALL    DIVIS           
		LD      DE,(QUOZIE)     
		LD      (UNOMIL),DE

                LD      A,00H           ;CCDD
                LD      D,A             ;CCDD
                SRL     E               ;CCDD
                LD      A,E             ;CCDD
                LD      (IMPMIL),DE     ;CCDD

                 
 
		;VERIFICA SE CILINDRO INFERIORE A 9"  NNCC

                LD      HL,(CILIN)	;SSRR
                LD      DE,00E6H        ;230 (9")
                SBC     HL,DE		;SE CILINDRO
                JR      NC,SILVC1	;PICCOLO METTO 
                CCF			;UNO IN NANOCI
                LD      A,01H
                JR      SILVC2
SILVC1:         LD      A,00H
SILVC2:         LD      (NANOCI),A


                ;SE CILINDRO INFERIORE A 6" SEGNALO ERRORE NNCC

                LD      HL,(CILIN)	;SSRR
                LD      DE,0098H        ;152 (6")
                SBC     HL,DE
                JR      NC,SILVC3
                CCF
		LD      A,01H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR
                JP      ESCI



                ;CALCOLO VALORI PER RICERCA

SILVC3:					;SSRR    

		LD	A,(DIAGON)	;SE E'IN MM SOLO MMLL
		CP	03H		;LONGITUD. CALCOLO VALORI
		JR	NZ,SILVC4	;DIVERSI DI MILL60 E MILL70
					 
	        LD      DE,1D40H        ;7488 WWWW BBBA
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL60),HL     ;6,0 mm 

	        LD      DE,23A6H        ;9126 EEUU
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL70),HL     ;7 mm

;ATTENZIONE QUESTO VALORE DI MILL45 MON E' STATO VERIFICATO

		LD      DE,15F0H        ;5616 
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL45),HL     ;4,5 mm 

		JR	SILVC5
SILVC4:					;MMLL
	        LD      DE,1770H        ;6000 WWWW BBBA
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL60),HL     ;6,0 mm 

	        LD      DE,1B94H        ;7060 EEUU
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL70),HL     ;7 mm


		LD      DE,1194H        ;4500 SSRR
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL45),HL     ;4,5 mm 

SILVC5:					;MMLL
                LD      DE,8868H        ;=35000 DEVRIM SSRR
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL35),HL     ;35mm


      
                LD      DE,0AF0H        ;2800 WWWW  BBAA
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL28),HL     ;28 mm   BBAA

                LD      (MOLTI),HL      ;MOLTIPLICO PER TTGG
                LD      A,0AH           ;10 PER AVERE
                LD      (MOLPL),A       ;LA DISTANZA
                CALL    MOLT            ;TRA IL IøSEGNO
                LD      HL,(PROD)       ;DEL CODE E LA
                LD      (SPACOD),HL     ;Iø MARCA TTGG


		LD      DE,4E20H        ;=20000
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      (MILL20),HL     ;20mm
                LD      DE,0E4EH        ;4000x4096=  
                LD      (MDO032),DE     ;1638400
                LD      DE,0000H        ;60\1638400=
                LD      (MDO232),DE     ;0,000003662
                LD      (MRE232),DE     ;3662=0E4EH
                LD      DE,(CILIN)
                LD      (MRE032),DE
                LD      A,02H           
                LD      (ALTDIV),A      
                CALL    MOL32
                CALL    DI1000
                LD      BC,(QU1000)
                LD      (COSVEL),BC     ;COSTANTE VEL. 


                LD      DE,06A4H        ;1700 VIENE  SSPP
                LD      (DIVDEN),DE     ;MESSO QUESTO SSPP
                LD      BC,(MILLES)     ;VALORE PER  SSPP
                LD      (DIVSOR),BC     ;IL SEGNO E SSPP
                CALL    DIVIS           ;MA DOVREBBE SSPP 
                LD      HL,(QUOZIE)     ;ESSERE 2000 SSPP
                LD      (SEGNO),HL      ;COME LOGICA SSPP
                DEC     HL              ;SSPP
                LD      (SPAZIO),HL     ;SSPP


                LD      DE,(MILL28)     ;QUESTO CALCO- FFXX BBAA
                LD      (MOLTI),DE      ;LO DA CIRCA 
                LD      A,06H           ;UNO SPAZIO  BBAA
                LD      (MOLPL),A       ;DI 30mm REA-
                CALL    MOLT            ;LI MA VANNO
                LD      DE,(PROD)       ;BENE PER AVER
                LD      (SPAZ40),DE     ;TOLLERANZA  FFXX


                ;CALCOLO POSIZIONE GATE1 NELL'OSCILLOSCOPIO OOOO

                LD      HL,(SPACOD)     ; TTGG
                LD      (DIVDEN),HL     ;DIVIDO IL
                LD      BC,(IMPMIL)     ;NUMERO DI 
                LD      B,00H           ;IMPULSI TRA IL
                LD      (DIVSOR),BC     ;TRIGGER E LA
                CALL    DIVIS           ;FASE PER IMP-
                LD      DE,(QUOZIE)     ;MIL+1 IL VALORE
                LD      (BINSET),DE     ;OTTENUTO LO
                CALL    AGGIUS          ;AGGIUSTO PER
                LD      DE,(QUOZIE)     ;ELIMINARE LE 
                LD      (DIVDEN),DE     ;UNITA' E POI
                LD      BC,000AH        ;DIVIDO PER 10
                LD      (DIVSOR),BC     ;E OTTENGO LA
                CALL    DIVIS           ;POSIZIONE DEL
                LD      DE,(QUOZIE)     ;CARATTERE DOVE
                
                INC     E               ;CCDD

                LD      (POSGA1),DE     ;INIZIA IL GATE
                LD      A,01H           
                LD      (MAGGI1),A      ;AGGIUSTAMENTO
                LD      DE,(AMPGA)      ;PER PORTARE
                LD      (QUOZIE),DE     ;A 0 O 5
                LD      (BINSET),DE     ;AMPGATE PER
                CALL    AGGIUS          ;L'OSCILLOSCOPIO
                LD      DE,(QUOZIE)     ;E SAPERE I 
                LD      (GATOSC),DE     ;CARATTERI OC-
                NOP                     ;CUPATI DAL GATE OOOO

ENTE2:          JP      CLEA1           ;CCOO JR      ENTE4           ;JP      CLEA1 CCPP
                NOP                     ;CCOO

ENTE3:          LD      A,(BINSET+10H)   
                CP      40H
		JR      Z,ENTE31
                CP      70H
                JR      Z,ENTE31

		LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JR      NZ,ENTE35
                CALL    TSPOST
		JR	ENTE33		;MMXX
ENTE35:		CALL	MCSPOST
		JP      CLEA1
ENTE31:
                LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JR      NZ,ENTE32
                CALL    SPOSTA          ;MMCC
                JR      ENTE33
ENTE32:         CALL    XPOSTA          ;MMCC
ENTE33:		JP      CLEA1		

ENTE34:                                 ;FF5555
                LD      HL,(FASE)       ;CARICO IL FF5555 
                LD      A,H             ;CONTATORE PER FF5555
                OUT     (20H),A         ;LEGGERE POI S1 FF5555
                LD      A,L             ;FF5555
                OUT     (10H),A         ;FF5555
                LD      A,00H
                LD      (MEM5),A
                LD      (MOLTI),HL      ;MOLTIPLICO PER FF5555
                LD      A,0AH           ;10 PER AVERE IL
                LD      (MOLPL),A       ;RIFERIMENTO TO-
                CALL    MOLT            ;TALE TRASCURAN-
                LD      DE,(PROD)       ;DO IL RAPPORTO
                LD      (RIFTOT),DE
                LD      A,01H           ;FF56
                LD      (MOSCI1),A      ;FF56
		LD	A,02H		;FF58
		LD	(MEMRIF),A
                JP      CLEA1           ;FF5555



                ;CALCOLO VALORI GATE1  WWWW

ENTE4:
                LD      A,01H           ;PER SALTARE CCPP
                LD      (MRIC+04H),A    ;CALL CODICE CCPP

		LD	A,(MM_MC)	;MMXX
		CP	00H		;SE MM SALTA
		JR	Z,ENTE44
		CP	01H		;SE MC	SALTA
		JR	Z,ENTE46
		LD	A,(SEQSEG)
		CP	01H
		JR	Z,ENTE44
		LD	DE,10H		;SE NON PRIMO 16mm
		JR	ENTE45
ENTE44:					;SE PRIMO 
                LD      DE,0EH          ;FISSO A 14mm 
		JR	ENTE45
ENTE46:
		LD	A,00H		;IMPONI ZERO NNCC
		LD	(SEQSEG),A	;SU DISPLAY
                LD      DE,(AMPGA)
                LD      (MOLTI),DE      ;AMPIEZZA GATE
                LD      A,64H           ;PER 100
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;AMPIEZA IN CENT.
		LD      (DIVDEN),DE
                LD      BC,(CENTES)     ;
		LD      (DIVSOR),BC
		CALL    DIVIS           ;AMPIEZZA GATE IN
		LD      DE,(QUOZIE)     ;IMPULSI ENCODER
					;NNCC
		LD      A,D             ;CONTROLLO SE IL   MMMM
		CP      00H             ;RISULTATO E'MAG-
		JR      Z,ENTE41        ;GIORE DI 255.
		LD      D,00H           ;SE LO E'IMPONGO
		LD      E,0FFH          ;COME VALORE MAX
		LD      (MOLTI),DE      ;255 E RIPETO LE
		LD      A,(CENTES)      ;OPERAZIONI 
		LD      (MOLPL),A       ;ALL'INVERSO PER
		CALL    MOLT            ;PER CALCOLARE IL
		LD      DE,(PROD)       ;NUOVO AMPAG RI-
		LD      (DIVDEN),DE     ;FERITO A 255.
		LD      BC,0064H
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      (AMPGA),DE

		JP      ENTE4           ;MMMM

ENTE45:
		LD      (AMPGA),DE      ;PER OSCIL  LLTT
                LD      (MOLTI),DE      ;AMPIEZZA GATE
		LD      A,64H           ;PER 100
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;AMPIEZA IN CENT.
		LD      (DIVDEN),DE
		LD      BC,(CENTES)
		LD      (DIVSOR),BC
		CALL    DIVIS           ;AMPIEZZA GATE IN
                LD      DE,(QUOZIE)     ;IMPULSI ENCODER.
                LD      A,D             ;SE E' MAGGIORE
                CP      00H             ;DI 255 IMPONGO
                JR      Z,ENTE41        ;255
                LD      DE,00FFH
ENTE41:         LD      (AMPIM1),DE     ;WWWW

                ;CALCOLO VALORI GATE2  WWWW


                LD      DE,12H          ;FISSO A 18mm MMXX
                LD      (MOLTI),DE      ;AMPIEZZA GATE
                LD      A,64H           ;PER 100
                LD      (MOLPL),A
                CALL    MOLT
                LD      DE,(PROD)       ;AMPIEZA IN CENT.
                LD      (DIVDEN),DE
                LD      BC,(CENTES)
                LD      (DIVSOR),BC
                CALL    DIVIS           ;AMPIEZZA GATE IN
                LD      DE,(QUOZIE)     ;IMPULSI ENCODER.
                LD      A,D             ;SE E' MAGGIORE
                CP      00H             ;DI 255 IMPONGO
                JR      Z,ENTE43        ;255
                LD      DE,00FFH
ENTE43:         LD      (AMPIM2),DE     ;WWWW



                LD      DE,(AMPIM2)     ; MMCC 
                LD      (MOLTI),DE      ;MOLTIPL. 
                LD      A,0AH           ; 
                LD      (MOLPL),A       ;PER 10  
                CALL    MOLT            ;
		LD      DE,(PROD)
                LD      (AMPI10),DE     ;MMCC


;
		;CALCOLO IL 40% DEI VALORI IN AMPIM E MMXX
		;LI MEMORIZZO IN OGNI SPECIFICO MEZGA

		LD	BC,(AMPIM1)	;MMXX	
		LD	(PERCE),BC
		CALL	PERC40
		LD	DE,(RISPER)
		LD	(MEZGA1),DE
		LD	(MEZGA),DE	;PROVVISORIO
		LD      DE,(AMPIM2)	;CALCOLO DEL	MMXX     
		LD      (MOLTI),DE	;BIANCO BBBB
                LD      A,96H           ;CHE E'IL 150% BBBB 
		LD      (MOLPL) ,A      ;DI AMPIMP BBBB
                CALL    MOLT            ;
		LD      DE,(PROD)       
		LD      (DIVDEN),DE
		LD      BC,0064H
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
                LD      (BIANCO),DE      ;BBBB


                LD      DE,(AMPGA)      ; SSCC
		LD      (MOLTI),DE
                LD      A,28H           ;CALCOLO IL 40% 
		LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
		CALL    MOLT            ;GATE
		LD      DE,(PROD)       
                LD      (AMPI40),DE     ;GATE IN CENTS     

		LD      DE,7D0H         ;2000 = 20mmX100
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
                LD      BC,(SEGRIF)     ;SSRR
                SBC     A,C             ;SSRR
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
               	LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
                LD      HL,(PTO232)     ;SIA PER LONG.
                LD      (DISTA2),HL     ;CHE PER TRAVERS
                
	        CALL    INTCOR          ;AGGIORNA CICLI
                CALL    TINTCO          ;FOFF

                CALL    IIGATE          ;IIGG

		LD      A,(MRIC+04H)
		CP      01H
		JR      Z,ENTE42
		CALL    CODICE

ENTE42:
                LD      A,01H           ;PER AVERLO OOOO
                LD      (MAGGI1),A      ;ANCHE SOLO IN
                LD      DE,(AMPGA)      ;CAMBIO AMPIEZZA
                LD      (QUOZIE),DE     ;GATE
                LD      (BINSET),DE     ;VEDI SOPRA
                CALL    AGGIUS          ;IN CALCOLO GATE
                LD      DE,(QUOZIE)     ;PER OSCILLO. 
                LD      (GATOSC),DE     


                ;CALCOLO POSIZIONE GATE2 NELL'OSCILLOSCOPIO CCPP OO22


                LD      HL,(CILIN)       ;CALCOLO 12,5%
                LD      (MOLT24),HL      ;DEL CILINDRO
                LD      A,7DH            ;125
                LD      (MOLP24),A
                CALL    MOL24
                LD      A,00H
                LD      (PROD24+03H),A
                CALL    DI2000



                LD      A,(SEQSEG)      ;OO22
                CP      02H
                JR      NZ,SEQUE3
                LD      A,14H           ;20
                JR      SEQFIN
SEQUE3:         CP      03H
                JR      NZ,SEQUE4
                LD      A,28H           ;40
                JR      SEQFIN
SEQUE4:         CP      04H
                JR      NZ,SEQUE5
                LD      A,3CH           ;60
                JR      SEQFIN
SEQUE5:         CP      05H
                JR      NZ,SEQUE6
                LD      A,50H           ;80
                JR      SEQFIN
SEQUE6:         CP      06H
                JR      NZ,SEQUE7
                LD      A,64H           ;100
                JR      SEQFIN
SEQUE7:         CP      07H
                JR      NZ,SEQUE8
                LD      A,78H           ;120
                JR      SEQFIN
SEQUE8:         CP      08H
                JR      NZ,SEQUE9
                LD      A,8CH           ;140
                JR      SEQFIN
SEQUE9:         CP      09H
                JR      NZ,SEQERR
                LD      A,0A0H          ;160

         
                ;IL CALCOLO SI FA DISTANZA IN MILLIMETRI DAL
                ;PRIMO GATE PER 256 DIVISO IL 12,5% DEL CILINDRO
                ;OTTENGO LA DISTANZA FRA I DUE GATE IN IMPULSI
                ;GLI IMPULSI LI DIVIDO PER IMPMIL E OTTENGO LA
                ;DISTANZA TRA I GATE IN PUNTI DISPLAY DIVIDO
                ;QUESTA PER 5 E OTTENGO LA POSIZIONE FINALE

SEQFIN:
                LD      (MOLPL),A
                LD      DE,00FFH        ;256
                LD      (MOLTI),DE
                CALL    MOLT
                LD      DE,(PROD)

                LD      (DIVDEN),DE
                LD      BC,(CILI12)
                LD      (DIVSOR),BC
                CALL    DIVIS             ;IMPULSI DA 2048
                LD      DE,(QUOZIE)       ;IN 12,5% DI CILIN      
                LD      (DIVDEN),DE
                LD      BC,(IMPMIL)
                LD      B,00H
                LD      (DIVSOR),BC
                CALL    DIVIS
                LD      DE,(QUOZIE)       ;PUNTI DI DISPLAY

                LD      (DIVDEN),DE
                LD      BC,0005H
                LD      (DIVSOR),BC
                CALL    DIVIS
                LD      DE,(QUOZIE)
                LD      A,E
                LD      BC,(POSGA1)
                ADD     A,C

                LD      (POSGA2),A
                JR      SEQEND
SEQERR:         CALL	CONTR		;CALL    ERROR EEUU
                CALL    RITDIS
SEQEND:         JP      CLEA1


FUNZI:          LD      A,00H           ;RESETTO PORTA C
		LD      (MEMC),A        ;IMPONENDO MANUALE
		OUT     (PC),A
		LD      A,(HL)          ;ASPETTO CHE    
		LD      (MEMTF),A       ;VENGA SCELTA
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FUNM
                CP      01H
                JR      Z,FUNI
                CP      02H
                JR      Z,FUNF
                CP      03H
                JR      Z,FUNB
                CP      04H
                JR      Z,FUNE
                CP      05H
                JR      Z,FUND          ;DDDD

FUNM:           CALL    INISI
                LD      HL,FUNDIS
                JR      FUNTX
FUNI:           CALL    INISI
                LD      HL,FUNDIS+14H
                JR      FUNTX
FUNF:           CALL    INISI
                LD      HL,FUNDIS+28H
                JR      FUNTX
FUNB:           CALL    INISI
                LD      HL,FUNDIS+3CH
                JR      FUNTX
FUNE:           CALL    INISI
                LD      HL,FUNDIS+50H
                JR      FUNTX
FUND:           CALL    INISI
                LD      HL,FUNDIS+64H

FUNTX:          CALL    TX              

                LD      A,(MEMTF)
		CP      00H
		JR      Z,FUNZ0
		CP      01H
		JP      Z,FUNZ1
		CP      02H
		JP      Z,FUNZ2
		CP      03H
		JP      Z,FUNZ3
		CP      04H
		JP      Z,FUNZ4
		CP      05H
		JP      Z,FUNZ5
                CP      08H             ;CCMM
                JP      Z,FUNZ8         ;CCMM
                JP      ESCI            
		
	     
		;AZZERAMENTO DOPO REGISTRO MANUALE

FUNZ0:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A        
		OUT     (PC),A
		LD      A,01H
		LD      (MEM0),A
		LD      DE,(SPELET)	;MMXX    
		LD      (SPERIF),DE
		LD      DE,0000H        ;PER AZZERAE MMXX
		LD      (TSHIFT),DE     ;VERAMENTE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,AZZM
                CP      01H
                JR      Z,AZZI
                CP      02H
                JR      Z,AZZF
                CP      03H
                JR      Z,AZZGB
                CP      04H
                JR      Z,AZZE
                CP      05H             ;DDDD
                JR      Z,AZZD

AZZM:           CALL    INISI
                LD      HL,AZZER1
                JR      AZZTX
AZZI:           CALL    INISI
                LD      HL,AZZER1+14H
                JR      AZZTX
AZZF:           CALL    INISI
                LD      HL,AZZER1+28H
                JR      AZZTX
AZZGB:          CALL    INISI
                LD      HL,AZZER1+3CH
                JR      AZZTX
AZZE:           CALL    INISI
                LD      HL,AZZER1+50H
                JR      AZZTX
AZZD:           CALL    INISI
                LD      HL,AZZER1+64H

AZZTX:          CALL    TX              
                CALL    BASSA
                LD      HL,AZZER2
                CALL    TX

		JP      ESCI

FUN3:

                LD      BC,(ERATTU)     ;CARICO L'ERRORE
		LD      (SHIFT),BC      ;LETTO IN SHIFT

                LD      A,(NORINV)      ;NNII
                CP      00H
                JR      Z,FUN4
                LD      A,(MSCORR)
                CP      08H
                JR      Z,FUN1
                JR      FUN5            ;NNII

FUN4:           LD      A,(MSCORR)      ;VEDO SE IN AVANTI
                CP      01H             ;O IN RITARDO E
		JR      Z,FUN1          ;CHIAMO LA ROUTINE
FUN5:           LD      A,70H           ;SPOSTA PER CEN-
		LD      (PIUMEN),A      ;TRARLO NEL GATE.
		JR      FUN2
FUN1:           LD      A,40H
		LD      (PIUMEN),A


FUN2:
		LD      A,01H           ;AVVISO DI AZZERA- 
                LD      (MAZTRA),A      ;RE TRAVERS
                LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JR      NZ,FUN21
                CALL    SPOSTA          ;MMCC
                JR      FUN22
FUN21:          CALL    XPOSTA          ;MMCC
		 
FUN22:          JP      CLEA1




		;PARAMETRI CILINDRO

FUNZ1:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,01H
		LD      (MEM1),A
		LD      DE,(CILIN)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,CILM
                CP      01H
                JR      Z,CILI
                CP      02H
                JR      Z,CILF
                CP      03H
                JR      Z,CILGB
                CP      04H
                JR      Z,CILE
                CP      05H
                JR      Z,CILD          ;DDDD

CILM:           CALL    INISI
                LD      HL,FORCIL
                JR      CILTX
CILI:           CALL    INISI
                LD      HL,FORCIL+14H
                JR      CILTX
CILF:           CALL    INISI
                LD      HL,FORCIL+28H
                JR      CILTX
CILGB:          CALL    INISI
                LD      HL,FORCIL+3CH
                JR      CILTX
CILE:           CALL    INISI
                LD      HL,FORCIL+50H
                JR      CILTX
CILD:           CALL    INISI
                LD      HL,FORCIL+64H

CILTX:          CALL    TX              

		LD      A,39H           ;C
		LD      (BINSET+10H),A
                CALL    BIN7

		JP      ESCI
KBRD1:          LD      A,(MEMA)        
                RES     2,A
                OUT     (PA),A
                SET     2,A
                OUT     (PA),A
                LD      D,00H           
                LD      B,08H           

                LD      A,(MEM5)        ;FF55
                BIT     0,A
                JP      NZ,ESCI          ;FF55


                LD      A,(MEM8)        ;CCMM
                BIT     0,A
                JR      Z,KBRD2

                LD      A,(HL)          ;CONTINUO LA  CCMM
		CP      0DH             ;LA CODIFICA
                JP      Z,MENO1         ;DELLA TASTIERA
		CP      0CH
                JP      Z,PIU1
                CP      13H
                JP      Z,OPERA
                CP      14H
                JP      Z,TRAS          ;CCMM


KBRD2:          LD      A,(MEMA)
                RES     1,A
                OUT     (PA),A
                IN      A,(PA)
                RR      A     
                RL      D
                SET     1,A
                SET     2,A
                OUT     (PA),A
                LD      (MEMA),A
                DJNZ    KBRD2
                LD      A,D
                AND     1FH             
                NOP                     ;     CALL    CAG
		LD      L,A
		LD      H,00H
		LD      DE,TABLE
		ADD     HL,DE
		LD      A,(HL)
		CP      0AH
		JP      Z,CLEA1
		CP      0BH
		JP      Z,ENTE1
		CP      0AH             ;SE NON NUMERO
		JP      NC,ESCI         ;ESCI
		LD      B,A
		LD      A,(MEMID)       ;SE E' IL PRIMO
		BIT     0,A             ;NUMERO INSERITO
		JR      NZ,ADIS1        ;INIZIALIZZA IL
		LD      A,01H           ;DISPLAY METTENDO
		LD      (MEMID),A       ;DEGLI ZERI
		CALL    INIZDI
ADIS1:          LD      A,B
		CALL    MUOVO
                EXX                     ;D2222
                CALL    BIOTTD
                XOR     A               ;CALL    BIOTT
		JP      ESCI

		;PARAMETRI ALLARME

FUNZ2:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,01H
		LD      (MEM2),A
		LD      DE,(ALLAR)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,SOAM
                CP      01H
                JR      Z,SOAI
                CP      02H
                JR      Z,SOAF
                CP      03H
                JR      Z,SOAGB
                CP      04H
                JR      Z,SOAE
                CP      05H
                JR      Z,SOAD          ;DDDD

SOAM:           CALL    INISI
                LD      HL,SOALLR
                JR      SOATX
SOAI:           CALL    INISI
                LD      HL,SOALLR+14H
                JR      SOATX
SOAF:           CALL    INISI
                LD      HL,SOALLR+28H
                JR      SOATX
SOAGB:          CALL    INISI
                LD      HL,SOALLR+3CH
                JR      SOATX
SOAE:           CALL    INISI
                LD      HL,SOALLR+50H
                JR      SOATX
SOAD:           CALL    INISI
                LD      HL,SOALLR+64H

SOATX:          CALL    TX              
		LD      A,77H           ;A
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      ESCI

		;PARAMETRI POSIZIONE SEGNO

FUNZ3:          LD      A,01H
		LD      (MEM3),A
                LD      (MRIC+04H),A

		LD	A,(MM_MC)	;MMMC
		CP	00H		;MMMC MMXX
		JR	Z,FUNZ30        ;MMMC
		CP	01H
		JR	Z,FUNZ31
		JP	FUNZ32
FUNZ30:
		LD      DE,(SEQSEG)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,POSM
                CP      01H
                JR      Z,POSI
                CP      02H
                JR      Z,POSF
                CP      03H
                JR      Z,POSGB
                CP      04H
                JR      Z,POSE
                CP      05H
                JR      Z,POSD

POSM:           CALL    INISI
                LD      HL,POSSEG
                JR      POSTX
POSI:           CALL    INISI
                LD      HL,POSSEG+14H
                JR      POSTX
POSF:           CALL    INISI
                LD      HL,POSSEG+28H
                JR      POSTX
POSGB:          CALL    INISI
                LD      HL,POSSEG+3CH
                JR      POSTX
POSE:           CALL    INISI
                LD      HL,POSSEG+50H
                JR      POSTX
POSD:           CALL    INISI
                LD      HL,POSSEG+64H

POSTX:          CALL    TX              
		JP	FUNZ33		;MMMC
FUNZ31:
		LD	DE,(AMPGA)
		LD      (BINSET),DE	;MMMC
                LD      A,(LINGUA)
                CP      00H
                JR      Z,AGAM
                CP      01H
                JR      Z,AGAI
                CP      02H
                JR      Z,AGAF
                CP      03H
                JR      Z,AGAGB
                CP      04H
                JR      Z,AGAE
                CP      05H
                JR      Z,AGAD

AGAM:           CALL    INISI
                LD      HL,GATEW
                JR      AGATX
AGAI:           CALL    INISI
                LD      HL,GATEW+14H
                JR      AGATX
AGAF:           CALL    INISI
                LD      HL,GATEW+28H
                JR      AGATX
AGAGB:          CALL    INISI
                LD      HL,GATEW+3CH
                JR      AGATX
AGAE:           CALL    INISI
                LD      HL,GATEW+50H
                JR      AGATX
AGAD:           CALL    INISI
                LD      HL,GATEW+64H

AGATX:          CALL    TX              ;MMMC
		JR	FUNZ33

FUNZ32:
		LD      DE,(SEQSEG)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,MCPOSM
                CP      01H
                JR      Z,MCPOSI
                CP      02H
                JR      Z,MCPOSF
                CP      03H
                JR      Z,MCPOSGB
                CP      04H
                JR      Z,MCPOSE
                CP      05H
                JR      Z,MCPOSD

MCPOSM:         CALL    INISI
                LD      HL,MCSSEG
                JR      MCPOSTX
MCPOSI:         CALL    INISI
                LD      HL,MCSSEG+14H
                JR      MCPOSTX
MCPOSF:         CALL    INISI
                LD      HL,MCSSEG+28H
                JR      MCPOSTX
MCPOSGB:        CALL    INISI
                LD      HL,MCSSEG+3CH
                JR      MCPOSTX
MCPOSE:         CALL    INISI
                LD      HL,MCSSEG+50H
                JR      MCPOSTX
MCPOSD:         CALL    INISI
                LD      HL,MCSSEG+64H
MCPOSTX:          
		CALL    TX              
FUNZ33:
		LD      A,73H           ;P
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI


		;SEGNALAZIONE FASATURA AUTOMATICA

FUNZ4:          LD      A,00H           ;IMPONGO MANUALE
                LD      (MEMC),A        ;++++++++++++++++
                OUT     (PC),A
	        LD      (SUPCOR),A	;SSCC 
                LD      (SEGOFF),A      ;DA VERIFICARE
                LD      A,01H           ;++++++++++++++++
		LD      (MRIC+00H),A
		LD      A,04H           ;DOPO 4 GIRI MEM. MMXX
		LD      (MRIC+08H),A    ;LO SPESSORE

                LD      BC,0000H        ;SSSS
                LD      (OFFSET),BC     ;SSSS

        	LD      A,0FH           ;DOPO 16 GIRI
		LD      (ALTGUA),A      ;STOP GUAD.AUTO
		LD      A,60H           ;INIZIO CON
		LD      (GUADS1),A      ;GUADAGNO MINIMO
		LD      (GUADS2),A      
		LD      A,05H
		LD      (MRIC+02H),A
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FASM
                CP      01H
                JR      Z,FASI
                CP      02H
                JR      Z,FASF
                CP      03H
                JR      Z,FASGB
                CP      04H
                JR      Z,FASESP
                CP      05H             ;DDDD
                JR      Z,FASED

FASM:           CALL    INISI
                LD      HL,FASEAU
                JR      FASTX
FASI:           CALL    INISI
                LD      HL,FASEAU+14H
                JR      FASTX
FASF:           CALL    INISI
                LD      HL,FASEAU+28H
                JR      FASTX
FASGB:          CALL    INISI
                LD      HL,FASEAU+3CH
                JR      FASTX
FASESP:         CALL    INISI
                LD      HL,FASEAU+50H
                JR      FASTX
FASED:          CALL    INISI
                LD      HL,FASEAU+64H

FASTX:          CALL    TX
                CALL    AZZF4           

                LD      A,(VCLONG)      ;TTAA
                CP      00H
                JR      Z,TRAVC
                LD      A,(MESSA)       ;CCMM
                CP      02H             ;CCMM
                JR      NZ,TRAVC        ;CCMM
                LD      A,01H           ;FFZZ
                LD      (MFLEXL),A
TRAVC:
                LD      A,(VCTRAV)
                CP      00H
                JR      Z,TRAVC1
                LD      A,(MESSA)       ;CCMM
                CP      02H             ;CCMM
                JR      NZ,TRAVC1       ;CCMM
                LD      A,01H
                LD      (MFLEXT),A      ;FFZZ TTAA
TRAVC1:
		JP      ESCI


                ;FASATURA MANUALE     FF55

FUNZ5:          LD      A,01H
                LD      (MEM5),A
                LD      A,00H           ;IMPONGO MANUALE
                LD      (MEMC),A
                OUT     (PC),A
		LD	(SHIFT3),A	;SSCC
		LD	(SHIFT4),A	;SSCC
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FUN5M
                CP      01H
                JR      Z,FUN5I
                CP      02H
                JR      Z,FUN5F
                CP      03H
                JR      Z,FUN5B
                CP      04H
                JR      Z,FUN5E
                CP      05H
                JR      Z,FUN5D          ;DDDD

FUN5M:          CALL    INISI
                LD      HL,FUNDI5
                JR      FUN5TX
FUN5I:          CALL    INISI
                LD      HL,FUNDI5+14H
                JR      FUN5TX
FUN5F:          CALL    INISI
                LD      HL,FUNDI5+28H
                JR      FUN5TX
FUN5B:          CALL    INISI
                LD      HL,FUNDI5+3CH
                JR      FUN5TX
FUN5E:          CALL    INISI
                LD      HL,FUNDI5+50H
                JR      FUN5TX
FUN5D:          CALL    INISI
                LD      HL,FUNDI5+64H

FUN5TX:         CALL    TX              

               
                JP      ESCI


                ;CALIBRAZIONE SPOSTAMENTO MOTORE  

FUNZ8:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,01H
                LD      (MEM8),A
                LD      A,(MESSA)       ;CCMM
                CP      00H
                JR      NZ,FUNZ81       ;CCMM
		CALL    BASSA
		LD      A,(LINGUA)
		CP      00H
                JR      Z,NOMESM
		CP      01H
                JR      Z,NOMESI
		CP      02H
                JR      Z,NOMESF
		CP      03H
                JR      Z,NOMESGB
		CP      04H
                JR      Z,NOMESE
                CP      05H
                JR      Z,NOMESD
NOMESM:         LD      HL,MESS0
                JR      SOMETX
NOMESI:         LD      HL,MESS0+14H
                JR      SOMETX
NOMESF:         LD      HL,MESS0+28H
                JR      SOMETX
NOMESGB:        LD      HL,MESS0+3CH
                JR      SOMETX
NOMESE:         LD      HL,MESS0+50H
                JR      SOMETX
NOMESD:         LD      HL,MESS0+64H
SOMETX:         CALL    TX
                JP      ESCI            ;CCMM
FUNZ81:         LD      DE,(CALIBR)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,CALM
                CP      01H
                JR      Z,CALI
                CP      02H
                JR      Z,CALF
                CP      03H
                JR      Z,CALGB
                CP      04H
                JR      Z,CALE
                CP      05H
                JR      Z,CALD          ;DDDD

CALM:           CALL    INISI
                LD      HL,FLXDIS
                JR      CALTX
CALI:           CALL    INISI
                LD      HL,FLXDIS+14H
                JR      CALTX
CALF:           CALL    INISI
                LD      HL,FLXDIS+28H
                JR      CALTX
CALGB:          CALL    INISI
                LD      HL,FLXDIS+3CH
                JR      CALTX
CALE:           CALL    INISI
                LD      HL,FLXDIS+50H
                JR      CALTX
CALD:           CALL    INISI
                LD      HL,FLXDIS+64H

CALTX:          CALL    TX              
                LD      A,1EH           ;J
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      ESCI


		;MANUALE AUTOMATICO LONGITUDINALE

AUTOC:          LD      A,00H           ;TOLGO USO DELLA                
		LD      (MKBUSY),A      ;TASTIERA
		LD      A,(MEMC)        ;METTO IN AUTOMAT.
		SET     2,A             
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANC:           LD      A,00H           ;TOLGO USO DELLA                
		LD      (MKBUSY),A      ;TASTIERA
                LD      A,(MEMC)        ;METTO IN MANUL.
                RES     0,A
                RES     1,A
                RES     2,A             
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANAVA:         LD      A,(MEMC)        ;SE E' IN AUTO-
                BIT     2,A             ;MATICO SALTO
		JR      NZ,MANEND
		LD      A,(MEMC)
		RES     1,A
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE AVANTI
                IN      A,(PA)
                BIT     4,A
                JR      NZ,MANEND
		LD      A,(HL)
                AND     1FH
                CP      0CH
                JR      Z,MANAVA

MANRIT:         LD      A,(MEMC)        ;SE E' IN AUTO-
                BIT     2,A             ;MATICO SALTA
		JR      NZ,MANEND
		LD      A,(MEMC)
		RES     0,A
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE RITARDO
		IN      A,(PA)
                BIT     4,A
                JR      NZ,MANEND
                LD      A,(HL)
                AND     1FH
                CP      0DH
		JR      Z,MANRIT

MANEND:         LD      A,00H           ;TOLGO L'USO
		LD      (MKBUSY),A      ;DELLA TASTIERA
                CALL    RESEPC          ;FFLL
                JP      ESCI

		;MANULAE AUTOMATICO TRAVERS

AUTOT:        
		LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
                CP      02H             ;LONGITUDINALE
                JP      Z,MANT

		LD      A,00H           ;TOLGO L'USO
		LD      (MKBUSY),A      ;DELLA TASTIERA
		LD      A,(MEMC)        ;METTO IN AUTMAT.
                SET     4,A
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANT:           LD      A,00H           ;TOLGO L'USO
		LD      (MKBUSY),A      ;DELLA TASTIERA
                LD      A,(MEMC)        ;METTO IN MANUL.
                RES     6,A
                RES     7,A
                RES     4,A
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANOPE:       
	        LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
                CP      02H             ;LONGITUDINALE
                JP      Z,ESCI

		LD      A,(MEMC)        ;SE IN AUTO-
                BIT     4,A             ;MATICO SALTA
		JR      NZ,MANEND
		LD      A,(MEMC)
                SET     6,A
                RES     7,A
		LD      (MEMC),A        ;MOTORE LATO
		OUT     (PC),A          ;OPERATORE
		IN      A,(PA)
                BIT     4,A
                JR      NZ,MANEND
                LD      A,(HL)
                AND     1FH
                CP      13H
		JR      Z,MANOPE


MANTRA:        
		LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
                CP      02H             ;LONGITUDINALE
                JP      Z,ESCI

		LD      A,(MEMC)        ;SE IN AUTO-
                BIT     4,A             ;MATICO SALTA
		JR      NZ,MANEND
		LD      A,(MEMC)
                RES     6,A
                SET     7,A
		LD      (MEMC),A        ;MOTORE LATO
		OUT     (PC),A          ;TRASMISSIONE
		IN      A,(PA)
                BIT     4,A
                JP      NZ,MANEND
                LD      A,(HL)
                AND     1FH
                CP      14H
		JR      Z,MANTRA



MUOVO:          LD      IX,BINSET+06H
		LD      B,(IX+00H)      ;MEMORIZZO I
		LD      C,(IX+01H)      ;NUMERI E LI
		LD      D,(IX+02H)      ;MUOVO VERSO
		LD      E,(IX+03H)      ;SINISTRA
		LD      (IX+00H),A
		LD      (IX+01H),B
		LD      (IX+02H),C
		LD      (IX+03H),D
		LD      (IX+04H),E
		RET

INIZDI:         LD      A,00H
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		RET

PUNTO:          
                CALL    YRXA_023              ;FFXX
                CALL    CENOSC          ;FF55
                LD      A,00H           ;TOLGO L'USO BBBB
                LD      (MKBUSY),A      ;DELLA TASTIERA  BBBB

ESCI:
      		
		LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JR      Z,MAR_C1
		LD	A,04H
		JR	MAR_C2
MAR_C1:         LD      A,0AH           ;CARICO IL	PUUU
MAR_C2:		LD      (ALTERR),A      ;BLOCCO ALLE
		LD	A,02H
		LD	(TALTER),A	;CARICO IL UUU
					;BLOCCO ALLE
		LD      A,0D7H          ;CORREZZIONI
		OUT     (71H),A         ;PER X GIRI
		LD      A,01H           ;ALL'USCITA
		OUT     (71H),A         ;DALLA TASTIERA

		POP     IY              ;INIZIO COSI'
		POP     IX              ;AGGIORNA IL
		POP     AF              ;TUTTO.
		POP     HL
		POP     DE
		POP     BC
		EI

		RETI


PIOB:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

		LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JP      NZ,XPIOB

		LD      A,(ALTERR)      ;QUANDO ALTERR PUUU
		CP      00H             ;ARRIVA A ZERO
		JR      Z,PIOB5         ;RIPRENDE IL
		CP	0BH             ;CALCOLO DELLO
		JR	NC,PIOB6        ;ERRORE
		DEC     A               ;CALCOLO DELLO
		LD      (ALTERR),A      ;ERRORE
		JR	PIOB5
PIOB6:		LD	A,00H
		LD	(ALTERR),A	;PUUU
PIOB5:
        	IN      A,(PB)          ;PPUU
                BIT     5,A
                JR      Z,PIOB4         ;PPUU

;                LD      A,(MRIC+06H)   ;VIENE DECR.IN    PPDD DARIVEDERE
;   DARIVEDERE             CP      00H            ;MODO CHE IL
;  DARIVEDERE              JR      Z,PIOB3        ;TEST DEL DOPPIO
;            DARIVEDERE    DEC     A              ;PIO VENGA LETTO
;                LD      (MRIC+06H),A   ;UNA VOLTA       PPDD


PIOB3:
                LD      A,(ENCOD2)     ;PPDD
                CP      02H
                JR      Z,PIOB1

                LD      A,(MEMFAS)      ;WWWW
                CP      00H
                JR      Z,PIOB2

		LD      A,0D7H          ;CONTROLLO CTC0
		OUT     (70H),A         ;CARICO AMPIEZZA
                LD      A,(AMPIM1)      ;GATE IN IMPULSI  WWWW
		OUT     (70H),A         ;ENCODER.

                LD      A,(MEMFAS)      ;WWWW
		CP      02H             ;SE ABILITAZ.
		JR      Z,PIOB1         ;PA7 SALTO

		LD      A,(GUADS1)      ;AMPLIFICAZIONE
		LD      B,A             ;S1
                LD      A,(MEMA)        
		RES     5,A
		RES     6,A
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A      
		
		LD      A,(MRIC+06H)    ;VEDO SE DEVO  PPDD
                CP      00H             ;CONTROLLARE IL
                JR      Z,PIOB1         ;DOPPIO SEGNO
                LD      A,0D7H          ;METTO PER
                OUT     (73H),A         ;PRIMO SEGNO 
                LD      A,02H           ;02H 
                OUT     (73H),A         ;
                JR      PIOB1


		;JR      PIOB7		;SSDD




PIOB2:
                LD      A,0D7H          ;CONTROLLO CTC0   WWWWW
                OUT     (70H),A         ;CARICO AMPIEZZA
                LD      A,(AMPIM2)      ;GATE IN IMPULSI  WWWW
		OUT     (70H),A         ;ENCODER.


                LD      A,(GUADS2)      ;AMPLIFICAZIONE
		LD      B,A             ;S2
                LD      A,(MEMA)        
		RES     5,A
		RES     6,A
		ADD     A,B             
		LD      (MEMA),A
                OUT     (PA),A                        
PIOB7:					;SSDD
                LD      A,(MRIC+06H)    ;VEDO SE DEVO  PPDD
                CP      00H             ;CONTROLLARE IL
                JR      Z,PIOB1         ;DOPPIO SEGNO
                LD      A,0D7H          ;METTO 03 PER
                OUT     (73H),A         ;NON FARE SENTIRE
                LD      A,03H           ;LA COMMUTAZIONEH.
                OUT     (73H),A         ;DEL TRAVERS   PPDD
                JR      PIOB1

PIOB4:          
                CALL    GATEPU          ;PPUU

PIOB1:          POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI





		;VERIFICA POSIZIONE S1

CTC0:          
		PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

		LD	A,(ALTERN)	;CONTROLLO CHE ALTERN	AALL
		CP	03H		;NON SUPERI DUE
		JR	C,CTC02		;PER NON FARE
		LD	A,02H		;LETTURE SBAGLIATE
		LD	(ALTERN),A
CTC02:					;AALL
                LD      A,(MM_MC)       ;MMCC
                CP      00H		;MMXX
                JP      NZ,XCTC0
                LD      A,(ENCOD1)     ;SE NON
                CP      00H            ;ABILITATO
                JR      Z,CTC01        ;SALTA   
                CP      01H
                JP      Z,CTC025
                LD      A,(ENCOD2)     ;INCREMENTO
                INC     A              ;A OGNI 255
                LD      (ENCOD2),A     ;IMPULSI
                LD      A,0DFH         ;RICARICO CTC0 
		OUT     (70H),A
                LD      A,0FFH
                OUT     (70H),A
                JP      CTC025         
CTC01:         
		LD      A,(MEMFAS)      
		CP      00H              
		JP      Z,CTC010        ;VAI FASE S2
		CP      02H
		JP      Z,CTC016        ;VAI ABILIT.PA7
                IN      A,(30H)         ;LEGGO IL VALORE   
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
                LD      (MPIEN1),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)         ;DI S1
		LD      D,A
                LD      (MPOSI1),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S1
		LD      D,A
                LD      (MASES1),DE
                LD      HL,(FASE2)      ;CARICO IL CONTA-
		LD      A,H             ;TORE PER LEGGERE
		OUT     (20H),A         ;LA FASE 2
		LD      A,L
		OUT     (10H),A         
                LD      A,(MEMA)        ;IMPONGO 
		SET     5,A             ;NELL'INTERVALLO
		SET     6,A             ;GUADAGNO MINIMO
		LD      (MEMA),A
                OUT     (PA),A    
		
                LD      A,(MEM5)        ;FF55
                CP      01H             ;FF55
                JR      NZ,CTC027       ;FF55
                CALL    SPOFAS          ;EEOO
                LD      HL,(FASE)       ;CARICO IL FF55 
                LD      A,H             ;CONTATORE PER FF55
                OUT     (20H),A         ;LEGGERE POI S1 FF55
                LD      A,L             ;FF55
                OUT     (10H),A         ;FF55        
CTC027:					;FF56
                OUT     (52H),A         
		LD      A,00H           
		LD      (MEMFAS),A      
		LD      A,(MEMC)        ;SE SONO IN MA-
                AND     14H             ;NUALE SALTO ;BIT     2,A  FFLL
		JR      Z,CTC03
		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,CTC03         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
		CALL    NOPRI
CTC03:          
                IN      A,(PB)
		BIT     3,A
		JR      Z,CTC08
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOMAT.
		JR      Z,CTC07         ;SALTA
		CALL    GAINS1          
CTC07:
                CALL    RESEPC          ;FFLL

                JP      CTC025
CTC08:          LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
                LD      A,(MEMC)        
                BIT     5,A
                JR      NZ,CTC09        
                LD      DE,(MPIEN1)
                LD      (PIENO1),DE
                LD      DE,(MPOSI1)
                LD      (POSIZ1),DE
                LD      DE,(MASES1)
		LD      (FASES1),DE
                JP      CTC025                  
CTC09:          LD      DE,(MPIEN1)
                LD      (TPIEN1),DE
                LD      DE,(MPOSI1)
                LD      (TPOSI1),DE
                LD      DE,(MASES1)
                LD      (TASES1),DE     
                JP      CTC025          

		;VERIFICA POSIZIONE DI S2

CTC010:         LD      A,(ALTGUA)      ;SE ATTIVO
		CP      00H             ;GUADAGNO AUTOM.
		JR      Z,CTC011        ;DECREMENTA
		DEC     A      
		LD      (ALTGUA),A
CTC011:         IN      A,(30H)         ;LEGGO IL VALORE
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
                LD      (MPIEN2),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)
		LD      D,A
                LD      (MPOSI2),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S2
		LD      D,A
                LD      (MASES2),DE
		LD      HL,(FASE3)      ;CARICO IL CONTA-
		LD      A,H             ;TORE PER POI
		OUT     (20H),A         ;L'ABILITARE PA7
		LD      A,L
		OUT     (10H),A
                LD      A,(MEMC)        
                BIT     5,A
                JR      NZ,CTC019       
                LD      DE,(MPIEN2)
                LD      (PIENO2),DE
                LD      DE,(MPOSI2)
                LD      (POSIZ2),DE
                LD      DE,(MASES2)
                LD      (FASES2),DE
                LD      A,(MRIC+00H)    
                CP      01H
                JR      Z,CTC018        
                LD      A,(ALTERN)
                DEC     A
                LD      (ALTERN),A
                CP      00H
                JR      NZ,CTC018
                LD      A,(MEMC)
                SET     5,A
                LD      (MEMC),A
                OUT     (PC),A
                LD      A,02H
                LD      (ALTERN),A
                JP      CTC018        
CTC019:         LD      DE,(MPIEN2)
                LD      (TPIEN2),DE
                LD      DE,(MPOSI2)
                LD      (TPOSI2),DE
                LD      DE,(MASES2)
                LD      (TASES2),DE     
                LD      A,(ALTERN)
                DEC     A
                LD      (ALTERN),A
                CP      00H
                JR      NZ,CTC018
                LD      A,(MEMC)        
                RES     5,A
                LD      (MEMC),A
                OUT     (PC),A
                LD      A,02H
                LD      (ALTERN),A
CTC018:         LD      A,(MEMA)        ;IMPONGO 
		SET     5,A             ;NELL'INTERVALLO
		SET     6,A             ;GUADAGNO MINIMO
		LD      (MEMA),A
                OUT     (PA),A          
		LD      A,02H
		LD      (MEMFAS),A
                OUT     (52H),A         ;STABILE DA 0,5 mS
		IN      A,(PB)          ;SE MANCA SEGNO
		BIT     3,A             ;MODIFICO IL
		JR      Z,CTC012        ;GUADAGNO DI S2
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOM.
		JR      Z,CTC012        ;SALTA
		CALL    GAINS2          
CTC012:         LD      A,01H           ;SEGNALA AL MAIN
		LD      (MCALER),A      ;CHE HA LETTO.
		LD      A,(MEMC)        ;SE SONO IN MA-
                AND     14H             ;NUALE SALTO ;BIT     2,A  FFLL
		JR      Z,CTC013
		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,CTC013        ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
		CALL    NOPRI
CTC013:         
                IN      A,(PB)
		BIT     3,A
		JR      Z,CTC015
                CALL    RESEPC          ;FFLL
                JP      CTC025
CTC015:         LD      A,(MEMA)
		RES     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
                JR      CTC017          
CTC016:         LD      HL,(FASE)       ;CARICO IL 
		LD      A,H             ;CONTATORE PER
		OUT     (20H),A         ;LEGGERE POI S1
		LD      A,L
		OUT     (10H),A         
		LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
		LD      A,01H
		LD      (MEMFAS),A
                JR      CTC025
CTC017:        
		LD      A,(MRIC+00H)
                CP      00H
                JR      NZ,CTC025
                LD      BC,011DH        ;4mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
CTC021:         IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,CTC022       ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO
CTC022:         DEC     BC              ;IN IX+01
                LD      A,B
                OR      C
                JR      NZ,CTC021       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.
                LD      A,(MEMC)        ;SE E'IN MANUALE
		BIT     2,A             ;SALTO
                JR      Z,CTC020
                LD      IX,TRIP         
                LD      A,(IX)          ;SE TRIP
                CP      00H             ;= ZERO NON
                JR      Z,CTC020        ;OPERA
CTC023:
                LD      A,(PROTEZ)      ;SE IN PROTE- TVVV
                CP      01H             ;ZIONE SALTA
                JR      Z,CTC020        ;TVVV
                LD      HL,(VELMED)     ;CONTROLLO SE
                LD      DE,(VELPRE)     ;TRA LA NUOVA 
                SBC     HL,DE           ;E LA VECCHIA 
                JR      C,CTC024        ;VELOCITA'C'E' 
                LD      A,L             ;UN DIFFERENZA
                CP      (IX)            ;TRIP IN METRI SIA  
                JP      M,CTC020        ;IN PIU' CHE
                CALL    ACCEL           ;MENO SE C'E'
                JR      CTC020          ;BLOCCO CON
CTC024:         CCF                     ;LA SCRITTA  
                LD      HL,(VELPRE)     ;APPROPIATA
                LD      DE,(VELMED)
                SBC     HL,DE
                LD      A,L
                CP      (IX)            
                JP      M,CTC020
                CALL    DECEL
CTC020:         LD      DE,(VELMED)
                LD      (VELPRE),DE
CTC025:  

                LD      A,(MOSCI1)      ;FF56
                CP      01H
                JR      NZ,CTC026       ;FF56
		CALL    CENTRO          ;FF56
                CALL    IIGATE          ;FF56
                LD      A,00H           ;FF56
                LD      (MOSCI1),A      ;FF56
CTC026:					;FF56
		POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI

		;CONTEGGIO GIRI ALL'USCITA DALLA TASTIERA
		


CTC1:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
		LD      A,(ENCOD1)      ;VEDO SE SONO
		CP      00H             ;IN TEST
                JR      Z,CTC16         ;ENCODER
		CP      01H
                JR      Z,CTC17
		CP      02H
                JR      Z,CTC18
CTC17:          LD      A,02H           ;PARTENZA TEST
		LD      (ENCOD1),A
                LD      HL,ENC2        
                JR      CTC14           
CTC18:          LD      HL,ENC6         ;FINE TEST                        
                JR      CTC14           
CTC16:          LD      A,(MRIC+00H)    ;CONTROLLA
		CP      01H             ;SE FALLITA
		JR      Z,CTC12         ;RICERCA CODICE
CTC10:          LD      A,43H
		OUT     (71H),A
CTC11:          POP     IY                
		POP     IX              
		POP     AF
		POP     HL
		POP     DE      
		POP     BC
		JR      CTC15
CTC12:          LD      A,(MRIC+02H)
		DEC     A
		LD      (MRIC+02H),A
		CP      00H
		JR      NZ,CTC13
		LD      A,01H           ;SEGNALO
		LD      (MDATER),A      ;RICERCA FALLITA
		LD      A,00H           ;E LA ANNULLO
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      A,43H
		OUT     (71H),A
                LD      HL,MAIN         ;RIPARTO DA 
		JR      CTC14           ;MAIN
CTC13:          CALL    GAINS1
                LD      HL,CODICE
CTC14:          POP     IY              
		POP     IX              
		POP     AF
		POP     DE      
		POP     BC
		EX      (SP),HL
CTC15:          EI              
		RETI





CTC2:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

                LD      A,(DECORR)      ;SE EXTRA 
                CP      00H             ;CORREZIONE 
                JR      NZ,CTC21        ;ATTIVA SALTO.
CTC23:          LD      A,(MEMC)        ;FINE DELLA
		RES     0,A             ;CORREZIONE
		RES     1,A
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,43H           ;RESETTO
		OUT     (71H),A         ;CTC1
		OUT     (72H),A         ;CTC2
                JR      CTC22           
CTC21:          LD      A,37H           ;CONTROLLO CTC1
		OUT     (71H),A         
                LD      A,40H           ;COSTANTE DI
		OUT     (71H),A         ;TEMPO
                LD      A,0D7H          ;CONTROLLO CTC2
                OUT     (72H),A         ;CARICO PER 
                LD      A,0FFH          ;EXTRA CORREZ.
		OUT     (72H),A
                LD      A,(DECORR)      ;SE E' MAGGIORE ZZZ
                DEC     A               ;DI UNO LA CORREZ-
                LD      (DECORR),A      ;ZIONE DIVENTA
                CP      00H             ;CONTINUA
                JR      NZ,CTC22
                LD      A,(CIDE75)      ;SE FATTO 75% ZZZ
                CP      00H             ;DEL CICLO
                JR      Z,CTC23         ;BLOCCO CORREZ.

CTC22:          POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE      
		POP     BC
		EI
		RETI





CTC3:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
                PUSH    IY

                LD      A,(MRIC+06H)    ;SE NON SONO IN  PPDD
		CP      00H             ;FUNZ4 SALTO
                JP      Z,CTC34         ;
CTC35:         
		LD      A,(LINGUA)
                CP      00H
                JR      Z,ATEM
                CP      01H
                JR      Z,ATEI
                CP      02H
                JR      Z,ATEF
                CP      03H
                JR      Z,ATEGB
                CP      04H
                JR      Z,ATEE
                CP      05H
                JR      Z,ATED
ATEM:           CALL    INISI
                LD      HL,OCIO
                JR      ATETX
ATEI:           CALL    INISI
                LD      HL,OCIO+14H
                JR      ATETX
ATEF:           CALL    INISI
                LD      HL,OCIO+28H
                JR      ATETX
ATEGB:          CALL    INISI
                LD      HL,OCIO+3CH
                JR      ATETX
ATEE:           CALL    INISI
                LD      HL,OCIO+50H
                JR      ATETX
ATED:           CALL    INISI
                LD      HL,OCIO+64H
ATETX:          CALL    TX              

		LD      A,(LINGUA)
		CP      00H
                JR      Z,DOPM
		CP      01H
                JR      Z,DOPI
		CP      02H
                JR      Z,DOPF
		CP      03H
                JR      Z,DOPGB
                CP      04H
                JR      Z,DOPE
                JR      DOPFIN
DOPM:           CALL    BASSA
                LD      HL,DOPPIO
                JR      DOPTX
DOPI:           CALL    BASSA
                LD      HL,DOPPIO+14H
                JR      DOPTX
DOPF:           CALL    BASSA
                LD      HL,DOPPIO+28H
                JR      DOPTX
DOPGB:          CALL    BASSA
                LD      HL,DOPPIO+3CH
                JR      DOPTX
DOPE:           CALL    BASSA
                LD      HL,DOPPIO+50H
DOPTX:          CALL    TX


DOPFIN:         LD      A,00H           ;
                LD      (MRIC+04H),A    ;
                LD      (MRIC+06H),A    ;PPDD  
                LD      A,43H           ;AADD
                OUT     (73H),A         ;AADD
                JR      CTC31           ;AADD
CTC34:         
		LD      A,(TMEM4)       ;SE ATTIVATA   PPDD
		CP      01H             ;CORREZIONE
                JP      NZ,CTC31        ;PPDD    JP      Z,CTC32         ;SALTA
CTC32:
                LD      A,(DECORT)      ;SE EXTRA   ZZZ
                CP      00H             ;CORREZIONE
                JR      NZ,CTC31        ;ATTIVA SALTO.
	        LD      BC,(TMEM5)       ;CONTIENE IL
                DEC     BC               ;VALORE 
                LD      (TMEM5),BC       ;DELL'ERRORE
                LD      A,B
                OR      C
                JR      NZ,CTC31        ;ZZZ
CTC33:         
		LD      A,(MEMC)        ;FINITO IL DE-  
                RES     6,A             ;CREMENTO DELLO
                RES     7,A             ;ERRORE TOGLI
                LD      (MEMC),A        ;LE CORREZIONI.
		OUT     (PC),A
		LD      A,43H
		OUT     (73H),A
		LD      A,00H
		LD      (TMEM4),A
CTC31:
                POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI

                

		;CALCOLO DELLO SPOSTAMENTO DI REGISTRO 

                
SPOSTA:         LD      HL,(SHIFT)
		LD      (MDO032),HL
		LD      HL,0000H
		LD      (MDO232),HL
		LD      HL,3E8H
		LD      (MRE032),HL
		LD      HL,0000H
		LD      (MRE232),HL
		CALL    MOL32
		LD      BC,(PTO032)
		LD      DE,(PTO232)
		LD      A,(PIUMEN)
		CP      40H
		JR      NZ,TOGLI
		LD      (ADDEN0),BC
		LD      (ADDEN2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (AUGEN0),BC
		LD      (AUGEN2),DE
		CALL    SOMM32
		LD      BC,(ADDEN0)
		LD      DE,(ADDEN2)
		LD      (DISTA0),BC
		LD      (DISTA2),DE
		JR      SPOFIN
TOGLI:          LD      (MINUE0),BC
		LD      (MINUE2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (SUBTR0),BC
		LD      (SUBTR2),DE
		CALL    SOTT32
		LD      BC,(RESTO0)
		LD      DE,(RESTO2)
		LD      (DISTA0),BC
		LD      (DISTA2),DE
SPOFIN:         RET



;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& NNDD
;		CONTROLLO ZONA MORTA
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


CORREZ:         LD      HL,(ERMEDI)     ;SE ZONA MORTA E'
		LD      DE,(ZONA)       ;> DELL'ERRORE
		SBC     HL,DE           ;NON CORREGGO
		JR      NC,CORREZIONI_1
		CCF
		LD      A,(MEMC)        
		RES     0,A             
		RES     1,A             
		LD      (MEMC),A        
		OUT     (PC),A          
		JP      CORREZIONI_END


		;#####################################################################
		;# CALCOLO CORREZIONE MOTORE                                         #
		;# [Ea x C/10 + (Ea - Ep) x D] x G                                   #
		;# [Ea x (C/10 + D) x G] - [Ep x D x G]	                             #
		;# CORRATT = 80000000h + [Ea x (C/10 + D) x G] - [Ep x D x G]        #
		;#####################################################################


CORREZIONI_1:   
		;[Ea x (C/10 + D) x G]
		LD      DE,(CILDIV)	
		LD	HL,(DERIVA)
		ADD	HL,DE		;HL = C/10+D
		LD	(MDO032),HL
		LD	HL,(GUADA)	;HL = G
		LD	(MRE032),HL
		LD	HL,0000H
		LD	(MDO232),HL
		LD	(MRE232),HL
		CALL	MOL32		;PT = (C/10+D)*G
		LD	HL,(PTO032)
		LD	(MDO032),HL
		LD	HL,(PTO232)
		LD	(MDO232),HL
		LD	HL,(ERATTU)	;HL = Ea
		LD	(MRE032),HL	
		CALL	MOL32		;PT = [Ea x (C/10 + D) x G]

		LD      A,(MSCORR_ATT)	
		CP      01H        
		JR      Z,CORREZIONI_2	

		;CORRATT = 80000000h - [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(CUBTR2),HL
		LD	HL,0000H	;MINUENDO = 80000000h
		LD	(CINUE0),HL
		LD	HL,8000H
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3

CORREZIONI_2:
		;CORRATT = 80000000h + [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(ADDEN0),HL	;ADDENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(ADDEN2),HL
		LD	HL,0000H	;AUGEND0 = 80000000h
		LD	(AUGEN0),HL
		LD	HL,8000H
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3
		

CORREZIONI_3:
		;[Ep x D x G]
		LD      HL,(ERPREC)     
		LD      (MOLTI),HL
		LD      A,(DERIVA)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)      
		LD      (MOLT24),HL       ;RISULTATO
		LD      A,(GUADA)
                LD      (MOLP24),A      
                CALL    MOL24

		LD      A,(MSCORR_PREC)	
		CP      01H        
		JR      Z,CORREZIONI_4	

		;CORRATT = CORRATT + [Ep x D x G]
		LD	HL,(CORRATT)
		LD	(ADDEN0),HL	;ADDENDO = CORRATT
		LD	HL,(CORRATT+02H)
		LD	(ADDEN2),HL
		LD	HL,(PROD24)	;AUGEND0 = [Ep x D x G]
		LD	(AUGEN0),HL
		LD	HL,(PROD24+02H)
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_5

CORREZIONI_4:
		;CORRATT = CORRATT - [Ep x D x G]
		LD	HL,(PROD24)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ep x D x G]
		LD	HL,(PROD24+02H)
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO

		JR	CORREZIONI_5
CORREZIONI_5:
		LD	A,(CORRATT+03H) ;IF CORRATT > 80000000h THEN MSCORR=D_AVANTI ELSE MSCORR=D_RITARDO
		BIT	7,A
		JR	Z,CORREZIONI_6

		LD      A,01H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_6:
		LD      A,08H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_7:	
		LD	HL,0000H
		LD	(CUBTR0),HL	;SOTTRAENDO = 80000000h
		LD	HL,8000h
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		
CORREZIONI_8:		

		LD      A,(CORRATT+03H)
		AND	7FH
		CP	00H
		JR	Z,CORREZIONI_9
                LD      BC,0FFFFH
                LD      A,0FFH
		JR	CORREZIONI_10
CORREZIONI_9:
                LD      BC,(CORRATT)
                LD      A,(CORRATT+02H)
		JR	CORREZIONI_10
CORREZIONI_10:

                LD      (MDECOR),A      ;VALORE PER 
                CP      00H             ;EXTRA CORREZ.
                JR      NZ,CORREZIONI_11

                LD      A,B

                LD      (CORRE),A
                JR      CORREZIONI_12          
CORREZIONI_11:  LD      A,0FFH
                LD      (CORRE),A




CORREZIONI_12: ;CORRE7:       
		LD      A,(CIDE75)      ;DECREMENTO ZZZ
                CP      00H             ;DEL 75% DEL
                JR      Z,CORREZIONI_13 ;CICLO
                DEC     A
                LD      (CIDE75),A

CORREZIONI_13: ; CORRE8:     
		LD      A,(MATTES)      ;CONTROLLO CICLO
		DEC     A               ;DI ATTESA
		LD      (MATTES),A
		CP      00H
		JP      NZ,CORREZIONI_END
                LD      A,(CICL75)      ;RICARICO IL ZZZ
                LD      (CIDE75),A      ;75% DEL CICLO ZZZ

		LD	A,(OF_ROT)
		CP	00H
		JR	NZ,CORREZIONI_14
		LD	A,(CICATT)
		JR	CORREZIONI_15
CORREZIONI_14: ;CORRE10:
                LD      A,(CICLO)      ;RICARICO IL CI- FOFF
CORREZIONI_15: ;CORRE11:				
		LD      (MATTES),A     ;CICLO DI ATTESA.
                LD      HL,(ERMEDI)
		LD      DE,(ZONA)
		SBC     HL,DE           ;SE ZONA MORTA
		JR      NC,CORREZIONI_16;MAGGIORE DI
		CCF                     ;ERMEDI SALTO
		JP      CORREZIONI_END
CORREZIONI_16: ;CORRE5:        
		LD      A,(MEMC)        ;SE E'IN MANUALE
		BIT     2,A             ;SALTO
		JP      Z,CORREZIONI_END
                LD      A,(CORRE)      ;ZZZ
                NOP                    ;LD      A,B             ;SE ERRORE = 0
                CP      00H            ;OR      C               ;SALTO
                JP      Z,KRAPIN        
                LD      A,(MDECOR)      ;ZZZ
                LD      (DECORR),A      ;ZZZ
                LD      A,(DERIVA)      ;VEDO SE PPPP       
                CP      00H             ;DERIVATIVO PPPP
                JR      NZ,CORREZIONI_17 ;E CORREZ PPPP
                LD      BC,(VCLONG)     ;PROPORZIONALE PPPP
                LD      HL,0000H        ;E' A ZERO PPPP
                SBC     HL,BC
                JR      Z,CORREZIONI_17                
                CALL    FLEXOL          ;PPPP
                JP      CORREZIONI_END  ;PPPP
CORREZIONI_17: ;CORRE9:
                LD      A,37H           ;CONTROLLO CTC1   
		OUT     (71H),A         
                LD      A,47H           ;COSTANTE DI
		OUT     (71H),A         ;TEMPO
		LD      A,0D7H          ;CONTROLLO CTC2
		OUT     (72H),A
                LD      A,(CORRE)       ;MSB ERRORE  ZZZ
                OUT     (72H),A
		LD      A,(MSCORR)      ;VEDO IN CHE
		CP      01H             ;SENSO CORREG.
		JR      NZ,AUTRIT
		LD      A,(MEMC)        ;CORREZIONE IN
		RES     1,A             ;AVANTI
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,114
		LD      (SIMCOL),A
                JR      CORREZIONI_END
AUTRIT:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     0,A             ;RITARDO
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,97
		LD      (SIMCOL),A
CORREZIONI_END: ;COFINE:        
		RET


KRAPIN:         LD      A,(MEMC)        ;QUANDO L'ERRORE 
                RES     0,A             ;E' A ZERO
                RES     1,A             ;SI ANNULLA 
                LD      (MEMC),A        ;TUTTO PER
                OUT     (PC),A          ;EVITARE CHE
                LD      A,43H           ;CHE AVVENGANO
                OUT     (71H),A         ;CORREZZIONI
                OUT     (72H),A         ;INDESIDERATE
                RET

		;CALCOLO ERRORE MEDIO PER DISPLAY

LMEDIA:
                LD      A,(PRIMOB)      ;WWAA
                LD      B,A
                LD      IX,MAVA00               ;+5CH     ;DMEP1C WWAA   ;SU SEDICI
                LD      DE,(VALORX)
                ADD     IX,DE
LMED01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    LMED01          ;L'ULTIMO
                INC     IX
                INC     IX
                LD      A,(PRIMOB)      ; LD      B,2FH           ;WWAA
                LD      B,A             ;WWAA
                LD      IY,MRIT00       ;+5CH   ;DMED1C       WWAA
                LD      DE,(VALORX)     ;WWAA
                ADD     IY,DE           ;WWAA
LMED02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;16 CELLE
                DEC     IY
                DEC     IY
                DJNZ    LMED02
                INC     IY
                INC     IY
                LD      DE,(ERATTU)      ;WWAA LD      DE,(ERMEDI)    INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 16 CELLE
                JR      Z,LMED04
LMED03:
                LD      (MAVA00),DE
                LD      (MRIT00),BC
                JR      LMED05
LMED04:         
                LD      (MAVA00),BC
                LD      (MRIT00),DE
LMED05:
                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,LMED06       ;48 CELLE 16 CELLE TMEPXX WWAA
                CCF                      ; 
LMED06:         LD      HL,0000H
LMED07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    LMED07
                LD      (SOMLO1),HL
                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,LMED08        ;48 CELLE 16 CELLE DTEDXX    WWAA
                CCF
LMED08:         LD      HL,0000H
LMED09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    LMED09
                LD      (SOMLO2),HL
                LD      DE,(SOMLO1)
		SBC     HL,DE
                JR      C,LMED10        ;SIMBOLO ERRORE
                LD      A,114           ;r RITARDO
                LD      (SIMCOL),A
                LD      A,105           ;i
                LD      (SIMCOL+01H),A
                LD      A,116           ;t
                LD      (SIMCOL+02H),A
                JR      LMED11 
LMED10:         CCF
                LD      A,97            ;a SIMBOLO ERRORE
                LD      (SIMCOL),A      ;AVANTI
                LD      A,118           ;v
                LD      (SIMCOL+01H),A
                LD      A,97            ;a
                LD      (SIMCOL+02H),A
		EX      DE,HL
                LD      DE,(SOMLO2)
		SBC     HL,DE
LMED11:         LD      (DIVDEN),HL
                LD      BC,(SECONB)     ;DIVISIONE    WWAA
                LD      B,00H           ;WWAA
                LD      (DIVSOR),BC     ;PER XX GGAA
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (ERMEDI),HL
                LD      A,(MAZTRA)      ;SENTE SE DEVE
                CP      00H             ;AZZERARE TRAVERS
                JR      Z,LMED12
		LD	A,(MM_MC)	;MMXX
		CP	00H
		JR	Z,LMED14
		CALL	MCAZZTR		;MMXX
		CALL	AZZTRA
		JR	LMED12
LMED14:		CALL    AZZTRA		;MMXX
LMED12:         LD      DE,0000H
		SBC     HL,DE
                JR      NZ, LMED13 
                LD      A,32            ;NO ERRORE MMDD11  
                LD      (SIMCOL),A
                LD      (SIMCOL+01H),A
                LD      (SIMCOL+02H),A

LMED13:         


                ;MEDIA ERRORE SU QUATTRO PER DISPLY LONGITUDINALE

                LD      A,(MSHIFT)
                CP      00H
                JR      Z,MEDL02
                CP      0FFH
                JR      NC,MEDL01
                DEC     A
                LD      (MSHIFT),A
                LD      DE,(SHIFT)
                LD      (ERMEDI),DE
                LD      (ERATTU),DE
                JP      MEDL015
MEDL01:         LD      A,00H
                LD      (MSHIFT),A

MEDL02:         
                LD      B,03H           ;FFFE        0FH           ;WWAA 
                LD      IX,DAVA00       ;
                LD      DE,0004H        ;FFFE     ;001CH
                ADD     IX,DE
MEDL03:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDL03          ;L'ULTIMO
                INC     IX
                INC     IX
                LD      B,03H           ;FFFE  0FH           ;WWAA
                LD      IY,DRIT00       ;WWAA
                LD      DE,0004H        ;FFFE     001CH
                ADD     IY,DE           ;WWAA
MEDL04:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;4 CELLE
                DEC     IY
                DEC     IY
                DJNZ    MEDL04
                INC     IY
                INC     IY
                LD      DE,(ERMEDI)      ;FFFE  (ERATTU)   INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 4 CELLE
                JR      Z,MEDL06
MEDL05:
                LD      (DAVA00),DE
                LD      (DRIT00),BC
                JR      MEDL07
MEDL06:         
                LD      (DAVA00),BC
                LD      (DRIT00),DE
MEDL07:
                LD      B,04H              ;FFFE 10H            ;SOMMA DELLE  
                JR      NC,MEDL08        ;4 CELLE  WWAA
                CCF                      ; 
MEDL08:         LD      HL,0000H
MEDL09:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDL09
                LD      (SOMDL1),HL

                LD      B,04H            ; FFFE  10H            ;SOMMA DELLE   WWAA
                JR      NC,MEDL10        ;4 CELLE  WWAA
                CCF
MEDL10:         LD      HL,0000H
MEDL11:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    MEDL11
                LD      (SOMDL2),HL
                LD      DE,(SOMDL1)
                SBC     HL,DE
                JR      C,MEDL12       ;SIMBOLO ERRORE
                JR      MEDL13   
MEDL12:         CCF
		EX      DE,HL
                LD      DE,(SOMDL2)     ;WWAA
		SBC     HL,DE
MEDL13:         LD      (DIVDEN),HL
                LD      BC,0004H        ;FFFE     0010H        ;
                LD      (DIVSOR),BC     ;
                CALL    DIVIS
                LD      DE,(QUOZIE)
                                        ;LD      (ERDILO),HL
                LD      HL,0004H        ;SCRIVO IL 
                SBC     HL,DE           ;SENSO DI
                JR      C,MEDL014       ;CORREZIONE
                LD      A,32            ;QUANDO  
                LD      (SIMCOL),A      ;SUPERA 4  
                LD      (SIMCOL+01H),A   
                LD      (SIMCOL+02H),A  
                JR      MEDL015
MEDL014:
                CCF
MEDL015:
                LD      (BINSET),DE
                LD      (BINSE1),DE

                RET


		;RANGE  IL SEGNO 8H/7H PER SPAZIO 10H/15H

CODICE:        

		LD	A,(MM_MC)	;MMXX
		CP	01H
		JP	Z,CODICE1
		CALL	VERIFI
		LD      A,(MEMB)
		SET     6,A             ;BLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
		LD      A,(GUADS1)      ;CARICO 
		LD      B,A             ;GUADAGNO DI
                LD      A,(MEMA)        ;S1 
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A          
		LD      A,0D7H          ;SE DOPO 5 GIRI
		OUT     (71H),A         ;DI RICERCA
		LD      A,05H           ;FALLITA ESCI
		OUT     (71H),A         
COD1:           LD      A,(SPAZ40)      ;40mm MAX A8
		LD      E,A
COD2:           IN      A,(PB)          
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      Z,COD2
COD3:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      NZ,COD3
		DEC     E
		JR      NZ,COD2
		
		;PRIMO SEGNO

		LD      A,(SEGNO)       ;1mm
		LD      E,A
		LD      BC,0FFFFH       ;NEL CASO MANCHI
TER:            DEC     BC              ;IL CODICE
		LD      A,B
		OR      C
		JR      Z,COD1
		IN      A,(PB)
		BIT     2,A
		JR      Z,TER
		CALL    RIT
		IN      A,(PB)          ;SE>1mm COD1
		BIT     2,A
		JR      NZ,COD1

		;PRIMO SPAZIO BIANCO

		LD      A,(SPAZIO)      ;5mmm MAX 16H
		LD      E,A
MIS2:           IN      A,(PB)          ;SE STAMPA COD1
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      Z,MIS2
MIS3:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      NZ,MIS3
		DEC     E
		JR      NZ,MIS2
		CALL    MARC            ;SENTE SE NEI
		LD      A,00H           ;PROSSIMI 2mm
		OR      B               ;ARRIVA IL SEGNO
		JR      Z,COD1          ;DI CODICE.

		;SECONDO SEGNO

		LD      A,(SEGNO)
		LD      E,A
QUAR:           IN      A,(PB)
		BIT     2,A
		JR      Z,QUAR
		CALL    RIT
		IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1 


		;SECONDO SPAZIO BIANCO

		LD      A,(SPAZIO)      ;5mmm MAX 16H
		LD      E,A
MIS4:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      Z,MIS4
MIS5:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      NZ,MIS5
		DEC     E
		JR      NZ,MIS4
		CALL    MARC
		LD      A,00H
		OR      B
		JP      Z,COD1

		;TERZO SEGNO

		LD      A,(SEGNO)
		LD      E,A
QUIN:           IN      A,(PB)
		BIT     2,A
		JR      Z,QUIN
		CALL    RIT
		IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1

		;TERZO SPAZIO BIANCO

		LD      A,(SPAZIO)
		LD      E,A
MIS6:           IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      Z,MIS6
MIS7:           IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1
		BIT     4,A
		JR      NZ,MIS7
		DEC     E
		JR      NZ,MIS6

		;CALCOLO POSIZIONE PRIMO GATE

         
		LD	A,(MM_MC)	;MMXX
		CP	00H
		JR	Z,MIS8
		JP	MIS9
MIS8:
		IN      A,(PB)          ;WWWW
		BIT     2,A
		JR      Z,MIS8
GATEPU:         IN      A,(10H)         ;LEGGO LA POSI- PPUU
                LD      L,A             ;ZIONE  WWWW
		IN      A,(20H)
                LD      H,A             ;WWWW
                LD      (FASES1),HL     ;WWWW
                LD      A,(SEGRIF)      ;SSRR
                CP      01H
                JR      Z,MIS81
                LD      B,A
                LD      A,(SEQSEG)      ;CONTROLLO SE
                XOR     B               ;SE SONO
                JR      Z,MIS81         ;UGUALI
                LD      A,(SEQSEG)
                SBC     A,B
                JR      C,W40

                LD      DE,(MILL20)
		LD      (MOLTI),DE
                LD      A,(SEGRIF)
                DEC     A
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
		LD	DE,(FASES1) ; LD      DE,(FASPRI)     ;SSRR
		ADD     HL,DE
                LD      DE,(MILL60)     
                SBC     HL,DE           
		LD      A,H             ;CONTROLLO SE 
		CP      10H             ;LA SOMMA HA
                JR      C,W30           ;SUPERATO 4096
		LD      DE,1000H        ;SE LO E'
		SBC     HL,DE           ;SOTTRAGGO AL
                LD	(FASE),HL	;LD      (FASES1),HL     ;RISULTATO 4096
                JR      IIGATE
W30:            CCF
                LD      (FASE),HL      
                JR      IIGATE          ;SSRR
W40:            CCF                     ;SSRR

MIS81:          LD      BC,(MILL60)     ;EEUU(MILL49)   ;(MILL28)  
MIS82:          SBC     HL,BC           ;SE IL RISULTATO  CCDD
                JR      NC,W4           ;E'POSITIVO LO
                CCF                     ;MEMORIZ.IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
                LD      BC,(FASES1)     ;MILL28 E IL
		ADD     HL,BC           ;RESTO LO SOMMO
W4:             LD      (FASE),HL       ;AL VALORE LETTO.


		;CALCOLO POSIZIONE SECONDO GATE
                         
IIGATE:                                ;IIGG

		LD      DE,(MILL20)           
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		DEC     A
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
                LD	DE,(FASES1);LD      DE,(FASPRI)     ;SSRR
		ADD     HL,DE
                LD      A,(NANOCI)      ;NNCC  SSRR
                CP      00H
                JR      Z,W5
                LD      DE,(MILL45)
                JR      W6
W5:             LD      DE,(MILL70)      
W6:             
		SBC     HL,DE           ;SSRR
		LD      A,H             ;CONTROLLO SE 
		CP      10H             ;LA SOMMA HA
                JR      C,W10           ;SUPERATO 4096
		LD      DE,1000H        ;SE LO E'
		SBC     HL,DE           ;SOTTRAGGO AL
		LD      (FASE2),HL      ;RISULTATO 4096
                JR      W20
W10:            CCF
		LD      (FASE2),HL      



		;CALCOLO PUNTO DI ABILITAZIONE DI PA7

W20:            LD      HL,(FASE)
		LD	DE,(MILL35)	;SSRR DEVRIM ;LD      DE,(MILL40)
		SBC     HL,DE
		JR      NC,W3
		CCF
		LD      HL,1000H        ;4096
		SBC     HL,DE
W3:             LD      (FASE3),HL
		LD      A,00H
                LD      (MRIC+00H),A    ;ssii
                LD      (MRIC+02H),A
                LD      A,(SEGRIF)      ;CCGG
                CP      01H
                JR      Z,W9
                CALL    SPASI          
W9:                                     ;CCGG
		LD      HL,(FASE)	;FFAA
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
       
		RET


		;CALCOLO POSIZIONE PRIMO GATE MC CON CODICE

MIS9:          
		IN      A,(PB)
		BIT     2,A
		JR      Z,MIS9
        	IN      A,(10H)         ;LEGGO LA POSI- PPUU
		LD      L,A             ;ZIONE
		IN      A,(20H)
		LD      H,A
		LD      (FASE),HL
                CALL    CENTRA        
		LD      A,(SEQSEG)      ;SE NON E'SELE-
		CP      01H             ;ZIONATO UNO
                JR      Z,XW20           ;SALTO  MMMM

;l'errore e' che salta a xw20 e careica in hl quando il valore e' in de 

		;CALCOLO POSIZIONE  NON PRIMO GATE

 		LD      DE,(MILL20)		;:(MILL19)     ;GRAFIKONTROL FFXX    
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		DEC     A
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
		LD      DE,(FASE)       
		ADD     HL,DE
		LD      A,H             ;CONTROLLO SE 
		CP      10H             ;LA SOMMA HA
                JR      C,XW10          ;SUPERATO 4096 MMMM
		LD      DE,1000H        ;SE LO E'
		SBC     HL,DE           ;SOTTRAGGO AL
		LD      (FASE),HL       ;RISULTATO 4096
                JR      XW20            ;MMMM
XW10:          
		CCF
		LD      (FASE),HL
XW20:           
		LD      A,H		;FFAA
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,00H           
                LD      (MRIC+00H),A    ;SSII
		LD      (MRIC+02H),A
       
		RET




		;MISURA SPAZIO BIANCO

CODICE1:        LD      A,(MEMB)        
		SET     6,A             ;BLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
                LD      A,(GUADS1)      ;CARICO 
		LD      B,A             ;GUADAGNO DI
                LD      A,(MEMA)        ;S1 
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A          
                LD      A,0D7H          ;SE DOPO CIRCA 
                OUT     (71H),A         ;9 GIRI RICERCA 
                LD      A,02H           ;FALLITA ESCI
		OUT     (71H),A
		LD	HL,0FFFFH	;VALORE DI WATCH SSDD
START:         
		LD      BC,(BIANCO)     ;VALORE DI BIANCO BBBB
		IN      A,(PB)          ;SE STAMPA ASPETTA
		CALL	WATCH		;WATCH DOG SSDD
		BIT     2,A             ;
		JR      NZ,START
MIS:            IN      A,(PB)                
		BIT     4,A             ;SE 2048 = 0
		JR      Z,MIS           ;ASPETTA
MIS1:           IN      A,(PB)          ;SE 2048 = 1
		BIT     4,A             ;ASPETTA
		JR      NZ,MIS1
		DEC     C               ;CONTEGGIO SPA-
		JR      NZ,MIS          ;ZIO BIANCO
		IN      A,(PB)
		BIT     2,A
		JR      NZ,START

		;MISURA SPESSORE SEGNO

SEC:            LD      BC,(UNOMIL)   
TER10:       
		CALL	WATCH		;WATCH DOG SSDD
		IN      A,(PB)          ;SE MANCA
		BIT     2,A             ;STAMPA ASPETTA
		JR      Z,TER10
TER11:          IN      A,(PB)
		BIT     4,A
		JR      Z,TER11
TER12:          IN      A,(PB)
		BIT     4,A
		JR      NZ,TER12
		IN      A,(PB)
		BIT     2,A             
		JR      Z,START           
		DEC     C
		JR      NZ,TER11

		;MISURA BIANCO POSTERIORE

                LD      BC,(BIANCO)     ;VALORE BIANCO BBBB
MIS12:          IN      A,(PB)
		BIT     4,A
		JR      Z,MIS12
MIS13:          IN      A,(PB)                
		BIT     4,A
		JR      NZ,MIS13
		DEC     C
		JR      NZ,MIS12
		IN      A,(PB)
		BIT     2,A
		JR      NZ,START
SEC1:           IN      A,(61H)
		LD      E,A
		IN      A,(62H)
		LD      D,A
		LD      (FASE),DE
		LD      A,(MEMB)
		RES     6,A             ;SBLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
		CALL    CENTRA  
		LD      A,00H           ;SE RICERCA OK
		LD      (MRIC+00H),A    ;ANNULLO 
		LD      (MRIC+02H),A	;SSDD
		LD      A,43H           ;RESETTO CTC1
		OUT     (71H),A         
		LD      A,(MEMC)        ;TOLOGO EVEN-
		RES     4,A             ;TUALE PROTE-
		LD      (MEMC),A        ;ZIONE
                OUT     (PC),A          
		RET


		;SUBROUTINE DI RITARDO

RIT:            IN      A,(PB)
		BIT     4,A
		JR      Z,RIT
RIT1:           IN      A,(PB)
		BIT     4,A
		JR      NZ,RIT1
		DEC     E
		JR      NZ,RIT
		RET


		;SUROUTINE DI CONTROLLO CODICE

MARC:           LD      A,(SEGNO)       ;MISURA 2mm IN      
		LD      B,A             ;MODO CHE IN
MAR1:           IN      A,(PB)          ;QUESTO SPAZIO
		BIT     2,A             ;PASSI IL SEGNO
		JR      NZ,RIT0         ;DI CODICE
		BIT     4,A
		JR      Z,MAR1
MAR2:           IN      A,(PB)
		BIT     2,A
		JR      NZ,RIT0
		BIT     4,A
		JR      NZ,MAR2
		DEC     B
		JR      NZ,MAR1
RIT0:           RET


		;ANTI IMPALLAMENTO      ;SSDD
WATCH:					;SSDD
		DEC	HL		;SSDD
		LD	A,H
		OR	L
		JR	Z,WATCH1
		RET
WATCH1:		LD	A,01H
		LD	(DOG),A
		JP	VIA		;SSDD


		;ADEGUAMENTO GUADAGNO AMPLIFICAT. ESTERNO

 
GAINS1:         EXX
		LD      A,(GUADS1)
		CP      60H
		JR      Z,GS11
		CP      40H
		JR      Z,GS12
		CP      20H
		JR      Z,GS13
		CP      00H
		JR      Z,GS14
GS11:           LD      A,40H
		JR      GS15
GS12:           LD      A,20H
		JR      GS15
GS13:           LD      A,00H
		JR      GS15
GS14:           LD      A,60H
GS15:           LD      (GUADS1),A
		EXX
		RET

GAINS2:         EXX
		LD      A,(GUADS2)
		CP      60H
		JR      Z,GS21
		CP      40H
		JR      Z,GS22
		CP      20H
		JR      Z,GS23
		CP      00H
		JR      Z,GS24
GS21:           LD      A,40H
		JR      GS25
GS22:           LD      A,20H
		JR      GS25
GS23:           LD      A,00H
		JR      GS25
GS24:           LD      A,60H
GS25:           LD      (GUADS2),A
		EXX
		RET


               ;CALCOLO RAPPORTO POSIZINE PIENO TRAVERS S1

TRAVER:                                ;+++++++++++++++++
             	LD      A,(MM_MC)       ;PUUU
                CP      00H		
                JR      NZ,TRAV5
		LD	A,(MEMFAS)	;DEVE PASSARE PUUU
		CP	02H		;DUE VOLTE
		JP	NZ,GIR1		;DA PIOB
TRAV5:		
		LD      A,(ALTERR)      ;VEDE SE DEVE PUUU
		CP      00H             ;ASPETTARE
		JR	Z,TRAV3
		JP	MEDT016
TRAV3:		
		LD      A,(TALTER)      ;QUANDO ALTERR PUUU
		CP      00H             ;ARRIVA A ZERO
		JR      Z,TRAV2         ;RIPRENDE IL
		CP	03H             ;CALCOLO DELLO
		JR	NC,TRAV1        ;ERRORE
		DEC     A               ;CALCOLO DELLO
		LD      (TALTER),A      ;ERRORE
		JR	Z,TRAV1
		JP	GIR1	
TRAV1:		LD	A,00H
		LD	(TALTER),A	;PUUU
TRAV2:
		LD      A,(MM_MC)       ;SE M/C SALTO
                CP      00H		
                JR      NZ,TRAV4
		LD	DE,(TASES1)	;VEDO SE PER
		LD	HL,(TASES2)	;ERRORE NON
		SBC	HL,DE		;HO LETTO
		JP	Z,MEDT016	;DUE VOLTE1		;PUUU
		JR	NC,TRAV4	;LS STESSA FASE
		CCF
TRAV4:					;PUUU
		LD      DE,(TERATT)     ;WWAA   (PIRLA)  +
                LD      (TERPRE),DE     ;WWAA MEGAPIRLA  +
                LD      A,(TMSCOR)      ;WWAA
                LD      IX,TPIEN1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
                LD      IY,TPOSI1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
                JR      C,RAPP30        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
                LD      IY,TPIEN1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
                JR      RAPP31
RAPP30:         CCF
		LD      A,00H
RAPP31:         LD      (TRAPP1),A      ;VERIFICO SE E'
                
		LD	A,(MM_MC)	;MMXX
		CP	00H
		JP	NZ,TRAVMC

                ;CALCOLO RAPPORTO POSIZINE PIENO TRAVERS S2

                LD      IX,TPIEN2       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
                LD      IY,TPOSI2       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
                JR      C,RAPP40        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
                LD      IY,TPIEN2
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
                JR      RAPP41
RAPP40:         CCF
		LD      A,00H
RAPP41:         LD      (TRAPP2),A      ;VERIFICO SE E'
                

                ;CALCOLO SPESSORE SEGNO DI RIFERIMENTO

		;CALCOLO POSIZIONE TOTTALE TRAVERS
		;(TASES1 x 10) + TRAPP1 = TPOST1

		LD      DE,(TASES1)     ;TASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(TRAPP1)
		LD      H,00H
		ADD     HL,DE
		LD      (TPOST1),HL
                LD      DE,(POSTO1)
		SBC     HL,DE
                JR      NC,SPES1        ;SE LA MISURA E'  SSSS
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST1)     ;TPOST1<POSTOT
		ADD     HL,DE           ;PER CUI SOMMO  
                LD      DE,(POSTO1)     ;A TPOSTO 40960
		SBC     HL,DE           ;E RIPETO SBC.
SPES1:
                LD      (SPELE1),HL

		
                ;CALCOLO POSIZIONE TOTTALE TRAVERS S2

PROVAT:
                LD      DE,(TASES2)     ;FASES2 x 10
                LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
                LD      HL,(TRAPP2)
		LD      H,00H
		ADD     HL,DE
                LD      (TPOST2),HL
                LD      DE,(POSTO2)     ;SSSS
		SBC     HL,DE
                JR      NC,SPES2        ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
                LD      DE,(TPOST2)     ;POSTO2<POSTO1
		ADD     HL,DE           ;PER CUI SOMMO  
                LD      DE,(POSTO2)     ;A POSTO2 40960  SSSS
		SBC     HL,DE           ;E RIPETO SBC.
SPES2:
                LD      (SPELE2),HL


		;(ERRORE x DECIMILLES.IN DIV.ENC.)-
		;DISTANZA IN CENTIMILLESIMI : 1000 =ERRORE
                ;IN CENTESIMI

                LD      A,(SEGOFF)      ;WWSS
                CP      00H
                JR      Z,SPES4     
                CP      02H             ;
                JR      Z,SPES3         
                LD      DE,(OFFSET)     
                SBC     HL,DE           
                JR      SPES4           
SPES3:        
		LD      DE,(OFFSET)     ;SSSS
                ADD     HL,DE
SPES4:
                LD      (SPEOFF),HL     ;WWSS 
                EX      DE,HL
                LD      HL,(SPELE1)     ;HL=SPESSORE SEGNO WWAA
		SBC     HL,DE
                JR      NC,TZ2
                LD      A,01H           
		LD      (TMSCOR),A      
		CCF
		EX      DE,HL
                LD      DE,(SPELE1)
		SBC     HL,DE
                JR      TZ3              

TZ2:            LD      A,08H           
		LD      (TMSCOR),A      
TZ3:
                LD      (TERATT),HL
                EX      DE,HL           ;  SSSS       
                LD      A,(MTASTI)      ;CONTROLLO SE
		CP      00H             ;SONO PASSATO
                JR      NZ,ERR11        ;DALLA TASIERA.
		LD      HL,0064H        ;SOMMO A ERPREC
                LD      BC,(TERPRE)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;ERATTU SE CARRY
                JR      NC,ERR12        ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
                LD      BC,(TERPRE)     ;LATA LA IGNORO.
	        LD      (TERATT),BC   
		LD	A,(SALTO)	;SE SALTO E'	EEUU
		CP	00H		;ZERO CORREGGO EEUU
		JR	Z,ERR16		;SEMPRE EEUU
                LD      A,(CONSAT)      ;CONTROLLA CHE NON EEAA
		DEC     A               ;CHE NON RIMANGA
                LD      (CONSAT),A      ;IN BLOCCO PER PIU'EEAA
		CP      00H             ;DI N GIRI MEMO- 
                JR      Z,ERR13         ;RIZZATI IN SALTO  
		JP      GIR1            ;E POI
ERR13:					;
                LD      (TERATT),DE     ;RICARICA L'ULTIMO
                LD      (TERPRE),DE     ;ERRORE LETTO
                JR      ERR12            
ERR11:          
		DEC     A               ;ATTESA 4 GIRI SE
		LD      (MTASTI),A      ;PASSATO DA TATSI.
ERR12:          
		LD      A,(SALTO)       ;CARICA I GIRI DI
                LD      (CONSAT),A      ;ATTESA.    EEAA
ERR16:		
		LD      A,(MKBUSY)      ;VEDO SE TASTIERA EEUU
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
ERR15:					
                CALL    TMEDIA
	        CALL    DISPLT          
                CALL    DISPLD
ERR14:          LD      HL,(BINSET)
                LD      (TDISPR),HL     
                LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR

                RET


                ;CALCOLO ERRORE MEDIO PER CORREZIONE TRAVERS.


TMEDIA:
                LD      A,(TPRIMB)      ;WWAA
                LD      B,A
                LD      IX,MOPE00               ;+5CH     ;DMEP1C WWAA   ;SU SEDICI
                LD      DE,(TVALOX)
                ADD     IX,DE
TMED01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    TMED01          ;L'ULTIMO
                INC     IX
                INC     IX
                LD      A,(TPRIMB)      ; LD      B,2FH           ;WWAA
                LD      B,A             ;WWAA
                LD      IY,MTRA00       ;+5CH   ;DMED1C       WWAA
                LD      DE,(TVALOX)     ;WWAA
                ADD     IY,DE           ;WWAA
TMED02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;16 CELLE
                DEC     IY
                DEC     IY
                DJNZ    TMED02
                INC     IY
                INC     IY
                LD      DE,(TERATT)      ;WWAA LD      DE,(ERMEDI)    INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(TMSCOR)       ;NELLA PRIMA
                CP      01H              ;DELLE 16 CELLE
                JR      Z,TMED04
TMED03:
                LD      (MOPE00),DE
                LD      (MTRA00),BC
                JR      TMED05
TMED04:         
                LD      (MOPE00),BC
                LD      (MTRA00),DE
TMED05:
                LD      A,(TSECOB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,TMED06       ;48 CELLE 16 CELLE TMEPXX WWAA
                CCF                      ; 
TMED06:         LD      HL,0000H
TMED07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    TMED07
                LD      (SOMTR1),HL
                LD      A,(TSECOB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,TMED08        ;48 CELLE 16 CELLE DTEDXX    WWAA
                CCF
TMED08:         LD      HL,0000H
TMED09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    TMED09

                LD      (SOMTR2),HL
                LD      DE,(SOMTR1)
                SBC     HL,DE
                JR      C,TMED11 
                LD      A,(DIAGON)
                CP      01H
                JR      Z,TMED10 
                LD      A,116           ;t SIMBOLO ERRORE
                LD      (SIMCOT),A      ;LATO TRASMISS.
                LD      A,114           ;r
                LD      (SIMCOT+01H),A
                LD      A,97            ;a
                LD      (SIMCOT+02H),A
                JR      TMED14 
TMED10:         LD      A,111           ;o SIMBOLO ERRORE
                LD      (SIMCOT),A      ;LATO OPERATORE
                LD      A,112           ;p
                LD      (SIMCOT+01H),A
                LD      A,101           ;e
                LD      (SIMCOT+02H),A
                JR      TMED14 
TMED11:         CCF
                LD      A,(DIAGON)
                CP      01H
                JR      Z,TMED12 
                LD      A,111           ;o SIMBOLO ERRORE
                LD      (SIMCOT),A      ;LATO OPERATORE
                LD      A,112           ;p
                LD      (SIMCOT+01H),A
                LD      A,101           ;e
                LD      (SIMCOT+02H),A
                JR      TMED13 

TMED12:         LD      A,116           ;t SIMBOLO ERRORE
                LD      (SIMCOT),A      ;LATO TRASMISS.
                LD      A,114           ;r
                LD      (SIMCOT+01H),A
                LD      A,97            ;a
                LD      (SIMCOT+02H),A


TMED13:         EX      DE,HL
                LD      DE,(SOMTR2)
		SBC     HL,DE
TMED14:         LD      (DIVDEN),HL
                LD      BC,(TSECOB)     ;DIVISIONE
                LD      B,00H
                LD      (DIVSOR),BC     ;PER 16 GGAA
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (TERMED),HL
		LD      DE,0000H
		SBC     HL,DE
                JR      NZ,TMED15 
                LD      A,32            ;NO ERRORI MMDD11
                LD      (SIMCOT),A
                LD      (SIMCOT+01H),A
                LD      (SIMCOT+02H),A

TMED15:        

                ;MEDIA ERRORE SU QUATTRO PER DISPLY TRASVERSALE

                LD      A,(MTSHIF)      ;FFFE
                CP      00H
                JR      Z,MEDT02
                CP      0FFH
                JR      NC,MEDT01
                DEC     A
                LD      (MTSHIF),A
                LD      DE,(TSHIFT)
                LD      (TERMED),DE
                LD      (TERATT),DE
                JP      MEDT015
MEDT01:         LD      A,00H
                LD      (MTSHIF),A

MEDT02:         
                LD      B,03H           ;FFFE        0FH           ;WWAA 
                LD      IX,DTRA00       ;
                LD      DE,0004H        ;FFFE     ;001CH
                ADD     IX,DE
MEDT03:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDT03          ;L'ULTIMO
                INC     IX
                INC     IX
                LD      B,03H           ;FFFE  0FH           ;WWAA
                LD      IY,DOPE00       ;WWAA
                LD      DE,0004H        ;FFFE     001CH
                ADD     IY,DE           ;WWAA
MEDT04:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;4 CELLE
                DEC     IY
                DEC     IY
                DJNZ    MEDT04
                INC     IY
                INC     IY
                LD      DE,(TERMED)      ;FFFE  (ERATTU)   INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(TMSCOR)       ;NELLA PRIMA
                CP      01H              ;DELLE 4 CELLE
                JR      Z,MEDT06
MEDT05:
                LD      (DTRA00),DE
                LD      (DOPE00),BC
                JR      MEDT07
MEDT06:         
                LD      (DTRA00),BC
                LD      (DOPE00),DE
MEDT07:
                LD      B,04H              ;FFFE 10H            ;SOMMA DELLE  
                JR      NC,MEDT08        ;4 CELLE  WWAA
                CCF                      ; 
MEDT08:         LD      HL,0000H
MEDT09:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDT09
                LD      (SOMDT1),HL
                LD      B,04H            ; FFFE  10H            ;SOMMA DELLE   WWAA
                JR      NC,MEDT10        ;4 CELLE  WWAA
                CCF
MEDT10:         LD      HL,0000H
MEDT11:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    MEDT11
                LD      (SOMDT2),HL
                LD      DE,(SOMDT1)
                SBC     HL,DE
                JR      C,MEDT12       ;SIMBOLO ERRORE
                JR      MEDT13   
MEDT12:         CCF
		EX      DE,HL
                LD      DE,(SOMDT2)     ;WWAA
		SBC     HL,DE
MEDT13:         LD      (DIVDEN),HL
                LD      BC,0004H        ;FFFE     0010H        ;
                LD      (DIVSOR),BC     ;
                CALL    DIVIS
                LD      DE,(QUOZIE)
                LD      HL,0004H        ;SCRIVO IL 
                SBC     HL,DE           ;SENSO DI
                JR      C,MEDT014       ;CORREZIONE
                LD      A,32            ;QUANDO  
                LD      (SIMCOT),A      ;SUPERA 4  
                LD      (SIMCOT+01H),A   
                LD      (SIMCOT+02H),A  
                JR      MEDT015
MEDT014:
                CCF
MEDT015:
                LD      (BINSET),DE
                LD      (BINSE2),DE
MEDT016:				;PUUU
                RET



		;CALCOLO CORREZIONE TRAVERS

CORTRA:         LD      HL,(TERMED)     ;CONTROLLO LA
		LD      DE,(ZONT)       ;ZONA MORTA
		SBC     HL,DE
		JR      NC,TCORRE
		CCF
                LD      A,(MEMC)    ;CCMM    
                RES     6,A             
                RES     7,A             
		LD      (MEMC),A        
		OUT     (PC),A          
		JP      TOFINE


		;#####################################
		;# CALCOLO CORREZIONE MOTORE TRAVERS #
		;# Et x Gt = TEMPO DI CORREZIONE     #   
		;#####################################

		
TCORRE:         
                LD      A,(PROTEZ)      ;CCMM
                CP      01H
                JP      Z,TOFINE

                LD      DE,(TERATT)     ;ZZZ
                LD      (MOLT24),DE
		LD      A,(GUATRA)
                LD      (MOLP24),A
                CALL    MOL24           ;########################
                LD      BC,(PROD24)     ;# VEDER DI ELIMINARE C #
                                        ;########################
                LD      A,(PROD24+02H)
                LD      (MDECOT),A      ;VALORE PER BBB
                CP      00H             ;EXTRA CORREZ.
                JR      NZ,TCORR1
                NOP                     ;LD      A,B
                LD      (TMEM6),BC      ;ZZZ
                JR      TCORR2          
TCORR1:         LD      B,0FFH
                LD      (TMEM6),BC       ;BC = ERRORE ZZZ

		;ROUTINE DI CORREZIONE TRAVERS

TCORR2:         LD      A,(TATTES)      ;CONTROLLO CICLO
		DEC     A               ;DI ATTESA
		LD      (TATTES),A
		CP      00H
                JR      NZ,TOFINE       
               	LD	A,(OF_ROT)
		CP	00H
		JR	NZ,TCORR3
		LD	A,(TCICAT)
		JR	TCORR4
TCORR3:
                LD      A,(TCICLO)      ;RICARICO IL CI- FOFF
TCORR4:				
		LD      (TATTES),A      ;CICLO
                LD      A,(MEMC)        ;SE IN MANUALE
                BIT     4,A             ;SALTO
		JR      Z,TOFINE
		LD      A,(TMEM4)
		CP      00H
		JR      Z,TOFINE        ;2
                LD      A,B             ;SE ERRORE = 0
                OR      C               ;SALTO ZZZ VEDERE DI ELIMINARE C
                JR      Z,TOFINE        ;################################
                LD      A,(MDECOT)      ;ZZZ
                LD      (DECORT),A      ;ZZZ
                LD      BC,(TMEM6)       ;ZZZ
                LD      (TMEM5),BC       ;ZZZ
                LD      A,0B7H           ;JJJ   B7H   
                OUT     (73H),A
                LD      A,07H           ;ZZZ
                OUT     (73H),A         ;
                LD      BC,(DIAGON)     
                LD      A,(TMSCOR)
                ADD     A,C
                CP      02H
                JR      Z,TAURIT
                CP      08H
                JR      Z,TAURIT
		LD      A,(MEMC)        ;CORREZIONE 
		RES     7,A             ;LATO OPERAT.
		SET     6,A
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,116           ;LATO OPERAT.
		LD      (SIMCOT),A
                JR      TOFINE          
TAURIT:         LD      A,(MEMC)        ;CORREZIONE 
		RES     6,A             ;LATO TRASM.
		SET     7,A
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,111           ;LATO TRASM.
		LD      (SIMCOT),A
TOFINE:
                RET
		      
		;SPOATMENTO REGISTRO TRAVERS
                
AZZTRA:         
                LD      HL,(SPELE1)     ;SOTTRAGGO TRA
                LD      DE,(SPELE2)     ;LORO I DUE 
                SBC     HL,DE           ;SPESSORI LA
                JR      NC,AZZTR1       ;DIFFERENZA LA
                CCF
                LD      A,01H           ;SOMMO A QUELLO  WWSS
                LD      (SEGOFF),A      ;INFERIORE IN
                EX      DE,HL           ;MODO DI AVERE
                LD      DE,(SPELE1)     ;ALL'AZZERAMENTO
                SBC     HL,DE           ;DUE SPESSORI
                LD      (OFFSET),HL     ;EGUALI E
                JR      AZZTR2          ;NEGATIVO O
AZZTR1:         LD      A,02H           ;POSITIVO  WWSS
                LD      (SEGOFF),A
                LD      (OFFSET),HL
AZZTR2:       
                JP      TPOFIN
TSPOST:        
		LD      HL,(TSHIFT)     
		LD      A,(TIUMEN)               
                CP      3FH              ;WWSS 78H
		JR      Z,SOTTRA

                LD      A,(SEGOFF)
                CP      02H
                JR      Z,AZZTR3
                LD      HL,(TSHIFT)
                LD      DE,(OFFSET)
                SBC     HL,DE
                JR      C,AZZTR5
                LD      A,02H
                LD      (SEGOFF),A
                JP      AZZTR4
AZZTR5:
                CCF
                EX      DE,HL
                LD      DE,(TSHIFT)
                SBC     HL,DE
                JR      AZZTR4
		JR      TPOFIN
SOTTRA:         
                LD      A,(SEGOFF)
                CP      01H
                JR      Z,AZZTR3
                LD      HL,(OFFSET)
                LD      DE,(TSHIFT)
                SBC     HL,DE
                JR      NC,AZZTR4
                CCF
                EX      DE,HL
                LD      DE,(OFFSET)
                SBC     HL,DE
                LD      A,01H
                LD      (SEGOFF),A
                JR      AZZTR4
AZZTR3:         LD      HL,(OFFSET)
                LD      DE,(TSHIFT)
                ADD     HL,DE
AZZTR4:         LD      (OFFSET),HL
TPOFIN:                                   ;EELL
                LD      A,00H
                LD      (MAZTRA),A        ; GGAA
                RET


                ;ROUTINE PER LCD

TXSET:
                LD      B,07H           ;TRASMISSIONE
TXSET1:         LD      A,(HL)          ;INIZIALIZ.LCD
                CALL    SERPAR
                INC     HL
                DJNZ    TXSET1
                RET
TX:
                LD      B,14H           ;TRASMISSIONE
TX1:            LD      A,(HL)          ;20 CARATTERI
                CALL    SERPAR
                INC     HL
                DJNZ    TX1
TX2:            RET
TXUNO:
                LD      B,01H           
TXUNO1:         LD      A,(HL)
                CALL    SERPAR
                INC     HL
                DJNZ    TXUNO1
                RET
INISI:
                CALL    RSZERO
                LD      HL,SETTA
                CALL    TXSET
                CALL    SPETA
                CALL    RSUNO
INISI1:         RET

ALTA:
                CALL    RSZERO
                CALL    TXUNO
                CALL    SPETA           
                CALL    RSUNO           
                CALL    SPETA
                RET
BASSA:
                CALL    RSZERO
                LD      HL,SECUND
                CALL    TXUNO
                CALL    RSUNO
                RET
SERPAR:
                PUSH    BC              ;TRASMISSIONE
                LD      B,08H           ;SERIALE PARAL-
                LD      C,A             ;LELO
SERPA1:         LD      A,(MEMB)
                RL      C
                JR      NC,WA1
                SET     7,A
                JR      WA2
WA1:            RES     7,A
WA2:            LD      (MEMB),A
                OUT     (PB),A
                LD      A,(MEMA)
                SET     1,A
                OUT     (PA),A
                RES     1,A
                OUT     (PA),A
                LD      (MEMA),A
                DJNZ    SERPA1
                LD      A,(MEMA)
                SET     3,A
                OUT     (PA),A
                RES     3,A
                OUT     (PA),A
                LD      (MEMA),A
                POP     BC
                RET                     
RSZERO:         
		LD      A,(MEMB)        ;METTO A ZERO
                RES     0,A             ;RS
                OUT     (PB),A
                LD      (MEMB),A
                RET
RSUNO:         
		LD      A,(MEMB)        ;METTO A UNO
                SET     0,A             ;RS
                OUT     (PB),A
                LD      (MEMB),A
                RET
SPETA:          
		LD      E,0B0H
SPETA1:         DEC     E
                JR      NZ,SPETA1
                RET

                ;SCRITTURA ACCELLERA            
 
                
ACCEL:          LD      A,(LINGUA)
		CP      00H
                JR      Z,ACCM
		CP      01H
                JR      Z,ACCI
		CP      02H
                JR      Z,ACCF
		CP      03H
                JR      Z,ACCGB
                CP      04H
                JR      Z,ACCE
                CP      05H
                JR      Z,ACCD          ;DDDD

                JR      ACCFIN
ACCM:           CALL    BASSA
                LD      HL,ACELER
                JR      ACCTX
ACCI:           CALL    BASSA
                LD      HL,ACELER+14H
                JR      ACCTX
ACCF:           CALL    BASSA
                LD      HL,ACELER+28H
                JR      ACCTX
ACCGB:          CALL    BASSA
                LD      HL,ACELER+3CH
                JR      ACCTX
ACCE:           CALL    BASSA
                LD      HL,ACELER+50H
                JR      ACCTX
ACCD:           CALL    BASSA
                LD      HL,ACELER+64H

ACCTX:          CALL    TX
                CALL    RITVEL    
		CALL	AZZTOT	       ;PUUU  
	
ACCFIN:         RET


                ;SCRITTURA  DECELLERA

DECEL:          LD      A,(LINGUA)
		CP      00H
                JR      Z,DECM
		CP      01H
                JR      Z,DECI
		CP      02H
                JR      Z,DECF
		CP      03H
                JR      Z,DECGB
                CP      04H
                JR      Z,DECE
                CP      05H
                JR      Z,DECD          ;DDDD

                JR      DECFIN
DECM:           CALL    BASSA
                LD      HL,DECELE
                JR      DECTX
DECI:           CALL    BASSA
                LD      HL,DECELE+14H
                JR      DECTX
DECF:           CALL    BASSA
                LD      HL,DECELE+28H
                JR      DECTX
DECGB:          CALL    BASSA
                LD      HL,DECELE+3CH
                JR      DECTX
DECE:           CALL    BASSA
                LD      HL,DECELE+50H
                JR      DECTX
DECD:           CALL    BASSA
                LD      HL,DECELE+64H

DECTX:          CALL    TX
                CALL    RITVEL
		CALL	AZZTOT		;PUUU

DECFIN:         RET


                ;RITARDO SCRITTURA ACCEL DECEL


RITVEL:        
                CALL    RESEPC          ;FFLL
                LD      BC,0FFFFH       ;TVVV
RITVE1:         
                DEC     BC
                LD      A,B
                OR      C
                JR      NZ,RITVE1
                RET                     ;FFZZ
                
                ;CALCOLO VELOCITA'ISTANTANEA SLEGATO     BBLL
                ;DAL NORMALE CALCOLO USATO SOLO PER NOPRI
                
VELIST:                                 ;BBLL

                LD      BC,011DH        ;4mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
VELO1:          IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,VELO2        ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO
VELO2:         
		DEC     BC              
                LD      A,B
                OR      C
                JR      NZ,VELO1       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.
                LD      DE,(COSVEL)
		LD      (MDO032),DE
		LD      DE,0000H
		LD      (MDO232),DE
		LD      (MRE232),DE
		LD      DE,(IMPVEL)
		LD      (MRE032),DE
		LD      A,02H           
		LD      (ALTDIV),A      
		CALL    MOL32
		CALL    DI1000
		LD      BC,(QU1000)     ;VELOCITA         
		LD      (ISTVEL),BC     ;ISTANTANEA    
                LD      (BINSET),BC     ;TTVV
                LD      A,01H           ;TTVV
                LD      (VELMEM),A      ;TTVV
                CALL    BIN7            ;TTVV
                LD      A,00H           ;TTVV
                LD      (VELMEM),A      ;TTVV
                RET




SERITA:
		LD      A,(GUADS1)      ;SALVA IL VALORE OO11
		LD      H,A             ;DI AMPLIF. OO11
		LD      A,(MEMA)
		RES     2,A
		OUT     (PA),A
		SET     2,A
		OUT     (PA),A
		LD      D,00H           
		LD      B,08H           
KRITPA:
		RES     1,A
		OUT     (PA),A
		IN      A,(PA)
		RR      A     
		RL      D
		SET     1,A
		SET     2,A
		AND     0FH             ;RIPRISTINA OO11
		ADD     A,H             ;AMPLIFICAZ.OO11 
		OUT     (PA),A
		LD      (MEMA),A
		DJNZ    KRITPA
		LD      (MEMA),A        
		LD      A,D
		AND     1FH             
                NOP                     ;CALL    CAG
		LD      L,A             ;LEGGO DUE VOLTE
		LD      H,00H           ;LA TASTIERA CON
		LD      DE,TABLE        ;UN RITARDO TRA 
		ADD     HL,DE           ;PRIMA E LA SECON-
		RET


               ;ANNULLA LO SHIFT QUANDO SI ESEGUE F4 
               ;SENZA AVER MODIFICATAO IL VALORE A F3

               


AZZF4:          LD      DE,7D0H         ;2000 = 20mmX100
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
		SBC     HL,DE
		LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
                LD      HL,(PTO232)     ;CENTESIMI
                LD      (DISTA2),HL     ;SIA PER LONG
                RET                     ;CHE PER TRAVERS






;RUTINE DI CORREZIONE ALLA PARTENZA DOPO F4 PER ESSERE RAPIDI ALL'AVVIO 
;IL TEMPO DICORREZZIONE VIENE CALCOLATO COME SEGUE   FFXX
;ERRORE x 60 / VELCOR = VALORE DI CORREZZIONE
;ATTENZIONE PER EVITARE DEI BLOCCHI IL VALORE MINIMO DI ERMEDI
;DEVE ESSERE SUPERIORE 0005    FFZZ

FLEXOL:
                LD      A,00H           ;FFZZ
                LD      (MFLEXL),A      ;FFZZ
                LD      HL,(ERATTU)     ;ERMEDI > 0005 FFRR
                LD      DE,0005H        ;PER CONTINUA- FFXX
                SBC     HL,DE           ;RE NELLA 
                JR      NC,FLEX1        ;CORREZZIONE   FFXX
                CCF
                JP      FINTRL          ;FFZZZ  FFXX

FLEX1:          LD      DE,(ERATTU)     ;MOLTIPLICO PER FFXX FFRR
                LD      (MOLTI),DE      ;60 L'ERRORE
                LD      A,3CH           ;
                LD      (MOLPL),A       ;
                CALL    MOLT            ;
                LD      DE,(PROD)

                LD      (DIVDEN),DE     ;DIVIDO PER
                LD      BC,(VCLONG)     ;PER VELOCTA'
                LD      (DIVSOR),BC     ;DI CORREZIONE
		CALL    DIVIS
                LD      DE,(QUOZIE)     ;

                LD      (FLERRO),DE     ;FFZZ   FFXX

		LD      A,(MSCORR)      ;VEDO IN CHE
		CP      01H             ;SENSO CORREG.
                JR      NZ,FLERIT
		LD      A,(MEMC)        ;CORREZIONE IN
		RES     1,A             ;AVANTI
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                JP      FINTRL          ;FFXX
FLERIT:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     0,A             ;RITARDO
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                JP      FINTRL          ;FFXX

                RET                     ;FFZZ

FLEXOT:         
                LD      A,00H           ;FFZZ
                LD      (MFLEXT),A      ;FFZZ
                LD      HL,(TERATT)     ;TERMED > 0005 FFRR
                LD      DE,0005H        ;PER CONTINUA- FFXX
                SBC     HL,DE           ;RE NELLA
                JR      NC,FLEX2        ;CORREZZIONE FFXX
                CCF
                JR      FINTRL          ;FFXX

FLEX2:          LD      DE,(TERATT)     ;MOLTIPLICO PER FFXX FFRR
                LD      (MOLTI),DE      ;60 L'ERRORE
                LD      A,3CH           ;
                LD      (MOLPL),A       ;
                CALL    MOLT            ;
                LD      DE,(PROD)
                LD      (DIVDEN),DE     ;DIVIDO PER
                LD      BC,(VCTRAV)     ;PER VELOCTA'
                LD      (DIVSOR),BC     ;DI CORREZIONE
		CALL    DIVIS
                LD      DE,(QUOZIE)     ;
                LD      (FLERRO),DE     ;FFZZ  FFXX
                LD      A,(SIMCOT)
                CP      116
                JR      Z,FLETRA
                LD      A,(MEMC)        ;CORREZIONE 
                RES     6,A             ;LATO TRASM.
                SET     7,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                JR      FINTRL          ;FFXX
FLETRA:         LD      A,(MEMC)        ;CORREZIONE
                SET     6,A             ;LATO OPERAT.
                RES     7,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                JR      FINTRL          ;FFXX
FINTRL:         
                RET

                ;RUTINE TEMPI DI CORREZIONE LONG/TRAV
                ;DISABILITO PIO B
FXCORR:
                LD      A,37H           ;PAR.CONT.INTER.    FFJJ
		OUT     (03H),A
                LD      A,0FFH          ;P.MAS.BIT 0234567  FFJJ
		OUT     (03H),A         ;ALL'INTERUPT
                LD      DE,(FLERRO)
FXCOR1:         LD      BC,09FFH       ;
FXCOR2:         DEC     BC
		LD      A,B
		OR      C
                JR      NZ,FXCOR2
                DEC     DE              ;FFZZ
                LD      A,D             ;FFZZ
                OR      E               ;FFZZ
                JR      NZ,FXCOR1
                CALL    RESEPC          ;FFLL

                ;RIABILITO PIO B

                LD      A,22H           ;VET.INT.PIO B
                OUT     (03H),A         ;CONTROLLO PIO B
		LD      A,0CFH          ;PORTA B MODO 3
		OUT     (03H),A
                LD      A,3EH           ;067 OUT 12345 IN   CCMM11
		OUT     (03H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (03H),A
                LD      A,0DDH          ;P.MAS.BIT 023467 CCMM11
		OUT     (03H),A         ;ALL'INTERUPT
                LD      A,00H           ;LLTT
                LD      (MTASTI),A      ;LLTT
                RET

RESEPC:
                LD      A,(PROTEZ)      ;FFLL
                CP      01H
                JR      Z,RESPE1
                LD      A,(MEMC)        
		RES     0,A
		RES     1,A
                RES     6,A
                RES     7,A
		LD      (MEMC),A
		OUT     (PC),A
RESPE1:         RET

                ;CORREZIONE MANUALE CALIBRATA

CORCAL:
                LD      A,(MESSA)       ;CCMM
                CP      00H
                JR      Z,CALFIN
                LD      A,(MEM8A)       ;CCMM
                CP      00H
                JR      Z,CALFIN
                CP      01H
                JR      Z,CALRIT
                CP      02H
                JR      Z,CALAVA
                CP      03H
                JR      Z,CALOPE
                CP      04H
                JR      Z,CALTRA
                JR      CALFIN

CALRIT:
                LD      DE,(CALIBR)
                LD      (ERATTU),DE
                LD      A,08H
                LD      (MSCORR),A
                CALL    FLEXOL
                JR      CALFIN
CALAVA:
                LD      DE,(CALIBR)
                LD      (ERATTU),DE
                LD      A,01H
                LD      (MSCORR),A
                CALL    FLEXOL
                JR      CALFIN
CALOPE:
                LD      DE,(CALIBR)
                LD      (TERATT),DE
                LD      A,116
                LD      (SIMCOT),A
                CALL    FLEXOT
                JR      CALFIN
CALTRA:
                LD      DE,(CALIBR)
                LD      (TERATT),DE
                LD      A,111
                LD      (SIMCOT),A
                CALL    FLEXOT

CALFIN:         LD      DE,0000H
                LD      (CALIBR),DE
                LD      (ERATTU),DE
                LD      (TERATT),DE
                LD      (MEM8A),DE
                RET                     ;CCMM



                ;FASATURA CON OSCILLOSCOPIO ESTERNO  FF55

SPOFAS:

                IN      A,(PA)          ;
		BIT     4,A
                JP      NZ,SPOEN1       ;
                CALL    SERITA          ;
                LD      DE,(INCEXT)
		LD      A,00H
		CP      E
                JR      NZ,EXTE1
                LD      E,14H
                LD      (INCEXT),DE
                JR      EXTE2
EXTE1:          LD      A,01H
		ADD     A,E
		LD      E,A
                LD      (INCEXT),DE
EXTE2:
                LD      A,(HL)          ;VERIFICO SE
                AND     1FH             ;PIGIATO
                CP      08H             ;AVANTI/RITARDO
                JP      Z,SXSPOS        ;LLLL
		CP      09H
                JR      Z,DXSPOS
		JP	SPOEND
DXSPOS:                
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,SPOF01
                LD      (FASE),HL
                JR      SPOF02
SPOF01:         CCF
                LD      HL,0FFFH
SPOF02:        
		LD      (FASE),HL
                LD      HL,(FASE2)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,SPOF03
                LD      (FASE2),HL
                JR      SPOF04
SPOF03:         CCF
                LD      HL,0FFFH
SPOF04:        
		LD      (FASE2),HL
                LD      HL,(FASE3)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,SPOF05
                LD      (FASE3),HL
                JR      SPOF06
SPOF05:         CCF
                LD      HL,0FFFH
SPOF06:         LD      (FASE3),HL
                JR      SPOEND
SXSPOS:
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                ADD     HL,DE
                LD      A,H
                CP      10H
                JR      NZ,SPOF07
                LD      HL,0000H
SPOF07:         LD      (FASE),HL
		JR	SPOEND		;MMXX

SPOEN1:         LD      DE,0000H
                LD      (INCEXT),DE
SPOEND:
                RET


		;CALCOLO CENTRATURA GATE

                

CENTRA:         EXX
		LD      HL,(FASE)       ;SOTTRAGGO IL VA-
                LD      BC,(MEZGA1)      ;LORE DI 1/2 GATE MMXX
                SBC     HL,BC           ;SE IL RISULTATO
		JR      C,RISNEG        ;E'POSITIVO LO
		JR      TRFASE          ;MEMORIZZO IN
RISNEG:         CCF                     ;IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
		LD      BC,(FASE)       ;IL 1/2 GATE E IL
		ADD     HL,BC           ;RESTO LO SOMMO
TRFASE:         LD      (FASE),HL       ;AL VALORE LETTO.
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,04H           ;4 GIRI ATTESA
		LD      (MEMRIF),A      ;PER MEMORIZZARE
		EXX                     ;IL RIFERIMENTO
		RET
CENTRO:         
		EXX                     ;FF56
                LD      HL,(FASES1)     ;SOTTRAGGO IL VA-
		LD      BC,(MEZGA1)     ;LORE DI 1/2 GATE MMXX
			                ;DAL VALORE LETTO
                SBC     HL,BC           ;SE IL RISULTATO
		JR      C,RISNE1        ;E'POSITIVO LO
		JR      TRFAS1          ;MEMORIZZO IN
RISNE1:         CCF                     ;IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
                LD      BC,(FASES1)       ;IL 1/2 GATE E IL
		ADD     HL,BC           ;RESTO LO SOMMO
TRFAS1:         LD      (FASE),HL       ;AL VALORE LETTO.
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,04H           ;4 GIRI ATTESA
		LD      (MEMRIF),A      ;PER MEMORIZZARE
		EXX                     ;IL RIFERIMENTO
		RET
		

	          ;CALCOLO DISTANZA TRA I SEGNI

SPASI:
                LD      A,(SEQSEG)      ;CCGG
                LD      BC,(SEGRIF)     ;SSRR CCGG
                SBC     A,C             ;SSRR CCGG
		LD      (MOLPL),A
                LD      DE,7D0H         ;H2000 = 20mmX100
		LD      (MOLTI),DE
		CALL    MOLT
		LD      HL,(PROD)
		LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
		LD      HL,(PTO232)     ;CENTIMILLESIMI
		LD      (DISTA2),HL
                RET                     ;CCGG

              ;CENTRATURA GATE CON FUN5 E OSCILLOSCOPIO


CENOSC:         LD      HL,(FASE)       ;SOMMO IL VA-
		LD      BC,(MEZGA)      ;LORE DI 1/2 GATE
		LD      B,00H           ;DAL VALORE LETTO
                ADD     HL,BC           ;DELLA FASE
                LD      (FASES1),HL     ;CONTROLLO SE
                EX      DE,HL           ;SONO A CAVALLO
                LD      HL,1000H        ;DELLO ZERO
                SBC     HL,DE           ;IL VALORE 
                JR      C,CENOS1        ;OTTENUTO LO
                JR      CENOS2          ;METTO IN FASES1
CENOS1:         CCF                     ;POI CREO UN
                LD      HL,1000H        ;VALORE APPROS-
                EX      DE,HL           ;SIMATO DI RIFTOT
                SBC     HL,DE           ;MOLTIPLICANDO
                LD      (FASES1),HL     ;PER 10 FASES1

CENOS2:         LD      HL,(FASES1)
                LD      (MOLTI),HL
                LD      A,0AH
                LD      (MOLPL),A
                CALL    MOLT
                LD      DE,(PROD)
                LD      (RIFTOT),DE

                RET





;#########################################
;# PARTI DI PROGRAMMA PER MARCA CILINDRO #
;#########################################


XPIOB:         
		
		LD      A,(ALTERR)      ;QUANDO ALTERR PUUU
		CP      00H             ;ARRIVA A ZERO
		JR      Z,XPIOB5        ;RIPRENDE IL
		CP	0BH             ;CALCOLO DELLO
		JR	NC,XPIOB6       ;ERRORE
		DEC     A               ;CALCOLO DELLO
		LD      (ALTERR),A      ;ERRORE
		JR	XPIOB5
XPIOB6:		LD	A,00H
		LD	(ALTERR),A	;PUUU

XPIOB5:
		IN      A,(PB)         ;PPUU
                BIT     5,A
                JR      Z,XPIOB4       ;PPUU
XPIOB3:        
		LD      A,(ENCOD2)     ;PPDD
                CP      02H
                JR      Z,XPIOB1
		LD      A,0D7H          ;CONTROLLO CTC0
		OUT     (70H),A         ;CARICO AMPIEZZA
		LD      A,(AMPIM1)      ;GATE IN IMPULSI
		OUT     (70H),A         ;ENCODER.
		LD      A,(GUADS1)      ;AMPLIFICAZIONE
		LD      B,A             ;S1
		LD      A,(MEMA)        
		RES     5,A
		RES     6,A
		ADD     A,B
		LD      (MEMA),A
		OUT     (PA),A

                LD      A,(MRIC+06H)    ;VEDO SE DEVO  PPDD
                CP      00H             ;CONTROLLARE IL
                JR      Z,XPIOB1        ;DOPPIO SEGNO
                LD      A,0D7H          ;METTO 3 PER-
                OUT     (73H),A         ;CHE NON SENTE
                LD      A,03H           ;LA COMMUT.    AADD
                OUT     (73H),A         ;DEL TRAVERS   PPDD
                JR      XPIOB1          ;PPUU
XPIOB4:          
		IN      A,(10H)         ;LEGGO LA POSI- PPUU
		LD      E,A             ;ZIONE
		IN      A,(20H)
		LD      D,A
		LD      (FASE),DE
                CALL    CENTRA        
XPIOB1:
		LD	A,01H		;ABILITA LE ABBB
		LD	(MCALER),A	;MISURE
		JP      PIOB1
XCTC0:
		LD      A,(ENCOD1)     ;SE NON   EEEE
		CP      00H            ;ABILITATO
		JR      Z,XCTC01       ;SALTA   EEEE
		CP      01H
		JP      Z,XCTC018
		LD      A,(ENCOD2)     ;INCREMENTO
		INC     A              ;A OGNI 255
		LD      (ENCOD2),A     ;IMPULSI
		LD      A,0DFH         ;RICARICO CTC0 EEEE
		OUT     (70H),A
		LD      A,0FFH
		OUT     (70H),A
		JP      XCTC018        ;EEEE EEEE EEEE EEEE
XCTC01:         
		IN      A,(30H)         ;LEGGO IL VALORE
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
		LD      (MPIEN1),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)         ;DI S1
		LD      D,A
		LD      (MPOSI1),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S1
		LD      D,A
		LD      (MASES1),DE
		LD      A,(MEM5)        ;FF55
                CP      01H
                JR      NZ,XCTC020       ;FF55
                CALL    XPOFAS		;FF58	
		JP      XCTC011          ;FF57
XCTC020:                                 ;FF55
		OUT     (52H),A         
		LD      A,(MEMC)        ;SE SONO IN MA-
                AND     14H             ;BIT     2,A  ;NUALE SALTO FFLL
		JR      Z,XCTC02
                IN      A,(PB)          ;SE MANCA IL
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,XCTC02         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
                CALL    NOPRI           ;FFFF
XCTC02:      
		IN      A,(PB)
		BIT     3,A
		JR      Z,XCTC04
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOMAT.
		JR      Z,XCTC03         ;SALTA
		CALL    GAINS1          
XCTC03:          
                CALL    RESEPC          ;FFLL
                JP      XCTC019          ;XXXXJP      CTC018

XCTC04:         LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
		LD      A,(MEMC)        
		BIT     5,A
		JR      NZ,XCTC05        
		LD      DE,(MPIEN1)
		LD      (PIENO1),DE
		LD      DE,(MPOSI1)
		LD      (POSIZ1),DE
		LD      DE,(MASES1)
		LD      (FASES1),DE
		JR      XCTC06                   
XCTC05:         LD      DE,(MPIEN1)
		LD      (TPIEN1),DE
		LD      DE,(MPOSI1)
		LD      (TPOSI1),DE
		LD      DE,(MASES1)
		LD      (TASES1),DE     
XCTC06:     
		LD      A,(DIAGON)      ;VEDO SE SOLO
		CP      02H             ;LONGITUDINALE
		JP      Z,XCTC08
		LD      A,(MEMC)        
		BIT     5,A
		JR      NZ,XCTC07        
		LD      A,(MRIC+00H)    
		CP      01H
		JR      Z,XCTC08         
		LD      A,(ALTERN)
		DEC     A
		LD      (ALTERN),A
		CP      00H
		JR      NZ,XCTC08
		LD      A,(MEMC)
		SET     5,A
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,02H
		LD      (ALTERN),A
		JP      XCTC08        
XCTC07: 
		LD      A,(ALTERN)
		DEC     A
		LD      (ALTERN),A
		CP      00H
		JR      NZ,XCTC08
		LD      A,(MEMC)        
		RES     5,A
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,02H
		LD      (ALTERN),A
XCTC08:         
		OUT     (52H),A         ;STABILE DA 0,5 mS
		LD      A,(MEMC)        ;SE SONO IN MA-
                AND     14H             ;BIT     2,A  ;NUALE SALTO FFLL
		JR      Z,XCTC09
		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,XCTC09         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
                CALL    NOPRI           ;FFFF
XCTC09:
		IN      A,(PB)
		BIT     3,A
		JR      Z,XCTC010
                CALL    RESEPC          ;FFLL
		JP      XCTC019          ;XXXXJP      CTC018
XCTC010:       
		LD      A,(MEMA)
		RES     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
XCTC011:        
		LD      HL,(FASE)       ;CARICO IL 
		LD      A,H             ;CONTATORE PER
		OUT     (20H),A         ;LEGGERE POI S1
		LD      A,L
		OUT     (10H),A         
		LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
XCTC012:         
		LD      A,(MRIC+00H)
		CP      00H
		JR      NZ,XCTC018
XCTC019:  
		LD      BC,011DH        ;4mS TEMPO  XXXX 
		LD      IX,IMPVEL       ;PER MISURARE
		LD      A,00H           ;GLI IMPULSI
		LD      (IX+01H),A
		LD      A,057H          ;SETTO CTC0
		OUT     (70H),A         ;SENZA INTERUPT
		LD      A,0FFH          
		OUT     (70H),A         
XCTC013:         
		IN      A,(70H)         ;NEL CASO IL 
		CP      00H             ;DECREMENTO 
		JR      NZ,XCTC014       ;ARRIVI A ZERO
		INC     (IX+01H)        ;LO MEMORIZZO
XCTC014:        
		DEC     BC              
		LD      A,B
		OR      C
		JR      NZ,XCTC013       
		IN      A,(70H)         
		CPL                     ;IMPULSI PROPOR
		LD      (IMPVEL),A      ;ALLA VELOCITA.
		LD      A,(MEMC)        ;SE E'IN MANUALE
		BIT     2,A             ;SALTO
		JR      Z,XCTC017
		LD      IX,TRIP         
		LD      A,(IX)          ;SE TRIP
		CP      00H             ;= ZERO NON
		JR      Z,XCTC017        ;OPERA
XCTC015:
                LD      A,(PROTEZ)      ;SE IN PROTE- TVVV
                CP      01H             ;ZIONE SALTA
                JR      Z,XCTC017        ;TVVV
                LD      HL,(VELMED)     ;CONTROLLO SE
		LD      DE,(VELPRE)     ;TRA LA NUOVA 
		SBC     HL,DE           ;E LA VECCHIA 
		JR      C,XCTC016        ;VELOCITA'C'E' 
		LD      A,L             ;UN DIFFERENZA
		CP      (IX)            ;TRIP IN METRI 
		JP      M,XCTC017        ;IN PIU' CHE
		CALL    ACCEL           ;MENO SE C'E'
		JR      XCTC017          ;BLOCCO CON
XCTC016:    
		CCF                     ;LA SCRITTA  
		LD      HL,(VELPRE)     ;APPROPIATA
		LD      DE,(VELMED)
		SBC     HL,DE
		LD      A,L
		CP      (IX)                         
		JP      M,XCTC017
		CALL    DECEL
XCTC017:         
		LD      DE,(VELMED)
		LD      (VELPRE),DE
XCTC018:
	        LD      A,(MOSCI1)      ;FF57
                CP      01H
                JR      NZ,XCTC021       ;FF57
		LD	A,(MEMRIF)	;ASPETTO UN
		DEC     A		;GIRO PER
		LD	(MEMRIF),A	;CENTRARE
		CP	00H
		JR	NZ,XCTC021
                CALL    CENTRO          ;FF57            
                LD      A,00H           ;FF57
                LD      (MOSCI1),A      ;FF57
		LD	A,01H		;FF58
		LD	(MEM0),A	;FF58
XCTC021:					;FF57
                JP      CTC017

		;CALCOLO RAPPORTO POSIZINE PIENO S1

XMAIN2:         LD      DE,(ERATTU)     ;MEMORIZZO ERRORE
		LD      (ERPREC),DE     ;PRECEDENTE
                LD      A,(MSCORR)      ;WWAASALVO SEGNO
                LD      IX,PIENO1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,XRAPP10        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      DE,(QUOZIE)
		JR      XRAPP11
XRAPP10:       
		CCF
		LD      DE,0000H
XRAPP11:        
		LD      (RAPPO1),DE     ;VERIFICO SE E'
                LD      A,(MEMRIF)      ;STATO TROVATO
		CP      00H             ;IL SEGNO DI
		JR      Z,XRAPP2        ;REGISTRO DURANTE
		LD      DE,(RAPPO1)     ;LA RICERCA AUTO-
		LD      (RAPRIF),DE     ;MATICA PER MEMO-
		LD      DE,(FASES1)     ;RIZZARE I RIFE-
		LD      (FASRIF),DE     ;RIMENTI QUESTI
		LD      HL,MEMRIF       ;VENGONO MEMORIZ-
		DEC     (HL)            ;ZATI DOPO 4 GIRI

		LD      A,(MEMRIF)      ;QUANDO ARRIVO
		CP      00H             ;A ZERO ESEGUO
		JR      NZ,XRAPP2        ;IL CALCOLO
		LD      DE,(FASRIF)     ;DEL RIFTOT
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPRIF)
		ADD     HL,DE
		LD      (RIFTOT),HL

		;CALCOLO DELL'ERRORE IN CENTESIMI ED
		;EVENTUALE CORREZIONE DA ESEGUIRE
		;(FASRIF-FASES1)+(RAPRIF-RAPPO1)= ERRORE
		;(FASRIFx10)+RAPRIF=RIFTOT
		;(FASES1x10)+RAPPO1=POSTOT
		;(RIFTOT-POSTOT):10=ERRORE IN DECIMI

XRAPP2:
                LD      DE,(FASES1)     ;FASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPPO1)
		ADD     HL,DE
		LD      (POSTOT),HL
		EX      DE,HL
		LD      HL,(RIFTOT)     ;FLO1 PUNTO A
		SBC     HL,DE
		JR      C,XERR1
		EX      DE,HL
		LD      HL,(AMPI10)     ;VEDO SE ERRORE  WWWW
		SBC     HL,DE           ;E'> DI AMPI10   WWWW
		EX      DE,HL
		JR      NC,XINDRE        ;FLO1 PUNTO B
		CCF
		LD      HL,(RIFTOT)     ;FLO1 PUNTO C
		LD      DE,(POSTOT)
		SBC     HL,DE
		EX      DE,HL
		LD      HL,0A000H       ;40960
		SBC     HL,DE
		JR      XINNAS
XERR1:          
		CCF
		LD      HL,(POSTOT)     ;FLO1 PUNTO D
		LD      DE,(RIFTOT)
		SBC     HL,DE
		EX      DE,HL
		LD      HL,(AMPI10)     ;FLO1 PUNTO E  WWWW
		SBC     HL,DE
		EX      DE,HL
		JR      NC,XINNAS
		CCF
		LD      HL,0A000H       ;40960
		LD      DE,(POSTOT)     ;FLO1 PUNTO F
		SBC     HL,DE
		LD      BC,(RIFTOT)
		ADD     HL,BC

XINDRE:
                LD      A,(NORINV)      ;CONTROLLO NNII
                BIT     0,A             ;COREZ.
                JR      NZ,XINNAS1      ;NORM/INVER NNII

XINDRE1:	LD	A,(MSCORR_ATT)	;NNDD
		LD	(MSCORR_PREC),A
		LD      A,08H           ;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. RITARDO
		LD	(MSCORR_ATT),A
                JR      XERR2
		
XINNAS:         LD      A,(NORINV)      ;NNII
                BIT     0,A
                JR      NZ,XINDRE1       ;NNII

XINNAS1:	
		LD	A,(MSCORR_ATT)	;NNDD
		LD	(MSCORR_PREC),A
		LD      A,01H           ;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. AVANTI
		LD	(MSCORR_ATT),A

		;(ERR.xCENT.IN DIV.ENC.):100=ERR.IN DECIM
XERR2: 
		LD      (MOLTI),HL      ;HL CONTIENE ERR.
		LD      A,(CENTES)
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      (DIVDEN),DE     ;PRIMA DIVISIONE
		LD      BC,000AH        ;PER DIECI
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      HL,(ERPREC)     ;FACCIO UNA MEDIA
		ADD     HL,DE           ;TRA ERRORE LETTO
		LD      (DIVDEN),HL     ;E IL PRECEDENTE. 
		LD      BC,0002H        
		LD      (DIVSOR),BC      
		CALL    DIVIS
		LD      DE,(QUOZIE)     
		LD      (ERATTU),DE
		LD      A,(SALTO)       ;SE SALTO E'
		CP      00H             ;ZERO CORREGGO
		JR      Z,XERR6          ;SEMPRE
		LD      HL,000AH        ;SOMMO A ERPREC
		LD      BC,(ERPREC)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;ERATTU SE CARRY
		JR      NC,XERR3         ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
		LD      BC,(ERPREC)     ;LATA LA IGNORO.
		LD      (ERATTU),BC
		LD      A,(CONSAL)      ;CONTROLLA CHE NON
		DEC     A               ;CHE NON RIMANGA
		LD      (CONSAL),A      ;IN BLOCCO PER PIU'
		CP      00H             ;DI N GIRI MEMO- 
		JR      Z,XERR5          ;RIZZATI IN SALTO  
		JP      GIR1            ;E POI
XERR5:           
		LD      (ERATTU),DE     ;RICARICA L'ULTIMO
		LD      (ERPREC),DE     ;ERRORE LETTO
		JR      XERR3            
XERR3:       
		LD      A,(SALTO)       ;CARICA I GIRI DI
		LD      (CONSAL),A      ;ATTESA.
XERR6:           
		LD      A,(MKBUSY)      ;VEDO SE TASTIERA
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
                CALL    LMEDIA          ;WWAA
		LD      A,(NODISP)      ;DOPO 16 VOLTE DD11
		CP      10H             ;CHE SALTO DD11
		JR      Z,XERR7          ;SCRIVO DD11
		LD      HL,(BINSET)     ;SE NON C'E'STATA
		LD      DE,(DISPRE)     ;VARIAZIONE 
		SBC     HL,DE           ;D'ERRORE NON
		JR      Z,XERR9         ;AGGIORNO IL DD11
		JR      NC,XERR7        ;DISPLAY
		CCF

XERR7:          LD      A,00H           ;ANNULLO DD11
		LD      (NODISP),A      ;CONTA DD11
		CALL    DISPLL
		LD      A,(SUPCOR)      ;MMMM
		CP      01H
		JR      NZ,XERR8         ;MMMM
		CALL    OVERCO          ;MMMM
XERR9:        
		LD      A,(NODISP)      ;INC LA DD11
		INC     A               ;LA CONTA DD11
		LD      (NODISP),A      ;DD11
XERR8: 
		LD      HL,(BINSET)
		LD      (DISPRE),HL     ;ZZZ
		LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR
		LD      A,(DIAGON)      ;VEDO SE SOLO SSLL
		CP      02H             ;LONGITUDINALE
		JR      Z,XERR10
		CALL    TRAVER
		LD      A,01H
		LD      (TMEM4),A
		CALL    CORTRA
		JR	XERR11		;SSLL
XERR10:
		CALL	DISPLD		;SSLL
XERR11:		
		JP	SOGLIN		;MMXX


		;CALCOLO DELLO SPOSTAMENTO REGISTRO E GATE


XPOSTA:         EXX
                LD      BC,(SHIFT)      ;SHIFT x 10 = A
		LD      (MOLTI),BC
                LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;FLO2 = A
		LD      (DIVDEN),DE     ;A : CENTES = B
		LD      BC,(CENTES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)     ;FLO2 = B
		LD      A,(PIUMEN)
		CP      70H
                JR      Z,XPOMEN
		LD      HL,(RIFTOT)
		ADD     HL,DE           ;RIFTOT + B = C
		EX      DE,HL           ;SE C < 40960 
		LD      HL,0A000H       ;ALLORA C = Z
		SBC     HL,DE           ;SE C > 40960
		EX      DE,HL           ;SI FARA'
                JR      NC,XPOFIN       ;C - 40960 = Z
		CCF
		LD      DE,0A000H
		SBC     HL,DE
                JR      XPOFIN
XPOMEN:         LD      HL,(RIFTOT)     ;RIFTOT - B = C
		SBC     HL,DE           ;SE C = POSITIVO
                JR      NC,XPOFIN       ;C = Z
		CCF                     ;SE C = NEGATIVO
		LD      HL,0A000H       ;SI FARA'
		SBC     HL,DE           ;40960 - B = D
		LD      DE,(RIFTOT)     ;D + RIFTOT = Z
		ADD     HL,DE
XPOFIN:         LD      (RIFTOT),HL     ;FLO2 = Z

		;RIFTOT/10=POSIZIONE ENCODER
		;POSIZIONE ENCODER - 1/2GATE = NUOVA FASE

		LD      (DIVDEN),HL
		LD      BC,000AH
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      DE,(QUOZIE)
                LD      BC,(MEZGA)      ;
		SBC     HL,BC
                JR      C,XISNE1
                JR      XRFAS1
XISNE1:         CCF                     ;SE 1/2GATE > DI
		LD      HL,1000H        ;QUOZIE ALLORA
		SBC     HL,BC           ;4096-1/2GAT = A
		ADD     HL,DE           ;A + QUOZIE=FASE
XRFAS1:         LD      (FASE),HL
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
                EXX
		RET
			
		;CALCOLO PARZIALE TRAVERS PER MC
		
TRAVMC:
		LD      DE,(TASES1)     ;TASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH		
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(TRAPP1)
		LD      H,00H
		ADD     HL,DE
		LD      (TPOST1),HL
		LD      DE,(POSTOT)
		SBC     HL,DE
		JR      NC,XZ1           ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST1)     ;TPOST1<POSTOT
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTOT)     ;A TPOSTO 40960
		SBC     HL,DE           ;E RIPETO SBC.


		;(ERRORE x DECIMILLES.IN DIV.ENC.)-
		;DISTANZA IN CENTIMILLESIMI : 1000 =ERRORE
		;IN CENTESIMI

XZ1:
                LD      (SPELET),HL     ;SPESSORE LETTO
		LD      A,(MRIC+08H)    ;ASPETTO 3 GIRI
		CP      00H             ;DOPO LA FASE
		JR      Z,Z2            ;PER CARICARE
		DEC     A               ;LO SPESSORE
		LD      (MRIC+08H),A    
		CP      01H
		JR      NZ,Z2
		LD      (SPERIF),HL
		LD      A,00H
		LD      (MRIC+08H),A    
Z2:             LD      DE,(SPERIF)
		LD      (SPELET),HL     ;HL=SPESSORE SEGNO
		SBC     HL,DE
		JR      NC,Z4
		LD	A,08		;LD	A,01H OOTT		       
		LD      (TMSCOR),A      
		CCF
		EX      DE,HL
		LD      DE,(SPELET)
		SBC     HL,DE
		JR      Z5              

Z4:             LD	A,01H		;LD	A,08H	OOTT	            
		LD      (TMSCOR),A      
Z5:             LD      (TERATT),HL
		LD      A,(SALTO)       ;SE SALTO E'
		CP      00H             ;ZERO CORREGGO
		JR      Z,TERR4         ;SEMPRE
		EX      DE,HL
		LD      HL,000AH        ;SOMMO A TERPRE 
		LD      BC,(TERPRE)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;TERATT SE CARRY
		JR      NC,TERR2        ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
		LD      BC,(TERPRE)     ;LATA LA IGNORO.
		LD      (TERATT),BC

                LD      A,(CONSAT)      ;CONTROLLA CHE NON EEAA
		DEC     A               ;CHE NON RIMANGA
                LD      (CONSAT),A      ;IN BLOCCO PER PIU'EEAA

                CP      00H             ;DI N GIRI MEMO- 
		JR      Z,TERR3         ;RIZZATI IN SALTO
TERR3:          LD      (TERATT),DE     ;RICARICA L'ULTIMO
		LD      (TERPRE),DE     ;ERRORE LETTO
		JR      TERR2            
TERR2:          LD      A,(SALTO)       ;CARICA I GIRI DI

                LD      (CONSAT),A      ;ATTESA.    EEAA

TERR4:          LD      A,(MKBUSY)      ;VEDO SE TASTIERA
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
		CALL    TMEDIA
		CALL	DISPLT		;MMXX
		CALL	DISPLD		;MMXX
TERR7:          
		LD      A,(NODISP)      ;INC LA DD11
		INC     A               ;LA CONTA DD11
		LD      (NODISP),A      ;DD11
TERR6:          
		LD      HL,(BINSET)
		LD      (TDISPR),HL     ;ZZZ
		LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR
		
		RET



		;SPOATMENTO REGISTRO TRAVERS
		

MCAZZTR:        LD      A,(TMSCOR)      ;VEDO SE IN AVANTI
		CP      01H             ;O IN RITARDO E
		JR      Z,MCZTR2        ;CHIAMO LA ROUTINE
		LD      A,(DIAGON)      ;SPOSTA PER CEN-
		CP      00H             ;TRARLO NEL GATE
		JR      Z,MCZTR1
		LD      A,78H
		LD      (TIUMEN),A
		JR      MCSPOST
MCZTR1:         LD      A,3FH           
		LD      (TIUMEN),A      
		JR      MCSPOST
MCZTR2:        
		LD      A,(DIAGON)      
		CP      00H             
		JR      Z,MCZTR3
		LD      A,3FH
		LD      (TIUMEN),A
		JR      MCSPOST
MCZTR3:         LD      A,78H
		LD      (TIUMEN),A
MCSPOST:       
		LD      HL,(TSHIFT)     
		LD      A,(TIUMEN)               
		CP	78H		;CP      3FH OOTT
		JR      Z,MCSOTTRA
		LD      HL,(SPERIF)
		LD      DE,(TSHIFT)
		ADD     HL,DE
		LD      (SPERIF),HL
		JR      MCTPOFIN
MCSOTTRA:       LD      HL,(SPERIF)
		LD      DE,(TSHIFT)
		SBC     HL,DE
		LD      (SPERIF),HL
MCTPOFIN:
                LD      A,00H
                LD      (MAZTRA),A        ; GGAA
                RET

                ;GESTIONE DELLA CORREZIONE SUPERIORE SSCC
                ;A MEZZO GATE  


OVERCO:         LD      HL,(ERATTU)     ;SE ERRORE > 1mm  
                LD      DE,0064H        ;SALTO SE NO  
                SBC     HL,DE           ;RICARICO LA
                JR      NC,OVERC3       ;SOVRA CORREZ-
                CCF                     ;ZIONE.
                LD      A,(SHIFT3)      ;METTO IN SHIFT
                DEC     A               ;AMPI40 FINO
                LD      (SHIFT3),A      ;A CHE SHIFT1
                CP      00H             ;ARRIVI A ZERO
                JR      Z,OVERC1
                LD      DE,(AMPI40)     
                LD      (SHIFT),DE      
	        JR      OVERC2
OVERC1:         
		LD      DE,(SHIFT4)     ;ALLA FINE 
                LD      (SHIFT),DE      ;CARICO IL
                LD      A,00H           ;RESTO IN
                LD      (SUPCOR),A      ;SHIFT
OVERC2:         CALL    XPOSTA
OVERC3:        
                RET


                ;FASATURA CON OSCILLOSCOPIO ESTERNO IN M/C

XPOFAS:                         
                IN      A,(PA)          ;
		BIT     4,A
                JP      NZ,XPOEN1       ;
                CALL    SERITA          ;
                LD      DE,(INCEXT)
		LD      A,00H
		CP      E
                JR      NZ,XEXTE1
                LD      E,02H
                LD      (INCEXT),DE
                JR      XEXTE2
XEXTE1:         LD      A,05H
		ADD     A,E
		LD      E,A
                LD      (INCEXT),DE

XEXTE2:
		OUT	(52H),A		;FF58
                LD      A,(HL)          ;VERIFICO SE
                AND     1FH             ;PIGIATO
                CP      08H             ;AVANTI/RITARDO
                JP      Z,SXSPOX        ;LLLL
		CP      09H
                JR      Z,DXSPOX
DXSPOX:                
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,XPOF01
                LD      (FASE),HL
                JR      XPOF02
XPOF01:         CCF
                LD      HL,0FFFH
XPOF02:         LD      (FASE),HL
                JR      XPOEND
SXSPOX:
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                ADD     HL,DE
                LD      A,H
                CP      10H
                JR      NZ,XPOF07
                LD      HL,0000H
XPOF07:         LD      (FASE),HL
                JR      XPOEND

XPOEN1:         LD      DE,0000H
                LD      (INCEXT),DE
XPOEND:                                 ;++++++++++++
                LD      DE,(FASE)       ;ATTENZIONE
                LD      (FASRIF),DE     ;QUESTA PARTE 
                LD      (MOLTI),DE      ;NON TIENE
                LD      A,0AH           ;CONTO DI 
                LD      (MOLPL),A       ;RAPRIF PER
                CALL    MOLT            ;CUI POTRBBE  
                LD      DE,(PROD)       ;INTRODURRE
                LD      (RIFTOT),DE     ;PICCOLI
                                        ;ERRORI
                RET                     ;+++++++++++

                ;INIZIALIZZAZIONE LCD E SCRITTA  RELES
INIZIO:
            	LD	A,(DOG)		;IN CASO DI SSDD
		CP	01H		;WATCH DOG SALTA
		JR	Z,CANE

		CALL    INISI           
                LD      HL,RELES1
                CALL    TX
                CALL    BASSA
                LD      HL,RELES2
                CALL    TX              
                CALL    RITDIS
CANE:
                LD      HL,IIRIGA       
                LD      DE,SECFUN
                LD      BC,0014H        
                LDIR
                LD      A,(MM_MC)       ;MMCC
                CP      01H
                JR      Z,COLMC
		CP	02H		;MMXX
		JR	Z,COLMC1
                LD      A,(LINGUA)
                CP      00H
                JR      Z,COLM
                CP      01H
                JR      Z,COLI
                CP      02H
                JR      Z,COLF
                CP      03H
                JR      Z,COLGB
                CP      04H
                JR      Z,COLE
                CP      05H
                JR      Z,COLD          ;DDDD

COLM:           LD      HL,COLORE
                JR      COLTX
COLI:           LD      HL,COLORE+14H
                JR      COLTX
COLF:           LD      HL,COLORE+28H
                JR      COLTX
COLGB:          LD      HL,COLORE+3CH
                JR      COLTX
COLE:           LD      HL,COLORE+50H
                JR      COLTX
COLD:           LD      HL,COLORE+64H
                JR      COLTX           ;MMCC
COLMC:          LD      HL,MACI
		JR	COLTX
COLMC1:		LD	HL,MACODE
COLTX:          LD      DE,NUMCOL
                LD      BC,0014H        
                LDIR
		RET

RELES1:
                ;  ZELO ELETTRONICA 
        DEFB    32, 32, 90, 69, 76, 79, 32, 69, 76, 69
        DEFB    84, 84, 82, 79, 78, 73, 67, 65, 32, 32

RELES2:
                ;OFFSE/ROTO LRXA_03.3    
        DEFB   79, 70, 70, 83, 69, 47, 82, 79, 84, 79  
        DEFB   32, 76, 82, 88, 65, 95, 48, 51, 46, 51  


PROGR1:
                ;PROGRAMMA WRXA_03.3 ;OO11  LLLL AAOO  
        DEFB    80, 82, 79, 71, 82, 65, 77, 77, 65, 32
        DEFB    87, 82, 88, 65, 95, 48, 51, 46, 51, 32


PROGR2:
                ;    DEL 18/07/07            TTVV
	DEFB    32, 32, 32, 32, 68, 69, 76, 32, 49, 56
        DEFB    47, 48, 55, 47, 48, 55, 32, 32, 32, 32

		END
		
 
