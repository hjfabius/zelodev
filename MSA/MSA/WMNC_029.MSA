

                         ;#################################
                         ;# CONTROLLO DI REGISTRO M/C     #
                         ;# LONGITUDINALE VERSIONE PER    #
                         ;# NORD MECCANICA CON CKTG0 A    #
                         ;# 1024 IMPULSI                  #
                         ;#################################
                         


                   
;10/05/05 MODIFICATO LE RUTINE DI MEDIA DEGLI ERRORI E DELLA VELOCITA
;INSERITO IL FILTRO PER LA VISUALIZZAZIONE DELL'ERRORE SUL DISPLAY
;16/5/05 MODIFICATA SUB RUTINE RITVEL WWAA
;07/06/05 MODIFICHE SULLA MEDIA VELOCITA WWNN
;22/07/05 ELIMINAZIONE ERRORE FILTRATO PER DISPLAY DIVENTA XXXX_021FFFE
;16/09/05 INSERITO ALLARME QUANDO NOPRINT BBLL
;08/10/05 SPOSTATO DI POSIZIONE LA SCRITTA ESEGUITO ERIMESSO IN FUNZ4
          ;L'ISTRUZIONE  LD   (MRIC+06H),A  DIVENTA _023
;14/11/05 SPOSTAMENTO IN RIGA BASSA DI BASSA VELOCITA E MANCA SEGNO TTVV/TVVV
          ;E CONSEGUENTE VISUALIZZAZIONE VELOCITA,ELIMINAZIONE,SCRITTURA
          ;ACCELLERA, DECELLERA QUANDO A BASSA VELOCITA  DIVENTA_024
;26/04/06 MODIFICHE SU VELOCITA' E AZZERAMENTO ERRORE IN NOPRINT 
          ;SE ERRORE SUPERA DEL 10% IL VALORE DI MEZZO GATE SI AZZERA
          ;L'ERRORE DIVENTA _025 AUMETATO VALORE DI BIANCO A 2FH VVVVBB 
;28/04/06 ;INSERITO CALCOLO BIANCO ANTERIORE E POSTERIORE  E CENTRATURA 	
          ;CON GRANDI GATE ELIMINATO A CTC020 IMPOSTA GUADAGNO MINIMO BBBB 
;04/04/06 ;IN CENTRA IL VALORE DI MEZGA E'PRESO SU 16 BIT 
	  ;TOLTO AZZERAMENTO IN NOPRI SOLO PER PROGRAMMA NORD MECCANICA
;18/05/06;ELIMINATO AZZERRAMENTO ERRORE DEL 26/04/06
;26/05/06 SCRITTURA ERRORE DATO ERRATO F1 E F3 EEOO EEUU
;03/06/06 INSERITO CENTRATURA GATE DOPO FASATURA CON OSCILLOSCOPIO SENZA
	  ;PASSARE DA FUNZ ZERO FF57
;22/07/06  ELIMINATO MSHIFT CHE FACEVA RIMANERE SUL DISPLAY PER QUALCHE
	  ;SECONDO IL VALORE DI SHIFT IMPOSTATO SSHH
;23/07/06 ELIMINAZIONE MTASTI IN PIOA E IN ALTRI POSTI MMTT
;23/07/06 MODIFICATO POSIZIONE MCALER IN MODO CHE FACCIA I CALCOLI 
	 ;UN VOLTA AL GIRO
;05/10/06 INSERITO COME DEFAULT ANCHE OSGAIN FATTO MODIFICHE SU ALTERR PUUU
;02/01/07 MODIFICATO INIZIALIZZAZIONE
;07/01/07 INSERIMENTO NUOVO SISTEMA CONTROLLO SEGNO DOPPIO,SPECIE DI WATCH DOG
	 ;NELLA RICERCA UATOMATICA,MODIFICATO CALCOLO BIANCO,UNOMIL
	 ;TOLTO MRIC+04H,06H,0AH,CILINDRO MAX=2047 DIVENTA  WMNC_026 SSDD
;08/01/07;AVVISO SEGNO DOPPIO VIENE VISULIZZATO SOLO ALLA RICRCA AUTOMATICA 
	 ;RIISERITO MRIC+04H AADD
;21/04/07 MIGLIORATO OSCILLOSCOPIO INTERNO CON AGGIUNTA DI MILL43 DIVENTA WMNC27
;22/04/07 INSERITO AZZTOT DOPO FUNZ4 (TAJ200)
;01/06/07 CAMBIATO TEMPI SCANSIONE OSCILLOSCOPIO ESTERNO
	  ;INSERITO IN +/- CARTA IN OSCILLOSCOPIO INTERNO
;07/07/07 MODIFICHE NUOVO DERIVATIVO DIVENTA LMNC_028 NNDD
;01/08/07 INSERITO FASATURA MANUALE EE MESSO AZZTOT ALL'USCITA OSCILLOSCOPIO
	;DIVENTA LMNC029 FFMM	

		; WMNC_029 + YMNC_015 = LMNC_029

;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
; ATTENZIONE NON E' STATO PROVATO
;%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



                NAME    WMNC_029            
                ASEG
                PUBLIC  MEMC,PC,MOSCIL,FASE,TRIGFA,PB,MEMB,MPUNTO
                PUBLIC  IMPMIL,FORMAR,SCRIOS,GATOSC,SPOINC,MEM5
                PUBLIC  MKBUSY,PA,SERITA,TX,INISI,BASSA
                PUBLIC  RSZERO,ADDRCG,SERPAR,RSUNO,MERITA
                PUBLIC  MEZGA,FASES1,MOLTI,MOLPL,MOLT,RIFTOT,PROD
                PUBLIC  GUADS1,MEMA,OSGAIN,GUAOSC,POSGAT,SPACOD
                PUBLIC  INFLAS,ENCOD1,ENCOD2,ENCOD3,ENCOD4  ;FFTT
                PUBLIC  TCICAT,CICATT,PROGR1,PROGR2,MEM6A  ;FFTT
                PUBLIC  BIN7,BINSET,CICL75,PROTEZ,RESEPC
                


                PUBLIC  TRIP,GUADA,CICLO,DERIVA,ZONA,INSER
                PUBLIC  SALTO,ZONT,LINGUA
                PUBLIC  DIVIS,DIVSOR,QUOZIE 
                PUBLIC  DIVDEN,XUNZ,XTASTO,MEM1,MEM2,MEM3
                

                EXTERN  YMNC_015,CENOSC,GENCAR,FINOSC,CAG,FUNDIS
                EXTERN  FORCIL,SOALLR,AZZER1,AZZER2,POSSEG,COLORE
                EXTERN  IIRIGA,AVANTI,RITARD,OPERAT,TRASMI,FASEAU
                EXTERN  ESEGUI,ERRORE,NOSTAM,VADASI,ACELER,DECELE
                EXTERN  PARAME,TRIDIS,GUADAG,CICLIC,DISDER,INSERZ
                EXTERN  DSALTO,ZONAMO,TRAGUA,TRACIC,TRAZON,DISLIN
                EXTERN  DIADIS,DIADI1,DIADI2,VELONG,VETRAV,DITEST
                EXTERN  TTESTA,TENCOD,LAVANO,LAVA,SECUND,NETA
                EXTERN  SETTA,TABLE,SSEG,SOLDIS,SOLBAS,GATEW
                EXTERN  NORDIS,INTIR,GUATIR,DOPPIO,TESREL,ATIDIS
                EXTERN  FLXDIS,FNOVE,MGUADA,TENCAR,P39_52
                EXTERN  FLASH,TEST,ENC2,ENC6,RITDIS,MODPA,FUNDI5   
		EXTERN	ERR_F1,ERR_F3,OCIO,FUNDM5





PA:     EQU     00H      ;DATI PORTA A
PB:     EQU     01H      ;DATI PORTA B
PC:     EQU     63H      ;DATI PORTA C
TABCON: EQU     0C000H   ;USATA IN CONVERSIONE BCD BINARIO
DIVDEN: EQU     0C014H   ;MEM. DEL DIVIDENDO
DIVSOR: EQU     0C016H   ;MEM. DEL DIVISORE
QUOZIE: EQU     0C018H   ;MEM. RISULTATO DIVISIONE
MOLTI:  EQU     0C01AH   ;MEMORIA DEL MOLTIPLICATORE
MOLPL:  EQU     0C01CH   ;MEMORIA DEL MOLTIPLICANDO
PROD:   EQU     0C01EH   ;MEMORIA DEL PRODOTTO
MOLT24: EQU     0C020H   ;MOLTIPLICATORE  MOLTIPLICA 24 BIT
MOLP24: EQU     0C022H   ;MOLTIPLICANDO MOLTIPLICA 24 BIT
PROD24: EQU     0C024H   ;C026H PRODOTTO MOLTIPLICA 24 BIT 
QU4096: EQU     0C028H   ;QUOZIENTE DIVISIONE PER 4096
QU1000: EQU     0C02AH   ;QUOZIENTE DIVISIONE PER 1000
MDIVIS: EQU     0C02CH   ;MEM. USATA IN DIVISIONE 1000

RESTO:  EQU     0C02EH   ;RESTO DELLA DIVISIONE A 16 BIT  

ADDEN0: EQU     0C030H   ;ADDENDO BASSO SOMMA A 32 BIT
ADDEN2: EQU     0C032H   ;ADDENDO ALTO SOMMA A 32 BIT
AUGEN0: EQU     0C034H   ;AUGENDO BASSO SOMMA A 32 BIT
AUGEN2: EQU     0C036H   ;AUGENDO ALTO SOMMA A 32 BIT

NODISP: EQU     0C038H   ;CONTA NON BLOCCO DISLAY DD11   AAVV

CONSAL: EQU     0C03AH   ;CONTEG. SALTI DI NON COR.LONG. EEAA
CONSAT: EQU     0C03CH   ;CONTEG. SALTI DI NON COR.TRAV. EEAA

VELBCD: EQU     0C040H   ;0C042H MEM. VELOCITA BCD
VELMEM: EQU     0C044H   ;USATA NELLA CONVERSIONE VELOCITA
VMEDIA: EQU     0C046H   ;USATA IN CALCOLO VELOCITA'MEDIA 
VELPRE: EQU     0C048H   ;MEM. DELLA VELOCITA' PRECEDENTE
IMPVEL: EQU     0C04AH   ;IMPULSI ENCODER IN 4 mS 
ISTVEL: EQU     0C04CH   ;VELOCITA' ISTANTANEA

VELMED: EQU     0C04EH   ;MEM.MEDIA DELLA VELOCITA' AAVV

MVEL00: EQU     0C050H   ;DA 0C050H A 0C06FH USATA IN WWAA

DECORR: EQU     0C080H   ;MEM.VALORE DI CORREZ.A DECR.LONGITUD.     WWAA
MDECOR: EQU     0C082H   ;MEM.EXTRA VALORE DI CORREZ. LONG. 
CORRE:  EQU     0C084H   ;MEM.VALORE DI CORREZ.MOTORE

ADDRCG: EQU     0C08AH   ;MEM.ADDRES GENERAZIONE CARATTERI 
BINSET: EQU     0C200H   ;MEM.TRASM.DISPLAY 4200H-4210H
BINSE1: EQU     0C220H   ;MEM.TRASM.DISPLAY 4220H-422FH
BINSE2: EQU     0C230H   ;MEM.TRASM.DISPLAY 4230H-423FH        

SUPCOR: EQU     0C250H   ;AVVISO SPOSTAMENTO > DI 1/2 GATE  
SHIFT3: EQU     0C252H   ;QUANTE VOLTE AMPI40 STA IN SHIFT  
SHIFT4: EQU     0C254H   ;RESTO DELLA DIVISIONE SHIFT AMPIMP 

MDATE1:	EQU	0C270H	;MEM. F1 ERRATO EEOO 
MDATE2:	EQU	0C272H	;MEM. F3 ERRATO EEOO                

MAGGIU: EQU     0C2E0H   ;MEM.USATA IN AGGIUST.DECIM.  
MAGGI1: EQU     0C2E2H   ;USATA IN AGGIUSTAMENTO AMPGATE OSCIL 

SPOINC: EQU     0C2E6H   ;MEM.INCREMENTO DELLO SPOSTAMENTO OSCIL. 

SIMCOL: EQU     0C300H   ;SIMBOLO PER DISPLAY
SIMCOT: EQU     0C304H   ;SIMBOLO PER DISPLAY
ALTERN: EQU     0C308H   ;CONTEGGIO ALTERNANZA
MAZTRA: EQU     0C30AH   ;AVVISO AZZERAMENTO TRAVERS
ENCOD1: EQU     0C310H   ;USATA IN TEST ENCODER
ENCOD2: EQU     0C312H   ;USATA IN TEST ENCODER
ENCOD3: EQU     0C314H   ;CONTEGGIO TENTATIVI TEST XXTT
ENCOD4: EQU     0C316H   ;CONTEGGIO IMPULSI FINALE  XXTT
MPIEN1: EQU     0C31AH   ;MEM TEMPORANEA PIENO 1 LONG
MPOSI1: EQU     0C31CH   ;MEM TEMPORANEA POSIZ.1 LONG
MASES1: EQU     0C31EH   ;MEM TEMPORANEA FASE 1 LONG
MPIEN2: EQU     0C326H   ;MEM TEMPORANEA PIENO 2 LONG
MPOSI2: EQU     0C328H   ;MEM TEMPORANEA POSIZ.2 LONG
MASES2: EQU     0C32AH   ;MEM TEMPORANEA FASE 2 LONG
TPIEN2: EQU     0C32CH   ;MEM TEMPORANEA PIENO 2 TRAV
TPOSI2: EQU     0C32EH   ;MEM TEMPORANEA POSIZ.2 LONG
TASES2: EQU     0C330H   ;MEM TEMPORANEA FASE 2 TRAV
TMEM4:  EQU     0C332H   ;ATTIVAZZIONE CORREZ.TITRO
TMEM5:  EQU     0C334H   ;USATA IN CORREZ.TRAVER
TMEM6:  EQU     0C336H   ;SENSO CORREZZIONE TIRO
CONALL: EQU     0C338H   ;CONTEGGIO AVVISI ALLARME CIRC.
CONALT: EQU     0C33AH   ;CONTEGGIO AVVISI ALLARME TRAV.
MEM0:   EQU     0C400H   ;MEMORIA DELLA FUNZIONE 0
MEM1:   EQU     0C402H   ;MEMORIA DELLA FUNZIONE 1
MEM2:   EQU     0C404H   ;MEMORIA DELLA FUNZIONE 2
MEM3:   EQU     0C406H   ;MEMORIA DELLA FUNZIONE 3
MEM5:   EQU     0C408H   ;MEMORIA DELLA FUNZIONE 5 
MEM6:   EQU     0C40AH   ;MEMORIA DELLA FUNZIONE 6
MEM6A:  EQU     0C40CH   ;MEM. USATA NELLA FUNZIONE 6
MEM7:   EQU     0C40EH   ;MEMORIA DELLA FUNZIONE 7
MEMW:   EQU     0C410H   ;USATA IN CALCOLO CORREZ.MOTORE
MEMID:  EQU     0C412H   ;MEM.INIZIALIZZIONE DISPLAY
MEMTF:  EQU     0C414H   ;MEM. TASTO F GIA' PIGIATO
PROTEZ: EQU     0C416H   ;AVVISO PROTEZIONE
MDATER: EQU     0C418H   ;MEM.INSERIMENTO DATO ERRATO
MCALER: EQU     0C41AH   ;SEGNALA AL MAIN DI CALCOLARE
MSCORR: EQU     0C41CH   ;MEM.INDICA IL SENSO DELLA CORR.
ALTDIV: EQU     0C41EH   ;ALTERNA I VALORI NELLA DIVISIONE
CADDE0: EQU     0C420H   ;ADDENDO BASSO SOMMA A 32 BIT
CADDE2: EQU     0C422H   ;ADDENDO ALTO SOMMA A 32BIT
CAUGE0: EQU     0C424H   ;AUGENDO BASSO SOMMA A 32 BIT
CAUGE2: EQU     0C426H   ;AUGENDO ALTO SOMMA A 32 BIT
CSOMM0: EQU     0C428H   ;SOMMA BASSA A 32 BIT
CSOMM2: EQU     0C42AH   ;SOMMA ALTA A 32 BIT
MREST0: EQU     0C42CH   ;MEM RESTO BASSA SOTT32
MREST2: EQU     0C42EH   ;MEM RESTO ALTA SOTT32

INCEXT: EQU     0C438H   ;AUMENTA VELOCITA SCANSIONE IN FUNZ5 FF55
MOSCI1: EQU	0C43AH	 ;USATA PER FASE CON OSCILLOSCOPIO ESTERNO FF57

MKBUSY: EQU     0C460H   ;SEGNALA L'USO DELLA TASTIERA
MDBUSY: EQU     0C462H   ;DISPLAY CON ERRORE DI REGISTRO
MATTES: EQU     0C464H   ;USATA IN DECREM.CILCI ATTESA

ALTERR: EQU     0C468H   ;ALT CALCOLO ERR.DOPO USO TASTIER 
ZEROSE: EQU     0C46AH   ;SEGNO IN ZERO ENCODER         
ALTGUA: EQU     0C46CH   ;DOPO N GIRI FISSA IL GUADAGNO 


MRIC:   EQU     0C470H   ;GRUPPO MEM IN RICERCA AUTOMATICA
MDO032: EQU     0C480H   ;MOLTIPLICANDO BASSO A 32 BIT 
MDO232: EQU     0C482H   ;MOLTIPLICANDO ALTO A 32 BIT 
MRE032: EQU     0C484H   ;MOLTIPLICATORE BASSO 32 BIT 
MRE232: EQU     0C486H   ;MOLTIPLICATORE ALTO A 32 BIT
PTO032: EQU     0C488H   ;PRODOTTO BASSO A 32 BIT 
PTO232: EQU     0C48AH   ;PRODOTTO ALTO  A 32 BIT
EDEND0: EQU     0C48CH   ;DIVIDENDO BASSO DIVISIONE 32BIT
EDEND2: EQU     0C48EH   ;DIVIDENDO ALTO DIVISIONEO 32BIT
QUOZ32: EQU     0C490H   ;QUOZ DIVISIONE 32BIT DIVISO 4096
MINUE0: EQU     0C492H   ;MINUENDO BASSO SOTT. A 32 BIT
MINUE2: EQU     0C494H   ;MINUENDO ALTO SOTT. A 32 BIT
SUBTR0: EQU     0C496H   ;SOTTRAENDO BASSO SOTT. A 32 BIT
SUBTR2: EQU     0C498H   ;SOTTRAENDO ALTO SOTT. A 32 BIT                     
RESTO0: EQU     0C49AH   ;RESTO BASSO SOTT. A 32 BIT
RESTO2: EQU     0C49CH   ;RESTO ALTO SOTT. A 32 BIT
MIXUE0: EQU     0C49EH   ;MINUENDO ALTERNATIVO BASSO
MIXUE2: EQU     0C4A0H   ;MINUENDO ALTERNATIVO ALTO
SUXTR0: EQU     0C4A2H   ;SOTTRAENDO ALTERNATIVO BASSO
SUXTR2: EQU     0C4A4H   ;SOTTRAENDO ALTERNATIVO ALTO
TMSCOR: EQU     0C4D4H   ;INDICA SENSO DI CORREZ. DISPLAY
TINUE0: EQU     0C4DCH   ;MINUENDO BASSO SOTT. A 32 BIT
TINUE2: EQU     0C4DEH   ;MINUENDO ALTO SOTT. A 32 BIT
TUBTR0: EQU     0C4E0H   ;SOTTRAENDO BASSO SOTT. A 32 BIT
TUBTR2: EQU     0C4E2H   ;SOTTRAENDO ALTO SOTT. A 32 BIT                     
TREST0: EQU     0C4E4H   ;RESTO BASSO SOTT. A 32 BIT
TREST2: EQU     0C4E6H   ;RESTO ALTO SOTT. A 32 BIT
TIXUE0: EQU     0C4E8H   ;MINUENDO ALTERNATIVO BASSO
TIXUE2: EQU     0C4EAH   ;MINUENDO ALTERNATIVO ALTO
TUXTR0: EQU     0C4ECH   ;SOTTRAENDO ALTERNATIVO BASSO
TUXTR2: EQU     0C4EEH   ;SOTTRAENDO ALTERNATIVO ALTO
CINUE0: EQU     0C4F0H   ;MINUENDO BASSO CSOTT32
CINUE2: EQU     0C4F2H   ;MINUENDO ALTO CSOTT32
CUBTR0: EQU     0C4F4H   ;SOTTRAENDO BASSO CSOTT32
CUBTR2: EQU     0C4F6H   ;SOTTRAENDO ALTO CSOTT32                     
CESTO0: EQU     0C4F8H   ;RESTO BASSO CSOTT32
CESTO2: EQU     0C4FAH   ;RESTO BASSO CSOTT32
CODIS0: EQU     0C4FCH   ;DIST.BASSA TRAVER COMPENSATA
CODIS2: EQU     0C4FEH   ;DIST.ALTA TRAVER COMPENSATA
POTAVA: EQU     0C500H   ;MEM.A DECR.MOTOPOT ORARIO   
POTRIT: EQU     0C502H   ;MEM.A DECR.MOTOPOT ANTIORARIO
SECFUN: EQU     0C600H   ;SECONDA RIGA FUNZ LCD
SECERR: EQU     0C620H   ;SECONDA RIGA ERRORE
NUMCOL: EQU     0C640H   ;RIGA NUMERO COLORE

SCRIOS: EQU     0C660H   ;0C6AH SCRITTURA OSCILLOSCOPIO 
TRIGFA: EQU     0C700H   ;MEM.FASE DI TRIGGER OSCILLO. 

MEMA:   EQU     0C800H   ;MEMORIA DELLA PORTA A  
MEMB:   EQU     0C802H   ;MEMORIA DELLA PORTA B  

FLASH2: EQU     0C806H   ;USATA IN CONTEGGIO FLASH TTTT PPNN

MEMC1:  EQU     0C808H   ;MEM PORTA C IN FLASH   PPPP

MERITA: EQU     0C80AH   ;USATA PER FINOSC IN RITDIS FFXX

MAVA00: EQU     0C900H   ;DA 0C900H A 0C95FH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE AVANTI
MRIT00: EQU     0C960H   ;DA 0C960H A 0C9BFH  SONO 96 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE RITARDO
DAVA00: EQU     0C9C0H   ;DA 0C9C0H A 0C9DFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE AVANTI DISPLAY
DRIT00: EQU     0C9E0H   ;DA 0C9E0H A 0C9FFH  SONO 16 LOCAZIONI WWAA
                         ;USATE IN CALCOLO MEDIA ERRORE RITARDO DISPLAY
ERATTU: EQU     0CA00H   ;ERRORE ATTUALE   ;LLTT FFXX   MMDD  WWAA
ERPREC: EQU     0CA02H   ;ERRORE PRECEDENTE   LLTT FFXX      WWAA
ERMEDI: EQU     0CA04H   ;MEMORIA ERRORE MEDIO LONG LLTT FFXX    WWAA
SOMLO1: EQU     0CA18H   ;PRIMA SOMMA PER MEDIA LONG GGAA   WWAA
SOMLO2: EQU     0CA1AH   ;SECONDA SOMMA PER MEDIA LONG GGAA WWAA
SOMDL1: EQU     0CA1CH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.
SOMDL2: EQU     0CA1EH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.

PRIMOB: EQU     0CD00H   ;VALORE DA DARE AL PRIMO REG B IN MEDIALOMG   VVVV
SECONB: EQU     0CD02H   ;VALORE DA DARE AL SECONDO REG B IN MEDIALOMG VVVV
VALORX: EQU     0CD04H   ;VALORE DA DARE AL REG IX IN MEDIALOMG        VVVV

CORRATT:EQU	0CD10H   ;CONTIENE IL VALORE CON SEGNO DELLA CORREZIONE IN BASE ALL'ERRORE (4BYTE)NNDD

MSCORR_ATT:EQU 	0CD34H   ;SENSO DELL'ERRORE ATTUALE NNDD
MSCORR_PREC:EQU 0CD36H   ;SENSO DELL'ERRORE PRECEDENTE NNDD


MEMC:   EQU     0D000H   ;MEMORIA DELLA PORTA C

CILIN:  EQU     0D004H   ;MEM. SVILUPPO CILINDRO
ALLAR:  EQU     0D006H   ;MEM. VALORE ALLARME IN CENTESIMI
COSVEL: EQU     0D008H   ;COSTANTE USATA IN VELOCITA'
CENTES: EQU     0D00AH   ;CENTESIMI IN UN IMP.DI ENCODER
MILLES: EQU     0D00CH   ;MILLESIMI IN UN IMP.DI ENCODER
AMPI10: EQU     0D00EH   ;AMPIMP x 40 USATA CON CKTG0 1024 
FASE:   EQU     0D010H   ;MEM. INIZIO GATE DELLA FASE S1
FASES1: EQU     0D012H   ;MEMORIA DELLA FASE DI S1
FASRIF: EQU     0D014H   ;MEM.FASE DI RIFERIMENTO DI S1
RAPPO1: EQU     0D016H   ;MEM. RAPPORTO S1
RAPRIF: EQU     0D018H   ;RAPPORTO DI RIFERIMMENTO
RIFTOT: EQU     0D01AH   ;(FASRIFx10)+RAPRIF=RIFTOT
POSTOT: EQU     0D01CH   ;(FASES1x10)+RAPRIF=RIFTOT
PIENO1: EQU     0D01EH   ;MEM. VALORE DEL PIENO S1
POSIZ1: EQU     0D020H   ;MEM. VALORE DELLA POSIZIONE S1
MEMRIF: EQU     0D022H   ;USATA PER MEMORIZ. I RIFERIMENTI
TASES1: EQU     0D024H   ;MEM TEMPORANEA FASE 1 TRAV
TRAPP1: EQU     0D026H   ;MEM.RAPPORTO S1 TRAVERS
TPOST1: EQU     0D028H   ;POSIZIONE TOTALE S1 TRAVERS
TPIEN1: EQU     0D02AH   ;MEM TEMPORANEA PIENO 1 TRAV
TPOSI1: EQU     0D02CH   ;MEM TEMPORANEA POSIZ.1 TRAV
SPELET: EQU     0D02EH   ;SPESSORE LETTO
SPERIF: EQU     0D030H   ;SPESSORE DI RIFERIMENTO
UNOMIL: EQU     0D032H   ;1mm IN IMPULSI ENCODER
AMPIMP: EQU     0D034H   ;AMPIEZZA GATE IN IMPULSI ENCODER
MEZGA:  EQU     0D036H   ;MEZGA PER 4 MEZGA=AMPIE. 50% GATE  
CILDIV: EQU     0D038H   ;CILINDRO DIVISO 10
CILMOL: EQU     0D03AH   ;CILINDRO MOLTIPLICATO x 10
CICL75: EQU     0D03CH   ;75% DEL CICLO DI CORREZZIONE 
CIDE75: EQU     0D03EH   ;MEM. DEL 75% DEL CICLO DI CORREZZIONE 
MEMAB:  EQU     0D040H   ;E D042H USATE IN ABILITAZ.GATE
SEQSEG: EQU     0D046H   ;E D048H POS.SEGNO NELLA SEQUENZA 
SEGNO:  EQU     0D04AH   ;IMP. DA 2048 IN UN SEGNO DA 2mm
SPAZIO: EQU     0D04CH   ;IMP.DA 2048 IN UNO SPAZIO DA 5mm
SPAZ40: EQU     0D04EH   ;IMP.DA 2048 IN SPAZIO DA 40mm
DISTAN: EQU     0D050H   ;DISTANZA TEORICA TRA S1 E S2
MILL20: EQU     0D052H   ;20mm IN IMPULSI ENCODER     
MILL40: EQU     0D054H   ;40mm IN IMPULSI ENCODER
GUADS1: EQU     0D056H   ;VALORE GUADAGNO SEGNALE S1
GUADS2: EQU     0D058H   ;VALORE GUADAGNO SEGNALE S2 
DMILLE: EQU     0D05AH   ;DECIMILLESIMI IN UN IMP.DI ENCOD
DISTA0: EQU     0D05CH   ;DISTANZA BASSA IN DECIMILLESIMI
DISTA2: EQU     0D05EH   ;DISTANZA ALTA IN DECIMILLESIMI
INFLAS: EQU     0D060H   ;INTERVALLO FLASH PROTEZIONI
LAVORO: EQU     0D062H   ;NøDEL LAVORO PRESENTE
SHIFT:  EQU     0D064H   ;MEM.DELLO SPOSTAMENTO REGISTRO
TSHIFT: EQU     0D066H   ;MEM. SPOSTAMENTO REG.TRAVERS
PIUMEN: EQU     0D068H   ;MEM.SENSO DELLO SPOSTAMENTO
SHIFT0: EQU     0D06AH   ;MEM.BASSA SPOSTAMENTO REGISTRO
SHIFT2: EQU     0D06CH   ;MEM. ALTA SPOSTAMENTO REGISTRO

POSGAT: EQU     0D06EH   ;POSIZIONE CARATTERE INIZIO GATE   

PIENO2: EQU     0D070H   ;MEM. VALORE DEL PIENO S2 
POSIZ2: EQU     0D074H   ;MEM. VALORE DELLA POSIZIONE S2 
RAPPO2: EQU     0D078H   ;MEM. RAPPORTO S2 
IMPENC: EQU     0D07AH   ;VALORE SPOSTAM.IN IMPULS.ENCODER
XUNZ:   EQU     0D07CH   ;MEMORIA FUNZIONE MOD. PARAMETRI
XTASTO: EQU     0D07EH   ;MEMORIA ULTIMO TASTO PREMUTO
TIUMEN: EQU     0D080H   ;MEM.SENSO DELLO SPOSTAM.TRAV
TDIST0: EQU     0D082H   ;DISTAN.BASSA IN DECIMILL.TRAV
TDIST2: EQU     0D084H   ;DIATAN. ALTA IN DECIMILL.TRAV
TATTES: EQU     0D086H   ;ATTESA CORREZ.TRAVERS
FASE2:  EQU     0D088H   ;MEM. INIZIO GATE DELLA FASE S2   
FASES2: EQU     0D08AH   ;MEMORIA DELLA FASE DI S2 
POSTO2: EQU     0D08CH   ;POSIZIONE TOTALE S2
CICATT: EQU     0D08EH   ;CICLI IN FUNZ. POSIZ. CILIN. LONG. 
TCICAT: EQU     0D090H   ;CICLI IN FUNZ. POSIZ. CILIN. TRAV. 
AMPGA:  EQU     0D092H   ;AMPIEZZA GATE IN mm  
GUADA:  EQU     0D0A0H   ;MEM.DEL GUAD.min 11 x CIL=2000
CICLO:  EQU     0D0AAH   ;MEMORIA CICLO DI CORREZIONE
DERIVA: EQU     0D0B4H   ;MEMORIA DEL VALORE DERIVATIVO
ZONA:   EQU     0D0BEH   ;MEMORIA VALORE ZONA MORTA
INSER:  EQU     0D0C8H   ;MEMORIA VALORE INSERZIONE AUTO
SALTO:  EQU     0D0D2H   ;MEM. VALORE SALTO DI CORREZIONE
ZONT:   EQU     0D0DCH   ;MEM. ZONA MORTA TRAVERS
LINGUA: EQU     0D0E6H   ;MEMORIA DELLA LINGUA
TRIP:   EQU     0D0F0H   ;SOGLIA BLOCCO PER VELOCITA' 

CENSEN: EQU     0D104H   ;VALORE SEGNO CENTRATO NEL GATE

GATOSC: EQU     0D106H   ;NUMERO CARATTERI OCCUPATI PER GATE  
AMPMEZ: EQU     0D108H   ;AMPIMP DIVISO 2
AMPI40: EQU     0D10AH   ;AMPIEZZA GATE DEL40%  IN CENTS  
GUAOSC: EQU     0D10CH   ;MEM.TEMPORANEA IN FUNZ OSCILLOSCOPIO
DMEZGA: EQU     0D10EH   ;40% GATE IN CENTESIMI
MNORD:  EQU     0D110H   ;GIRI ATTESA PRIMA DI TOGLIERE PC 7

DISPRE: EQU     0D11AH   ;ERRORE DISPLAY LONG.PRECEDENTE 
TDISPR: EQU     0D11CH   ;ERRORE DISPLAY TRAV.PRECEDENTE 
IMPMIL: EQU     0D11EH   ;IMPULSI DA 2048 PER mm PIU UNO  
BIANCO: EQU	0D120H   ;MINIMO SPAZIO BIANCO PER RA BBBB	
SPACOD: EQU     0D13EH   ;E' LA COPIA DI MILL40  TTGG

OSGAIN: EQU     0D140H   ;GUADAGNO SEGNALE OSCILLOSCOPIO  OOGG AAOO

MOSCIL: EQU     0D200H   ;MEM. OSCILLOSCOPIO DA D500H A D900H
MPUNTO: EQU     0D600H   ;MEM. DEL PUNTO ON O OFF   
FORMAR: EQU     0D700H   ;USATA NELLA FORMAZIONE DELLA MARCA 
CENTE4: EQU     0D982H   ;CENTES PER 4 
DOG:	EQU	0D984H	 ;IN CASO DI WATCH DOG NON FA VEDERE LA SCRITTA INIZIALE SSDD
MILL43:	EQU	0D98EH	 ;USATO IN OSCILLOSCOPIO INTERRNO
TAP1:   EQU     0DA20H   ;TABELLA IND. INTER. PIO1A
TAP2:   EQU     0DA22H   ;TABELLA IND. INTER. PIO1B
TAB0:   EQU     0DA30H   ;TABELLA IND. INTER. CTC CANALE 0
TAB1:   EQU     0DA32H   ;TABELLA IND. INTER. CTC CANALE 1
TAB2:   EQU     0DA34H   ;TABELLA IND. INTER. CTC CANALE 2
TAB3:   EQU     0DA36H   ;TABELLA IND. INTER. CTC CANALE 3
TABLAV: EQU     0DB00H   ;INIZIO TABELLA MEM. LAVORI



		;INIZIALIZZAZIONE SISTEMA       
		
WMNC_029:
		ORG     0000H
		JP      VIA

		ORG     0008H
		JP      VIA

		ORG     0010H
		JP      VIA

		ORG     0018H
		JP      VIA

		ORG     0020H
		JP      VIA

		ORG     0028H
		JP      VIA

		ORG     0030H
		JP      VIA

		ORG     0038H
		JP      VIA


		ORG     100H

VIA:

		

RESET_PIO:            
		LD	HL,INIT_Z80
		LD	(0DFFFH),HL
		LD	(0DFFDH),HL
		LD      SP,0DFFDH       ;DEF.AREA STACK
		RETI

INIT_Z80:
		LD	HL,VIA
		LD	(0DFFFH),HL
		LD      SP,0DFFFH       ;DEF.AREA STACK
		IM      2               ;IMPOSTA MODO PIO = 2
		LD      A,0DAH          ;IND.ALTO TAB.
		LD      I,A
                LD      IY,PIOA         ;IND.ROUT.INT.
		LD      (TAP1),IY       ;CAR.TAB.INT.
		LD      A,20H           ;VET.INTER.PIO A
		OUT     (02H),A         ;CONTROLLO PIO A
		LD      A,0CFH          ;PORTA A MODO 3
		OUT     (02H),A
                LD      A,11H           ;0-4 IN 123567 OUT
		OUT     (02H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (02H),A 
		LD      A,0EFH          ;P.M.BIT 0123567
		OUT     (02H),A
                LD      IY,PIOB         ;IND.ROUT.INT.
		LD      (TAP2),IY       ;CAR.TAB.INT.
		LD      A,22H           ;VET.INT.PIO B
		OUT     (03H),A         ;CONTROLLO PIO B
		LD      A,0CFH          ;PORTA B MODO 3
		OUT     (03H),A

                LD      A,3EH           ;067 OUT 12345 IN 1E PPUU
		OUT     (03H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (03H),A
                LD      A,0DDH          ;P.MAS.BIT 023467 FD PPUU

		OUT     (03H),A         ;ALL'INTERUPT
                LD      IY,CTC0         ;IND.ROUT.CTC0.
		LD      (TAB0),IY       ;CAR.TAB.INT.CAN0
		LD      A,30H           ;VET.IND.CTC0
		OUT     (70H),A         ;VET.SEMPRE IN 0
                LD      IY,CTC1         ;IND.ROUT.CTC1
		LD      (TAB1),IY       ;CAR.TAB.INT.CAN1
		LD      A,32H           ;VET.IND.CTC1
		OUT     (70H),A
                LD      IY,CTC2         ;IND.ROUT.CTC2
		LD      (TAB2),IY       ;CAR.TAB.INT.CAN2
		LD      A,34H           ;VET.IND.CTC2
		OUT     (70H),A
                LD      IY,CTC3         ;IND.ROUT.CTC3
		LD      (TAB3),IY       ;CAR.TAB.INT.CAN3
		LD      A,36H           ;VET.IND.CTC3
		OUT     (70H),A         ;VET.CARICATO
		EI                      ;SEMPRE IN 0

		;RESET DELLA PORTA C

		LD      A,(MEMC)        ;RESETTO LE USCITE
		RES     0,A             ;CHE NON VENGONO
		RES     1,A             ;UTILIZZATE
		RES     5,A             ;RIMANE MEMORIZ-
		RES     6,A             ;ZATA LA CONDI-
		RES     7,A             ;ZIONE AUTO/MAN
		OUT     (PC),A
		LD      (MEMC),A

                ;AZZERAMENTO DA 0C000H A 0CFFFH
		
		LD      A,00H
                LD      (TABCON),A      ;LOC. INIZIALE
                LD      HL,TABCON
                LD      DE,TABCON+01H
                LD      BC,0FFFH
		LDIR                    
		LD      A,04H           ;PER NON AVERE IN
		LD      (MATTES),A      ;DECREMENTO FFH
		LD      (CONSAL),A
                LD      (CONSAT),A      ;EEAA
		LD	(OSGAIN),A	;PUUU
                LD      (ALTERN),A
                CALL    DEFAUL
                CALL    VARERR          ;WWAA
                CALL    GENCAR          ;
		CALL	VERIFI		;EEUU

                ;INIZIALIZZAZIONE LCD E SCRITTA RELES
		
		LD	A,(DOG)		;IN CASO DI SSDD
		CP	01H		;WATCH DOG SALTA
		JR	Z,CANE
                CALL    INISI           
                LD      HL,RELES1
                CALL    TX
                CALL    BASSA
                LD      HL,RELES2
                CALL    TX              
                CALL    RITDIS          ;
CANE:
                LD      HL,IIRIGA       ;
                LD      DE,SECFUN
                LD      BC,0014H        ;28/01/01
                LDIR
                LD      HL,COLORE
                LD      DE,NUMCOL
                LD      BC,0014H        ;28/01/01
                LDIR                    ;

                ;TRASMISSIONE DELLA FASE

FASTRA:        
		LD	A,00H		;RESETTO WATCH DOG SSDD
		LD	(DOG),A		;SSDD

		LD      HL,(FASE)
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
       
FASAUT:         LD      A,(MRIC+00H) 
		CP      01H
                JP      NZ,MAIN         ;GGAA
		LD      A,(MEMC)        
		RES     5,A
		LD      (MEMC),A
		OUT     (PC),A          
		CALL    CODICE
		LD      A,(MEMB)
		RES     6,A
		LD      (MEMB),A
		OUT     (PB),A
		LD      A,00H
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
                LD      A,60H           ;ALLA PART-
		LD      (GUADS1),A      ;ZA METTO GUA-
   

		;MAIN PROGRAMMA PRINCIPALE DI CALCOLO


MAIN:           
		LD      A,(MCALER)      ;VEDE SE DEVE ABBB
		CP      00H             ;CALCOLARE O NO
		JP      Z,GIR1
		LD      A,00H
		LD      (MCALER),A
		CALL	CONTR		 ;EEOO
MAIN1:          
		LD      A,(ALTERR)      ;VEDE SE DEVE
		CP      00H             ;ASPETTARE
		JP      NZ,GIR1         


		;CALCOLO RAPPORTO POSIZINE PIENO S1

	        LD      DE,(ERATTU)     ;MEMORIZZO ERRORE PUUU
		LD      (ERPREC),DE     ;PRECEDENTE
                LD      A,(MSCORR)      ;
		LD      IX,PIENO1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,RAPP10        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
                LD      DE,(QUOZIE)
		JR      RAPP11
RAPP10:         CCF
                LD      DE,0000H
RAPP11:         LD      (RAPPO1),DE     ;VERIFICO SE E'
		LD      A,(MEMRIF)      ;STATO TROVATO
		CP      00H             ;IL SEGNO DI
                JR      Z,RAPP2         ;REGISTRO DURANTE
		CALL	AZZTOT		;RESET MEDIA --> taj 200   TTTTLLLL
                LD      DE,(RAPPO1)     ;LA RICERCA AUTO-
                LD      (RAPRIF),DE     ;MATICA PER MEMO-
		LD      DE,(FASES1)     ;RIZZARE I RIFE-
		LD      (FASRIF),DE     ;RIMENTI QUESTI
		LD      HL,MEMRIF       ;VENGONO MEMORIZ-
		DEC     (HL)            ;ZATI DOPO 4 GIRI
                LD      A,(MEMRIF)      ;QUANDO ARRIVO
                CP      00H             ;A ZERO ESEGUO
                JR      NZ,RAPP2        ;IL CALCOLO
                LD      DE,(FASRIF)     ;DEL RIFTOT
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
                LD      HL,(RAPRIF)
		ADD     HL,DE
                LD      (RIFTOT),HL



		;CALCOLO DELL'ERRORE IN CENTESIMI ED
		;EVENTUALE CORREZIONE DA ESEGUIRE
                ;(FASRIF-FASES1)+(RAPRIF-RAPPO1)= ERRORE
		;(FASRIFx10)+RAPRIF=RIFTOT
                ;(FASES1x10)+RAPPO1=POSTOT
		;(RIFTOT-POSTOT):10=ERRORE IN DECIMI

RAPP2:          LD      DE,(FASES1)     ;FASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
                LD      HL,(RAPPO1)
		ADD     HL,DE
		LD      (POSTOT),HL
		EX      DE,HL
		LD      HL,(RIFTOT)     ;FLO1 PUNTO A
		SBC     HL,DE
                JR      C,ERR1
		EX      DE,HL
                LD      HL,(AMPI10)     ;VEDO SE ERRORE 
                SBC     HL,DE           ;E'> DI AMPI10
		EX      DE,HL
                JR      NC,INDRE        ;FLO1 PUNTO B
		CCF
		LD      HL,(RIFTOT)     ;FLO1 PUNTO C
		LD      DE,(POSTOT)
		SBC     HL,DE
		EX      DE,HL
		LD      HL,0A000H       ;40960
		SBC     HL,DE
                JR      INNAS
ERR1:           CCF
		LD      HL,(POSTOT)     ;FLO1 PUNTO D
		LD      DE,(RIFTOT)
		SBC     HL,DE
		EX      DE,HL
                LD      HL,(AMPI10)     ;FLO1 PUNTO E  
		SBC     HL,DE
		EX      DE,HL
                JR      NC,INNAS
		CCF
		LD      HL,0A000H       ;40960
		LD      DE,(POSTOT)     ;FLO1 PUNTO F
		SBC     HL,DE
		LD      BC,(RIFTOT)
		ADD     HL,BC
INDRE:          LD      A,08H           ;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. RITARDO
                JR      ERR2
INNAS:          LD      A,01H           ;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. AVANTI


		;(ERR.xCENT.IN DIV.ENC.):100=ERR.IN DECIM


ERR2:           LD      (MOLTI),HL      ;HL CONTIENE ERR.
		LD      A,(CENTES)
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      (DIVDEN),DE     ;PRIMA DIVISIONE
		LD      BC,000AH        ;PER DIECI
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      HL,(ERPREC)     ;FACCIO UNA MEDIA
		ADD     HL,DE           ;TRA ERRORE LETTO
		LD      (DIVDEN),HL     ;E IL PRECEDENTE. 
		LD      BC,0002H        
		LD      (DIVSOR),BC      
		CALL    DIVIS

 		LD      DE,(QUOZIE)
                LD      (ERATTU),DE
                LD      A,(SALTO)       ;SE SALTO E'
                CP      00H             ;ZERO CORREGGO
                JR      Z,ERR6          ;SEMPRE
                LD      HL,0064H        ;SOMMO A ERPREC   
		LD      BC,(ERPREC)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;ERATTU SE CARRY
                JR      NC,ERR3         ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
		LD      BC,(ERPREC)     ;LATA LA IGNORO.
		LD      (ERATTU),BC
                LD      A,(CONSAL)      ;CONTROLLA CHE NON
		DEC     A               ;CHE NON RIMANGA
		LD      (CONSAL),A      ;IN BLOCCO PER PIU'
		CP      00H             ;DI N GIRI MEMO- 
                JR      Z,ERR5          ;RIZZATI IN SALTO  
		JP      GIR1            ;E POI
ERR5:           LD      (ERATTU),DE     ;RICARICA L'ULTIMO
		LD      (ERPREC),DE     ;ERRORE LETTO
                JR      ERR3            
ERR3:           LD      A,(SALTO)       ;CARICA I GIRI DI
		LD      (CONSAL),A      ;ATTESA.

ERR6:           LD      A,(MKBUSY)      ;VEDO SE TASTIERA
		CP      00H             ;E' IN USO
		JP      NZ,GIR1
                CALL    LMEDIA
                LD      A,(NODISP)      ;DOPO 16 VOLTE DD11
                CP      10H             ;CHE SALTO DD11
                JR      Z,ERR7          ;SCRIVO DD11

                LD      HL,(BINSET)     ;SE NON C'E'STATA
                LD      DE,(DISPRE)     ;VARIAZIONE 
                SBC     HL,DE           ;D'ERRORE NON
                JR      Z,ERR9          ;AGGIORNO IL DD11
                JR      NC,ERR7         ;DISPLAY
                CCF

ERR7:           LD      A,00H           ;ANNULLO DD11
                LD      (NODISP),A      ;CONTA DD11
                CALL    SCRITL
                CALL    SCRITD

                LD      A,(SUPCOR)      ;
                CP      01H
                JR      NZ,ERR8         ;
                CALL    OVERCO          ;

ERR9:           LD      A,(NODISP)      ;INC LA DD11
                INC     A               ;LA CONTA DD11
                LD      (NODISP),A      ;DD11

ERR8:           LD      HL,(BINSET)
                LD      (DISPRE),HL     ;
                LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR

		;CONTROLLO SOGLIA INSERZIONE

SOGLIN:         CALL    VELO
                LD      HL,(ISTVEL)     ;VVVV LD      HL,(VELMED)     
		LD      DE,(INSER)      
		SBC     HL,DE            
		JR      C,SOGLI2
SOGLI1:         LD      A,00H           ;FFLL
                LD      (PROTEZ),A      ;FFLL
                JR      ALLA1 
SOGLI2:         CCF
                    
		LD      A,05H           ;BLOCCO ALL.
		LD      (CONALL),A
		LD      A,07H           ;SE INSER E'
		LD      (MATTES),A      ;MAGGIORE
		LD      A,(MEMC)        ;BLOCC0 LA COR-
		RES     3,A             ;REZIONE E AL
		LD      (MEMC),A        ;TANDO I CICLI
		OUT     (PC),A          ;DI ATTESA.
		BIT     2,A             ;SE NON E' IN
		JP      Z,GIRO          ;AUTO SALTO
		CALL    LOWSPE          
		JP      GIRO

		;CONTROLLO SOGLIA ALLARME 

ALLA1:          IN      A,(PB)          ;NORD
                BIT     3,A             ;SE MANCA IL
                JR      NZ,ALLA3        ;SALTO
                LD      DE,(DMEZGA)     ;NORD
                LD      HL,(ERMEDI)     ;QUANDO L'ERRO-
                SBC     HL,DE           ;RE E' MINORE 
                JR      NC,ALLA3        ;DEL 40% DEL
                CCF                     ;GATE E SONO
                LD      A,(MNORD)       ;PASSATI 2
                DEC     A               ;GIRI TOLGO
                LD      (MNORD),A       ;USCITA 
                CP      02H             ;TRASMISSIONE
                JR      NC,ALLA4         
                CP      00H             
                JR      NZ,ALLA3        
                LD      A,(MEMC)        
                RES     7,A             
                LD      (MEMC),A
                OUT     (PC),A
                JR      ALLA3
ALLA4:          LD      A,02H           ;EVITO CHE
                LD      (MNORD),A       ;MNORD < 2
ALLA3:          LD      A,(ALLAR)       ;SE ALLARME E'
		CP      00H             ;MESSO A ZERO
		JR      Z,NOALL         ;SALTA.
		LD      HL,(ALLAR)      ;CONTROLLO SE 
		LD      DE,(ERMEDI)     ;L'ERRORE HA SU-
		SBC     HL,DE           ;PERATO LA SOGLIA
		JR      NC,NOALL        ;DI ALLARME
		CCF
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
		JR      Z,NOALL
		LD      A,(CONALL)      ;CONTO 5 AVVISI
		CP      00H             ;PRIMA DI ATTIVA- 
		JR      Z,ALLA2         ;RE L'ALLARME
		DEC     A
		LD      (CONALL),A
		JR      GIRO
ALLA2:          LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
		JR      GIRO
NOALL:          LD      A,(MEMC)
		RES     3,A             ;DISATTIVO ALLARM
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,05H           ;CARICO 5 AVVISI
		LD      (CONALL),A      ;DI ALLARME


GIRO:           CALL    CORREZ


		;ROUTINE DI ATTESA

                
                
GIR1:
                EI

                LD      A,(MEMC)        ;SE SONO IN BBLL
                BIT     2,A             ;MANUALE
                JR      NZ,NON          ;DISATTIVO
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL




NON:            LD      A,(MKBUSY)      ;SE STO USANDO
		CP      01H             ;LA TASTIERA
		JR      NZ,G6           ;BLOCCO LE
                CALL    RESEPC          ;CORREZIONI  FFLL

G6:             LD      A,(PROTEZ)
		CP      00H
		JR      Z,G7
                LD      A,(INFLAS)      ;FFLL
		DEC     A
		LD      (INFLAS),A
		CP      00H
		JR      NZ,G7

                CALL    FLASH          ;xxxx

G7:             LD      BC,01FFH       ;OOOO QUESTO
G1:             DEC     BC             ;VALORE VA BENE
		LD      A,B            ;DOPO AVER  RIMESSO
		OR      C              ;A MAIN1 JP Z,GIR1
		JR      NZ,G1          ;E NON Z,SOGLIN
		LD      BC,01FFH       ;0000
G2:             DEC     BC
		LD      A,B
		OR      C
		JR      NZ,G2
		LD      A,(MKBUSY)      ;SE TASTIERA 
		BIT     0,A             ;IN USO SALTA
		JR      NZ,G3
		LD      BC,01FFFH
G4:             DEC     BC
		LD      A,B
		OR      C
		JR      Z,G8
		IN      A,(PB)          ;SOLO QUANDO LA
		BIT     4,A             ;MACCHINA GIRA
		JR      Z,G4            ;ESEGUE IL CON-
G5:             DEC     BC              ;TROLLO SE NO
		LD      A,B             ;ASPETTA E
		OR      C               ;METTE ZERO
		JR      Z,G8            ;ALLA VELOCITA'
		IN      A,(PB)          
		BIT     4,A             
		JR      NZ,G5
		JR      G3
G8:             LD      A,48
		LD      (NUMCOL+11H),A
		LD      (NUMCOL+12H),A
		LD      (NUMCOL+13H),A
		CALL    INISI
		LD      HL,NUMCOL
		CALL    TX

                CALL    FLASH           ;xxxx

G9:             LD      DE,0000H        ;AAVV  FFLL
                LD      (VELBCD),DE     ;AZZERO LE MEM.
                LD      HL,VELBCD       ;DELLA MEDIA
                LD      DE,VELBCD+01H   ;E DELLA 
                LD      BC,002FH        ;VELOCITA AAVV 
                LDIR

                CALL    RESEPC          ;FFLL22
                LD      A,00H
                LD      (PROTEZ),A      ;FFLL22

                LD      A,(MEMC)        ;DISTTIVO BBLL
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL


G3:             JP      FASAUT








                
                ;GESTIONE TASTIERA


PIOA:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
                LD      DE,1FFFH        ;SO SPOSTAMENTO.  TTPP
KRIT1:          DEC     DE                
		LD      A,D
		OR      E
		JR      NZ,KRIT1
		IN      A,(PA)          
		BIT     4,A
		JP      NZ,ESCI
                CALL    SERITA
                LD      C,(HL)          ;DA LETTURA SE 
                LD      DE,1FFFH        ;SONO EGUALI   TTPP
KRIT2:          DEC     DE              ;PROCEDO SE NO 
		LD      A,D             ;ESCO
		OR      E
		JR      NZ,KRIT2
		IN      A,(PA)
		BIT     4,A
		JP      NZ,ESCI
                CALL    SERITA
		LD      A,(HL)          ;SECONDA LETTURA
                CP      C               ;C= PRIMA LETTU-
                JP      NZ,ESCI         ;RA
		LD      A,(MDBUSY)      ;SE IL DISPLAY
		CP      00H             ;E' OCCUPATO 
		JR      Z,PIOA1         ;DALL'ERRORE DI
		LD      A,00H           ;REGISTRO LO
		LD      (MDBUSY),A      ;CANCELLO
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A
PIOA1:          LD      A,01H           ;SEGNALA L'USO
		LD      (MKBUSY),A      ;DELLA TATSIERA
		LD      A,(HL)          
		CP      0AH
                JP      Z,CLEA3         ;NORD
		CP      0BH
		JP      Z,ENTE1
		LD      A,(MEM0)        ;CONTROLLO SE 
		BIT     0,A             ;INSERITE FUN-
		JP      NZ,KBRD1        ;ZIONI
		LD      A,(MEM1)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM2)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM3)
		BIT     0,A
		JP      NZ,KBRD1


                LD      A,(MEM5)        ;FF55
		BIT     0,A
		JP      NZ,KBRD1


		LD      A,(MEM6)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM7)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(HL)          ;CONTINUO LA
		CP      0DH             ;LA CODIFICA
                JP      Z,MENO1         ;DELLA TASTIERA
		CP      0CH
                JP      Z,PIU1
                CP      0EH             ;T24
                JP      Z,MANC
                CP      10H             ;T24
                JP      Z,AUTOC
                CP      11H
                JP      Z,MANT
                CP      12H
                JP      Z,AUTOT
                CP      13H
                JP      Z,OPERA
                CP      14H
                JP      Z,TRAS
                CP      15H
                JP      Z,PUNTO
                CP      16H
                JR      NZ,PIOA2
                CALL    MODPA
PIOA2:          CP      17H
                JR      NZ,PIOA3
                CALL    TEST          ;T24
PIOA3:          LD      A,(MEMTF)     ;CONTROLLO SE
		CP      00H             ;PIGIATO PRECE-
                JP      NZ,FUNZI        ;DENTEMENTE F
		LD      A,(HL)
		CP      0FH
		JP      Z,FUNZI
		CP      0AH             ;SE NON E' UN
		JR      NC,NONUM        ;NUMERO SALTA
		CALL    MUOVO
                EXX                     
                CALL    BIOTTD
                XOR     A               
NONUM:          LD      (MEMTF),A       ;MEMORIZZA
		JP      ESCI            ;LA FUNZIONE

CLEA3:          LD      A,(MEMC)        ;PER ELIMI- NORD
                RES     7,A             ;NARE LA 
                LD      (MEMC),A        ;FUNZ9
                OUT     (PC),A          ;NORD
CLEA1:                                  ;SSDD
                LD      A,00H           ;CANCELLA
		LD      IX,BINSET+06H   ;LE MEMORIE
		LD      (IX+00H),A      ;TEMPORANEE
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A  ;E LA LETTERA
		LD      (MEM0),A        ;AZZERO MEMORIE
		LD      (MEM1),A
		LD      (MEM2),A        
		LD      (MEM3),A

                LD      (MEM5),A        ;

		LD      (MEM6),A
		LD      (MEM7),A
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MRIC+04H),A	 ;AADD SSDD
		LD      (MEMTF),A       ;AZZERO MEM.
		LD      (MEMID),A       ;TASTO F E INIZIA-
		LD      (MDATER),A      ;LIZAZZIONE DISP.
		LD      (MKBUSY),A      ;DATA ERROR E

                LD      A,00H           
                ADD     A,48
                LD      (NUMCOL+09H),A  
                CALL    INISI           
                LD      HL,NUMCOL
                CALL    TX

                JP      ESCI

                
MENO1:          LD      A,(MEMC)        ;SE MANUALE
                BIT     2,A             ;MOTORE RITARDO
                JP      Z,MANRIT
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,RITM
                CP      01H
                JR      Z,RITI
                CP      02H
                JR      Z,RITF
                CP      03H
                JR      Z,RITGB
                CP      04H
                JR      Z,RITE
                CP      05H
                JR      Z,RITD
RITM:           CALL    INISI
                LD      HL,RITARD
                JR      RITTX
RITI:           CALL    INISI
                LD      HL,RITARD+14H
                JR      RITTX
RITF:           CALL    INISI
                LD      HL,RITARD+28H
                JR      RITTX
RITGB:          CALL    INISI
                LD      HL,RITARD+3CH
                JR      RITTX
RITE:           CALL    INISI
                LD      HL,RITARD+50H
                JR      RITTX
RITD:           CALL    INISI
                LD      HL,RITARD+64H
RITTX:          CALL    TX


                LD      A,40H           ; -
		LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI

PIU1:           LD      A,(MEMC)        ;SE MANUALE 
                BIT     2,A             ;MOTORE AVANTI
                JP      Z,MANAVA
                LD      DE,0000H
                LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,AVAM
                CP      01H
                JR      Z,AVAI
                CP      02H
                JR      Z,AVAF
                CP      03H
                JR      Z,AVAGB
                CP      04H
                JR      Z,AVAE
                CP      05H
                JR      Z,AVAD
AVAM:           CALL    INISI
                LD      HL,AVANTI
                JR      AVATX
AVAI:           CALL    INISI
                LD      HL,AVANTI+14H
                JR      AVATX
AVAF:           CALL    INISI
                LD      HL,AVANTI+28H
                JR      AVATX
AVAGB:          CALL    INISI
                LD      HL,AVANTI+3CH
                JR      AVATX
AVAE:           CALL    INISI
                LD      HL,AVANTI+50H
                JR      AVATX
AVAD:           CALL    INISI
                LD      HL,AVANTI+64H
AVATX:          CALL    TX              

                LD      A,70H           ; +
		LD      (BINSET+10H),A
                CALL    BIN7
                CALL    BIN7            ;FFLL
		JP      ESCI
                

OPERA:          JP      ESCI            ;ELIMINATI NORD


TRAS:           JP      ESCI            ;ELIMINATI NORD

ENTE1:         
	        LD      A,(MEM5)        ;FF57
                BIT     0,A             ;FF57
                JP      NZ,ENTE34       ;FF57
		LD      A,(MEM0)
		BIT     0,A
		JP      NZ,FUN3
		LD      A,00H           ;AZZERO MEM.
                LD      (ALTGUA),A      ;BLOCCO CAMBIO 
                LD      (MEM0),A        ;GUADAGNO
		LD      (MEM1),A
		LD      (MEM2),A
		LD      (MEM3),A

                LD      (MEM5),A        ; FF57

		LD      (MEM6),A
		LD      (MEM7),A
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MRIC+04H),A	  ;AADD

		LD      (MEMTF),A       ;TASTO F E INI-
		LD      (MEMID),A       ;ZIALIZZAZIONE
		CALL    BCDBIN          ;DISPLAY
		LD      A,(BINSET+10H)  ;SE SELEZIONATO
		CP      40H             ;MENO SALTO
		JP      Z,ENTE3         ;SE SELEZIONATO
		CP      70H             ;PIU' SALTO
		JP      Z,ENTE3
                CP      3FH             ;SE SELEZIONATO
                JP      Z,ENTE3         ;OPERATORE SALTO
                CP      78H             ;SE SELEZIONATO
                JP      Z,ENTE3         ;TRASMISS. SALTO
		CP      73H             ;SE SELEZIONATO
		JP      Z,ENTE4         ;P SALTO
		CP      50H
		JP      Z,ENTE6
		CP      1CH
		JP      Z,ENTE7
		CP      39H             ;CILINDRO CALCOLO
		JP      NZ,ENTE2        ;CENTES.
		LD      DE,(CILIN)      ;MOLTIPLICO PER
		LD      (MOLTI),DE      ;10 IL CILINDRO
		LD      A,0AH           ;PER POTER USARE
		LD      (MOLPL),A       ;AGGIUSTAMENTO
		CALL    MOLT            ;DECIMALE
		LD      BC,(PROD)
		LD      (CILMOL),BC     ;CILINDRO x 10
		LD      (MDO032),BC
		LD      DE,0000H        
		LD      (MDO232),DE     
		LD      BC,03E8H         
		LD      (MRE032),BC      
		LD      (MRE232),DE     
		CALL    MOL32
		LD      BC,(PTO032)     ;CILNDRO X 10000
		LD      DE,(PTO232)
		LD      (EDEND0),BC
		LD      (EDEND2),DE
		CALL    DIV32
		LD      DE,(QUOZ32)
		LD      (DMILLE),DE     ;DECIMILLESIMI
		LD      (DIVDEN),DE     ;CALCOLO QUANTI
		LD      BC,000AH        ;MILLESIMI CI 
		LD      (DIVSOR),BC     ;SONO IN UN
		CALL    DIVIS           ;CILINDRO
		LD      DE,(QUOZIE)
		LD      (MILLES),DE     ;MILLESIMI
		LD      (DIVDEN),DE     ;DIVIDO PER 10
		LD      BC,000AH        ;PER AVERE 
		LD      (DIVSOR),BC     ;I CENTESIMI
		CALL    DIVIS           
		LD      DE,(QUOZIE)
		LD      (CENTES),DE
		LD      DE,(CILIN)      ;DIVISIONE DEL
		LD      (DIVDEN),DE     ;CILNDRO PER 10
		LD      BC,000AH
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      (CILDIV),DE
		LD	DE,1388H	;=5000 ESSENDO UNOMIL SSDD
		LD      (DIVDEN),DE     ;MISURATO CON 2048
		LD      DE,(DMILLE)     ;DIVIDO 5000/DMILLE
		LD      (DIVSOR),DE     ;E TROVO QUANTI IMPULSI
		CALL    DIVIS           ;DA 2048 SONO 1mm
		LD      DE,(QUOZIE)     
		LD      (UNOMIL),DE     
		LD      DE,4E20H        ;=20000
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      (MILL20),HL     ;20mm
		ADD     HL,HL
		LD      (MILL40),HL     ;40mm 

                LD      (SPACOD),HL     ;SERVE IN OSCFX1 TTGG

		LD      DE,0A7F8H        ;=43000
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      (MILL43),HL     ;43mm

                LD      DE,0E4EH        ;4000x4096=  
                LD      (MDO032),DE     ;1638400
                LD      DE,0000H        ;60\1638400=
                LD      (MDO232),DE     ;0,000003662
                LD      (MRE232),DE     ;3662=0E4EH
                LD      DE,(CILIN)
                LD      (MRE032),DE
                LD      A,02H           
                LD      (ALTDIV),A      
                CALL    MOL32
                CALL    DI1000
                LD      BC,(QU1000)
                LD      (COSVEL),BC     ;COSTANTE VEL. 


		;CALCOLO VALORI PER RICERCA CODICE
		;AL CAMBIO DI FORMATO

		;########################################
		;# UNOMIL : 2 = IMPULSI DA 2048 IN 1mm  #
		;# NøIMPULSI DA 2048 IN 1 mm X 3 =      #   
		;# SPESSORE SEGNO. LO SPAZIO TRA DUE    #
		;# SEGNI E' DI 7 mm PER CUI LO SPAZIO   #
		;# RIMANENTE E' Nø IMPULSI DA 2048      #
		;# IN 1mm X 4 CIOE'3+1=4                #
		;########################################
		
		LD      DE,(UNOMIL)
                
		SRL     E               ;DIVISO DUE

                LD      A,E             ;IMPULSI DA 
                INC     A               ;2048 PER mm+1
                LD      (IMPMIL),A      ;

                LD      B,E             ;PERCHE' 2048
		LD      D,00H
		LD      (MOLTI),DE      ;NøIMPULSI X 3
		LD      A,03H
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      (SEGNO),DE
		LD      A,B             ;NøIMPULSI X 3
		ADD     A,E             ;+1= SPAZIO
		LD      (SPAZIO),A
		LD      DE,(MILL40)     ;MILL40:2=A
		SRL     E               ;40mm IN
		LD      A,E             ;IMPULSI DA 2048
		LD      (SPAZ40),A      


                ;CALCOLO POSIZIONE GATE NELL'OSCILLOSCOPIO

                LD      HL,(MILL43)         ;
                LD      (DIVDEN),HL     ;DIVIDO IL
                LD      BC,(IMPMIL)     ;NUMERO DI 
                LD      B,00H           ;IMPULSI TRA IL
                LD      (DIVSOR),BC     ;TRIGGER E LA
                CALL    DIVIS           ;FASE PER IMP-
                LD      DE,(QUOZIE)     ;MIL+1 IL VALORE
                LD      (BINSET),DE     ;OTTENUTO LO
                CALL    AGGIUS          ;AGGIUSTO PER
                LD      DE,(QUOZIE)     ;ELIMINARE LE 
                LD      (DIVDEN),DE     ;UNITA' E POI
                LD      BC,000AH        ;DIVIDO PER 10
                LD      (DIVSOR),BC     ;E OTTENGO LA
                CALL    DIVIS           ;POSIZIONE DEL
                LD      DE,(QUOZIE)     ;CARATTERE DOVE
                LD      (POSGAT),DE     ;INIZIA IL GATE
                LD      A,01H           
                LD      (MAGGI1),A      ;AGGIUSTAMENTO
                LD      DE,(AMPGA)      ;PER PORTARE
                LD      (QUOZIE),DE     ;A 0 O 5
                LD      (BINSET),DE     ;AMPGATE PER
                CALL    AGGIUS          ;L'OSCILLOSCOPIO
                LD      DE,(QUOZIE)     ;E SAPERE I 
                LD      (GATOSC),DE     ;CARATTERI OC-
                                        ;CUPATI DAL GATE OOOO

ENTE2:          JP      CLEA1

ENTE3:          LD      A,(BINSET+10H)   
                CP      40H
		JR      Z,ENTE31
                CP      70H
                JR      Z,ENTE31
		JP      CLEA1
ENTE31:
                CALL    SPOSTA
		JP      CLEA1

ENTE34:                                 ;FF57
                LD      HL,(FASE)       ;CARICO IL FF57 
                LD      A,H             ;CONTATORE PER FF57
                OUT     (20H),A         ;LEGGERE POI S1 FF57
                LD      A,L             ;FF5555
                OUT     (10H),A         ;FF5555
                LD      A,00H
                LD      (MEM5),A
                LD      (MOLTI),HL      ;MOLTIPLICO PER FF57
                LD      A,0AH           ;10 PER AVERE IL
                LD      (MOLPL),A       ;RIFERIMENTO TO-
                CALL    MOLT            ;TALE TRASCURAN-
                LD      DE,(PROD)       ;DO IL RAPPORTO
                LD      (RIFTOT),DE
                LD      A,01H           ;FF57
                LD      (MOSCI1),A      ;FF57
		LD	A,02H		;FF57
		LD	(MEMRIF),A	;FF57
                
		JP      CLEA1           ;FF57


ENTE4:
     
                LD      DE,(CENTES)     ;
                LD      (MOLTI),DE      ;
                LD      A,04H
                LD      (MOLPL),A
                CALL    MOLT
                LD      DE,(PROD)
                LD      (CENTE4),DE     ;

                LD      DE,(AMPGA)      ;NORD
                LD      (MOLTI),DE      ;MOLTIPLICO
                LD      A,50H           ;AMPIEZZA GATE
                LD      (MOLPL),A       ;PER 80
		CALL    MOLT
                LD      DE,(PROD)       
                LD      (DIVDEN),DE     ;DIVIDO PER 2
                LD      BC,0002H
		LD      (DIVSOR),BC
                CALL    DIVIS           ;AMPIEZZA 40%  
                LD      DE,(QUOZIE)     ;IN CENTESIMI
                LD      (DMEZGA),DE


                LD      DE,(AMPGA)
		LD      (MOLTI),DE      ;AMPIEZZA GATE
		LD      A,64H           ;PER 100
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;AMPIEZA IN CENT.
		LD      (DIVDEN),DE
                LD      BC,(CENTE4)     ;
		LD      (DIVSOR),BC
		CALL    DIVIS           ;AMPIEZZA GATE IN
		LD      DE,(QUOZIE)     ;IMPULSI ENCODER.

                LD      A,D             ;CONTROLLO SE IL 
		CP      00H             ;RISULTATO E'MAG-
		JR      Z,ENTE41        ;GIORE DI 255.
		LD      D,00H           ;SE LO E'IMPONGO
		LD      E,0FFH          ;COME VALORE MAX
		LD      (MOLTI),DE      ;255 E RIPETO LE
                LD      A,(CENTE4)      ;OPERAZIONI 
		LD      (MOLPL),A       ;ALL'INVERSO PER
		CALL    MOLT            ;PER CALCOLARE IL
		LD      DE,(PROD)       ;NUOVO AMPAG RI-
		LD      (DIVDEN),DE     ;FERITO A 255.
		LD      BC,0064H
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      (AMPGA),DE

                JP      ENTE4           ; NORD

ENTE41:         LD      (AMPIMP),DE     
		LD      (MOLTI),DE
                LD      A,0B4H          ;CALCOLO IL 180%  
		LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
                CALL    MOLT            ;GATE CIOE 45x4
		LD      DE,(PROD)       
		LD      (DIVDEN),DE
		LD      BC,0064H
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
                LD      (MEZGA),DE     ;
 
		LD	DE,(AMPIMP)	;METTO IL BIANCO = AL GATE SSDD
		LD	(MOLTI),DE	;ESSENDO AMPIMP MISURATO  
		LD	A,02H		;IN 1024 E IL BIANCO  
		LD	(MOLPL),A	;IN 2048 MOLTIPLICO PER 2
		CALL	MOLT		;AMPIMP PER AVAERE IL BIANCO
		LD	DE,(PROD)
		LD	(BIANCO),DE	;SSDD


                LD      DE,(AMPGA)      ; 
		LD      (MOLTI),DE
                LD      A,28H           ;CALCOLO IL 40% 
		LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
		CALL    MOLT            ;GATE
		LD      DE,(PROD)       
                LD      (AMPI40),DE     ;GATE IN CENTS     

                LD      A,(AMPIMP)      ;
                SRL     A
                LD      (AMPMEZ),A      ;

                LD      DE,(AMPIMP)     ;CON CKTG0 A  
                LD      (MOLTI),DE      ;1024 MOLTIPL. 
                LD      A,28H           ;PER 40 ANZICHE 
                LD      (MOLPL),A       ;PER 10 CON CKTG0 
                CALL    MOLT            ;A 4096
		LD      DE,(PROD)
                LD      (AMPI10),DE     
		
		LD      DE,7D0H         ;2000 = 20mmX100
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
		SBC     HL,DE
		LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
                LD      (TDIST0),HL     ;CENTIMILLESIMI
                LD      HL,(PTO232)     ;SIA PER LONG.
                LD      (DISTA2),HL     ;CHE PER TRAVERS
                LD      (TDIST2),HL
ENTE42:
                LD      A,01H           ;PER AVERLO 
                LD      (MAGGI1),A      ;ANCHE SOLO IN
                LD      DE,(AMPGA)      ;CAMBIO AMPIEZZA
                LD      (QUOZIE),DE     ;GATE
                LD      (BINSET),DE     ;VEDI SOPRA
                CALL    AGGIUS          ;IN CALCOLO GATE
                LD      DE,(QUOZIE)     ;PER OSCILLO. 
                LD      (GATOSC),DE     

                JP      CLEA1



FUNZI:          LD      A,00H           ;RESETTO PORTA C
		LD      (MEMC),A        ;IMPONENDO MANUALE
		OUT     (PC),A
		LD      A,(HL)          ;ASPETTO CHE    
		LD      (MEMTF),A       ;VENGA SCELTA
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FUNM
                CP      01H
                JR      Z,FUNI
                CP      02H
                JR      Z,FUNF
                CP      03H
                JR      Z,FUNB
                CP      04H
                JR      Z,FUNE
                CP      05H
                JR      Z,FUND
FUNM:           CALL    INISI
                LD      HL,FUNDIS
                JR      FUNTX
FUNI:           CALL    INISI
                LD      HL,FUNDIS+14H
                JR      FUNTX
FUNF:           CALL    INISI
                LD      HL,FUNDIS+28H
                JR      FUNTX
FUNB:           CALL    INISI
                LD      HL,FUNDIS+3CH
                JR      FUNTX
FUNE:           CALL    INISI
                LD      HL,FUNDIS+50H
                JR      FUNTX
FUND:           CALL    INISI
                LD      HL,FUNDIS+64H
FUNTX:          CALL    TX              

  
                LD      A,(MEMTF)
		CP      00H
		JR      Z,FUNZ0
		CP      01H
		JP      Z,FUNZ1
		CP      02H
		JP      Z,FUNZ2
		CP      03H
		JP      Z,FUNZ3
		CP      04H
		JP      Z,FUNZ4
		CP      05H
		JP      Z,FUNZ5
		CP      06H
		JP      Z,FUNZ6
		CP      07H
		JP      Z,FUNZ7

                CP      09H
                JP      Z,FUNZ9         ;NORD

                JP      ESCI
		
	     
		;AZZERAMENTO DOPO REGISTRO MANUALE

FUNZ0:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A        
		OUT     (PC),A
		LD      A,01H
		LD      (MEM0),A

                LD      DE,(SPELET)     
                LD      (SPERIF),DE


                LD      DE,0000H        ;PER AZZERAE
                LD      (TSHIFT),DE     ;VERAMENTE

                LD      A,(LINGUA)
                CP      00H
                JR      Z,AZZM
                CP      01H
                JR      Z,AZZI
                CP      02H
                JR      Z,AZZF
                CP      03H
                JR      Z,AZZGB
                CP      04H
                JR      Z,AZZE
                CP      05H
                JR      Z,AZZD
AZZM:           CALL    INISI
                LD      HL,AZZER1
                JR      AZZTX
AZZI:           CALL    INISI
                LD      HL,AZZER1+14H
                JR      AZZTX
AZZF:           CALL    INISI
                LD      HL,AZZER1+28H
                JR      AZZTX
AZZGB:          CALL    INISI
                LD      HL,AZZER1+3CH
                JR      AZZTX
AZZE:           CALL    INISI
                LD      HL,AZZER1+50H
                JR      AZZTX
AZZD:           CALL    INISI
                LD      HL,AZZER1+64H
AZZTX:          CALL    TX              
                CALL    BASSA
                LD      HL,AZZER2
                CALL    TX

		JP      ESCI

FUN3:           LD      BC,(ERATTU)     ;CARICO L'ERRORE
		LD      (SHIFT),BC      ;LETTO IN SHIFT                                          
		LD      A,(MSCORR)      ;VEDO SE IN AVANTI
		CP      01H             ;O IN RITARDO E
		JR      Z,FUN1          ;CHIAMO LA ROUTINE
		LD      A,70H           ;SPOSTA PER CEN-
		LD      (PIUMEN),A      ;TRARLO NEL GATE.
		JR      FUN2
FUN1:           LD      A,40H
		LD      (PIUMEN),A
FUN2:           CALL    SPOSTA
                LD      A,01H           ;AVVISO DI AZZERA-
                LD      (MAZTRA),A      ;RE TRAVERS
		JP      CLEA1

		              		
		;PARAMETRI CILINDRO

FUNZ1:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,01H
		LD      (MEM1),A
		LD      DE,(CILIN)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,CILM
                CP      01H
                JR      Z,CILI
                CP      02H
                JR      Z,CILF
                CP      03H
                JR      Z,CILGB
                CP      04H
                JR      Z,CILE
                CP      05H
                JR      Z,CILD
CILM:           CALL    INISI
                LD      HL,FORCIL
                JR      CILTX
CILI:           CALL    INISI
                LD      HL,FORCIL+14H
                JR      CILTX
CILF:           CALL    INISI
                LD      HL,FORCIL+28H
                JR      CILTX
CILGB:          CALL    INISI
                LD      HL,FORCIL+3CH
                JR      CILTX
CILE:           CALL    INISI
                LD      HL,FORCIL+50H
                JR      CILTX
CILD:           CALL    INISI
                LD      HL,FORCIL+64H
CILTX:          CALL    TX              
		LD      A,39H           ;C
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI
KBRD1:          LD      A,(MEMA)        
                RES     2,A
                OUT     (PA),A
                SET     2,A
                OUT     (PA),A
                LD      D,00H           
                LD      B,08H           

                LD      A,(MEM5)        ;FF55
                BIT     0,A
                JP      NZ,ESCI          ;FF55


KBRD2:          LD      A,(MEMA)
                RES     1,A
                OUT     (PA),A
                IN      A,(PA)
                RR      A     
                RL      D
                SET     1,A
                SET     2,A
                OUT     (PA),A
                LD      (MEMA),A
                DJNZ    KBRD2
                LD      A,D
                AND     1FH             
                LD      L,A
		LD      H,00H
		LD      DE,TABLE
		ADD     HL,DE
		LD      A,(HL)
		CP      0AH
		JP      Z,CLEA1
		CP      0BH
		JP      Z,ENTE1
		CP      0AH             ;SE NON NUMERO
		JP      NC,ESCI         ;ESCI
		LD      B,A
		LD      A,(MEMID)       ;SE E' IL PRIMO
		BIT     0,A             ;NUMERO INSERITO
		JR      NZ,ADIS1        ;INIZIALIZZA IL
		LD      A,01H           ;DISPLAY METTENDO
		LD      (MEMID),A       ;DEGLI ZERI
		CALL    INIZDI
ADIS1:          LD      A,B
		CALL    MUOVO
                EXX                     
                CALL    BIOTTD
                XOR     A               
		JP      ESCI

		;PARAMETRI ALLARME

FUNZ2:          LD      A,00H           ;IMPONGO MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,01H
		LD      (MEM2),A
		LD      DE,(ALLAR)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,SOAM
                CP      01H
                JR      Z,SOAI
                CP      02H
                JR      Z,SOAF
                CP      03H
                JR      Z,SOAGB
                CP      04H
                JR      Z,SOAE
                CP      05H
                JR      Z,SOAD
SOAM:           CALL    INISI
                LD      HL,SOALLR
                JR      SOATX
SOAI:           CALL    INISI
                LD      HL,SOALLR+14H
                JR      SOATX
SOAF:           CALL    INISI
                LD      HL,SOALLR+28H
                JR      SOATX
SOAGB:          CALL    INISI
                LD      HL,SOALLR+3CH
                JR      SOATX
SOAE:           CALL    INISI
                LD      HL,SOALLR+50H
                JR      SOATX
SOAD:           CALL    INISI
                LD      HL,SOALLR+64H
SOATX:          CALL    TX              
		LD      A,77H           ;A
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      ESCI

		;PARAMETRI POSIZIONE SEGNO

FUNZ3:          LD      A,01H
		LD      (MEM3),A
                LD      DE,(AMPGA)
		LD      (BINSET),DE
                LD      A,(LINGUA)
                CP      00H
                JR      Z,POSM
                CP      01H
                JR      Z,POSI
                CP      02H
                JR      Z,POSF
                CP      03H
                JR      Z,POSGB
                CP      04H
                JR      Z,POSE
                CP      05H
                JR      Z,POSD
POSM:           CALL    INISI
                LD      HL,GATEW
                JR      POSTX
POSI:           CALL    INISI
                LD      HL,GATEW+14H
                JR      POSTX
POSF:           CALL    INISI
                LD      HL,GATEW+28H
                JR      POSTX
POSGB:          CALL    INISI
                LD      HL,GATEW+3CH
                JR      POSTX
POSE:           CALL    INISI
                LD      HL,GATEW+50H
                JR      POSTX
POSD:           CALL    INISI
                LD      HL,GATEW+64H
POSTX:          CALL    TX              
		LD      A,73H           ;P
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI

		;SEGNALAZIONE FASATURA AUTOMATICA


FUNZ4:          LD      A,00H           ;IMPONGO MANUALE
                LD      (MEMC),A        
                OUT     (PC),A
                LD      (SUPCOR),A      ;
                LD      A,01H
		LD      (MRIC+00H),A
		LD      (MRIC+04H),A	;AADD
 		LD      A,0FH           ;DOPO 16 GIRI
		LD      (ALTGUA),A      ;STOP GUAD.AUTO
		LD      A,60H           ;INIZIO CON
		LD      (GUADS1),A      ;GUADAGNO MINIMO

                LD      A,05H
		LD      (MRIC+02H),A
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FASM
                CP      01H
                JR      Z,FASI
                CP      02H
                JR      Z,FASF
                CP      03H
                JR      Z,FASGB
                CP      04H
                JR      Z,FASESP
                CP      05H
                JR      Z,FASESD
FASM:           CALL    INISI
                LD      HL,FASEAU
                JR      FASTX
FASI:           CALL    INISI
                LD      HL,FASEAU+14H
                JR      FASTX
FASF:           CALL    INISI
                LD      HL,FASEAU+28H
                JR      FASTX
FASGB:          CALL    INISI
                LD      HL,FASEAU+3CH
                JR      FASTX
FASESP:         CALL    INISI
                LD      HL,FASEAU+50H
                JR      FASTX
FASESD:         CALL    INISI
                LD      HL,FASEAU+64H
FASTX:          CALL    TX              
		JP      ESCI

                ;FASATURA MANUALE     FF55
                      
                ;FASATURA MANUALE     FF55

FUNZ5:		
;		LD      A,01H		
;               LD      (MEM5),A	
		LD      A,00H           ;IMPONGO MANUALE
                LD      (MEMC),A
                OUT     (PC),A
		LD	(SHIFT3),A	;SSCC
		LD	(SHIFT4),A	;SSCC

		IN      A,(10H)         ;SENTO SE FFMM
		LD      L,A             ;L'ENCODER
		IN      A,(20H)         ;STA GIRANDO
		LD      H,A             ;SE E' FERMO
		LD      BC,07FFFH       ;ESEGUO FSABO
FUNZ51:         DEC     BC              ;SE GIRA ESEGUO
		LD      A,B             ;RICENTRATURA
		OR      C
		JR      NZ,FUNZ51
		IN      A,(10H)      
		LD      E,A
		IN      A,(20H)
		CP      H
		JR      NZ,FUNZ52
		LD      A,E
		CP      L
		JR      Z,FUNZ53
FUNZ52:					;FFMM
		LD      A,01H		
                LD      (MEM5),A	
                LD      A,(LINGUA)
                CP      00H
                JR      Z,FUN5M
                CP      01H
                JR      Z,FUN5I
                CP      02H
                JR      Z,FUN5F
                CP      03H
                JR      Z,FUN5B
                CP      04H
                JR      Z,FUN5E
                CP      05H
                JR      Z,FUN5D          ;DDDD

FUN5M:          CALL    INISI
                LD      HL,FUNDI5
                JR      FUN5TX
FUN5I:          CALL    INISI
                LD      HL,FUNDI5+14H
                JR      FUN5TX
FUN5F:          CALL    INISI
                LD      HL,FUNDI5+28H
                JR      FUN5TX
FUN5B:          CALL    INISI
                LD      HL,FUNDI5+3CH
                JR      FUN5TX
FUN5E:          CALL    INISI
                LD      HL,FUNDI5+50H
                JR      FUN5TX
FUN5D:          CALL    INISI
                LD      HL,FUNDI5+64H

FUN5TX:         CALL    TX              
            
                JP      ESCI
FUNZ53:					;FFMM

		IN      A,(10H)         ;LEGGO LA POSI-
		LD      E,A             ;ZIONE
		IN      A,(20H)
		LD      D,A
		LD      (FASE),DE
		LD      (MOLTI),DE      ;MOLTIPLICO PER
		LD      A,0AH           ;10 PER AVERE IL
		LD      (MOLPL),A       ;RIFERIMENTO 
		CALL    MOLT            ;TOTALE.
		LD      DE,(PROD)
		LD      (RIFTOT),DE
		CALL    CENTRA

                LD      A,(LINGUA)
                CP      00H
                JR      Z,FUNM5M
                CP      01H
                JR      Z,FUNM5I
                CP      02H
                JR      Z,FUNM5F
                CP      03H
                JR      Z,FUNM5B
                CP      04H
                JR      Z,FUNM5E
                CP      05H
                JR      Z,FUNM5D          ;DDDD

FUNM5M:         CALL    INISI
                LD      HL,FUNDM5
                JR      FUNM5TX
FUNM5I:         CALL    INISI
                LD      HL,FUNDM5+14H
                JR      FUNM5TX
FUNM5F:         CALL    INISI
                LD      HL,FUNDM5+28H
                JR      FUNM5TX
FUNM5B:         CALL    INISI
                LD      HL,FUNDM5+3CH
                JR      FUNM5TX
FUNM5E:         CALL    INISI
                LD      HL,FUNDM5+50H
                JR      FUNM5TX
FUNM5D:         CALL    INISI
                LD      HL,FUNDM5+64H

FUNM5TX:        CALL    TX              

		JP	ESCI



		;LETTURA PARAMETRI LAVORO

FUNZ6:          JP      CLEA1           ;###########
		LD      A,01H           ;#SOPPRESSA#
		LD      (MEM6),A        ;###########
		LD      DE,(LAVORO)
		LD      (BINSET),DE
		LD      A,50H           ;r
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI
		
ENTE6:          LD      BC,0020H        ;PER CALCOLARE
		LD      A,(LAVORO)      ;L'INDIRIZZO DI
		LD      (MOLTI),BC      ;INIZIO DEI DATI 
		LD      (MOLPL),A       ;DI UN LAVORO
		CALL    MOLT            ;MOLTIPLICO IL
		LD      DE,(PROD)       ;Nø DEL LAVORO 
		LD      HL,TABLAV       ;PER 32 E IL
		ADD     HL,DE           ;RISULTATO LO
		LD      DE,CILIN        ;SOMMO ALL'INDI-
		LDIR                    ;RIZZ0 DI INIZIO
		LD      A,01H           ;DELLA TABELLA
		LD      (MEM6A),A       
		JP      CLEA1

		;SCRITTURA PARAMETRI LAVORO


FUNZ7:          JP      CLEA1           ;###########
		LD      A,01H           ;#SOPPRESSA#
		LD      (MEM7),A        ;###########
		LD      DE,(LAVORO)
		LD      (BINSET),DE
		LD      A,1CH           ;u
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI

ENTE7:          LD      BC,0020H        ;COME SOPRA SOLO
		LD      A,(LAVORO)      ;CHE VENGONO
		LD      (MOLTI),BC      ;INVERTITI TRA 
		LD      (MOLPL),A       ;LORO LA DESTINA-
		CALL    MOLT            ;ZIONE E LA SOR- 
		LD      DE,(PROD)       ;GENTE
		LD      HL,TABLAV
		ADD     HL,DE
		EX      DE,HL
		LD      HL,CILIN
		LDIR
		JP      CLEA1

                ;FUNZIONE 9 PER NORD MECCANICA

FUNZ9:          LD      A,(MEMC)        ;NORD
                RES     0,A
                SET     1,A
                SET     2,A
                SET     7,A
                LD      (MEMC),A
                OUT     (PC),A
                LD      A,02H           ;CARICO LA
                LD      (MNORD),A       ;MEM A DECRE-
                JP      CLEA1           ;MENTO

                
		;MANUALE AUTOMATICO LONGITUDINALE

AUTOC:          LD      A,00H           ;TOLGO USO DELLA                
		LD      (MKBUSY),A      ;TASTIERA
		LD      A,(MEMC)        ;METTO IN AUTOMAT.
		SET     2,A             
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANC:           LD      A,00H           ;TOLGO USO DELLA                
		LD      (MKBUSY),A      ;TASTIERA
                LD      A,(MEMC)        ;METTO IN MANUL.
                RES     0,A
                RES     1,A
                RES     2,A             
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANAVA:         LD      A,(MEMC)        ;SE E' IN AUTO-
                BIT     2,A             ;MATICO SALTO
		JR      NZ,MANEND
		LD      A,(MEMC)
		RES     1,A
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE AVANTI
                IN      A,(PA)
                BIT     4,A
                JR      NZ,MANEND
		LD      A,(HL)
                AND     1FH
                CP      0CH
                JR      Z,MANAVA

MANRIT:         LD      A,(MEMC)        ;SE E' IN AUTO-
                BIT     2,A             ;MATICO SALTA
		JR      NZ,MANEND
		LD      A,(MEMC)
		RES     0,A
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE RITARDO
		IN      A,(PA)
                BIT     4,A
                JR      NZ,MANEND
                LD      A,(HL)
                AND     1FH
                CP      0DH
		JR      Z,MANRIT

MANEND:         LD      A,00H           ;TOLGO L'USO
		LD      (MKBUSY),A      ;DELLA TASTIERA
                CALL    RESEPC          ;FFLL
		JP      ESCI

		;MANULAE AUTOMATICO TRAVERS


AUTOT:          JP      ESCI            ;ELIMINATI NORD

MANT:           JP      ESCI            ;ELIMINATI NORD



MUOVO:          LD      IX,BINSET+06H
		LD      B,(IX+00H)      ;MEMORIZZO I
		LD      C,(IX+01H)      ;NUMERI E LI
		LD      D,(IX+02H)      ;MUOVO VERSO
		LD      E,(IX+03H)      ;SINISTRA
		LD      (IX+00H),A
		LD      (IX+01H),B
		LD      (IX+02H),C
		LD      (IX+03H),D
		LD      (IX+04H),E
		RET

INIZDI:         LD      A,00H
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		RET


PUNTO:         
                CALL    YMNC_015         ;MMMM
                CALL    CENOSC           ;FF55
		CALL	AZZTOT		;FFMM
                LD      A,00H           ;TOLGO L'USO 
                LD      (MKBUSY),A      ;DELLA TASTIERA  

ESCI:
		LD	A,(MOSCI1)	;CONTROLLO SE	PUUU
		CP	01H		;SE SONO PASSATO PUUU
		JR	Z,ALTE1		;DA FUNZ5	PUUU
		JR	ALTE2		;SE SI AUMENTO
ALTE1:					;ALTERR PER
		LD      A,0AH           ;POTER AZZERARE
		LD      (ALTERR),A      ;L'ERRORE	PUUU
		JR	ALTE3		;PUUU
ALTE2:		
		LD      A,02H           ;CARICO IL
		LD      (ALTERR),A      ;BLOCCO ALLE
ALTE3:					;PUUU
		LD      A,0D7H          ;CORREZZIONI
		OUT     (71H),A         ;PER DUE GIRI
		LD      A,01H           ;ALL'USCITA
		OUT     (71H),A         ;DALLA TASTIERA
		LD      A,(MEMA)               
		SET     7,A
		OUT     (PA),A          
		LD      (MEMA),A
		LD      A,(MEM6A)       ;SE FINITA LA
		CP      00H             ;FUNZIONE 6
		JR      NZ,ESCI1        ;RIPARTI DALLO
		POP     IY              ;INIZIO COSI'
		POP     IX              ;AGGIORNA IL
		POP     AF              ;TUTTO.
		POP     HL
		POP     DE
		POP     BC
		JR      ESCI2
ESCI1:          LD      HL,VIA
		EX      (SP),HL
ESCI2:          EI
		RETI



PIOB:           PUSH    BC              
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

                IN      A,(PB)          ;PPUU
                BIT     5,A
                JR      Z,PIOB4         ;PPUU

		LD      A,(ALTERR)      ;QUANDO ALTERR PUUU
		CP      00H             ;ARRIVA A ZERO
		JR      Z,PIOB3         ;RIPRENDE IL
		CP	0BH             ;CALCOLO DELLO
		JR	NC,PIOB6        ;ERRORE
		DEC     A               ;CALCOLO DELLO
		LD      (ALTERR),A      ;ERRORE
		JR	PIOB3
PIOB6:		LD	A,00H
		LD	(ALTERR),A	;PUUU

PIOB3:          LD      A,(ENCOD2)     ;PPDD
                CP      02H
                JR      Z,PIOB1         

		LD      A,0D7H          ;CONTROLLO CTC0
		OUT     (70H),A         ;CARICO AMPIEZZA
		LD      A,(AMPIMP)      ;GATE IN IMPULSI
		OUT     (70H),A         ;ENCODER.
		LD      A,(GUADS1)      ;AMPLIFICAZIONE
		LD      B,A             ;S1
                LD      A,(MEMA)        
		RES     5,A
		RES     6,A
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A          
		LD      A,(MRIC+04H)	;AADD
		CP	01H		;AADD
		JR	NZ,PIOB1	;AADD

                LD      A,0D7H          ;ATTIVO IL CTC3 PER CONTROLLARE SSDD
                OUT     (73H),A         ;IL SEGNO DOPPIO DURANTE IL GATE
                LD      A,02H           ;CIOE' LO ATTIVO A PIOB E LO
                OUT     (73H),A         ;RESETTO ALL'INIZIO DI CTC0
		JR	PIOB1		;SSDD
PIOB4:          
                IN      A,(10H)         ;LEGGO LA POSI- PPUU
		LD      E,A             ;ZIONE
		IN      A,(20H)
		LD      D,A
		LD      (FASE),DE
                CALL    CENTRA        
PIOB1:         
		LD	A,01H		;ABILITA LE ABBB
		LD	(MCALER),A	;MISURE
		POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI






                ;VERIFICA POSIZIONE S1  

CTC0:           PUSH    BC              
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

	        LD      A,(TMEM4)       ;SE ATTIVATA SSDD
                CP      00H             ;CORREZIONE
                JR      NZ,CTC06       ;SALTA 
		LD      A,43H		; SSDD
		OUT     (73H),A		;SSDD
CTC06: 

                LD      A,(ENCOD1)     ;SE NON   
                CP      00H            ;ABILITATO
                JR      Z,CTC01        ;SALTA   
                CP      01H
                JP      Z,CTC018
                LD      A,(ENCOD2)     ;INCREMENTO
                INC     A              ;A OGNI 255
                LD      (ENCOD2),A     ;IMPULSI
                LD      A,0DFH         ;RICARICO CTC0 
		OUT     (70H),A
                LD      A,0FFH
                OUT     (70H),A
                JP      CTC018          

CTC01:          IN      A,(30H)         ;LEGGO IL VALORE
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
                LD      (MPIEN1),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)         ;DI S1
		LD      D,A
                LD      (MPOSI1),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S1
		LD      D,A
                LD      (MASES1),DE

                LD      A,(MEM5)        ;FF55
                CP      01H
                JR      NZ,CTC020       ;FF55
                CALL    SPOFAS
                JP      CTC011          ;FF55


CTC020:                                 ;FF55
                OUT     (52H),A         
		LD      A,(MEMC)        ;SE SONO IN MA-
		BIT     2,A             ;NUALE SALTO
                JR      Z,CTC02
		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
                JR      Z,CTC02         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
		CALL    NOPRI                    
CTC02:        
              
                IN      A,(PB)
		BIT     3,A
                JR      Z,CTC04
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOMAT.
                JR      Z,CTC03         ;SALTA
		CALL    GAINS1

CTC03:          LD      A,(MEMC)        ;SE ATTIVO NORD

                BIT     7,A             ;F9 SALTO NORD
                JP      NZ,CTC018

                CALL    RESEPC          ;FFLL


                JP      CTC018          
CTC04:          LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
                LD      A,(MEMC)        
                BIT     5,A
                JR      NZ,CTC05        
                LD      DE,(MPIEN1)
                LD      (PIENO1),DE
                LD      DE,(MPOSI1)
                LD      (POSIZ1),DE
                LD      DE,(MASES1)
		LD      (FASES1),DE
                JR      CTC08                  
CTC05:          LD      DE,(MPIEN1)
                LD      (TPIEN1),DE
                LD      DE,(MPOSI1)
                LD      (TPOSI1),DE
                LD      DE,(MASES1)
                LD      (TASES1),DE     


CTC08:          OUT     (52H),A         ;STABILE DA 0,5 mS
		LD      A,(MEMC)        ;SE SONO IN MA-
		BIT     2,A             ;NUALE SALTO
                JR      Z,CTC09
		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
                JR      Z,CTC09         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
		CALL    NOPRI
CTC09:         
                IN      A,(PB)
		BIT     3,A
                JR      Z,CTC010
		LD      A,(MEMC)

                BIT     7,A             ;SE ATTIVO NORD
                JP      NZ,CTC018       ;F9 SALTO

                CALL    RESEPC          ;FFLL

                JP      CTC018          
CTC010:         LD      A,(MEMA)
		RES     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
CTC011:         LD      HL,(FASE)       ;CARICO IL 
		LD      A,H             ;CONTATORE PER
		OUT     (20H),A         ;LEGGERE POI S1
		LD      A,L
		OUT     (10H),A         
		LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
CTC012:         LD      A,(MRIC+00H)
                CP      00H
                JR      NZ,CTC018

CTC019:         LD      A,(MEMC)        ;SALTO PER
                BIT     7,A             ;FUNZ9 NORD
                JR      NZ,CTC018       ;MECCANICA.

                LD      BC,0474H        ;16mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
CTC013:         IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,CTC014       ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO

CTC014:         DEC     BC              
                LD      A,B
                OR      C
                JR      NZ,CTC013       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.
                LD      A,(MEMC)        ;SE E'IN MANUALE
		BIT     2,A             ;SALTO
                JR      Z,CTC017
                LD      IX,TRIP         
                LD      A,(IX)          ;SE TRIP
                CP      00H             ;= ZERO NON
                JR      Z,CTC017        ;OPERA

CTC015:
                LD      A,(PROTEZ)      ;SE IN PROTE- TVVV
                CP      01H             ;ZIONE SALTA
                JR      Z,CTC017        ;TVVV

                LD      HL,(VELMED)     ;CONTROLLO SE
                LD      DE,(VELPRE)     ;TRA LA NUOVA 
                SBC     HL,DE           ;E LA VECCHIA 
                JR      C,CTC016        ;VELOCITA'C'E' 
                LD      A,L             ;UN DIFFERENZA
                CP      (IX)            ;TRIP IN METRI 
                JP      M,CTC017        ;IN PIU' CHE
                CALL    ACCEL           ;MENO SE C'E'
                JR      CTC017          ;BLOCCO CON
CTC016:         CCF                     ;LA SCRITTA  
                LD      HL,(VELPRE)     ;APPROPIATA
                LD      DE,(VELMED)
                SBC     HL,DE
                LD      A,L
                CP      (IX)                         
                JP      M,CTC017
                CALL    DECEL
CTC017:         LD      DE,(VELMED)
                LD      (VELPRE),DE
CTC018:
	        LD      A,(MOSCI1)      ;FF57
                CP      01H
                JR      NZ,CTC021       ;FF57
		LD	A,(MEMRIF)	;ASPETTO UN
		DEC     A		;GIRO PER
		LD	(MEMRIF),A	;CENTRARE
		CP	00H
		JR	NZ,CTC021
                CALL    CENTRO          ;FF57            
                LD      A,00H           ;FF57
                LD      (MOSCI1),A      ;FF57

CTC021:					;FF57
	        POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI



		;CONTEGGIO GIRI ALL'USCITA DALLA TASTIERA
		

CTC1:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
		LD      A,(ENCOD1)      ;VEDO SE SONO
		CP      00H             ;IN TEST
                JR      Z,CTC16         ;ENCODER
		CP      01H
                JR      Z,CTC17
		CP      02H
                JR      Z,CTC18
CTC17:          LD      A,02H           ;PARTENZA TEST
		LD      (ENCOD1),A
                LD      HL,ENC2
                JR      CTC14           
CTC18:          LD      HL,ENC6         ;FINE TEST                        
                JR      CTC14           
CTC16:          LD      A,(MRIC+00H)    ;CONTROLLA
		CP      01H             ;SE FALLITA
		JR      Z,CTC12         ;RICERCA CODICE
		LD      A,(ALTERR)      ;QUANDO ALTERR
		CP      00H             ;ARRIVA A ZERO
		JR      Z,CTC10         ;RIPRENDE IL
		DEC     A               ;CALCOLO DELLO
		LD      (ALTERR),A      ;ERRORE
		JR      CTC11
CTC10:          LD      A,43H
		OUT     (71H),A
CTC11:          POP     IY                
		POP     IX              
		POP     AF
		POP     HL
		POP     DE      
		POP     BC
		JR      CTC15
CTC12:          CALL    GAINS1         
                LD      A,(MRIC+02H)
		DEC     A
		LD      (MRIC+02H),A
		CP      00H
		JR      NZ,CTC13
		LD      A,01H           ;SEGNALO
		LD      (MDATER),A      ;RICERCA FALLITA
		LD      A,00H           ;E LA ANNULLO
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      A,43H
		OUT     (71H),A
                LD      HL,MAIN         ;RIPARTO DA   DD11
		JR      CTC14           ;MAIN
CTC13:          CALL    GAINS1
                LD      HL,CODICE
CTC14:          POP     IY              
		POP     IX              
		POP     AF
		POP     DE      
		POP     BC
		EX      (SP),HL
CTC15:          EI              
		RETI




CTC2:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

                LD      A,(DECORR)      ;SE EXTRA 
                CP      00H             ;CORREZIONE 
                JR      NZ,CTC21        ;ATTIVA SALTO.
CTC23:          LD      A,(MEMC)        ;FINE DELLA
		RES     0,A             ;CORREZIONE
		RES     1,A
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,43H           ;RESETTO
		OUT     (71H),A         ;CTC1
		OUT     (72H),A         ;CTC2
                JR      CTC22           
CTC21:          LD      A,37H           ;CONTROLLO CTC1
		OUT     (71H),A         
                LD      A,40H           ;COSTANTE DI
		OUT     (71H),A         ;TEMPO
                LD      A,0D7H          ;CONTROLLO CTC2
                OUT     (72H),A         ;CARICO PER 
                LD      A,0FFH          ;EXTRA CORREZ.
		OUT     (72H),A

                LD      A,(DECORR)      ;SE E' MAGGIORE 
                DEC     A               ;DI UNO LA CORREZ-
                LD      (DECORR),A      ;ZIONE DIVENTA
                CP      00H             ;CONTINUA
                JR      NZ,CTC22

                LD      A,(CIDE75)      ;SE FATTO 75% 
                CP      00H             ;DEL CICLO
                JR      Z,CTC23         ;BLOCCO CORREZ.



CTC22:          POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE      
		POP     BC
		EI
		RETI


CTC3:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
                PUSH    IY
                LD      A,(TMEM4)       ;SE ATTIVATA 
                CP      00H             ;CORREZIONE
                JP      NZ,CTC32        ;SALTA      
CTC34:		
		DI			;SSDD
		LD      A,(LINGUA)
                CP      00H
                JR      Z,ATEM
                CP      01H
                JR      Z,ATEI
                CP      02H
                JR      Z,ATEF
                CP      03H
                JR      Z,ATEGB
                CP      04H
                JR      Z,ATEE
                CP      05H
                JR      Z,ATED
ATEM:           CALL    INISI
                LD      HL,OCIO
                JR      ATETX
ATEI:           CALL    INISI
                LD      HL,OCIO+14H
                JR      ATETX
ATEF:           CALL    INISI
                LD      HL,OCIO+28H
                JR      ATETX
ATEGB:          CALL    INISI
                LD      HL,OCIO+3CH
                JR      ATETX
ATEE:           CALL    INISI
                LD      HL,OCIO+50H
                JR      ATETX
ATED:           CALL    INISI
                LD      HL,OCIO+64H
ATETX:          CALL    TX              


                LD      A,(LINGUA)
		CP      00H
                JR      Z,DOPM
		CP      01H
                JR      Z,DOPI
		CP      02H
                JR      Z,DOPF
		CP      03H
                JR      Z,DOPGB
                CP      04H
                JR      Z,DOPE
		CP	05H
		JR	Z,DOPD
                JR      DOPFIN
DOPM:           CALL    BASSA
                LD      HL,DOPPIO
                JR      DOPTX
DOPI:           CALL    BASSA
                LD      HL,DOPPIO+14H
                JR      DOPTX
DOPF:           CALL    BASSA
                LD      HL,DOPPIO+28H
                JR      DOPTX
DOPGB:          CALL    BASSA
                LD      HL,DOPPIO+3CH
                JR      DOPTX
DOPE:           CALL    BASSA
                LD      HL,DOPPIO+50H
DOPD:           CALL    BASSA
                LD      HL,DOPPIO+64H
DOPTX:          CALL    TX

DOPFIN:					;SSDD
	        LD      BC,0FFFFH
DOPRIT:         DEC     BC
		LD      A,B
		OR      C
		JR      NZ,DOPRIT

		CALL    SERITA          ;SSDD

                LD      A,(HL)          ;SE TASTO CANC SSDD
                AND     1FH             ;PIGIATO CANCELLA
                CP      0AH             ;
                JR      Z,CTC31
	        CP      0BH             ;
                JR      Z,CTC31
		JP	CTC34
CTC32:        
		LD      BC,(TMEM5)       ;CONTIENE IL
                DEC     BC               ;VALORE 
                LD      (TMEM5),BC       ;DELL'ERRORE
                LD      A,B
                OR      C
                JR      NZ,CTC31        ;
CTC33:         
		LD      A,(MEMC)        ;FINITO IL DE-  
                RES     6,A             ;CREMENTO DELLO
                RES     7,A             ;ERRORE TOGLI
                LD      (MEMC),A        ;LE CORREZIONI.
		OUT     (PC),A
		LD      A,43H
		OUT     (73H),A
		LD      A,00H
		LD      (TMEM4),A
CTC31:         
		POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI






		;CONVERSIONE BCD BINARIO PER 10 DIGIT

                

BCDBIN:         EXX        
		LD      IX,BINSET+06H
		LD      A,(IX+03H)
		RL      A
		RL      A
		RL      A
		RL      A
		ADD     A,(IX+02H)
		LD      IY,TABCON
		LD      (IY+05H),A
		LD      A,(IX+01H)
		RL      A
		RL      A
		RL      A
		RL      A
		ADD     A,(IX+00H)
		LD      (IY+04H),A
		LD      A,00H
		LD      (IY+06H),A
		LD      (IY+07H),A
		LD      (IY+08H),A
		LD      C,20H
DBLP:           LD      B,05H
		XOR     A
		LD      HL,TABCON+08H
COR0:           LD      A,(HL)
		RRA
		PUSH    AF
		BIT     7,A
		JR      Z,COR1
		SUB     30H
COR1:           BIT     3,A
		JR      Z,COR2
		SUB     03H
COR2:           LD      (HL),A
		DEC     HL
		POP     AF
		DJNZ    COR0
		LD      B,04H
SHR4:           RR      (HL)
		DEC     HL
		DJNZ    SHR4
		DEC     C
		JR      NZ,DBLP
                LD      A,(BINSET+10H)  ;MEMORIZZO IL
		CP      39H             ;VALORE DELLA 
		JR      Z,LETTC         ;FUNZIONE NELLA
		CP      77H             ;SUA MEMORIA
		JR      Z,LETTA
		CP      73H
		JR      Z,LETTP
		CP      50H
		JR      Z,LETRU
		CP      1CH
		JR      Z,LETRU
		CP      40H
		JR      Z,LEMEN
		CP      70H
		JR      Z,LEPIU
                CP      3FH
                JP      Z,LETTO         
                CP      78H
                JP      Z,LETTT         
                JR      LETT2
LETTC:          LD      HL,(TABCON)
		LD      (CILIN),HL
                JR      LETT2
LETTA:          LD      HL,(TABCON)
		LD      (ALLAR),HL
                JR      LETT2
LETTP:          LD      HL,(TABCON)
                LD      (AMPGA),HL              
                JR      LETT2
LETRU:          LD      HL,(TABCON)
		LD      (LAVORO),HL
                JR      LETT2
LEMEN:          LD      HL,(TABCON)
		LD      (SHIFT),HL
                LD      (TSHIFT),HL     
                
                LD      A,(BINSET+10H)  ;DI SHIFT SUL
                LD      (PIUMEN),A      ;DISPLAY
                LD      A,3FH           
                LD      (TIUMEN),A      
                JR      LETT2
LEPIU:          LD      HL,(TABCON)
		LD      (SHIFT),HL
		LD      A,(BINSET+10H)
		LD      (PIUMEN),A
                LD      A,78H           
                LD      (TIUMEN),A      

LETT2:          LD      DE,(SHIFT)      ;SE E'IN AUTO 
                LD      HL,(AMPI40)     ;MENTI MASSIMI 
                SBC     HL,DE           ;GATE
		JR      NC,LETT1
		CCF
		LD      A,01H
                LD      (SUPCOR),A      ;LD      (MDATER),A

                LD      HL,(SHIFT)      ;VEDO QUANTE 
                LD      (DIVDEN),HL     ;VOLTE AMPI40
                LD      BC,(AMPI40)     ;STA IN SHIFT
                LD      (DIVSOR),BC     ;E LO MEM. IN
                CALL    DIVIS           ;SHIFT3
                LD      BC,(QUOZIE)
                LD      (SHIFT3),BC     ;IL RESTO LO
                LD      BC,(RESTO)      ;MEM IN SHIFT4
                LD      (SHIFT4),BC     ;
                LD      HL,(SHIFT)      ;SLAVO LA SUPER 
                LD      DE,(AMPI40)
                SBC     HL,DE
                JR      NC,LETT3
                CCF
                LD      A,01H
                LD      (MDATER),A
                JR      LETT1

LETT3:          LD      DE,(AMPI40)     ;CARICO IL MAX 
                LD      (SHIFT),DE      ;ACCETTABILE 
		JR	LETT1
LETTO:          LD      HL,(TABCON)
		LD      (TSHIFT),HL
		LD      A,(BINSET+10H)
		LD      (TIUMEN),A
		JR      LETT1
LETTT:          LD      HL,(TABCON)
		LD      (TSHIFT),HL
		LD      A,(BINSET+10H)
		LD      (TIUMEN),A
LETT1:          EXX
		RET


		;CALCOLO CENTRATURA GATE

              

CENTRA:         EXX
		LD      HL,(FASE)       ;SOTTRAGGO IL VA-
                LD      BC,(MEZGA)     ;LORE DI 1/2 GATE 
                ;LD      B,00H
		SBC     HL,BC           ;SE IL RISULTATO
		JR      C,RISNEG        ;E'POSITIVO LO
		JR      TRFASE          ;MEMORIZZO IN
RISNEG:         CCF                     ;IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
		LD      BC,(FASE)       ;IL 1/2 GATE E IL
		ADD     HL,BC           ;RESTO LO SOMMO
TRFASE:         LD      (FASE),HL       ;AL VALORE LETTO.
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,04H           ;4 GIRI ATTESA
		LD      (MEMRIF),A      ;PER MEMORIZZARE
		EXX                     ;IL RIFERIMENTO
		RET

		;CALCOLO DELLO SPOSTAMENTO REGISTRO E GATE

                

SPOSTA:         EXX
                LD      BC,(SHIFT)      ;SHIFT x 10 = A
		LD      (MOLTI),BC
                LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;FLO2 = A
		LD      (DIVDEN),DE     ;A : CENTES = B
		LD      BC,(CENTES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)     ;FLO2 = B
		LD      A,(PIUMEN)
		CP      70H
		JR      Z,SPOMEN
		LD      HL,(RIFTOT)
		ADD     HL,DE           ;RIFTOT + B = C
		EX      DE,HL           ;SE C < 40960 
		LD      HL,0A000H       ;ALLORA C = Z
		SBC     HL,DE           ;SE C > 40960
		EX      DE,HL           ;SI FARA'
		JR      NC,SPOFIN       ;C - 40960 = Z
		CCF
		LD      DE,0A000H
		SBC     HL,DE
		JR      SPOFIN
SPOMEN:         LD      HL,(RIFTOT)     ;RIFTOT - B = C
		SBC     HL,DE           ;SE C = POSITIVO
		JR      NC,SPOFIN       ;C = Z
		CCF                     ;SE C = NEGATIVO
		LD      HL,0A000H       ;SI FARA'
		SBC     HL,DE           ;40960 - B = D
		LD      DE,(RIFTOT)     ;D + RIFTOT = Z
		ADD     HL,DE
SPOFIN:         LD      (RIFTOT),HL     ;FLO2 = Z

		;RIFTOT/10=POSIZIONE ENCODER
		;POSIZIONE ENCODER - 1/2GATE = NUOVA FASE

		LD      (DIVDEN),HL
		LD      BC,000AH
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      DE,(QUOZIE)
                LD      BC,(MEZGA)     ;
		SBC     HL,BC
		JR      C,RISNE1
		JR      TRFAS1
RISNE1:         CCF                     ;SE 1/2GATE > DI
		LD      HL,1000H        ;QUOZIE ALLORA
		SBC     HL,BC           ;4096-1/2GAT = A
		ADD     HL,DE           ;A + QUOZIE=FASE
TRFAS1:         LD      (FASE),HL
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A


TRFAS2:         EXX
		RET


		;ROUTINE SCRITTA ERRORE

                

ERROR:          LD      A,(LINGUA)
                CP      00H
                JR      Z,ERRM
                CP      01H
                JR      Z,ERRI
                CP      02H
                JR      Z,ERRF
                CP      03H
                JR      Z,ERRGB
                CP      04H
                JR      Z,ERRE
                CP      05H
                JR      Z,ERRD
ERRM:           CALL    BASSA
                LD      HL,ERRORE
                JR      ERRTX
ERRI:           CALL    BASSA
                LD      HL,ERRORE+14H
                JR      ERRTX
ERRF:           CALL    BASSA
                LD      HL,ERRORE+28H
                JR      ERRTX
ERRGB:          CALL    BASSA
                LD      HL,ERRORE+3CH
                JR      ERRTX
ERRE:           CALL    BASSA
                LD      HL,ERRORE+50H
                JR      ERRTX
ERRD:           CALL    BASSA
                LD      HL,ERRORE+64H
ERRTX:          CALL    TX              
		LD      A,01H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR.
		RET


		;ROUTINE SCRITTURA NO PRINT


NOPRI:
		             
		CALL	VELIST
		CALL	SCRITD
		LD      A,(MEMC)        ;METTO LA
                BIT     7,A             ;SE ATTIVO NORD
                JP      NZ,NOPFUN       ;F9 SALTO

                LD      A,(ALLAR)       ;SE ALLARME E'   BBLL
		CP      00H             ;MESSO A ZERO
                JR      Z,NOPRI2        ;SALTA.
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
                JR      Z,NOPRI2

                LD      HL,(ISTVEL)     
                LD      DE,(INSER)      
                SBC     HL,DE            
                JR      C,NOPRI3         ;BBLL

                LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
                JR      NOPRI2

NOPRI3:
                CCF                     ;BBLL
                LD      A,(MEMC)
                RES     3,A             ;DISATTIVO 
                LD      (MEMC),A        ;ALLARME
                OUT     (PC),A          ;BBLL

NOPRI2:                                 ;BBLL
               
		LD	A,(MEMC)	;CCCC
		SET	4,A		;CCCC
		LD	(MEMC),A	;CCCC
		
		LD	A,(MEMC)	;CCCC
		BIT	7,A
		JR	NZ,NOPFUN	;CCCC


                LD      A,(LINGUA)
		CP      00H
                JR      Z,NOPM
		CP      01H
                JR      Z,NOPI
		CP      02H
                JR      Z,NOPF
		CP      03H
                JR      Z,NOPGB
                CP      04H
                JR      Z,NOPE
                CP      05H
                JR      Z,NOPD          ;DDDD

                JR      NOPFIN
NOPM:           CALL    BASSA            ;INISI  TTVV          ;FFLL
                LD      HL,NOSTAM
                JR      NOPTX
NOPI:           CALL    BASSA            ;TTVV       INISI            ;FFLL
                LD      HL,NOSTAM+14H
                JR      NOPTX
NOPF:           CALL    BASSA            
                LD      HL,NOSTAM+28H
                JR      NOPTX
NOPGB:          CALL    BASSA            
                LD      HL,NOSTAM+3CH
                JR      NOPTX
NOPE:           CALL    BASSA            
                LD      HL,NOSTAM+50H
                JR      NOPTX
NOPD:           CALL    BASSA
                LD      HL,NOSTAM+64H

NOPTX:          CALL    TX

        	LD      A,01H           ;FFLL
                LD      (PROTEZ),A      ;FFLL
         
NOPFIN:         CALL    FLASH           ;  xxxx    FFLL

	
		LD	A,(MEMC)	;VVVV
		RES	0,A		;VVVV
		RES	1,A		;VVVV
		RES	6,A		;VVVV
		RES	7,A
		LD	(MEMC),A	;VVVV
		OUT	(PC),A		;VVVV
	
                JR      NOPRI1	        ;NO F9 SALTO VVVV
NOPFUN:
	        LD      A,(LINGUA)      ;NORD
		CP      00H
                JR      Z,NOVM
		CP      01H
                JR      Z,NOVI
		CP      02H
                JR      Z,NOVF
		CP      03H
                JR      Z,NOVGB
                CP      04H
                JR      Z,NOVE
                CP      05H
                JR      Z,NOVD
NOVM:           CALL    INISI
                LD      HL,FNOVE
                JR      NOVTX

NOVI:           CALL    INISI
                LD      HL,FNOVE+14H
                JR      NOVTX
NOVF:           CALL    INISI
                LD      HL,FNOVE+28H
                JR      NOVTX
NOVGB:          CALL    INISI
                LD      HL,FNOVE+3CH
                JR      NOVTX
NOVE:           CALL    INISI
                LD      HL,FNOVE+50H
                JR      NOVTX
NOVD:           CALL    INISI
                LD      HL,FNOVE+64H
NOVTX:          CALL    TX
                CALL    BASSA
                LD      HL,SOLBAS
                CALL    TX
		CALL	RITDIS		;SSDD
		JR	NOFIN1          ;VVVV	 

NOPRI1:         
                
		LD	A,(MEMC)
		BIT	7,A
		JR	NZ,NOPRI7
		RES	0,A
		RES	1,A
		SET	4,A
		RES	6,A
		;RES	7,A
		JR	NOPRI8
NOPRI7:
		RES	0,A
		SET	1,A
		SET	4,A
NOPRI8:
		LD	A,(MEMC)
		OUT	(PC),A
                LD      A,0AH
                LD      (ALTERN),A
   	        
NOFIN1:
		RET



		;ROUTINE SCRITTURA LOW-SPEED
                

LOWSPE:

                CALL    RESEPC          ;FFLL

                CALL    VELIST         ;BBLL TTVV
                CALL    SCRITD         ;TTVV CALL    DISPLD  ;TTVV


LOWSP1:         LD      A,(LINGUA)      ;FFLL
		CP      00H
                JR      Z,LOWM
		CP      01H
		JR      Z,LOWI
		CP      02H
                JR      Z,LOWF
		CP      03H
                JR      Z,LOWGB
                CP      04H
                JR      Z,LOWE
                CP      05H             ;DDDD
                JR      Z,LOWD

		JR      LOWFIN
LOWM:           CALL    BASSA            ;TTVV
                LD      HL,VADASI
                JR      LOWTX
LOWI:           CALL    BASSA            ;TTVV
                LD      HL,VADASI+14H
                JR      LOWTX
LOWF:           CALL    BASSA
                LD      HL,VADASI+28H
                JR      LOWTX
LOWGB:          CALL    BASSA
                LD      HL,VADASI+3CH
                JR      LOWTX
LOWE:           CALL    BASSA
                LD      HL,VADASI+50H
                JR      LOWTX
LOWD:           CALL    BASSA
                LD      HL,VADASI+64H

LOWTX:          CALL    TX

                LD      A,01H           ;FFLL
                LD      (PROTEZ),A      ;FFLL

                CALL    FLASH           ;xxxxTVVV
                

LOWFIN:         RET



;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& NNDD
;		CONTROLLO ZONA MORTA
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


CORREZ:         LD      HL,(ERMEDI)     ;SE ZONA MORTA E'
		LD      DE,(ZONA)       ;> DELL'ERRORE
		SBC     HL,DE           ;NON CORREGGO
		JR      NC,CORREZIONI_1
		CCF
		LD      A,(MEMC)        
		RES     0,A             
		RES     1,A             
		LD      (MEMC),A        
		OUT     (PC),A          
		JP      CORREZIONI_END


		;#####################################################################
		;# CALCOLO CORREZIONE MOTORE                                         #
		;# [Ea x C/10 + (Ea - Ep) x D] x G                                   #
		;# [Ea x (C/10 + D) x G] - [Ep x D x G]	                             #
		;# CORRATT = 80000000h + [Ea x (C/10 + D) x G] - [Ep x D x G]        #
		;#####################################################################


CORREZIONI_1:   
		;[Ea x (C/10 + D) x G]
		LD      DE,(CILDIV)	
		LD	HL,(DERIVA)
		ADD	HL,DE		;HL = C/10+D
		LD	(MDO032),HL
		LD	HL,(GUADA)	;HL = G
		LD	(MRE032),HL
		LD	HL,0000H
		LD	(MDO232),HL
		LD	(MRE232),HL
		CALL	MOL32		;PT = (C/10+D)*G
		LD	HL,(PTO032)
		LD	(MDO032),HL
		LD	HL,(PTO232)
		LD	(MDO232),HL
		LD	HL,(ERATTU)	;HL = Ea
		LD	(MRE032),HL	
		CALL	MOL32		;PT = [Ea x (C/10 + D) x G]

		LD      A,(MSCORR_ATT)	
		CP      01H        
		JR      Z,CORREZIONI_2	

		;CORRATT = 80000000h - [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(CUBTR2),HL
		LD	HL,0000H	;MINUENDO = 80000000h
		LD	(CINUE0),HL
		LD	HL,8000H
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3

CORREZIONI_2:
		;CORRATT = 80000000h + [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(ADDEN0),HL	;ADDENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(ADDEN2),HL
		LD	HL,0000H	;AUGEND0 = 80000000h
		LD	(AUGEN0),HL
		LD	HL,8000H
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3
		

CORREZIONI_3:
		;[Ep x D x G]
		LD      HL,(ERPREC)     
		LD      (MOLTI),HL
		LD      A,(DERIVA)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)      
		LD      (MOLT24),HL       ;RISULTATO
		LD      A,(GUADA)
                LD      (MOLP24),A      
                CALL    MOL24

		LD      A,(MSCORR_PREC)	
		CP      01H        
		JR      Z,CORREZIONI_4	

		;CORRATT = CORRATT + [Ep x D x G]
		LD	HL,(CORRATT)
		LD	(ADDEN0),HL	;ADDENDO = CORRATT
		LD	HL,(CORRATT+02H)
		LD	(ADDEN2),HL
		LD	HL,(PROD24)	;AUGEND0 = [Ep x D x G]
		LD	(AUGEN0),HL
		LD	HL,(PROD24+02H)
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_5

CORREZIONI_4:
		;CORRATT = CORRATT - [Ep x D x G]
		LD	HL,(PROD24)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ep x D x G]
		LD	HL,(PROD24+02H)
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO

		JR	CORREZIONI_5
CORREZIONI_5:
		LD	A,(CORRATT+03H) ;IF CORRATT > 80000000h THEN MSCORR=D_AVANTI ELSE MSCORR=D_RITARDO
		BIT	7,A
		JR	Z,CORREZIONI_6

		LD      A,01H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_6:
		LD      A,08H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_7:	
		LD	HL,0000H
		LD	(CUBTR0),HL	;SOTTRAENDO = 80000000h
		LD	HL,8000h
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		
CORREZIONI_8:		

		LD      A,(CORRATT+03H)
		AND	7FH
		CP	00H
		JR	Z,CORREZIONI_9
                LD      BC,0FFFFH
                LD      A,0FFH
		JR	CORREZIONI_10
CORREZIONI_9:
                LD      BC,(CORRATT)
                LD      A,(CORRATT+02H)
		JR	CORREZIONI_10
CORREZIONI_10:

                LD      (MDECOR),A      ;VALORE PER 
                CP      00H             ;EXTRA CORREZ.
                JR      NZ,CORREZIONI_11

                LD      A,B

                LD      (CORRE),A
                JR      CORREZIONI_12          
CORREZIONI_11:  LD      A,0FFH
                LD      (CORRE),A



		;ROUTINE DI CORREZIONE


CORREZIONI_12:  LD      A,(CIDE75)      ;DECREMENTO 
                CP      00H             ;DEL 75% DEL
                JR      Z,CORREZIONI_13        ;CICLO
                DEC     A
                LD      (CIDE75),A


CORREZIONI_13:       

		LD      A,(MATTES)		;CONTROLLO CICLO
		DEC     A			;DI ATTESA
		LD      (MATTES),A
		CP      00H
		JP      NZ,CORREZIONI_END

                LD      A,(CICL75)		;RICARICO IL 
                LD      (CIDE75),A		;75% DEL CICLO 

                LD      A,(CICLO)		;RICARICO IL CI-
		LD      (MATTES),A		;CLO DI ATTESA.

                LD      HL,(ERMEDI)
		LD      DE,(ZONA)
		SBC     HL,DE			;SE ZONA MORTA
		JR      NC,CORREZIONI_14		;MAGGIORE DI
		CCF				;ERMEDI SALTO
		JP      CORREZIONI_END
CORREZIONI_14:         
		LD	A,(MEMC)		;SE SONO IN 
		BIT	2,A			;MANUALE SALTO
		JP      Z,CORREZIONI_END

                LD      A,(CORRE)
                CP      00H			;SALTO
                JP      Z,KRAPIN        

                LD      A,(MDECOR)
                LD      (DECORR),A


                LD      A,37H			;CONTROLLO CTC1   
		OUT     (71H),A         
                LD      A,40H			;COSTANTE DI TEMPO
		OUT     (71H),A			
		LD      A,0D7H			;CONTROLLO CTC2
		OUT     (72H),A
                LD      A,(CORRE)		;MSB ERRORE  
                OUT     (72H),A


		LD      A,(MSCORR)		;VEDO IN CHE
		CP      01H		;SENSO CORREG.
		JR      NZ,AUTRIT

AUTAVA:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     1,A		;AVANTI
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A
	        LD      A,114           
                LD      (SIMCOL),A

		JR      CORREZIONI_END

 
AUTRIT:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     0,A             ;RITARDO
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,97            
                LD      (SIMCOL),A
COFINE:         RET

		
CORREZIONI_END:         
		RET
;****************************************************************** NNDD



KRAPIN:        
		LD      A,(MEMC)        ;QUANDO L'ERRORE 
                RES     0,A             ;E' A ZERO
                RES     1,A             ;SI ANNULLA 
                RES     6,A             ;TUTTO PER
                RES     7,A             ;EVITARE CHE
                LD      (MEMC),A        ;AVVENGANO
                OUT     (PC),A          ;CORREZZIONI
                LD      A,43H           ;INDESIDERATE
                OUT     (71H),A         ;COME A KRAPINA
                OUT     (72H),A
                RET                     






                ;CALCOLO ERRORE MEDIO PER CORREZIONE LONG


LMEDIA:
                LD      A,(PRIMOB)      ;WWAA
                LD      B,A
                
                LD      IX,MAVA00               ;+5CH     ;DMEP1C WWAA   ;SU SEDICI
                LD      DE,(VALORX)
                ADD     IX,DE
LMED01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    LMED01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      A,(PRIMOB)      ; LD      B,2FH           ;WWAA
                LD      B,A             ;WWAA
                LD      IY,MRIT00       ;+5CH   ;DMED1C       WWAA
                LD      DE,(VALORX)     ;WWAA
                ADD     IY,DE           ;WWAA
LMED02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;16 CELLE
                DEC     IY
                DEC     IY
                DJNZ    LMED02
                INC     IY
                INC     IY


                LD      DE,(ERATTU)      ;WWAA LD      DE,(ERMEDI)    INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 16 CELLE
                JR      Z,LMED04
LMED03:
                LD      (MAVA00),DE
                LD      (MRIT00),BC
                JR      LMED05
LMED04:         
                LD      (MAVA00),BC
                LD      (MRIT00),DE
LMED05:
                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,LMED06       ;48 CELLE 16 CELLE TMEPXX WWAA
                CCF                      ; 
LMED06:         LD      HL,0000H
LMED07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    LMED07
                LD      (SOMLO1),HL

                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H            ;SOMMA DELLE  16 celle reali WWAA
                JR      NC,LMED08        ;48 CELLE 16 CELLE DTEDXX    WWAA
                CCF
LMED08:         LD      HL,0000H
LMED09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    LMED09

                LD      (SOMLO2),HL
                LD      DE,(SOMLO1)
		SBC     HL,DE
                JR      C,LMED10        ;SIMBOLO ERRORE
                LD      A,114           ;r RITARDO
                LD      (SIMCOL),A
                LD      A,105           ;i
                LD      (SIMCOL+01H),A
                LD      A,116           ;t
                LD      (SIMCOL+02H),A
                JR      LMED11 
LMED10:         CCF
                LD      A,97            ;a SIMBOLO ERRORE
                LD      (SIMCOL),A      ;AVANTI
                LD      A,118           ;v
                LD      (SIMCOL+01H),A
                LD      A,97            ;a
                LD      (SIMCOL+02H),A
		EX      DE,HL
                LD      DE,(SOMLO2)
		SBC     HL,DE
LMED11:         LD      (DIVDEN),HL
                LD      BC,(SECONB)     ;DIVISIONE    WWAA
                LD      B,00H           ;WWAA
                LD      (DIVSOR),BC     ;PER XX GGAA
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (ERMEDI),HL

LMED12:         LD      DE,0000H
		SBC     HL,DE
                JR      NZ, LMED13 
                LD      A,32            ;NO ERRORE MMDD11  
                LD      (SIMCOL),A
                LD      (SIMCOL+01H),A
                LD      (SIMCOL+02H),A

LMED13:         


                ;MEDIA ERRORE SU QUATTRO PER DISPLY LONGITUDINALE
		
	       
                LD      B,03H           ;FFFE        0FH           ;WWAA 
                LD      IX,DAVA00       ;
                LD      DE,0004H        ;FFFE     ;001CH
                ADD     IX,DE
MEDL01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDL01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      B,03H           ;FFFE  0FH           ;WWAA
                LD      IY,DRIT00       ;WWAA
                LD      DE,0004H        ;FFFE     001CH
                ADD     IY,DE           ;WWAA
MEDL02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;4 CELLE
                DEC     IY
                DEC     IY
                DJNZ    MEDL02
                INC     IY
                INC     IY


                LD      DE,(ERMEDI)      ;FFFE  (ERATTU)   INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 4 CELLE
                JR      Z,MEDL04
MEDL03:
                LD      (DAVA00),DE
                LD      (DRIT00),BC
                JR      MEDL05
MEDL04:         
                LD      (DAVA00),BC
                LD      (DRIT00),DE
MEDL05:
                LD      B,04H              ;FFFE 10H            ;SOMMA DELLE  
                JR      NC,MEDL06        ;4 CELLE  WWAA
                CCF                      ; 
MEDL06:         LD      HL,0000H
MEDL07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDL07
                LD      (SOMDL1),HL

                LD      B,04H            ; FFFE  10H            ;SOMMA DELLE   WWAA
                JR      NC,MEDL08        ;4 CELLE  WWAA
                CCF
MEDL08:         LD      HL,0000H
MEDL09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    MEDL09

                LD      (SOMDL2),HL
                LD      DE,(SOMDL1)
                SBC     HL,DE
                JR      C,MEDL10       ;SIMBOLO ERRORE
                JR      MEDL11   
MEDL10:         CCF
		EX      DE,HL
                LD      DE,(SOMDL2)     ;WWAA
		SBC     HL,DE
MEDL11:         LD      (DIVDEN),HL
                LD      BC,0004H        ;FFFE     0010H        ;
                LD      (DIVSOR),BC     ;
                CALL    DIVIS
                LD      DE,(QUOZIE)
                                        ;LD      (ERDILO),HL

                LD      HL,0004H        ;SCRIVO IL 
                SBC     HL,DE           ;SENSO DI
                JR      C,MEDL12        ;CORREZIONE
                LD      A,32            ;QUANDO  
                LD      (SIMCOL),A      ;SUPERA 4  
                LD      (SIMCOL+01H),A   
                LD      (SIMCOL+02H),A  
                JR      MEDL13
MEDL12:
                CCF
MEDL13:
                LD      (BINSET),DE
                LD      (BINSE1),DE

                RET



            

		;MISURA SPAZIO BIANCO

CODICE:         LD      A,(MEMB)        
		SET     6,A             ;BLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
                LD      A,(GUADS1)      ;CARICO 
		LD      B,A             ;GUADAGNO DI
                LD      A,(MEMA)        ;S1 
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A          

                LD      A,0D7H          ;SE DOPO CIRCA 
                OUT     (71H),A         ;9 GIRI RICERCA 
                LD      A,02H           ;FALLITA ESCI
		OUT     (71H),A

		LD	HL,0FFFFH	;VALORE DI WATCH SSDD
START:          
		LD      BC,(BIANCO)	;VALORE DI BIANCO BBBB
		IN      A,(PB)          ;SE STAMPA  ASPETTA
		CALL	WATCH		;WATCH DOG SSDD
		BIT     2,A             ;
		JR      NZ,START
MIS:            IN      A,(PB)                
		BIT     4,A             ;SE 2048 = 0
		JR      Z,MIS           ;ASPETTA
MIS1:           IN      A,(PB)          ;SE 2048 = 1
		BIT     4,A             ;ASPETTA
		JR      NZ,MIS1
		DEC     C               ;CONTEGGIO SPA-
		JR      NZ,MIS          ;ZIO BIANCO
		IN      A,(PB)
		BIT     2,A
		JR      NZ,START

		;MISURA SPESSORE SEGNO
		
SEC:            LD      BC,(UNOMIL)     
TER:            CALL	WATCH		;WATCH DOG SSDD
		IN      A,(PB)          ;SE MANCA
		BIT     2,A             ;STAMPA ASPETTA
		JR      Z,TER
TER1:           IN      A,(PB)
		BIT     4,A
		JR      Z,TER1
TER2:           IN      A,(PB)
		BIT     4,A
		JR      NZ,TER2
		IN      A,(PB)
		BIT     2,A             
		JR      Z,START           
		DEC     C
		JR      NZ,TER1

		;MISURA BIANCO POSTERIORE

                LD      BC,(BIANCO)      ;VALORE BIANCO BBBB
MIS2:           IN      A,(PB)
		BIT     4,A
		JR      Z,MIS2
MIS3:           IN      A,(PB)                
		BIT     4,A
		JR      NZ,MIS3
		DEC     C
		JR      NZ,MIS2
		IN      A,(PB)
		BIT     2,A
		JR      NZ,START
SEC1:           IN      A,(61H)
		LD      E,A
		IN      A,(62H)
		LD      D,A
		LD      (FASE),DE
		LD      A,(MEMB)
		RES     6,A             ;SBLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
		CALL    CENTRA  

                LD      A,(LINGUA)
                CP      00H
                JR      Z,ESEM
                CP      01H
                JR      Z,ESEI
                CP      02H
                JR      Z,ESEF
                CP      03H
                JR      Z,ESEGB
                CP      04H
                JR      Z,ESEE
                CP      05H
                JR      Z,ESED
ESEM:           CALL    BASSA
                LD      HL,ESEGUI
                JR      ESETX
ESEI:           CALL    BASSA
                LD      HL,ESEGUI+14H
                JR      ESETX
ESEF:           CALL    BASSA
                LD      HL,ESEGUI+28H
                JR      ESETX
ESEGB:          CALL    BASSA
                LD      HL,ESEGUI+3CH
                JR      ESETX
ESEE:           CALL    BASSA
                LD      HL,ESEGUI+50H
                JR      ESETX
ESED:           CALL    BASSA
                LD      HL,ESEGUI+64H
ESETX:          CALL    TX              

		LD      A,00H           ;SE RICERCA OK
		LD      (MRIC+00H),A    ;ANNULLO 
		LD      (MRIC+02H),A	;SSDD
		LD      A,43H           ;RESETTO CTC1
		OUT     (71H),A         
		LD      A,(MEMC)        ;TOLOGO EVEN-
		RES     4,A             ;TUALE PROTE-
		LD      (MEMC),A        ;ZIONE
                OUT     (PC),A      
		RET


		;SUBROUTINE DI RITARDO

RIT:            IN      A,(PB)
		BIT     4,A
		JR      Z,RIT
RIT1:           IN      A,(PB)
		BIT     4,A
		JR      NZ,RIT1
		DEC     E
		JR      NZ,RIT
		RET

		;SUBROUTINE DI CONTROLLO CODICE

MARC:           LD      A,(SEGNO)       ;MISURA 2mm IN      
		LD      B,A             ;MODO CHE IN
MAR1:           IN      A,(PB)          ;QUESTO SPAZIO
		BIT     2,A             ;PASSI IL SEGNO
		JR      NZ,RIT0         ;DI CODICE
		BIT     4,A
		JR      Z,MAR1
MAR2:           IN      A,(PB)
		BIT     2,A
		JR      NZ,RIT0
		BIT     4,A
		JR      NZ,MAR2
		DEC     B
		JR      NZ,MAR1
RIT0:           RET

		;ANTI IMPALLAMENTO      ;SSDD
WATCH:					;SSDD
		DEC	HL		;SSDD
		LD	A,H
		OR	L
		JR	Z,WATCH1
		RET
WATCH1:		LD	A,01H
		LD	(DOG),A
		JP	VIA		;SSDD


		;ADEGUAMENTO GUADAGNO AMPLIFICAT. ESTERNO

                
GAINS1:         EXX
		LD      A,(GUADS1)
		CP      60H
		JR      Z,GS11
		CP      40H
		JR      Z,GS12
		CP      20H
		JR      Z,GS13
		CP      00H
		JR      Z,GS14
GS11:           LD      A,40H
		JR      GS15
GS12:           LD      A,20H
		JR      GS15
GS13:           LD      A,00H
		JR      GS15
GS14:           LD      A,60H
GS15:           LD      (GUADS1),A
		EXX
		RET


		;CONTROLLO PARAMETRI E EVENTUALE
		;INSERIMENTO VALORI DI DEFAULT

                
DEFAUL:         LD      IX,TRIP         
		LD      (IX+01H),00H
                LD      A,(IX)
                CP      0FH
                JR      NC,DEF1
		JR      DEF2
DEF1:           LD      A,06H
		LD      (IX),A


DEF2:           LD      IX,GUADA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF3
		CP      64H
                JR      NC,DEF3
                JR      DEF4
DEF3:           LD      A,0AH
		LD      (IX),A
		
DEF4:           LD      IX,CICLO
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF5
		CP      64H
                JR      NC,DEF5
                JR      DEF6
DEF5:           LD      A,03H
		LD      (IX),A
		
DEF6:           LD      IX,DERIVA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF7
		CP      0FFH
                JR      NC,DEF7
                JR      DEF8
DEF7:           LD      A,02H
		LD      (IX),A
		
DEF8:           LD      IX,ZONA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF9
		CP      65H
                JR      NC,DEF9
                JR      DEF10
DEF9:           LD      A,00H
		LD      (IX),A
		
DEF10:          LD      IX,INSER
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF11
                CP      0FFH            ;PPNN
                JR      NC,DEF11
                JR      DEF12
DEF11:          LD      A,0AH
		LD      (IX),A

DEF12:          LD      IX,SALTO
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      0AH
                JR      NC,DEF13
                JR      DEF14           
DEF13:          LD      A,09H
		LD      (IX),A



DEF14:          LD      IX,ZONT
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF15
                CP      65H
                JR      NC,DEF15
                JR      DEF16
DEF15:          LD      A,00H
		LD      (IX),A

DEF16:          LD      IX,LINGUA
		LD      (IX+01H),00H
		LD      A,(IX)
                CP      0FFH            
                JR      Z,DEF17
                CP      06H
                JR      NC,DEF17
                JR      DEF18
DEF17:          LD      A,01H
		LD      (IX),A


DEF18:		LD	A,(OSGAIN)	;PUUU		
		CP	00H
		JR	Z,DEF19
		CP	05H
		JR	NC,DEF19
		JR	DEF20
DEF19:		LD	A,04H
		LD	(OSGAIN),A

                ;AAOO ELIMINATO OSGAIN

DEF20:          LD      A,(GUADS1)      ;SE IN PARTENZA
                CP      00H             ;NON C'E UN
                JR      Z,DEF21         ;VALORE NORMALE
                CP      20H             ;CREA CASINO 
                JR      Z,DEF21         ;IN SERITA.
                CP      40H
                JR      Z,DEF21
                LD      A,60H
                LD      (GUADS1),A
DEF21:          RET



                ;ROUTINE DI DIVISIONE A 16 BIT

                

DIVIS:          EXX
		LD      DE,(DIVDEN)
		LD      BC,(DIVSOR)
DIV16:          XOR     A
		LD      H,A
		LD      L,A
		LD      A,10H
DV0:            RL      E
		RL      D
		ADC     HL,HL
		SBC     HL,BC
		JR      NC,DIV1
		ADD     HL,BC
DIV1:           CCF
		DEC     A
		JR      NZ,DV0
		LD	(RESTO),HL	;SSCC
		EX      DE,HL
		ADC     HL,HL
		LD      (QUOZIE),HL
		EXX
		RET

		;ROUTINE DI MOLTIPLICAZIONE

                

MOLT:           EXX
		LD      DE,(MOLTI)      ;MOLTIPLICANDO
		LD      A,(MOLPL)       ;MOLTIPLICATORE
		LD      HL,00H
		LD      B,08H
MULT:           ADD     HL,HL
		RLA
		JR      NC,CHCNT
		ADD     HL,DE
CHCNT:          DJNZ    MULT            ;SE IL RISULTATO
		CP      00H             ;E'> DI FFFFH IL
		JR      Z,CHC1          ;REGISTRO A SARA'
		LD      HL,0FFFFH       ;DIVERSO DA 0 PER
CHC1:           LD      (PROD),HL       ;CUI CARICA IL MAX
		EXX                     ;(SOLO IN CASO DI
		RET                     ;CORREZ.MOTORE)

		;ROUTINE DI AGGIUSTAMENTO DECIMALE

  
AGGIUS:         LD      A,01H           ; 
                LD      (MAGGIU),A      ; 
                JP      BIN7            ;
AGGIU1:         LD      A,00H           ; 
                LD      (MAGGIU),A      ; 

                LD      A,(MAGGI1)
                CP      01H
                JR      Z,AGGIU2

                LD      IX,QUOZIE
                LD      HL,BINSET+02H   ; 
		RRD

		CP      06H
		JR      Z,PI4
		CP      07H
		JR      Z,PI3
		CP      08H
		JR      Z,PI2
		CP      09H
		JR      Z,PI1
		JR      FINP1
PI4:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0004H
		ADD     HL,BC
		JR      FINP0
PI3:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0003H
		ADD     HL,BC
		JR      FINP0
PI2:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0002H
		ADD     HL,BC
		JR      FINP0
PI1:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0001H
		ADD     HL,BC
FINP0:          LD      (QUOZIE),HL
FINP1:          EXX
		RET


AGGIU2:         LD      IX,QUOZIE
                LD      HL,BINSET+02H   ; 
		RRD

                CP      00H
                JR      Z,PIU0
                CP      01H
                JR      Z,MEN1
                CP      02H
                JR      Z,MEN2
                CP      03H
                JR      Z,PLUS2
                CP      04H
                JR      Z,PLUS1
                CP      05H
                JR      Z,PIU0
                CP      06H
                JR      Z,MEN1
                CP      07H
                JR      Z,MEN2
                CP      08H
                JR      Z,PLUS2
                CP      09H
                JR      Z,PLUS1

PLUS1:          INC     (IX)
                JR      PIU0
PLUS2:          INC     (IX)
                INC     (IX)
                JR      PIU0

MEN1:           DEC     (IX)
                JR      PIU0
MEN2:           DEC     (IX)
                DEC     (IX)
                JR      PIU0
PIU0:           LD      E,(IX+00H)       
                LD      D,(IX+01H)      

                LD      (DIVDEN),DE     ;DIVISIONE
                LD      BC,0005H        ;PER CINQUE
                LD      (DIVSOR),BC     ;PER AVERE
                CALL    DIVIS           ;IL NUMERO
                LD      A,00H           ;DI CARATTERI
                LD      (MAGGI1),A      ;OCCUPATI
                EXX                     ;DAL GATE

		RET



                
                
		;MOLTIPLICAZIONE A 24 BIT  

MOL24:          EXX                                                                                        
		LD      DE,(MOLT24)
		LD      A,(MOLP24)
		LD      BC,800H                
		LD      H,C
		LD      L,C
MPX1:           ADD     HL,HL
		RLA
		JR      NC,MPX2
		ADD     HL,DE
		ADC     A,C             ;IL RISULTATO
MPX2:           DJNZ    MPX1            ;SI TROVA IN AHL
		LD      (PROD24),HL
		LD      (PROD24+02H),A
		EXX
		RET

		;DIVISIONE PER 4096

                

DI4096:         EXX
		LD      HL,(PROD24)
		LD      A,(PROD24+02H)
		LD      B,0DH           ;PER DIVIDERE
MPX3:           DJNZ    MPX4            ;IN 4096 SHIFTO
		JR      MPX8            ;A DESTRA 12 VOLTE
MPX4:           SRL     L
		SRL     H
		JR      C,MPX6
MPX5:           SRL     A
		JR      C,MPX7
		JR      MPX3
MPX6:           CCF
		SET     7,L
		JR      MPX5
MPX7:           CCF
		SET     7,H
		JR      MPX3
MPX8:           LD      (QU4096),HL
		EXX
		RET


		;DIVIS. 24 PER 8 BIT (DIVISIONE PER 1000)
		
                

DI1000:         EXX
                LD      A,(ALTDIV)      
                CP      00H
                JR      Z,DI1004
                CP      01H             
                JR      Z,DI1005
                LD      IX,PTO032
                JR      DI1006
DI1004:         LD      IX,RESTO0
                JR      DI1006
DI1005:         LD      IX,TREST0       
DI1006:         LD      DE,3E8H         ;1000
                LD      BC,0000H
		LD      A,16
		LD      (MDIVIS),A
DI1001:         LD      H,(IX+03H)
		LD      L,(IX+02H)
		SBC     HL,DE
		JP      M,DI1002
		LD      (IX+03H),H      ;RESTO
		LD      (IX+02H),L
		INC     BC
DI1002:         SLA     (IX+00H)        ;ROTAZ.DIV.DO
		RL      (IX+01H)
		RL      (IX+02H)
		RL      (IX+03H)
		SLA     C               ;ROTAZ.QUO.TE
		RL      B
		LD      A,(MDIVIS)
		DEC     A
		LD      (MDIVIS),A
		JR      NZ,DI1001
		LD      H,(IX+03H)
		LD      L,(IX+02H)
		SBC     HL,DE
		JP      M,DI1003
		INC     BC
DI1003:         LD      (QU1000),BC
		EXX
		RET
		

	       ;MOLTIPLICZIONE A 32 BIT

                

MOL32:          EXX
                LD      B,04H
		LD      HL,PTO032
INIT:           LD      (HL),00H
		INC     HL
		DJNZ    INIT
SHIFTX:         LD      B,04H
		LD      IX,MDO032+03H
		XOR     A
RTX:            RR      (IX)
		DEC     IX
		DJNZ    RTX
		JR      NC,ZERO
		LD      B,04H
		LD      HL,PTO032
		LD      IY,MRE032
		CCF
NXTBYT:         LD      A,(IY)
		ADC     A,(HL)
		LD      (HL),A
		INC     IY
		INC     HL
		DJNZ    NXTBYT
ZERO:           LD      B,04H
		LD      IX,MDO032
		XOR     A
ZCHK:           OR      (IX)
		JR      NZ,SHIFTY
		INC     IX
		DJNZ    ZCHK
		JR      END32
SHIFTY:         LD      B,04H
		LD      IY,MRE032
		XOR     A
LEFTY:          RL      (IY)
		INC     IY
		DJNZ    LEFTY
		JR      SHIFTX
END32:          EXX
		RET

		;DIVISIONE, 32BIT DIVISO 4096

                

DIV32:          EXX
		LD      HL,(EDEND0)
		LD      DE,(EDEND2)
		LD      B,0DH           ;PER DIVIDERE
MPW1:           DJNZ    MPW2            ;IN 4096 SHIFTO
		JR      MPW8            ;A DESTRA 12 VOLTE
MPW2:           SRL     L
		SRL     H
		JR      C,MPW7
MPW3:           SRL     E
		JR      C,MPW6
MPW4:           SRL     D
		JR      C,MPW5
		JR      MPW1
MPW5:           CCF
		SET     7,E
		JR      MPW1
MPW6            CCF
		SET     7,H
		JR      MPW4
MPW7:           CCF
		SET     7,L
		JR      MPW3
MPW8:           LD      (QUOZ32),HL
		EXX
		RET

                

SOTT32:         EXX
		AND     A
		LD      HL,(MINUE0)     ;SALVO MINU-
		LD      (MIXUE0),HL     ;ENDO E SOT-
		LD      HL,(MINUE2)     ;TRAENDO
		LD      (MIXUE2),HL     ;ORIGINALI
		LD      HL,(SUBTR0)
		LD      (SUXTR0),HL
		LD      HL,(SUBTR2)
		LD      (SUXTR2),HL
		LD      HL,(MIXUE2)     ;VERIFICO CHI E'
		LD      DE,(SUXTR2)     ;IL NUMERO PIU'
		SBC     HL,DE           ;GRANDE PER PER
		JR      Z,SOT01         ;NON AVERE IL
		JR      NC,SOT03        ;RISULTATO NEGA-
		JR      SOT02           ;TIVO E PER
SOT01:          LD      HL,(MIXUE0)     ;DETERMINARE IL
		LD      DE,(SUXTR0)     ;SENSO DI CORREZ-
		SBC     HL,DE           ;ZIONE
		JR      NC,SOT03
SOT02:          LD      HL,(MIXUE0)
		LD      DE,(SUXTR0)
		LD      (MIXUE0),DE
		LD      (SUXTR0),HL
		LD      HL,(MIXUE2)
		LD      DE,(SUXTR2)
		LD      (MIXUE2),DE
		LD      (SUXTR2),HL     
		LD      A,08H
		LD      (MSCORR),A
		JR      SOT04
SOT03:          LD      A,01H
		LD      (MSCORR),A
SOT04:          LD      HL,(MIXUE0)
		LD      DE,(MIXUE2)
		LD      BC,(SUXTR0)
		AND     A
		SBC     HL,BC
		LD      (RESTO0),HL
                LD      (MREST0),HL     ;MEMORIZZO
                JR      NC,SOT05        ;IL RESTO
                DEC     DE              ;PERCHE' LA
SOT05:          EX      DE,HL           ;LOCAZIONE
                LD      DE,(SUXTR2)     ;REST0 VIENE
                AND     A               ;IN SEGUITO
                SBC     HL,DE           ;MODIFICATA
		LD      (RESTO2),HL
                LD      (MREST2),HL     
		EXX
		RET

TSOTT32:        EXX
		AND     A
                LD      HL,(TINUE0)     ;SALVO MINU-
                LD      (TIXUE0),HL     ;ENDO E SOT-
                LD      HL,(TINUE2)     ;TRAENDO
                LD      (TIXUE2),HL     ;ORIGINALI
                LD      HL,(TUBTR0)
                LD      (TUXTR0),HL
                LD      HL,(TUBTR2)
                LD      (TUXTR2),HL
                LD      HL,(TIXUE2)     ;VERIFICO CHI E'
                LD      DE,(TUXTR2)     ;IL NUMERO PIU'
		SBC     HL,DE           ;GRANDE PER PER
                JR      Z,TSOT01        ;NON AVERE IL
                JR      NC,TSOT03       ;RISULTATO NEGA-
                JR      TSOT02          ;TIVO E PER
TSOT01:         LD      HL,(TIXUE0)     ;DETERMINARE IL
                LD      DE,(TUXTR0)     ;SENSO DI CORREZ-
		SBC     HL,DE           ;ZIONE
                JR      NC,TSOT03
TSOT02:         LD      HL,(TIXUE0)
                LD      DE,(TUXTR0)
                LD      (TIXUE0),DE
                LD      (TUXTR0),HL
                LD      HL,(TIXUE2)
                LD      DE,(TUXTR2)
                LD      (TIXUE2),DE
                LD      (TUXTR2),HL     
		LD      A,08H
                LD      (TMSCOR),A
                JR      TSOT04
TSOT03:         LD      A,01H
                LD      (TMSCOR),A
TSOT04:         LD      HL,(TIXUE0)
                LD      DE,(TIXUE2)
                LD      BC,(TUXTR0)
		AND     A
		SBC     HL,BC
                LD      (TREST0),HL
                JR      NC,TSOT05
		DEC     DE
TSOT05:         EX      DE,HL
                LD      DE,(TUXTR2)
		AND     A
		SBC     HL,DE
                LD      (TREST2),HL
		EXX
		RET


		;SOMMA A 32 BIT

                

SOMM32:         EXX
		LD      HL,ADDEN0
		LD      DE,AUGEN0
		LD      B,04H
		AND     A
ADDW:           LD      A,(DE)
		ADC     A,(HL)
		LD      (HL),A
		INC     DE              ;IL RISULTATO
		INC     HL              ;SI TROVA NELLA
		DJNZ    ADDW            ;LOCAZIONE 
		EXX                     ;ADDEN0 E ADDEN2
		RET

 
                
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& NNDD
;		SOMMA A 32 BIT
;
;	AUGENDO = ADDENDO + AUGENDO
;	si definisce il primo operando addendo e il secondo augendo. 
;	Il risultato somma va poi a sostituire il valore dell'augendo 
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&		
                

FABIOSOMM32:      
		EXX
		LD      DE,ADDEN0
		LD      HL,AUGEN0
		LD      B,04H
		AND     A
FABIOADDW:      LD      A,(DE)
		ADC     A,(HL)
		LD      (HL),A
		INC     DE              ;IL RISULTATO
		INC     HL              ;SI TROVA NELLA
		DJNZ    FABIOADDW            ;LOCAZIONE 
		EXX                     ;ADDEN0 E ADDEN2
		RET

               

CSOTT32:        EXX
                AND     A
                LD      HL,(CINUE2)
                LD      DE,(CUBTR2)
                SBC     HL,DE
                JR      NC,COT00
                LD      HL,(CINUE2)
                LD      (CINUE2),DE
                LD      (CUBTR2),HL
                LD      HL,(CINUE0)
                LD      DE,(CUBTR0)
                LD      (CINUE0),DE
                LD      (CUBTR0),HL
COT00:          LD      HL,(CINUE0)
                LD      DE,(CINUE2)
                LD      BC,(CUBTR0)
                AND     A
                SBC     HL,BC
                LD      (CESTO0),HL
                JR      NC,COT01
                DEC     DE
COT01:          EX      DE,HL
                LD      DE,(CUBTR2)
                AND     A
                SBC     HL,DE
                LD      (CESTO2),HL
                EXX
                RET

                

CSOM32:         EXX
                SCF
                CCF
                LD      HL,(CADDE0)
                LD      DE,(CAUGE0)
                ADC     HL,DE
                LD      (CSOMM0),HL
                LD      HL,(CADDE2)
                LD      DE,(CAUGE2)
                ADC     HL,DE
                LD      (CSOMM2),HL
                SCF
                CCF
                EXX
                RET




                ;ROUTINE PER LCD

TXSET:          LD      B,07H           ;TRASMISSIONE
TXSET1:         LD      A,(HL)          ;INIZIALIZ.LCD
                CALL    SERPAR
                INC     HL
                DJNZ    TXSET1
                RET


TX:
                LD      B,14H           ;TRASMISSIONE
TX1:            LD      A,(HL)          ;20 CARATTERI
		CALL    SERPAR
		INC     HL
		DJNZ    TX1
TX2:            RET                     ;FFLL

TXUNO:          LD      B,01H
TXUNO1:         LD      A,(HL)
		CALL    SERPAR
		INC     HL
		DJNZ    TXUNO1
		RET

INISI:

                CALL    RSZERO
		LD      HL,SETTA
		CALL    TXSET
		CALL    SPETA
		CALL    RSUNO
INISI1:         RET                     ;FFLL

ALTA:           CALL    RSZERO          
                CALL    TXUNO
                CALL    SPETA           
                CALL    RSUNO           
                CALL    SPETA
                RET

BASSA:          CALL    RSZERO
                LD      HL,SECUND
                CALL    TXUNO
                CALL    RSUNO
                RET

SERPAR:         PUSH    BC              ;TRASMISSIONE
                LD      B,08H           ;SERIALE PARAL-
                LD      C,A             ;LELO
SERPA1:         LD      A,(MEMB)
                RL      C
                JR      NC,WA1
                SET     7,A
                JR      WA2
WA1:            RES     7,A
WA2:            LD      (MEMB),A
                OUT     (PB),A
                LD      A,(MEMA)
                SET     1,A
                OUT     (PA),A

                NOP                     ;LLLL
                NOP
                NOP                     ;LLLL

                RES     1,A
                OUT     (PA),A
                LD      (MEMA),A
                DJNZ    SERPA1
                LD      A,(MEMA)
                SET     3,A
                OUT     (PA),A

                NOP                     ;LLLL
                NOP
                NOP                     ;LLLL

                RES     3,A
                OUT     (PA),A
                LD      (MEMA),A
                POP     BC
                RET


RSZERO:         LD      A,(MEMB)        ;METTO A ZERO
                RES     0,A             ;RS
                OUT     (PB),A
                LD      (MEMB),A
                RET

RSUNO:          LD      A,(MEMB)        ;METTO A UNO
                SET     0,A             ;RS
                OUT     (PB),A
                LD      (MEMB),A
                RET

SPETA:          LD      E,0B0H
SPETA1:         DEC     E
                JR      NZ,SPETA1
                RET



		;CONVERSIONE BINARIO SETTE SGMENTI

		;REG. D CONTIENE IL NUMERO DI BYTE BINARI
		;REG. E CONTIENE IL NUMERO DI BYTE BCD
                ;ADDR. 4200H E 4201H MEM. NUMERO BINARIO
                ;ADDR. 4202H E 4203H MEM. NUMERO BCD

                

BIN7:           EXX
                LD      D,02H           ; 
		LD      E,05H
		LD      A,00H
		LD      B,E
		LD      HL,BINSET+02H
CLR:            LD      (HL),A
		INC     HL
		DJNZ    CLR
		LD      A,D             ;A=NUMERO BYTE
		ADD     A,A
		ADD     A,A
		ADD     A,A
		LD      C,A             ;C=NUMERO BIT
LOOP:           LD      L,00H
		LD      B,D
SHLB:           RL      (HL)
		INC     HL
		DJNZ    SHLB
		LD      L,02H
		LD      B,E
BCDADJ:         LD      A,(HL)
		ADC     A,A
		DAA
		LD      (HL),A
		INC     HL
		DJNZ    BCDADJ
		DEC     C
		JR      NZ,LOOP
                LD      A,(MAGGIU)      ;
                CP      01H
                JP      Z,AGGIU1        ;



		;METTE IN MEMORIA UN SINGOLO BCD

		LD      IY,BINSET+05H   ;TAB.BCD SING-1
                LD      HL,BINSET+02H   ;TAB.COPPIA BCDDD
		RRD
		LD      (IY+01H),A
		RRD
		LD      (IY+02H),A
                INC     HL
                RRD
		LD      (IY+03H),A
		RRD
		LD      (IY+04H),A
                INC     HL              
		RRD
		LD      (IY+05H),A

                LD      A,(VELMEM)      ;QUANDO ESE-
                CP      00H             ;GUE VELOCITA'
                JR      Z,BIOTTD        ;RITORNA DA 
                LD      HL,BINSET+06H   ;QUESTO PUNTO
                LD      DE,VELBCD
                LD      BC,0003H
                LDIR
                RET

BIOTTD:         LD      IY,BINSET+05H   
                LD      IX,SECFUN+07H   
                LD      A,(IY+01H)      
                ADD     A,48
                LD      (IX+04H),A
                LD      A,(IY+02H)      
                ADD     A,48
                LD      (IX+03H),A
                LD      A,(IY+03H)      
                ADD     A,48
                LD      (IX+02H),A
                LD      A,(IY+04H)      
                ADD     A,48
                LD      (IX+01H),A

                CALL    TXUNO           
                CALL    BASSA
                LD      HL,SECFUN
                CALL    TX
		EXX
                RET


                

		;REG. D CONTIENE IL NUMERO DI BYTE BINARI
		;REG. E CONTIENE IL NUMERO DI BYTE BCD
                ;ADDR. 4220H E 4221H MEM. NUMERO BINARIO
                ;ADDR. 4222H E 4223H MEM. NUMERO BCD

SCRITL:         EXX
                LD      D,02H
                LD      E,05H
		LD      A,00H
		LD      B,E
                LD      HL,BINSE1+02H
CLRL:           LD      (HL),A
		INC     HL
                DJNZ    CLRL
		LD      A,D             ;A=NUMERO BYTE
		ADD     A,A
		ADD     A,A
		ADD     A,A
		LD      C,A             ;C=NUMERO BIT
LOOPL:          LD      L,20H
		LD      B,D
SHLBL:          RL      (HL)
		INC     HL
                DJNZ    SHLBL
                LD      L,22H
		LD      B,E
BCDAJL:         LD      A,(HL)
		ADC     A,A
		DAA
		LD      (HL),A
		INC     HL
                DJNZ    BCDAJL
		DEC     C
                JR      NZ,LOOPL


		;METTE IN MEMORIA UN SINGOLO BCD

                LD      IY,BINSE1+05H   ;TAB.BCD SING-1
                LD      HL,BINSE1+02H   ;TAB.COPPIA BCDDD
		RRD
		LD      (IY+01H),A
		RRD
		LD      (IY+02H),A
                INC     HL              
		RRD
		LD      (IY+03H),A
		RRD
		LD      (IY+04H),A
                INC     HL              
		RRD
		LD      (IY+05H),A
                EXX
                RET

		;REG. D CONTIENE IL NUMERO DI BYTE BINARI
		;REG. E CONTIENE IL NUMERO DI BYTE BCD
                ;ADDR. 4230H E 4231H MEM. NUMERO BINARIO
                ;ADDR. 4232H E 4233H MEM. NUMERO BCD

GIGIOT:         EXX
                LD      D,02H
                LD      E,05H
		LD      A,00H
		LD      B,E
                LD      HL,BINSE2+02H
CLRT:           LD      (HL),A
		INC     HL
                DJNZ    CLRT
		LD      A,D             ;A=NUMERO BYTE
		ADD     A,A
		ADD     A,A
		ADD     A,A
		LD      C,A             ;C=NUMERO BIT
LOOPT:          LD      L,30H
		LD      B,D
SHLBT:          RL      (HL)
		INC     HL
                DJNZ    SHLBT
                LD      L,32H
		LD      B,E
BCDAJT:         LD      A,(HL)
		ADC     A,A
		DAA
		LD      (HL),A
		INC     HL
                DJNZ    BCDAJT
		DEC     C
                JR      NZ,LOOPT


		;METTE IN MEMORIA UN SINGOLO BCD

                LD      IY,BINSE2+05H   ;TAB.BCD SING-1
                LD      HL,BINSE2+02H   ;TAB.COPPIA BCDDD
		RRD
		LD      (IY+01H),A
		RRD
		LD      (IY+02H),A
                INC     HL              
		RRD
		LD      (IY+03H),A
		RRD
		LD      (IY+04H),A
                INC     HL              
		RRD
		LD      (IY+05H),A
                EXX
                RET

SCRITD:         EXX
                LD      IY,BINSE1+05H   
                LD      IX,SECERR       
                LD      A,(IY+01H)      
                CP      05H             ; PER AVERE
                JR      C,SCRI4         ;SOLO 0 o 5
                LD      A,05H
                JR      SCRI5
SCRI4:          LD      A,00H                
SCRI5:          ADD     A,48            ;CENTESIMI
                LD      (IX+06H),A      ; 
                LD      A,(IY+02H)      
                ADD     A,48            ;DECIMI
                LD      (IX+05H),A      ;
                LD      A,(IY+03H)      
                ADD     A,48            ;UNITA
                LD      (IX+03H),A      ;
                LD      A,(IY+04H)
                ADD     A,48            ;DECINE 
                LD      (IX+02H),A      ;
                LD      A,44            ;,
                LD      (IX+04H),A      ;
                LD      A,58            ;:
                LD      (IX+01H),A
                LD      A,76            ;L
                LD      (IX+00H),A
                LD      A,(SIMCOL)
                LD      (IX+07H),A      ;
                LD      A,(SIMCOL+01H)  ;
                LD      (IX+08H),A      ;
                LD      A,(SIMCOL+02H)  ; 
                LD      (IX+09H),A      ;

                LD      A,32            ;VUOTO
                LD      (IX+0AH),A      

                LD      A,32            ;VUOTO
                LD      (IX+0BH),A
                LD      A,32            ;VUOTO
                LD      (IX+0CH),A
                LD      A,84            ;T
                LD      (IX+0DH),A
                LD      A,58            ;:
                LD      (IX+0EH),A
                LD      A,45            ;-
                LD      (IX+0FH),A
                LD      A,79            ;O
                LD      (IX+10H),A
                LD      A,70            ;F
                LD      (IX+11H),A
                LD      A,70            ;F
                LD      (IX+12H),A
                LD      A,45            ;-
                LD      (IX+13H),A



                LD      IX,VELBCD
                LD      A,(IX)
                ADD     A,48
                LD      (NUMCOL+13H),A  ;UNITA'
                INC     IX
                LD      A,(IX)
                ADD     A,48
                LD      (NUMCOL+12H),A  ;DECINE
                INC     IX
                LD      A,(IX)
                ADD     A,48
                LD      (NUMCOL+11H),A  ;CENTINAIA

                LD      A,67            ;C ADD     A,48
                LD      (NUMCOL+09H),A  ;INSETTER

                CALL    INISI           
                LD      HL,NUMCOL
                CALL    TX              

SCRI1:          CALL    TXUNO           
                CALL    BASSA
                LD      HL,SECERR
                CALL    TX

		EXX
                RET


                

                ;GESTIONE DELLA CORREZIONE SUPERIORE
                ;A MEZZO GATE  


OVERCO:         LD      HL,(ERATTU)     ;SE ERRORE > 1mm  
                LD      DE,0064H        ;SALTO SE NO  
                SBC     HL,DE           ;RICARICO LA
                JR      NC,OVERC3       ;SOVRA CORREZ-
                CCF                     ;ZIONE.

                LD      A,(SHIFT3)      ;METTO IN SHIFT
                DEC     A               ;AMPI40 FINO
                LD      (SHIFT3),A      ;A CHE SHIFT1
                CP      00H             ;ARRIVI A ZERO
                JR      Z,OVERC1
                LD      DE,(AMPI40)     
                LD      (SHIFT),DE      
                JR      OVERC2

OVERC1:         LD      DE,(SHIFT4)     ;ALLA FINE 
                LD      (SHIFT),DE      ;CARICO IL
                LD      A,00H           ;RESTO IN
                LD      (SUPCOR),A      ;SHIFT

OVERC2:         CALL    SPOSTA


OVERC3:         RET                     ;








		;###########################
		;# CALCOLO DELLA  VELOCITA'#
		;###########################

		;4mS x 4096 = 16384000
		;60\1638400 = 0,000003662
		;0,000003662 x CILINDRO = X
		;X\1000 = COSVEL (COSVEL E' CALCOLATA
		;AL CAMBIO CILINDRO)
		;COSVEL x IMPVEL = Y
		;Y/1000 = VELOCITA m/m

VELO:           LD      DE,(COSVEL)
		LD      (MDO032),DE
		LD      DE,0000H
		LD      (MDO232),DE
		LD      (MRE232),DE
		LD      DE,(IMPVEL)
		LD      (MRE032),DE
		LD      A,02H           
		LD      (ALTDIV),A      
		CALL    MOL32
		CALL    DI1000
		LD      BC,(QU1000)     ;VELOCITA         
		LD      (ISTVEL),BC     ;ISTANTANEA    

                ;MEDIA VELOCITA SU QUATTRO LETTURE WWAA WWNN

                LD      B,03H           ;WWAA WWNN
                LD      IX,MVEL00       ;
                LD      DE,0004H        ;WWNN
                ADD     IX,DE
MEDV01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;DATO AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDV01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      DE,(ISTVEL)      ;
                LD      (MVEL00),DE

                LD      B,04H            ;SOMMA DELLE  WWNN
                JR      NC,MEDV02        ;4 CELLE  WWAA   WWNN
                CCF                      ; 
MEDV02:         LD      HL,0000H
MEDV03:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDV03
                

                LD      (DIVDEN),HL
                LD      BC,0004H        ;WWNN
                LD      (DIVSOR),BC     ;
		CALL    DIVIS
		LD      HL,(QUOZIE)

		LD      (VELMED),HL                 

		LD      DE,(VELPRE)     ;SE NON CAMBIA
		SBC     HL,DE           ;NON AGGIORNO
                JR      Z,MEDV05        ;IL DISPLAY ZZZ
                JR      NC,MEDV04
		CCF

MEDV04:         LD      HL,(VELMED)

		LD      (BINSET),HL     ;ZZZ
		LD      A,01H
		LD      (VELMEM),A
		CALL    BIN7
		LD      A,00H
		LD      (VELMEM),A
MEDV05:         RET


                



                ;SCRITTURA ACCELLERA            
 

ACCEL:          LD      A,(LINGUA)
		CP      00H
                JR      Z,ACCM
		CP      01H
                JR      Z,ACCI
		CP      02H
                JR      Z,ACCF
		CP      03H
                JR      Z,ACCGB
                CP      04H
                JR      Z,ACCE
                CP      05H
                JR      Z,ACCD
                JR      ACCFIN
ACCM:           CALL    BASSA
                LD      HL,ACELER
                JR      ACCTX
ACCI:           CALL    BASSA
                LD      HL,ACELER+14H
                JR      ACCTX
ACCF:           CALL    BASSA
                LD      HL,ACELER+28H
                JR      ACCTX
ACCGB:          CALL    BASSA
                LD      HL,ACELER+3CH
                JR      ACCTX
ACCE:           CALL    BASSA
                LD      HL,ACELER+50H
                JR      ACCTX
ACCD:           CALL    BASSA
                LD      HL,ACELER+64H
ACCTX:          CALL    TX
                CALL    RITVEL    
		CALL	AZZTOT		;PUUU
ACCFIN:         RET


                ;SCRITTURA  DECELLERA

DECEL:          LD      A,(LINGUA)
		CP      00H
                JR      Z,DECM
		CP      01H
                JR      Z,DECI
		CP      02H
                JR      Z,DECF
		CP      03H
                JR      Z,DECGB
                CP      04H
                JR      Z,DECE
                CP      05H
                JR      Z,DECD
                JR      DECFIN
DECM:           CALL    BASSA
                LD      HL,DECELE
                JR      DECTX
DECI:           CALL    BASSA
                LD      HL,DECELE+14H
                JR      DECTX
DECF:           CALL    BASSA
                LD      HL,DECELE+28H
                JR      DECTX
DECGB:          CALL    BASSA
                LD      HL,DECELE+3CH
                JR      DECTX
DECE:           CALL    BASSA
                LD      HL,DECELE+50H
                JR      DECTX
DECD:           CALL    BASSA
                LD      HL,DECELE+64H
DECTX:          CALL    TX
                CALL    RITVEL
		CALL	AZZTOT		;PUUU
DECFIN:         RET


                ;RITARDO SCRITTURA ACCEL DECEL


RITVEL:         ; DA RICOPIARE TOTALMENTE WWAA WWAA

                CALL    RESEPC          ;FFLL
                LD      BC,7FFFH
RITVE1:         
                DEC     BC
                LD      A,B
                OR      C
                JR      NZ,RITVE1
                

                RET                     ;FFZZ

AZZTOT:					;PUUU
                LD      A,00H           ;ALL'USCITA VVVV
                LD      (MAVA00),A      ;VIENE AZZERATO VVVV
                LD      HL,MAVA00       ;TUTTO CIO'CHE VVVV
                LD      DE,MAVA00+01H   ;RIGUARDA LA  VVVV
                LD      BC,130H         ;VISUALIZZAZIONE VVVV
                LDIR                    ;DELL'ERRORE 


		RET


                ;CALCOLO VELOCITA'ISTANTANEA SLEGATO     BBLL
                ;DAL NORMALE CALCOLO USATO SOLO PER NOPRI
                
VELIST:                                 ;BBLL

                LD      BC,0474H        ;16mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
VELO1:          IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,VELO2        ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO

VELO2:          DEC     BC              
                LD      A,B
                OR      C
                JR      NZ,VELO1       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.


                LD      DE,(COSVEL)
		LD      (MDO032),DE
		LD      DE,0000H
		LD      (MDO232),DE
		LD      (MRE232),DE
		LD      DE,(IMPVEL)
		LD      (MRE032),DE
		LD      A,02H           
		LD      (ALTDIV),A      
		CALL    MOL32
		CALL    DI1000
		LD      BC,(QU1000)     ;VELOCITA         
		LD      (ISTVEL),BC     ;ISTANTANEA    

                LD      (BINSET),BC     ;TTVV
                LD      A,01H           ;TTVV
                LD      (VELMEM),A      ;TTVV
                CALL    BIN7            ;TTVV
                LD      A,00H           ;TTVV
                LD      (VELMEM),A      ;TTVV

                RET



SERITA:
                LD      A,(GUADS1)      ;SALVA IL VALORE 
                LD      H,A             ;DI AMPLIF. 

		LD      A,(MEMA)
		RES     2,A
		OUT     (PA),A
		SET     2,A
		OUT     (PA),A
		LD      D,00H           
		LD      B,08H           
KRITPA:
		RES     1,A
		OUT     (PA),A
		IN      A,(PA)
		RR      A     
		RL      D
		SET     1,A
		SET     2,A

                AND     0FH             ;RIPRISTINA 
                ADD     A,H             ;AMPLIFICAZ. 

		OUT     (PA),A
		LD      (MEMA),A
		DJNZ    KRITPA
		LD      (MEMA),A        
		LD      A,D
		AND     1FH             
                ;                       CALL    CAG
        	LD      L,A             ;LEGGO DUE VOLTE
		LD      H,00H           ;LA TASTIERA CON
		LD      DE,TABLE        ;UN RITARDO TRA 
		ADD     HL,DE           ;PRIMA E LA SECON-
		RET






                ;FASATURA CON OSCILLOSCOPIO ESTERNO  FF55

SPOFAS:                         
                IN      A,(PA)          ;
		BIT     4,A
                JP      NZ,SPOEN1       ;
                CALL    SERITA          ;

                LD      DE,(INCEXT)
		LD      A,00H
		CP      E
                JR      NZ,EXTE1
                LD      E,14H
                LD      (INCEXT),DE
                JR      EXTE2
EXTE1:          LD      A,01H
		ADD     A,E
		LD      E,A
                LD      (INCEXT),DE

EXTE2:
                LD      A,(HL)          ;VERIFICO SE
                AND     1FH             ;PIGIATO
                CP      08H             ;AVANTI/RITARDO
                JP      Z,SXSPOS        ;LLLL
		CP      09H
		JR      Z,DXSPOS
		JR	SPOEND

DXSPOS:
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,SPOF01
                LD      (FASE),HL
                JR      SPOF02
SPOF01:         CCF
                LD      HL,0FFFH
SPOF02:         LD      (FASE),HL
                JR      SPOEND
SXSPOS:
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                ADD     HL,DE
                LD      A,H
                CP      10H
                JR      NZ,SPOF07
                LD      HL,0000H
SPOF07:         LD      (FASE),HL
                JR      SPOEND

SPOEN1:         LD      DE,0000H
                LD      (INCEXT),DE

SPOEND:
                RET



RESEPC:
                LD      A,(PROTEZ)      ;FFLL
                CP      01H
                JR      Z,RESPE1
                LD      A,(MEMC)        
		RES     0,A
		RES     1,A
                RES     6,A
                RES     7,A
		LD      (MEMC),A
		OUT     (PC),A
RESPE1:         RET

               ;CALCOLO VARIABILI PER MEDIA ERRORE LONG.

VARERR:                                  ;WWAA
                LD      A,(CICLO)
                CP      09H
                JR      NC,MECI01
                LD      A,07H
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,0CH
                LD      (VALORX),A
                JR      MECI04
MECI01:
                LD      A,(CICLO)
                CP      11H             ;= 17
                JR      NC,MECI02
                LD      A,0FH
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,1CH           ;= 28
                LD      (VALORX),A
                JR      MECI04
MECI02:
                LD      A,(CICLO)
                CP      21H             ;= 33
                JR      NC,MECI03
                LD      A,1FH           ;= 31
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,3CH           ;= 60
                LD      (VALORX),A
                JR      MECI04
MECI03:
                LD      A,2FH           ;= 47
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,5CH           ;= 92
                LD      (VALORX),A
MECI04:
                RET


		
		;CENTRATURA DOPO FASE CON OSCILLOSCOPIO ESTERNO FF57

CENTRO:         EXX                     ;SOTTRAGGO IL VA- FF57
                LD      HL,(FASES1)     ;LORE DI 1/2 GATE
		LD      BC,(MEZGA)       ;DAL VALORE LETTO
                SBC     HL,BC           ;SE IL RISULTATO
		JR      C,CENTR1        ;E'POSITIVO LO
		JR      CENTR2          ;MEMORIZZO IN
CENTR1:         CCF                     ;IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
                LD      BC,(FASES1)       ;IL 1/2 GATE E IL
		ADD     HL,BC           ;RESTO LO SOMMO
CENTR2:         LD      (FASE),HL       ;AL VALORE LETTO.
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,04H           ;4 GIRI ATTESA
		LD      (MEMRIF),A      ;PER MEMORIZZARE
		EXX                     ;IL RIFERIMENTO
		RET


		;VERIFICA VALORI DI F1 E F3 


VERIFI:
		LD	HL,(CILIN)	;EEOO
		LD	DE,0FFFFH	;EEOO
		ADD	HL,DE
		JR	C,VERF11 	;EEUU
		CALL	ERR_F1
		JR	VERF3		;EEOO
VERF1:		CCF
VERF11:		LD	HL,(CILIN)	;EEUU
		LD	DE,7FFH		;2047mm	MAX SIZE SSDD
		SBC	HL,DE
		JR	NC,VERF13 	;EEUU
		CCF
		JR	VERF3
VERF13:		CALL	ERR_F1		;EEUU
VERF3:
		LD	A,(AMPGA)	;EEUU
		CP	00H
		JR	NZ,VERF4
		CALL	ERR_F3

VERF4:
              
	        RET                     ;EEUU


              ;VERIFICA TIPO DI ERRORE DA SCRIVERE
		

CONTR:          LD      A,(MDATER)
		CP      00H
		JR      Z,CO4
		CP	01H		;EEOO
		JR	Z,CO1		;EEOO
		CP	02H
		JR	Z,CO2
		CP	03H
		JR	Z,CO3
		JR	CO4
CO1:		CALL    ERROR		;EEOO
		JR	CO4		;EEOO
CO2:		CALL	ERR_F1		;EEOO
		JR	CO4
CO3:		CALL	ERR_F3		;EEOO
CO4:
		RET

                
RELES1:
                ;  ZELO ELETTRONICA 
        DEFB    32, 32, 90, 69, 76, 79, 32, 69, 76, 69
        DEFB    84, 84, 82, 79, 78, 73, 67, 65, 32, 32

RELES2:
                ; INSETTER LMNC_02.9 
        DEFB    32, 73, 78, 83, 69, 84, 84, 69, 82, 32
        DEFB    76, 77, 78, 67, 95, 48, 50, 46, 56, 32  

PROGR1:
                ; PROGRAMMA WMNC_02.9;
        DEFB    32, 80, 82, 79, 71, 82, 65, 77, 77, 65
        DEFB    32, 87, 77, 78, 67, 95, 48, 50, 46, 56

PROGR2:
                ;    DEL 01/08/07            TTVV
	DEFB    32, 32, 32, 32, 68, 69, 76, 32, 48, 49
        DEFB    47, 48, 56, 47, 48, 55, 32, 32, 32, 32



                END


