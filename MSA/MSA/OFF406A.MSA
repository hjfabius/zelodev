 
                ;##################################
                ;# CONTROLLO DI REGISTRO COLORE   #
                ;# LONGITUDINALE OFFSET CON UNA   #
                ;# TESTA CON SEGNI CODICE ZELO    #
                ;#  E USO DEL DEL PROXIMITY       #
                ;##################################

                ;*************************************
                ;* PER CILINDRI SUPERIORI A 1200 mm  *
                ;* VERIFICARE CALCOLI SEGNO ,SPAZIO  *
                ;*************************************

                ;##################################

                ;PER MODIFICHE VEDI IN ANNA

;24/07/03  MODIFICA PER RST  38H, ELIMINATA SCRITTA RELES
;24/07/03  E ELEMINANDO  MOLTISSIME ORG DIVENTA OFF77C
;13/09/03 ELIMINATO ERRORI DI OFF77C DIVENTA OFF78C
;07/09/04 CALCOLO POSIZIONE II GATE DURANTE FUNZ3 IIGG
;07/09/04 INIZIO MODIFICHE CORREZIONE TOTALE DOPO LA FASATURA FFZZ
;15/09/04 MODIFICATO IN AZZERAMENTO ERRORE DA MMED00 A DMED00
         ;MODIFICATO VALORI DERIVATIVO  DDEE
         ;SPOSTATO DI POSIZIONE IN MEMEORIA MATTES
;04/10/04 MESSO DOPPIO SEGNO PPDD
;04/10/04 INSERITO TEDESCO TTDD
;18/10/04 MESSO AZZERAMENTO MEMORIE VELOCITA AAVV
;20/10/04 SISTEMATO DEFINITIVAMENTE TEST ENCODER XXTT
;30/10/04 RIFATTO CALCOLO SEGNO E SPAZIO (PALLADIO) SSPP
;30/10/04 DIVENTA  OFF80A
;05/11/04 MODIFICHE SU FLEXOL  FFXX
;09/11/04 RITOCCHI SU FLEXOL   FFRR
;21/05/05 AGGIORNAMENTO ALLE MODIFICHE 150 WWAA
;26/05/05 MODIFICHE SULL'AGGIORNAMETO DEL 21/05 WWLL
;27/05/05 ADATTAMENTO A COL/OFF WWTT
;26/05/05 DIVENTA COL300A.MSA 
;12/07/05 AGGIUNTA LETTURA CON PROXIMITY PXXX
;13/07/05 PORTATA MEDIA SU DISPLAY DA 8 A 4 DIVENTA 30.1
          ;ELIMINATO TEMPO DI ATTESA SU SEGNALAZIONE DOPPIO  ATTT
;08/08/05 ;ELIMINATO ERRORE FILTRATO FFFE 
;16/09/05 INSERITO ALLARME QUANDO NOPRINT BBLL  DIVENTA 30.3
;05/02/06 DIFETTO DEVRIM CON CILINDRO 435 mm NON GENERAVA
          ;PRIMO GATE CON F3 = 2 PORTATO MILL40 A MILL35
;11/03/06 ELIMINATO PROBLEMA CHE QUANDO SI INSERIVA UNO SHIFT E C'ERA
          ;UN ERRORE IN SENSO OPPOSTO QUESTO DAVA ANCORA UNA CORREZIONE
          ;IN SENSO OPPOSTO ALLO SHIFT OOPP DIVENTA DIW304
;16/05/06 ;SCRITTA ERRORE SU DATO ERRATO F1 F3 EEOO
;18/05/06 ;INSERIMENTO OSCILLOSCOPIO ESTERNO FF55 MODIFICHE SUL DIW
          ;MIGLIORAMENTI FF56
;20/05/06 ;ULTIMATO FASATURA CON OSCILLISCOPIO E CON PULSANTE FF56
;20/05/06 ;INIZIO MODIFICHE CAMBIO SEGNO DI RIFERIMENTO SSRR
;21/05/06 ;MODIFICHE PER CORREZIONE SOLO PROPORZIONALE PPPP
;22/05/06 ;SISTEMATO SCRITTURE ERRORE EEUU
;23/05/06 ;ELIMINATO ERRORE SU F3 EFATTO ALTRE MIGLIORIE CCGG
;26/05/06 ;PARAMETRO SALTO COME MINIMO ZERO E MODIFICATO DATO ERRATO F1 SSMM
          ;ELIMINATI RITARDI ALLA CORREZIONE PER SLTI DI ERRORE (SALTO1) SSMM
;05/06/06 ELIMINATO MSHIFT CHE FACEVA RIMANERE SUL DISPLAY PER QUALCHE
	  ;SECONDO IL VALORE DI SHIFT IMPOSTATO
;24/06/06 ELIMINATA MODIFICA PER VIAPPIANI SU GROSSA VARIAZIONE VELOCITA DIVENTA 306 UUUU          
;07/10/06 AGIUNTE ULTERIORI PROTEZIONI E AZZERATO ERRORE QUANDO ACCEL/DECEL
	  ;DIVENTA 307 PUUU
;23/12/06 TENTATIVO DI MODIFICA PER LEGGERE IL REGISTRO UTILIZZANDO LO SPESSORE DEL SEGNO SSSS
;31/12/06 MODIFICA LEGGENDO LO SPESSORE DEL SEGNO OK DIVENTA 400
;03/01/07 INSERIMENTO NUOVO SISTEMA CONTROLLO SEGNO DOPPIO SSDD
;22/01/07 MIGLIORAMENTO SEGNO DOPPIO MMSS
;23/01/07 SISSTEMATO ALTERN IN MODO CHE NON SUPERI IL VALORE DI DUE AALL
;29/01/07  DURANTE SEGNO DOPPIO SALTUARIMENNTE RIMANEVA IN RICERCA RRDD
;24/02/07 INSERITO ABILITA/DISABILITA DOPPIO SEGNO DDAA
;20/05/07 ALL'USCITA DELLA TASIERA PORTATO ALTERR DA 8 A 3 PER VELOCIZZARE
;29/06/07 MODIFICHE NUOVO DERIVATIVO DIVENTA COL402A NNDD
;16/10/07 MODIFICATO CHIAMATA A NOPRI E FATTO GENRARE GATE 2 ANCHE IN CASO DI NOPRI JJJJ
	 ; DIVENTA OFF403A
;10/01/07 RIMESSO SALTO A UN MINIMO DI UNO E MODIFICATO DIVENTA OFF404A MMUU
;12/04/08  QUANDO RIMANE TONTO TEMPO IN GIRO SI RESETTA CAMBIATO IL MODO DI SCRIVERE	
	   ; FASE ESEGUITA DIVENTA OFF405A LOLA RRAA
;27/05/08 MODIFICHE PER FARE LA MISURA DELLA DISTANZA TRA I SEGNI O SOLO SUL FRONTE
	;DI SALITA OPPURE MISURANDO LO SPESSORE. INSERITO I PARAMETRI NASCOSTI
	;PER ZELO CON LA POSSIBILITA DI VEDERLI CON TEST5 DIVENTA OFF406A FFSS 
;01/06/08 CAMBIATO TEMPI IN GIR1 FF11

PA:     EQU     00H     ;DATI PORTA A
PB:     EQU     01H     ;DATI PORTA B
PC:     EQU     63H     ;DATI PORTA C
TABCON: EQU     4000H   ;USATA IN CONVERSIONE BCD BINARIO
POSIT:  EQU     4018H   ;MEM.DELLA FUNZIONE PIU'
NEGAT:  EQU     401AH   ;MEM.DELLA FUNZIONE MENO
MANAU:  EQU     401CH   ;MEM.DELLA FUNZIONE MANUALE/AUTO
LAVORO: EQU     401EH   ;NøDEL LAVORO PRESENTE
SHIFT:  EQU     4020H   ;MEM.DELLO SPOSTAMENTO REGISTRO
PIUMEN: EQU     4022H   ;MEM.SENSO DELLO SPOSTAMENTO
DIVDEN: EQU     4024H   ;MEM. DEL DIVIDENDO
DIVSOR: EQU     4026H   ;MEM. DEL DIVISORE
QUOZIE: EQU     4028H   ;MEM. RISULTATO DIVISIONE
MOLTI:  EQU     402AH   ;MEMORIA DEL MOLTIPLICATORE
MOLPL:  EQU     402CH   ;MEMORIA DEL MOLTIPLICANDO
PROD:   EQU     402EH   ;MEMORIA DEL PRODOTTO
MOLT24: EQU     4030H   ;MOLTIPLICATORE  MOLTIPLICA 24 BIT
MOLP24: EQU     4032H   ;MOLTIPLICANDO MOLTIPLICA 24 BIT
PROD24: EQU     4034H   ;4036H PRODOTTO MOLTIPLICA 24 BIT 
QU4096: EQU     4038H   ;QUOZIENTE DIVISIONE PER 4096
QU1000: EQU     403AH   ;QUOZIENTE DIVISIONE PER 1000
MDIVIS: EQU     403CH   ;MEM. USATA IN DIVISIONE 1000
SHIFT0: EQU     4040H   ;MEM.BASSA SPOSTAMENTO REGISTRO
SHIFT2: EQU     4042H   ;MEM. ALTA SPOSTAMENTO REGISTRO
ADDEN0: EQU     4044H   ;ADDENDO BASSO SOMMA A 32 BIT
ADDEN2: EQU     4046H   ;ADDENDO ALTO SOMMA A 32 BIT
AUGEN0: EQU     4048H   ;AUGENDO BASSO SOMMA A 32 BIT
AUGEN2: EQU     404AH   ;AUGENDO ALTO SOMMA A 32 BIT
IMPENC: EQU     406AH   ;VALORE SPOSTAM.IN IMPULS.ENCODER
CONSAL: EQU     4070H   ;CONTEGGIO SALTI DI NON CORREZ. 
CORRE:  EQU     407AH   ;MEM.VALORE DI CORREZ.MOTORE
DECORR: EQU     407CH   ;EXTRA VALORE DI CORREZ. LONGITUD.
MDECOR: EQU     407EH   ;MEM.EXTRA VALORE DI CORREZ. LONG. 
NOCIAO: EQU     4080H   ;NON SCRIVE CIAO IN CASO DI BLOCCO  
GUADA:  EQU     4100H   ;MEM.DEL GUAD.min 11 x CIL=2000
CICLO:  EQU     410AH   ;MEMORIA CICLO DI CORREZIONE
DERIVA: EQU     4114H   ;MEMORIA DEL VALORE DERIVATIVO
ZONA:   EQU     411EH   ;MEMORIA VALORE ZONA MORTA
INSER:  EQU     4128H   ;MEMORIA VALORE INSERZIONE AUTO
SALTO:  EQU     4132H   ;MEM. VALORE SALTO DI CORREZIONE
XUNZ:   EQU     413CH   ;MEMORIA FUNZIONE MOD. PARAMETRI
LINGUA: EQU     4146H   ;MEMORIA DELLA LINGUA
TRIP:   EQU     4150H   ;SOGLIA BLOCCO PER VELOCITA'
ABIDOP: EQU     415AH   ;AB/DIS DOP. SEG. GROSSA VAR.VEL.


VCLONG: EQU     4164H   ;VELOCITA DI CORREZIONE LONGITUDINALE FFZZ AAOO
PROXIM: EQU     416EH   ;LETTURA CON O SENZA PROXIMITY
SEGRIF: EQU     4178H   ;SCELTA SEGNO DI RIFERIMENTO SSRR
SELFRO:	EQU 	4182H	;SELEZ. MISURA SU FRONTE SALITA O SPESSORE FFSS
XTASTO: EQU     4192H   ;MEMORIA ULTIMO TASTO PREMUTO   CCGG 
ALTDIV: EQU     4194H   ;ALTERNA I VALORI NELLA DIVISIONE CCGG 

BINSET: EQU     4200H   ;MEM.TRASM.DISPLAY 4200H-4210H
AGGIU:  EQU     4300H   ;MEM.AGGIUST.DECIM. 4300H-4310H
MEM0:   EQU     4320H   ;MEMORIA DELLA FUNZIONE 0   WWAA
MEM1:   EQU     4322H   ;MEMORIA DELLA FUNZIONE 1
MEM2:   EQU     4324H   ;MEMORIA DELLA FUNZIONE 2
MEM3:   EQU     4326H   ;MEMORIA DELLA FUNZIONE 3
MEM5:   EQU     4328H   ;MEMORIA DELLA FUNZIONE 5 FF55
MEM6:   EQU     432AH   ;MEMORIA DELLA FUNZIONE 6
MEM6A:  EQU     432CH   ;MEM. USATA NELLA FUNZIONE 6
MEM7:   EQU     432EH   ;MEMORIA DELLA FUNZIONE 7
MEMW:   EQU     4330H   ;USATA IN CALCOLO CORREZ.MOTORE
MEMID:  EQU     4332H   ;MEM.INIZIALIZZIONE DISPLAY
MEMTF:  EQU     4334H   ;MEM. TASTO F GIA' PIGIATO
MEMRIF: EQU     4336H   ;USATA PER MEM.I RIFERIMENTI
MDATER: EQU     4338H   ;MEM.INSERIMENTO DATO ERRATO
MCALER: EQU     433AH   ;SEGNALA AL MAIN DI CALCOLARE
MSCORR: EQU     433CH   ;MEM.INDICA IL SENSO DELLA CORR.
FRONTE: EQU     433EH   ;CAMBIO BIT 4 CTC3  

MNOPRI:	EQU	4340H	;USATA PER AVVISARE NOPRI JJJJ

MDBUSY: EQU     4342H   ;DISPLAY CON ERRORE DI REGISTR
MKBUSY: EQU     4344H   ;SEGNALA L'USO DELLA TASTIERA

MTASTI: EQU     4346H   ;SEGNALA PASSAGGIO DALLA TASTIERA
MNOPR1: EQU     4348H   ;USATA PER CONTEGGIO NOPRINT S1
MNOPR2: EQU     434AH   ;USATA PER CONTEGGIO NOPRINT S2
ALTERR: EQU     434CH   ;ALT CALCOLO ERR.DOPO USO TASTIER 
ZEROSE: EQU     434EH   ;SEGNO IN ZERO ENCODER 
ALTGUA: EQU     4350H   ;DOPO N GIRI FISSA IL GUADAGNO
MRIC:   EQU     4352H   ;435EH  GRUPPO MEME IN RICERCA AUTOMATICA SSRR
;+00H SEGNALA RICERCA IN CORSO MMSS
;+02H CONTA I GIRI DELLA RICERA
;+04H SEGNO DOPPIO 0=CONTROLLO ATTIVO 1=SCRITTA ABILITATA 2=DISABILITATO SSDD
;+06H CONTEGGIO GIRI PER CANCELLARE LA SCRITTA DOPPIO MMSS
;+08H USATA PER SCRITTURA FASE ESEGUITA RRAA

MDO032: EQU     4360H   ;MOLTIPLICANDO BASSO A 32 BIT 
MDO232: EQU     4362H   ;MOLTIPLICANDO ALTO A 32 BIT 
MRE032: EQU     4364H   ;MOLTIPLICATORE BASSO 32 BIT 
MRE232: EQU     4366H   ;MOLTIPLICATORE ALTO A 32 BIT
PTO032: EQU     4368H   ;PRODOTTO BASSO A 32 BIT 
PTO232: EQU     436AH   ;PRODOTTO ALTO  A 32 BIT
EDEND0: EQU     436CH   ;DIVIDENDO BASSO DIVISIONE 32BIT
EDEND2: EQU     436EH   ;DIVIDENDO ALTO DIVISIONEO 32BIT
QUOZ32: EQU     4370H   ;QUOZ DIVISIONE 32BIT DIVISO 4096
MINUE0: EQU     4372H   ;MINUENDO BASSO SOTT. A 32 BIT
MINUE2: EQU     4374H   ;MINUENDO ALTO SOTT. A 32 BIT
SUBTR0: EQU     4376H   ;SOTTRAENDO BASSO SOTT. A 32 BIT
SUBTR2: EQU     4378H   ;SOTTRAENDO ALTO SOTT. A 32 BIT                     
RESTO0: EQU     437AH   ;RESTO BASSO SOTT. A 32 BIT
RESTO2: EQU     437CH   ;RESTO ALTO SOTT. A 32 BIT
MIXUE0: EQU     437EH   ;MINUENDO ALTERNATIVO BASSO
MIXUE2: EQU     4380H   ;MINUENDO ALTERNATIVO ALTO
SUXTR0: EQU     4382H   ;SOTTRAENDO ALTERNATIVO BASSO
SUXTR2: EQU     4384H   ;SOTTRAENDO ALTERNATIVO ALTO
SETUP1: EQU     4386H   ;USATA IN SET-UP PARAMETRI 
SETUP2: EQU     4388H   ;USATA IN SET-UP PARAMETRI
TEST1:  EQU     438AH   ;USATA IN TEST TESTA ESPLORANTE
TEST2:  EQU     438CH   ;USATA IN TEST TESTA ESPLORANTE
ENCOD1: EQU     438EH   ;USATA IN TEST ENCODER
ENCOD2: EQU     4390H   ;USATA IN TEST ENCODER
ENCOD3: EQU     4392H   ;CONTEGGIO TENTATIVI TEST
ENCOD4: EQU     4394H   ;CONTEGGIO IMPULSI FINALE  XXTT
MATTES: EQU     4396H   ;USATA IN DECREM.CILCI ATTESA

MFLEXL: EQU     4398H   ;ABILITA CORREZ. LONG. ALLA FASE   FFZZ AAVV
FLERRO: EQU     439AH   ;ERRORE DA CORREGGERE IN FLEXO  FFZZ  AAVV   

ZERCIN: EQU     439CH   ;METTE 0 o 5 SOLO NELL'ERRORE         AAVV

MNOP01: EQU     43A0H   ;USATA IN NO PRINT PER MANTENERE L'AALARME BBLL
MDATE1:	EQU	43A4H	;MEM. F1 ERRATO EEOO DA METTERE IN ORDINE NELLA SEQUENZA EEOO
MDATE2:	EQU	43A6H	;MEM. F3 ERRATO EEOO DA METTERE IN ORDINE NELLA SEQUENZA EEOO

VMEDIA: EQU     43B0H   ;USATA IN CALCOLO VELOCITA'MEDIA AAVV WWAA
VELPRE: EQU     43B2H   ;MEM. DELLA VELOCITA' PRECEDENTE AAVV WWAA
IMPVEL: EQU     43B4H   ;IMPULSI ENCODER IN 4 mS AAVV         WWAA
MSOGLI: EQU     43B6H   ;MEM. BASSA VELOCITA'AAVV             WWAA
VELMED: EQU     43B8H   ;MEM.DELLA VELOCITA' AAVV             WWAA
ISTVEL: EQU     43BAH   ;VELOCITA' ISTANTANEA AAVV            WWAA

MVEL00: EQU     43C0H   ;DA 43C0H A 43DFH USATA IN WWAA
                         ;CALCOLO VELOCITA' MEDIA

MOSCI1: EQU     43F2H   ;USATA PER FASE CON OSCILLOSCOPIO FF56
INCEXT: EQU     43F4H   ;AUMENTA VELOCITA SCANSIONE IN FUNZ5 FF55


MAVA00: EQU     4400H   ;DA 4400H A 445FH  SONO 96 LOCAZIONI WWAA
                        ;USATE IN CALCOLO MEDIA ERRORE AVANTI
MRIT00: EQU     4460H   ;DA 4460H A 44BFH  SONO 96 LOCAZIONI WWAA
                        ;USATE IN CALCOLO MEDIA ERRORE RITARDO

DAVA00: EQU     44C0H   ;DA 44C0H A 44DFH  SONO 16 LOCAZIONI WWAA
                        ;USATE IN CALCOLO MEDIA ERRORE AVANTI DISPLAY
DRIT00: EQU     44E0H   ;DA 44E0H A 44FFH  SONO 16 LOCAZIONI WWAA
                        ;USATE IN CALCOLO MEDIA ERRORE RITARDO DISPLAY


ERATTU: EQU     4500H   ;ERRORE ATTUALE   ;LLTT FFXX   MMDD  WWAA
ERPREC: EQU     4502H   ;ERRORE PRECEDENTE   LLTT FFXX      WWAA
ERMEDI: EQU     4504H   ;MEMORIA ERRORE MEDIO LONG LLTT FFXX    WWAA
ERAT10: EQU     4506H   ;ERRORE ATTUALE PER DIECI  WWLL

PRIMOB: EQU     4520H   ;VALORE DA DARE AL PRIMO REG B IN MEDIALOMG   WWAA PUUU
SECONB: EQU     4522H   ;VALORE DA DARE AL SECONDO REG B IN MEDIALOMG WWAA
VALORX: EQU     4524H   ;VALORE DA DARE AL REG IX IN MEDIALOMG        WWAA
SOMLO1: EQU     4526H   ;PRIMA SOMMA PER MEDIA LONG GGAA   WWAA
SOMLO2: EQU     4528H   ;SECONDA SOMMA PER MEDIA LONG GGAA WWAA
SOMDL1: EQU     452AH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.
SOMDL2: EQU     452CH   ;USATA IN CALCOLO MEDIA DIPLAY LONG.
NANOCI: EQU     452EH   ;SEGNALA CILINDRO INFERIORE A 9" NNCC PUUU

ALTERN: EQU     4540H   ;CONTEGGIO ALTERNANZA
;DOPPIO:	EQU	4542H	;0=CONTROLLO ATTIVO 1=SCRITTA ABILITATA 2=DISABILITATO SSDD


CORRATT:EQU	45B0H   ;CONTIENE IL VALORE CON SEGNO DELLA CORREZIONE IN BASE ALL'ERRORE (4BYTE)NNDD

CINUE0: EQU     45B4H   ;MINUENDO BASSO CSOTT32	SOTTRAZIONE	32 BIT NNDD
CINUE2: EQU     45B6H   ;MINUENDO ALTO CSOTT32		SOTTRAZIONE	32 BIT NNDD
CUBTR0: EQU     45B8H   ;SOTTRAENDO BASSO CSOTT32	SOTTRAZIONE	32 BIT NNDD
CUBTR2: EQU     45BAH   ;SOTTRAENDO ALTO CSOTT32	SOTTRAZIONE	32 BIT NNDD           
CESTO0: EQU     45BCH   ;RESTO BASSO CSOTT32		SOTTRAZIONE	32 BIT NNDD
CESTO2: EQU     45BEH   ;RESTO BASSO CSOTT32		SOTTRAZIONE	32 BIT NNDD

CADDE0:	EQU     45C8H   ;ADDENDO BASSO			SOMMA		32 BIT NNDD
CADDE2:	EQU     45CAH   ;ADDENDO ALTO			SOMMA		32 BIT NNDD
CAUGE0:	EQU     45CCH   ;AUGENDO BASSO			SOMMA		32 BIT NNDD
CAUGE2:	EQU     45CEH   ;AUGENDO ALTO			SOMMA		32 BIT NNDD
CSOMM0: EQU     45D0H   ;SOMMA BASSA			SOMMA		32 BIT NNDD
CSOMM2: EQU     45D2H   ;SOMMA ALTA			SOMMA		32 BIT NNDD

MSCORR_ATT:EQU 	45E0H   ;SENSO DELL'ERRORE ATTUALE NNDD
MSCORR_PREC:EQU 45E2H   ;SENSO DELL'ERRORE PRECEDENTE NNDD
PARA_NASC:EQU	45F0H   ;USATA PER ENTRARE NEI PARAMETRI NASCOSTI FFSS

MEMA:   EQU     4600H   ;MEMORIA DELLA PORTA A
MEMB:   EQU     4602H   ;MEMORIA DELLA PORTA B
MEMC:   EQU     4604H   ;MEMORIA DELLA PORTA C
CONALL: EQU     4606H   ;MEM.CONTEGGIO AVVISI ALLARME
GATMEZ: EQU     4608H   ;1/2 AMPIEZZA IMPULSI GATE
CILIN:  EQU     460AH   ;MEM. SVILUPPO CILINDRO
ALLAR:  EQU     460CH   ;MEM. VALORE ALLARME
CENTES: EQU     460EH   ;CENTESIMI IN UN IMP.DI ENCODER
MILLES: EQU     4610H   ;MILLESIMI IN UN IMP.DI ENCODER

FASRIF: EQU     461CH   ;MEM.FASE DI RIFERIMENTO DI S1
UNOMIL: EQU     461EH   ;1mm IN IMPULSI ENCODER 
RIFTOT: EQU     4620H   ;(FASRIFx10)+RAPRIF=RIFTOT 
AMPIM1: EQU     4626H   ;AMPIEZZA GATE1 IN IMPULSI ENCODER   
AMPIM2: EQU     4628H   ;AMPIEZZA GATE2 IN IMPULSI ENCODER   

CILDIV: EQU     462AH   ;CILINDRO DIVISO 10
CILMOL: EQU     462CH   ;CILINDRO MOLTIPLICATO x 10
SPESSO: EQU     462EH   ;MEM.IN LETTURA SPESSORE SEGNI
CONSEG: EQU     4630H   ;CONTA I SEGNI LETTI
CONSE1: EQU     4632H   ;CONTEGGIO SENZA AZZERAMENTO
DUEBIA: EQU     4634H   ;CONTEG.2 SPAZI BIANCHI OK 
NUSEOK: EQU     4636H   ;NøSEGNI CON SPAZIO BIANCO OK 
NUSOK1: EQU     4638H   ;COME NUSEOK MA IN DECREMENTO
MEMAB:  EQU     463AH   ;E 453EH USATE IN ABILITAZ.GATE
SEGENC: EQU     463CH   ;SPESS. SEGNO IN IMPULSI ENCODER  
MEMFAS: EQU     463EH   ;SEGNALA FASE O FASE2 
SEGINC: EQU     4640H   ;MEMORIZZA INCREMENTO DEL SEGNO
SEQSEG: EQU     4642H   ;E 4644H POS.SEGNO NELLA SEQUENZA 
SEGNO:  EQU     4646H   ;IMP. DA 2048 IN UN SEGNO DA 2mm
SPAZIO: EQU     4648H   ;IMP.DA 2048 IN UNO SPAZIO DA 5mm
SPAZ40: EQU     464AH   ;IMP.DA 2048 IN SPAZIO DA 40mm
DISTAN: EQU     464CH   ;DISTANZA TEORICA TRA S1 E S2
MILL45: EQU     464EH   ;4,5mm IN IMPULSI ENCODER CODICE ZELO 
MILL8:  EQU     4650H   ;8mm IN IMPULSI ENCODER CODICE ZELO   
MILL20: EQU     4652H   ;20mm IN IMPULSI ENCODER     
MILL35: EQU     4654H   ;35mm IN IMPULSI ENCODER DEVRIM
MILL60: EQU     4656H   ;6,0mm IN IMPULSI ENCODER TRIANGOLO  SSRR
GUADS1: EQU     4658H   ;VALORE GUADAGNO SEGNALE S1
GUADS2: EQU     465AH   ;VALORE GUADAGNO SEGNALE S2
DMILLE: EQU     465CH   ;DECIMILLESIMI IN UN IMP.DI ENCOD
DISTA0: EQU     465EH   ;DISTANZA BASSA IN DECIMILLESIMI
DISTA2: EQU     4660H   ;DISTANZA ALTA IN DECIMILLESIMI
CICATT: EQU     4662H   ;CICLI IN FUNZ. POSIZ. CILINDRO 
MLING:  EQU     4664H   ;USATA IN MEM. DELLA LINGUA
COSVEL: EQU     4666H   ;COSTANTE USATA IN VELOCITA'
CICL75: EQU     4668H   ;75% DEL CICLO DI CORREZZIONE 
CIDE75: EQU     466AH   ;MEM. DEL 75% DEL CICLO DI CORREZZIONE 
MEZGA:  EQU     4670H   ;MEM.AMPIEZZA 45% FF56

FASE:   EQU     4700H   ;MEM. INIZIO GATE DELLA FASE S1
FASE2:  EQU     4702H   ;MEM. INIZIO GATE DELLA FASE S2
FASE3:  EQU     4704H   ;PUNTO DI ABILITAZIONE  PER PA7

FASES1: EQU     4706H   ;MEMORIA DELLA FASE DI S1
TASES1: EQU     4708H   ;MEM TEMPORANEA FASE 1 TRAV
FASES2: EQU     470AH   ;MEMORIA DELLA FASE DI S2
TASES2: EQU     470CH   ;MEM TEMPORANEA FASE 2 TRAV
POSTO1: EQU     470EH   ;POSIZIONE TOTALE S1
TPOST1: EQU     4710H   ;POSIZIONE TOTALE S1 TRAVERS
POSTO2: EQU     4712H   ;POSIZIONE TOTALE S2
TPOST2: EQU     4714H   ;POSIZIONE TOTALE S1 TRAVERS


PIENO1: EQU     4716H   ;MEM. VALORE DEL PIENO S1
TPIEN1: EQU     4718H   ;MEM TEMPORANEA PIENO 1 TRAV
PIENO2: EQU     471AH   ;MEM. VALORE DEL PIENO S2
TPIEN2: EQU     471CH   ;MEM TEMPORANEA PIENO 2 TRAV
POSIZ1: EQU     471EH   ;MEM. VALORE DELLA POSIZIONE S1
TPOSI1: EQU     4720H   ;MEM TEMPORANEA POSIZ.1 TRAV
POSIZ2: EQU     4722H   ;MEM. VALORE DELLA POSIZIONE S2
TPOSI2: EQU     4724H   ;MEM TEMPORANEA POSIZ.2 LONG
CPOST1:	EQU	4726H	;POSIZIONE TOALE DI CENTRO S1
CPOST2:	EQU	4728H	;POSIZIONE TOALE DI CENTRO S2

RAPPO1: EQU     472AH   ;MEM. RAPPORTO S1
RAPPO2: EQU     472CH   ;MEM. RAPPORTO S2

MPIEN1: EQU     472EH   ;MEM TEMPORANEA PIENO 1 LONG  CCMM11
MPIEN2: EQU     4730H   ;MEM TEMPORANEA PIENO 2 LONG
MPOSI1: EQU     4732H   ;MEM TEMPORANEA POSIZ.1 LONG
MPOSI2: EQU     4734H   ;MEM TEMPORANEA POSIZ.2 LONG
MASES1: EQU     4736H   ;MEM TEMPORANEA FASE 1 LONG
MASES2: EQU     4738H   ;MEM TEMPORANEA FASE 2 LONG

TRAPP1: EQU     473AH   ;MEM.RAPPORTO S1 TRAVERS
TRAPP2: EQU     473CH   ;MEM.RAPPORTO S2 TRAVERS
SPELE1: EQU     473EH   ;SPESSORE SEGNO DI RIFERIMENTO  SSSS     
SPELE2: EQU     4740H   ;SPESSORE SECONDO SEGNO   SSSS     

LOLA:	EQU     4742H   ; WATCH DOG CHE INTERVIENE NELLE RUTINE DI ATTESA GIRO
TAP1:   EQU     5020H   ;TABELLA IND. INTER. PIO1A
TAP2:   EQU     5022H   ;TABELLA IND. INTER. PIO1B
TAB0:   EQU     5030H   ;TABELLA IND. INTER. CTC CANALE 0
TAB1:   EQU     5032H   ;TABELLA IND. INTER. CTC CANALE 1
TAB2:   EQU     5034H   ;TABELLA IND. INTER. CTC CANALE 2
TAB3:   EQU     5036H   ;TABELLA IND. INTER. CTC CANALE 3
TABLAV: EQU     5100H   ;INIZIO TABELLA MEM. LAVORI
		
		
		;INIZIALIZZAZIONE SISTEMA

  
		
		


		ORG     0000H
		JP      VIA

		ORG     0008H
		JP      VIA

		ORG     0010H
		JP      VIA

		ORG     0018H
		JP      VIA

		ORG     0020H
		JP      VIA

		ORG     0028H
		JP      VIA

		ORG     0030H
		JP      VIA

		ORG     0038H
		JP      VIA


		ORG     100H

VIA:
		LD	A,01H		;LOLA
		LD	(NOCIAO),A
		
RESET_PIO:            
		LD	HL,INIT_Z80
		LD	(5FFFH),HL
		LD	(5FFDH),HL
		LD      SP,5FFDH       ;DEF.AREA STACK
		RETI

INIT_Z80:
		LD	HL,VIA
		LD	(5FFFH),HL
		LD      SP,5FFFH        ;DEF.AREA STACK
		IM      2               ;IMPOSTA MODO PIO = 2
		LD      A,50H           ;IND.ALTO TAB.
		LD      I,A
                LD      IY,PIOA         ;IND.ROUT.INT.  SSVV
		LD      (TAP1),IY       ;CAR.TAB.INT.
		LD      A,20H           ;VET.INTER.PIO A
		OUT     (02H),A         ;CONTROLLO PIO A
		LD      A,0CFH          ;PORTA A MODO 3
		OUT     (02H),A
		LD      A,1FH           ;0-4 IN 5-6-7 OUT
		OUT     (02H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (02H),A 
		LD      A,0EFH          ;P.M.BIT 0123567
		OUT     (02H),A
                LD      IY,PIOB         ;IND.ROUT.INT.  SSVV
		LD      (TAP2),IY       ;CAR.TAB.INT.
		LD      A,22H           ;VET.INT.PIO B
		OUT     (03H),A         ;CONTROLLO PIO B
		LD      A,0CFH          ;PORTA B MODO 3
		OUT     (03H),A
		LD      A,1EH           ;0567 OUT 1234 IN
		OUT     (03H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (03H),A
		LD      A,0FDH          ;P.MAS.BIT 0234567
		OUT     (03H),A         ;ALL'INTERUPT
                LD      IY,CTC0         ;IND.ROUT.CTC0.  SSVV
		LD      (TAB0),IY       ;CAR.TAB.INT.CAN0
		LD      A,30H           ;VET.IND.CTC0
		OUT     (70H),A         ;VET.SEMPRE IN 0
                LD      IY,CTC1         ;IND.ROUT.CTC1   SSVV
		LD      (TAB1),IY       ;CAR.TAB.INT.CAN1
		LD      A,32H           ;VET.IND.CTC1
		OUT     (70H),A
                LD      IY,CTC2         ;IND.ROUT.CTC2  SSVV
		LD      (TAB2),IY       ;CAR.TAB.INT.CAN2
		LD      A,34H           ;VET.IND.CTC2
		OUT     (70H),A
                LD      IY,CTC3         ;IND.ROUT.CTC3  SSVV
		LD      (TAB3),IY       ;CAR.TAB.INT.CAN3
		LD      A,36H           ;VET.IND.CTC3
		OUT     (70H),A         ;VET.CARICATO
		EI                      ;SEMPRE IN 0

		;RESET DELLA PORTA C

		LD      A,80H           ;SBLOCCO PORTA C
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,(MEMC)        ;RESETTO LE USCITE
		RES     0,A             ;CHE NON VENGONO
		RES     1,A             ;UTILIZZATE
		NOP                     ;(FARMOPRINT)
		RES     5,A             ;RIMANE MEMORIZ-
		RES     6,A             ;ZATA LA CONDI-
		RES     7,A             ;ZIONE AUTO/MAN
		OUT     (PC),A
		LD      (MEMC),A


                ;AZZERAMENTO DA 4200H A 45FFH
		
		LD      A,00H
		LD      (BINSET),A      ;LOC. INIZIALE
		LD      HL,BINSET
		LD      DE,BINSET+01H
                LD      BC,03FFH        ;WWAA
		LDIR                    

		LD      A,02H           ;PER NON AVERE IN FFSS
		LD      (MATTES),A      ;DECREMENTO FFH
		LD      (CONSAL),A
		CALL    DEFAUL
                CALL    VARERR          ;WWAA
                CALL    VERIFI          ;UUEE
 

		;SE PIGIATO FUNZIONE SALTO A MOD.PARAMETRI

		IN      A,(PA)
		CP      8FH                                                                                                                                                                                                                   
		JR      NZ,FASTRA
		LD	A,01H		;SETTO IL RIFERIMENTO FFSS
		LD	(PARA_NASC),A	;PARAMETRI NASCOSTI FFSS
		JP      MODPA

		LD	A,(LOLA)	;SE RESETTATO
		CP	00H		;IN GIRO SALTA
		JP	NZ,MAIN1	;SCRITTA 

		;TRASMISSIONE DELLA FASE

FASTRA:         LD      A,(NOCIAO)     ;SALTA  SE 
                CP      01H            ;NON E' ALLA LOLA
		JR      NZ,FASTR1      ;PARTENZA 
		CALL    CIAO           

FASTR1:         LD      HL,(FASE)      ;SSVV
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
;		LD      A,00H          
;		LD      (BINSET+10H),A		;LOLA
;		LD      A,40H
;		LD      (BINSET+0FH),A
;		LD      (BINSET+0EH),A
;		LD      (BINSET+0DH),A                     
;		LD      (BINSET+0CH),A
;		EXX
;	        CALL    TRDIS
FASAUT:       
		LD      A,(MRIC+00H) 
		CP      01H
		JR      NZ,MAIN

		CALL	AZZTOT	
		CALL    CODICE
		CALL	FASEOK		;RRAA


		;MAIN PROGRAMMA PRINCIPALE DI CALCOLO

MAIN:            
		CALL	CONTR		;EEOO
		LD	DE,(FASES1)	;PROTEZIONE PUUU
		LD	HL,(FASES2)	;IN CASO DI
		SBC	HL,DE		;LETTURA SBAGLITA
		JP	Z,GIR1		;PUUU
		JR	NC,MAIN1
		CCF

MAIN1:          LD      A,(MCALER)      ;VEDE SE DEVE
		CP      00H             ;CALCOLARE O NO
		JP      Z,GIR1

		LD      A,00H		;QUANDO VA REGOLARMENTE LOLA
		LD	(LOLA),A	;ANNULLO IL RESET

		LD      (MCALER),A
                LD      (NOCIAO),A      ;PER NUOVA PART. 
		LD      A,(ALTERR)      ;VEDE SE DEVE
		CP      00H             ;ASPETTARE
		JP      NZ,GIR1         

		;CALCOLO RAPPORTO POSIZINE PIENO S1

MAIN2:        
		LD      DE,(ERATTU)     ;MEMORIZZO ERRORE
		LD      (ERPREC),DE     ;PRECEDENTE

                LD      A,(MSCORR)      ;WWAASALVO SEGNO

                LD      IX,PIENO1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,RAPP10        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
		JR      RAPP11
RAPP10:         CCF
		LD      A,00H
RAPP11:         LD      (RAPPO1),A      ;VERIFICO SE E'

		;CALCOLO RAPPORTO POSIZINE PIENO S2

		LD      IX,PIENO2       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
		LD      IY,POSIZ2       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
		JR      C,RAPP20        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
		LD      IY,PIENO2
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
		JR      RAPP21
RAPP20:         CCF
		LD      A,00H
RAPP21:         LD      (RAPPO2),A      ;VERIFICO SE E'

		;CALCOLO POSIZIONE TOTTALE S1

		LD      DE,(FASES1)     ;FASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPPO1)
		LD      H,00H
		ADD     HL,DE
		LD      (POSTO1),HL

		;CALCOLO POSIZIONE TOTTALE S2
		
		LD      DE,(FASES2)     ;FASES2 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(RAPPO2)
		LD      H,00H
		ADD     HL,DE
		LD      (POSTO2),HL
		
		LD	A,(SELFRO)	;SCELTA TRA FRONTE FFSS
		CP	01H		;O SPESSORE FFSS
		JR	Z,SELSPE	;FFSS

		LD      DE,(POSTO1)	;FFSS
		SBC     HL,DE
		JP      NC,Z1           ;SE LA MISURA E' FFSS
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(POSTO2)     ;POSTO2<POSTO1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO1)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC.FFSS
		JR	Z1		;FFSS

SELSPE:					;FFSS
		CALL	TRAVER		;SSSS


		;CALCOLO VALORE TOTALE DEL PUNTO MEDIANO DEL SEGNO

		LD	HL,(TPOST1)	;SOTTRAGGO IL VALORE DI SSSS
		LD	DE,(POSTO1)	;FINE SEGNO CON QUELLO INIZIALE
		SBC	HL,DE
		JR      NC,ZX1          ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST1)     ;TPOST1<POSTO1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO1)     ;A POSTO1 40960
		SBC     HL,DE           ;E RIPETO SBC.
ZX1:
		LD      (DIVDEN),HL     ;IL VALORE CHE RAPPRESENTA 
		LD      BC,0002H        ;LO SPESSORE  LO DIVIDO
		LD      (DIVSOR),BC     ;PER DUE IL RISULTATO 
		CALL    DIVIS           ;LO SOMMO A POSTO1
		LD      HL,(QUOZIE)	;E OTTENGO COSI UN 
		LD	DE,(POSTO1)	;VALORE CHE CORRISPONDE
		ADD	HL,DE		;ALCENTRO DEL SEGNO
		LD	(CPOST1),HL	;SSSS

		LD	HL,(TPOST2)	;SOTTRAGGO IL VALORE DI SSSS
		LD	DE,(POSTO2)	;FINE SEGNO CON QUELLO INIZIALE
		SBC	HL,DE
		JR      NC,ZX2          ;SE LA MISURA E'
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(TPOST2)     ;TPSTO2<POSTO2
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(POSTO2)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC.
ZX2:
		LD      (DIVDEN),HL     ;IL VALORE CHE RAPPRESENTA
		LD      BC,0002H        ;LO SPESSORE  LO DIVIDO
		LD      (DIVSOR),BC     ;PER DUE IL RISULTATO 
		CALL    DIVIS           ;LO SOMMO A POSTO2
		LD      HL,(QUOZIE)	;E OTTENGO COSI UN
		LD	DE,(POSTO2)	;VALORE CHE CORRISPONDE
		ADD	HL,DE		;ALCENTRO DEL SEGNO
		LD	(CPOST2),HL	;SSSS
		LD	DE,(CPOST1)
		SBC	HL,DE		;
		JR      NC,Z1           ;SE LA MISURA E' SSSS
		CCF                     ;FATTA A CAVALLO
		LD      HL,0A000H       ;DI ZERO ENCODER
		LD      DE,(CPOST2)     ;CPOST2<CPOST1
		ADD     HL,DE           ;PER CUI SOMMO  
		LD      DE,(CPOST1)     ;A POSTO2 40960
		SBC     HL,DE           ;E RIPETO SBC. SSSS


		;(ERRORE x DECIMILLES.IN DIV.ENC.)-
		;DISTANZA IN CENTIMILLESIMI : 1000 =ERRORE
		;IN CENTESIMI

Z1:            
		LD      (MDO032),HL     ;HL=DISTANZA S1/S2
		LD      HL,0000H
		LD      (MDO232),HL
		LD      BC,(DMILLE)
		LD      (MRE032),BC
		LD      (MRE232),HL
		CALL    MOL32
		LD      BC,(PTO032)
		LD      DE,(PTO232)
		LD      (MINUE0),BC
		LD      (MINUE2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (SUBTR0),BC
		LD      (SUBTR2),DE
                LD      A,00H
                LD      (ALTDIV),A      
		CALL    SOTT32
		CALL    DI1000
		LD      DE,(QU1000)     ;ERRORE 
		LD      (ERATTU),DE     
		LD      A,(MTASTI)      ;CONTROLLO SE
		CP      00H             ;SONO PASSATO
		JR      NZ,ERR1         ;DALLA TASIERA.
                LD      A,(CONSAL)      ;CONTROLLO  MMUU
                CP      00H		;SE DEVO ATTIVARE 
                JR      Z,ERR5		;IL SALTO
                LD      A,(CONSAL)      ;DECREMENTA I GIRI
                DEC     A               ;DI BLOCCO
                LD      (CONSAL),A      ;PER IL SALTO
                CP      00H              
                JR      Z,ERR5            
                JP      GIR1  
ERR5:

;		LD	A,(SALTO)	;SE SALTO = 0 FFSS
;		CP	00H		;SALTO QUESTA FFSS
;		JR	Z,ERR7		;PARTE FFSS

		LD      HL,0064H        ;SOMMO A ERPREC
		LD      BC,(ERPREC)     ;1mm IL RISULTATO
		ADD     HL,BC           ;LO SOTTRAGGO A
		SBC     HL,DE           ;ERATTU SE CARRY
		JR      NC,ERR2         ;SE VI E' STATA  
		CCF                     ;UNA LETTURA SBAL-
		LD      BC,(ERPREC)     ;LATA LA IGNORO.
		LD      (ERATTU),BC

		LD	A,(SALTO)	;CARICA I GIRI MMUU
		LD	(CONSAL),A	;DI ATTESA

		LD	A,(SALTO)	;SE SALTO E'	MMUU
		CP	00H		;ZERO CORREGGO MMUU
		JR	Z,ERR7		;SEMPRE MMUU

		LD      A,(CONSAL)      ;CONTROLLA CHE NON
		DEC     A               ;CHE NON RIMANGA
		LD      (CONSAL),A      ;IN BLOCCO PER PIU'
		CP      00H             ;DI N GIRI MEMO- 
		JR      Z,ERR3          ;RIZZATI IN SALTO  
		JP      GIR1            ;E POI
ERR3:           LD      (ERATTU),DE     ;RICARICA L'ULTIMO
		LD      (ERPREC),DE     ;ERRORE LETTO
		JR      ERR2            
ERR1:           DEC     A               ;ATTESA 4 GIRI SE
		LD      (MTASTI),A      ;PASSATO DA TATSI.
ERR2:  
		LD      A,(SALTO)       ;CARICA I GIRI DI MMUU
		LD      (CONSAL),A      ;ATTESA.
ERR7:		LD      A,(MKBUSY)      ;VEDO SE TASTIERA EEUU
		CP      00H             ;E' IN USO
		JP      NZ,GIR1		;


                CALL    LMEDIA
                LD      A,(MEMC)        ;SE PROT. SALTO
                BIT     4,A             ;PER ELIMINARE
                JR      NZ,ERR4         ;FLASH AL DISPLAY
                LD      A,01H           ;PER AVERE
                LD      (ZERCIN),A      ;0 o 5 SOLO
                CALL    BIN7            ;NELL'ERRORE 
ERR4:           LD      A,01H           ;SEGNALAZ.DISPLAY
		LD      (MDBUSY),A      ;OCCUPATO DA ERROR



		;CONTROLLO SOGLIA INSERZIONE
       
SOGLIN:         CALL    VELO
                LD      HL,(ISTVEL)     ;LD      HL,(VELMED) FF55  
		LD      DE,(INSER)      
		SBC     HL,DE            
		JR      C,SOGLI2        
SOGLI1:         LD      A,(MEMC)        ;TOLGO LA
		RES     4,A             ;PROTEZIONE
		LD      (MEMC),A
		OUT     (PC),A
                LD      A,00H           ;ANNULLO  MEM 
                LD      (MSOGLI),A      ;BASSA VELO 
		JR      ALLA1 
SOGLI2:         CCF                     
		LD      A,05H           ;BLOCCO ALL.
		LD      (CONALL),A
                CALL    LOWSPE          
                LD      A,01H           ;SEGNALO 
                LD      (MSOGLI),A      ;BASSA VELO
		LD      A,07H           ;SE INSER E'
		LD      (MATTES),A      ;MAGGIORE
		LD      A,(MEMC)        ;BLOCC0 LA COR-
		RES     3,A             ;REZIONE E AL
		SET     4,A             ;LARME E AUMEN-
		LD      (MEMC),A        ;TANDO I CICLI
		OUT     (PC),A          ;DI ATTESA.
		JR      GIRO



		;CONTROLLO SOGLIA ALLARME 

ALLA1:          LD      A,(ALLAR)       ;SE ALLARME E'
		CP      00H             ;MESSO A ZERO
		JR      Z,NOALL         ;SALTA.
		LD      HL,(ALLAR)      ;CONTROLLO SE 
		LD      DE,(ERMEDI)     ;L'ERRORE HA SU-
		SBC     HL,DE           ;PERATO LA SOGLIA
		JR      NC,NOALL        ;DI ALLARME
		CCF
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
		JR      Z,NOALL
		LD      A,(CONALL)      ;CONTO 5 AVVISI
		CP      00H             ;PRIMA DI ATTIVA- 
		JR      Z,ALLA2         ;RE L'ALLARME
		DEC     A
		LD      (CONALL),A
		JR      GIRO
ALLA2:          LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
		JR      GIRO
NOALL:
                LD      A,(MNOP01)      ;BBLL BBLL BBLL
                CP      01H      
                JR      Z,GIRO          ;BBLL  BBLL

                LD      A,(MEMC)
		RES     3,A             ;DISATTIVO ALLARM
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,05H           ;CARICO 5 AVVISI
		LD      (CONALL),A      ;DI ALLARME

GIRO:           CALL    CORREZ
		JP      GIR1




                ;ROUTINE DI ATTESA

GIR1:           EI                      ;õõõõõõõõõõõõõõ

		LD	A,(MRIC+08H)	;CONTROLLO SE DEVO RRAA
		CP	01H		;SCRIVERE FASE
		JR	NZ,G13		;ESEGUITA
		CALL	FASEOK		;RRAA
G13:					;RRAA
		LD	A,(MNOPRI)	;CONTROLLO SE JJJJJ
		CP	00H		;DEVO CHIAMARE NOPRI
		JR	Z,G15
		CALL	NOPRI
G15:					;JJJJ
                LD      A,(MEMC)        ;SE SONO IN BBLL
                BIT     2,A             ;MANUALE
                JR      NZ,G14          ;DISATTIVO
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL


G14:            LD      A,(MKBUSY)      ;SE STO USANDO
		CP      01H             ;LA TASTIERA
                JR      NZ,G1           ;BLOCCO LE 
		LD      A,(MEMC)        ;CORREZIONI
		RES     0,A
		RES     1,A
		RES     4,A
		LD      (MEMC),A
		OUT     (PC),A          

G1:             LD      BC,9FFFH	;LOLA FF11
G12:            DEC     BC
		LD      A,B
		OR      C
                JR      NZ,G12

		LD	A,(LOLA)	;INCREMETA IL
		INC	A		;CONTEGGIO DEL
		LD	(LOLA),A	;WATCH DOG DI GIRO
		CP	20H
		JP	Z,RESET_PIO	;LOLA

                CALL    G10

G2:             LD	BC,0FFFH	;RITARDO PER FF11
G3:             DEC     BC              ;VEDERE SE
                LD      A,B             ;GIRA ENCODER
		OR      C
                JR      Z,G4

                IN      A,(PB)          ;SOLO QUANDO LA
		BIT     4,A             ;MACCHINA GIRA
                JR      Z,G3            ;SALTA
                JR      G6
G4:             LD      A,(MKBUSY)      ;SE STO USANDO
		CP      01H             ;LA TASTIERA
                JR      Z,G9            ;SALTO 
                CALL    STOP            
G5:             CALL    G10

G6:             LD      BC,0FFFH        ;RITARDO PER FF11
G7:             DEC     BC              ;VEDERE SE 
                LD      A,B             ;GIRA ENCODER
		OR      C
                JR      Z,G8

                IN      A,(PB)          ;SOLO QUANDO
                BIT     4,A             ;LA MACCHINA
                JR      NZ,G7           ;GIRA SALTA
                JR      G9

G8:             LD      A,(MKBUSY)      ;SE STO USANDO
		CP      01H             ;LA TASTIERA
                JR      Z,G9            ;SALTO 

                CALL	STOP

                LD      DE,0000H        ;AAVV
                LD      (MVEL00),DE     ;AZZERO LE MEM.
                LD      HL,MVEL00       ;DELLA MEDIA
                LD      DE,MVEL00+01H   ;E DELLA 
                LD      BC,001FH        ;VELOCITA AAVV 
                LDIR

                LD      A,(MEMC)        ;DISTTIVO BBLL
                RES     3,A             ;ALLARME
                LD      (MEMC),A
                OUT     (PC),A          ;BBLL



G9:             JP      FASAUT
G10:            LD      A,00H           ;CONTROLLO SE
		LD      (SETUP1),A      ;DEVO ANDARE
		LD      A,(SETUP2)      ;IN MODIFICA
		CP      01H             ;PARAMETRI
		JP      Z,MODPA
		LD      A,00H           ;CONTROLLO SE
		LD      (TEST1),A       ;DEVO ANDARE
		LD      A,(TEST2)       ;IN TEST
		CP      01H             
		JP      Z,TEST
		RET




		;GESTIONE TASTIERA


PIOA:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
		LD      A,04H           ;SERVE IN ERR1
		LD      (MTASTI),A      ;PER E ELIMINARE
		LD      A,(MEMA)        ;IL SALTO QUANDO 
		RES     7,A             ;DA TASTIERA IN
		OUT     (PA),A          ;AUTO O IN MANUA-
		LD      (MEMA),A        ;LE SI FA UN GROS-
		LD      DE,0FFFH        ;SO SPOSTAMENTO.
KRIT1:          DEC     DE                
		LD      A,D
		OR      E
		JR      NZ,KRIT1
		IN      A,(PA)          
		BIT     4,A
		JP      NZ,ESCI
		AND     0FH             
		LD      L,A             ;LEGGO DUE VOLTE
		LD      H,00H           ;LA TASTIERA CON
		LD      DE,TABLE        ;UN RITARDO TRA 
		ADD     HL,DE           ;PRIMA E LA SECON-
		LD      B,(HL)          ;DA LETTURA SE 
		LD      DE,0FFFH        ;SONO EGUALI 
KRIT2:          DEC     DE              ;PROCEDO SE NO 
		LD      A,D             ;ESCO
		OR      E
		JR      NZ,KRIT2
		IN      A,(PA)
		BIT     4,A
		JP      NZ,ESCI
		AND     0FH             
		LD      L,A
		LD      H,00H
		LD      DE,TABLE
		ADD     HL,DE
		LD      A,(HL)          ;SECONDA LETTURA
		CP      B               ;B= PRIMA LETTU-
		JP      NZ,ESCI         ;RA
		CP      0EH
		JP      Z,AUTMAN
		LD      A,(MDBUSY)      ;SE IL DISPLAY
		CP      00H             ;E' OCCUPATO 
		JR      Z,PIOA1         ;DALL'ERRORE DI
		LD      A,00H           ;REGISTRO LO
		LD      (MDBUSY),A      ;CANCELLO
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A
		CALL    BIOTT
PIOA1:          LD      A,01H           ;SEGNALA L'USO
		LD      (MKBUSY),A      ;DELLA TATSIERA
                LD      A,00H           ;ANNULLO SE- 
                LD      (MSOGLI),A      ;GNALAZIONE 
		LD      A,(HL)
		CP      0AH
		JR      Z,CLEA1
		CP      0BH
		JP      Z,ENTE1
		LD      A,(MEM0)        ;CONTROLLO SE 
		BIT     0,A             ;INSERITE FUN-
		JP      NZ,KBRD1        ;ZIONI
		LD      A,(MEM1)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM2)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM3)
		BIT     0,A
		JP      NZ,KBRD1

		LD      A,(MEM5)        ;FF55
                BIT     0,A
                JP      NZ,KBRD1
		
		LD      A,(MEM6)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(MEM7)
		BIT     0,A
		JP      NZ,KBRD1
		LD      A,(HL)          ;CONTINUO LA
		CP      0DH             ;LA CODIFICA
                JP      Z,MENO1         ;DELLA TASTIERA
		CP      0CH
                JP      Z,PIU1
		LD      A,(MEMTF)       ;CONTROLLO SE
		CP      00H             ;PIGIATO PRECE-
		JP      NZ,FUNZI        ;DENTEMENTE F
		LD      A,(HL)
		CP      0FH
		JP      Z,FUNZI
		CP      0AH             ;SE NON E' UN
		JR      NC,NONUM        ;NUMERO SALTA
		CALL    MUOVO
		CALL    BIOTT
NONUM:          LD      (MEMTF),A       ;MEMORIZZA
		JP      ESCI            ;LA FUNZIONE
CLEA1:
		IN      A,(PA)          ;SE TASTO CANC SSDD
		AND	0FH		;PIGIATO CANCELLA
		CP      0AH              
		JR      NZ,CLEA2        ;SCRITTA DOPPIO SSDD
		LD	A,(MRIC+04H)	;MMSS
		CP	01H
		JR	NZ,CLEA2
		LD	A,02H
		LD	(MRIC+04H),A	;SSDD	MMSS
		LD      A,43H		;RESETTO CTC3 PER SSDD
		OUT     (73H),A		;CONTROLLO SEGNO DOPPIO

CLEA2:					;SSDD
	        LD      A,00H           ;CANCELLA
		LD      IX,BINSET+06H   ;LE MEMORIE
		LD      (IX+00H),A      ;TEMPORANEE
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		LD      (BINSET+10H),A  ;E LA LETTERA
		LD      (MEM0),A        ;AZZERO MEMORIE
		LD      (MEM1),A
		LD      (MEM2),A        
		LD      (MEM3),A
                LD      (MEM5),A        ;FF55 
		LD      (MEM6),A
		LD      (MEM7),A
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MEMTF),A       ;AZZERO MEM.
		LD      (MEMID),A       ;TASTO F E INIZIA-
		LD      (MDATER),A      ;LIZAZZIONE DISP.
		LD      (MKBUSY),A      ;DATA ERROR E
		CALL    BIOTT           ;TASTIERA IN USO.
CLEAT1:         IN      A,(PA)          
		AND     1AH             ;SENTO SE IL
		CP      0AH             ;TASTO CLEAR
		JR      NZ,CLEAT3       ;E'PIGIATO PER
		LD      BC,0A00H        ;PIU' DI 5 SEC.
CLEAT2:         DEC     BC              ;SE LO E' 
		LD      A,B             ;ATTIVO L'AC-
		OR      C               ;CESSO AL CAMBIO 
		JR      NZ,CLEAT2       ;PARAMETI
		LD      A,(TEST1)
		INC     A
		LD      (TEST1),A
		CP      0FFH
		JR      NZ,CLEAT1
		LD      A,01H
		LD      (TEST2),A
CLEAT3:         JP      ESCI            
  
MENO1:          LD      A,(MEMC)        ;SE IN MANUALE
		BIT     2,A             ;MOTORE RITARDO 
		JP      Z,MANRIT        
		LD      A,40H           ; -
		LD      (BINSET+10H),A

                LD      A,00H           ;AZZERO PER OOPP
                LD      (MRIT00),A      ;NON AVERE
                LD      HL,MRIT00       ;CORREZIONI
                LD      DE,MRIT00+01H   ;INVERSE ALLO
                LD      BC,05FH         ;AL SENSO
                LDIR                    ;DELLO SHIFT OOPP

		CALL    BIOTT
		CALL    BCDBIN
		JP      ESCI

PIU1:           LD      A,(MEMC)        ;SE IN MANUALE
		BIT     2,A             ;MOTORE AVANTI
		JP      Z,MANAVA
		LD      A,70H           ; +
		LD      (BINSET+10H),A

                LD      A,00H           ;AZZERO PER OOPP
                LD      (MAVA00),A      ;NON AVERE
                LD      HL,MAVA00       ;CORREZIONI
                LD      DE,MAVA00+01H   ;INVERSE ALLO
                LD      BC,05FH         ;AL SENSO
                LDIR                    ;DELLO SHIFT OOPP

		CALL    BIOTT
		CALL    BCDBIN
		JP      ESCI
	
ENTE1:
 		LD      A,(MEM5)        ;FF5555
                BIT     0,A             ;FF5555
                JP      NZ,ENTE31       ;FF5555

	        LD      A,(MEM0)
		BIT     0,A
		JP      NZ,FUN3
		LD      A,00H           ;AZZERO MEM.
		LD      (MEM0),A
		LD      (MEM1),A
		LD      (MEM2),A
		LD      (MEM3),A
		LD      (MEM6),A
		LD      (MEM7),A
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MEMTF),A       ;TASTO F E INI-
		LD      (MEMID),A       ;ZIALIZZAZIONE
		CALL    BCDBIN          ;DISPLAY
		LD      A,(BINSET+10H)  ;SE SELEZIONATO
		CP      40H             ;MENO SALTO
		JP      Z,ENTE3         ;SE SELEZIONATO
		CP      70H             ;PIU' SALTO
		JP      Z,ENTE3   
		CP      73H             ;SE SELEZIONATO
		JP      Z,ENTE4         ;P SALTO
		CP      50H
		JP      Z,ENTE6
		CP      1CH
		JP      Z,ENTE7
                CP      39H             
                JP      NZ,ENTE2        
                CALL    INTCOR          ;AGGIORNA CICLI.
                LD      DE,(CILIN)      ;MOLTIPLICO PER
		LD      (MOLTI),DE      ;10 IL CILINDRO
		LD      A,0AH           ;PER POTER USARE
		LD      (MOLPL),A       ;AGGIUSTAMENTO
		CALL    MOLT            ;DECIMALE
		LD      BC,(PROD)
		LD      (CILMOL),BC     ;CILINDRO x 10
		LD      (MDO032),BC
		LD      DE,0000H        
		LD      (MDO232),DE     
		LD      BC,03E8H         
		LD      (MRE032),BC      
		LD      (MRE232),DE     
		CALL    MOL32
		LD      BC,(PTO032)     ;CILNDRO X 10000
		LD      DE,(PTO232)
		LD      (EDEND0),BC
		LD      (EDEND2),DE
		CALL    DIV32
		LD      DE,(QUOZ32)
		LD      (DMILLE),DE     ;DECIMILLESIMI
		LD      (DIVDEN),DE     ;CALCOLO QUANTI
		LD      BC,000AH        ;MILLESIMI CI 
		LD      (DIVSOR),BC     ;SONO IN UN
		CALL    DIVIS           ;CILINDRO
		LD      DE,(QUOZIE)
		LD      (MILLES),DE     ;MILLESIMI
		LD      (DIVDEN),DE     ;DIVIDO PER 10
		LD      BC,000AH        ;PER AVERE 
		LD      (DIVSOR),BC     ;I CENTESIMI
		CALL    DIVIS           
		LD      DE,(QUOZIE)
		LD      (CENTES),DE
		LD      DE,(CILIN)      ;DIVISIONE DEL
		LD      (DIVDEN),DE     ;CILNDRO PER 10
		LD      BC,000AH
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
		LD      (CILDIV),DE
		LD      DE,2710H        ;10000/DMILLE=                                     
		LD      (DIVDEN),DE     ;IMPULSI ENCO-
		LD      DE,(DMILLE)     ;DER PER 1mm
		LD      (DIVSOR),DE     
		CALL    DIVIS           
		LD      DE,(QUOZIE)     
		DEC     DE              
		LD      (UNOMIL),DE

                ;VERIFICA SE CILINDRO INFERIORE A 9"  NNCC

                LD      HL,(CILIN)
                LD      DE,00E6H        ;230 (9")
                SBC     HL,DE
                JR      NC,SILVC1
                CCF
                LD      A,01H
                JR      SILVC2
SILVC1:         LD      A,00H
SILVC2:         LD      (NANOCI),A


                ;SE CILINDRO INFERIORE A 6" SEGNALO ERRORE NNCC

                LD      HL,(CILIN)
                LD      DE,0098H        ;152 (6")
                SBC     HL,DE
                JR      NC,SILVC3
                CCF
		LD      A,01H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR
                JP      ESCI


                ;CALCOLO VALORI PER RICERCA
SILVC3:                
                LD      DE,1F40H        ;8000 
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL8),HL      ;8 ZELO 

                LD      DE,1194H        ;4500 
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL45),HL     ;4,5 ZELO


		LD      DE,4E20H        ;=20000
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
		LD      (MILL20),HL     ;20mm

                LD      DE,8868H        ;=35000 DEVRIM
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL35),HL     ;35mm

	        LD      DE,1770H        ;6000  SSRR
		LD      (DIVDEN),DE
		LD      BC,(MILLES)
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (MILL60),HL     ;6,0 mm SSRR


                LD      DE,0E4EH        ;4000x4096=  
                LD      (MDO032),DE     ;1638400
                LD      DE,0000H        ;60\1638400=
                LD      (MDO232),DE     ;0,000003662
                LD      (MRE232),DE     ;3662=0E4EH
                LD      DE,(CILIN)
                LD      (MRE032),DE
                LD      A,01H
                LD      (ALTDIV),A      
                CALL    MOL32
                CALL    DI1000
                LD      BC,(QU1000)
                LD      (COSVEL),BC     ;COSTANTE VEL. 
                

                LD      DE,06A4H        ;1700 VIENE  SSPP
                LD      (DIVDEN),DE     ;MESSO QUESTO SSPP
                LD      BC,(MILLES)     ;VALORE PER  SSPP
                LD      (DIVSOR),BC     ;IL SEGNO E SSPP
                CALL    DIVIS           ;MA DOVREBBE SSPP 
                LD      HL,(QUOZIE)     ;ESSERE 2000 SSPP
                LD      (SEGNO),HL      ;COME LOGICA SSPP
                DEC     HL              ;SSPP
                LD      (SPAZIO),HL     ;SSPP

                LD      DE,(MILL8)      ;QUESTO CALCO- FFXX
                LD      (MOLTI),DE      ;LO DA CIRCA 
                LD      A,02H           ;UNO SPAZIO
                LD      (MOLPL),A       ;DI 30mm REA-
                CALL    MOLT            ;LI MA VANNO
                LD      DE,(PROD)       ;BENE PER AVER
                LD      (SPAZ40),DE     ;TOLLERANZA  FFXX

ENTE2:          JP      CLEA1           
ENTE3:          CALL    SPOSTA
		JP      CLEA1


ENTE31:                                 ;FF5555
                LD      HL,(FASE)       ;CARICO IL FF5555 
                LD      A,H             ;CONTATORE PER FF5555
                OUT     (20H),A         ;LEGGERE POI S1 FF5555
                LD      A,L             ;FF5555
                OUT     (10H),A         ;FF5555
                LD      A,00H
                LD      (MEM5),A
                LD      (MOLTI),HL      ;MOLTIPLICO PER FF5555
                LD      A,0AH           ;10 PER AVERE IL
                LD      (MOLPL),A       ;RIFERIMENTO TO-
                CALL    MOLT            ;TALE TRASCURAN-
                LD      DE,(PROD)       ;DO IL RAPPORTO
                LD      (RIFTOT),DE
                LD      A,01H           ;FF56
                LD      (MOSCI1),A      ;FF56
                JP      CLEA1           ;FF5555



                ;CALCOLO VALORI GATE1

ENTE4:
                LD      A,(NANOCI)      ;NNCC
                CP      00H
                JR      Z,ENTE45
                LD      DE,0AH
                JR      ENTE46
ENTE45:         LD      DE,0CH          ;FISSO A 12mm
ENTE46:         LD      (MOLTI),DE      ;AMPIEZZA GATE1
		LD      A,64H           ;PER 100
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;AMPIEZA IN CENT.
		LD      (DIVDEN),DE
		LD      BC,(CENTES)
		LD      (DIVSOR),BC
                CALL    DIVIS           ;AMPIEZZA GATE1 IN
		LD      DE,(QUOZIE)     ;IMPULSI ENCODER.
                LD      A,D             ;SE E' MAGGIORE
                CP      00H             ;DI 255 IMPONGO
                JR      Z,ENTE41        ;255
                LD      DE,00FFH
ENTE41:      
		LD      (AMPIM1),DE
		LD      (MOLTI),DE
                LD      A,2DH           ;CALCOLO IL 45% 
		LD      (MOLPL) ,A      ;DELL'AMPIEZZA DEL
		CALL    MOLT            ;GATE
		LD      DE,(PROD)       
		LD      (DIVDEN),DE
		LD      BC,0064H
		LD      (DIVSOR),BC
		CALL    DIVIS
		LD      DE,(QUOZIE)
                LD      (MEZGA),DE


                ;CALCOLO VALORI GATE2

                LD      A,(NANOCI)      ;NNCC
                CP      00H
                JR      Z,ENTE47
                LD      DE,0AH
                JR      ENTE48
ENTE47:         LD      DE,12H          ;FISSO A 18mm  
ENTE48:         LD      (MOLTI),DE      ;AMPIEZZA GATE2
		LD      A,64H           ;PER 100
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)       ;AMPIEZA IN CENT.
		LD      (DIVDEN),DE
		LD      BC,(CENTES)
		LD      (DIVSOR),BC
                CALL    DIVIS           ;AMPIEZZA GATE2 IN
		LD      DE,(QUOZIE)     ;IMPULSI ENCODER.
                LD      A,D             ;SE E' MAGGIORE
                CP      00H             ;DI 255 IMPONGO
                JR      Z,ENTE43        ;255
                LD      DE,00FFH
ENTE43:         LD      (AMPIM2),DE     

		CALL	SPASI		;CCGG
	        CALL    INTCOR
                CALL    IIGATE          ;IIGG
ENTE42:     
		JP      CLEA1                    


FUNZI:          LD      A,71H           ;F
		LD      (BINSET+10H),A
		LD      A,40H           ;-
		LD      (BINSET+0FH),A
		LD      (BINSET+0EH),A
		LD      (BINSET+0DH),A
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		LD      A,00H           ;RESETTO PORTA C
		LD      (MEMC),A        ;IMPONENDO MANUALE
		OUT     (PC),A
		LD      A,(HL)          ;ASPETTO CHE    
		LD      (MEMTF),A       ;VENGA SCELTA
		CP      00H
		JR      Z,FUNZ0
		CP      01H
		JP      Z,FUNZ1
		CP      02H
		JP      Z,FUNZ2
		CP      03H
		JP      Z,FUNZ3
		CP      04H
		JP      Z,FUNZ4
		CP      05H
		JP      Z,FUNZ5
		CP      06H
		JP      Z,FUNZ6
		CP      07H
		JP      Z,FUNZ7
FUNZI1:         IN      A,(PA)          
		AND     1FH             ;SENTO SE IL
		CP      0FH             ;TASTO FUNZIONE
		JR      NZ,FUNZI3       ;E'PIGIATO PER
                LD      BC,0700H        ;PIU' DI 5 SEC.
FUNZI2:         DEC     BC              ;SE LO E' 
		LD      A,B             ;ATTIVO L'AC-
		OR      C               ;CESSO AL CAMBIO 
		JR      NZ,FUNZI2       ;PARAMETI
		LD      A,(SETUP1)
		INC     A
		LD      (SETUP1),A
		CP      0FFH
		JR      NZ,FUNZI1
		LD      A,01H
		LD      (SETUP2),A
FUNZI3:         JP      ESCI            
		
		
		;AZZERAMENTO DOPO REGISTRO MANUALE

FUNZ0:          LD      A,01H
		LD      (MEM0),A
		LD      A,77H           ;A
		LD      (BINSET+10H),A
		LD      A,5BH           ;Z
		LD      (BINSET+0FH),A
		LD      A,5BH           ;Z
		LD      (BINSET+0EH),A
		LD      A,79H           ;E
		LD      (BINSET+0DH),A
		LD      A,50H           ;r
		LD      (BINSET+0CH),A
		EXX                     ;SCRITTA
		CALL    TRDIS           ;AZZER
		JP      ESCI
FUN3:           LD      BC,(ERATTU)     ;CARICO L'ERRORE
		LD      (SHIFT),BC      ;LETTO IN SHIFT                                          
		LD      A,(MSCORR)      ;VEDO SE IN AVANTI
		CP      01H             ;O IN RITARDO E
		JR      Z,FUN1          ;CHIAMO LA ROUTINE
		LD      A,70H           ;SPOSTA PER CEN-
		LD      (PIUMEN),A      ;TRARLO NEL GATE.
		JR      FUN2
FUN1:           LD      A,40H
		LD      (PIUMEN),A
FUN2:           CALL    SPOSTA
		JP      CLEA1
		
		;PARAMETRI CILINDRO

FUNZ1:          LD      A,01H
		LD      (MEM1),A
		LD      DE,(CILIN)
		LD      (BINSET),DE
		LD      A,39H           ;C
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI
KBRD1:        
	        LD      A,(MEM5)        ;FF55
                BIT     0,A             ;FF55
                JP      NZ,ESCI         ;FF55
		
		IN      A,(PA)
		AND     0FH
		LD      L,A
		LD      H,00H
		LD      DE,TABLE
		ADD     HL,DE
		LD      A,(HL)
		CP      0AH
		JP      Z,CLEA1
		CP      0BH
		JP      Z,ENTE1
		CP      0AH             ;SE NON NUMERO
		JP      NC,ESCI         ;ESCI
		LD      B,A
		LD      A,(MEMID)       ;SE E' IL PRIMO
		BIT     0,A             ;NUMERO INSERITO
		JR      NZ,ADIS1        ;INIZIALIZZA IL
		LD      A,01H           ;DISPLAY METTENDO
		LD      (MEMID),A       ;DEGLI ZERI
		CALL    INIZDI
ADIS1:          LD      A,B
		CALL    MUOVO
		CALL    BIOTT
		JP      ESCI

		;PARAMETRI ALLARME

FUNZ2:          LD      A,01H
		LD      (MEM2),A
		LD      DE,(ALLAR)
		LD      (BINSET),DE
		LD      A,77H           ;A
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI
	       
		;PARAMETRI POSIZIONE SEGNO

FUNZ3:          LD      A,01H
		LD      (MEM3),A
		LD      DE,(SEQSEG)
		LD      (BINSET),DE
		LD      A,73H           ;P
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      ESCI

		;SEGNALAZIONE FASATURA AUTOMATICA

FUNZ4:          LD      A,01H
		LD      (MRIC+00H),A
		LD	(MRIC+08H),A	;RRAA
		LD      A,0FH           ;DOPO 16 GIRI
		LD      (ALTGUA),A      ;STOP GUAD.AUTO
		LD      A,60H           ;INIZIO CON
		LD      (GUADS1),A      ;GUADAGNO MINIMO
		LD      (GUADS2),A      
		LD      A,05H
		LD      (MRIC+02H),A
                CALL    AZZF4

                LD      A,01H           ;FFZZ
                LD      (MFLEXL),A

		LD	A,00H		;MMSS
		LD	(MRIC+04H),A
		LD	(MRIC+06H),A

		JP      ESCI



		;FASATURA MANUALE E RICENTRATURA

FUNZ5:          IN      A,(10H)         ;SENTO SE FF55
		LD      L,A             ;L'ENCODER
		IN      A,(20H)         ;STA GIRANDO
		LD      H,A             ;SE E' FERMO
		LD      BC,07FFFH       ;ESEGUO FSABO
FUNZ51:         DEC     BC              ;SE GIRA ESEGUO
		LD      A,B             ;RICENTRATURA
		OR      C
		JR      NZ,FUNZ51
		IN      A,(10H)      
		LD      E,A
		IN      A,(20H)
		CP      H
		JR      NZ,FUNZ52
		LD      A,E
		CP      L
		JR      Z,FUNZ53
FUNZ52:         LD      A,3FH           ;O
		LD      (BINSET+10H),A
		LD      A,6DH           ;S

		LD      (BINSET+0FH),A
		LD      A,39H           ;C
		LD      (BINSET+0EH),A
		LD      A,06H           ;I
		LD      (BINSET+0DH),A
		LD      A,38H           ;L
		LD      (BINSET+0CH),A
		LD      A,01H
		LD	(MEM5),A	;FF55
		EXX
		CALL    TRDIS
		JP      ESCI           
FUNZ53:

                LD      HL,(FASE)       ;CARICO IL FF5555 
                LD      A,H             ;CONTATORE PER FF5555
                OUT     (20H),A         ;LEGGERE POI S1 FF5555
                LD      A,L             ;FF5555
                OUT     (10H),A         ;FF5555
                LD      A,00H
                LD      (MEM5),A
                LD      (MOLTI),HL      ;MOLTIPLICO PER FF5555
                LD      A,0AH           ;10 PER AVERE IL
                LD      (MOLPL),A       ;RIFERIMENTO TO-
                CALL    MOLT            ;TALE TRASCURAN-
                LD      DE,(PROD)       ;DO IL RAPPORTO
                LD      (RIFTOT),DE
                LD      A,01H           ;FF56
                LD      (MOSCI1),A      ;FF56


                LD      A,71H           ;F
		LD      (BINSET+10H),A
		LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,6DH           ;S
		LD      (BINSET+0EH),A
		LD      A,7CH           ;b
		LD      (BINSET+0DH),A
		LD      A,5CH           ;o
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		JP      ESCI

		;LETTURA PARAMETRI LAVORO

FUNZ6:          JP      CLEA1           ;########### 
ENTE6:          JP      ESCI            ;#SOPPRESSA# 
                                        ;########### 
		

		;SCRITTURA PARAMETRI LAVORO

FUNZ7:          JP      CLEA1           ;########### 
ENTE7:          JP      ESCI            ;#SOPPRESSA# 
                                        ;########### 


AUTMAN:         LD      DE,0FFFH        ;CONTROLLO
KRIT3:          DEC     DE              ;ANTIDISTURBO  
		LD      A,D
		OR      E
		JR      NZ,KRIT3
		IN      A,(PA)          
		BIT     4,A
		JP      NZ,ESCI
		AND     0FH             
		LD      L,A             ;LEGGO DUE VOLTE
		LD      H,00H           ;LA TASTIERA CON
		LD      DE,TABLE        ;UN RITARDO TRA 
		ADD     HL,DE           ;PRIMA E LA SECON-
		LD      B,(HL)          ;DA LETTURA SE 
		LD      DE,0FFFH        ;SONO EGUALI 
KRIT4:          DEC     DE              ;PROCEDO SE NO 
		LD      A,D             ;ESCO
		OR      E
		JR      NZ,KRIT4
		IN      A,(PA)
		BIT     4,A
		JP      NZ,ESCI
		AND     0FH             
		LD      L,A
		LD      H,00H
		LD      DE,TABLE
		ADD     HL,DE
		LD      A,(HL)          ;SECONDA LETTURA
		CP      B               ;B= PRIMA LETTU-
		JP      NZ,ESCI         ;RA.

		LD      A,00H           ;TOLGO USO DELLA                
		LD      (MKBUSY),A      ;TASTIERA
		LD      A,(MEMC)
		BIT     2,A
		JR      NZ,MANUAL
		LD      A,(MEMC)
		SET     2,A             ;METTO IN AUTOMAT.
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANUAL:         LD      A,(MEMC)
		RES     0,A
		RES     1,A
		RES     2,A             ;METTO IN MANUALE
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI

MANAVA:         LD      A,(MEMC)        ;SE E' IN AUTO-
		BIT     2,A             ;MATICO SALTO
		JR      NZ,MANEND
		RES     1,A
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE AVANTI
		IN      A,(PA)
		AND     1FH             ;XXXXXXXXX      
		CP      0CH             ;XXXXXXXXX
		JR      Z,MANAVA
		JR      MANEND

MANRIT:         LD      A,(MEMC)        ;SE E' IN AUTO-
		BIT     2,A             ;MATICO SALTA
		JR      NZ,MANEND
		RES     0,A
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A          ;MOTORE RITARDO
		IN      A,(PA)
		AND     1FH             ;XXXXXXXXX
		CP      0DH             ;XXXXXXXXXXXX
		JR      Z,MANRIT

MANEND:         LD      A,00H           ;TOLGO L'USO
		LD      (MKBUSY),A      ;DELLA TASTIERA
		LD      A,(MEMC)
		RES     0,A
		RES     1,A
		LD      (MEMC),A
		OUT     (PC),A
		JP      ESCI    

MUOVO:          LD      IX,BINSET+06H
		LD      B,(IX+00H)      ;MEMORIZZO I
		LD      C,(IX+01H)      ;NUMERI E LI
		LD      D,(IX+02H)      ;MUOVO VERSO
		LD      E,(IX+03H)      ;SINISTRA
		LD      (IX+00H),A
		LD      (IX+01H),B
		LD      (IX+02H),C
		LD      (IX+03H),D
		LD      (IX+04H),E
		RET

INIZDI:         LD      A,00H
		LD      IX,BINSET+06H
		LD      (IX+00H),A
		LD      (IX+01H),A
		LD      (IX+02H),A
		LD      (IX+03H),A
		LD      (IX+04H),A
		RET

ESCI:           LD      A,03H           ;CARICO IL
		LD      (ALTERR),A      ;BLOCCO ALLE
		LD      A,0D7H          ;CORREZZIONI
		OUT     (71H),A         ;PER DUE GIRI
		LD      A,01H           ;ALL'USCITA
		OUT     (71H),A         ;DALLA TASTIERA
		LD      A,(MEMA)               
		SET     7,A
		OUT     (PA),A          
		LD      (MEMA),A
		LD      A,(MEM6A)       ;SE FINITA LA
		CP      00H             ;FUNZIONE 6
		JR      NZ,ESCI1        ;RIPARTI DALLO
		POP     IY              ;INIZIO COSI'
		POP     IX              ;AGGIORNA IL
		POP     AF              ;TUTTO.
		POP     HL
		POP     DE
		POP     BC
		JR      ESCI2
ESCI1:          LD      HL,RESET_PIO		;LOLA
		EX      (SP),HL
ESCI2:          EI
		RETI



PIOB:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY

     
	        LD      A,(MEMFAS)      
		CP      00H
		JR      Z,PIOB2

                LD      A,0D7H          ;CONTROLLO CTC0 
		OUT     (70H),A         ;CARICO AMPIEZZA
                LD      A,(AMPIM1)      ;GATE1 IN IMPULSI
		OUT     (70H),A         ;ENCODER.

                LD      A,(MEMFAS)      
		CP      02H             ;SE ABILITAZ.
                JR      Z,PIOB1         ;PA7 SALTO 

		LD      A,(GUADS1)      ;AMPLIFICAZIONE
		LD      B,A             ;S1
                LD      A,(MEMA)        
		RES     5,A
		RES     6,A
		ADD     A,B
		LD      (MEMA),A
                OUT     (PA),A          
		JR      PIOB1

PIOB2:          LD      A,0D7H          ;CONTROLLO CTC0   
		OUT     (70H),A         ;CARICO AMPIEZZA
                LD      A,(AMPIM2)      ;GATE2 IN IMPULSI
                OUT     (70H),A         ;ENCODER. 

                LD      A,(GUADS2)      ;AMPLIFICAZIONE
		LD      B,A             ;S2
		LD      A,(MEMA)        ;XXXXXX
		RES     5,A
		RES     6,A
		ADD     A,B             
		LD      (MEMA),A
		OUT     (PA),A          ;XXXXXXX              


                LD      A,(PROXIM)      ;VEDO SE  PXXX
                CP      01H             ;ATTIVO 
                JR      NZ,PIOB1

                LD      A,(MEMC)        ;ATTIVO COM- PXXX SSSS
                SET     7,A             ;MUTAZIONE
                LD      (MEMC),A        ;CONTROLLO
                OUT     (PC),A          ;DIPASSO

PIOB1:
		LD	A,(ABIDOP)	;CONTROLLO SE DDAA
		CP	00H		;SEGNALARE
		JR	Z,PIOB3		;DOPPIO SEGNO

		LD	A,(MRIC+04H)	;SE INSERITA  LA NON SSDD MMSS
		CP	02H		;VISUALIZZAZIONE 
		JR	Z,PIOB3		;DELLA SCRITTA SALTO SSDD
                LD      A,0D7H          ;ATTIVO IL CTC3 PER CONTROLLARE SSDD
                OUT     (73H),A         ;IL SEGNO DOPPIO DURANTE IL GATE
                LD      A,02H           ;CIOE' LO ATTIVO A PIOB E LO
                OUT     (73H),A         ;RESETTO ALL'INIZIO DI CTC0
PIOB3:					;SSDD
		POP     IY              ;PPDD
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI



		;VERIFICA POSIZIONE S1

CTC0:          
		PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
		
		LD	A,(SELFRO)	;SE DEVO LAVORARE FFSS
		CP	01H		;SOLO SUI FRONTI FFSS
		JR	Z,CTC028	;SETTO IN MODO FFSS
		LD	A,00H		;DI NON AVERE COMMUTAZIONI FFSS
		LD	(ALTERN),A	;FFSS
		LD      A,(MEMC)	;FFSS
                RES     5,A		;FFSS
                LD      (MEMC),A	;FFSS
                OUT     (PC),A		;FFSS

CTC028:					;FFSS
		LD      A,43H		;RESETTO CTC3 PER SSDD
		OUT     (73H),A		;CONTROLLO SEGNO DOPPIO

 		LD	A,(MRIC+04H)	;SE E' ATTIVA MMSS
		CP	02H		;LA SCCRITTA DOPPIO
		JR	Z,CTC04		;ASPETTO CIRCA
		LD	A,(MRIC+06H)	;15 GIRI E POI LA
		CP	40H		;TOLGO
		JR	NC,CTC02
		INC	A
		LD	(MRIC+06H),A
		JR	CTC04
CTC02:		LD	A,02H
		LD	(MRIC+04H),A
CTC04:         
		
		LD	A,(SELFRO)	;SE SOLO FRONTIFFSS
		CP	00H		;SALTO FFSS
		JR	Z,CTC05 	;FFSS

		
		LD	A,(ALTERN)	;CONTROLLO CHE ALTERN	AALL
		CP	03H		;NON SUPERI DUE
		JR	C,CTC05		;PER NON FARE
		LD	A,02H		;LETTURE SBAGLIATE
		LD	(ALTERN),A
CTC05:					;AALL
                LD      A,(ENCOD1)     ;SE NON
                CP      00H            ;ABILITATO
                JR      Z,CTC01        ;SALTA   
                CP      01H
                JP      Z,CTC025
                LD      A,(ENCOD2)     ;INCREMENTO
                INC     A              ;A OGNI 255
                LD      (ENCOD2),A     ;IMPULSI
                LD      A,0DFH         ;RICARICO CTC0 
		OUT     (70H),A
                LD      A,0FFH
                OUT     (70H),A
                JP      CTC025         

CTC01:		
		LD      A,(MEMFAS)      
		CP      00H              
		JP      Z,CTC010        ;VAI FASE S2
		CP      02H
		JP      Z,CTC016        ;VAI ABILIT.PA7
                IN      A,(30H)         ;LEGGO IL VALORE   
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
                LD      (MPIEN1),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)         ;DI S1
		LD      D,A
                LD      (MPOSI1),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S1
		LD      D,A
                LD      (MASES1),DE
                LD      HL,(FASE2)      ;CARICO IL CONTA-
		LD      A,H             ;TORE PER LEGGERE
		OUT     (20H),A         ;LA FASE 2
		LD      A,L
		OUT     (10H),A         
                LD      A,(MEMA)        ;IMPONGO 
		SET     5,A             ;NELL'INTERVALLO
		SET     6,A             ;GUADAGNO MINIMO
		LD      (MEMA),A
                OUT     (PA),A    
		
                LD      A,(MEM5)        ;FF55
                CP      01H             ;FF55
                JR      NZ,CTC027       ;FF55
                CALL    SPOFAS          ;EEOO
                LD      HL,(FASE)       ;CARICO IL FF55 
                LD      A,H             ;CONTATORE PER FF55
                OUT     (20H),A         ;LEGGERE POI S1 FF55
                LD      A,L             ;FF55
                OUT     (10H),A         ;FF55        
		
CTC027:					;FF56
		LD      A,(MEMB)	;SSSS
		SET     5,A             ;ATTIVO IL MONO-
		OUT     (PB),A          ;STABILE DA 0,5 mS
		RES     5,A
		LD      (MEMB),A
		OUT     (PB),A		;SSSS

		LD      A,00H           
		LD      (MEMFAS),A	      
		LD      A,(MEMC)        ;SE SONO IN MA-	SSSS
		BIT     2,A             ;NUALE SALTO
		JR      Z,CTC03		;SSSS

		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,CTC03         ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
	       ;CALL    NOPRI		;JJJJ
		LD	A,01H		;AVVISO DI JJJJJ
		LD	(MNOPRI),A	;NOPRI
CTC03:          
                IN      A,(PB)
		BIT     3,A
		JR      Z,CTC08
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOMAT.
		JR      Z,CTC07         ;SALTA
		CALL    GAINS1          
CTC07:
                CALL    RESEPC          ;FFLL

               ;JP      CTC025		;TOLTO PER FAR GENERARE!!!!!!!!!!!!JJJJ
					;GATE 2 QUANDO MANCA STAMPA
CTC08:					
		LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
                LD      A,(MEMC)        
                BIT     5,A
                JR      NZ,CTC09        
                LD      DE,(MPIEN1)
                LD      (PIENO1),DE
                LD      DE,(MPOSI1)
                LD      (POSIZ1),DE
                LD      DE,(MASES1)
		LD      (FASES1),DE
                JP      CTC025                  
CTC09:       
		LD	A,(SELFRO)	;SE SOLO FRONTI FFSS
		CP	00H		;SALTO FFSS
		JP	Z,CTC025 	;FFSS

		LD      DE,(MPIEN1)
                LD      (TPIEN1),DE
                LD      DE,(MPOSI1)
                LD      (TPOSI1),DE
                LD      DE,(MASES1)
                LD      (TASES1),DE     
                JP      CTC025          

		;VERIFICA POSIZIONE DI S2

CTC010:         LD      A,(ALTGUA)      ;SE ATTIVO
		CP      00H             ;GUADAGNO AUTOM.
		JR      Z,CTC011        ;DECREMENTA
		DEC     A      
		LD      (ALTGUA),A
CTC011:         
		IN      A,(30H)         ;LEGGO IL VALORE
		LD      E,A             ;DI PIENO
		IN      A,(40H)
		LD      D,A
                LD      (MPIEN2),DE
		IN      A,(50H)         ;LEGGO IL VALORE
		LD      E,A             ;DELLA POSIZIONE
		IN      A,(60H)
		LD      D,A
                LD      (MPOSI2),DE
		IN      A,(61H)         ;LEGGO IL VALORE
		LD      E,A             ;DI ENCODER
		IN      A,(62H)         ;ALL'ARRIVO DI S2
		LD      D,A
                LD      (MASES2),DE
		LD      HL,(FASE3)      ;CARICO IL CONTA-
		LD      A,H             ;TORE PER POI
		OUT     (20H),A         ;L'ABILITARE PA7
		LD      A,L
		OUT     (10H),A

		LD	A,(SELFRO)	;SE SOLO FRONTI FFSS
		CP	00H		;SALTO FFSS
		JR	Z,CTC029 	;FFSS

                LD      A,(MEMC)        
                BIT     5,A
                JR      NZ,CTC019     
CTC029:					;FFSS
                LD      DE,(MPIEN2)
                LD      (PIENO2),DE
                LD      DE,(MPOSI2)
                LD      (POSIZ2),DE
                LD      DE,(MASES2)
                LD      (FASES2),DE
                LD      A,(MRIC+00H)    
                CP      01H
                JR      Z,CTC018      
		
		LD	A,(SELFRO)	;SE SOLO FRONTI FFSS
		CP	00H		;SALTO FFSS
		JR	Z,CTC018 	;FFSS

                LD      A,(ALTERN)
                DEC     A
                LD      (ALTERN),A
                CP      00H
                JR      NZ,CTC018
                LD      A,(MEMC)
                SET     5,A
                LD      (MEMC),A
                OUT     (PC),A
                LD      A,02H
                LD      (ALTERN),A
                JP      CTC018        
CTC019:         LD      DE,(MPIEN2)
                LD      (TPIEN2),DE
                LD      DE,(MPOSI2)
                LD      (TPOSI2),DE
                LD      DE,(MASES2)
                LD      (TASES2),DE     
                LD      A,(ALTERN)
                DEC     A
                LD      (ALTERN),A
                CP      00H
                JR      NZ,CTC018
		
                LD      A,(MEMC)       
                RES     5,A
                LD      (MEMC),A
                OUT     (PC),A

                LD      A,02H
                LD      (ALTERN),A
CTC018:   
                LD      A,(MEMC)        ;RESET PROXIMITY
                RES     7,A		
                LD      (MEMC),A
                OUT     (PC),A

		LD      A,(MEMA)        ;IMPONGO 
		SET     5,A             ;NELL'INTERVALLO
		SET     6,A             ;GUADAGNO MINIMO
		LD      (MEMA),A
                OUT     (PA),A          
		LD      A,02H
		LD      (MEMFAS),A

		LD      A,(MEMB)	;SSSS
		SET     5,A             ;ATTIVO IL MONO-
		OUT     (PB),A          ;STABILE DA 0,5 mS
		RES     5,A
		LD      (MEMB),A
		OUT     (PB),A		;SSSS

		IN      A,(PB)          ;SE MANCA SEGNO
		BIT     3,A             ;MODIFICO IL
		JR      Z,CTC012        ;GUADAGNO DI S2
		LD      A,(ALTGUA)      ;SE FINITA RICERCA
		CP      00H             ;GUADAGNO AUTOM.
		JR      Z,CTC012        ;SALTA
		CALL    GAINS2          
CTC012:         LD      A,01H           ;SEGNALA AL MAIN
		LD      (MCALER),A      ;CHE HA LETTO.

		LD      A,(MEMC)        ;SE SONO IN MA- SSSS
		BIT     2,A             ;NUALE SALTO
		JR      Z,CTC013	;SSSS

		IN      A,(PB)          ;SE MANCA IL 
		BIT     3,A             ;SEGNO BLOCCO
		JR      Z,CTC013        ;LA CORREZIONE
		LD      A,02H           ;AUMENTANDO I
		LD      (MATTES),A      ;CICLI DI ATTESA.
	       ;CALL    NOPRI		;JJJJJ
		LD	A,01H		;AVVISO DI NOPRI JJJJJ
		LD	(MNOPRI),A
CTC013:         
                IN      A,(PB)
		BIT     3,A
		JR      Z,CTC015
                CALL    RESEPC          ;FFLL
                JP      CTC025
CTC015:         LD      A,(MEMA)
		RES     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
                JR      CTC017          
CTC016:         LD      HL,(FASE)       ;CARICO IL 
		LD      A,H             ;CONTATORE PER
		OUT     (20H),A         ;LEGGERE POI S1
		LD      A,L
		OUT     (10H),A         
		LD      A,(MEMA)
		SET     7,A
		LD      (MEMA),A
		OUT     (PA),A
		LD      A,43H
		OUT     (70H),A
		LD      A,01H
		LD      (MEMFAS),A

                JR      CTC025

CTC017:         LD      A,(MRIC+00H)
                CP      00H
                JR      NZ,CTC025

                LD      BC,011DH        ;4mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
CTC021:         IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,CTC022       ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO
CTC022:         DEC     BC              ;IN IX+01
                LD      A,B
                OR      C
                JR      NZ,CTC021       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.

                LD      A,(MEMC)        ;SE E'IN MANUALE
		BIT     2,A             ;SALTO
                JR      Z,CTC020

                LD      IX,TRIP         
                LD      A,(IX)          ;SE TRIP
                CP      00H             ;= ZERO NON
                JR      Z,CTC020        ;OPERA


CTC023:
		LD      A,(MEMC)        ;SE PROT. SALTO SSSS
                BIT     4,A             ;
                JR      NZ,CTC020       ;SSSS	
	
                LD      HL,(VELMED)     ;CONTROLLO SE
                LD      DE,(VELPRE)     ;TRA LA NUOVA 
                SBC     HL,DE           ;E LA VECCHIA 
                JR      C,CTC024        ;VELOCITA'C'E' 
                LD      A,L             ;UN DIFFERENZA
                CP      (IX)            ;TRIP IN METRI SIA  
                JP      M,CTC020        ;IN PIU' CHE
                CALL    ACCEL           ;MENO SE C'E'
                JR      CTC020          ;BLOCCO CON
CTC024:         CCF                     ;LA SCRITTA  
                LD      HL,(VELPRE)     ;APPROPIATA
                LD      DE,(VELMED)
                SBC     HL,DE
                LD      A,L
                CP      (IX)            
                JP      M,CTC020
                CALL    DECEL
CTC020:         LD      DE,(VELMED)
                LD      (VELPRE),DE
CTC025:  

                LD      A,(MOSCI1)      ;FF56
                CP      01H
                JR      NZ,CTC026       ;FF56
		
                CALL    CENTRO          ;FF56
                CALL    IIGATE          ;FF56
                LD      A,00H           ;FF56
                LD      (MOSCI1),A      ;FF56

CTC026:					;FF56
		POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI



		;CONTEGGIO GIRI ALL'USCITA DALLA TASTIERA
		

CTC1:           PUSH    BC
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
		PUSH    IY
		LD      A,(ENCOD1)      ;VEDO SE SONO
		CP      00H             ;IN TEST
                JR      Z,CTC16         ;ENCODER
		CP      01H
                JR      Z,CTC17
		CP      02H
                JR      Z,CTC18
CTC17:          LD      A,02H           ;PARTENZA TEST
		LD      (ENCOD1),A
                LD      HL,ENC2
                JR      CTC14           
CTC18:          LD      HL,ENC6         ;FINE TEST                        
                JR      CTC14           ;EEEEEEEEE
CTC16:          LD      A,(MRIC+00H)    ;CONTROLLA
		CP      01H             ;SE FALLITA
		JR      Z,CTC12         ;RICERCA CODICE
		LD      A,(ALTERR)      ;QUANDO ALTERR
		CP      00H             ;ARRIVA A ZERO
		JR      Z,CTC10         ;RIPRENDE IL
		DEC     A               ;CALCOLO DELLO
		LD      (ALTERR),A      ;ERRORE
		JR      CTC11
CTC10:          LD      A,43H
		OUT     (71H),A
CTC11:          POP     IY                
		POP     IX              
		POP     AF
		POP     HL
		POP     DE      
		POP     BC
		JR      CTC15
CTC12:          LD      A,(MRIC+02H)
		DEC     A
		LD      (MRIC+02H),A
		CP      00H
		JR      NZ,CTC13
		LD      A,01H           ;SEGNALO
		LD      (MDATER),A      ;RICERCA FALLITA
		LD      A,00H           ;E LA ANNULLO
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD      (MRIC+08H),A	;RRAA
		LD      A,43H
		OUT     (71H),A
                LD      HL,MAIN         ;RIPARTO DA SSVV
		JR      CTC14           ;MAIN
CTC13:          CALL    GAINS1
                LD      HL,CODICE
CTC14:          POP     IY              
		POP     IX              
		POP     AF
		POP     DE      
		POP     BC
		EX      (SP),HL
CTC15:          EI              
		RETI




CTC2:           PUSH    BC              
                PUSH    DE              
                PUSH    HL              
		PUSH    AF
		PUSH    IX
		PUSH    IY

                LD      A,(DECORR)      ;SE EXTRA 
                CP      00H             ;CORREZIONE 
                JR      NZ,CTC21        ;ATTIVA SALTO.
CTC23:          LD      A,(MEMC)        ;FINE DELLA
		RES     0,A             ;CORREZIONE
		RES     1,A
		LD      (MEMC),A
		OUT     (PC),A
		LD      A,43H           ;RESETTO
		OUT     (71H),A         ;CTC1
		OUT     (72H),A         ;CTC2
                JR      CTC22           
CTC21:          LD      A,37H           ;CONTROLLO CTC1
		OUT     (71H),A         
                LD      A,40H           ;COSTANTE DI
		OUT     (71H),A         ;TEMPO
                LD      A,0D7H          ;CONTROLLO CTC2
                OUT     (72H),A         ;CARICO PER 
                LD      A,0FFH          ;EXTRA CORREZ.
		OUT     (72H),A

                LD      A,(DECORR)      ;SE E' MAGGIORE 
                DEC     A               ;DI UNO LA CORREZ-
                LD      (DECORR),A      ;ZIONE DIVENTA
                CP      00H             ;CONTINUA
                JR      NZ,CTC22

                LD      A,(CIDE75)      ;SE FATTO 75% ZZZ
                CP      00H             ;DEL CICLO
                JR      Z,CTC23         ;BLOCCO CORREZ.

CTC22:          POP     IY
		POP     IX
		POP     AF
                POP     HL              
                POP     DE              
                POP     BC              
		EI
		RETI



CTC3:           PUSH    BC              
		PUSH    DE
		PUSH    HL
		PUSH    AF
		PUSH    IX
                PUSH    IY

		LD      A,01H		;ATTIVA SCRITTA  SSDD
		LD	(MRIC+04H),A	;SSDD	MMSS

		LD      A,(LINGUA+00H)
		CP      00H
		JR      Z,CTC3E
		CP      01H
		JR      Z,CTC3I
		CP      02H
		JR      Z,CTC3S
		CP      03H
		JR      Z,CTC3E
                CP      04H             ;TTDD
                JR      Z,CTC3D         ;TTDD
CTC3E:          LD      A,5EH           ;d
		LD      (BINSET+10H),A
		LD      A,5CH           ;o
		LD      (BINSET+0FH),A
		LD      A,1CH           ;u
		LD      (BINSET+0EH),A
		LD      A,7CH           ;b
		LD      (BINSET+0DH),A
		LD      A,38H           ;L
		LD      (BINSET+0CH),A
                JR      CTC32
CTC3I:          LD      A,5EH           ;d
		LD      (BINSET+10H),A
		LD      A,3FH           ;O
		LD      (BINSET+0FH),A
		LD      A,73H           ;P
		LD      (BINSET+0EH),A
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
                JR      CTC32
CTC3S:          LD      A,5EH           ;d
		LD      (BINSET+10H),A
		LD      A,5CH           ;o
		LD      (BINSET+0FH),A
		LD      A,7CH           ;b
		LD      (BINSET+0EH),A
		LD      A,38H           ;L
		LD      (BINSET+0DH),A
		LD      A,79H           ;E
		LD      (BINSET+0CH),A
                JR      CTC32           ; TTDD
CTC3D:          LD      A,5EH           ;d
		LD      (BINSET+10H),A
		LD      A,5CH           ;o
		LD      (BINSET+0FH),A
                LD      A,73H           ;P
		LD      (BINSET+0EH),A
		LD      (BINSET+0DH),A
                LD      A,79H           ;E
		LD      (BINSET+0CH),A

CTC32:          EXX
		CALL	RESEPC		;SSDD
		CALL    TRDIS
		
CTC31:          POP     IY
		POP     IX
		POP     AF
		POP     HL
		POP     DE
		POP     BC
		EI
		RETI



TABLE:          DEFB    00H             ;0
		DEFB    01H             ;1
		DEFB    02H             ;2
		DEFB    03H             ;3
		DEFB    04H             ;4
		DEFB    05H             ;5
		DEFB    06H             ;6
		DEFB    07H             ;7
		DEFB    08H             ;8
		DEFB    09H             ;9
		DEFB    0AH             ;CLEAR
		DEFB    0BH             ;ENTER
		DEFB    0CH             ;PIU'
		DEFB    0DH             ;MENO
		DEFB    0EH             ;MAN/AUTO
		DEFB    0FH             ;FUNZIONE


SSEG:           DEFB    3FH             ;0
		DEFB    06H             ;1
		DEFB    5BH             ;2
		DEFB    4FH             ;3
		DEFB    66H             ;4
		DEFB    6DH             ;5
		DEFB    7DH             ;6
		DEFB    07H             ;7
		DEFB    7FH             ;8
		DEFB    6FH             ;9


		;CONVERSIONE BINARIO SETTE SGMENTI

		;REG. D CONTIENE IL NUMERO DI BYTE BINARI
		;REG. E CONTIENE IL NUMERO DI BYTE BCD
		;ADDR. 4100H E 4101H MEM. NUMERO BINARIO
		;ADDR. 4102H E 4103H MEM. NUMERO BCD


BIN7:           EXX
		LD      D,02H
		LD      E,05H
		LD      A,00H
		LD      B,E
		LD      HL,BINSET+02H
CLR:            LD      (HL),A
		INC     HL
		DJNZ    CLR
		LD      A,D             ;A=NUMERO BYTE
		ADD     A,A
		ADD     A,A
		ADD     A,A
		LD      C,A             ;C=NUMERO BIT
LOOP:           LD      L,00H
		LD      B,D
SHLB:           RL      (HL)
		INC     HL
		DJNZ    SHLB
		LD      L,02H
		LD      B,E
BCDADJ:         LD      A,(HL)
		ADC     A,A
		DAA
		LD      (HL),A
		INC     HL
		DJNZ    BCDADJ
		DEC     C
		JR      NZ,LOOP


		;METTE IN MEMORIA UN SINGOLO BCD

		LD      IY,BINSET+05H   ;TAB.BCD SING-1
		LD      HL,BINSET+02H   ;TAB.COPPIA BCD
		RRD
                LD      B,A             ;SALVO A 
                LD      A,(ZERCIN)      ;PER AVERE
                CP      00H             ;SOLO 0 o 5
                JR      Z,ZECI2
                LD      A,B
                CP      05H             ; PER AVERE
                JR      C,ZECI1         ;SOLO 0 o 5
                LD      A,05H
                JR      ZECI3
ZECI1:          LD      A,00H
                JR      ZECI3
ZECI2:          LD      A,B
ZECI3:          LD      (IY+01H),A      
		RRD
		LD      (IY+02H),A
		INC     HL
		RRD
		LD      (IY+03H),A
		RRD
		LD      (IY+04H),A
		INC     HL
		RRD
		LD      (IY+05H),A
                LD      A,00H           ;ANNULLO
                LD      (ZERCIN),A      ;SOLO 0 o 5
		EXX
      
		;CONVERSIONE BCD SETTE SEGMENTI
					 
BIOTT:          EXX
		LD      C,05H
		LD      B,04H           ;N.BYTE - LETTERA
		LD      IY,BINSET+0BH   ;MEM.-1 7 SEG
SOM:            LD      HL,BINSET+05H   ;INIZ. MEM.-1 BCD
		INC     C
		LD      L,C
		INC     IY
		LD      A,(HL)          ;PRENDI DATO
		LD      L,A             ;INDICE A 16 BIT
		LD      H,0
		LD      DE,SSEG         ;BASE TAB.7SEG.
		ADD     HL,DE           
		LD      A,(HL)          ;SALVA IL CODICE
		LD      (IY),A
		DJNZ    SOM


		;TRASMISSIONE DISPLAY
	  
					    
TRDIS:          XOR     A              
		OUT     (PB),A
		SET     0,A             ;START
		OUT     (PB),A
		SET     7,A
		OUT     (PB),A
		RES     7,A
		OUT     (PB),A
		LD      C,05H           ;NUMERO DISPLAY
LOOP2:          LD      B,07H           ;NUMERO SEGMENTI
LOOP1:          RES     0,A             ;SPENGO TUTTI
		RES     5,A             ;I SEGMENTI
		OUT     (PB),A          
		SET     7,A
		OUT     (PB),A
		RES     7,A
		OUT     (PB),A
		SRL     D
		DJNZ    LOOP1
		DEC     C
		JR      NZ,LOOP2
		XOR     A
		OUT     (PB),A
		SET     0,A             ;START
		OUT     (PB),A
		SET     7,A
		OUT     (PB),A
		RES     7,A
		OUT     (PB),A
		LD      HL,BINSET+0BH   ;TAB.7SEG.-1
		LD      C,05H           ;NUMERO DISPLAY
LOOP4:          LD      B,07H           ;NUMERO SEGMENTI
		INC     HL
		LD      A,(HL)
		LD      D,A
LOOP3:          LD      A,D
		RES     5,A             ;PER NON ATTIVA-
		RES     6,A             ;RE MONOSTABILE
		RES     7,A             ;DA 5mS.
		OUT     (PB),A
		SET     7,A
		OUT     (PB),A
		RES     7,A
		OUT     (PB),A
		SRL     D
		DJNZ    LOOP3
		DEC     C
		JR      NZ,LOOP4
MONO:           XOR     A               ;AZZERO PB 
		OUT     (PB),A          ;PER AVERLO 
		LD      (MEMB),A        ;PULITO QUANDO
		EXX                     ;ESEGUIRO'IN (PB)
		RET                     

		;CONVERSIONE BCD BINARIO PER 10 DIGIT


BCDBIN:         EXX        
		LD      IX,BINSET+06H
		LD      A,(IX+03H)
		RL      A
		RL      A
		RL      A
		RL      A
		ADD     A,(IX+02H)
		LD      IY,TABCON
		LD      (IY+05H),A
		LD      A,(IX+01H)
		RL      A
		RL      A
		RL      A
		RL      A
		ADD     A,(IX+00H)
		LD      (IY+04H),A
		LD      A,00H
		LD      (IY+06H),A
		LD      (IY+07H),A
		LD      (IY+08H),A
		LD      C,20H
DBLP:           LD      B,05H
		XOR     A
		LD      HL,TABCON+08H
COR0:           LD      A,(HL)
		RRA
		PUSH    AF
		BIT     7,A
		JR      Z,COR1
		SUB     30H
COR1:           BIT     3,A
		JR      Z,COR2
		SUB     03H
COR2:           LD      (HL),A
		DEC     HL
		POP     AF
		DJNZ    COR0
		LD      B,04H
SHR4:           RR      (HL)
		DEC     HL
		DJNZ    SHR4
		DEC     C
		JR      NZ,DBLP
                LD      A,(BINSET+10H)  ;MEMORIZZO IL
		CP      39H             ;VALORE DELLA 
		JR      Z,LETTC         ;FUNZIONE NELLA
		CP      77H             ;SUA MEMORIA
		JR      Z,LETTA
		CP      73H
		JR      Z,LETTP
		CP      50H
		JR      Z,LETRU
		CP      1CH
		JR      Z,LETRU
		CP      40H
		JR      Z,LEMEN
		CP      70H
		JR      Z,LEPIU
		JR      LETT
LETTC:          LD      HL,(TABCON)
		LD      (CILIN),HL
		JR      LETT
LETTA:          LD      HL,(TABCON)
		LD      (ALLAR),HL
		JR      LETT
LETTP:          LD      HL,(TABCON)
		LD      (SEQSEG),HL
		JR      LETT
LETRU:          LD      HL,(TABCON)
		LD      (LAVORO),HL
		JR      LETT
LEMEN:          LD      HL,(TABCON)
		LD      (SHIFT),HL

		LD      A,(BINSET+10H)
		LD      (PIUMEN),A
		JR      LETT
LEPIU:          LD      HL,(TABCON)
		LD      (SHIFT),HL

		LD      A,(BINSET+10H)
		LD      (PIUMEN),A
LETT:           LD      DE,(SHIFT)      ;ACCETTO SPOSTA-
		LD      HL,01F4H        ;MENTO MASSIMO
		SBC     HL,DE           ;DI 500 CENTESIMI
		JR      NC,LETT1
		CCF
		LD      A,01H
		LD      (MDATER),A
LETT1:          EXX
		RET



		;CALCOLO CENTRATURA GATE
                ;WWWW ELIMINATA

                ;CALCOLO DELLO SPOSTAMENTO DI REGISTRO 


SPOSTA:         LD      HL,(SHIFT)
		LD      (MDO032),HL
		LD      HL,0000H
		LD      (MDO232),HL
		LD      HL,3E8H
		LD      (MRE032),HL
		LD      HL,0000H
		LD      (MRE232),HL
		CALL    MOL32
		LD      BC,(PTO032)
		LD      DE,(PTO232)
		LD      A,(PIUMEN)
		CP      40H
		JR      NZ,TOGLI
		LD      (ADDEN0),BC
		LD      (ADDEN2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (AUGEN0),BC
		LD      (AUGEN2),DE
		CALL    SOMM32
		LD      BC,(ADDEN0)
		LD      DE,(ADDEN2)
		LD      (DISTA0),BC
		LD      (DISTA2),DE
		JR      SPOFIN
TOGLI:          LD      (MINUE0),BC
		LD      (MINUE2),DE
		LD      BC,(DISTA0)
		LD      DE,(DISTA2)
		LD      (SUBTR0),BC
		LD      (SUBTR2),DE
		CALL    SOTT32
		LD      BC,(RESTO0)
		LD      DE,(RESTO2)
		LD      (DISTA0),BC
		LD      (DISTA2),DE
SPOFIN:         RET


		;ROUTINE SCRITTA ERRORE


ERROR:
                LD      A,(LINGUA+00H)   ;TTDD
		CP      00H
                JR      Z,ERRE
		CP      01H
                JR      Z,ERRE
		CP      02H
                JR      Z,ERRE
		CP      03H
                JR      Z,ERRE
                CP      04H
                JR      Z,ERRD
                
ERRE:           LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,50H           ;r
		LD      (BINSET+0FH),A
		LD      (BINSET+0EH),A
		LD      A,5CH           ;o
		LD      (BINSET+0DH),A
		LD      A,50H           ;r
		LD      (BINSET+0CH),A
                JR      ERRFIN
ERRD:           LD      A,71H           ;F
		LD      (BINSET+10H),A
                LD      A,79H           ;E
		LD      (BINSET+0FH),A
                LD      A,76H           ;H
		LD      (BINSET+0EH),A
                LD      A,38H           ;L
		LD      (BINSET+0DH),A
                LD      A,79H           ;E
		LD      (BINSET+0CH),A

ERRFIN:         EXX
		CALL    TRDIS
		LD      A,01H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR.
		RET

       
		;SCRITTURA ERRORE IN F1	  EEOO

ERRF1:          LD      A,79H           ;E EEOO
		LD      (BINSET+10H),A
		LD      A,50H           ;r
		LD      (BINSET+0FH),A
		LD	A,40H		;-
		LD      (BINSET+0EH),A
		LD      A,71H           ;F
		LD      (BINSET+0DH),A
		LD      A,06H           ;1
		LD      (BINSET+0CH),A
                
	        EXX
		CALL    TRDIS
		LD      A,02H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR.
		RET
 

 		;SCRITTURA ERRORE IN F3	  EEOO

ERRF3:          LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,50H           ;r
		LD      (BINSET+0FH),A
		LD	A,40H		;-
		LD      (BINSET+0EH),A
		LD      A,71H           ;F
		LD      (BINSET+0DH),A
		LD      A,4FH           ;3
		LD      (BINSET+0CH),A
                
	        EXX
		CALL    TRDIS
		LD      A,03H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR.
		RET			;EEOO

                ;AVVISO SEGNO DI RIFERIMENTO NON VALIDO SSRR

ERRF4:                                  ;EEUU SSRR           

                LD      A,79H           ;E
		LD      (BINSET+10H),A
                LD      A,50H           ;r
		LD      (BINSET+0FH),A
                LD      A,04H           ;i
		LD      (BINSET+0EH),A
                LD      A,71H           ;F  FFZZ
		LD      (BINSET+0DH),A
                LD      A,79H           ;E
		LD      (BINSET+0CH),A

	        EXX
		CALL    TRDIS
                LD      A,04H           ;ERRORE SI ELI-
		LD      (MDATER),A      ;MINA CON CLEAR.
		RET			;EEOO



                RET



		;ROUTINE SCRITTURA NO PRINT


NOPRI:

                LD      A,(ALLAR)       ;SE ALLARME E'   BBLL
		CP      00H             ;MESSO A ZERO
                JR      Z,NOPR12        ;SALTA.
		LD      A,(MEMC)        ;SE SONO IN
		BIT     2,A             ;MANUALE SALTO
                JR      Z,NOPR12

                CALL    VELIST          ;BBLL
                LD      HL,(ISTVEL)     
                LD      DE,(INSER)      
                SBC     HL,DE            
                JR      C,NOPR13         ;BBLL

                LD      A,(MEMC)
		SET     3,A             ;ATTIVO ALLARME
		LD      (MEMC),A
		OUT     (PC),A
                JR      NOPR12

NOPR13:
                CCF                     ;BBLL
                LD      A,(MEMC)
                RES     3,A             ;DISATTIVO 
                LD      (MEMC),A        ;ALLARME
                OUT     (PC),A          ;BBLL

NOPR12:                                 ;BBLL

                LD      A,(MEMC)        ;METTO PROTEZIONE
                SET     4,A             
                LD      (MEMC),A
                LD      A,00H
		LD      (MNOPR1),A
		LD      (MNOPR2),A
		LD      A,(LINGUA+00H)
		CP      00H
		JR      Z,NOPE
		CP      01H
		JR      Z,NOPI
		CP      02H
		JR      Z,NOPS
		CP      03H
		JR      Z,NOPS
                CP      04H             ;TTDD
                JR      Z,NOPD          ;TTDD
NOPE:           LD      A,54H           ;n
		LD      (BINSET+10H),A
		LD      A,5CH           ;o
		LD      (BINSET+0FH),A
		LD      A,73H           ;P
		LD      (BINSET+0EH),A
		LD      A,50H           ;r
		LD      (BINSET+0DH),A
		LD      A,04H           ;i
		LD      (BINSET+0CH),A
		JR      NOPFIN 
NOPI:           LD      A,7CH           ;b
		LD      (BINSET+10H),A
		LD      A,06H           ;I
		LD      (BINSET+0FH),A
		LD      A,77H           ;A
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,39H           ;C
		LD      (BINSET+0CH),A
		JR      NOPFIN
NOPS:           LD      A,7CH           ;b
		LD      (BINSET+10H),A
		LD      A,38H           ;L
		LD      (BINSET+0FH),A
		LD      A,77H           ;A
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,39H           ;C
		LD      (BINSET+0CH),A
		JR      NOPFIN
NOPD:           LD      A,38H           ;L
		LD      (BINSET+10H),A
                LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      (BINSET+0EH),A
                LD      A,50H           ;r
		LD      (BINSET+0DH),A
                LD      A,40H           ;-
                LD      (BINSET+0CH),A  ;TTDD

NOPFIN:         EXX
		CALL	RESEPC		;SSDD
                CALL    TRDIS
		LD      BC,0FFFFH
NOPRI1:         DEC     BC              ;RITARDO CHE
                LD      A,B             ;PERMETTE LA
                OR      C               ;VISUALIZZA-
                JR      NZ,NOPRI1       ;ZIONE DI NOPIR
		CALL	AZZTOT		;PUUU
		LD	A,00H		;RESETTO L'AVVISO JJJJ
		LD	(MNOPRI),A

		RET


                ;ROUTINE SCRITTURA STOP 


                

STOP:           LD      A,6DH           ;S 
		LD      (BINSET+10H),A
                LD      A,78H           ;t
		LD      (BINSET+0FH),A
                LD      A,3FH           ;O
		LD      (BINSET+0EH),A
                LD      A,73H           ;P
		LD      (BINSET+0DH),A
                LD      A,00H           ;
		LD      (BINSET+0CH),A
                EXX  
		CALL	RESEPC		;SSDD
		CALL    TRDIS
		LD      DE,0000H        
                LD      (VELMED),DE     ;AZZERO LE MEM.
                LD      HL,VELMED       ;DELLA VELOCITA
                LD      DE,VELMED+01H   
                LD      BC,001CH
                LDIR                    

		RET


		;ROUTINE SCRITTURA LOW-SPEED

                

LOWSPE:         LD      A,(MEMC)        ;METTO PROTEZIONE
                SET     4,A             
                LD      (MEMC),A
                LD      A,(LINGUA+00H)
		CP      00H
		JR      Z,LOWE
		CP      01H
		JR      Z,LOWI
		CP      02H
		JR      Z,LOWS
		CP      03H
		JR      Z,LOWF
                CP      04H             ;TTDD
                JR      Z,LOWD          ;TTDD
LOWE:           LD      A,38H           ;L
		LD      (BINSET+10H),A
		LD      A,6DH           ;S
		LD      (BINSET+0FH),A
		LD      A,73H           ;P
		LD      (BINSET+0EH),A
		LD      A,79H           ;E
		LD      (BINSET+0DH),A
		LD      (BINSET+0CH),A
		JR      LOWFIN
LOWI:           LD      A,38H           ;L
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,54H           ;n
		LD      (BINSET+0EH),A
		LD      A,78H           ;t
		LD      (BINSET+0DH),A
		LD      A,77H           ;A
		LD      (BINSET+0CH),A
		JR      LOWFIN 
LOWS:           LD      A,38H           ;L
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,54H           ;n
		LD      (BINSET+0EH),A
		LD      A,78H           ;t
		LD      (BINSET+0DH),A
		LD      A,5CH           ;o
		LD      (BINSET+0CH),A
		JR      LOWFIN
LOWF:           LD      A,38H           ;L
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,54H           ;n
		LD      (BINSET+0EH),A
		LD      A,78H           ;t
		LD      (BINSET+0DH),A
                LD      A,00H           ;
		LD      (BINSET+0CH),A
                JR      LOWFIN          ;TTDD
LOWD:           LD      A,38H           ;L
		LD      (BINSET+10H),A
                LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,54H           ;n
		LD      (BINSET+0EH),A
                LD      A,6FH           ;G
                LD      (BINSET+0DH),A
                LD      A,6DH           ;S
		LD      (BINSET+0CH),A

LOWFIN:         EXX   
		CALL	RESEPC		;SSDD
		CALL    TRDIS
		RET


		;CONTROLO ZONA MORTA

CORREZ:         LD      A,(MEMC)        ;SE PROT. SALTO
                BIT     4,A             ;PER ELIMINARE
                JP      NZ,COFINE       ;FLASH AL DISPLAY
                LD      HL,(ERMEDI)     ;SE ZONA MORTA E'WWW
		LD      DE,(ZONA)       ;> DELL'ERRORE
		SBC     HL,DE           ;NON CORREGGO
		JR      NC,CORREZIONI_1 ;NNDD
		CCF
		LD      A,(MEMC)        
		RES     0,A             
		RES     1,A             
		LD      (MEMC),A        
		OUT     (PC),A          
		JP      COFINE





		;##################################################################### NNDD
		;# CALCOLO CORREZIONE MOTORE                                         #
		;# [Ea x C/10 + (Ea - Ep) x D] x G                                   #
		;# [Ea x (C/10 + D) x G] - [Ep x D x G]	                             #
		;# CORRATT = 80000000h + [Ea x (C/10 + D) x G] - [Ep x D x G]        #
		;#####################################################################


CORREZIONI_1:   
		;[Ea x (C/10 + D) x G]
		LD      DE,(CILDIV)	
		LD	HL,(DERIVA)
		ADD	HL,DE		;HL = C/10+D
		LD	(MDO032),HL
		LD	HL,(GUADA)	;HL = G
		LD	(MRE032),HL
		LD	HL,0000H
		LD	(MDO232),HL
		LD	(MRE232),HL
		CALL	MOL32		;PT = (C/10+D)*G
		LD	HL,(PTO032)
		LD	(MDO032),HL
		LD	HL,(PTO232)
		LD	(MDO232),HL
		LD	HL,(ERATTU)	;HL = Ea
		LD	(MRE032),HL	
		CALL	MOL32		;PT = [Ea x (C/10 + D) x G]

		LD      A,(MSCORR_ATT)	
		CP      01H        
		JR      Z,CORREZIONI_2	

		;CORRATT = 80000000h - [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(CUBTR2),HL
		LD	HL,0000H	;MINUENDO = 80000000h
		LD	(CINUE0),HL
		LD	HL,8000H
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3

CORREZIONI_2:
		;CORRATT = 80000000h + [Ea x (C/10 + D) x G]
		LD	HL,(PTO032)
		LD	(ADDEN0),HL	;ADDENDO = [Ea x (C/10 + D) x G]
		LD	HL,(PTO232)
		LD	(ADDEN2),HL
		LD	HL,0000H	;AUGEND0 = 80000000h
		LD	(AUGEN0),HL
		LD	HL,8000H
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_3
		

CORREZIONI_3:
		;[Ep x D x G]
		LD      HL,(ERPREC)     
		LD      (MOLTI),HL
		LD      A,(DERIVA)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)      
		LD      (MOLT24),HL       ;RISULTATO
		LD      A,(GUADA)
                LD      (MOLP24),A      
                CALL    MOL24

		LD      A,(MSCORR_PREC)	
		CP      01H        
		JR      Z,CORREZIONI_4	

		;CORRATT = CORRATT + [Ep x D x G]
		LD	HL,(CORRATT)
		LD	(ADDEN0),HL	;ADDENDO = CORRATT
		LD	HL,(CORRATT+02H)
		LD	(ADDEN2),HL
		LD	HL,(PROD24)	;AUGEND0 = [Ep x D x G]
		LD	(AUGEN0),HL
		LD	HL,(PROD24+02H)
		LD	(AUGEN2),HL
		CALL	FABIOSOMM32		;AUGENDO = ADDENDO + AUGENDO
		LD	HL,(AUGEN0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(AUGEN2)
		LD	(CORRATT+02H),HL ;ALTO
		JR	CORREZIONI_5

CORREZIONI_4:
		;CORRATT = CORRATT - [Ep x D x G]
		LD	HL,(PROD24)
		LD	(CUBTR0),HL	;SOTTRAENDO = [Ep x D x G]
		LD	HL,(PROD24+02H)
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO

		JR	CORREZIONI_5
CORREZIONI_5:
		LD	A,(CORRATT+03H) ;IF CORRATT > 80000000h THEN MSCORR=01H ELSE MSCORR=D_RITARDO
		BIT	7,A
		JR	Z,CORREZIONI_6

		LD      A,01H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_6:
		LD      A,08H
		LD      (MSCORR),A
		JR	CORREZIONI_7

CORREZIONI_7:	
		LD	HL,0000H
		LD	(CUBTR0),HL	;SOTTRAENDO = 80000000h
		LD	HL,8000h
		LD	(CUBTR2),HL
		LD	HL,(CORRATT)	;MINUENDO = CORRATT
		LD	(CINUE0),HL
		LD	HL,(CORRATT+02H)
		LD	(CINUE2),HL
		CALL	CSOTT32		;RESTO = MINUENDO - SOTTRAENDO
		LD	HL,(CESTO0)
		LD	(CORRATT),HL	;BASSO
		LD	HL,(CESTO2)
		LD	(CORRATT+02H),HL ;ALTO
		
CORREZIONI_8:		

		LD      A,(CORRATT+03H)
		AND	7FH
		CP	00H
		JR	Z,CORREZIONI_9
                LD      BC,0FFFFH
                LD      A,0FFH
		JR	CORREZIONI_10
CORREZIONI_9:
                LD      BC,(CORRATT)
                LD      A,(CORRATT+02H)
		JR	CORREZIONI_10
CORREZIONI_10:

                LD      (MDECOR),A      ;VALORE PER 
                CP      00H             ;EXTRA CORREZ.
                JR      NZ,CORREZIONI_11

                LD      A,B

                LD      (CORRE),A
                JR      CORREZIONI_12          
CORREZIONI_11:  LD      A,0FFH
                LD      (CORRE),A





		;ROUTINE DI CORREZIONE


CORREZIONI_12:  LD      A,(CIDE75)      ;DECREMENTO 
                CP      00H             ;DEL 75% DEL
                JR      Z,CORREZIONI_13        ;CICLO
                DEC     A
                LD      (CIDE75),A


CORREZIONI_13:       

		LD      A,(MATTES)		;CONTROLLO CICLO
		DEC     A			;DI ATTESA
		LD      (MATTES),A
		CP      00H
		JP      NZ,COFINE

                LD      A,(CICL75)		;RICARICO IL 
                LD      (CIDE75),A		;75% DEL CICLO 

                LD      A,(CICATT)      ;RICARICO IL CI-
		LD      (MATTES),A      ;CLO DI ATTESA.
                LD      HL,(ERMEDI)
		LD      DE,(ZONA)
		SBC     HL,DE           ;SE ZONA MORTA
		JR      NC,CORREZIONI_14       ;MAGGIORE DI
		CCF                     ;ERMEDI SALTO
		JP      COFINE
CORREZIONI_14:      
		LD	A,(MEMC)		;SE SONO IN 
		BIT	2,A			;MANUALE SALTO
		JP      Z,COFINE

                LD      A,(CORRE)
                CP      00H			;SALTO
                JP      Z,KRAPIN        
                LD      A,(MDECOR)
                LD      (DECORR),A

		LD	A,(MFLEXL)		;VEDO SE ATTIVA 
		CP	00H			;CORREZ PROPORZINALE
		JR	Z,CORREZIONI_15		;DOPO F4
		JR	CORREZIONI_16

CORREZIONI_15:
                LD      A,(DERIVA)		 ;VEDO SE ATTIVA  PPPP       
                CP      00H			 ;SOLO CORREZ. PPPP
                JR      NZ,CORREZIONI_17	 ;PROPORZIONALE PPPP
CORREZIONI_16:
                LD      BC,(VCLONG)		 
                LD      HL,0000H		 
                SBC     HL,BC
                JR      Z,CORREZIONI_17                
                CALL    FLEXOL			
                JP      COFINE			
CORREZIONI_17:
                LD      A,37H			;CONTROLLO CTC1   
		OUT     (71H),A         
                LD      A,40H			;COSTANTE DI TEMPO
		OUT     (71H),A			
		LD      A,0D7H			;CONTROLLO CTC2
		OUT     (72H),A
                LD      A,(CORRE)		;MSB ERRORE  
                OUT     (72H),A


		LD      A,(MSCORR)		;VEDO IN CHE
		CP      01H		        ;SENSO CORREG.
		JR      NZ,AUTRIT

AUTAVA:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     1,A		
		SET     0,A		;AVANTI
		RES	4,A
		LD      (MEMC),A
		OUT     (PC),A
		
		JR     COFINE
AUTRIT:
	        LD      A,(MEMC)        ;CORREZIONE IN
		RES     0,A             ;RITARDO
		SET     1,A
                RES     4,A             
		LD      (MEMC),A
		OUT     (PC),A
COFINE:         RET

KRAPIN:         LD      A,(MEMC)        ;QUANDO L'ERRORE 
                RES     0,A             ;E' A ZERO
                RES     1,A             ;SI ANNULLA 
                LD      (MEMC),A        
                OUT     (PC),A          
                LD      A,43H           
                OUT     (71H),A         
                OUT     (72H),A
                RET                     



                ;CALCOLO ERRORE MEDIO PER CORREZIONE LONG


LMEDIA:
                LD      A,(PRIMOB)      ;WWAA
                LD      B,A
                LD      IX,MAVA00               ;+5CH     ;DMEP1C WWAA   ;SU SEDICI
                LD      DE,(VALORX)
                ADD     IX,DE
LMED01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    LMED01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      A,(PRIMOB)      ; LD      B,2FH           ;WWAA
                LD      B,A             ;WWAA
                LD      IY,MRIT00       ;+5CH   ;DMED1C       WWAA
                LD      DE,(VALORX)     ;WWAA
                ADD     IY,DE           ;WWAA
LMED02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;16 CELLE
                DEC     IY
                DEC     IY
                DJNZ    LMED02
                INC     IY
                INC     IY


                LD      DE,(ERATTU)      ;WWAA  LD      DE,(ERMEDI)    INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 16 CELLE
                JR      Z,LMED04
LMED03:
                LD      (MAVA00),DE
                LD      (MRIT00),BC
                JR      LMED05
LMED04:         
                LD      (MAVA00),BC
                LD      (MRIT00),DE
LMED05:
                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H           
                JR      NC,LMED06       ;48 CELLE 16 CELLE TMEPXX WWAA
                CCF                      ; 
LMED06:         LD      HL,0000H
LMED07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    LMED07
                LD      (SOMLO1),HL

                LD      A,(SECONB)      ;WWAA
                LD      B,A             ;WWAA LD      B,30H 
                JR      NC,LMED08        ;48 CELLE 16 CELLE DTEDXX    WWAA
                CCF
LMED08:         LD      HL,0000H
LMED09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    LMED09

                LD      (SOMLO2),HL
                LD      DE,(SOMLO1)
		SBC     HL,DE
                JR      C,LMED10        
                LD      A,01H           ;CORREZIONE
                LD      (MSCORR),A      ;IN AVANTI

                LD      A,23H           ;SIMBOLO ERRORE
                LD      (BINSET+10H),A  ;RITARDO

                JR      LMED11

LMED10:         CCF
                LD      A,08H           ;CORREZIONE
                LD      (MSCORR),A      ;IN RITARDO

                LD      A,1CH           ;SIMBOLO ERRORE
                LD      (BINSET+10H),A  ;AVANTI




                EX      DE,HL
                LD      DE,(SOMLO2)
		SBC     HL,DE
LMED11:         LD      (DIVDEN),HL
                LD      BC,(SECONB)     ;DIVISIONE    WWAA
                LD      B,00H           ;WWAA
                LD      (DIVSOR),BC     ;PER XX GGAA
		CALL    DIVIS
		LD      HL,(QUOZIE)
                LD      (ERMEDI),HL

LMED12:         LD      DE,0000H
		SBC     HL,DE
                JR      NZ, LMED13 

                LD      A,00H           ;NESSUNA
                LD      (MSCORR),A      ;CORREZIONE


                LD      A,09H           ;SIMBOLO =
                LD      (BINSET+10H),A


LMED13:         


                ;MEDIA ERRORE SU QUATTRO PER DISPLY LONGITUDINALE


		LD      B,03H           ;FFFE        0FH           ;WWAA 
                LD      IX,DAVA00       ;
                LD      DE,0004H        ;FFFE     ;001CH
                ADD     IX,DE
MEDL01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;ERRORE AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDL01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      B,03H           ;FFFE  0FH           ;WWAA
                LD      IY,DRIT00       ;WWAA
                LD      DE,0004H        ;FFFE     001CH
                ADD     IY,DE           ;WWAA
MEDL02:
                LD      E,(IY)          ;RIPETE QUELLO
                LD      D,(IY+01H)      ;VISTO SOPRA
                LD      (IY+02H),E      ;CON ALTRE  
                LD      (IY+03H),D      ;4 CELLE
                DEC     IY
                DEC     IY
                DJNZ    MEDL02
                INC     IY
                INC     IY


                LD      DE,(ERMEDI)      ;FFFE  (ERATTU)   INSERIMENTO
                LD      BC,0000H         ;NUOVO ERRORE
                LD      A,(MSCORR)       ;NELLA PRIMA
                CP      01H              ;DELLE 4 CELLE
                JR      Z,MEDL04
MEDL03:
                LD      (DAVA00),DE
                LD      (DRIT00),BC
                JR      MEDL05
MEDL04:         
                LD      (DAVA00),BC
                LD      (DRIT00),DE
MEDL05:
                LD      B,04H              ;FFFE 10H            ;SOMMA DELLE  
                JR      NC,MEDL06        ;4 CELLE  WWAA
                CCF                      ; 
MEDL06:         LD      HL,0000H
MEDL07:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDL07
                LD      (SOMDL1),HL

                LD      B,04H            ; FFFE  10H            ;SOMMA DELLE   WWAA
                JR      NC,MEDL08        ;4 CELLE  WWAA
                CCF
MEDL08:         LD      HL,0000H
MEDL09:
                LD      E,(IY+00H)
                LD      D,(IY+01H)
                ADC     HL,DE
                INC     IY
                INC     IY
                DJNZ    MEDL09

                LD      (SOMDL2),HL
                LD      DE,(SOMDL1)
                SBC     HL,DE
                JR      C,MEDL10       ;SIMBOLO ERRORE
                JR      MEDL11   
MEDL10:         CCF
		EX      DE,HL
                LD      DE,(SOMDL2)     ;WWAA
		SBC     HL,DE
MEDL11:         LD      (DIVDEN),HL
                LD      BC,0004H        ;FFFE     0010H        ;
                LD      (DIVSOR),BC     ;
                CALL    DIVIS
                LD      DE,(QUOZIE)
                LD      (BINSET),DE

                RET


                
                
		;RANGE  IL SEGNO 8H/7H PER SPAZIO 10H/15H

              
                
		;RANGE  IL SEGNO 8H/7H PER SPAZIO 10H/15H

CODICE:         
		
	        CALL    VERIFI          ;EEUU
		LD      A,(MEMB)
		SET     6,A             ;BLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
		LD      A,(GUADS1)      ;CARICO 
		LD      B,A             ;GUADAGNO DI
		LD      A,(MEMA)        ;S1 XXXXXXX
		ADD     A,B
		LD      (MEMA),A
		OUT     (PA),A          ;XXXXXX
		LD      A,0D7H          ;SE DOPO CIRCA 10  RRAA
		OUT     (71H),A         ;GIRI DI RICERCA
		LD      A,02H           ;FALLITA ESCI RRAA
		OUT     (71H),A         
COD1:                    
		LD	A,(MRIC+02H)	;SE NO IN RICERCA RRDD
		CP	00H		;ESCI
		JP	Z,W11

		LD      A,(SPAZ40)      ;40mm MAX A8
		LD      E,A
COD2:           IN      A,(PB)          
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      Z,COD2
COD3:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      NZ,COD3
		DEC     E
		JR      NZ,COD2
		
		;PRIMO SEGNO

		LD      A,(SEGNO)       ;1mm
		LD      E,A
		LD      BC,0FFFFH       ;NEL CASO MANCHI
TER:            DEC     BC              ;IL CODICE
		LD      A,B
		OR      C
		JR      Z,COD1
		IN      A,(PB)
		BIT     2,A
		JR      Z,TER
		CALL    RIT
		IN      A,(PB)          ;SE>1mm COD1
		BIT     2,A
		JR      NZ,COD1

		;PRIMO SPAZIO BIANCO

		LD      A,(SPAZIO)      ;5mmm MAX 16H
		LD      E,A
MIS2:           IN      A,(PB)          ;SE STAMPA COD1
		BIT     2,A
		JR      NZ,COD1
		BIT     4,A
		JR      Z,MIS2
MIS3:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      NZ,MIS3
		DEC     E
		JR      NZ,MIS2
		CALL    MARC            ;SENTE SE NEI
		LD      A,00H           ;PROSSIMI 2mm
		OR      B               ;ARRIVA IL SEGNO
		JR      Z,COD1          ;DI CODICE.

		;SECONDO SEGNO

		LD      A,(SEGNO)
		LD      E,A
QUAR:           IN      A,(PB)
		BIT     2,A
		JR      Z,QUAR
		CALL    RIT
		IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1 

		;SECONDO SPAZIO BIANCO

		LD      A,(SPAZIO)      ;5mmm MAX 16H
		LD      E,A
MIS4:           IN      A,(PB)
		BIT     2,A
		JR      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      Z,MIS4
MIS5:           IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1         ;SE STAMPA COD1 RRDD
		BIT     4,A
		JR      NZ,MIS5
		DEC     E
		JR      NZ,MIS4
		CALL    MARC
		LD      A,00H
		OR      B
		JP      Z,COD1


		;TERZO SEGNO

		LD      A,(SEGNO)
		LD      E,A
QUIN:           IN      A,(PB)
		BIT     2,A
		JR      Z,QUIN
		CALL    RIT
		IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1

		;TERZO SPAZIO BIANCO

		LD      A,(SPAZIO)
		LD      E,A
MIS6:           IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1         ;SE STAMPA COD1
		BIT     4,A
		JR      Z,MIS6
MIS7:           IN      A,(PB)
		BIT     2,A
		JP      NZ,COD1
		BIT     4,A
		JR      NZ,MIS7
		DEC     E
		JR      NZ,MIS6


                ;CALCOLO POSIZIONE PRIMO GATE     SSRR

MIS8:           IN      A,(PB)          ;WWWW
		BIT     2,A
		JR      Z,MIS8
GATEPU:         IN      A,(10H)         ;LEGGO LA POSI- PPUU
                LD      L,A             ;ZIONE  WWWW
		IN      A,(20H)
                LD      H,A             ;WWWW
                LD      (FASES1),HL     ;WWWW

                LD      A,(SEGRIF)      ;SSRR
                CP      01H
                JR      Z,MIS81
                LD      B,A
                LD      A,(SEQSEG)      ;CONTROLLO SE
                XOR     B               ;SE SONO
                JR      Z,MIS81         ;UGUALI
                LD      A,(SEQSEG)
                SBC     A,B
                JR      C,W40

                LD      DE,(MILL20)
		LD      (MOLTI),DE
                LD      A,(SEGRIF)
                DEC     A
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
                LD      DE,(FASES1)     ;SSRR
		ADD     HL,DE
                LD      DE,(MILL60)     
                SBC     HL,DE           
		LD      A,H             ;CONTROLLO SE 
		CP      10H             ;LA SOMMA HA
                JR      C,W30           ;SUPERATO 4096
		LD      DE,1000H        ;SE LO E'
		SBC     HL,DE           ;SOTTRAGGO AL
                LD      (FASE),HL       ;SSRR LD  (FASES1),HL ;RISULTATO 4096
                JR      IIGATE
W30:            CCF
                LD      (FASE),HL      
                JR      IIGATE          ;SSRR

W40:            CCF                     ;SSRR




MIS81:          LD      BC,(MILL45)     ;GRAFIKONTOL WWWW CCDD BBAA 
MIS82:          SBC     HL,BC           ;SE IL RISULTATO  CCDD
                JR      NC,W4           ;E'POSITIVO LO
                CCF                     ;MEMORIZ.IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
                LD      BC,(FASES1)     ; E IL
		ADD     HL,BC           ;RESTO LO SOMMO
W4:             LD      (FASE),HL       ;AL VALORE LETTO.


		;CALCOLO POSIZIONE SECONDO GATE
                         
IIGATE:                                ;IIGG

		LD      DE,(MILL20)           
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		DEC     A
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)

                LD      DE,(FASES1)     ;SSRR
                ADD     HL,DE

		LD      A,(NANOCI)      ;NNCC  SSRR
                CP      00H
                JR      Z,W5
                LD      DE,(MILL45)
                JR      W6
W5:             LD      DE,(MILL8)      
W6:             SBC     HL,DE          ;SSRR

		LD      A,H             ;CONTROLLO SE 
		CP      10H             ;LA SOMMA HA
                JR      C,W10           ;SUPERATO 4096
		LD      DE,1000H        ;SE LO E'
		SBC     HL,DE           ;SOTTRAGGO AL
		LD      (FASE2),HL      ;RISULTATO 4096
                JR      W20
W10:            CCF
                LD      (FASE2),HL      ;SSRR


		;CALCOLO PUNTO DI ABILITAZIONE DI PA7

W20:            
                LD      HL,(FASE)
                LD      DE,(MILL35)     ;DEVRIM
		SBC     HL,DE
		JR      NC,W3
		CCF
		LD      HL,1000H        ;4096
		SBC     HL,DE
W3:             LD      (FASE3),HL
		LD      A,00H
		LD	(MRIC+00H),A	;RRDD
		LD      (MRIC+02H),A

                LD      A,(SEGRIF)      ;CCGG
                CP      01H
                JR      Z,W11
                CALL    SPASI          
W11:                                   ;CCGG
		RET

		;SUBROUTINE DI RITARDO

RIT:            IN      A,(PB)
		BIT     4,A
		JR      Z,RIT
RIT1:           IN      A,(PB)
		BIT     4,A
		JR      NZ,RIT1
		DEC     E
		JR      NZ,RIT
		RET

		;SUROUTINE DI CONTROLLO CODICE

MARC:           LD      A,(SEGNO)       ;MISURA 2mm IN      
		LD      B,A             ;MODO CHE IN
MAR1:           IN      A,(PB)          ;QUESTO SPAZIO
		BIT     2,A             ;PASSI IL SEGNO
		JR      NZ,RIT0         ;DI CODICE
		BIT     4,A
		JR      Z,MAR1
MAR2:           IN      A,(PB)
		BIT     2,A
		JR      NZ,RIT0
		BIT     4,A
		JR      NZ,MAR2
		DEC     B
		JR      NZ,MAR1
RIT0:           RET




		;ADEGUAMENTO GUADAGNO AMPLIFICAT. ESTERNO



GAINS1:         EXX
		LD      A,(GUADS1)
		CP      60H
		JR      Z,GS11
		CP      40H
		JR      Z,GS12
		CP      20H
		JR      Z,GS13
		CP      00H
		JR      Z,GS14
GS11:           LD      A,40H
		JR      GS15
GS12:           LD      A,20H
		JR      GS15
GS13:           LD      A,00H
		JR      GS15
GS14:           LD      A,60H
GS15:           LD      (GUADS1),A
		EXX
		RET

GAINS2:         EXX
		LD      A,(GUADS2)
		CP      60H
		JR      Z,GS21
		CP      40H
		JR      Z,GS22
		CP      20H
		JR      Z,GS23
		CP      00H
		JR      Z,GS24
GS21:           LD      A,40H
		JR      GS25
GS22:           LD      A,20H
		JR      GS25
GS23:           LD      A,00H
		JR      GS25
GS24:           LD      A,60H
GS25:           LD      (GUADS2),A
		EXX
		RET

		;CONTROLLO PARAMETRI E EVENTUALE
		;INSERIMENTO VALORI DI DEFAULT



DEFAUL:         LD      IX,TRIP         
		LD      (IX+01H),00H
                LD      A,(IX)
                CP      0FH
                JR      NC,DEF1
		JR      DEF2
DEF1:           LD      A,06H
		LD      (IX),A

DEF2:           LD      IX,GUADA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF3
		CP      64H
                JR      NC,DEF3
                JR      DEF4
DEF3:           LD      A,0AH
		LD      (IX),A
		
DEF4:           LD      IX,CICLO
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF5
		CP      64H
                JR      NC,DEF5
                JR      DEF6
DEF5:           LD      A,0FH
		LD      (IX),A
		
DEF6:           LD      IX,DERIVA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF7
                CP      0FEH
                JR      NC,DEF7
                JR      DEF8
DEF7:           LD      A,00H		;PPPP
		LD      (IX),A
		
DEF8:           LD      IX,ZONA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF9
		CP      65H		;SSMM
                JR      NC,DEF9
                JR      DEF10
DEF9:           LD      A,00H
		LD      (IX),A
		
DEF10:          LD      IX,INSER
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF11
                CP      0FFH
                JR      NC,DEF11
                JR      DEF12
DEF11:          LD      A,0AH
		LD      (IX),A

DEF12:          LD      IX,SALTO
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF14		 ;JR      Z,DEF13 FFSS
		CP      0AH
                JR      NC,DEF13
                JR      DEF14
DEF13:          LD      A,01H           ;MMUU
		LD      (IX),A


DEF14:          LD      IX,LINGUA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF15
                CP      05H             ;TTDD
                JR      NC,DEF15
                JR      DEF16
DEF15:          LD      A,00H           ;INGLESE
		LD      (IX),A


DEF16:          LD      IX,VCLONG       ;FFZZ
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      0AH
                JR      C,DEF17
                JR      DEF18
DEF17:          LD      A,00H           
		LD      (IX),A

DEF18:
                LD      IX,PROXIM       ;PXXX
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF19
                CP      02H             ;
                JR      NC,DEF19
                JR      DEF20
DEF19:          LD      A,00H
                LD      (IX),A          

DEF20:          LD      IX,SEGRIF       ;SSRR
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF21
                CP      0DH
                JR      NC,DEF21
                JR      DEF22
DEF21:          LD      A,01H           
		LD      (IX),A

DEF22: 
		LD      IX,ABIDOP      ;DDAA
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF23
                CP      02H
                JR      NC,DEF23
                JR      DEF24
DEF23:          LD      A,00H
		LD      (IX),A
DEF24:		
                LD      IX,SELFRO       ;FFSS
		LD      (IX+01H),00H
		LD      A,(IX)
		CP      00H
                JR      Z,DEF25
                CP      02H             ;
                JR      NC,DEF25
                JR      DEF26
DEF25:          LD      A,00H
                LD      (IX),A          
                
DEF26:		
		
		RET  




               ;CALCOLO RAPPORTO POSIZINE PIENO TRAVERS S1

TRAVER:                                ;+++++++++++++++++
;             	LD      A,(MM_MC)       ;PUUU
;                CP      00H		
;                JR      NZ,TRAV5

		LD	A,(MEMFAS)	;DEVE PASSARE PUUU
		CP	02H		;DUE VOLTE
		JP	NZ,GIR1		;DA PIOB

TRAV5:		
		LD      A,(ALTERR)      ;VEDE SE DEVE PUUU
		CP      00H             ;ASPETTARE
		JR	Z,TRAV3
		
		JP	GIR1
;;+++++++++++++++++++++++++++++++++++++++++++++++++++++
;DA VERIFICARE IN UN SECONDO TEMPO
;TRAV3:		
;		LD      A,(TALTER)      ;QUANDO ALTERR PUUU
;		CP      00H             ;ARRIVA A ZERO
;		JR      Z,TRAV2         ;RIPRENDE IL
;		CP	03H             ;CALCOLO DELLO
;		JR	NC,TRAV1        ;ERRORE
;		DEC     A               ;CALCOLO DELLO
;		LD      (TALTER),A      ;ERRORE
;		JR	Z,TRAV1
;		JP	GIR1	
;TRAV1:		LD	A,00H
;		LD	(TALTER),A	;PUUU
;TRAV2:
;;		LD      A,(MM_MC)       ;SE M/C SALTO
;;                CP      00H		
;;                JR      NZ,TRAV4
;
;		LD	DE,(TASES1)	;VEDO SE PER
;		LD	HL,(TASES2)	;ERRORE NON
;		SBC	HL,DE		;HO LETTO
;		JP	Z,MEDT016	;DUE VOLTE1		;PUUU
;		JR	NC,TRAV4	;LS STESSA FASE
;		CCF
;TRAV4:					;PUUU
;;		LD      DE,(TERATT)     ;WWAA   (PIRLA)  +	SSSS
;;                LD      (TERPRE),DE     ;WWAA MEGAPIRLA  +SSSS
;;                                        ;+++++++++++++++++
;              ;  LD      A,(TMSCOR)      ;WWAA SSSS

;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

TRAV3:
		LD	DE,(TASES1)	;VEDO SE PER	SSSS
		LD	HL,(TASES2)	;ERRORE NON
		SBC	HL,DE		;HO LETTO
		JP	Z,GIR1  	;DUE VOLTE1 SSSS

                LD      IX,TPIEN1       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
                LD      IY,TPOSI1       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
                JR      C,RAPP30        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
                LD      IY,TPIEN1
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
                JR      RAPP31
RAPP30:         CCF
		LD      A,00H
RAPP31:         LD      (TRAPP1),A      ;VERIFICO SE E'
                
;		LD	A,(MM_MC)	;MMXX
;		CP	00H
;		JP	NZ,TRAVMC

                ;CALCOLO RAPPORTO POSIZINE PIENO TRAVERS S2

                LD      IX,TPIEN2       ;DIVIDO PIENO
		LD      E,(IX+00H)      ;PER DIECI
		LD      D,(IX+01H)      ;E SOTTRAGGO
		LD      (DIVDEN),DE     ;IL RISULTATO
		LD      BC,000AH        ;A POSIZIONE
		LD      (DIVSOR),BC     ;SE IL RISULTATO
		CALL    DIVIS           ;E' NEGATIVO
		LD      IX,QUOZIE       ;VUOLE DIRE CHE
		LD      E,(IX+00H)      ;DIVIDENDO
		LD      D,(IX+01H)      ;POSIZIONE X 10
                LD      IY,TPOSI2       ;CON PIENO AVRO'
		LD      L,(IY+00H)      ;UN NUMERO MINORE
		LD      H,(IY+01H)      ;DI 0,1 PER CUI
		SBC     HL,DE           ;CARICO IN MEM.
                JR      C,RAPP40        ;RAPPORTO ZERO.
		LD      E,(IY+00H)      ;SE LA SOTTRZIONE
		LD      D,(IY+01H)      ;NON DA RISULTATO
		LD      (MOLTI),DE      ;NEGATIVO PROCEDO
		LD      A,0AH           ;NELLA DIVISIONE
		LD      (MOLPL),A       ;POSIZIONE X 10
		CALL    MOLT            ;DIVISO PIENO
		LD      IX,PROD         ;E OTTERRO'UN
		LD      C,(IX+00H)      ;RISULTATO 
		LD      B,(IX+01H)      ;COMPRESO 
		LD      (DIVDEN),BC     ;TRA 0,1 E 0,9
                LD      IY,TPIEN2
		LD      E,(IY+00H)
		LD      D,(IY+01H)
		LD      (DIVSOR),DE
		CALL    DIVIS
		LD      A,(QUOZIE+00H)
                JR      RAPP41
RAPP40:         CCF
		LD      A,00H
RAPP41:         LD      (TRAPP2),A      ;VERIFICO SE E'
                

                ;CALCOLO SPESSORE SEGNO DI RIFERIMENTO

		;CALCOLO POSIZIONE TOTTALE TRAVERS
		;(TASES1 x 10) + TRAPP1 = TPOST1

		LD      DE,(TASES1)     ;TASES1 x 10
		LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
		LD      HL,(TRAPP1)
		LD      H,00H
		ADD     HL,DE
		LD      (TPOST1),HL
;                LD      DE,(POSTO1)
;		SBC     HL,DE
;                JR      NC,SPES1        ;SE LA MISURA E'  SSSS
;		CCF                     ;FATTA A CAVALLO
;		LD      HL,0A000H       ;DI ZERO ENCODER
;		LD      DE,(TPOST1)     ;TPOST1<POSTOT
;		ADD     HL,DE           ;PER CUI SOMMO  
;                LD      DE,(POSTO1)     ;A TPOSTO 40960
;		SBC     HL,DE           ;E RIPETO SBC.
;SPES1:
;                LD      (SPELE1),HL

		
                ;CALCOLO POSIZIONE TOTTALE TRAVERS S2

PROVAT:
                LD      DE,(TASES2)     ;FASES2 x 10
                LD      (MOLTI),DE
		LD      A,0AH
		LD      (MOLPL),A
		CALL    MOLT
		LD      DE,(PROD)
                LD      HL,(TRAPP2)
		LD      H,00H
		ADD     HL,DE
                LD      (TPOST2),HL
;                LD      DE,(POSTO2)     ;SSSS
;		SBC     HL,DE
;                JR      NC,SPES2        ;SE LA MISURA E'
;		CCF                     ;FATTA A CAVALLO
;		LD      HL,0A000H       ;DI ZERO ENCODER
;                LD      DE,(TPOST2)     ;POSTO2<POSTO1
;		ADD     HL,DE           ;PER CUI SOMMO  
;                LD      DE,(POSTO2)     ;A POSTO2 40960  SSSS
;		SBC     HL,DE           ;E RIPETO SBC.
;SPES2:
;                LD      (SPELE2),HL


		RET			;SSSS




                ;CALCOLO VELOCITA'ISTANTANEA SLEGATO     BBLL
                ;DAL NORMALE CALCOLO USATO SOLO PER NOPRI
                
VELIST:                                 ;BBLL

                LD      BC,011DH        ;4mS TEMPO   
                LD      IX,IMPVEL       ;PER MISURARE
                LD      A,00H           ;GLI IMPULSI
                LD      (IX+01H),A
                LD      A,057H          ;SETTO CTC0
                OUT     (70H),A         ;SENZA INTERUPT
                LD      A,0FFH          
                OUT     (70H),A         
VELO1:          IN      A,(70H)         ;NEL CASO IL 
                CP      00H             ;DECREMENTO 
                JR      NZ,VELO2        ;ARRIVI A ZERO
                INC     (IX+01H)        ;LO MEMORIZZO

VELO2:          DEC     BC              
                LD      A,B
                OR      C
                JR      NZ,VELO1       
                IN      A,(70H)         
                CPL                     ;IMPULSI PROPOR
                LD      (IMPVEL),A      ;ALLA VELOCITA.


                LD      DE,(COSVEL)
		LD      (MDO032),DE
		LD      DE,0000H
		LD      (MDO232),DE
		LD      (MRE232),DE
		LD      DE,(IMPVEL)
		LD      (MRE032),DE
		LD      A,02H           
		LD      (ALTDIV),A      
		CALL    MOL32
		CALL    DI1000
		LD      BC,(QU1000)     ;VELOCITA         
		LD      (ISTVEL),BC     ;ISTANTANEA    

                RET


                ;SCRITTURA CIAO

CIAO:       
		LD      A,5BH           ;Z LOLA
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,38H           ;L
		LD      (BINSET+0EH),A
		LD      A,3FH           ;O
		LD      (BINSET+0DH),A
                LD      A,00H           
		LD      (BINSET+0CH),A
		EXX
	        CALL    TRDIS
		CALL	RITDIS

                LD      A,(LINGUA+00H)
		CP      00H
		JR      Z,CIAOE
		CP      01H
		JR      Z,CIAOI
		CP      02H
		JR      Z,CIAOS
		CP      03H
		JR      Z,CIAOF
                CP      04H             ;TTDD
                JR      Z,CIAOD         ;TTDD
CIAOE:          LD      A,00H           
		LD      (BINSET+10H),A
		LD      A,76H           ;H
		LD      (BINSET+0FH),A
		LD      A,06H           ;I
		LD      (BINSET+0EH),A
		LD      A,00H           ;
		LD      (BINSET+0DH),A
		LD      (BINSET+0CH),A
		JR      CIAOFIN
CIAOI:          LD      A,39H           ;C
		LD      (BINSET+10H),A
                LD      A,06H           ;I
		LD      (BINSET+0FH),A
                LD      A,77H           ;A
		LD      (BINSET+0EH),A
                LD      A,3FH           ;O
		LD      (BINSET+0DH),A
                LD      A,00H           
		LD      (BINSET+0CH),A
		JR      CIAOFIN 
CIAOS:          LD      A,76H           ;H
		LD      (BINSET+10H),A
		LD      A,3FH           ;O
		LD      (BINSET+0FH),A
		LD      A,38H           ;L
		LD      (BINSET+0EH),A
		LD      A,77H           ;A
		LD      (BINSET+0DH),A
		LD      A,00H           
		LD      (BINSET+0CH),A
		JR      CIAOFIN
CIAOF:          LD      A,6DH           ;S
		LD      (BINSET+10H),A
		LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,38H           ;L
		LD      (BINSET+0EH),A
		LD      A,3EH           ;U
		LD      (BINSET+0DH),A
                LD      A,78H           ;t
		LD      (BINSET+0CH),A
                JR      CIAOFIN          ;TTDD
CIAOD:          LD      A,76H           ;H
		LD      (BINSET+10H),A
                LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,38H           ;L
		LD      (BINSET+0EH),A
                LD      (BINSET+0DH),A	;L
                LD      A,3FH           ;O
		LD      (BINSET+0CH),A
CIAOFIN:
		EXX
	        CALL    TRDIS
		CALL	RITDIS

 		RET                           




		;RITARDO PER DISPLAY



RITDIS:         LD      D,02H		;LOLA
RITDI1:         LD      BC,0FFFFH
RITDI2:         DEC     BC
		LD      A,B
		OR      C
		JR      NZ,RITDI2
		DEC     D
		JR      NZ,RITDI1
		RET


                ;ROUTINE CALCOLO INTERVALLO CORREZIONI
                ;IN FUNZIONE DELLO SVILUPPO DEL CILINDRO
                ;E DELLA POSIZIONE DEL GRUPPO STAMPA



INTCOR:         LD      DE,00FEH        ;254mm
                LD      (MOLTI),DE      ;CALCOLO I
                LD      A,(CICLO)       ;FORMATI CHE
                LD      (MOLPL),A       ;CI SONO TRA  
                CALL    MOLT            ;LA TESTA E
                LD      DE,(PROD)       ;IL RELATIVO  
                LD      (DIVDEN),DE     ;GRUPPO STAMPA 
                LD      DE,(CILIN)      ;IN FUNZIONE
                LD      (DIVSOR),DE     ;DEL FORMATO
                CALL    DIVIS           ;MONTATO.
                LD      DE,(QUOZIE)     ;INCREMENTO
                INC     DE              ;PER ARROTON-
                LD      A,E             ;DARE SUI DE- 
                CP      04H             ;CIMALI.
                JR      NC,INTCO1       ;SE IL RISUL-
                CCF                     ;TATO E'MINORE
                LD      DE,0004H        ;DI 4 IMPONGO
INTCO1:         LD      (CICATT),DE     ;MINIMO 4

                NOP                     ;CALCOLO DEL 
                LD      (MOLTI),DE      ;75% DEL CICLO
                LD      A,19H           ;CHE VIENE USATO
                LD      (MOLPL),A       ;ALL'INIZIO DELLE
                CALL    MOLT            ;EXTRA CORREZ.
                LD      DE,(PROD)       ;PER FAR SI CHE
                LD      (DIVDEN),DE     ;VI SIA UNA 
                LD      BC,64H          ;BREVE INTERRU-
                LD      (DIVSOR),BC     ;ZIONE PER 
                CALL    DIVIS           ;EVITARE LA
                LD      DE,(QUOZIE)     ;CORREZZIONE
                LD      HL,(CICATT)     ;CONTINUA  ATTT
                SBC     HL,DE
                LD      (CICL75),HL

                RET


		;ROUTINE DI DIVISIONE A 16 BIT



DIVIS:          EXX
		LD      DE,(DIVDEN)
		LD      BC,(DIVSOR)
DIV16:          XOR     A
		LD      H,A
		LD      L,A
		LD      A,10H
DV0:            RL      E
		RL      D
		ADC     HL,HL
		SBC     HL,BC
		JR      NC,DIV1
		ADD     HL,BC
DIV1:           CCF
		DEC     A
		JR      NZ,DV0
		EX      DE,HL
		ADC     HL,HL
		LD      (QUOZIE),HL
		EXX
		RET

		;ROUTINE DI MOLTIPLICAZIONE



MOLT:           EXX
		LD      DE,(MOLTI)      ;MOLTIPLICANDO
		LD      A,(MOLPL)       ;MOLTIPLICATORE
		LD      HL,00H
		LD      B,08H
MULT:           ADD     HL,HL
		RLA
		JR      NC,CHCNT
		ADD     HL,DE
CHCNT:          DJNZ    MULT            ;SE IL RISULTATO
		CP      00H             ;E'> DI FFFFH IL
		JR      Z,CHC1          ;REGISTRO A SARA'
		LD      HL,0FFFFH       ;DIVERSO DA 0 PER
CHC1:           LD      (PROD),HL       ;CUI CARICA IL MAX
		EXX                     ;(SOLO IN CASO DI
		RET                     ;CORREZ.MOTORE)



;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& NNDD
;		SOMMA A 32 BIT
;
;	AUGENDO = ADDENDO + AUGENDO
;	si definisce il primo operando addendo e il secondo augendo. 
;	Il risultato somma va poi a sostituire il valore dell'augendo 
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&		
                

FABIOSOMM32:      
		EXX
		LD      DE,ADDEN0
		LD      HL,AUGEN0
		LD      B,04H
		AND     A
FABIOADDW:      LD      A,(DE)
		ADC     A,(HL)
		LD      (HL),A
		INC     DE              ;IL RISULTATO
		INC     HL              ;SI TROVA NELLA
		DJNZ    FABIOADDW            ;LOCAZIONE 
		EXX                     ;ADDEN0 E ADDEN2
		RET

;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& NNDD
;		SOTTRAZIONE A 32 BIT
;
;	RESTO = MINUENDO - SOTTRAENDO
;&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&		

CSOTT32:        EXX
                AND     A
                LD      HL,(CINUE2)
                LD      DE,(CUBTR2)
                SBC     HL,DE
                JR      NC,COT00
                LD      HL,(CINUE2)
                LD      (CINUE2),DE
                LD      (CUBTR2),HL
                LD      HL,(CINUE0)
                LD      DE,(CUBTR0)
                LD      (CINUE0),DE
                LD      (CUBTR0),HL
COT00:          LD      HL,(CINUE0)
                LD      DE,(CINUE2)
                LD      BC,(CUBTR0)
                AND     A
                SBC     HL,BC
                LD      (CESTO0),HL
                JR      NC,COT01
                DEC     DE
COT01:          EX      DE,HL
                LD      DE,(CUBTR2)
                AND     A
                SBC     HL,DE
                LD      (CESTO2),HL
                EXX
                RET

               
CSOM32:         EXX
                SCF
                CCF
                LD      HL,(CADDE0)
                LD      DE,(CAUGE0)
                ADC     HL,DE
                LD      (CSOMM0),HL
                LD      HL,(CADDE2)
                LD      DE,(CAUGE2)
                ADC     HL,DE
                LD      (CSOMM2),HL
                SCF
                CCF
                EXX
                RET


		;ROUTINE DI AGGIUSTAMENTO DECIMALE



AGGIUS:         EXX                     ;USO LA CONVER-
		LD      D,02H           ;SIONE BINARIO
		LD      E,05H           ;BCD E CONTROLLO
		LD      A,00H           ;SE L'UNITA' E'
		LD      B,E             ;TRA 0-5 LASCIO
		LD      HL,AGGIU+02H    ;COSI'SE E'TRA 
CLRA:           LD      (HL),A          ;6-9 AUMENTO LA
		INC     HL              ;DECINA DI UNO
		DJNZ    CLRA
		LD      A,D             ;A=NUMERO BYTE
		ADD     A,A
		ADD     A,A
		ADD     A,A
                LD      C,A             ;C=NUMERO BIT
LOOPA:          LD      L,00H
		LD      B,D
SHLBA:          RL      (HL)
		INC     HL
		DJNZ    SHLBA
		LD      L,02H
		LD      B,E
BCDADA:         LD      A,(HL)
		ADC     A,A
		DAA
		LD      (HL),A
		INC     HL
		DJNZ    BCDADA
		DEC     C
		JR      NZ,LOOPA
		LD      IX,QUOZIE
		LD      HL,AGGIU+02H    ;TAB.COPPIA BCD
		RRD
		CP      06H
		JR      Z,PI4
		CP      07H
		JR      Z,PI3
		CP      08H
		JR      Z,PI2
		CP      09H
		JR      Z,PI1
		JR      FINP1
PI4:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0004H
		ADD     HL,BC
		JR      FINP0
PI3:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0003H
		ADD     HL,BC
		JR      FINP0
PI2:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0002H
		ADD     HL,BC
		JR      FINP0
PI1:            LD      L,(IX+00H)
		LD      H,(IX+01H)
		LD      BC,0001H
		ADD     HL,BC
FINP0:          LD      (QUOZIE),HL
FINP1:          EXX
		RET



		;MOLTIPLICAZIONE A 24 BIT  

MOL24:          EXX                                                                                        
		LD      DE,(MOLT24)
		LD      A,(MOLP24)
		LD      BC,800H                
		LD      H,C
		LD      L,C
MPX1:           ADD     HL,HL
		RLA
		JR      NC,MPX2
		ADD     HL,DE
		ADC     A,C             ;IL RISULTATO
MPX2:           DJNZ    MPX1            ;SI TROVA IN AHL
		LD      (PROD24),HL
		LD      (PROD24+02H),A
                LD      A,00H
                LD      (PROD24+03H),A
		EXX
		RET

		;DIVISIONE PER 4096



DI4096:         EXX
		LD      HL,(PROD24)
		LD      A,(PROD24+02H)
		LD      B,0DH           ;PER DIVIDERE
MPX3:           DJNZ    MPX4            ;IN 4096 SHIFTO
		JR      MPX8            ;A DESTRA 12 VOLTE
MPX4:           SRL     L
		SRL     H
		JR      C,MPX6
MPX5:           SRL     A
		JR      C,MPX7
		JR      MPX3
MPX6:           CCF
		SET     7,L
		JR      MPX5
MPX7:           CCF
		SET     7,H
		JR      MPX3
MPX8:           LD      (QU4096),HL
		EXX
		RET


		;DIVIS. 24 PER 8 BIT (DIVISIONE PER 1000)
		


DI1000:         EXX
                LD      A,(ALTDIV)       
                CP      00H
                JR      Z,DI1004
                LD      IX,PTO032
                JR      DI1005
DI1004:         LD      IX,RESTO0
DI1005:         LD      DE,3E8H         ;1000
                LD      BC,0000H
		LD      A,16
		LD      (MDIVIS),A
DI1001:         LD      H,(IX+03H)
		LD      L,(IX+02H)
		SBC     HL,DE
		JP      M,DI1002
		LD      (IX+03H),H      ;RESTO
		LD      (IX+02H),L
		INC     BC
DI1002:         SLA     (IX+00H)        ;ROTAZ.DIV.DO
		RL      (IX+01H)
		RL      (IX+02H)
		RL      (IX+03H)
		SLA     C               ;ROTAZ.QUO.TE
		RL      B
		LD      A,(MDIVIS)
		DEC     A
		LD      (MDIVIS),A
		JR      NZ,DI1001
		LD      H,(IX+03H)
		LD      L,(IX+02H)
		SBC     HL,DE
		JP      M,DI1003
		INC     BC
DI1003:         LD      (QU1000),BC
		EXX
		RET



                ;MOLTIPLICZIONE A 32 BIT



MOL32:          EXX
                LD      B,04H
		LD      HL,PTO032
INIT:           LD      (HL),00H
		INC     HL
		DJNZ    INIT
SHIFTX:         LD      B,04H
		LD      IX,MDO032+03H
		XOR     A
RTX:            RR      (IX)
		DEC     IX
		DJNZ    RTX
		JR      NC,ZERO
		LD      B,04H
		LD      HL,PTO032
		LD      IY,MRE032
		CCF
NXTBYT:         LD      A,(IY)
		ADC     A,(HL)
		LD      (HL),A
		INC     IY
		INC     HL
		DJNZ    NXTBYT
ZERO:           LD      B,04H
		LD      IX,MDO032
		XOR     A
ZCHK:           OR      (IX)
		JR      NZ,SHIFTY
		INC     IX
		DJNZ    ZCHK
		JR      END32
SHIFTY:         LD      B,04H
		LD      IY,MRE032
		XOR     A
LEFTY:          RL      (IY)
		INC     IY
		DJNZ    LEFTY
		JR      SHIFTX
END32:          EXX
		RET

		;DIVISIONE, 32BIT DIVISO 4096



DIV32:          EXX
		LD      HL,(EDEND0)
		LD      DE,(EDEND2)
		LD      B,0DH           ;PER DIVIDERE
MPW1:           DJNZ    MPW2            ;IN 4096 SHIFTO
		JR      MPW8            ;A DESTRA 12 VOLTE
MPW2:           SRL     L
		SRL     H
		JR      C,MPW7
MPW3:           SRL     E
		JR      C,MPW6
MPW4:           SRL     D
		JR      C,MPW5
		JR      MPW1
MPW5:           CCF
		SET     7,E
		JR      MPW1
MPW6            CCF
		SET     7,H
		JR      MPW4
MPW7:           CCF
		SET     7,L
		JR      MPW3
MPW8:           LD      (QUOZ32),HL
		EXX
		RET



SOTT32:         EXX
		AND     A
		LD      HL,(MINUE0)     ;SALVO MINU-
		LD      (MIXUE0),HL     ;ENDO E SOT-
		LD      HL,(MINUE2)     ;TRAENDO
		LD      (MIXUE2),HL     ;ORIGINALI
		LD      HL,(SUBTR0)
		LD      (SUXTR0),HL
		LD      HL,(SUBTR2)
		LD      (SUXTR2),HL
		LD      HL,(MIXUE2)     ;VERIFICO CHI E'
		LD      DE,(SUXTR2)     ;IL NUMERO PIU'
		SBC     HL,DE           ;GRANDE PER PER
		JR      Z,SOT01         ;NON AVERE IL
		JR      NC,SOT03        ;RISULTATO NEGA-
		JR      SOT02           ;TIVO E PER
SOT01:          LD      HL,(MIXUE0)     ;DETERMINARE IL
		LD      DE,(SUXTR0)     ;SENSO DI CORREZ-
		SBC     HL,DE           ;ZIONE
		JR      NC,SOT03
SOT02:          LD      HL,(MIXUE0)
		LD      DE,(SUXTR0)
		LD      (MIXUE0),DE
		LD      (SUXTR0),HL
		LD      HL,(MIXUE2)
		LD      DE,(SUXTR2)
		LD      (MIXUE2),DE
		LD      (SUXTR2),HL     

		LD	A,(MSCORR_ATT)	;NNDD
		LD	(MSCORR_PREC),A
		LD      A,08H           ;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. RITARDO
		LD	(MSCORR_ATT),A

		JR      SOT04
SOT03:       

		LD	A,(MSCORR_ATT)	;NNDD
		LD	(MSCORR_PREC),A
		LD      A,01H		;SEGNALAZIONE
		LD      (MSCORR),A      ;CORREZ. AVANTI
		LD	(MSCORR_ATT),A

SOT04:          LD      HL,(MIXUE0)
		LD      DE,(MIXUE2)
		LD      BC,(SUXTR0)
		AND     A
		SBC     HL,BC
		LD      (RESTO0),HL
		JR      NC,SOT05
		DEC     DE
SOT05:          EX      DE,HL
		LD      DE,(SUXTR2)
		AND     A
		SBC     HL,DE
		LD      (RESTO2),HL
		EXX
		RET

		;SOMMA A 32 BIT



SOMM32:         EXX
		LD      HL,ADDEN0
		LD      DE,AUGEN0
		LD      B,04H
		AND     A
ADDW:           LD      A,(DE)
		ADC     A,(HL)
		LD      (HL),A
		INC     DE              ;IL RISULTATO
		INC     HL              ;SI TROVA NELLA
		DJNZ    ADDW            ;LOCAZIONE 
		EXX                     ;ADDEN0 E ADDEN2
		RET




                

                ;###########################
                ;# CALCOLO DELLA  VELOCITA'#
                ;###########################

                ;4mS x 4096 = 16384000
                ;60\1638400 = 0,000003662
                ;0,000003662 x CILINDRO = X
                ;X\1000 = COSVEL (COSVEL E' CALCOLATA
                ;AL CAMBIO CILINDRO)
                ;COSVEL x IMPVEL = Y
                ;Y/1000 = VELOCITA m/m

VELO:           LD      DE,(COSVEL)     
                LD      (MDO032),DE
                LD      DE,0000H
                LD      (MDO232),DE
                LD      (MRE232),DE
                LD      DE,(IMPVEL)
                LD      (MRE032),DE
                LD      A,01H
                LD      (ALTDIV),A      
                CALL    MOL32
                CALL    DI1000
                LD      BC,(QU1000)     ;VELOCITA         
                LD      (ISTVEL),BC     ;ISTANTANEA    


                ;MEDIA VELOCITA SU QUATTRO LETTURE WWAA

                LD      B,03H           ;WWAA 
                LD      IX,MVEL00       ;
                LD      DE,0004H
                ADD     IX,DE
MEDV01:
                LD      E,(IX)          ;DATI LETTI
                LD      D,(IX+01H)      ;INSERENDO
                LD      (IX+02H),E      ;IL NUOVO
                LD      (IX+03H),D      ;DATO AL
                DEC     IX              ;PRIMO POSTO
                DEC     IX              ;ED ELIMINANDO
                DJNZ    MEDV01          ;L'ULTIMO
                INC     IX
                INC     IX


                LD      DE,(ISTVEL)      ;
                LD      (MVEL00),DE

                LD      B,04H            ;SOMMA DELLE  
                JR      NC,MEDV02        ;4 CELLE  WWAA
                CCF                      ; 
MEDV02:         LD      HL,0000H
MEDV03:
                LD      E,(IX+00H)
                LD      D,(IX+01H)
                ADC     HL,DE
                INC     IX
                INC     IX
                DJNZ    MEDV03
                

                LD      (DIVDEN),HL
                LD      BC,0004H        ;
                LD      (DIVSOR),BC     ;
		CALL    DIVIS
		LD      HL,(QUOZIE)

		LD      (VELMED),HL                 

                RET                     ;WWAA









                ;SCRITTURA ACCEL DECEL

                

ACCEL:
                LD      A,(LINGUA+00H)   ;TTDD
		CP      00H
                JR      Z,ACCE
		CP      01H
                JR      Z,ACCE
		CP      02H
                JR      Z,ACCE
		CP      03H
                JR      Z,ACCE
                CP      04H
                JR      Z,ACCD

ACCE:           LD      A,77H           ;A
		LD      (BINSET+10H),A
                LD      A,39H           ;C
		LD      (BINSET+0FH),A
                LD      A,39H           ;C
		LD      (BINSET+0EH),A
                LD      A,79H           ;E
		LD      (BINSET+0DH),A
                LD      A,38H           ;L
		LD      (BINSET+0CH),A
                JR      DECE1                     
ACCD:           LD      A,7CH           ;b
		LD      (BINSET+10H),A
                LD      A,79H           ;E
		LD      (BINSET+0FH),A
                LD      A,6DH           ;S
		LD      (BINSET+0EH),A
                LD      A,39H           ;C
		LD      (BINSET+0DH),A
                LD      A,76H           ;H
		LD      (BINSET+0CH),A
                JR      DECE1                     



DECEL:
                LD      A,(LINGUA+00H)   ;TTDD
		CP      00H
                JR      Z,DCCE
		CP      01H
                JR      Z,DCCE
		CP      02H
                JR      Z,DCCE
		CP      03H
                JR      Z,DCCE
                CP      04H
                JR      Z,DCCD


DCCE:           LD      A,5EH           ;d
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
                LD      A,39H           ;C
		LD      (BINSET+0EH),A
                LD      A,79H           ;E
		LD      (BINSET+0DH),A
                LD      A,38H           ;L
		LD      (BINSET+0CH),A
                JR      DECE1
DCCD:           LD      A,1CH           ;v
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
                LD      A,50H           ;r
		LD      (BINSET+0EH),A
                LD      A,5BH           ;Z
		LD      (BINSET+0DH),A
                LD      A,3FH           ;O
                LD      (BINSET+0CH),A     ;TTDD


DECE1:          EXX 
		CALL	RESEPC		;SSDD
                CALL    TRDIS
		LD      BC,01FFH        
RITVE1:         DI
                LD      D,077H
RITVE2:         DEC     D
                JR      NZ,RITVE2
                LD      A,(CICATT)      ;RICARICO I ATTT
                ;RLA                     ;CICLI ATTT 
                RLA                     ;QUADRUPLI       
                LD      (MATTES),A      ;CATI DI
                EI                      ;CORREZZIONE
                DEC     BC              ;DALL'INIZIO
                LD      A,B
                OR      C
                JR      NZ,RITVE1
		CALL	AZZTOT		;PUUU
                RET                     ;FFZZ




                 ;CALCOLO DISTANZA TRA I SEGNI

SPASI:
                LD      A,(SEQSEG)      ;CCGG
                LD      BC,(SEGRIF)     ;SSRR CCGG
                SBC     A,C             ;SSRR CCGG
		LD      (MOLPL),A
                LD      DE,7D0H         ;H2000 = 20mmX100
		LD      (MOLTI),DE
		CALL    MOLT
		LD      HL,(PROD)
		LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
		LD      HL,(PTO232)     ;CENTIMILLESIMI
		LD      (DISTA2),HL
                RET                     ;CCGG


                ;ANNULLA LO SHIFT QUANDO SI ESEGUE F4
                ;SENZA AVER MODIFICATO IL VALORE A F3



AZZF4:          LD      DE,7D0H         ;VEDI ENTE4
		LD      (MOLTI),DE
		LD      A,(SEQSEG)
		LD      (MOLPL),A
		CALL    MOLT
		LD      HL,(PROD)
		SBC     HL,DE
		LD      (DISTAN),HL
		LD      (MDO032),HL     ;CALCOLO
		LD      BC,0000H        ;DISTANZA IN
		LD      (MDO232),BC     ;CENTIMILLESIMI
		LD      HL,03E8H
		LD      (MRE032),HL
		LD      (MRE232),BC
		CALL    MOL32
		LD      HL,(PTO032)
		LD      (DISTA0),HL     ;DISTANZA IN
		LD      HL,(PTO232)     ;CENTIMILLESIMI
		LD      (DISTA2),HL
                RET



               ;CALCOLO VARIABILI PER MEDIA ERRORE LONG.

VARERR:                                  ;WWAA
                LD      A,(CICATT)      ;ATTT
                CP      09H
                JR      NC,MECI01
                LD      A,07H
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,0CH
                LD      (VALORX),A
                JR      MECI04
MECI01:
                LD      A,(CICATT)      ;ATTT
                CP      11H             ;= 17
                JR      NC,MECI02
                LD      A,0FH
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,1CH           ;= 28
                LD      (VALORX),A
                JR      MECI04
MECI02:
                LD      A,(CICATT)      ;ATTT
                CP      21H             ;= 33
                JR      NC,MECI03
                LD      A,1FH           ;= 31
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,3CH           ;= 60
                LD      (VALORX),A
                JR      MECI04
MECI03:
                LD      A,2FH           ;= 47
                LD      (PRIMOB),A
                INC     A
                LD      (SECONB),A
                LD      A,5CH           ;= 92
                LD      (VALORX),A
MECI04:
                RET







        ;VERIFICA VALORI DI F1 E F3 E SEGNO DI RIFERIMENTO  EEUU



VERIFI:
		LD	HL,(CILIN)	;EEOO SSMM
		LD	DE,0FFFFH	;EEOO
		ADD	HL,DE
		JR	C,VERF11 	;EEUU
		CALL	ERRF1
		JR	VERF3		;EEOO
VERF1:		CCF
VERF11:		LD	HL,(CILIN)	;EEUU SSMM
		LD	DE,9D4H		;2500mm	MAX SIZE
		SBC	HL,DE
		JR	NC,VERF13 	;EEUU
		CCF
		JR	VERF3
VERF13:		CALL	ERRF1		;EEUU
VERF3:
		LD	A,(SEQSEG)	;EEOO
		CP	00H
                JR      NZ,VERF4        ;EEUU
		CALL	ERRF3		;EEOO	SSMM

VERF4:
                LD      A,(SEGRIF)      ;SSRR EEUU
                LD      B,A             ;SSRR
                LD      A,(SEQSEG)      ;CONTROLLO SE
                XOR     B               ;SE SONO
                JR      Z,VERF5         ;UGUALI
                LD      A,(SEQSEG)      ;SSRR
                SBC     A,B             ;SSRR
                JR      NC,VERF6        ;SSRR
                CCF
VERF5:          CALL    ERRF4           ;EEUU SSRR

VERF6:          RET                     ;EEUU





		;SCRITTURA Nø VERSIONE PROGRAMMA

                

RELESE:         LD      A,78H           ;t
		LD      (BINSET+10H),A
		LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,1EH           ;J
		LD      (BINSET+0EH),A
                LD      A,00H           
		LD      (BINSET+0DH),A
                LD      A,00H           
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS
                CALL    RITDIS

		LD      A,39H           ;C
		LD      (BINSET+10H),A
		LD      A,3FH           ;O
		LD      (BINSET+0FH),A
		LD      A,38H           ;L
		LD      (BINSET+0EH),A
		LD      A,3FH           ;O
		LD      (BINSET+0DH),A
		LD      A,50H           ;r
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
                CALL    RITDIS
                CALL    RITDIS

                LD      A,3FH           ;O
		LD      (BINSET+10H),A
                LD      A,71H           ;F
		LD      (BINSET+0FH),A
                LD      A,71H           ;F
		LD      (BINSET+0EH),A
                LD      A,6DH           ;S
		LD      (BINSET+0DH),A
                LD      A,79H           ;E
		LD      (BINSET+0CH),A
		EXX

		CALL    TRDIS
		CALL    RITDIS
                CALL    RITDIS

           
                LD      A,66H           ;4
		LD      (BINSET+10H),A
                LD      A,3FH           ;0
		LD      (BINSET+0FH),A
                LD      A,08H           ;_
		LD      (BINSET+0EH),A
                LD      A,7DH		;6 MMUU
                LD      (BINSET+0DH),A
                LD      A,77H           ;A
		LD      (BINSET+0CH),A
		EXX

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS
    
                 
               
                LD      A,3FH           ;0
		LD      (BINSET+10H),A
                LD      A,06H           ;1
		LD      (BINSET+0FH),A
                LD      A,40H           ;- 
		LD      (BINSET+0EH),A
                LD      A,3FH           ;0   
		LD      (BINSET+0DH),A
                LD      A,7DH           ;6
		LD      (BINSET+0CH),A
		EXX
         
		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS


                LD      A,00H           ;MMMM   MM33
		LD      (BINSET+10H),A
                LD      A,5BH           ;2 
		LD      (BINSET+0FH),A
                LD      A,3FH           ;0 
		LD      (BINSET+0EH),A
                LD      A,3FH           ;0   
		LD      (BINSET+0DH),A
                LD      A,7FH           ;8
		LD      (BINSET+0CH),A
		EXX

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS


                LD      A,00H           ;MMMM   MM33
		LD      (BINSET+10H),A
                LD      A,39H           ;C 
		LD      (BINSET+0FH),A
                LD      A,3FH           ;O 
		LD      (BINSET+0EH),A
                LD      A,5EH           ;d   
		LD      (BINSET+0DH),A
                LD      A,79H           ;E
		LD      (BINSET+0CH),A
		EXX

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS

                LD      A,00H           ;MMMM   MM33
		LD      (BINSET+10H),A
                LD      A,5BH           ;Z 
		LD      (BINSET+0FH),A
                LD      A,79H           ;E 
		LD      (BINSET+0EH),A
                LD      A,38H           ;L   
		LD      (BINSET+0DH),A
                LD      A,3FH           ;O
		LD      (BINSET+0CH),A
		EXX

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS


                JP      TESEND          ;MM33


		
		;VISUALIZZAZIONE VALORE PARAMETRI USATI SOLO DA ASSISTENZA
		;USANDO TEST 5

TECNICO:				;FFSS

		LD      DE,(VCLONG)     ;VALORE E' IN
                LD      (BINSET),DE     ;CENTESIMI DI mm
                LD      A,50H           ;r
		LD      (BINSET+10H),A
		CALL    BIN7

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS
		CALL    RITDIS

                LD      DE,(SELFRO)     ;
                LD      (BINSET),DE     ;.
                LD      A,52H           ;CADREGA GIRATA
		LD      (BINSET+10H),A
		CALL    BIN7

		CALL    TRDIS
		CALL    RITDIS
		CALL    RITDIS
		CALL    RITDIS

		 
		JP	TESEND		;FFSS




;RUTINE DI CORREZIONE ALLA PARTENZA DOPO F4 PER ESSERE RAPIDI ALL'AVVIO 
;IL TEMPO DICORREZZIONE VIENE CALCOLATO COME SEGUE   FFXX
;ERRORE x 60 / VELCOR = VALORE DI CORREZZIONE
;ATTENZIONE PER EVITARE DEI BLOCCHI IL VALORE MINIMO DI ERMEDI
;DEVE ESSERE SUPERIORE 0005    FFZZ

FLEXOL:
                LD      A,00H           ;FFZZ
                LD      (MFLEXL),A      ;FFZZ
                LD      HL,(ERATTU)     ;ERMEDI > 0005 FFRR
                LD      DE,0005H        ;PER CONTINUA- FFXX
                SBC     HL,DE           ;RE NELLA 
                JR      NC,FLEX1        ;CORREZZIONE   FFXX
                CCF
                JP      FINTRA          ;FFZZZ

FLEX1:          LD      DE,(ERATTU)     ;MOLTIPLICO PER FFXX FFRR
                LD      (MOLTI),DE      ;60 L'ERRORE
                LD      A,3CH           ;
                LD      (MOLPL),A       ;
                CALL    MOLT            ;
                LD      DE,(PROD)

                LD      (DIVDEN),DE     ;DIVIDO PER
                LD      BC,(VCLONG)     ;PER VELOCTA'
                LD      (DIVSOR),BC     ;DI CORREZIONE
		CALL    DIVIS
                LD      DE,(QUOZIE)     ;

                LD      (FLERRO),DE     ;FFZZ   FFXX

		LD      A,(MSCORR)      ;VEDO IN CHE
		CP      01H             ;SENSO CORREG.
                JR      NZ,FLERIT
		LD      A,(MEMC)        ;CORREZIONE IN
		RES     1,A             ;AVANTI
		SET     0,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                JR      FINTRA
FLERIT:         LD      A,(MEMC)        ;CORREZIONE IN
		RES     0,A             ;RITARDO
		SET     1,A
		LD      (MEMC),A
		OUT     (PC),A
                CALL    FXCORR
                                       ;RET                     ;FFZZ


FINTRA:                                 ;FFZZ

                RET


                ;RUTINE TEMPI DI CORREZIONE LONG


FXCORR:
                LD      A,37H           ;DISABILITO
                OUT     (03H),A         ;INTERUPT DI
                LD      A,0FFH          ;PIOB
                OUT     (03H),A         ;

                LD      DE,(FLERRO)    ;FFZZ
FXCOR1:         LD      BC,09FFH       ;
FXCOR2:         DEC     BC
		LD      A,B
		OR      C
                JR      NZ,FXCOR2
                DEC     DE              ;FFZZ
                LD      A,D             ;FFZZ
                OR      E               ;FFZZ
                JR      NZ,FXCOR1

                LD      A,(MEMC)        ;
                RES     0,A
                RES     1,A             ;
                RES     6,A
                RES     7,A
		LD      (MEMC),A
		OUT     (PC),A

                ;RIABILITO INTERRUPT PIOB

                LD      A,22H           ;VET.INT.PIO B
                OUT     (03H),A         ;CONTROLLO PIO B
		LD      A,0CFH          ;PORTA B MODO 3
		OUT     (03H),A
		LD      A,1EH           ;0567 OUT 1234 IN
		OUT     (03H),A
		LD      A,97H           ;PAR.CONT.INTER.
		OUT     (03H),A
		LD      A,0FDH          ;P.MAS.BIT 0234567
		OUT     (03H),A         ;ALL'INTERUPT


                LD      A,00H
                LD      (MTASTI),A


                RET


           ;VERIFICA TIPO DI ERRORE DA SCRIVERE
		
CONTR:          LD      A,(MDATER)
		CP      00H
                JR      Z,CO5
		CP	01H		;EEOO
		JR	Z,CO1		;EEOO
		CP	02H
		JR	Z,CO2
		CP	03H
		JR	Z,CO3
                CP      04H             ;EEUU
                JR      Z,CO4           ;EEUU
                JR      CO5             ;EEUU
CO1:		CALL    ERROR		;EEOO
                JR      CO5             ;EEUU
CO2:		CALL	ERRF1		;EEOO
                JR      CO5             ;EEUU
CO3:		CALL	ERRF3		;EEOO
                JR      CO5             ;EEUU
CO4:            CALL    ERRF4
CO5:
		RET


 	       
	       ;FASATURA CON OSCILLOSCOPIO ESTERNO  FF55

SPOFAS:                         
                IN      A,(PA)          ;
		BIT     4,A
                JP      NZ,SPOEN1       ;
                LD      DE,(INCEXT)
		LD      A,00H
		CP      E
                JR      NZ,EXTE1
                LD      E,14H		 ;ERA 2 CON OSCIL
                LD      (INCEXT),DE	 ;NORMALE MESSO A 		
                JR      EXTE2		 ;20 PER TAJ SCOPE 
EXTE1:          LD      A,01H		 ;ERA 5 CON OSCIL
		ADD     A,E		 ;NORMALE MESSO 1
		LD      E,A		 ;PER TAJ SCOPE	
                LD      (INCEXT),DE

EXTE2:
                IN	A,(PA)          ;VERIFICO SE
                AND     1FH             ;PIGIATO
                CP      08H             ;AVANTI/RITARDO
                JP      Z,SXSPOS        ;LLLL
		CP      09H
                JR      Z,DXSPOS
		JR	SPOEND
DXSPOS:                
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                SBC     HL,DE
                JR      C,SPOF01
                LD      (FASE),HL
                JR      SPOF02
SPOF01:         CCF
                LD      HL,0FFFH
SPOF02:         LD      (FASE),HL
                JR      SPOEND
SXSPOS:
                LD      HL,(FASE)
                LD      DE,(INCEXT)
                ADD     HL,DE
                LD      A,H
                CP      10H
                JR      NZ,SPOF07
                LD      HL,0000H
SPOF07:         LD      (FASE),HL
                JR      SPOEND

SPOEN1:         LD      DE,0000H
                LD      (INCEXT),DE

SPOEND:
                RET


CENTRO:         EXX                     ;FF56
                LD      HL,(FASES1)       ;SOTTRAGGO IL VA-
		LD      BC,(MEZGA)      ;LORE DI 1/2 GATE
                ;LD      B,00H           ;DAL VALORE LETTO
                SBC     HL,BC           ;SE IL RISULTATO
		JR      C,RISNEG        ;E'POSITIVO LO
		JR      TRFASE          ;MEMORIZZO IN
RISNEG:         CCF                     ;IN FASE.
		LD      HL,1000H        ;SE E'NEGATIVO
		SBC     HL,BC           ;SOTTRAGGO DA 4096
                LD      BC,(FASES1)       ;IL 1/2 GATE E IL
		ADD     HL,BC           ;RESTO LO SOMMO
TRFASE:         LD      (FASE),HL       ;AL VALORE LETTO.
		LD      A,H
		OUT     (20H),A
		LD      A,L
		OUT     (10H),A
		LD      A,04H           ;4 GIRI ATTESA
		LD      (MEMRIF),A      ;PER MEMORIZZARE
		EXX                     ;IL RIFERIMENTO
		RET
		
		
AZZTOT:
                LD      A,00H           ;ATTT PUUU
                LD      (MAVA00),A      ;LOC. INIZIALE
                LD      HL,MAVA00
                LD      DE,MAVA00+01H
                LD      BC,0110H
		LDIR                    
		RET

		;SCRITTURA FASE ESEGUITA

FASEOK:					;RRAA
		LD      A,00H
		LD      (MRIC+00H),A
		LD      (MRIC+02H),A
		LD	(MRIC+04H),A	;ATTIVA SCRITTA SSDD MMSS
		LD	(MRIC+08H),A	;RRAA
		LD      A,60H           ;ALLA PARTE-
		LD      (GUADS1),A      ;ZA METTO GUA-
		LD      (GUADS2),A      ;DAGNO MINIMO

		LD      A,71H           ;F
		LD      (BINSET+10H),A
		LD      A,77H           ;A
		LD      (BINSET+0FH),A
		LD      A,6DH           ;S
		LD      (BINSET+0EH),A
		LD      A,79H           ;E
		LD      (BINSET+0DH),A
                LD      A,00H          
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		RET			;RRAA


		;######################
		;# MODIFICA PARAMETRI #
		;######################





MODPA:          DI
		LD	A,(PARA_NASC)	;FFSS
		CP	01H		;FFSS
		JR	NZ,MODPA3
		LD      A,00H           
		LD      (SETUP2),A
		LD      A,78H           ;t
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,39H           ;C
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
		JR	MODPA4		;FFSS

MODPA3:		
		LD      A,00H           
		LD      (SETUP2),A
		LD      A,6DH           ;S
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,78H           ;t
		LD      (BINSET+0EH),A
		LD      A,3EH           ;U
		LD      (BINSET+0DH),A
		LD      A,73H           ;P
		LD      (BINSET+0CH),A
MODPA4:					;FFSS
		EXX
		CALL    TRDIS
		CALL    RITDIS          ;PER NON AVERE
		LD      DE,0000H        ;UN NUMERO INCA-
		LD      (XUNZ),DE       ;SINATORE.
MODPA1:         LD      BC,0BFFFH       ;RITARDO ANTI
XONT1:          DEC     BC              ;RIMBALZO
		LD      A,B
		OR      C
		JR      NZ,XONT1
XONT4:          IN      A,(PA)          
		AND     1FH             ;SELEZIONA TASTO
                CP      0FH             ;FUNZIONE  
		JR      Z,XNCR          ;(CILIN/ALLAR)
		CP      0CH             ;TASTO +
		JP      Z,XART6
		CP      0DH             ;TASTO -
		JP      Z,XART6
		CP      0AH             ;TATSO CLEAR
		JP      Z,XART6
		CP      0BH             ;TASTO ENTER
		JP      Z,RESETT
		JP      XINE
XART:           LD      A,00H
		LD      D,A
		LD      HL,XUNZ
		LD      (HL),A
		JR      XERO
XART1:          LD      A,0DH           ;CONTEGGIO >13 FFSS
		LD      D,A
		LD      HL,XUNZ
		LD      (HL),A
		JP      XERO
XNCR:           LD      A,00H           
                LD      (MLING),A       
                LD      HL,XUNZ
		LD      D,(HL)
		INC     D
XERO:           LD      A,D
		LD      (HL),A
                CP      0DH             ;FFSS
		JR      Z,XART
		CP      0FFH
		JR      Z,XART1
		CP      00H
                JR      Z,TRI
                CP      01H
		JR      Z,GUAD
                CP      02H
		JP      Z,CIC		;FFSS
                CP      03H
                JP      Z,DER
                CP      04H
                JP      Z,ZON
                CP      05H
		JP      Z,INS
                CP      06H
		JP      Z,SALT
                CP      07H             
                JP      Z,LING
                CP      08H             ;FFSS
                JP      Z,PROX
                CP      09H             ;SSRR
                JP      Z,SERI          ;SSRR
		CP	0AH		;DDAA
		JP	Z,DOPP
		
		LD	B,A		;SELEZIONE  FFSS
		LD	A,(PARA_NASC)	;PARAMETRI NASCOSTI FFSS
		CP	01H
		JP	NZ,MODPA1
		LD      A,B	

		CP      0BH             ;FFSS
                JP      Z,VCL
 		CP	0CH		;FFSS
		JP	Z,FRONT
		JP      MODPA1		;DDAA

		


TRI:            LD      IX,TRIP         ;CARICO PARAMETRI
                LD      (IX+02H),00H    ;DEL TRIP DI 
                LD      (IX+03H),00H    ;VELOCITA'
                LD      (IX+04H),0FH     
                LD      DE,(TRIP)
		LD      (BINSET),DE
                LD      A,74H           ;h
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE



GUAD:           LD      IX,GUADA        ;CARICO PARAMETRI
                LD      (IX+02H),02H    ;DEL GADAGNO
		LD      (IX+03H),00H
		LD      (IX+04H),0FFH   ; = 255 EEFF
		LD      DE,(GUADA)
		LD      (BINSET),DE
		LD      A,7CH           ;b
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE



CIC:            LD      IX,CICLO        ;CARICO PARAMETRI
                LD      (IX+02H),01H    ;DEL CICLO CORREZ.
		LD      (IX+03H),00H
		LD      (IX+04H),64H
		LD      DE,(CICLO)

                LD      (BINSET),DE     ;CALCOLO DEL  ATTT
                ;LD      (MOLTI),DE      ;75% DEL CICLO
                ;LD      A,19H           ;CHE VIENE USATO
                ;LD      (MOLPL),A       ;ALL'INIZIO DELLE
                ;CALL    MOLT            ;EXTRA CORREZ.
                ;LD      DE,(PROD)       ;PER FAR SI CHE
                ;LD      (DIVDEN),DE     ;VI SIA UNA 
                ;LD      BC,64H          ;BREVE INTERRU-
                ;LD      (DIVSOR),BC     ;ZIONE PER 
                ;CALL    DIVIS           ;EVITARE LA
                ;LD      DE,(QUOZIE)     ;CORREZZIONE
                ;LD      HL,(CICLO)      ;CONTINUA
                ;SBC     HL,DE
                ;LD      (CICL75),HL

		LD      A,58H           ;c
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE



DER:            LD      IX,DERIVA       ;CARICO PARAMETRI
		LD      (IX+02H),00H    ;DEL DERIVATIVO
		LD      (IX+03H),00H
                LD      (IX+04H),0FEH    
		LD      DE,(DERIVA)
		LD      (BINSET),DE
		LD      A,5EH           ;d
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE


ZON:            LD      IX,ZONA         ;CARICO PARAMETRI
		LD      (IX+02H),00H    ;DELLA ZONA MORTA
		LD      (IX+03H),00H
		LD      (IX+04H),65H	;SSRR
		LD      DE,(ZONA)
		LD      (BINSET),DE
		LD      A,09H           ;=
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE


INS:            LD      IX,INSER        ;CARICO PARAMETRI
		LD      (IX+02H),00H    ;DELL'INSERZIONE
		LD      (IX+03H),00H
                LD      (IX+04H),0FFH
		LD      DE,(INSER)
		LD      (BINSET),DE
		LD      A,04            ;i
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE


SALT:           LD      IX,SALTO        ;CARICO PARAMETRI
		LD      (IX+02H),01H    ;DEL SALTO DI MMUU
		LD      (IX+03H),00H    ;CORREZIONE
		LD      (IX+04H),0AH    
		LD      DE,(SALTO)
		LD      (BINSET),DE
		LD      A,5CH           ;o
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      XINE


LING:           LD      A,01H           
                LD      (MLING),A       
		LD      IX,LINGUA       ;CARICO PARAMETRI                                                              
		LD      (IX+02H),00H    ;DELLA LINGUA
		LD      (IX+03H),00H    
                LD      (IX+04H),05H    ;TTDD
		LD      DE,(LINGUA)
		LD      (BINSET),DE
		LD      A,38H           ;L
		LD      (BINSET+10H),A
		CALL    BIN7
		LD      A,E
		CP      00H
		JR      Z,LING0
		CP      01H
		JR      Z,LING1
		CP      02H
		JR      Z,LING2
		CP      03H
		JR      Z,LING3
                CP      04H             ;TTDD
                JR      Z,LING4         ;TTDD
		JP      XINE
LING0:          LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,54H           ;n
		LD      (BINSET+0FH),A
		LD      A,6FH           ;g
		LD      (BINSET+0EH),A
		LD      A,38H           ;L
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
                JR      LING5
LING1:          LD      A,06H           ;I
		LD      (BINSET+10H),A
		LD      A,78H           ;t
		LD      (BINSET+0FH),A
		LD      A,77H           ;A
		LD      (BINSET+0EH),A
		LD      A,38H           ;L
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
                JR      LING5              ;TTDD
LING2:          LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,6DH           ;S
		LD      (BINSET+0FH),A
		LD      A,73H           ;P
		LD      (BINSET+0EH),A
		LD      A,77H           ;A
		LD      (BINSET+0DH),A
		LD      A,54H           ;n
		LD      (BINSET+0CH),A
                JR      LING5                ;TTDD
LING3:          LD      A,71H           ;F
		LD      (BINSET+10H),A
		LD      A,50H           ;r
		LD      (BINSET+0FH),A
		LD      A,77H           ;A
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,39H           ;C
		LD      (BINSET+0CH),A
                JR      LING5                ;TTDD
LING4:          LD      A,5EH           ;d
		LD      (BINSET+10H),A
                LD      A,79H           ;E
		LD      (BINSET+0FH),A
                LD      A,3EH           ;U
		LD      (BINSET+0EH),A
                LD      A,78H           ;t
		LD      (BINSET+0DH),A
                LD      A,6DH           ;S
		LD      (BINSET+0CH),A

LING5:          EXX                          ;TTDD
		CALL    TRDIS
		JP      XINE



PROX:           LD      IX,PROXIM       ;0= DISABILITA  PXXX
                LD      (IX+02H),00H    ;1= ABILITA   
                LD      (IX+03H),00H    ;LETTURA CON 
                LD      (IX+04H),02H    ;PROXIMITY 
                LD      DE,(PROXIM)     ;
                LD      (BINSET),DE     ;.
                LD      A,1EH           ;J
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE

SERI:           LD      IX,SEGRIF       ;CARICO POSIZIONE  SSRR
                LD      (IX+02H),02H    ;DEL SEGNO DI
                LD      (IX+03H),00H    ;RIFERIMENTO
                LD      (IX+04H),0DH    ;ZZZ 
                LD      DE,(SEGRIF)
		LD      (BINSET),DE
                LD      A,73H           ;P
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE

DOPP:           LD      IX,ABIDOP       ;0= DISABILITA  DDAA
		LD      (IX+02H),00H    ;1= ABILITA BLOC-  
                LD      (IX+03H),00H    ;CO DOPPIO SEGNO 
                LD      (IX+04H),02H     
                LD      DE,(ABIDOP)     
                LD      (BINSET),DE     
                LD      A,54H           ;n
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE


VCL:            LD      IX,VCLONG       ;CARICO PARAMETRI  FFSS (SPOSTAO)
                LD      (IX+02H),00H    ;DELLA CORREZIONE 
                LD      (IX+03H),00H    ;VELOCE ALLA
                LD      (IX+04H),0FFH   ;PARTENZA IL 
                LD      DE,(VCLONG)     ;VALORE E' IN
                LD      (BINSET),DE     ;CENTESIMI DI mm
                LD      A,50H           ;r
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      XINE


FRONT:          LD      IX,SELFRO       ;0= LETTURA SU FRONTE DI SALITA
                LD      (IX+02H),00H    ;1= LETTURA SPESSORE SEGNO   
                LD      (IX+03H),00H    ;FFSS 
                LD      (IX+04H),02H    ; 
                LD      DE,(SELFRO)     ;
                LD      (BINSET),DE     ;.
                LD      A,52H           ;CADREGA GIRATA
		LD      (BINSET+10H),A
		CALL    BIN7
		JP      XINE


		;GESTIONE CONTEGGIO

XONT5:          LD      BC,0AFFFH       ;cont. lento
XONT7:          DEC     BC
		LD      A,B
		OR      C
		JR      NZ,XONT7
XART6:          IN      A,(PA)          
		AND     1FH             ;sente che
		CP      0CH             ;tasto 
		JR      Z,XNCR2         ;premuto
		CP      0DH
		JR      Z,XECR2
		CP      0AH             ;SE CLEAR AZZERA
		JR      Z,XZZER         ;IL DISPLAY
		JP      XINE
XECR2:          LD      E,(IX+00H)
		LD      D,(IX+01H)
		LD      A,D             ;VEDO SE E'ZERO 
		OR      E               ;PER NON AVERE IN
		JR      Z,XENT2         ;DECREMENTO FFFFH
		LD      A,(MEM1)
		BIT     0,A
		JR      Z,XENTO
XENT2:          LD      D,(IX+03H)
		LD      E,(IX+04H)
		XOR     A
		LD      (MEM1),A
		JR      XENT1
XENTO:          LD      E,(IX+00H)      ;CARICO I 
		LD      D,(IX+01H)      ;PARAMETRI
XENT1:          DEC     DE
		LD      (IX+00H),E      ;SALVO I PARAMETRI
		LD      (IX+01H),D
		LD      (BINSET),DE
		CALL    BIN7            ;TRASMISSIONE
		LD      A,E
		CP      (IX+02H)
		JR      Z,XZZ3
		JR      XERO2
XZZ3:           LD      A,01H
		LD      (MEM1),A
		LD      (IX+00H),E      ;AZZERAMENTO
		LD      (IX+01H),D      ;FASE E ALLARME
		JP      XERO2
XNCR2:          LD      E,(IX+00H)
		LD      D,(IX+01H)
		INC     DE
		LD      (IX+00H),E
		LD      (IX+01H),D
		LD      (BINSET),DE
		CALL    BIN7
		LD      A,E
		CP      (IX+04H)
		JR      Z,XZZER
		JP      XERO2           ;SECONDO LA
XZZER:          LD      DE,0000H        ;FUNZIONE
		LD      (IX+00H),E      ;RICHIESTA
		LD      (IX+01H),D
		LD      (BINSET),DE
		CALL    BIN7
		JR      XERO2
XECR3:          LD      A,01H
		LD      (MEM2),A
		IN      A,(PA)
		AND     1FH
		CP      0DH
		JR      Z,XECR3
XNCR3:          LD      A,01H
		LD      (MEM3),A
		IN      A,(PA)
		AND     1FH
		CP      0CH
		JR      Z,XNCR3
XERO2:          LD      A,(MLING)       ;LLLLLL
                CP      01H
                JP      Z,LING          ;LLLL
                IN      A,(PA)
		AND     1FH             ;SENTE SE TASTO
		CP      0DH             ;ANCORA PREMUTO
		JP      Z,XONT5         ;RIPETE IL CICLO
		CP      0CH
		JP      Z,XONT5
XINE:           LD      (XTASTO),IX
		JP      MODPA1
RESETT:         LD      A,00H           ;PER NON VEDERLO LOLA
                LD      (NOCIAO),A      ;QUANDO RITORNA 
		LD	(PARA_NASC),A	;RESETTO LA MEM. FFSS
                JP      RESET_PIO       ;LOLA 




                

		;VERIFICA FUNZIONAMENTO TESTA
		;E ENCODER

TEST:           DI
		LD      A,00H           ;RESETTO PORTA C
		LD      (MEMC),A        ;IMPONENDO MANUALE
		OUT     (PC),A
		LD      (TEST2),A
		LD      A,78H           ;t
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,6DH           ;S
		LD      (BINSET+0EH),A
		LD      A,78H           ;t
		LD      (BINSET+0DH),A
                LD      A,00H           ;
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS          
TES1:           LD      BC,01FFH        ;RITARDO ANTI 
TES2:           DEC     BC              ;RIMBALZO
		LD      A,B
		OR      C
		JR      NZ,TES2
                IN      A,(PA)
		AND     1FH
		CP      01H            ;TEST TESTA
		JR      Z,TES3
		CP      02H            ;TEST ENCODER
		JP      Z,ENC1
                CP      03H            ;ATTT
                JP      Z,ATCICLO
                CP      04H
                JP      Z,RELESE
		CP	05H		;VISUALIZZO  FFSS
		JP	Z,TECNICO	;PARAMETRI NASCOS
		CP      0BH
		JP      Z,TESEND
		JR      TES1
TES3:           CALL    TESDIS
		LD      A,(MEMB)
		SET     6,A             ;BLOCCO GATE
		LD      (MEMB),A
		OUT     (PB),A
		LD      D,0FFH
TES4:           IN      A,(PB)          
		BIT     2,A
		JR      NZ,TESSI
		LD      BC,0A00H        ;5 SECONDI
TES5:           DEC     BC              ;DI TEST 
		LD      A,B             
		OR      C                
		JR      NZ,TES5         
		DEC     D
		LD      A,00H
		CP      D
		JR      NZ,TES4
		LD      A,78H           ;t
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,40H           ;-
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,3FH           ;O
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS          
                CALL    RITDIS          ;XXTT
                JR      TESEND          ;XXTT
TESSI:          LD      A,78H           ;t
		LD      (BINSET+10H),A
		LD      A,79H           ;E
		LD      (BINSET+0FH),A
		LD      A,40H           ;-
		LD      (BINSET+0EH),A
		LD      A,6DH           ;S
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS          
                CALL    RITDIS          ;XXTT
TESEND:         EI  
                JP      RESET_PIO	;LOLA



TESDIS:         LD      A,40H           ;-
		LD      (BINSET+10H),A  ;SCRITTURA
		LD      (BINSET+0FH),A  ;CHE INDICA
		LD      (BINSET+0EH),A  ;L'INIZIO
		LD      (BINSET+0DH),A  ;DEL TEST
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		RET

		;TEST DELL'ENCODER
		
ENC1:           CALL    TESDIS         
                LD      A,01H          ;CARICO UN
                LD      (ENCOD1),A     ;GIRO IN CTC1
                LD      A,0D7H         ;AL GIRO
                OUT     (71H),A        
                LD      A,01H          
                OUT     (71H),A        
                LD      A,00H          ;AZZERO IL 
                LD      (ENCOD2),A     ;CONTATORE
                LD      BC,0000H       ;XXTT2
                LD      (ENCOD4),BC
                EI                     ;PER 16
		JP      TES1

                

ENC2:          
                LD      A,37H           ;DISABILITO
                OUT     (03H),A         ;INTERUPT DI
                LD      A,0FFH          ;PIOB
                OUT     (03H),A         ;
ENC3:
                IN      A,(PB)          ;XXTT
		BIT     4,A
                JR      Z,ENC3
ENC7:           IN      A,(PB)
                BIT     4,A
                JR      NZ,ENC7
                LD      BC,(ENCOD4)
                INC     BC
                LD      (ENCOD4),BC
                JR      ENC3            ;XXTT


ENC6:           LD      A,00H
                LD      (ENCOD1),A      ;
                LD      A,(ENCOD2)
		LD      A,43H
		OUT     (71H),A
                LD      A,(ENCOD3)      ;TENTA PER
                INC     A               ;10 VOLTE 
                LD      (ENCOD3),A      ;IL TEST
                CP      03H             ;XXTT
                JP      NZ,ENC1

                LD      HL,(ENCOD4)     ;XXTT2
                LD      DE,07FDH        ;2045
                SBC     HL,DE
                JR      C,ENC41

ENC5:
                LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,54H           ;n
		LD      (BINSET+0FH),A
		LD      A,40H           ;-
		LD      (BINSET+0EH),A
		LD      A,6DH           ;S
		LD      (BINSET+0DH),A
		LD      A,06H           ;I
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS
                CALL    RITDIS          ;XXTT
                LD      A,00H
                LD      (ENCOD3),A
                JR      ENC8            ;XXTT2  JP      TES1
ENC41:
                CCF                     ;XXTT2
ENC4:           LD      A,79H           ;E
		LD      (BINSET+10H),A
		LD      A,54H           ;n
		LD      (BINSET+0FH),A
		LD      A,40H           ;-
		LD      (BINSET+0EH),A
		LD      A,54H           ;n
		LD      (BINSET+0DH),A
		LD      A,3FH           ;O
		LD      (BINSET+0CH),A
		EXX
		CALL    TRDIS
		CALL    RITDIS
                CALL    RITDIS          ;XXTT
ENC8:
                LD      A,00H
                LD      (ENCOD3),A
                JP      RESET_PIO	;LOLA JP      VIA             ;XXTTJP      TES1





                ;VISUALIZZAZIONE CICLI DI CORREZIONE



ATCICLO:        LD      DE,(CICATT)
		LD      (BINSET),DE
                LD      A,76H           ;H
		LD      (BINSET+10H),A
		CALL    BIN7
                JP      TES1

		;RESETTO PORTA C
RESEPC:
		LD      A,(MEMC)	;SSSSS       
                RES     0,A
                RES     1,A
		SET	4,A
                RES     6,A
                RES     7,A
                LD      (MEMC),A
                OUT     (PC),A
		RET


		END


                



